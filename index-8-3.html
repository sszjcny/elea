<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="https://i.postimg.cc/hv146kF5/IMG-1855.png">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ÁîòÊ¢ÖÁÇ∏Êú∫</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700&family=Long+Cang&display=swap" rel="stylesheet">
    <style>
.msg-time {
    display: block;
    font-size: 0.65rem;
    color: #888;
    margin-top: 4px;
    text-align: right; 
    opacity: 0.8;
}
.msg-row.other .msg-time {
    text-align: left; 
}
#newspaper-modal {
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(5px);
    display: none; 
    align-items: center;
    justify-content: center;
    z-index: 3000;
}
.paper-full-view {
    width: 90%;
    max-width: 600px;
    height: 85vh;
    background: #fdf6e3;
    padding: 20px;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
    overflow-y: auto;
    font-family: "Times New Roman", serif;
    position: relative;
    transform: rotate(-1deg);
    border: 1px solid #ccc;
}
.paper-full-head { text-align: center; border-bottom: 3px double #333; padding-bottom: 10px; margin-bottom: 15px; }
.paper-title { font-size: 2.5rem; font-family: "Old English Text MT", serif; line-height: 1; }
.paper-body { font-size: 1rem; line-height: 1.6; text-align: justify; column-count: 1; }

#camera-ui {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: #1a1a1a;
}
#canvas-area {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    position: relative;
    background-image: radial-gradient(#333 1px, transparent 1px);
    background-size: 20px 20px;
}
canvas {
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    max-width: 95%;
    max-height: 95%;
}
.cam-tools {
    height: 100px; 
    background: #222;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0 15px;
    overflow-x: auto;
    border-top: 1px solid #333;
    flex-shrink: 0;
}
        :root {
            --bg-gradient-1: #cdd1d3;
            --bg-gradient-2: #e3e3e3;
            --tv-wood-light: #a05a2c;
            --tv-wood-dark: #5c2e14;
            --dock-bg: rgba(245, 245, 245, 0.4);
            --glass-border: 1px solid rgba(255,255,255,0.45);
            --glass-shadow: 0 8px 32px rgba(0,0,0,0.1);
            --icon-size: 50px;
            --news-bg: #fdf6e3; 
            --news-ink: #2b2626;
            --morandi-green: #97a89e; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

                body, html {
    margin: 0; padding: 0; 
    width: 100vw;       
    height: 100vh;      
    overflow: hidden;   
    background-color: #cdd1d3; 
}

#screen { 
    position: fixed;    
    top: 0; 
    left: 0; 
    width: 100vw;       
    height: 100vh;      
    z-index: 0;
 
    background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2)); 
    background-size: cover;
    background-position: center;
}
        #pages-wrapper {
            display: flex; width: 100%; height: 100%;
            overflow-x: scroll; overflow-y: hidden;
            scroll-snap-type: x mandatory; scroll-behavior: smooth;
        }
        #pages-wrapper::-webkit-scrollbar { display: none; }

.page {
    min-width: 100%; height: 100%;
    padding-top: calc(40px + env(safe-area-inset-top)); 
    padding-left: 18px; padding-right: 18px;
    
    padding-bottom: 130px; 
    
    scroll-snap-align: start;
    display: flex; flex-direction: column; gap: 13px;
    align-items: center; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch; 
}
        .header-info {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 4px 0; margin-bottom: 0px; width: 100%; flex-shrink: 0;
        }
        .time-widget { 
            font-size: 3.25rem; font-weight: 700; color: #2c3e50; 
            line-height: 0.9; letter-spacing: -2px; 
            font-family: "Georgia", serif; 
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        .date-widget { 
            font-size: 0.85rem; font-weight: 600; color: #7f8c8d; 
            margin-top: 4px; text-transform: uppercase; letter-spacing: 2px;
        }
        .tv-container {
            width: 290px; height: 220px; flex-shrink: 0; position: relative; z-index: 1;
        }
        .tv-case {
            width: 100%; height: 100%;
            background: repeating-linear-gradient(90deg, var(--tv-wood-dark), var(--tv-wood-dark) 2px, var(--tv-wood-light) 3px, var(--tv-wood-light) 8px);
            border-radius: 16px; padding: 14px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; border: 4px solid #3e1e0f; 
        }
        .tv-bezel-wrapper {
            flex: 1; background: linear-gradient(to bottom, #d4cfc9, #8f8f8f);
            padding: 8px; border-radius: 8px; border: 1px solid #666;
            display: flex; overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .tv-screen-frame {
            width: 100%; height: 100%; background: #000; border-radius: 20px;
            position: relative; overflow: hidden; border: 2px solid #222;
            box-shadow: inset 0 0 20px rgba(0,0,0,1);
        }
        .tv-screen {
            width: 100%; height: 100%; 
            background: #111;
            position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
      .tv-content { 
    width: 100%; 
    height: 100%; 
    object-fit: fill; /* Âº∫Âà∂Êãâ‰º∏Â°´Êª°Â±èÂπïÔºåÂ¶ÇÊûúÊÉ≥‰øùÊåÅÊØî‰æãÂèØÁî® contain Êàñ cover */
    display: block; 
    position: absolute; /* ÁªùÂØπÂÆö‰ΩçÈò≤Ê≠¢Ë¢´Êå§Âéã */
    top: 0;
    left: 0;
    z-index: 1;
}
/* ÂêåÊó∂‰πüÁ°Æ‰øùÂ±èÂπïÂÆπÂô®ÊòØÁõ∏ÂØπÂÆö‰Ωç */
.tv-screen {
    width: 100%; height: 100%; 
    background: #111;
    position: relative; /* ÂÖ≥ÈîÆ */
    overflow: hidden;
    display: flex; justify-content: center; align-items: center;
}
        .crt-scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 5;
            background:
                linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 40%, rgba(255,255,255,0.05) 100%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.05) 3px);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
        }
       /* ÊêúÁ¥¢ .tv-control-panel Âπ∂ÊõøÊç¢‰∏∫‰ª•‰∏ãÂÜÖÂÆπ */
.tv-control-panel {
    height: 40px; 
    margin-top: 10px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    padding: 0 10px; 
    
    /* üëá ‰øÆÊîπËøôÈáåÔºöÂ∞ÜÂéüÊù•ÁöÑ hex È¢úËâ≤Êîπ‰∏∫ rgbaÔºåÊúÄÂêé‰∏Ä‰Ωç 0.8 Ë°®Á§∫ 80%‰∏çÈÄèÊòéÂ∫¶ */
    background: linear-gradient(to bottom, rgba(43, 21, 10, 0.8), rgba(62, 30, 15, 0.2)); 
    
    /* üëá Âª∫ËÆÆÂä†‰∏äËøô‰∏ÄË°åÔºåËÆ©ÈÄèËøáËÉåÊôØÁöÑÈÉ®ÂàÜÊúâÊ®°Á≥äÊÑüÔºåÊõ¥ÂÉèÁéªÁíÉ/‰∫öÂÖãÂäõ */
    backdrop-filter: blur(3px); 
    -webkit-backdrop-filter: blur(3px);

    border-radius: 4px;
    border-top: 1px solid rgba(255,255,255,0.1);
}
        .tv-logo-badge { 
            background: linear-gradient(to right, #d4af37, #f9e076); 
            padding: 2px 8px; font-family: serif; font-weight: bold; font-size: 0.7rem; color: #3e1e0f; 
            border-radius: 2px; letter-spacing: 1px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .tv-knobs { display: flex; gap: 12px; }
        .knob { 
            width: 24px; height: 24px; 
            background: radial-gradient(circle, #eee 30%, #bbb 100%); 
            border-radius: 50%; border: 1px solid #444; position: relative; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .add-btn-trigger { position: absolute; inset: 0; z-index: 20; cursor: pointer; }
        .middle-grid { 
            display: flex; width: 100%; min-height: 188px; gap: 13px; flex-shrink: 0;
        }
        .left-apps-grid {
            width: 45%;
            display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, 1fr);
            gap: 10px; align-items: center; justify-items: center;
        }
        .app-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.1s;}
        .app-item:active { transform: scale(0.95); }
        .app-icon {
            width: var(--icon-size); height: var(--icon-size); border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.4rem; color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .app-name { font-size: 0.65rem; color: #444; font-weight: 500; }
.newspaper-wrap {
    flex: 1; 
    background-color: #f4ecd8;
    background-image: 
        linear-gradient(90deg, rgba(0,0,0,0.02) 1px, transparent 1px),
        linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px);
    background-size: 20px 20px; 
    
    color: #2b2626; 
    padding: 7px;
    border: 1px solid #d6cbb0;
    box-shadow: 
        1px 1px 0px rgba(0,0,0,0.1),
        3px 3px 0px rgba(0,0,0,0.05),
        5px 5px 15px rgba(0,0,0,0.1);
    
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    position: relative;
    transform: rotate(0.5deg); 
    border-radius: 2px;
    transition: transform 0.2s;
    cursor: pointer;
}

.newspaper-wrap:active {
    transform: scale(0.98) rotate(0deg);
}

    padding-bottom: 3px; 
    margin-bottom: 4px; 
    text-align: center; 
}

.news-brand { 
    font-family: "Old English Text MT", serif; 
    font-size: 0.85rem; 
    line-height: 1; 
    color: #1a1a1a; 
    margin-bottom: 1px;
    text-shadow: 0 1px 0 rgba(255,255,255,0.5); 
}

.news-meta-bar { 
    border-top: 1px solid #2b2626; 
    padding-top: 1px; 
    display: flex; 
    justify-content: space-between; 
    font-size: 0.22rem; 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 1px;
    font-family: sans-serif;
}

.news-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
}

.news-headline { 
    font-family: "Times New Roman", serif; 
    font-weight: 900; 
    font-size: 0.65rem; 
    line-height: 0.9; 
    text-transform: uppercase; 
    text-align: center; 
    margin-bottom: 4px; 
    color: #111;
    letter-spacing: -0.5px;
}
.news-img-halftone {
    width: 100%; 
    height: 32px; 
    margin-bottom: 4px;
    border: 1px solid #333;
    background-image: radial-gradient(circle, #333 20%, transparent 25%); 
    background-size: 4px 4px;
    background-color: #e0dcd0; 
    filter: contrast(0.8) sepia(0.4);
    opacity: 0.6;
}

.news-text-columns { 
    column-count: 2; 
    column-gap: 8px; 
    column-rule: 1px solid rgba(0,0,0,0.1);
    font-family: "Georgia", serif; 
    font-size: 0.22rem; 
    line-height: 1.4; 
    text-align: justify; 
    color: #333;
}
.newspaper-wrap.custom-cover-mode {
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    background-color: transparent; 
    padding: 0; 
}

.newspaper-wrap.custom-cover-mode > * {
    opacity: 0; 
    pointer-events: none;
}

        .weather-glass {
            height: 73px; width: 100%; flex-shrink: 0;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 19px; border: var(--glass-border); box-shadow: var(--glass-shadow);
            display: flex; align-items: center; justify-content: space-between; padding: 0 21px;
            color: #333; margin-top: auto; 
        }
        .w-left h2 { margin: 0; font-size: 2.1rem; font-weight: 400; }
        .w-left p { margin: 0; font-size: 0.83rem; opacity: 0.7; }
        .w-icon { font-size: 2.6rem; }
     .dock-bar {
    position: fixed; 
    bottom: 26px;    
    
    left: 18px; right: 18px;
    height: 78px;
    background: var(--dock-bg); 
    backdrop-filter: blur(30px); 
    -webkit-backdrop-filter: blur(30px);
    border-radius: 30px; 
    display: flex; justify-content: space-around; align-items: center;
    border: var(--glass-border); 
    box-shadow: var(--glass-shadow); 
    z-index: 1000; 
}
        .page-2-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 22px 9px; padding-top: 35px; justify-items: center; width: 100%; }
        #tv-file-input { display: none; }
        .tv-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-family: monospace; font-size: 0.8rem; text-align: center; z-index: 4; text-shadow: 0 0 5px rgba(255,255,255,0.5); font-weight: bold;}
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f4ebe8; z-index: 2000;
            display: none; flex-direction: column;
            animation: fadeIn 0.3s ease;
            font-family: -apple-system, "Helvetica Neue", sans-serif;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header {
            padding: 0 20px; 
            height: 120px;
            padding-top: env(safe-area-inset-top); 
            background: #dcbdbd; color: #5e4b4b;
            font-size: 1.1rem; font-weight: bold;
            display: flex; justify-content: space-between; 
            align-items: flex-end; 
            padding-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0; 
        }
        .close-btn { background: none; border: none; font-size: 1.8rem; color: #5e4b4b; cursor: pointer; padding: 10px; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; }

        .morandi-card {
            background: rgba(255, 255, 255, 0.6); border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 15px rgba(189, 156, 156, 0.15); border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.8rem; color: #9e8a8a; margin-bottom: 5px; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e0d0d0;
            background: #fffdfd; color: #666; outline: none; transition: 0.2s;
        }
        .m-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .m-btn.primary { background: #cba8a8; color: white; }
        .m-btn.secondary { background: #e8d7d7; color: #7a6363; }
        .m-btn.small { flex: none; padding: 6px 12px; font-size: 0.8rem; background: #dcbdbd; color: white; }

        #fan-modal {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            align-items: center; justify-content: center;
        }
        .elec-screen-container {
            width: 90%; max-width: 500px;
            background: #111;
            border: 2px solid #333;
            box-shadow: 0 0 20px rgba(0, 255, 128, 0.2);
            border-radius: 10px;
            position: relative;
            padding: 5px;
            margin-bottom: 10vh;
        }
        .elec-screen {
            background: repeating-linear-gradient(0deg, rgba(0, 20, 0, 0.9), rgba(0, 20, 0, 0.9) 2px, rgba(0, 40, 0, 0.9) 3px);
            border: 1px solid #0f0;
            border-radius: 4px;
            min-height: 200px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: flex-start;
        }
        .elec-text {
            font-family: "Courier New", monospace;
            color: #0f0;
            font-size: 1.1rem;
            line-height: 1.5;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.8);
            white-space: pre-wrap;
            z-index: 2;
        }
        .scanline-anim {
            position: absolute; top: 0; left: 0; width: 100%; height: 10px;
            background: rgba(0, 255, 0, 0.3);
            opacity: 0.5;
            animation: scan 3s linear infinite;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }
        .elec-deco-bar {
            height: 20px;
            background: #222;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; margin-top: 5px;
        }
        .deco-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .deco-dot.active { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #chat-modal { 
            background: #f2f2f2; 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            flex-direction: column; 
            z-index: 2000; 
        }
               .chat-header {
            position: absolute; 
            top: 0; left: 0; right: 0;
            height: 120px;
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            display: flex; 
            align-items: flex-end; 
            justify-content: space-between;
            padding: 0 15px; 
            padding-bottom: 10px; 
            z-index: 110; 
        } 
        .chat-header-center { display: flex; flex-direction: column; align-items: center; width: 60%; }
        .chat-title-input {
            border: none; background: transparent; font-size: 1.1rem; font-weight: bold;
            text-align: center; width: 100%; outline: none; padding: 0; color: #000;
        }
        .chat-status-toggle {
            font-size: 0.75rem; color: #666; margin-top: 2px;
            background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .status-online .status-dot { background: #06c755; }
               .chat-body {
            position: relative; 
            flex: 1; 
            width: 100%;
            overflow-y: auto; 
            padding: 15px;
            padding-top: 110px; 
            padding-bottom: calc(max(20px, env(safe-area-inset-bottom)) + 70px);
            display: flex; flex-direction: column; gap: 15px;
            -webkit-overflow-scrolling: touch;
            background: transparent;
        }
        .chat-footer {
            position: absolute; 
            bottom: 0; left: 0; right: 0;
            min-height: 60px; 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.05);
            padding: 8px 10px; display: flex; align-items: center; gap: 8px;
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            z-index: 110;
        }
        .chat-func-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; cursor: pointer; color: #555; background: none; border: none; padding: 0;
        }
       #chat-input-text {
    flex: 1; /* Âç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
    width: 0; /* ÈÖçÂêàflex:1‰ΩøÁî®ÔºåÈò≤Ê≠¢ÂÜÖÂÆπËøáÂ§öÊíëÁ†¥ÂÆπÂô® */
    padding: 10px; 
    border-radius: 18px; 
    border: 1px solid rgba(255,255,255,0.4); 
    background: rgba(255,255,255,0.5); 
    font-size: 1rem; 
    outline: none; 
    height: 38px; 
    backdrop-filter: blur(5px);
}
        .chat-send-btn {
            background: transparent !important; 
            border: none;
            padding: 0; width: 40px; height: 36px; 
            color: #E6CAFF; 
            font-size: 1.8rem; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chat-send-btn {
    background: transparent !important; 
    border: none;
    padding: 0; 
    
    /* üëá Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂Âõ∫ÂÆöÂÆΩÂ∫¶ÔºåÁ¶ÅÊ≠¢Áº©Â∞è/ÊîæÂ§ß */
    width: 40px !important; 
    min-width: 40px !important; 
    flex-shrink: 0 !important; 
    /* üëÜ Ê†∏ÂøÉ‰øÆÂ§çÁªìÊùü */

    height: 36px; 
    color: #E6CAFF; 
    font-size: 1.8rem; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: transform 0.2s;
    text-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
        .quote-preview-bar {
            display: none; 
            width: 100%; 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-left: 4px solid #06c755;
            padding: 8px 10px; margin-bottom: 5px; border-radius: 4px;
            font-size: 0.85rem; color: #555;
            justify-content: space-between; align-items: center;
        }
        .quote-text-preview { 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85%;
        }
        .quote-close-btn { cursor: pointer; font-weight: bold; padding: 0 5px; color: #999; }
        .msg-quote-block {
            margin-bottom: 6px; padding: 4px 8px; 
            background: rgba(0,0,0,0.05); border-left: 3px solid #ccc;
            font-size: 0.75rem; color: #666; border-radius: 2px;
            display: flex; flex-direction: column;
        }
        .msg-quote-user { font-weight: bold; margin-bottom: 2px; }
        .msg-row.deleting { opacity: 1; }
        .msg-checkbox {
            width: 20px; height: 20px; margin-right: 10px; display: none;
            align-self: center;
        }
        .chat-body.delete-mode .msg-checkbox { display: block; }
        .chat-body.delete-mode .msg-avatar { pointer-events: none; } 
        .delete-toolbar {
            display: none; width: 100%; align-items: center; justify-content: space-between;
            color: #ff4444; font-weight: bold;
        }
        .msg-row { display: flex; gap: 8px; align-items: flex-start; max-width: 100%; width: 100%; }
        .msg-row.other { flex-direction: row; }
        .msg-row.me { flex-direction: row; justify-content: flex-end; }
        
        .msg-avatar { 
            width: 42px; height: 42px; background: #ccc; border-radius: 6px; flex-shrink: 0; 
            background-size: cover; background-position: center; border: 1px solid rgba(0,0,0,0.1);
            position: relative; overflow: visible; display: block; cursor: pointer; 
        }
        .avatar-frame { position: absolute; inset: -6px; width: calc(100% + 12px); height: calc(100% + 12px); pointer-events: none; z-index: 2; object-fit: contain; }
        .msg-bubble {
            padding: 10px 14px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4;
            word-wrap: break-word; max-width: 70%; position: relative;
            background: #fff; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: visible; 
        } 
        .msg-row.me .msg-bubble { background: #95ec69; color: #000; text-align: left; }
        .msg-image { max-width: 150px; border-radius: 8px; border: 1px solid #ddd; display: block;}

        .msg-row.system { justify-content: center; margin: 10px 0; }
        .msg-system-text { font-size: 0.75rem; color: #999; background: rgba(0,0,0,0.05); padding: 3px 10px; border-radius: 10px; }
        .load-more-container { width: 100%; display: flex; justify-content: center; padding: 10px 0; }
        .load-more-btn {
            background: rgba(0,0,0,0.05); color: #666; border: none;
            padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; cursor: pointer;
        }

     .chat-settings-panel {
    position: absolute; top: 0; right: 0; width: 85%; height: 100%;
    background: #fff; 
    z-index: 3000; /* ‚úÖ ÊîπÂ§ßÔºöÁ°Æ‰øùÊµÆÂú®ÊâÄÊúâÂÖÉÁ¥†ÊúÄ‰∏äÈù¢ */
    transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 20px; overflow-y: auto; 
    /* ‚úÖ ÊîπÂ§ßÔºöÈÅøÂºÄÈ°∂ÈÉ®ÁöÑÊ†áÈ¢òÊ†èÂå∫Âüü */
    padding-top: 130px !important; 
}  
        .chat-settings-panel.open { transform: translateX(0); }
        .range-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .range-group input { width: 70px; padding: 5px; text-align: center;}
        #sticker-modal {
            position: absolute; bottom: 70px; left: 10px; right: 10px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 10px; z-index: 150; display: none; border: 1px solid #ddd;
            height: 300px; display: flex; flex-direction: column;
        }
        .sticker-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 5px; }
        .sticker-item-wrap { position: relative; width: 100%; aspect-ratio: 1; }
        .sticker-img { width: 100%; height: 100%; object-fit: contain; cursor: pointer; border-radius: 4px; background: #f5f5f5; }
        .sticker-img:active { transform: scale(0.9); }
        .sticker-del-btn {
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            background: red; color: white; border-radius: 50%; font-size: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            display: none; 
        }
        .delete-mode .sticker-del-btn { display: flex; }
        .delete-mode .sticker-img { opacity: 0.7; }
        .sticker-toolbar { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #eee; }
        #wb-container { display: flex; height: 100%; overflow: hidden; background: #fdfaf8; border-radius: 12px; border: 1px solid #e6dada; }
        .wb-sidebar { width: 110px; background: #ece0e0; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #dcbdbd; }
        .wb-category { padding: 15px 10px; font-size: 0.8rem; color: #6b5858; border-bottom: 1px solid rgba(255,255,255,0.5); cursor: pointer; }
        .wb-category.active { background: #fff; color: #8b0000; font-weight: bold; border-left: 4px solid #8b0000; }
        .wb-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .wb-toolbar { padding: 10px; background: #fff; border-bottom: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end; }
        .wb-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .wb-entry { display: flex; align-items: center; gap: 10px; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #f0f0f0; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .wb-entry-info { flex: 1; overflow: hidden; }
        #wb-editor-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10; display: none; flex-direction: column; }
        .editor-header { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fdfaf8; }
        .editor-textarea { flex: 1; width: 100%; padding: 15px; border: 1px solid #eee; border-radius: 8px; resize: none; font-size: 1rem; outline: none; }

        .receipt-modal { background: #e0e0e0; }
        .receipt-card {
            background: var(--receipt-bg); width: 100%; max-width: 500px; margin: 0 auto; border-radius: 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative;
            font-family: 'Courier New', Courier, monospace; color: var(--receipt-ink);
            display: flex; flex-direction: column; height: 100%;
            mask-image: linear-gradient(to top, transparent 1%, black 2%);
        }
        .receipt-header { text-align: center; padding: 35px 20px 10px 20px; border-bottom: 2px dashed #ccc; }
        .receipt-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; letter-spacing: 2px; }
        .receipt-tabs { display: flex; justify-content: space-around; padding: 10px 0; border-bottom: 1px dashed #ccc; font-size: 0.8rem; font-weight: bold; }
        .r-tab { cursor: pointer; padding: 5px 10px; border-radius: 4px; opacity: 0.5; }
        .r-tab.active { opacity: 1; background: #eee; text-decoration: underline; }
        .receipt-body { flex: 1; overflow-y: auto; padding: 15px 20px; display: flex; flex-direction: column; gap: 8px; }
        .word-item { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px dotted #e0e0e0; padding-bottom: 5px; }
        .hidden-file-input { display: none; }
#card-table-desk {
    width: 100%; height: 100%;
    position: relative;
    overflow-y: auto; 
    overflow-x: hidden;
    background: radial-gradient(circle at center, #3c3c3c 0%, #1a1a1a 100%);
    box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    padding-bottom: 100px; 
}
#card-area {
    width: 100%; height: 100%;
    position: relative;
    transform-style: preserve-3d;
    perspective: 1000px;
}
.playing-card {
    position: absolute;
    width: 60px; height: 90px;
    background-color: #1e3a5f;
    background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 2px, transparent 2px, transparent 4px);
    border: 2px solid #fff;
    border-radius: 4px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    cursor: pointer;
    transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), z-index 0s;
    display: flex; justify-content: center; align-items: center;
    color: rgba(255,255,255,0.5); font-size: 1.5rem;
    transform-style: preserve-3d; 
}
.playing-card.flipped {
    background-color: #fff;
    background-image: none;
    transform: rotateY(180deg) scale(1) !important; 
    z-index: 1000 !important;
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
}
.playing-card-front {
    position: absolute; top:0; left:0; width:100%; height:100%;
    backface-visibility: visible; 
    transform: rotateY(180deg); 
    background-size: cover; background-position: center;
    border-radius: 4px;
    display: none; 
}
.playing-card.flipped .playing-card-front { display: block; }
.card-table-ui {
    position: absolute; bottom: 30px; left: 0; right: 0;
    display: flex; flex-direction: column; align-items: center; gap: 10px;
    z-index: 2000; pointer-events: none;
}
.card-table-ui button { pointer-events: auto; }
.paper-brand { font-family: "Old English Text MT", serif; font-size: 3rem; text-align: center; line-height: 1; margin-bottom: 5px; }
.paper-meta-row { display: flex; justify-content: space-between; border-top: 2px solid #000; border-bottom: 1px solid #000; padding: 4px 0; font-family: "Georgia", serif; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; }

.paper-split-body {
    display: flex;
    gap: 20px;
    height: calc(100% - 100px); 
}
.vertical-divider { width: 1px; background: #000; opacity: 0.3; height: 100%; flex-shrink: 0; }
.paper-col { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }

.col-header { text-align: center; margin-bottom: 15px; border-bottom: 3px double #ccc; padding-bottom: 10px; }
.col-tag { background: #000; color: #fff; padding: 2px 6px; font-size: 0.6rem; text-transform: uppercase; font-weight: bold; display: inline-block; margin-bottom: 5px; }
.col-header h3 { font-family: "Times New Roman", serif; font-size: 1.6rem; margin: 0; line-height: 1.1; }

.news-cards-strip { 
    display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #aaa; 
}
.mini-card-display { width: 40px; height: 60px; background: #ddd; border: 1px solid #333; background-size: cover; border-radius: 2px; }

.news-article { font-family: "Georgia", serif; font-size: 0.95rem; line-height: 1.6; text-align: justify; color: #111; }
.news-article h4 { font-size: 1.2rem; margin: 10px 0 5px 0; font-weight: bold; line-height: 1.2; text-align: left; }
.skeleton-text { color: #888; font-style: italic; text-align: center; margin-top: 50px; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
.finance-nav {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; color: #555; font-weight: bold;
}
.finance-nav button { background:none; border:none; font-size:1.2rem; color:#7d8c7c; cursor:pointer; }

.finance-chart-container {
    margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.5); 
    border-radius: 8px; font-size: 0.75rem;
}
.chart-row { display: flex; align-items: center; margin-bottom: 6px; }
.chart-label { width: 40px; text-align: right; margin-right: 8px; color: #666; }
.chart-bar-bg { flex: 1; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; }
.chart-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.chart-val { width: 50px; text-align: right; margin-left: 5px; color: #888; }

.cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
.cat-btn {
    padding: 8px 2px; border: 1px solid #ddd; border-radius: 6px; 
    background: #fff; color: #555; font-size: 0.8rem; cursor: pointer; text-align: center;
    transition: all 0.2s;
}
.cat-btn:active { transform: scale(0.95); }
.cat-btn.expense { border-color: #e8d7d7; color: #a33; }
.cat-btn.income { border-color: #d4e8d7; color: #366; }

.history-selector {
    position: absolute; top: 50px; right: 20px; 
    background: #fff; border: 1px solid #ccc; padding: 10px;
    border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    display: none; z-index: 10;
}
#tarot-result-area {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #fdfbf7;
    z-index: 150;
    display: none;
    flex-direction: column;
    overflow-y: auto; 
    padding: 80px 20px 50px 20px; 
    box-sizing: border-box;
}
#tarot-app-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden; 
    position: relative; 
}

#tarot-desk-area {
    flex: 1;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    background: radial-gradient(circle at center, #3c3c3c 0%, #1a1a2e 100%);
}

#tarot-card-spread {
    flex: 1;
    width: 100%;
    overflow-y: auto; 
    overflow-x: hidden;
    padding: 20px 10px 120px 10px; 
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-content: flex-start;
    gap: 12px;
}
.tarot-bottom-bar {
    position: absolute;
    bottom: 30px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    z-index: 100; 
    pointer-events: none; 
}
.tarot-bottom-bar button {
    pointer-events: auto; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    border-radius: 30px;
    padding: 12px 30px;
    font-weight: bold;
    transition: transform 0.1s;
}
.tarot-bottom-bar button:active { transform: scale(0.95); }
#selected-cards-header {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    justify-content: flex-start !important;
    align-items: flex-start !important;
    gap: 15px !important; 
    width: 100% !important;
    min-height: 140px !important; 
    padding: 10px 5px !important;
    margin-bottom: 20px !important;
    -webkit-overflow-scrolling: touch;
    position: relative;
    z-index: 10;
}
#selected-cards-header::-webkit-scrollbar {
    display: none;
}
.result-card-display {
    flex: 0 0 auto !important; 
    flex-shrink: 0 !important;
    width: 64px !important;
    height: auto !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    position: relative;
    margin: 0 !important;
}
.result-card-img {
    width: 60px !important;
    height: 90px !important;
    background-size: cover;
    background-position: center;
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.8);
    transition: transform 0.3s;
    margin-bottom: 8px !important;
}
.result-card-tag {
    position: static !important; 
    width: 100%;
    text-align: center;
    font-size: 0.7rem;
    line-height: 1.2;
    color: #333;
    font-weight: bold;
    word-wrap: break-word; 
    white-space: normal;
}
.reverse-tag {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) rotate(180deg) !important;
    
    background: rgba(180, 0, 0, 0.9);
    color: white;
    font-size: 0.5rem;
    padding: 2px 5px;
    border-radius: 3px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 5;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
#tarot-history-panel {
    z-index: 3000 !important; 
    background: #fdfbf7;
    box-shadow: -5px 0 20px rgba(0,0,0,0.2);
}
.tarot-card-item {
    width: 60px; 
    height: 90px;
    position: relative;
    cursor: pointer;
    perspective: 1000px; 
    margin: 5px; 
}
.tarot-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.tarot-card-item.picked .tarot-card-inner {
    transform: rotateY(180deg);
}
.t-card-front, .t-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden; 
    -webkit-backface-visibility: hidden;
    border-radius: 4px;
    top: 0; 
    left: 0;
}
.t-card-back {
    background: #1e272e;
    border: 2px solid #d2b48c;
    background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 4px);
    z-index: 2;
}
.t-card-front {
    background-color: #fff;
    background-size: cover;
    background-position: center;
    color: #333;
    display: flex;
    align-items: center; 
    justify-content: center;
    transform: rotateY(180deg); 
    border: 1px solid #ddd;
}

.letter-write-container {
    display: block; 
    width: 100%;
    height: 100%;
    overflow-y: auto; 
    padding: 20px;
    padding-bottom: 150px; 
    background: #e6e6e6; 
    box-sizing: border-box;
    -webkit-overflow-scrolling: touch; 
}
.paper-sheet {
    background-color: #fdf6e3;
    background-image: repeating-linear-gradient(#fdf6e3 0px, #fdf6e3 29px, #ccc 30px);
    background-attachment: local;     
    width: 100%;
    max-width: 600px;
    margin: 0 auto 30px auto; 
    padding: 30px 30px 50px 30px; 
    
    border-radius: 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    
    font-family: 'Long Cang', cursive, serif; 
    font-size: 1.3rem;
    line-height: 30px; 
    color: #2b2626;
    min-height: 80vh; 
    height: auto !important; 
    overflow: visible; 
    position: relative;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
}
.letter-textarea-clean {
    width: 100%; 
    min-height: 60vh;
    height: auto;
    border: none; 
    background: transparent; 
    resize: none; 
    outline: none;     
    font-family: inherit; 
    font-size: inherit;
    line-height: inherit;    
    overflow-y: hidden; 
    display: block;
    margin-top: 10px;
    flex: 1;
}
#reply-content-display {
    white-space: pre-wrap; 
    word-wrap: break-word;
    width: 100%;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
    min-height: 200px;
}
.sheet-user { 
    transform: rotate(-0.5deg); 
    background-color: #fdf6e3;
}
.sheet-reply { 
    background-color: #fff0f5; 
    background-image: repeating-linear-gradient(#fff0f5 0px, #fff0f5 29px, #dcbdbd 30px);
    transform: rotate(0.5deg); 
}
.sheet-dice-bar {
    display: flex; gap: 10px; justify-content: center;
    padding-bottom: 15px; border-bottom: 2px dashed #ccc;
    margin-bottom: 15px;
}
.receipt-gift-wrapper {
    background: #fff; 
    width: 300px;   
    max-width: 90%;
    max-height: 85vh; 
    overflow-y: auto;
    margin: auto;     
    padding: 20px;
    font-family: 'Courier New', Courier, monospace;
    color: #333;
    box-shadow: 0 0 20px rgba(0,0,0,0.5); 
    position: relative;
    border-top: 1px dashed #ccc;
    border-bottom: 1px dashed #ccc;
}
.receipt-gift-wrapper::before, .receipt-gift-wrapper::after {
    content: ""; position: absolute; left: 0; width: 100%; height: 4px;
    background-size: 8px 8px;
}
.receipt-gift-wrapper::before {
    top: -4px; background-image: radial-gradient(circle, #fff 4px, transparent 5px);
}
.receipt-gift-wrapper::after {
    bottom: -4px; background-image: radial-gradient(circle, #fff 4px, transparent 5px);
    background-position: 4px 0;
}
.gift-invoice-head { text-align: center; border-bottom: 2px dashed #333; padding-bottom: 10px; margin-bottom: 15px; }
.gift-invoice-title { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; }
.gift-invoice-meta { font-size: 0.7rem; color: #666; margin-top: 5px; text-transform: uppercase; }

.gift-item-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 1.1rem; }
.gift-desc-block { font-size: 0.85rem; text-align: justify; line-height: 1.4; border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 10px; }
.gift-reason-block { font-size: 0.7rem; background: #f0f0f0; padding: 8px; margin-top: 10px; border-radius: 4px; }
.gift-barcode { font-family: 'Libre Barcode 39', cursive; font-size: 2.5rem; text-align: center; margin-top: 15px; opacity: 0.7; transform: scaleY(0.8); }
.letter-write-container {
    height: 100%;
    overflow-y: auto;
    padding-bottom: 200px; 
}
.paper-sheet {
    height: auto !important; 
    min-height: 80vh; 
    overflow: visible; 
    display: flex;
    flex-direction: column;
}
.letter-textarea-clean {
    width: 100%;
    overflow-y: hidden; 
    height: auto;
    min-height: 300px;
    resize: none;
    display: block;
}
.tarot-bottom-bar {
    position: fixed; 
    bottom: 40px;    
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999 !important;
    display: flex;
    gap: 15px;
    background: rgba(0,0,0,0.8); 
    padding: 12px 30px;
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    width: auto;
    white-space: nowrap;
}
#theater-modal {
    background: #fff;
    transition: background 0.3s, color 0.3s;
}

.theater-theme-day {
    --th-bg: #f7f1e3;
    --th-text: #2c3e50;
    --th-accent: #8e44ad;
    --th-bar: #e5dbc9;
    --th-input-bg: rgba(255,255,255,0.6);
}

.theater-theme-night {
    --th-bg: #1e1e1e;
    --th-text: #a8a8a8;
    --th-accent: #9b59b6;
    --th-bar: #2d2d2d;
    --th-input-bg: rgba(0,0,0,0.3);
}
.theater-theme-green {
    --th-bg: #c7edcc; 
    --th-text: #2e3b2e; 
    --th-accent: #3e8e41;
    --th-bar: #b8dcb8; 
    --th-input-bg: rgba(255,255,255,0.5);
}

#theater-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background: var(--th-bg);
    color: var(--th-text);
    font-family: "Noto Serif SC", "Songti SC", serif; 
}
.theater-header {
    padding: 15px 20px;
    padding-top: max(15px, env(safe-area-inset-top));
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--th-bar);
    border-bottom: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.th-title { font-size: 1.2rem; font-weight: bold; color: var(--th-accent); }
#theater-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    padding-bottom: 50px;
    scroll-behavior: smooth;
}

.novel-segment {
    margin-bottom: 25px;
    position: relative;
    line-height: 1.8;
    font-size: 1.1rem;
    text-align: justify;
    padding-bottom: 15px;
    border-bottom: 1px dashed rgba(128,128,128,0.2);
}
.novel-segment p { margin-bottom: 15px; text-indent: 2em; }

.segment-del-btn {
    position: absolute;
    right: 0;
    top: 0;
    font-size: 0.8rem;
    color: #ff6b6b;
    opacity: 0.3;
    cursor: pointer;
    padding: 5px;
}
.novel-segment:hover .segment-del-btn { opacity: 1; }
.theater-footer {
    padding: 15px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
    background: var(--th-bar);
    border-top: 1px solid rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.th-input-row { display: flex; gap: 10px; align-items: flex-end; }
.th-textarea {
    flex: 1;
    background: var(--th-input-bg);
    border: 1px solid rgba(128,128,128,0.3);
    border-radius: 8px;
    padding: 10px;
    font-family: inherit;
    font-size: 1rem;
    resize: none;
    outline: none;
    height: 60px;
    color: var(--th-text);
}
.th-textarea:focus { border-color: var(--th-accent); }

.th-btn {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
    background: var(--th-accent);
    color: white;
    font-size: 0.9rem;
    white-space: nowrap;
}
.th-btn:active { transform: scale(0.95); }
.th-btn.secondary { background: rgba(128,128,128,0.2); color: var(--th-text); }
.th-loading {
    text-align: center;
    padding: 20px;
    color: var(--th-accent);
    font-style: italic;
    animation: th-pulse 1.5s infinite;
}
@keyframes th-pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
#theater-history-panel {
    z-index: 2500;
    background: var(--th-bg);
    color: var(--th-text);
}
.period-theme {
    --p-bg: #fce4ec;
    --p-card: #fff0f5;
    --p-accent: #d81b60;
    --p-text: #880e4f;
}

#period-modal {
    background: #fdfbf7; 
}

.cycle-dashboard {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
    border-radius: 16px;
    padding: 20px;
    color: var(--p-text);
    box-shadow: 0 4px 15px rgba(216, 27, 96, 0.15);
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.cycle-status-text {
    font-size: 1.8rem;
    font-weight: bold;
    font-family: "Georgia", serif;
    margin: 10px 0;
}

.cycle-sub-text {
    font-size: 0.9rem;
    opacity: 0.8;
}

.period-toggle-btn {
    background: white;
    color: var(--p-accent);
    border: 1px solid var(--p-accent);
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
}
.period-toggle-btn.active {
    background: var(--p-accent);
    color: white;
    box-shadow: 0 0 10px rgba(216, 27, 96, 0.4);
}

.ai-care-card {
    background: white;
    border-left: 4px solid var(--p-accent);
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.recipe-box {
    background: #fff;
    border: 1px dashed #aaa;
    padding: 15px;
    margin-top: 10px;
    font-family: "Courier New", monospace;
    font-size: 0.85rem;
}

.history-log-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
    color: #555;
}
.cycle-dashboard {
    height: auto !important;
    min-height: 120px !important;
    overflow: visible !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 20px !important;
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%) !important;
    color: #880e4f !important;
}

.cycle-status-text {
    display: block !important;
    color: #880e4f !important;
    opacity: 1 !important;
}

.period-toggle-btn {
    display: inline-block !important;
    opacity: 1 !important;
    z-index: 10 !important;
    cursor: pointer !important;
}
#forum-modal {
    background: #f2f3f5; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
.forum-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
}
.forum-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 20px;
}
.forum-thread-header {
    background: #fff;
    padding: 20px 15px;
    margin-bottom: 10px;
    border-bottom: 1px solid #e1e1e1;
}
.forum-title-text {
    font-size: 1.3rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
    line-height: 1.4;
}
.forum-post-row {
    background: #fff;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}
.forum-avatar {
    width: 40px;
    height: 40px;
    border-radius: 4px; 
    background-color: #ddd;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}
.forum-content-col {
    flex: 1;
}
.forum-user-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}
.forum-username {
    font-size: 0.9rem;
    color: #666;
    font-weight: bold;
}
.forum-lz-tag {
    background: #fffbf0;
    color: #ff9c00;
    border: 1px solid #ff9c00;
    font-size: 0.6rem;
    padding: 0 4px;
    border-radius: 2px;
    margin-left: 5px;
}
.forum-floor-num {
    font-size: 0.8rem;
    color: #999;
}
.forum-text-body {
    font-size: 1rem;
    color: #111;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}
.forum-action-bar {
    margin-top: 10px;
    display: flex;
    gap: 20px;
    font-size: 1.2rem;
    color: #999;
}
.forum-icon-btn { cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem;}
.forum-footer-bar {
    background: #fff;
    padding: 10px 15px;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
    border-top: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.forum-input-settings {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 5px;
    font-size: 0.8rem;
}
.fridge-body {
    height: 90%; 
    width: 95%; 
    max-width: 480px;
    margin: auto;
    display: flex; 
    flex-direction: column;
    position: relative;
    overflow: hidden;
    background-color: #f8f9fa;
    background-image: radial-gradient(circle at 50% 30%, #ffffff 0%, #e3f2fd 80%);
    border: 12px solid #cfd8dc;
    border-radius: 36px;
    box-shadow: 
        inset 0 0 60px rgba(0,0,0,0.15), 
        0 20px 50px rgba(0,0,0,0.3);     
}
.fridge-body::after {
    content: "";
    position: absolute; top: 0; left: 10%; right: 10%; height: 60px;
    background: radial-gradient(ellipse at center, rgba(255,255,255,0.9) 0%, transparent 70%);
    opacity: 0.8;
    pointer-events: none;
    z-index: 1;
}
.fridge-shelf {
    position: relative; 
    z-index: 5;
    padding: 5px 15px;
    display: flex; 
    align-items: flex-end; 
    gap: 8px;
    width: 100%;
    background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.4), rgba(255,255,255,0.1));
    border-bottom: 6px solid rgba(220, 240, 255, 0.6); 
    box-shadow: 0 8px 10px -5px rgba(0,0,0,0.1); 
}
.shelf-label {
    position: absolute; right: 10px; bottom: 8px;
    font-size: 0.6rem; color: #b0bec5; font-weight: 800; text-transform: uppercase;
    letter-spacing: 1px; pointer-events: none; z-index: 2;
}
.shelf-1 {
    height: 20%;
    align-items: flex-end;
    justify-content: space-around;
    padding-bottom: 5px;
}
.condiment-jar {
    display: flex; flex-direction: column; align-items: center;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: pointer; transform-origin: bottom center;
    position: relative; opacity: 0.5; filter: grayscale(0.5);
}
.condiment-jar.active {
    opacity: 1; filter: grayscale(0);
    transform: scale(1.15) translateY(-5px);
    z-index: 10;
}
.jar-cap {
    width: 24px; height: 10px;
    background: linear-gradient(to right, #78909c, #455a64);
    border-radius: 3px; box-shadow: 0 2px 3px rgba(0,0,0,0.2);
}
.jar-body {
    width: 30px; height: 45px;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 6px 6px 8px 8px;
    position: relative; overflow: hidden;
    box-shadow: inset 2px 0 5px rgba(255,255,255,0.4);
}
.jar-liquid {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
    transition: background 0.3s;
    border-top: 1px solid rgba(255,255,255,0.5);
}
.jar-name {
    font-size: 0.6rem; margin-top: 2px; color: #546e7a; font-weight: bold;
    text-shadow: 0 1px 0 rgba(255,255,255,0.8);
}
.jar-type-ËÄóÊ≤π .jar-liquid { background: #4e342e; } 
.jar-type-ÁîüÊäΩ .jar-liquid { background: #212121; } 
.jar-type-Áõê .jar-liquid { background: #f5f5f5; height: 80%; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size:3px 3px;}
.jar-type-Á≥ñ .jar-liquid { background: #fff9c4; height: 75%; opacity: 0.9; }
.jar-type-ÈÜã .jar-liquid { background: #3e2723; height: 65%; }
.jar-type-ÊñôÈÖí .jar-liquid { background: #ffb74d; opacity: 0.8; }
.jar-type-Ê≤π .jar-liquid { background: #ffeb3b; opacity: 0.8; }
.shelf-2 {
    height: 18%;
    justify-content: space-evenly;
}
.staple-item {
    background: #fff;
    border: 1px solid #eceff1;
    border-radius: 10px;
    padding: 5px 12px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: 0.2s; cursor: pointer;
    font-size: 0.85rem; color: #455a64;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-width: 60px;
}
.staple-item.active {
    background: #fff8e1; border-color: #ffecb3;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(255, 193, 7, 0.2);
    color: #f57f17; font-weight: bold;
}
.staple-count { font-size: 0.7rem; color: #aaa; margin-top: 2px; }
.staple-item.active .staple-count { color: #f9a825; }
.shelf-3, .shelf-4 {
    height: 22%;
    padding: 0; 
    border-bottom: none; 
    background: none; 
    box-shadow: none;
    display: flex;
    justify-content: center;
    align-items: center;
    perspective: 800px; 
}
.crisper-drawer {
    width: 92%; height: 90%;
    background: rgba(255, 255, 255, 0.25);
    border: 2px solid rgba(255, 255, 255, 0.6);
    border-radius: 0 0 16px 16px;
    border-top: 4px solid rgba(255,255,255,0.8); 
    
    backdrop-filter: blur(4px);
    box-shadow: 
        inset 0 10px 20px rgba(255,255,255,0.4),
        0 5px 15px rgba(0,0,0,0.05);
        
    display: flex; flex-wrap: wrap; 
    align-content: flex-start; gap: 8px;
    padding: 12px;
    overflow-y: auto;
    position: relative;
    transition: transform 0.2s;
}
.drawer-handle-label {
    position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.9);
    padding: 2px 10px; border-radius: 10px 10px 0 0;
    font-size: 0.65rem; color: #78909c; font-weight: bold; text-transform: uppercase;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
}
.ing-tag {
    padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; 
    cursor: pointer; font-weight: 500;
    display: flex; align-items: center; gap: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.1s;
}
.ing-tag:active { transform: scale(0.95); }
.ing-tag.veg { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
.ing-tag.meat { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.add-ing-btn {
    width: 28px; height: 28px; border-radius: 50%;
    background: rgba(255,255,255,0.5); 
    border: 1px dashed #90a4ae; color: #78909c;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.2rem; transition: 0.2s;
}
.add-ing-btn:hover { background: #fff; border-color: #29b6f6; color: #29b6f6; }
.shelf-5 {
    flex: 1; 
    background: linear-gradient(to bottom, #cfd8dc, #b0bec5); 
    border-top: 1px solid #fff;
    border-bottom: none;
    box-shadow: inset 0 5px 10px rgba(0,0,0,0.1);
    
    display: flex; justify-content: center; align-items: center;
    padding: 0;
}
.smart-screen {
    width: 60%; height: 70%;
    background: #000;
    border-radius: 12px;
    border: 2px solid #546e7a;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    color: #4fc3f7; cursor: pointer;
    overflow: hidden; position: relative;
    transition: all 0.2s;
}
.smart-screen:active { transform: scale(0.96); border-color: #29b6f6; }
.smart-screen-icon { font-size: 1.8rem; margin-bottom: 5px; }
.smart-screen-text { font-size: 0.75rem; letter-spacing: 1px; font-family: sans-serif;}
.smart-screen::before {
    content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: screenShine 5s infinite;
}
@keyframes screenShine { 0% { left: -100%; } 20% { left: 100%; } 100% { left: 100%; } }

#call-overlay {
    border-radius: 24px; 
    background: #0f172a; 
}
.recipe-note-card {
    background: #fff9c4;
    color: #333;
    font-family: "Comic Sans MS", cursive, sans-serif;
    transform: rotate(-1deg);
    box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
    border-top: 8px solid rgba(255,255,0,0.3); 
}
.fridge-history-panel {
    position: absolute; right: 0; top: 0; height: 100%; width: 260px;
    background: #fdfbf7;
    border-left: 1px solid #ddd;
    box-shadow: -5px 0 20px rgba(0,0,0,0.1);
    z-index: 20;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px; overflow-y: auto;
}
.fridge-history-panel.open { transform: translateX(0); }
#fridge-modal {
    background: #f2f4f6 !important; 
    align-items: flex-end;
    padding: 0 !important;
}
.fridge-app-container {
    width: 100%; height: 100%;
    background: #f2f4f6;
    display: flex; flex-direction: column;
    position: relative;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}
        .fridge-header-clean {
            height: 90px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex; 
            align-items: flex-end;
            justify-content: space-between;
            padding: 0 15px;
            padding-bottom: 10px;
            flex-shrink: 0;
        }
.fh-btn { border:none; background:none; font-size:1rem; color:#333; cursor:pointer; font-weight: 500;}
.fh-title { font-weight: bold; font-size: 1.1rem; color:#333; }
.fh-icon { font-size: 1.5rem; color:#333; cursor:pointer; transform: rotate(-30deg); }
.fridge-scroll-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    padding-bottom: 120px;
}

.section-title {
    font-size: 0.85rem; color: #8898aa; margin: 20px 0 10px 5px; font-weight: bold;
}
.condiments-grid {
    display: flex; gap: 15px; overflow-x: auto; padding: 15px 10px;
    background: #fff; border-radius: 12px; margin-bottom: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.flat-bottle {
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    opacity: 0.3; transition: 0.2s; min-width: 50px; cursor: pointer; filter: grayscale(100%);
}
.flat-bottle.active { opacity: 1; transform: scale(1.05); filter: grayscale(0%); }
.bottle-shape {
    width: 32px; height: 50px;
    border-radius: 6px;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.bottle-shape::before {
    content: ""; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
    width: 14px; height: 5px; border-radius: 2px;
}
.b-oil .bottle-shape { background: #fdd835; } 
.b-oil .bottle-shape::before { background: #e53935; } 

.b-dark .bottle-shape { background: #5d4037; } 
.b-dark .bottle-shape::before { background: #d84315; }

.b-black .bottle-shape { background: #212121; } 
.b-black .bottle-shape::before { background: #ef5350; }

.b-white .bottle-shape { background: #fff; border:1px solid #ddd;} 
.b-white .bottle-shape::before { background: #bdbdbd; width:28px; height: 3px; top: 2px;}

.b-wine .bottle-shape { background: #ffca28; } 
.b-wine .bottle-shape::before { background: #d84315; }

.bottle-name { font-size: 0.7rem; color: #555; }
.staples-row {
    display: flex; justify-content: space-around;
    background: #fff; padding: 20px; border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.staple-icon-btn {
    position: relative; display: flex; flex-direction: column; align-items: center;
    opacity: 0.4; transition: 0.2s; cursor: pointer;
}
.staple-icon-btn.active { opacity: 1; }
.staple-img { font-size: 1.8rem; margin-bottom: 5px; }
.staple-badge {
    position: absolute; top: -5px; right: -8px;
    background: #ff3b30; color: white; font-size: 0.6rem;
    padding: 2px 6px; border-radius: 10px; font-weight: bold; min-width: 18px; text-align: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.staple-label { font-size: 0.8rem; color: #333; }
.tags-container {
    display: flex; flex-wrap: wrap; gap: 10px;
    padding: 5px;
}
.ing-tag-pill {
    background: #fff;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem; color: #333;
    display: flex; align-items: center; gap: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e0e0e0;
}
.ing-tag-pill .count { 
    color: #888; font-size: 0.9rem; background: #f0f0f0; 
    padding: 0 6px; border-radius: 4px;
}
.ing-tag-pill .del-x { color: #ff3b30; margin-left: 2px; cursor: pointer; font-weight: bold; opacity: 0.6;}

.add-circle-btn {
    width: 38px; height: 38px; border-radius: 50%;
    border: 1px dashed #bbb; color: #bbb;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; background: transparent; cursor: pointer;
}
.fridge-footer-fixed {
    position: absolute; bottom: 30px; left: 20px; right: 20px;
    z-index: 10;
}
.big-call-btn {
    width: 100%; height: 56px;
    background: #00e0ff; /* ‰∫ÆÈùíËìù */
    background: linear-gradient(to right, #00c6ff, #0072ff);
    color: white; border: none; border-radius: 28px;
    font-size: 1.1rem; font-weight: bold;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    box-shadow: 0 10px 20px rgba(0, 114, 255, 0.3);
    transition: transform 0.1s; cursor: pointer;
}
.big-call-btn:active { transform: scale(0.98); }
#wechat-call-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000;
    z-index: 9999;
    display: none; flex-direction: column; align-items: center;
    color: white;
    padding-top: 10vh;
}
.wx-minimize { position: absolute; top: 50px; left: 20px; opacity: 0.7; font-size: 1.5rem; cursor: pointer;}
.wx-avatar {
    width: 110px; height: 110px; border-radius: 12px;
    background-size: cover; background-position: center;
    margin-bottom: 25px; 
    background-color: #333; border: 1px solid #444;
}
.wx-name { font-size: 1.8rem; font-weight: 500; margin-bottom: 10px; }
.wx-status { font-size: 1rem; opacity: 0.6; margin-bottom: 30px; font-weight: 300;}

.wx-subtitle-box {
    width: 85%; max-height: 250px; overflow-y: auto;
    text-align: center; color: rgba(255,255,255,0.9);
    font-size: 1.1rem; line-height: 1.6;
    padding: 10px; 
    background: rgba(255,255,255,0.05);
    border-radius: 16px;
    backdrop-filter: blur(10px);
    margin-bottom: 20px;
}

.wx-footer-btns {
    margin-top: auto; margin-bottom: 60px;
    display: flex; justify-content: space-around; width: 100%; padding: 0 30px;
}
.wx-btn-col { display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer;}
.wx-round-btn {
    width: 72px; height: 72px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; color: white;
    transition: 0.2s;
}
.wx-round-btn:active { filter: brightness(0.8); }
.wx-btn-hangup { background: #ff3b30; }
.wx-btn-normal { background: rgba(255,255,255,0.15); backdrop-filter: blur(5px);}
.wx-btn-label { font-size: 0.8rem; opacity: 0.7; }
#fridge-history-panel {
    position: absolute;
    top: 50px; 
    right: 0;
    bottom: 0; 
    width: 280px;
    background: #fdfbf7; 
    border-left: 1px solid #e0e0e0;
    box-shadow: -5px 0 20px rgba(0,0,0,0.1);
    z-index: 2000; 
    transform: translateX(100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px;
    overflow-y: auto;
}
#fridge-history-panel.open {
    transform: translateX(0); 
}
.sticky-paper {
    background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); 
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.15);
    font-family: "Comic Sans MS", cursive, sans-serif; 
    color: #5d4037;
    position: relative;
    transform: rotate(-1deg); 
    transition: transform 0.2s;
    border-radius: 2px;
}
.sticky-paper:nth-child(even) {
    transform: rotate(1deg);
    background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); 
}
.sticky-paper:hover {
    transform: scale(1.02) rotate(0deg); 
    z-index: 10;
    box-shadow: 5px 10px 15px rgba(0,0,0,0.2);
}
.sticky-paper::before {
    content: "";
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 20px;
    background: rgba(255, 255, 255, 0.4);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transform: translateX(-50%) rotate(-2deg);
}
#sticky-note-modal {
    display: none; 
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.6);
    z-index: 3000;
}
.big-sticky-note {
    width: 80%;
    max-width: 400px;
    min-height: 400px;
    background: #fff9c4;
    padding: 30px;
    box-shadow: 10px 10px 30px rgba(0,0,0,0.3);
    font-family: "Comic Sans MS", cursive, sans-serif;
    position: relative;
    display: flex;
    flex-direction: column;
}
.note-pin {
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
    font-size: 2rem; color: #d32f2f; text-shadow: 2px 2px 2px rgba(0,0,0,0.3);
}
#note-detail-content {
    white-space: pre-wrap;      
    line-height: 1.6; 
    font-size: 0.95rem; 
    color: #3e2723; 
    flex: 1;         
    overflow-y: auto;           
    max-height: 55vh;           
    padding-right: 5px;         
    margin-bottom: 10px;
    background-image: repeating-linear-gradient(transparent, transparent 27px, #d7ccc8 28px);
    background-attachment: local;
}
.fridge-item-large {
    grid-column: span 1; 
    grid-row: span 2;    
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); 
    border-radius: 24px; 
    border: 4px solid #fff; 
    box-shadow: 
        inset 5px 5px 15px rgba(255,255,255,0.8), 
        inset -5px -5px 10px rgba(210, 180, 140, 0.2), 
        0 8px 15px rgba(0,0,0,0.1);             
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s;
    padding: 10px; 
}
.fridge-item-large::before {
    content: "";
    position: absolute;
    top: 35%; 
    left: 10px;
    right: 10px;
    height: 2px;
    background: rgba(0,0,0,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.5);
}
.fridge-handle {
    position: absolute;
    left: 12px;
    top: 40%; 
    width: 8px;
    height: 52px;
    background: linear-gradient(to right, #e0e0e0, #ffffff, #bdbdbd);
    border-radius: 6px;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
}
.fridge-sticker {
    font-size: 1.9rem;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
    transform: rotate(8deg);
    margin-top: -20px; 
    margin-left: 15px; 
}
#fridge-modal {
    background: #fffbe7 !important; 
}
.fridge-header-clean {
    background: rgba(255,255,255,0.6) !important;
    backdrop-filter: blur(10px);
    border-bottom: 1px dashed #e6dca0 !important;
}
.fridge-app-container {
    background: #fffbe7 !important;
}
.condiments-grid, .staples-row, .tags-container, .ing-tag-pill {
    border: 1px solid #fff !important;
    background: rgba(255,255,255,0.7) !important;
    box-shadow: 0 4px 10px rgba(230, 210, 160, 0.2) !important;
}
#pickup-modal {
    background: #f0f2f5; 
    display: none;
    flex-direction: column;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.pickup-header {
    background: #fff;
    border-bottom: 1px solid #dcdcdc;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    padding-top: max(10px, env(safe-area-inset-top));
    flex-shrink: 0;
    z-index: 10;
}
#pickup-chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: #aebfd0;
}
.pup-row {
    display: flex;
    gap: 10px;
    max-width: 100%;
}
.pup-row.left { justify-content: flex-start; }
.pup-row.right { justify-content: flex-end; }
.pup-avatar {
    width: 40px; height: 40px;
    border-radius: 6px;
    background-color: #ccc;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}
.pup-bubble {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 1rem;
    line-height: 1.5;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.pup-row.right .pup-bubble {
    background: #ffe033; 
    color: #000;
}
.pup-row.right .pup-bubble::after {
    content: ""; position: absolute; right: -6px; top: 14px;
    border-top: 6px solid transparent; border-bottom: 6px solid transparent;
    border-left: 6px solid #ffe033;
}

.pup-row.left .pup-bubble {
    background: #fff;
    color: #000;
}
.pup-row.left .pup-bubble::before {
    content: ""; position: absolute; left: -6px; top: 14px;
    border-top: 6px solid transparent; border-bottom: 6px solid transparent;
    border-right: 6px solid #fff;
}
.pickup-footer {
    background: #f7f7f7;
    border-top: 1px solid #dcdcdc;
    padding: 10px;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.pickup-input-group {
    display: flex;
    gap: 10px;
}

.pup-textarea {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px;
    font-size: 0.95rem;
    resize: none;
    height: 60px;
    outline: none;
}
#pickup-history-panel {
    z-index: 2100;
    background: #fff;
}
.memo-widget-wide {
    grid-column: span 2; 
    grid-row: span 1;    
    width: 100%;
    height: 100%;
    min-height: 95px;
    background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%); 
    border-radius: 12px;
    padding: 12px;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s;
    display: flex;
    flex-direction: column;
}
.memo-widget-wide:active { transform: scale(0.98); }
.memo-widget-wide::before {
    content: ""; position: absolute; top: 0; right: 0;
    border-width: 0 15px 15px 0;
    border-style: solid;
    border-color: rgba(0,0,0,0.1) #fff rgba(0,0,0,0.1) rgba(0,0,0,0.1); 
    box-shadow: -1px 1px 1px rgba(0,0,0,0.1);
}
.memo-preview-text {
    font-family: "Comic Sans MS", cursive, sans-serif;
    color: #5d4037;
    font-size: 0.85rem;
    line-height: 1.4;
    white-space: pre-wrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 4; 
    -webkit-box-orient: vertical;
}
.album-shelf-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    padding: 20px;
}
.album-cover-item {
    aspect-ratio: 3/4;
    background: #d7ccc8; 
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
    border-radius: 4px 10px 10px 4px;
    box-shadow: 
        inset 5px 0 10px rgba(0,0,0,0.1), 
        3px 5px 10px rgba(0,0,0,0.2);
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    border-left: 6px solid #8d6e63; 
    overflow: hidden;
}
.album-cover-item:active { transform: scale(0.96); }
.album-cover-text {
    font-family: "Courier New", monospace;
    font-weight: bold;
    color: #3e2723;
    background: rgba(255,255,255,0.6);
    padding: 5px 10px;
    transform: rotate(-2deg);
    box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    max-width: 90%;
    text-align: center;
}
.album-photo-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
    padding: 10px;
}
.photo-thumb {
    aspect-ratio: 1;
    background-color: #eee;
    background-size: cover;
    background-position: center;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
}
#photo-viewer-modal {
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    perspective: 1000px; 
}
.held-photo-card {
    background: #fff;
    padding: 15px 15px 50px 15px; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transform: rotate(5deg) translateY(100vh); 
    transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    max-width: 80%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

.held-photo-card.slide-in {
    transform: rotate(-2deg) translateY(0); 
}
.held-photo-img {
    max-width: 100%;
    max-height: 45vh;
    object-fit: contain;
    background: #eee;
}
.ann-card {
    height: 140px;
    width: 100%;
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    background-color: #eee;
    position: relative;
    overflow: hidden;
    color: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.6);
    transition: transform 0.2s;
}
.ann-card:active { transform: scale(0.98); }
.ann-card::before {
    content: ""; position: absolute; inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.6));
    z-index: 1;
}
.ann-content { position: relative; z-index: 2; }
.ann-days { font-size: 2.5rem; font-weight: bold; line-height: 1; }
.ann-label { font-size: 0.9rem; opacity: 0.9; }
.ann-date-text { font-size: 0.8rem; opacity: 0.8; font-family: monospace; }
.ann-del-btn {
    position: absolute; top: 10px; right: 10px; z-index: 3;
    background: rgba(0,0,0,0.4); border-radius: 50%; width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; cursor: pointer; color: #fff;
}
.dream-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #333;
}
.dream-table th, .dream-table td {
    border: 1px solid #e1bee7;
    padding: 8px;
    text-align: left;
}
.dream-table th {
    background-color: #f3e5f5;
    color: #4a148c;
    font-weight: bold;
    width: 35%; 
}
.dream-table td {
    background-color: #fff;
}
#dream-card-table-desk {
    width: 100%; height: 100%;
    position: relative;
    overflow-y: auto; 
    overflow-x: hidden;
    background: radial-gradient(circle at center, #4a148c 0%, #1a0528 100%);
    box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    padding-bottom: 100px; 
}
#dream-card-area {
    width: 100%; height: 100%;
    position: relative;
    transform-style: preserve-3d;
    perspective: 1000px;
}
/* --- ÊâæÂà∞ÂéüÊúâÁöÑ .hp-app-icon Âπ∂ÊõøÊç¢‰∏∫‰ª•‰∏ãÂÜÖÂÆπ --- */
.hp-app-icon {
    width: 52px; 
    height: 52px;
    border-radius: 10px; /* Â¶ÇÊûúÂõæÊ†áÊú¨Ë∫´ÊúâÂúÜËßíÔºåÂèØ‰ª•ËÆæ‰∏∫0ÊàñÊõ¥Â∞è */
    display: flex; 
    justify-content: center; 
    align-items: center;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    transition: transform 0.1s;
    
    /*‰ª•Ê≠§‰∏ãÊòØÂÖ≥ÈîÆ‰øÆÊîπÔºöËÆ©ÂÆÉÊòæÁ§∫ÂõæÁâá */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    background-color: transparent !important; /* ÂéªÊéâÂéüÊù•ÁöÑËÉåÊôØËâ≤ */
    font-size: 0 !important; /* ÈöêËóèÂéüÊù•ÁöÑ emoji */
    color: transparent !important;
    border: none !important;
}
.hp-app-icon:active { transform: scale(0.9); }
.hp-app-icon:active { transform: scale(0.9); }
.hp-icon-label {
    font-size: 0.6rem; color: white; text-align: center; margin-top: 4px; text-shadow: 0 1px 2px black;
}
.hp-wechat-row {
    display: flex; gap: 10px; background: white; padding: 10px; border-bottom: 1px solid #eee; align-items: center; cursor: pointer;
}
.hp-wechat-avatar {
    width: 40px; height: 40px; border-radius: 4px; background: #ddd; background-size: cover;
}
.hp-chat-bubble {
    padding: 8px 12px; border-radius: 4px; max-width: 80%; margin-bottom: 10px; font-size: 0.95rem;
}
.hp-chat-bubble.me { background: #95ec69; align-self: flex-end; margin-left: auto; }
.hp-chat-bubble.other { background: white; align-self: flex-start; }
.hp-xhs-card {
    background: white; border-radius: 8px; overflow: hidden; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.hp-xhs-img { height: 120px; background: #eee; width: 100%; object-fit: cover; }
.hp-taobao-item {
    display: flex; gap: 10px; background: white; margin-bottom: 10px; padding: 10px; border-radius: 8px;
}
.hp-memo-item {
    background: #fff9c4; padding: 15px; margin-bottom: 10px; border-radius: 5px; font-family: "Comic Sans MS", cursive; border-left: 4px solid #fbc02d;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.study-task-card {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    border: 1px solid #eceff1;
    transition: all 0.2s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.study-task-card:active { transform: scale(0.98); }
.study-task-card.completed {
    background: #f1f8e9; 
    border-color: #c5e1a5;
}

.study-task-header {
    display: flex; 
    align-items: center; 
    justify-content: space-between;
}

.study-day-tag {
    background: #eceff1;
    color: #546e7a;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
}
.study-task-card.completed .study-day-tag {
    background: #c8e6c9;
    color: #2e7d32;
}

.study-task-content {
    margin-top: 8px;
    font-size: 1rem;
    color: #333;
    line-height: 1.5;
}
.study-task-card.completed .study-task-content {
    text-decoration: line-through;
    color: #888;
}
.study-quote-box {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed #a5d6a7;
    color: #2e7d32;
    font-size: 0.9rem;
    font-family: "KaiTi", "STKaiti", serif; 
    display: none; 
    animation: fadeIn 0.5s;
}
.study-task-card.completed .study-quote-box {
    display: block;
}

.check-icon {
    width: 20px; height: 20px;
    border: 2px solid #cfd8dc;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: transparent;
}
.study-task-card.completed .check-icon {
    background: #66bb6a;
    border-color: #66bb6a;
    color: white;
}
.theme-app-item {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    padding: 10px; background: #fff; border-radius: 8px; border: 1px solid #eee; cursor: pointer;
}
.theme-icon-preview {
    width: 40px; height: 40px; border-radius: 8px; background: #eee; background-size: cover; background-position: center;
}
.stamp-item {
    width: 100%; aspect-ratio: 1; background: #fff; border: 1px dashed #ccc; 
    background-size: contain; background-repeat: no-repeat; background-position: center;
    position: relative;
}
.stamp-del {
    position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; 
    background: red; color: white; border-radius: 50%; font-size: 10px; 
    display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.reply-stamp-gift {
    position: absolute;
    width: 130px; 
    height: 130px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    mix-blend-mode: normal; 
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));   
    cursor: pointer;
    z-index: 20;    
    transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.reply-stamp-gift:active {
    transform: translateX(-50%) scale(0.92) !important;
    filter: brightness(0.9);
}
.custom-font-applied { font-family: inherit !important; }
#theme-modal .modal-body {
    display: flex;
    flex-direction: column;
    padding: 0;
    background: #f2f4f6;
}
#theme-modal .modal-body > div:first-child {
    flex-shrink: 0; 
    padding: 15px 15px 5px 15px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    z-index: 10;
}
.theme-tab-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 15px;
    padding-bottom: 100px; 
}
#app-icon-list {
    padding-top: 5px; 
}
.font-setting-item {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    border: 1px solid #eee;
}
.font-setting-item label {
    font-weight: bold;
    color: #555;
    margin-bottom: 8px;
    display: block;
}
.game-console-widget {
    grid-column: span 4;
    grid-row: span 2;  
    width: 100%;
    height: 100%;
    min-height: 155px;
    background: #2d3436; 
    border-radius: 20px;
    position: relative;
    box-shadow: 0 10px 20px rgba(0,0,0,0.4), inset 0 -5px 10px rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    border: 4px solid #444;
}
.gc-dpad {
    position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
    width: 60px; height: 60px;
    background: radial-gradient(#444, #222);
    clip-path: polygon(33% 0, 66% 0, 66% 33%, 100% 33%, 100% 66%, 66% 66%, 66% 100%, 33% 100%, 33% 66%, 0 66%, 0 33%, 33% 33%);
    box-shadow: inset 2px 2px 5px rgba(255,255,255,0.1);
}
.gc-btns {
    position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
    width: 60px; height: 60px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
}
.gc-btn {
    width: 25px; height: 25px; border-radius: 50%;
    background: #e74c3c; box-shadow: 0 3px 0 #c0392b;
}
.gc-btn:nth-child(2) { margin-top: 10px; background: #f1c40f; box-shadow: 0 3px 0 #f39c12; }
.gc-screen-area {
    width: 60%; height: 80%;
    background: #000;
    border-radius: 4px;
    border: 4px solid #111;
    overflow: hidden;
    position: relative;
    display: flex; align-items: center; justify-content: center;
}
.gc-screen-img {
    width: 100%; height: 100%; object-fit: cover; opacity: 0.8;
}
.gc-scanline {
    position: absolute; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.3) 3px);
    pointer-events: none;
}
#game-modal {
    background: #000;
    perspective: 1000px;
}
.game-interface {
    width: 100%; height: 100%;
    background-size: cover; background-position: center;
    position: relative;
    overflow: hidden;
    font-family: "Noto Serif SC", serif;
}
.game-stats-panel {
    position: absolute; top: 70px; left: 10px;
    background: rgba(0,0,0,0.6);
    padding: 8px; border-radius: 8px; border: 2px solid #fff;
    display: flex; gap: 10px; align-items: center;
    z-index: 50;
    backdrop-filter: blur(4px);
}
.game-avatar {
    width: 50px; height: 50px; border-radius: 4px;
    background: #ccc; background-size: cover; border: 1px solid #fff;
}
.game-bars { display: flex; flex-direction: column; gap: 5px; width: 120px; }
.g-bar-row { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: white; }
.g-bar-bg { flex: 1; height: 6px; background: #333; border-radius: 3px; overflow: hidden; border: 1px solid #666; }
.g-bar-fill { height: 100%; transition: width 0.5s; }
.g-val { width: 25px; text-align: right; }
.half-body {
    position: absolute; bottom: 0;
    height: 70%; 
    width: auto; max-width: 60%;
    object-fit: contain;
    transition: opacity 0.3s, transform 0.3s;
    filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
    z-index: 10;
}
.hb-char { left: -50px; transform: translateX(0); }
.hb-user { right: -50px; transform: translateX(0); }
.hb-hidden { opacity: 0; transform: translateY(20px); pointer-events: none; }
/* === ‰øÆÊîπÂºÄÂßãÔºöRPG ÂØπËØùÊ°ÜÊªëÂä®‰øÆÂ§ç === */
.rpg-dialog-box {
    position: absolute; bottom: 20px; left: 20px; right: 20px;
    height: 140px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
    background: rgba(0, 0, 0, 0.85);
    border: 3px solid #fff;
    border-radius: 8px;
    padding: 15px;
    z-index: 100; 
    color: #fff;
    box-shadow: 0 5px 20px rgba(0,0,0,0.8);
    display: flex; 
    flex-direction: column;
}
.rpg-name {
    color: #f1c40f; font-weight: bold; font-size: 1.1rem; margin-bottom: 8px;
    text-shadow: 1px 1px 0 #000;
    flex-shrink: 0; /* Èò≤Ê≠¢ÂêçÂ≠óË¢´ÂéãÁº© */
}

.rpg-name {
    color: #f1c40f; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;
    text-shadow: 1px 1px 0 #000;
}
.rpg-text {
    font-size: 1rem; 
    line-height: 1.6; 
    text-align: justify; 
    flex: 1; /* Âç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
    overflow-y: auto; /* ÂÖ≥ÈîÆÔºöÂÖÅËÆ∏ÂûÇÁõ¥ÊªëÂä® */
    padding-right: 5px; /* ÁªôÊªöÂä®Êù°ÁïôÁÇπ‰ΩçÁΩÆ */
    word-wrap: break-word;
    -webkit-overflow-scrolling: touch; /* iOS‰∏ùÊªëÊªöÂä® */
}
/* === ‰øÆÊîπÁªìÊùü === */
.rpg-cursor {
    display: inline-block; width: 8px; height: 15px; background: #fff;
    animation: blink 1s infinite; vertical-align: middle;
}
@keyframes blink { 50% { opacity: 0; } }
.game-input-overlay {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: rgba(0,0,0,0.9); padding: 15px;
    z-index: 200; display: none; 
    flex-direction: column; gap: 10px;
}
.game-input-row { display: flex; gap: 10px; }
.game-input {
    flex: 1; background: #222; border: 1px solid #555; color: white;
    padding: 10px; border-radius: 4px; outline: none;
}
.game-history-btn {
    position: absolute; top: 70px; right: 10px;
    background: rgba(255,255,255,0.2); border: 1px solid #fff;
    color: #fff; padding: 5px 10px; border-radius: 4px;
    z-index: 60; cursor: pointer; font-size: 0.8rem;
}
.card-meaning-display {
    font-size: 0.7rem; color: #aaa; margin-top: 5px; font-style: italic; border-top: 1px dashed #555; padding-top: 3px;
}
#game-card-table-desk {
    width: 100%; 
    height: 100%;
    background: radial-gradient(circle at center, #2d3436 0%, #000000 100%);
    position: relative;
    overflow-y: auto; 
    overflow-x: hidden;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    padding-bottom: 100px;
}
#game-card-area {
    width: 100%; 
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    perspective: 1000px;
}
.sys-toast-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px); 
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none; 
}
.sys-toast-container.show {
    transform: translateX(-50%) translateY(0);
}

.sys-toast-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border-radius: 20px;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 90vw;
    pointer-events: auto;
    cursor: pointer;
    animation: toastPop 0.4s forwards;
}

@keyframes toastPop {
    0% { opacity: 0; transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1); }
}

.toast-icon { font-size: 1.5rem; }
.toast-body { flex: 1; display: flex; flex-direction: column; }
.toast-title { font-size: 0.85rem; font-weight: bold; color: #333; }
.toast-msg { font-size: 0.75rem; color: #666; margin-top: 2px; }
.bottle-shape {
    width: 32px !important;
    height: 50px !important;
    background-color: #e0e0e0;
    border: 1px solid rgba(0,0,0,0.1);
}
.b-oil .bottle-shape { background-color: #fdd835 !important; }
.b-dark .bottle-shape { background-color: #5d4037 !important; }
.b-black .bottle-shape { background-color: #212121 !important; }
.b-white .bottle-shape { background-color: #ffffff !important; }
.b-wine .bottle-shape { background-color: #ffca28 !important; }
/* === RPG Ê≤âÊµ∏ÂºèÈô™‰º¥Ê†∑Âºè === */
.comp-rpg-dialog-box {
    position: absolute;
    bottom: 20px;
    left: 15px;
    right: 15px;
    height: 160px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
    background: rgba(0, 0, 0, 0.85); /* Ê∑±Ëâ≤ÂçäÈÄèÊòéÂ∫ï */
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    padding-top: 25px;
    z-index: 20;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

.comp-rpg-name-tag {
    position: absolute;
    top: -15px;
    left: 20px;
    background: #6c5ce7;
    color: #fff;
    padding: 4px 15px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
}

.comp-rpg-text {
    flex: 1;
    color: #fff;
    font-size: 1.05rem;
    line-height: 1.6;
    font-family: "Songti SC", serif; /* ÂÆã‰ΩìÊõ¥ÊúâÊñáÂ≠¶ÊÑü */
    overflow-y: auto; /* ÂÜÖÂÆπËøáÂ§öÊó∂ÂÖÅËÆ∏ÂÜÖÈÉ®ÊªöÂä® */
    text-shadow: 0 1px 2px #000;
    white-space: pre-wrap;
}

/* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÁïôÂäüËÉΩ */
.comp-rpg-text::-webkit-scrollbar { width: 0; }

.comp-rpg-sub {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.6);
    margin-top: 5px;
    font-style: italic;
    min-height: 15px;
}

/* ÊâìÂ≠óÊú∫ÂÖâÊ†á */
.comp-cursor {
    display: inline-block;
    width: 8px; height: 16px;
    background: #fff;
    vertical-align: sub;
    animation: blink 1s infinite;
}
/* ÊïôÂØº APP ‰∏ìÁî®Ê†∑Âºè */
.quiz-option {
    padding: 12px 15px;
    background: #f1f2f6;
    border: 1px solid #dfe4ea;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
}
.quiz-option:active { transform: scale(0.98); }
.quiz-option.correct {
    background: #4cd137 !important; color: white !important; border-color: #44bd32 !important;
}
.quiz-option.wrong {
    background: #e84118 !important; color: white !important; border-color: #c23616 !important;
    animation: shake 0.4s;
}
.quiz-index {
    font-weight: bold; margin-right: 10px; opacity: 0.6;
}
@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}
/* === Êñ∞Â¢ûÔºöËØ≠Èü≥ÂΩïÂà∂‰∏éÊòæÁ§∫Ê†∑Âºè === */
@keyframes pulse-red { 
    0% { transform: scale(1); opacity: 1; } 
    50% { transform: scale(1.2); opacity: 0.8; } 
    100% { transform: scale(1); opacity: 1; } 
}
.recording-active {
    color: #ff4444 !important;
    animation: pulse-red 1.5s infinite;
}
.audio-bubble {
    display: flex; align-items: center; gap: 8px; cursor: pointer;
    min-width: 80px; padding-right: 10px;
}
.audio-icon { font-size: 1.2rem; }
.audio-duration { font-size: 0.8rem; opacity: 0.8; }
/* üå∏ È¶ôÁâá APP ‰∏ìÁî®Ê†∑Âºè */
#scent-grid {
    padding-bottom: 50px;
}

.scent-chip {
    aspect-ratio: 3/4;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #fce4ec;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s;
    position: relative;
    overflow: hidden;
}

.scent-chip:active {
    transform: scale(0.95);
}

/* Êú™ÁøªÂºÄÁä∂ÊÄÅ (ËÉåÈù¢) */
.scent-chip.closed {
    background: linear-gradient(135deg, #fdfbf7 0%, #fff0f5 100%);
    background-image: radial-gradient(#d81b60 1px, transparent 1px);
    background-size: 10px 10px;
}
.scent-chip.closed::after {
    content: "No. " attr(data-index);
    font-family: "Courier New", monospace;
    color: #d81b60;
    font-weight: bold;
    background: #fff;
    padding: 2px 8px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* ÁøªÂºÄÁä∂ÊÄÅ */
.scent-chip.revealed {
    background: #fff;
}

.scent-icon {
    font-size: 1.8rem;
    margin-bottom: 5px;
}

.scent-name-mini {
    font-size: 0.75rem;
    color: #5d4037;
    text-align: center;
    padding: 0 5px;
    font-weight: bold;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* ÂéÜÂè≤ÂàóË°®È°π */
.scent-history-card {
    background: #fff;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    border-left: 4px solid #d4a5a5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
/* üß© ÊãºÂõæÊ∏∏ÊàèÊ†∑Âºè */
.puzzle-board {
    width: 300px;
    height: 300px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 2px;
    background: #2d3436;
    padding: 2px;
    border-radius: 4px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.puzzle-piece {
    width: 100%;
    height: 100%;
    position: relative;
    cursor: pointer;
    transform-style: preserve-3d;
    transition: transform 0.6s, border 0.2s;
}

.puzzle-piece.selected {
    border: 2px solid #00cec9;
    z-index: 10;
    box-shadow: 0 0 10px #00cec9;
}

/* ÁøªËΩ¨Âä®Áîª */
.puzzle-piece.flipped {
    transform: rotateY(180deg);
}

.puzzle-face, .puzzle-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

/* Ê≠£Èù¢ÔºöÂõæÁâáÁ¢éÁâá */
.puzzle-face {
    background-size: 300px 300px; /* ‰∏é board Â§ßÂ∞è‰∏ÄËá¥ */
    background-repeat: no-repeat;
    background-color: #eee;
}

/* ËÉåÈù¢ÔºöÊïÖ‰∫ãÊñáÊú¨ */
.puzzle-back {
    transform: rotateY(180deg);
    background: #fff;
    color: #2d3436;
    font-size: 0.6rem; /* Â≠ó‰ΩìË¶ÅÊûÅÂ∞èÊâçËÉΩÂ°ûËøõÂ∞èÊ†ºÂ≠ê */
    padding: 5px;
    text-align: center;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    overflow-y: auto;
    word-break: break-all;
    line-height: 1.2;
}

/* ÂéÜÂè≤ÂàóË°®Áº©Áï•Âõæ */
.puzzle-history-thumb {
    width: 100%;
    height: 150px;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    position: relative;
}
.puzzle-history-thumb::after {
    content: "üß©";
    position: absolute;
    bottom: 5px; right: 5px;
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
    width: 25px; height: 25px;
    text-align: center;
    line-height: 25px;
}
/* ÊäΩÂç°Âä®ÁîªÁΩëÊ†º */
.gacha-grid-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    width: 95%;
    max-width: 800px;
    perspective: 1000px;
}

/* Âç°ÁâáÂÆπÂô® */
.gacha-card-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 2/3; /* ‰πôÂ•≥Ê∏∏ÊàèÂç°ÁâåÈÄöÂ∏∏ËæÉÈïø */
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
    opacity: 0; /* ÂàùÂßãÈöêËóèÔºåÁî®‰∫éÂä®Áîª */
    transform: translateY(50px);
}

.gacha-card-wrapper.visible {
    opacity: 1;
    transform: translateY(0);
}

.gacha-card-wrapper.flipped {
    transform: rotateY(180deg);
}

/* Âç°Èù¢Ê≠£Âèç */
.gacha-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(255,255,255,0.2);
}

/* Âç°ËÉå (Áªü‰∏Ä) */
.gacha-back {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    border: 2px solid #fff;
}

/* Âç°Ê≠£ (ÂÜÖÂÆπ) */
.gacha-front {
    transform: rotateY(180deg);
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gacha-front-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.gacha-frame {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 5;
    background-size: 100% 100%;
}

/* ÂÖâÊïà */
.gacha-shine {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent);
    transform: rotate(45deg);
    animation: shine 0.5s;
    pointer-events: none;
    display: none;
}
@keyframes shine { from { left: -100%; } to { left: 100%; } }

.gacha-card-wrapper.flipped .gacha-shine {
    display: block;
}

/* ÊâãÊú∫ÈÄÇÈÖçÔºöÂçÅËøûÊäΩÂèòÊàê‰∏§Ë°åÊªëÂä®ÊàñÁ¥ßÂáëÂ∏ÉÂ±Ä */
@media (max-width: 600px) {
    .gacha-grid-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 10px;
    }
}
/* === üßÇ ‰ªøÁúüË∞ÉÊñôÁì∂Ê†∑Âºè === */
.condiments-grid {
    /* Âº∫Âà∂Ê®™ÂêëÊªöÂä®Ôºå‰∏çÊç¢Ë°å */
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    justify-content: flex-start !important;
    padding-left: 15px !important;
    padding-right: 15px !important;
    /* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÁïôÂäüËÉΩ */
    scrollbar-width: none; 
}
.condiments-grid::-webkit-scrollbar { display: none; }

.real-bottle-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    margin-right: 12px;
    flex-shrink: 0; /* Á¶ÅÊ≠¢Ë¢´ÂéãÁº© */
    opacity: 0.4;
    filter: grayscale(0.8);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: pointer;
    position: relative;
    width: 40px; /* Áªô‰∏™Âõ∫ÂÆöÂÆΩÂ∫¶Âç†‰Ωç */
    height: 90px;
}

/* === üßÇ ‰ªøÁúüË∞ÉÊñôÁì∂ (ProÁâà) === */

/* ÂÆπÂô®ÔºöÊ®™ÂêëÊéíÂàó */
.condiments-grid {
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    justify-content: flex-start !important;
    padding: 10px 15px !important;
    gap: 15px !important;
    /* ÈöêËóèÊªöÂä®Êù° */
    scrollbar-width: none; 
}
.condiments-grid::-webkit-scrollbar { display: none; }

/* Âçï‰∏™Áì∂Â≠êÂåÖË£Ö */
.real-bottle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    position: relative;
    flex-shrink: 0;
    width: 45px; 
    height: 100px;
    opacity: 0.4; /* Êú™Êã•ÊúâÊó∂ÂçäÈÄèÊòé+ÁÅ∞Â∫¶ */
    filter: grayscale(0.8) contrast(0.8);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
}

/* ÊøÄÊ¥ªÁä∂ÊÄÅ */
.real-bottle-item.active {
    opacity: 1;
    filter: grayscale(0) contrast(1);
    transform: translateY(-8px) scale(1.05);
    z-index: 10;
}
/* ÈÄâ‰∏≠Êó∂Â∫ïÈÉ®Êúâ‰∏™ÂÖâÂúàÊïàÊûú */
.real-bottle-item.active::after {
    content: ""; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
    width: 30px; height: 5px; background: rgba(0,0,0,0.1); border-radius: 50%;
    filter: blur(2px); z-index: -1;
}

/* ÈÄöÁî®ÈÉ®‰ª∂ */
.b-body {
    position: relative; overflow: hidden;
    box-shadow: inset -3px -3px 5px rgba(0,0,0,0.2), 1px 1px 4px rgba(0,0,0,0.15);
}
/* È´òÂÖâ (Ê®°ÊãüÁéªÁíÉÂèçÂÖâ) */
.b-highlight {
    position: absolute; top: 0; left: 5px; width: 3px; height: 100%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.6), rgba(255,255,255,0.1));
    border-radius: 2px; pointer-events: none;
}
.b-label {
    position: absolute; background: #fff; color: #333; font-weight: bold; font-family: sans-serif;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2); text-align: center;
}
.b-label.vertical {
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 16px; padding: 2px 0; font-size: 0.6rem; border-radius: 2px; writing-mode: vertical-rl;
}
.b-label.simple {
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    padding: 1px 4px; font-size: 0.5rem; border-radius: 2px;
}

/* --- 1. Ê≤πÊ°∂ (Fat Bottle) --- */
.type-fat .b-body {
    width: 38px; height: 55px;
    border-radius: 8px 8px 10px 10px;
    border: 1px solid rgba(0,0,0,0.1);
}
.type-fat .b-cap {
    width: 14px; height: 8px; border-radius: 2px 2px 0 0; margin-bottom: 0px; z-index: 2;
}
.type-fat .b-handle {
    position: absolute; top: 38px; right: 0px;
    width: 10px; height: 20px;
    border: 3px solid #e15f41; border-left: none;
    border-radius: 0 8px 8px 0;
}
.type-fat .b-liquid {
    position: absolute; bottom: 0; width: 100%; height: 85%;
    background: linear-gradient(to top, rgba(243, 156, 18, 0.8), rgba(241, 196, 15, 0.5));
}

/* --- 2. ÁªÜÈ´òÁì∂ (Bottle - ÈÖ±Ê≤π/ÈÜã/ÊñôÈÖí) --- */
.type-bottle .b-cap {
    width: 12px; height: 10px; border-radius: 2px; z-index: 3;
    box-shadow: inset -1px 0 2px rgba(0,0,0,0.3);
}
.type-bottle .b-neck {
    width: 8px; height: 8px; margin-bottom: -1px; z-index: 2;
}
.type-bottle .b-shoulder {
    width: 24px; height: 6px; border-radius: 10px 10px 0 0; z-index: 2;
}
.type-bottle .b-body {
    width: 24px; height: 50px; border-radius: 0 0 6px 6px;
}

/* --- 3. ËÄóÊ≤π (Oyster) --- */
.type-oyster .b-pump {
    width: 16px; height: 10px; border-radius: 3px; z-index: 3;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.type-oyster .b-neck {
    width: 10px; height: 8px; margin-bottom: -1px; border-radius: 2px;
}
.type-oyster .b-body {
    width: 26px; height: 58px; border-radius: 6px 6px 8px 8px;
    display: flex; align-items: center; justify-content: center;
}
.type-oyster .b-label {
    position: static; transform: none; writing-mode: vertical-rl; height: 70%;
    font-family: serif; border: 1px solid #ddd;
}

/* --- 4. ÁüÆÁΩê (Jar - Áõê/Á≥ñ) --- */
.type-jar .b-lid {
    width: 30px; height: 6px; border-radius: 3px; z-index: 2;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.type-jar .b-body {
    width: 28px; height: 35px; border-radius: 0 0 5px 5px;
    border: 1px solid rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.3); /* ÁéªÁíÉÊÑü */
}
.type-jar .b-powders {
    position: absolute; bottom: 2px; left: 2px; right: 2px; height: 70%;
    border-radius: 0 0 4px 4px;
    background-image: radial-gradient(rgba(0,0,0,0.05) 1px, transparent 1px);
    background-size: 3px 3px;
}

/* --- 5. Á†îÁ£®Áì∂ (Shaker - ËÉ°Ê§í) --- */
.type-shaker .b-knob {
    width: 22px; height: 12px; border-radius: 4px 4px 0 0; margin-bottom: 0;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2);
}
.type-shaker .b-body {
    width: 22px; height: 40px; border-radius: 0 0 4px 4px;
}
.type-shaker .b-grain {
    position: absolute; bottom: 0; width: 100%; height: 80%;
    background-image: radial-gradient(#555 1px, transparent 1px);
    background-size: 2px 2px;
}

/* Â∫ïÈÉ®ÊñáÂ≠ó */
.b-name-text {
    font-size: 0.65rem; color: #555; margin-top: 5px; font-weight: bold;
    text-shadow: 0 1px 0 #fff;
}
/* === üßÇ ÊûÅÁÆÄ‰ªøÁúüË∞ÉÊñôÁì∂ (Morandi Style) === */

/* Ê®™ÂêëÊªöÂä®ÂÆπÂô® */
.condiments-grid {
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    justify-content: flex-start !important;
    padding: 15px 20px !important;
    gap: 18px !important; /* Â¢ûÂä†Èó¥Ë∑ù */
    scrollbar-width: none; 
    align-items: flex-end !important; /* Â∫ïÈÉ®ÂØπÈΩê */
}
.condiments-grid::-webkit-scrollbar { display: none; }

/* Âçï‰∏™Áì∂Â≠êÂÆπÂô® */
.real-bottle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    position: relative;
    flex-shrink: 0;
    width: 40px; 
    height: 90px;
    opacity: 0.3; /* Êú™ÊøÄÊ¥ªÊó∂Êõ¥Ê∑°ÔºåËûçÂÖ•ËÉåÊôØ */
    filter: grayscale(0.5); /* ÂæÆÂæÆÁÅ∞Â∫¶ */
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
}

/* ÊøÄÊ¥ªÁä∂ÊÄÅ */
.real-bottle-item.active {
    opacity: 1;
    filter: grayscale(0);
    transform: translateY(-5px);
}

/* === ÈÄöÁî®ÁªÑ‰ª∂ === */

/* Áì∂Ë∫´ÁéªÁíÉË¥®ÊÑü */
.min-body {
    position: relative;
    background: rgba(255, 255, 255, 0.2); /* ÂçäÈÄèÊòéÁéªÁíÉÂ∫ï */
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 
        inset 1px 1px 3px rgba(255,255,255,0.2), 
        2px 2px 5px rgba(0,0,0,0.05); /* ÊüîÂíåÊäïÂΩ± */
    overflow: hidden;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
}

/* Ê∂≤‰Ωì */
.min-liquid {
    position: absolute; bottom: 0; left: 0; width: 100%;
    /* Ê∂≤‰ΩìË°®Èù¢ÂæÆÂæÆÂºØÊõ≤ÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü */
    border-radius: 50% 50% 0 0 / 5px 5px 0 0; 
    opacity: 0.9;
}

/* È´òÂÖâÂèçÂÖâÊù° (ÁîªÈæôÁÇπÁùõ‰πãÁ¨î) */
.min-gloss {
    position: absolute; top: 5%; left: 15%; width: 20%; height: 80%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
    border-radius: 10px;
    pointer-events: none;
}

/* === 1. Ê≤πÊ°∂ (Fat) === */
.style-fat .min-body {
    width: 36px; height: 50px;
    border-radius: 8px 8px 10px 10px;
}
.style-fat .min-cap {
    width: 12px; height: 6px; background: #ccc;
    border-radius: 2px 2px 0 0; margin-bottom: 0px; z-index: 2;
}
/* ÊääÊâãÔºöÁî®ÂúÜÁéØÊ®°Êãü */
.style-fat .min-handle {
    position: absolute; top: 38px; right: -2px;
    width: 10px; height: 22px;
    border: 3px solid rgba(255,255,255,0.6); 
    border-left: none;
    border-radius: 0 8px 8px 0;
    box-shadow: 1px 1px 2px rgba(0,0,0,0.05);
}

/* === 2. ÁªÜÈ´òÁì∂ (Tall Bottle) === */
.style-bottle .min-body {
    width: 24px; height: 55px;
    border-radius: 6px 6px 8px 8px;
}
.style-bottle .min-neck {
    width: 10px; height: 8px; background: rgba(255,255,255,0.3);
    margin-bottom: -2px; z-index: 1; border: 1px solid rgba(255,255,255,0.2);
}
.style-bottle .min-cap {
    width: 12px; height: 10px; border-radius: 2px; z-index: 2;
    box-shadow: inset -1px 0 2px rgba(0,0,0,0.1);
}

/* === 3. ËÄóÊ≤πÁì∂ (Oyster) === */
.style-oyster .min-body {
    width: 26px; height: 60px;
    border-radius: 6px 6px 8px 8px;
}
/* Ê≥µÂ§¥ */
.style-oyster .min-pump {
    width: 18px; height: 8px; border-radius: 4px 4px 2px 2px; z-index: 2;
    position: relative;
}
.style-oyster .min-pump::after { /* Ê≥µÂò¥ */
    content: ""; position: absolute; left: -3px; top: 2px;
    width: 6px; height: 3px; background: inherit; border-radius: 2px 0 0 2px;
}
.style-oyster .min-neck {
    width: 10px; height: 6px; background: rgba(255,255,255,0.3); margin-bottom: -1px;
}

/* === 4. ÁüÆÁΩê (Jar) === */
.style-jar .min-body {
    width: 32px; height: 36px;
    border-radius: 4px 4px 8px 8px;
    background: rgba(255,255,255,0.15);
}
.style-jar .min-lid {
    width: 34px; height: 5px; border-radius: 2px; z-index: 2;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* === 5. Á†îÁ£®Áì∂ (Shaker) === */
.style-shaker .min-body {
    width: 22px; height: 45px;
    border-radius: 4px;
}
.style-shaker .min-knob {
    width: 22px; height: 14px; border-radius: 4px 4px 0 0;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,0.1);
}

/* Â∫ïÈÉ®ÊñáÂ≠ó (Êõ¥È´òÁ∫ßÁöÑÁÅ∞Ëâ≤) */
.b-name-text {
    font-size: 0.65rem; color: #7f8c8d; 
    margin-top: 6px; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    letter-spacing: 0.5px;
}
/* ÈÄâ‰∏≠ÂêéÊñáÂ≠óÂèòÊ∑± */
.real-bottle-item.active .b-name-text {
    color: #2c3e50; font-weight: 600;
}
/* === ÊñáÊ∏∏ (Text Adventure) ‰∏ìÁî®Ê†∑Âºè === */
#adv-modal {
    background: #000;
    z-index: 9999;
    display: none; /* ÈªòËÆ§ÈöêËóè */
    flex-direction: column;
    font-family: "Noto Serif SC", serif;
}

/* È°∂ÈÉ®Ê†è */
.adv-top-bar {
    height: 80px;
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 2px solid #000;
    display: flex;
    align-items: center;
    padding: 0 20px;
    padding-top: env(safe-area-inset-top);
    justify-content: space-between;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 100;
}

.adv-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.adv-avatar {
    width: 50px;
    height: 50px;
    border: 2px solid #000;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    background-color: #ddd;
}

.adv-stats {
    display: flex;
    flex-direction: column;
    font-size: 0.8rem;
    color: #333;
    font-weight: bold;
}

.adv-exit-btn {
    padding: 8px 20px;
    background: #000;
    color: #fff;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-family: serif;
}

/* Âú∫ÊôØÂÆπÂô® */
#adv-scene-container {
    flex: 1;
    position: relative;
    background-color: #333;
    background-size: cover;
    background-position: center;
    overflow: hidden;
}

/* Áªü‰∏ÄÊåâÈíÆÊ†∑ÂºèÔºöÁôΩÂ∫ïÈªëÂ≠óÈªëÊ°Ü */
.adv-btn {
    position: absolute;
    background: #fff;
    color: #000;
    border: 2px solid #000;
    padding: 10px 20px;
    font-weight: bold;
    font-size: 0.9rem;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.8);
    cursor: pointer;
    transition: transform 0.1s;
    text-align: center;
    min-width: 100px;
}

.adv-btn:active {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0px rgba(0,0,0,0.8);
}

/* ÊåâÈíÆ‰ΩçÁΩÆÁ±ª */
.pos-center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
.pos-top-mid { top: 15%; left: 50%; transform: translateX(-50%); }
.pos-top-left { top: 15%; left: 10%; }
.pos-top-right { top: 15%; right: 10%; }
.pos-btm-mid { bottom: 15%; left: 50%; transform: translateX(-50%); }
.pos-btm-left { bottom: 15%; left: 10%; }
.pos-btm-right { bottom: 15%; right: 10%; }
/* ÂàóË°®ÂºèÊåâÈíÆÂÆπÂô® (Áî®‰∫éÂïÜÂú∫Â∑¶‰æßÂàóË°®Á≠â) */
.pos-list-left {
    top: 10%; left: 5%;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.pos-list-left .adv-btn { position: static; transform: none; text-align: left;}

/* Â∫ïÈÉ®ÂØπËØùÊ°Ü */
#adv-dialog-box {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    min-height: 150px;
    background: rgba(0, 0, 0, 0.85);
    border: 2px solid #fff;
    color: #fff;
    padding: 20px;
    display: none; /* ÈªòËÆ§ÈöêËóè */
    z-index: 200;
    display: flex;
    gap: 15px;
}

.adv-dialog-avatar {
    width: 80px;
    height: 80px;
    border: 2px solid #fff;
    background-color: #555;
    background-size: cover;
    flex-shrink: 0;
}

.adv-dialog-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.adv-dialog-name {
    color: #f1c40f;
    font-weight: bold;
    margin-bottom: 8px;
}

.adv-dialog-text {
    font-size: 1rem;
    line-height: 1.6;
}
/* --- ÊñáÊ∏∏Êñ∞Â¢ûÊ†∑Âºè (Phase 2) --- */
.closet-container {
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.9);
    padding: 20px; display: flex; flex-direction: column;
    overflow-y: auto;
}
.closet-header {
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;
}
.closet-avatars {
    display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;
}
.closet-avatar-box {
    width: 100px; height: 150px; background: #ddd; border: 2px solid #555;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; position: relative; cursor: pointer;
}
.closet-avatar-box img { width: 100%; height: 100%; object-fit: cover; }
.attr-table {
    width: 100%; border-collapse: collapse; margin-bottom: 20px;
    font-size: 0.9rem; color: #333;
}
.attr-table td { border: 1px solid #ccc; padding: 8px; }
.attr-table td:first-child { background: #f0f0f0; font-weight: bold; width: 40%; }
.inv-list { display: flex; flex-direction: column; gap: 8px; }
.inv-item {
    display: flex; justify-content: space-between; align-items: center;
    background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.inv-btn-group { display: flex; gap: 5px; }
.inv-btn {
    padding: 4px 8px; font-size: 0.75rem; border: none; border-radius: 4px; cursor: pointer;
}
.btn-use { background: #81ecec; color: #006266; }
.btn-sell { background: #fab1a0; color: #d63031; }
/* --- ÊñáÊ∏∏Á´ãÁªò‰øÆÂ§ç (Phase 2.2) --- */
#adv-tachie-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 15; /* ËÉåÊôØ(0) < ÊåâÈíÆ(1) < Á´ãÁªò(15) < ÂØπËØùÊ°Ü(20) */
    overflow: hidden;
    display: flex;
    justify-content: space-between; /* Â∑¶Âè≥ÂàÜÂ∏É */
    align-items: flex-end; /* Â∫ïÈÉ®ÂØπÈΩê */
    padding: 0 5%; /* Â∑¶Âè≥Áïô‰∏ÄÁÇπËæπË∑ù */
}

.adv-tachie-img {
    height: 85%; /* Á´ãÁªòÈ´òÂ∫¶ */
    max-width: 45%; /* Èò≤Ê≠¢Â§™ÂÆΩ */
    object-fit: contain;
    filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
    transition: opacity 0.2s, transform 0.2s;
    display: none; /* ÈªòËÆ§ÈöêËóè */
}

.tachie-left {
    transform-origin: bottom left;
    /* Áî®Êà∑Á´ãÁªòÂú®Â∑¶Ëæπ */
}

.tachie-right {
    transform-origin: bottom right;
    /* ËßíËâ≤Á´ãÁªòÂú®Âè≥Ëæπ */
}

/* Á°Æ‰øùÂØπËØùÊ°ÜÂú®Á´ãÁªò‰∏äÈù¢ */
#adv-dialog-box {
    z-index: 20 !important;
}
/* === ÊñáÊ∏∏ UI ‰øÆÂ§çË°•‰∏Å === */

/* 1. Á°Æ‰øùÂØπËØùÊ°ÜÊòØÂõ∫ÂÆöÈ´òÂ∫¶Ôºå‰∏îÁÇπÂáª‰ªª‰ΩïÂú∞ÊñπÈÉΩËÉΩÁøªÈ°µ */
#adv-dialog-box {
    height: 150px !important; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
    min-height: 150px !important;
    cursor: pointer; /* ÊâãÂûãÈº†Ê†á */
    z-index: 100 !important; /* Á°Æ‰øùÂú®Á´ãÁªò‰∏äÈù¢ */
    user-select: none; /* Èò≤Ê≠¢ÂèåÂáªÈÄâ‰∏≠ÊñáÊú¨ */
}

/* 2. Á´ãÁªò‰ΩçÁΩÆ‰øÆÊ≠£ÔºöÁî®Êà∑Âú®Â∑¶ÔºåËßíËâ≤Âú®Âè≥ */
#adv-tachie-layer {
    z-index: 50 !important; /* Âú®ËÉåÊôØ‰πã‰∏äÔºåÂØπËØùÊ°Ü‰πã‰∏ã */
    pointer-events: none; /* Á©øÈÄèÁÇπÂáª */
}
.tachie-left {
    left: -10%; /* Áî®Êà∑Á´ãÁªòÁ®çÂæÆÂÅèÂ∑¶ */
    transform: scale(0.9); /* Áî®Êà∑Á®çÂæÆÂ∞è‰∏ÄÁÇπÊòæËøú */
}
.tachie-right {
    right: -10%; /* ËßíËâ≤Á´ãÁªòÂú®Âè≥ */
    transform: scale(1.0); /* ËßíËâ≤Á®çÂæÆÂ§ß‰∏ÄÁÇπÊòæËøë */
}

/* 3. ÂéÜÂè≤ËÆ∞ÂΩïÂ±ïÂºÄÊ†∑Âºè */
.adv-history-item {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid #aaa;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}
.adv-history-item.expanded {
    border-left-color: #0984e3;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.adv-history-summary {
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: #2d3436;
}
.adv-history-detail {
    display: none; /* ÈªòËÆ§ÈöêËóè */
    margin-top: 10px;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #636e72;
    white-space: pre-wrap;
    border-top: 1px dashed #eee;
    padding-top: 10px;
}
.adv-history-item.expanded .adv-history-detail {
    display: block; /* Â±ïÂºÄÊó∂ÊòæÁ§∫ */
}

/* 4. ÂêçÂ≠óÂèØÁÇπÂáªÊ†∑Âºè */
#adv-user-name {
    border-bottom: 1px dashed #fff;
    cursor: pointer;
}
/* === ÊñáÊ∏∏ UI ‰øÆÂ§çË°•‰∏Å === */

/* 1. Á°Æ‰øùÂØπËØùÊ°ÜÊòØÂõ∫ÂÆöÈ´òÂ∫¶Ôºå‰∏îÁÇπÂáª‰ªª‰ΩïÂú∞ÊñπÈÉΩËÉΩÁøªÈ°µ */
#adv-dialog-box {
    height: 150px !important; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
    min-height: 150px !important;
    cursor: pointer; /* ÊâãÂûãÈº†Ê†á */
    z-index: 100 !important; /* Á°Æ‰øùÂú®Á´ãÁªò‰∏äÈù¢ */
    user-select: none; /* Èò≤Ê≠¢ÂèåÂáªÈÄâ‰∏≠ÊñáÊú¨ */
}

/* 2. Á´ãÁªò‰ΩçÁΩÆ‰øÆÊ≠£ÔºöÁî®Êà∑Âú®Â∑¶ÔºåËßíËâ≤Âú®Âè≥ */
#adv-tachie-layer {
    z-index: 50 !important; /* Âú®ËÉåÊôØ‰πã‰∏äÔºåÂØπËØùÊ°Ü‰πã‰∏ã */
    pointer-events: none; /* Á©øÈÄèÁÇπÂáª */
}
.tachie-left {
    left: -10%; /* Áî®Êà∑Á´ãÁªòÁ®çÂæÆÂÅèÂ∑¶ */
    transform: scale(0.9); /* Áî®Êà∑Á®çÂæÆÂ∞è‰∏ÄÁÇπÊòæËøú */
}

.tachie-right {
    transform-origin: bottom right;
    /* üëá Êñ∞Â¢û/‰øÆÊîπ‰ª•‰∏ãËøôÂá†Ë°å üëá */
    position: absolute !important;  /* Âº∫Âà∂ÁªùÂØπÂÆö‰Ωç */
    right: -10% !important;         /* Âº∫Âà∂Èù†Âè≥ (Ë¥üÊï∞ÊòØ‰∏∫‰∫ÜÁ®çÂæÆÈú≤Âá∫‰∏ÄÂçäÔºåÂèØÊîπ‰∏∫ 0) */
    bottom: 0 !important;           /* Âº∫Âà∂Ê≤âÂ∫ï */
    left: auto !important;          /* Á°Æ‰øùÂ∑¶Ëæπ‰∏çÁîüÊïà */
    display: none;                  /* ÈªòËÆ§ÈöêËóèÔºåÁî± JS ÊéßÂà∂ÊòæÁ§∫ */
}

/* 3. ÂéÜÂè≤ËÆ∞ÂΩïÂ±ïÂºÄÊ†∑Âºè */
.adv-history-item {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid #aaa;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}
.adv-history-item.expanded {
    border-left-color: #0984e3;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.adv-history-summary {
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: #2d3436;
}
.adv-history-detail {
    display: none; /* ÈªòËÆ§ÈöêËóè */
    margin-top: 10px;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #636e72;
    white-space: pre-wrap;
    border-top: 1px dashed #eee;
    padding-top: 10px;
}
.adv-history-item.expanded .adv-history-detail {
    display: block; /* Â±ïÂºÄÊó∂ÊòæÁ§∫ */
}

/* 4. ÂêçÂ≠óÂèØÁÇπÂáªÊ†∑Âºè */
#adv-user-name {
    border-bottom: 1px dashed #fff;
    cursor: pointer;
}
/* ================= üé® Á´ãÁªò‰ΩçÁΩÆ‰øÆÊ≠£Ë°•‰∏Å ================= */

/* 1. Ë∞ÉÊï¥Á´ãÁªòÂÆπÂô®ÁöÑ‰ΩçÁΩÆ */
#adv-tachie-layer {
    /* Âº∫Âà∂ÂÆö‰ΩçÂà∞ÂØπËØùÊ°Ü‰∏äÊñπ */
    bottom: 175px !important; /* ÂØπËØùÊ°ÜÈ´òÂ∫¶Á∫¶150px + Èó¥Ë∑ù */
    top: auto !important;     /* ÂèñÊ∂àÈ°∂ÈÉ®ÂÆö‰Ωç */
    height: 55% !important;   /* ÈôêÂà∂È´òÂ∫¶ÔºåÈò≤Ê≠¢ÈÅÆÊå°È°∂ÈÉ®ÁöÑ"ÂäüËÉΩ"ÊåâÈíÆ */
    
    /* Á°Æ‰øùÂ∏ÉÂ±ÄÊ≠£Á°Æ */
    display: flex !important;
    align-items: flex-end !important; /* ËÆ©ÂõæÁâáÂ∫ïÈÉ®ÂØπÈΩê */
    justify-content: space-between !important;
    padding: 0 20px !important;
    pointer-events: none !important; /* ÂÖ≥ÈîÆÔºöËÆ©ÁÇπÂáªÁ©øÈÄèÁ´ãÁªòÔºå‰∏çÁÑ∂ÁÇπ‰∏çÂà∞ÂêéÈù¢ÁöÑÊåâÈíÆ */
}

/* 2. Ë∞ÉÊï¥ÂõæÁâáÊú¨Ë∫´ÁöÑÊ†∑Âºè */
.adv-tachie-img {
    height: 100% !important;  /* Âç†Êª°ÂÆπÂô®È´òÂ∫¶ */
    width: auto !important;
    max-width: 80% !important;
    object-fit: contain !important;
    object-position: bottom !important; /* Á°Æ‰øùÂõæÁâáÂ∫ïÈÉ®ÂØπÈΩê */
    
    /* Á®çÂæÆÁªôÁÇπÈò¥ÂΩ±ËÆ©ÂÆÉÊõ¥ÊúâÁ´ã‰ΩìÊÑü */
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
}

/* 3. ÂæÆË∞ÉÂ∑¶Âè≥‰ΩçÁΩÆÔºåÈÅøÂÖçÂ§™Èù†Ëæπ */
.tachie-left {
    transform-origin: bottom left;
    margin-left: -10px; 
}
.tachie-right {
    transform-origin: bottom right;
    margin-right: -10px;
    /* Á°Æ‰øùÂè≥‰æßÁ´ãÁªòÁªùÂØπÈù†Âè≥ */
    position: absolute !important;
    right: 5% !important;
    bottom: 0 !important;
}
/* === üì© ÈöèÊú∫Áü≠‰ø°ÂäüËÉΩÊ†∑Âºè === */
.random-sms-toast {
    position: fixed;
    right: -200px; /* ÂàùÂßãÈöêËóèÂú®Â±èÂπïÂ§ñ */
    top: 50%;
    transform: translateY(-50%);
    width: 160px;
    height: 80px;
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    border-radius: 12px 0 0 12px;
    box-shadow: -5px 0 15px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 20000;
    cursor: pointer;
    transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-left: 4px solid #fff;
}
.random-sms-toast.show { right: 0; }
.random-sms-icon { font-size: 2rem; animation: sms-bounce 1s infinite; }
@keyframes sms-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

/* Áü≠‰ø°ÁªìÊûúÂ±ïÁ§∫Âå∫ (Â§çÁî®Áé∞ÊúâÂç°ÁâáÊ†∑Âºè) */
.sms-result-box {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    max-width: 80%;
    max-height: 60vh;
    overflow-y: auto;
    font-family: "Songti SC", serif;
    border: 2px solid #ff9a9e;
    box-shadow: 0 0 30px rgba(255, 154, 158, 0.5);
    display: none; /* ÂàùÂßãÈöêËóè */
    flex-direction: column;
    gap: 15px;
}
/* === üç´ Â∑ßÂÖãÂäõÂà∂‰ΩúÂ∞èÊ∏∏ÊàèÊ†∑Âºè === */
.choco-game-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    overflow: hidden;
}
.choco-pot {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 280px; height: auto; z-index: 5; pointer-events: none;
}
.choco-item {
    position: absolute; width: 80px; z-index: 10; cursor: grab;
    transition: transform 0.1s; touch-action: none;
}
.choco-item:active { cursor: grabbing; transform: scale(1.1); }
/* === üòò ‰∫≤‰∫≤‰∫íÂä®Ê®°Âºè‰∏ìÁî®Ê†∑Âºè === */
#adv-kiss-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #000; z-index: 30000; /* ÊúÄÈ´òÂ±ÇÁ∫ß */
    display: none; flex-direction: column; align-items: center; justify-content: flex-end;
}
#kiss-char-img {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; /* ÂÖÖÊª°Â±èÂπïÔºåÊ®°ÊãüÂáëËøëÁöÑÊïàÊûú */
    object-position: top center;
    filter: brightness(0.9);
    pointer-events: none; /* ËÆ©ÁÇπÂáªÁ©øÈÄèÂà∞ÈÅÆÁΩ©Â±ÇÂ§ÑÁêÜ */
}
.kiss-dialog {
    position: relative; z-index: 10; margin-bottom: 100px;
    background: rgba(255,255,255,0.9); color: #333;
    padding: 15px 25px; border-radius: 20px; font-weight: bold;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    max-width: 80%; text-align: center;
    border: 2px solid #ff7675;
    animation: popIn 0.3s;
}
/* ÂëºÂê∏Âä®ÁîªÔºåÊ®°ÊãüÊúüÂæÖ */
@keyframes kiss-breathe { 0% {transform: scale(1);} 50% {transform: scale(1.02);} 100% {transform: scale(1);} }
.kiss-active #kiss-char-img { animation: kiss-breathe 3s infinite ease-in-out; }
    </style>
</head>
<body>
<div id="camera-modal" class="modal-overlay" style="padding:0;">
    <div id="camera-ui">
        <div style="padding:10px; display:flex; justify-content:space-between; color:white; background:#111; align-items:center;">
            <span>Â§çÂè§ÊöóÊàø</span>
            <div id="sticker-ops" style="display:none; gap:10px;">
                <button class="m-btn small" onclick="controlSticker('scale', 1.1)">‚ûï</button>
                <button class="m-btn small" onclick="controlSticker('scale', 0.9)">‚ûñ</button>
                <button class="m-btn small" style="background:red; color:white;" onclick="controlSticker('del')">üóëÔ∏è</button>
            </div>
            <button onclick="closeCamera()" style="background:none;border:none;color:white;font-size:1.2rem;">√ó</button>
        </div>
        <div id="canvas-area">
            <canvas id="editor-canvas"></canvas>
        </div>
        <div class="cam-tools">
            <button class="m-btn small" onclick="document.getElementById('upload-bg').click()">üì∑ Â∫ïÂõæ</button>
            <button class="m-btn small" onclick="document.getElementById('upload-sticker').click()">üòä Ë¥¥Á∫∏</button>
            <select id="frame-select" class="m-btn small" onchange="handleFrameChange(this.value)" style="background:#ddd; color:#333; max-width: 100px;">
                <option value="black" selected>‚¨õ ÈªòËÆ§Èªë</option>
                <option value="polaroid">‚¨ú ÊãçÁ´ãÂæó</option>
                <option value="custom">üñºÔ∏è Ëá™ÂÆö‰πâ</option>
                <option value="none">üö´ Êó†Ê°Ü</option>
            </select>

            <button class="m-btn primary small" onclick="saveCanvasPhoto()">üíæ ‰øùÂ≠ò</button>
        </div>
    </div>
    <input type="file" id="upload-bg" accept="image/*" style="display:none" onchange="handleBgUpload(this)">
    <input type="file" id="upload-sticker" accept="image/*" style="display:none" onchange="handleCamStickerUpload(this)">
    <input type="file" id="upload-frame-custom" accept="image/*" style="display:none" onchange="handleCustomFrameUpload(this)">
</div>
    <div id="screen">
        <div id="pages-wrapper">
            <!-- Page 1 -->
            <div class="page" id="page1" style="padding-top: calc(10px + env(safe-area-inset-top)); gap: 3px;">
                <div class="header-info">
                    <div class="time-widget" id="clock">12:00</div>
                    <div class="date-widget" id="date">JAN 24</div>
                </div>
                <div class="tv-container" style="margin-top: 0px;">
           <div id="tv-shell-case" class="tv-case">
                    <!-- ‰øÆÊîπÔºöÁÇπÂáªÁîµËßÜ‰∏ª‰ΩìËøõÂÖ•ÊñáÊ∏∏ -->
<div class="add-btn-trigger" onclick="openTextAdventure()"></div>
                        <div class="tv-bezel-wrapper">
                            <div class="tv-screen-frame">
                             <div class="tv-screen" onclick="openTextAdventure()" style="cursor: pointer;">
    <div class="crt-scanlines"></div>
    <span class="tv-placeholder">üì∫ CLICK START</span>
    <img id="tv-content" class="tv-content" src="" style="display:none;">
</div>
                            </div>
                        </div>
                        <div class="tv-control-panel">
                            <div class="tv-logo-badge">Zenith</div>
                            <div class="tv-knobs">
                                <div class="knob" style="transform: rotate(45deg);"></div>
                                <div class="knob" style="transform: rotate(-20deg);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" id="tv-file-input" accept="image/*">

                <div class="middle-grid" style="margin-top: 0px;">
                    <div class="left-apps-grid">
                        <div class="app-item" onclick="openSettings()"><div class="app-icon" style="background:#7d8c7c">‚öôÔ∏è</div><span class="app-name">ËÆæÁΩÆ</span></div>
                        <div class="app-item" onclick="openWorldBook()"><div class="app-icon" style="background:#d4a5a5">üìñ</div><span class="app-name">‰∏ñÁïå‰π¶</span></div>
                        <div class="app-item" onclick="openThesaurus()"><div class="app-icon" style="background:var(--morandi-green)">üßæ</div><span class="app-name">ËØçÂ∫ì</span></div>
                       <div class="app-item" onclick="openCamera()"><div class="app-icon" style="background:#5e6d79;">üì∑</div><span class="app-name">Áõ∏Êú∫</span></div> 
                        <div class="app-item" onclick="openFileApp()"><div class="app-icon" style="background:#c9bba0">üìÇ</div><span class="app-name">Êñá‰ª∂</span></div>
                       <div class="app-item" onclick="openFinanceApp()">
    <div class="app-icon" style="background:#6b705c">üí∞</div>
    <span class="app-name">ËÆ∞Ë¥¶</span>
</div>
                    </div>
<div class="newspaper-wrap" ondblclick="initCardTable()">
    <div class="news-header-section">
        <div class="news-brand">The Daily Post</div>
        <div class="news-meta-bar">
            <span>Morning Ed.</span>
            <span>Est. 1923</span>
            <span>Vol. 402</span>
        </div>
    </div>
    <div class="news-content">
        <div class="news-headline">MYSTIC ECHOES</div>
        <div class="news-img-halftone"></div>
        <div class="news-text-columns">
            <p>Strange energies detected in the ether today. Experts baffled by sudden surge.</p>
            <p>Cards reveal secrets hidden beneath the surface of reality.</p>
        </div>
    </div>
</div>
                </div>

            </div>
            
            <div class="page" id="page2">
<div class="page-2-grid" style="padding-top: 0; margin-top: -20px;">
    <div class="fridge-item-large" onclick="openFridgeApp()" style="grid-row: span 2;">
        <div class="fridge-handle"></div>
        <div class="fridge-sticker"></div>
    </div>
<div class="app-item" onclick="openStudyApp()">
        <div class="app-icon" style="background:#546e7a; color:#fff; font-size:1.4rem; border:2px solid #cfd8dc; box-shadow:0 2px 5px rgba(0,0,0,0.2);">üìÖ</div>
        <span class="app-name">Â≠¶‰π†ËÆ°Âàí</span>
    </div>
    <!-- 2. Â∞èÂâßÂú∫ -->
    <div class="app-item" onclick="openTheaterApp()">
        <div class="app-icon" style="background:#8e44ad; color:#fff; font-size:1.4rem;">üé≠</div>
        <span class="app-name">Â∞èÂâßÂú∫</span>
    </div>
    <div class="app-item" onclick="openPickupApp()">
        <div class="app-icon" style="background:#f1c40f; color:#fff; font-size:1.4rem; border:2px solid #000;">üì±</div>
        <span class="app-name">Êç°ÊâãÊú∫</span>
    </div>
    <div class="app-item" onclick="openPeriodApp()">
        <div class="app-icon" style="background:#f48fb1; color:#fff; font-size:1.4rem;">üå∫</div>
        <span class="app-name">ÁªèÊúü</span>
    </div>
    <div class="app-item" onclick="openForumApp()">
        <div class="app-icon" style="background:#00d2d3; color:#fff; font-size:1.4rem;">üí¨</div>
        <span class="app-name">ËÆ∫Âùõ‰Ωì</span>
    </div>
    <div class="app-item" onclick="openAlbumApp()">
        <div class="app-icon" style="background:#8d6e63; color:#fff; font-size:1.4rem; border:1px solid #d7ccc8;">üñºÔ∏è</div>
        <span class="app-name">Áõ∏ÂÜå</span>
    </div>
    <div class="app-item" onclick="openAnniversaryApp()">
        <div class="app-icon" style="background:#cba8a8; color:#fff; font-size:1.4rem; border:1px solid #e6dada;">üìÖ</div>
        <span class="app-name">Á∫™ÂøµÊó•</span>
    </div>
    <!-- ‰øÆÊîπÔºöÊó•ËÆ∞ÁªÑ‰ª∂ (Â∑≤‰øÆÂ§ç) -->
<div id="diary-widget" class="memo-widget-wide" onclick="openDiaryApp()" style="grid-column: span 2; grid-row: span 2; background: linear-gradient(135deg, #fdfbf7 0%, #ebedee 100%); border: 1px solid #ccc;">
    <div style="font-size:0.7rem; color:#888; margin-bottom:4px; font-weight:bold; letter-spacing:1px;">DIARY</div>
    <div id="desktop-diary-preview" style="font-family: 'Georgia', serif; font-size: 0.75rem; color:#555; line-height:1.4; overflow:hidden; display:-webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical;">
        ÁÇπÂáªÁîüÊàê‰ªäÊó•Êó•ËÆ∞...
    </div>
    <!-- Ë£ÖÈ•∞Áî®ÁöÑÊó•ËÆ∞Êú¨ÁªëÂ∏¶ -->
    <div style="position:absolute; right:20px; top:0; bottom:0; width:15px; background:rgba(0,0,0,0.05); border-left:1px dashed #aaa; border-right:1px dashed #aaa;"></div>
</div>
    <div class="app-item" onclick="openDreamApp()">
        <div class="app-icon" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color:#fff; font-size:1.4rem; border:1px solid #fff;">ü¶Ñ</div>
        <span class="app-name">Ê¢¶</span>
    </div>
    <div class="app-item" onclick="openHisPhoneApp()">
        <div class="app-icon" style="background: #2d3436; color: #fff; font-size: 1.4rem; border: 1px solid #636e72; box-shadow: 0 0 10px rgba(0,0,0,0.5);">üì±</div>
        <span class="app-name">taÁöÑÊâãÊú∫</span>
    </div>
    <div class="app-item" onclick="openThemeApp()">
        <div class="app-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%); color:#fff; font-size:1.4rem; border:1px solid #fff;">üé®</div>
        <span class="app-name">ÁæéÂåñ</span>
    </div>
<div id="console-widget-p2" class="game-console-widget" onclick="openGameApp()">
    <div class="gc-dpad"></div>
    <div class="gc-screen-area">
        <div class="gc-scanline"></div>
        <img id="widget-game-bg-p3" class="gc-screen-img" src="" style="display:none"> 
        <div class="tv-placeholder" style="color:#fff; text-shadow:0 0 5px #0f0;">PRESS START</div>
    </div>
    <div class="gc-btns"><div class="gc-btn"></div><div class="gc-btn"></div></div>
</div>
</div>
    </div> 
            <!-- Page 3 -->

<div class="page" id="page3" style="padding-top: calc(20px + env(safe-area-inset-top)); padding-bottom: 100px; gap: 8px;">
    <div class="page-2-grid" style="padding-top: 0; margin-top: -20px;">
        <!-- ÂéüÊúâÁöÑËÄÅÁ¶èÁâπ -->
        <div class="app-item" onclick="openLofterApp()">
            <div class="app-icon" style="background:#2c6e49; color:#fff; font-size:0.8rem; font-family:serif; font-weight:bold;">Lf</div>
            <span class="app-name">ËÄÅÁ¶èÁâπ</span>
        </div>
<!-- üé¥ Êñ∞Â¢ûÔºö‰πôÂ•≥ÊäΩÂç° APP -->
<div class="app-item" onclick="openGachaCardApp()">
    <div class="app-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 15px rgba(161, 140, 209, 0.5);">üé¥</div>
    <span class="app-name">ÂëΩËøêÊäΩÂç°</span>
</div>
<!-- üßô‚Äç‚ôÄÔ∏è Êñ∞Â¢ûÔºöÂ•≥Â∑´ APP ÂõæÊ†á -->
<div class="app-item" onclick="openWitchApp()">
    <div class="app-icon" style="background: #2d3436; color:#a29bfe; font-size:0.8rem; border:2px solid #6c5ce7; box-shadow: 0 0 10px rgba(108, 92, 231, 0.6);">üßô‚Äç‚ôÄÔ∏è</div>
    <span class="app-name">Â•≥Â∑´</span>
</div>
<!-- ... Âú® Page 3 ÁöÑ grid Èáå ... -->

<!-- ‚ù§Ô∏è Êñ∞Â¢ûÔºöÈªòÂ•ëÂ§ßÊåëÊàò APP ÂõæÊ†á -->
<div class="app-item" onclick="openTacitApp()">
    <div class="app-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%); color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 15px rgba(255, 105, 135, 0.4);">üíû</div>
    <span class="app-name">ÈªòÂ•ëÊåëÊàò</span>
</div>
       <!-- üå∏ Êñ∞Â¢ûÔºöÈ¶ôÁâá APP ÂõæÊ†á -->
<div class="app-item" onclick="openScentApp()">
    <div class="app-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 15px rgba(255, 192, 203, 0.4);">üß¥</div>
    <span class="app-name">È¶ôÁâáÊî∂ÈõÜ</span>
</div> 
<!-- üß© Êñ∞Â¢ûÔºöËÆ∞ÂøÜÊãºÂõæ APP ÂõæÊ†á -->
<div class="app-item" onclick="openPuzzleApp()">
    <div class="app-icon" style="background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%); color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(116, 235, 213, 0.4);">üß©</div>
    <span class="app-name">ËÆ∞ÂøÜÊãºÂõæ</span>
</div>

        <!-- üî• Êñ∞Â¢ûÔºöÂÖ≥‰∫éÁóõËã¶ APP -->
        <div class="app-item" onclick="openPainApp()">
            <div class="app-icon" style="background:#636e72; color:#fff; font-size:0.8rem; border:1px solid #b2bec3;">üíä</div>
            <span class="app-name">ÂÖ≥‰∫éÁóõËã¶</span>
        </div>
<!-- üìã Êñ∞Â¢ûÔºöÂ∑•‰ΩúÊó•Êä• APP ÂõæÊ†á -->
<div class="app-item" onclick="openWorkApp()">
    <div class="app-icon" style="background:#57606f; color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(47, 53, 66, 0.4);">üìä</div>
    <span class="app-name">Â∑•‰ΩúÊó•Êä•</span>
</div>
<!-- Êñ∞Â¢ûÔºöÊê¨ÂÆ∂Êó•ËÆ∞ APP ÂõæÊ†á -->
<div class="app-item" onclick="openMovingApp()">
    <div class="app-icon" style="background:#e17055; color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(225, 112, 85, 0.4);">üì¶</div>
    <span class="app-name">Êê¨ÂÆ∂Êó•ËÆ∞</span>
</div>
        <!-- Êñ∞Â¢ûÔºöÂÆ†Áâ©Êó•ËÆ∞ APP -->
        <div class="app-item" onclick="openPetDiaryApp()">
            <div class="app-icon" style="background:#ff9f43; color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(255, 159, 67, 0.4);">üêæ</div>
            <span class="app-name">ÂÆ†Áâ©Êó•ËÆ∞</span>
        </div>
<!-- üî• Êñ∞Â¢ûÔºöÊóÆÊóØGame ÂõæÊ†á -->
<div class="app-item" onclick="openGalgameApp()">
    <div class="app-icon" style="background: linear-gradient(135deg, #ff9ff3 0%, #feca57 100%); color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(255, 159, 243, 0.5);">üè©</div>
    <span class="app-name">ÊóÆÊóØGame</span>
</div>
<div class="app-item" onclick="openGashaponApp()">
    <div class="app-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(255, 154, 158, 0.5);">üç¨</div>
    <span class="app-name">Âπ≥Ë°åÊâ≠Ëõã</span>
</div>
<div class="app-item" onclick="openShadowApp()">
    <div class="app-icon" style="background:#2d3436; color:#d63031; font-size:0.8rem; border:2px solid #636e72; box-shadow: 0 0 10px rgba(0,0,0,0.8);">üòà</div>
    <span class="app-name">Èò¥ÊöóÈù¢</span>
</div>

<div class="app-item" onclick="openSummaryApp()">
    <div class="app-icon" style="background:#607d8b; color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(96, 125, 139, 0.4);">üìù</div>
    <span class="app-name">Â≠¶‰π†ÊÄªÁªì</span>
</div>
<!-- Êñ∞Â¢ûÔºöÈô™‰º¥ APP -->
<div class="app-item" onclick="openCompanionApp()">
    <div class="app-icon" style="background:#a29bfe; color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 15px rgba(162, 155, 254, 0.4);">üï∞Ô∏è</div>
    <span class="app-name">Èô™‰º¥</span>
</div>
<!-- üî• Êñ∞Â¢ûÔºöÊïôÂØº APP ÂõæÊ†á -->
<div class="app-item" onclick="openTeachingApp()">
    <div class="app-icon" style="background:#273c75; color:#fff; font-size:0.8rem; border:2px solid #fff; box-shadow: 0 4px 10px rgba(39, 60, 117, 0.4);">üçé</div>
    <span class="app-name">ÊïôÂØº</span>
</div>

<div id="console-widget-p3" class="game-console-widget" onclick="openRpgApp()" style="grid-column: span 4; grid-row: span 2; background: #2d3436; border:4px solid #57606f;">
    <!-- Êñ∞Â¢ûÔºöÊëáÊùÜÁªÑ‰ª∂ -->
<div class="joystick-base">
    <div class="joystick-stick"></div>
</div>
    <div class="gc-screen-area" style="width: 65%; height: 85%; border: 2px solid #111;">

     <img id="p3-screen-img" src="https://i.postimg.cc/ZqXkMnTj/IMG_1126.png" style="width:100%; height:100%; object-fit:cover;">
        
        <div style="position:absolute; bottom:10px; left:0; width:100%; text-align:center; color:#0f0; font-family:'Courier New'; font-weight:bold; font-size:0.8rem; text-shadow:0 0 2px #000; animation: blink 1s infinite;">CLICK START</div>
    </div>
    <div class="gc-btns" style="right:10px; width:50px; height:50px;">
        <div class="gc-btn" style="background:#ff7675;"></div>
        <div class="gc-btn" style="background:#74b9ff;"></div>
    </div>
</div>
    </div>
</div>
<!-- Page 4: ÂÆ†Áâ©Èô™‰º¥Á≥ªÁªü -->
<div class="page" id="page4" style="background:none; overflow:hidden; position:relative;">
    <!-- Âä®ÊÄÅËÉåÊôØÂ±Ç -->
    <div id="pet-bg-layer" style="position:absolute; inset:0; z-index:0; background-size:cover; background-position:center;"></div>
    
    <!-- Ë£ÖÈ•∞Áâ©Â±Ç -->
    <div id="pet-decor-layer" style="position:absolute; inset:0; z-index:1; pointer-events:none;"></div>

    <!-- ÂÆ†Áâ©Â±Ç (‰ºöÂú®JS‰∏≠Âä®ÊÄÅÊéßÂà∂‰ΩçÁΩÆ) -->
    <div id="pet-sprite" onclick="interactWithPet()" style="position:absolute; bottom:30%; left:50%; width:120px; height:120px; z-index:10; transition: transform 0.5s, left 2s linear; cursor:pointer; background-size:contain; background-repeat:no-repeat; background-position:center;"></div>

    <!-- Á¶ªÂÆ∂Âá∫Ëµ∞Êó∂ÁöÑÊèêÁ§∫ -->
    <div id="pet-runaway-msg" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:20; background:rgba(0,0,0,0.8); color:white; padding:20px; border-radius:10px; text-align:center;">
        <h3>üòø ÂÆ†Áâ©Á¶ªÂÆ∂Âá∫Ëµ∞‰∫Ü...</h3>
        <p>ÂøÉÊÉÖÂÄºÂΩíÈõ∂ÔºåÂÆÉ‰º§ÂøÉÂú∞Á¶ªÂºÄ‰∫Ü„ÄÇ</p>
        <button class="m-btn primary" onclick="retrievePet()">ÊîØ‰ªò 15 ÁßØÂàÜÊâæÂõû</button>
    </div>

    <!-- UI ÂõæÊ†á -->
    <!-- Âè≥‰∏äËßíÔºöËÆæÁΩÆ -->
    <img src="https://i.postimg.cc/xTT4JSkB/IMG_1806.png" onclick="openPetSettings()" style="position:absolute; top:calc(20px + env(safe-area-inset-top)); right:20px; width:40px; height:40px; z-index:100; cursor:pointer;">
    
    <!-- Â∑¶‰∏ãËßíÔºöÂïÜÂ∫ó -->
    <img src="https://i.postimg.cc/KvvHkyKd/IMG_1805.png" onclick="openPetShop()" style="position:absolute; bottom:30px; left:20px; width:50px; height:50px; z-index:100; cursor:pointer;">
    
    <!-- Âè≥‰∏ãËßíÔºöËÉåÂåÖ -->
    <img src="https://i.postimg.cc/155jnZgT/IMG_1804.png" onclick="openPetBag()" style="position:absolute; bottom:30px; right:20px; width:50px; height:50px; z-index:100; cursor:pointer;">
</div>
</div>
        </div>
        
        <div class="dock-bar">
    <div class="app-item" onclick="openFan()" style="margin-bottom:0">
        <div class="app-icon" style="background:#000; border:2px solid #333; box-shadow:0 0 5px #0f0;">üìü</div>
    </div>
    <div class="app-item" onclick="openChatApp()" style="margin-bottom:0">
        <div class="app-icon" style="background:#06c755; box-shadow:none; font-size: 1.4rem;">üí¨</div>
    </div>
    <div class="app-item" onclick="openTarotApp()" style="margin-bottom:0">
        <div class="app-icon" style="background:#2c3e50; color:#a29bfe; box-shadow:none; border:1px solid rgba(255,255,255,0.3);">üîÆ</div>
    </div>

    <!-- üëá ‰øÆÊîπÁÇπÔºöÁªô‰ø°‰ª∂Âä†‰∏ä app-item Â§ñÂ£≥ üëá -->
    <div class="app-item" onclick="openLetterApp()" style="margin-bottom:0">
        <div class="app-icon" style="background:#fdf6e3; color:#555; border:1px solid #ccc; box-shadow:none;">‚úâÔ∏è</div>
        </div>
    </div>
<div id="settings-modal" class="modal-overlay">
    <div class="modal-header"><span>API ÈÖçÁΩÆ‰∏≠ÂøÉ</span><button class="close-btn" onclick="closeSettings()">√ó</button></div>
    <div class="modal-body">
        <div class="morandi-card">
          <!-- Êñ∞Â¢ûÔºöÂ§úÈó¥Ê®°ÂºèÂºÄÂÖ≥ -->
<div class="morandi-card" style="display:flex; justify-content:space-between; align-items:center; background:#2d3436; color:#fff;">
    <span>üåô Â§úÈó¥Ê∑±Ëâ≤Ê®°Âºè (Êä§Áúº)</span>
    <label class="switch" style="position:relative; display:inline-block; width:50px; height:24px;">
        <input type="checkbox" onchange="toggleNightMode(this)" style="opacity:0; width:0; height:0;">
        <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px;"></span>
        <span style="position:absolute; content:''; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%;" id="night-slider"></span>
    </label>
</div>
<!-- ÊèíÂÖ•ÁªìÊùü -->  <h3>ËøûÊé•ÈÖçÁΩÆ</h3>
<div class="morandi-card" style="border-left: 4px solid #06c755;">
    <h3>üîî ÈÄöÁü•ÊùÉÈôê</h3>
    <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
        ÂÖÅËÆ∏ÂèëÈÄÅÁ≥ªÁªüÈÄöÁü•Ôºå‰ª•‰æøÂú®ÈÄÄÂá∫ App ÂêéÊé•Êî∂Ê∂àÊÅØÂíåÁîüÊàêÁªìÊûú„ÄÇ
        <br>(iOSÈúÄÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÊâçËÉΩÁîüÊïà)
    </p>
    <button class="m-btn primary" onclick="NotificationManager.requestPermission()" style="background:#06c755;">ÂºÄÂêØÁ≥ªÁªüÈÄöÁü•ÊùÉÈôê</button>
</div>
<div class="morandi-card" style="border:1px solid #7d8c7c;">
    <h3 style="color:#2c3e50;">üíæ ÂÖ®Â±ÄÊï∞ÊçÆÂ§á‰ªΩ</h3>
    <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
        Â§á‰ªΩÊâÄÊúâÊñáÂ≠óÊï∞ÊçÆÔºà‰∏ñÁïå‰π¶„ÄÅËÅäÂ§©ËÆ∞ÂΩï„ÄÅÁ∫™ÂøµÊó•„ÄÅÊâÄÊúâAppËÆ∞ÂΩïÔºâ„ÄÇ<br>
        <span style="color:#d81b60;">Ê≥®ÊÑèÔºö‰∏çÂåÖÂê´Êñá‰ª∂ÁöÑÊï∞ÊçÆ„ÄÇËøô‰∏™Â∞èÊâãÊú∫Êï£Ê¢¶ÂêëÁ¶ÅÊ≠¢‰ΩøÁî®ÔºÅ</span>
    </p>
    <div style="display:flex; gap:10px;">
        <button class="m-btn secondary" onclick="exportFullBackup()">üì§ ÂØºÂá∫Â§á‰ªΩ (.json)</button>
        <button class="m-btn secondary" onclick="document.getElementById('restore-file-input').click()">üì• ÂØºÂÖ•ÊÅ¢Â§ç</button>
        <input type="file" id="restore-file-input" accept=".json" style="display:none" onchange="importFullRestore(this)">
    </div>
</div>
<!-- Âú® settings-modal ÁöÑ modal-body ÈáåÊâæ‰∏™Âú∞ÊñπÊèíÂÖ• -->
<div class="morandi-card" style="border:1px dashed #ff9a9e; margin-top:10px;">
    <h4 style="color:#ff9a9e; margin:0 0 5px 0;"></h4>
    <button class="m-btn small" onclick="testRandomSms()" style="width:100%;">üì© Á´ãÂç≥Ëß¶ÂèëÈöèÊú∫Áü≠‰ø°</button>
</div>
<div class="morandi-card" style="border:1px solid #ff7675;">
    <h3 style="color:#d63031;">üßπ ÂÜÖÂ≠òÊïëÊè¥ (Êó†ÈúÄÈáç‰º†)</h3>
    <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
        Ëá™Âä®Êâ´ÊèèÁé∞ÊúâÁöÑÁõ∏ÂÜå„ÄÅËÉåÊôØ„ÄÅË°®ÊÉÖÂåÖÔºåÂ∞ÜÂ§ßÂõæÁâáËøõË°åÊó†ÊçüÂéãÁº©„ÄÇ<br>
        <span style="color:red;">Â¶ÇÊûú‰Ω†ËßâÂæóÂç°È°øÔºåËØ∑ÁÇπËøôÈáåÔºÅGIF‰∏ç‰ºöË¢´ÂΩ±Âìç„ÄÇ</span>
    </p>
    <button id="btn-optimize-start" class="m-btn primary" onclick="runSystemOptimization()" style="width:100%; background:#d63031;">üöÄ ÂºÄÂßãÂÖ®Â∫ìÁò¶Ë∫´</button>
</div>
<div class="morandi-card" style="border:1px solid #ff4757; background:#fff5f5;">
    <h3 style="color:#c0392b;">üóëÔ∏è ÊûÅÁÆÄÊ®°Âºè (‰∏ÄÈîÆÈáçÁΩÆ)</h3>
    <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
        Âà†Èô§ÊâÄÊúâËÅäÂ§©„ÄÅÂâßÊÉÖ„ÄÅÊó•ËÆ∞Á≠â<b>ÂéÜÂè≤ËÆ∞ÂΩï</b>ÔºåËÆ©Á≥ªÁªüÂõûÂà∞ÂàöÂÆâË£ÖÊó∂ÁöÑÊ∏ÖÁàΩÁä∂ÊÄÅ„ÄÇ<br>
        <span style="color:#27ae60; font-weight:bold;">‚úÖ ÁªùÂØπ‰øùÁïôÔºö</span>ÁæéÂåñÁ¥†Êùê„ÄÅÂ°îÁΩóÁâåÊñá‰ª∂„ÄÅ‰∏ñÁïå‰π¶„ÄÅËØçÂ∫ì„ÄÅAPIËÆæÁΩÆ„ÄÅÂÆ†Áâ©Áä∂ÊÄÅ„ÄÅLineÊî∂ËóèÂ§π„ÄÇ
    </p>
    <button class="m-btn primary" onclick="performSelectiveReset()" style="width:100%; background:#ff4757;">‚ö†Ô∏è Âà†Èô§ÊâÄÊúâÂéÜÂè≤ (ÊÖéÁÇπ)</button>
</div>
            <div class="input-group"><label>API Address</label><input type="text" id="api-url" placeholder="https://api.openai.com/v1" oninput="autoSaveApiSettings()"></div>
           <div class="input-group"><label>API Key</label><input type="password" id="api-key" placeholder="sk-..." oninput="autoSaveApiSettings()"></div>
            
            <div class="input-group"><label>Ê®°Âûã</label><select id="model-select" onchange="autoSaveApiSettings()"><option value="" disabled selected>ËØ∑ÊãâÂèñ...</option></select></div>
            <div class="input-group">
                <label style="display:flex; justify-content:space-between;"><span>Ê∏©Â∫¶: <span id="temp-display">0.7</span></span></label>
                <input type="range" id="api-temp" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('temp-display').innerText = this.value; autoSaveApiSettings()">
            </div>
            
            <div class="action-row" style="display:flex; gap:10px; margin-top:10px;">
                <button class="m-btn secondary" onclick="fetchModels()">üîÑ ÊãâÂèñ</button>
                <button class="m-btn primary" onclick="saveCurrentProfile()">üíæ Âè¶Â≠ò‰∏∫ÊñπÊ°à</button>
            </div>
        </div>
        <div class="morandi-card"><h3>Â∑≤‰øùÂ≠òÊñπÊ°à</h3><div id="profile-list"></div></div>
    </div>
</div>
    <div id="fan-modal" class="modal-overlay">
        <button class="close-btn" style="position:absolute; top:50px; right:20px; color:#fff;" onclick="closeFan()">√ó</button>
        <div class="elec-screen-container">
            <div class="elec-screen">
                <div class="scanline-anim"></div>
                <div class="elec-text" id="fan-display-text"></div>
            </div>
            <div class="elec-deco-bar">
                <div class="deco-dot active"></div>
                <div style="color:#555; font-size:0.5rem; letter-spacing:2px;">SYS.OP.READY</div>
                <div class="deco-dot"></div>
            </div>
        </div>
    </div>
    <div id="file-modal" class="modal-overlay">
        <div class="modal-header"><span>Êñá‰ª∂ÁÆ°ÁêÜ</span><button class="close-btn" onclick="document.getElementById('file-modal').style.display='none'">√ó</button></div>
        <div class="modal-body">
            <div class="morandi-card">
                <h3>üìÅ ÈÄöÁî®ÂØºÂÖ•</h3>
                <p style="font-size:0.8rem; color:#888;">‰ªéÊâãÊú∫Êñá‰ª∂ÂØºÂÖ•ÂõæÁâáÊàñÊñáÊ°£</p>

                <input type="file" id="file-generic-input" class="hidden-file-input" accept="image/*, .jpg, .jpeg, .png, .gif, .webp, .txt, .pdf, .json, */*">
                <button class="m-btn secondary" onclick="document.getElementById('file-generic-input').click()">ÈÄâÊã©Êñá‰ª∂...</button>
            </div>

            <div class="morandi-card">
                <h3>üîÆ Â°îÁΩóÁâåÂ∫ì (0-77)</h3>
                <p style="font-size:0.8rem; color:#888;">ËØ∑ÈÄâÊã©78Âº†JPEGÂõæÁâá (Êñá‰ª∂ÂêçÈúÄÂåÖÂê´Êï∞Â≠ó0-77)</p>
              <input type="file" id="file-tarot-input" class="hidden-file-input" multiple accept="*/*">


                <button class="m-btn primary" onclick="document.getElementById('file-tarot-input').click()">ÊâπÈáè‰∏ä‰º†Â°îÁΩóÁâå</button>
                <div id="tarot-status" style="margin-top:10px; font-size:0.8rem; color:#666;"></div>
            </div>

            <div class="morandi-card">
                <h3>‚öúÔ∏è Èõ∑ËØ∫ÊõºÁâåÂ∫ì (1-36)</h3>
                <p style="font-size:0.8rem; color:#888;">ËØ∑ÈÄâÊã©36Âº†JPEGÂõæÁâá (Êñá‰ª∂ÂêçÈúÄÂåÖÂê´Êï∞Â≠ó1-36)</p>
  <input type="file" id="file-lenormand-input" class="hidden-file-input" multiple accept="*/*">
                <button class="m-btn primary" onclick="document.getElementById('file-lenormand-input').click()">ÊâπÈáè‰∏ä‰º†Èõ∑ËØ∫Êõº</button>
                <div id="lenormand-status" style="margin-top:10px; font-size:0.8rem; color:#666;"></div>
            </div>
        </div>
    </div>
    <div id="chat-modal" class="modal-overlay" style="display:none;">
        <div class="chat-header">
            <button class="m-btn small" onclick="closeChatApp()">üîô</button>
            <div class="chat-header-center">
                <input type="text" id="chat-title-input" class="chat-title-input" value="ÁßÅÂØÜËÅäÂ§©" onblur="saveLineTitle()">
                <div class="chat-status-toggle" id="chat-status-toggle" onclick="toggleOnlineStatus()">
                    <div class="status-dot"></div>
                    <span id="chat-status-text">‰ºëÊÅØ</span>
                </div>
            </div>
            <button class="m-btn small" onclick="toggleChatSettings()">‚öôÔ∏è</button>
        </div>
        <div class="chat-body" id="chat-history"></div>
        <div id="sticker-modal" style="display:none;">
            <div class="sticker-grid" id="sticker-grid-container"></div>
            <div class="sticker-toolbar">
                <input type="file" id="sticker-upload-input" multiple accept="image/*" style="display:none" onchange="handleStickerUpload(this)">
                <div style="display:flex; gap:10px">
                    <button class="m-btn small" onclick="document.getElementById('sticker-upload-input').click()">‚ûï ‰ªéÁõ∏ÂÜåÂØºÂÖ•</button>
                    <button class="m-btn small" id="toggle-del-btn" onclick="toggleStickerDeleteMode()" style="background:#e8d7d7; color:red;">üóëÔ∏è Âà†Èô§Ê®°Âºè</button>
                </div>
                <button class="m-btn small" onclick="document.getElementById('sticker-modal').style.display='none'">üîΩ</button>
            </div>
        </div>
        <div class="chat-footer" id="chat-footer-bar">
            <div id="normal-footer-content" style="width:100%; display:flex; flex-direction:column;">
                
                <div id="quote-preview-bar" class="quote-preview-bar">
                    <div style="display:flex; flex-direction:column; overflow:hidden;">
                        <span style="font-size:0.7rem; color:#06c755; font-weight:bold;">ÂõûÂ§çÔºö</span>
                        <span id="quote-content-text" class="quote-text-preview"></span>
                    </div>
                    <div class="quote-close-btn" onclick="cancelQuote()">√ó</div>
                </div>
                <div style="display:flex; align-items:center; gap:8px; width:100%;">
                    <input type="file" id="chat-img-input" style="display:none" accept="image/*" onchange="handleChatImageUpload(this)">
                    <button class="chat-func-btn" onclick="document.getElementById('chat-img-input').click()">‡∑Ü</button>
                    <button class="chat-func-btn" onclick="toggleStickers()">‚Ä¢·¥ó‚Ä¢</button>
<button class="chat-func-btn" id="btn-mic" onclick="toggleVoiceRecording()">üçè</button>
  
                    <input type="text" id="chat-input-text" placeholder="Aa" onkeydown="if(event.key==='Enter') sendUserMessage()">
                    <button class="chat-send-btn" onclick="sendUserMessage()">‚ô°</button>
                </div>
            </div>
            <div id="delete-footer-content" class="delete-toolbar">
                <button class="m-btn small" onclick="quitDeleteMode()" style="background:#ccc;">ÂèñÊ∂à</button>
                <span id="delete-count-text">Â∑≤ÈÄâ 0 Êù°</span>
              <button class="m-btn small" onclick="confirmCollectMessages()" style="background:#f1c40f; color:#333; margin-right:5px;">‚≠ê Êî∂Ëóè</button>
    <button class="m-btn small" onclick="confirmDeleteMessages()" style="background:#ff4444; color:white;">üóëÔ∏è Âà†Èô§</button>
</div>
        </div>
        <div class="chat-settings-panel" id="chat-settings">
            <h3>ËÅäÂ§©ËÆæÁΩÆ</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="m-btn small" onclick="toggleChatSettings()" style="background:#e8d7d7;">ÂÖ≥Èó≠Èù¢Êùø</button>
                <button class="m-btn small" onclick="clearChatHistory()" style="background:#d4a5a5; color:white;">Ê∏ÖÁ©∫ËÆ∞ÂΩï</button><button class="m-btn small" onclick="toggleCollectionList()" style="background:#ffeaa7; color:#d35400;">‚≠ê Êü•ÁúãÊî∂ËóèÂ§π</button>
    </div>

    <!-- Êñ∞Â¢ûÔºöÊî∂ËóèÂàóË°®ÂÆπÂô® (ÈªòËÆ§ÈöêËóè) -->
    <div id="chat-collection-container" style="display:none; margin-bottom:20px; border-top:2px dashed #ffeaa7; padding-top:10px;">
        <h4 style="color:#e67e22;">‚≠ê Ê∞∏‰πÖÊî∂Ëóè (ÁÇπÂáªÂõæÁâáÊü•Áúã)</h4>
        <div id="chat-collection-list" style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;"></div>
    </div>
             <div class="input-group">
                <label>ËÅäÂ§©ËÉåÊôØÂõæ</label>
                <input type="text" id="set-chat-bg" placeholder="ËæìÂÖ•ÈìæÊé•..." onblur="saveChatSettings()">
                <input type="file" onchange="handleFileToInput(this, 'bg')">
            </div>
            <h4 style="margin-top:15px">üëã Êãç‰∏ÄÊãçÈÖçÁΩÆ</h4>
            <div class="input-group">
                <label>Êãç‰∏ÄÊãçÁä∂ÊÄÅÂ∫ì</label>
                <textarea id="set-nudge-list" class="editor-textarea" style="height:80px" placeholder="‰∏ÄË°å‰∏Ä‰∏™" onblur="saveChatSettings()"></textarea>
            </div>
            <h4 style="margin-top:15px">üé≠ Â§¥ÂÉèËÆæÁΩÆ</h4>
            <div class="input-group"><label>ÊàëÁöÑÂ§¥ÂÉè</label><input type="file" onchange="handleFileToInput(this, 'myAvatar')"></div>
            <div class="input-group"><label>ÊàëÁöÑÂ§¥ÂÉèÊ°Ü (URL)</label><input type="text" id="set-my-frame" onblur="saveChatSettings()"></div>
            <div class="input-group"><label>ÂØπÊñπÂ§¥ÂÉè</label><input type="file" onchange="handleFileToInput(this, 'botAvatar')"></div>
            <div class="input-group"><label>ÂØπÊñπÂ§¥ÂÉèÊ°Ü (URL)</label><input type="text" id="set-bot-frame" onblur="saveChatSettings()"></div>
            <h4 style="margin-top:15px">üí¨ Ê∞îÊ≥°Ê†∑Âºè (ÊîØÊåÅ CSS)</h4>
            <div class="input-group"><label>ÊàëÁöÑÊ∞îÊ≥° CSS (ÊîØÊåÅ } .class::before { )</label><textarea id="set-my-css" class="editor-textarea" style="height:80px" onblur="saveChatSettings()"></textarea></div>
            <div class="input-group"><label>ÂØπÊñπÊ∞îÊ≥° CSS (ÊîØÊåÅ } .class::before { )</label><textarea id="set-bot-css" class="editor-textarea" style="height:80px" onblur="saveChatSettings()"></textarea></div>
            <h4 style="margin-top:15px">‚è±Ô∏è ÂõûÂ§çÈÄªËæë</h4>
            <div class="range-group"><label>Âª∂Ëøü(Áßí)</label><input type="number" id="set-delay-min" onchange="saveChatSettings()"> - <input type="number" id="set-delay-max" onchange="saveChatSettings()"></div>
            <div class="range-group"><label>Êù°Êï∞</label><input type="number" id="set-count-min" onchange="saveChatSettings()"> - <input type="number" id="set-count-max" onchange="saveChatSettings()"></div>
            <div class="range-group"><label>Ë¢´Âä®Èó¥Èöî(ÂàÜ)</label><input type="number" id="set-passive-min" onchange="saveChatSettings()"> - <input type="number" id="set-passive-max" onchange="saveChatSettings()"></div>
<h4 style="margin-top:15px">emoticon È¢úÊñáÂ≠óÈÖçÁΩÆ</h4>
<!-- Êñ∞Â¢ûÔºöÈ¢ëÁéáË∞ÉËäÇÊªëÂùó -->
<div class="input-group">
    <label style="display:flex; justify-content:space-between;">
        <span>Âá∫Áé∞È¢ëÁéá: <span id="kaomoji-prob-display" style="color:#6c5ce7; font-weight:bold;">60</span>%</span>
        <span style="font-size:0.7rem; color:#999;">(0=ÂÖ≥Èó≠, 100=ÂøÖÂ∏¶)</span>
    </label>
    <input type="range" id="set-kaomoji-prob" min="0" max="100" step="5" value="60" 
           style="width:100%; accent-color: #6c5ce7;"
           oninput="document.getElementById('kaomoji-prob-display').innerText = this.value; saveChatSettings()">
</div>
<!-- ÂéüÊúâÁöÑËæìÂÖ•Ê°Ü -->
<div class="input-group">
    <label>È¢úÊñáÂ≠óÂ∫ì (‰∏ÄË°å‰∏Ä‰∏™)</label>
    <textarea id="set-kaomoji-list" class="editor-textarea" style="height:80px" placeholder="‰æãÂ¶ÇÔºö\n(ÔΩ°‚Ä¢ÃÄ·¥ó-)‚úß\n(‚âß‚àá‚â¶)Ôæâ\n( ¬¥ÔΩ•ÔΩ•)Ôæâ(._.`)" onblur="saveChatSettings()"></textarea>
</div>
        </div>
    </div>
    <div id="thesaurus-modal" class="modal-overlay receipt-modal">
        <div class="modal-header" style="background:transparent; color:#555; box-shadow:none;">
            <span>&nbsp;</span><button class="close-btn" onclick="closeThesaurus()">√ó</button>
        </div>
        <div class="modal-body" style="padding: 0 20px 20px 20px;">
            <div class="receipt-card">
                <div class="receipt-header">
                    <div class="receipt-title">WORD BANK</div>
                    <div class="receipt-meta" id="receipt-date">DATE: 2026-01-24</div>
                </div>
                <div class="receipt-tabs">
                    <div class="r-tab active" onclick="switchThesaurusTab('reply')" id="tab-reply">ÂõûÂ§ç</div>
                    <div class="r-tab" onclick="switchThesaurusTab('note')" id="tab-note">Á∫∏Êù°</div>
                    <div class="r-tab" onclick="switchThesaurusTab('expense')" id="tab-expense">ÊîØÂá∫</div>
                    <div class="r-tab" onclick="switchThesaurusTab('income')" id="tab-income">Êî∂ÂÖ•</div>
                </div>
                <div class="receipt-body" id="thesaurus-list"></div>
                <div style="padding:15px; border-top:2px dashed #ccc; display:flex; gap:10px; background:#fcfcfc;">
                    <button class="m-btn small" onclick="addWord()" style="background:#555; color:#fff;">+ Ë°å</button>
                    <button class="m-btn small" onclick="exportWords()" style="background:#ccc;">ÂØºÂá∫</button>
                    <button class="m-btn small" onclick="importWords()" style="background:#ccc;">ÂØºÂÖ•</button>
                </div>
                <input type="file" id="txt-import-input" class="hidden-file-input" accept=".txt">
            </div>
        </div>
    </div>
    <div id="wb-modal" class="modal-overlay">
        <div class="modal-header"><span>‰∏ñÁïå‰π¶</span><button class="close-btn" onclick="closeWorldBook()">√ó</button></div>
        <div class="modal-body" style="padding: 10px; position: relative;">
            <div id="wb-container">
                <div class="wb-sidebar" id="wb-sidebar"></div>
                <div class="wb-main">
                    <div class="wb-toolbar">
                        <input type="file" id="any-import-input" class="hidden-file-input" accept=".json,.txt">
                        <button class="m-btn small" style="background:#9fb1bc;" onclick="importAny()">üìÇ ÂØºÂÖ•</button>
                        <button class="m-btn small" style="background:#8fbbbd;" onclick="exportCategory()">üíæ ÂØºÂá∫TXT</button>
                        <button class="m-btn small" onclick="addEntry()">+ Êñ∞Â¢û</button>
                    </div>
                    <div class="wb-list" id="wb-list"></div>
                </div>
                <div id="wb-editor-overlay">
                    <div class="editor-header">
                        <button class="m-btn small" style="background:#e8d7d7; color:#7a6363" onclick="closeEntryEditor()">ÂèñÊ∂à</button>
                        <span style="font-weight:bold; color:#6b5858">ÁºñËæë</span>
                        <button class="m-btn small" onclick="saveEntryEditor()">‰øùÂ≠ò</button>
                    </div>
                    <div class="editor-body">
                        <div class="input-group"><label>Ê†áÈ¢ò</label><input type="text" id="edit-title"></div>
                        <div class="input-group" style="flex:1; display:flex; flex-direction:column;"><label>ÂÜÖÂÆπ</label><textarea id="edit-content" class="editor-textarea"></textarea></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div id="letter-app-modal" class="modal-overlay">
    <div id="letter-list-view" style="width:100%; height:100%; display:flex; flex-direction:column; background:#f5f5f5;">
        <div class="modal-header" style="background:#e0dcd0; color:#5e4b4b;">
            <span>üì¨ ‰ø°ÁÆ±</span>
            <div style="display:flex; gap:15px;">
                <button class="m-btn small" onclick="createNewLetter()" style="background:#fff;">‚úèÔ∏è ÂÜô‰ø°</button>
                <button class="close-btn" onclick="closeLetterApp()">√ó</button>
            </div>
        </div>
        <div id="letter-history-list" style="padding:20px; overflow-y:auto; flex:1;">
        </div>
    </div>
    <div id="letter-write-view" style="display:none; width:100%; height:100%; flex-direction:column; background:#e0e0e0;">
        <div style="padding:10px; display:flex; justify-content:space-between; background:#d4c4a8; align-items:center; flex-shrink:0;">
            <button class="m-btn small" onclick="backToLetterList()" style="background:#fff;">üîô ËøîÂõû</button>
            <div style="font-size:0.9rem; font-weight:bold; color:#5e4b4b;">Date: <span id="letter-date"></span></div>
            <button class="m-btn small" id="btn-del-letter" onclick="deleteCurrentLetter()" style="background:transparent; color:red; border:none;">üóëÔ∏è</button>
        </div>
<div class="letter-write-container">
    <div class="paper-sheet sheet-user">
        <div style="font-size:0.8rem; color:#999; margin-bottom:5px; text-align:right;">From: Me</div>
        <textarea id="letter-content" class="letter-textarea-clean" placeholder="Âú®Ê≠§ÂÜô‰∏ã‰Ω†ÁöÑ‰ø°‰ª∂..." oninput="handleLetterInput(this)"></textarea>
    </div>
    <div id="letter-action-bar" style="text-align:center;">
        <button id="btn-send-letter" class="m-btn primary" onclick="generateReplyLetter(false)" style="width:100%; font-family:sans-serif; background:#5e6d79;">üìÆ ÂØÑÂá∫ (ÊäïÊé∑Âç†ÊòüÈ™∞)</button>
    </div>
    <div id="reply-sheet" class="paper-sheet sheet-reply" style="display:none;">
        <div id="dice-visual-container" class="dice-visual-row">            
        </div>        
        <div style="font-size:0.8rem; color:#999; margin-bottom:10px;">Reply:</div>
        <div id="reply-content-display" style="white-space: pre-wrap; flex:1;"></div>
<div style="margin-top:20px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.1); display:flex; gap:10px;">
   <button id="btn-footer-gift" class="m-btn small" onclick="openGiftModal()" style="background:#d4a5a5; color:white; flex:1;">üéÅ Êü•ÁúãÈöè‰ø°Á§ºÁâ©</button>
    <button id="btn-footer-regen" class="m-btn small" onclick="generateReplyLetter(true)" style="background:#ccc; color:#555;">üîÑ ÈáçÂÜôÂÜÖÂÆπ(‰∏çÊîπÈ™∞Â≠ê)</button>
</div>    </div>
    <div style="height:50px;"></div>
</div>
    </div>
</div>
<div id="gift-modal" class="modal-overlay" style="background:rgba(0,0,0,0.7);">
    <button class="close-btn" onclick="document.getElementById('gift-modal').style.display='none'" style="position:absolute; top:20px; right:20px; color:#fff; z-index:100;">√ó</button>
    
    <div class="receipt-gift-wrapper">
        <div class="gift-invoice-head">
            <div class="gift-invoice-title">GIFT INVOICE</div>
            <div class="gift-invoice-meta">ORDER #<span id="gift-id">0000</span></div>
            <div class="gift-invoice-meta" id="gift-date-str">J** **, *0**</div>
        </div>

        <div class="gift-item-row">
            <span>ITEM:</span>
            <span>Mystery Gift</span>
        </div>

        <div style="border-bottom:2px solid #333; margin-bottom:10px;"></div>

        <div class="gift-desc-block" id="gift-content-text">
            Wait for data...
        </div>

               <div class="gift-item-row" style="margin-top:15px;">
            <span>TOTAL:</span>
            <span id="gift-price-display">$‚ôæÔ∏è (LOVE)</span>
        </div>

        <div class="gift-reason-block">
            <strong>ASTRO LOG:</strong><br>
            <span id="gift-reason-text">...</span>
        </div>

        <div style="text-align:center; margin-top:20px; font-size:0.6rem;">
            THANK YOU FOR YOUR PATIENCE
        </div>
        <div class="gift-barcode">||| || ||| | ||||</div>
    </div>
</div>
    <script>

// === üñºÔ∏è ÂõæÁâáÂéãÁº©Â∑•ÂÖ∑ (Ê†∏ÂøÉ‰ºòÂåñË°•‰∏Å) ===
// Â∞ÜÂ§ßÂõæÁâáÂéãÁº©Âà∞ 1280px ÂÆΩÔºåË¥®Èáè 0.7ÔºåÂ§ßÂπÖÈôç‰ΩéÂÜÖÂ≠òÂç†Áî®
// === üñºÔ∏è Êô∫ËÉΩÂõæÁâáÂ§ÑÁêÜÂ∑•ÂÖ∑ (‰øÆÂ§çGIFÂèòÈùôÂõæ„ÄÅÂõæÊ†áÈªëÂ∫ïÈóÆÈ¢ò) ===
function compressImage(file, callback) {
    // 1. Â¶ÇÊûúÊòØ GIFÔºå‰∏∫‰∫Ü‰øùÁïôÂä®ÊïàÔºåÁõ¥Êé•‰∏çÂéãÁº©ÔºÅ
    if (file.type === 'image/gif') {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => callback(e.target.result);
        return;
    }

    // 2. Â¶ÇÊûúÊñá‰ª∂Êú¨Êù•Â∞±ÂæàÂ∞è (Â∞è‰∫é 500KB)ÔºåÁõ¥Êé•‰∏çÂéãÁº©ÔºÅ
    // (ËøôÊ†∑ÂõæÊ†áÁöÑÈÄèÊòéÂ∫¶„ÄÅÂ∞èÂõæÁöÑÊ∏ÖÊô∞Â∫¶ÈÉΩËÉΩÂÆåÁæé‰øùÁïô)
    if (file.size < 500 * 1024) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => callback(e.target.result);
        return;
    }

    // 3. Âè™ÊúâÂ§ßÂõæÁâáÊâçËøõÂéãÁº©Êú∫
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let width = img.width;
            let height = img.height;
            
            // ÈôêÂà∂ÊúÄÂ§ßÂ∞∫ÂØ∏ (ËÉåÊôØÂõæÂèØ‰ª•Á®çÂ§ß‰∏ÄÁÇπÔºå1920Â§üÊ∏ÖÊô∞‰∫Ü)
            const MAX_SIZE = 1920;
            if (width > height) {
                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
            } else {
                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // Êô∫ËÉΩÂà§Êñ≠ËæìÂá∫Ê†ºÂºè
            let outputType = 'image/jpeg';
            let quality = 0.7;

            // Â¶ÇÊûúÂéüÂõæÊòØ PNGÔºå‰∏∫‰∫Ü‰øùÁïôÈÄèÊòéÂ∫¶ÔºåÂøÖÈ°ªËæìÂá∫‰∏∫ PNG
            if (file.type === 'image/png') {
                outputType = 'image/png';
                quality = 0.8; 
            }

            const compressedBase64 = canvas.toDataURL(outputType, quality);
            callback(compressedBase64);
        }
    }
}
        // === ÂÖ®Â±ÄÂèòÈáè ===
        let chatDisplayLimit = 20; 
        let currentQuoteData = null; 
        let isDeleteMode = false; 
        let selectedDeleteIds = new Set(); 
        let longPressTimer = null; 
        
        let thesaurusCats = ['reply', 'note', 'expense', 'income'];
        let currentThesaurusTab = 'reply';
// === ÁâåÂêçÊò†Â∞ÑÊï∞ÊçÆ ===
const TAROT_NAMES = {
    0: "ÊÑö‰∫∫", 1: "È≠îÊúØÂ∏à", 2: "Â•≥Á•≠Âè∏", 3: "ÁöáÂêé", 4: "ÁöáÂ∏ù", 5: "ÊïôÁöá", 6: "ÊÅã‰∫∫", 7: "ÊàòËΩ¶",
    8: "ÂäõÈáè", 9: "ÈöêÂ£´", 10: "ÂëΩËøê‰πãËΩÆ", 11: "Ê≠£‰πâ", 12: "ÂÄíÂêä‰∫∫", 13: "Ê≠ªÁ•û", 14: "ËäÇÂà∂", 15: "ÊÅ∂È≠î",
    16: "È´òÂ°î", 17: "ÊòüÊòü", 18: "Êúà‰∫Æ", 19: "Â§™Èò≥", 20: "ÂÆ°Âà§", 21: "‰∏ñÁïå",
    // ÊùÉÊùñ (22-35)
    22: "ÊùÉÊùñÁéãÁâå", 23: "ÊùÉÊùñ‰∫å", 24: "ÊùÉÊùñ‰∏â", 25: "ÊùÉÊùñÂõõ", 26: "ÊùÉÊùñ‰∫î", 27: "ÊùÉÊùñÂÖ≠", 28: "ÊùÉÊùñ‰∏É",
    29: "ÊùÉÊùñÂÖ´", 30: "ÊùÉÊùñ‰πù", 31: "ÊùÉÊùñÂçÅ", 32: "ÊùÉÊùñ‰æç‰ªé", 33: "ÊùÉÊùñÈ™ëÂ£´", 34: "ÊùÉÊùñÁéãÂêé", 35: "ÊùÉÊùñÂõΩÁéã",
    // Âú£ÊùØ (36-49)
    36: "Âú£ÊùØÁéãÁâå", 37: "Âú£ÊùØ‰∫å", 38: "Âú£ÊùØ‰∏â", 39: "Âú£ÊùØÂõõ", 40: "Âú£ÊùØ‰∫î", 41: "Âú£ÊùØÂÖ≠", 42: "Âú£ÊùØ‰∏É",
    43: "Âú£ÊùØÂÖ´", 44: "Âú£ÊùØ‰πù", 45: "Âú£ÊùØÂçÅ", 46: "Âú£ÊùØ‰æç‰ªé", 47: "Âú£ÊùØÈ™ëÂ£´", 48: "Âú£ÊùØÁéãÂêé", 49: "Âú£ÊùØÂõΩÁéã",
    // ÂÆùÂâë (50-63)
    50: "ÂÆùÂâëÁéãÁâå", 51: "ÂÆùÂâë‰∫å", 52: "ÂÆùÂâë‰∏â", 53: "ÂÆùÂâëÂõõ", 54: "ÂÆùÂâë‰∫î", 55: "ÂÆùÂâëÂÖ≠", 56: "ÂÆùÂâë‰∏É",
    57: "ÂÆùÂâëÂÖ´", 58: "ÂÆùÂâë‰πù", 59: "ÂÆùÂâëÂçÅ", 60: "ÂÆùÂâë‰æç‰ªé", 61: "ÂÆùÂâëÈ™ëÂ£´", 62: "ÂÆùÂâëÁéãÂêé", 63: "ÂÆùÂâëÂõΩÁéã",
    // ÊòüÂ∏Å (64-77)
    64: "ÊòüÂ∏ÅÁéãÁâå", 65: "ÊòüÂ∏Å‰∫å", 66: "ÊòüÂ∏Å‰∏â", 67: "ÊòüÂ∏ÅÂõõ", 68: "ÊòüÂ∏Å‰∫î", 69: "ÊòüÂ∏ÅÂÖ≠", 70: "ÊòüÂ∏Å‰∏É",
    71: "ÊòüÂ∏ÅÂÖ´", 72: "ÊòüÂ∏Å‰πù", 73: "ÊòüÂ∏ÅÂçÅ", 74: "ÊòüÂ∏Å‰æç‰ªé", 75: "ÊòüÂ∏ÅÈ™ëÂ£´", 76: "ÊòüÂ∏ÅÁéãÂêé", 77: "ÊòüÂ∏ÅÂõΩÁéã"
};

const LENORMAND_NAMES = {
    1: "È™ëÂ£´", 2: "Âπ∏ËøêËçâ", 3: "Ëàπ", 4: "ÊàøÂ≠ê", 5: "Ê†ë", 6: "‰∫ë", 7: "Ëõá", 8: "Ê£∫Êùê", 9: "Ëä±Êùü",
    10: "Èï∞ÂàÄ", 11: "Èû≠Â≠ê", 12: "È∏ü", 13: "Â∞èÂ≠©", 14: "ÁãêÁã∏", 15: "ÁÜä", 16: "ÊòüÊòü", 17: "Èπ≥È∏ü", 18: "Áãó",
    19: "Â°î", 20: "Ëä±Âõ≠", 21: "Â±±", 22: "Ë∑Ø", 23: "ËÄÅÈº†", 24: "ÂøÉ", 25: "ÊàíÊåá", 26: "‰π¶", 27: "‰ø°",
    28: "Áî∑‰∫∫", 29: "Â•≥‰∫∫", 30: "ÁôæÂêà", 31: "Â§™Èò≥", 32: "Êúà‰∫Æ", 33: "Èí•Âåô", 34: "È±º", 35: "Èîö", 36: "ÂçÅÂ≠óÊû∂"
};

        // === Âü∫Á°ÄÈÄªËæë ===
        function updateTime() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('clock').innerText = `${h}:${m}`;
            const dateStr = now.toISOString().split('T')[0];
            if(document.getElementById('receipt-date')) document.getElementById('receipt-date').innerText = "DATE: " + dateStr;
        }
        setInterval(updateTime, 1000); updateTime();
const DB_NAME = "RetroOS_System_V7789";  
const DB_VERSION = 25; 
const idb = {
    db: null,
    init: function() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            
            req.onupgradeneeded = (e) => {
                console.log("Ê≠£Âú®Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÁªìÊûÑ...");
                const db = e.target.result;
                if(!db.objectStoreNames.contains('tv')) db.createObjectStore('tv', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('chat_history')) db.createObjectStore('chat_history', { keyPath: 'id', autoIncrement: true });
                if(!db.objectStoreNames.contains('pickup_data')) db.createObjectStore('pickup_data', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('chat_stickers')) db.createObjectStore('chat_stickers', { keyPath: 'id', autoIncrement: true });
                if(!db.objectStoreNames.contains('settings_heavy')) db.createObjectStore('settings_heavy', { keyPath: 'key' });           
                if(!db.objectStoreNames.contains('album_data')) db.createObjectStore('album_data', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('anniversary_data')) db.createObjectStore('anniversary_data', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('tarot_deck')) db.createObjectStore('tarot_deck', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('lenormand_deck')) db.createObjectStore('lenormand_deck', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('theater_data')) db.createObjectStore('theater_data', { keyPath: 'id' });
                if(!db.objectStoreNames.contains('forum_data')) db.createObjectStore('forum_data', { keyPath: 'id' });
if(!db.objectStoreNames.contains('universal_store')) db.createObjectStore('universal_store', { keyPath: 'id' });
            };

            req.onsuccess = (e) => { 
                this.db = e.target.result; 
                console.log("Êï∞ÊçÆÂ∫ìËøûÊé•ÊàêÂäüÔºÅ");
setTimeout(checkAnniversaries, 2000);
                resolve(this.db); 
            };
            
            req.onerror = (e) => {
                console.error("IndexedDB ÈîôËØØ:", e.target.error);
                resolve(null);
            };
        });
    },
    put: function(storeName, data) {
        return new Promise((resolve) => {
            try {
                const tx = this.db.transaction([storeName], "readwrite");
                tx.objectStore(storeName).put(data);
                tx.oncomplete = () => resolve();
            } catch (err) { console.error(err); resolve(); }
        });
    },
    get: function(storeName, key) {
        return new Promise((resolve) => {
            try {
                const tx = this.db.transaction([storeName], "readonly");
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            } catch (err) { resolve(null); }
        });
    },
    getAll: function(storeName) {
        return new Promise((resolve) => {
            try {
                const tx = this.db.transaction([storeName], "readonly");
                const req = tx.objectStore(storeName).getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve([]);
            } catch (err) { resolve([]); }
        });
    },
    delete: function(storeName, key) {
        return new Promise((resolve) => {
            try {
                const tx = this.db.transaction([storeName], "readwrite");
                tx.objectStore(storeName).delete(key);
                tx.oncomplete = () => resolve();
            } catch (err) { resolve(); }
        });
    },
    clear: function(storeName) {
        return new Promise((resolve) => {
            try {
                const tx = this.db.transaction([storeName], "readwrite");
                tx.objectStore(storeName).clear();
                tx.oncomplete = () => resolve();
            } catch (err) { resolve(); }
        });
    }
};

// === ‰øÆÂ§çÁâàÔºöÊô∫ËÉΩÂÖºÂÆπÂΩïÈü≥ÂäüËÉΩ ===
let mediaRecorder;
let audioChunks = [];
let isRecordingVoice = false;

async function toggleVoiceRecording() {
    const btn = document.getElementById('btn-mic');
    const input = document.getElementById('chat-input-text');

    if (!isRecordingVoice) {
        // 1. Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÊùÉÈôê
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return alert("Êó†Ê≥ïÂΩïÈü≥ÔºöËØ∑Á°Æ‰øù‰ΩøÁî® HTTPS ÂçèËÆÆÊàñÂú®Êú¨Âú∞ localhost ËøêË°åÔºåÂπ∂ÂÖÅËÆ∏È∫¶ÂÖãÈ£éÊùÉÈôê„ÄÇ");
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // 2. Ê†∏ÂøÉ‰øÆÂ§çÔºöËá™Âä®Ê£ÄÊµãÊîØÊåÅÁöÑÊ†ºÂºè (‰ºòÂÖà MP4 ‰ª•ÂÖºÂÆπ iOS)
            let mimeType = 'audio/webm'; // ÈªòËÆ§
            if (MediaRecorder.isTypeSupported('audio/mp4')) {
                mimeType = 'audio/mp4'; // iOS ÂèãÂ•Ω
            } else if (MediaRecorder.isTypeSupported('audio/aac')) {
                mimeType = 'audio/aac';
            }
            
            console.log("ÈááÁî®ÂΩïÈü≥Ê†ºÂºè:", mimeType);
            mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
            
            mediaRecorder.start();
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                // ‰ΩøÁî®Ê£ÄÊµãÂà∞ÁöÑÊ†ºÂºèÁîüÊàê Blob
                const audioBlob = new Blob(audioChunks, { type: mimeType });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob); 
                reader.onloadend = () => {
                    const base64data = reader.result;
                    // ÂèëÈÄÅÊ∂àÊÅØ
                    appendMessage(base64data, true, 'audio'); 
                    triggerBotReply(); 
                }
                // ÂÅúÊ≠¢Âç†Áî®È∫¶ÂÖãÈ£é (ÂÖ≥Èó≠Á∫¢ÁÇπ)
                stream.getTracks().forEach(track => track.stop());
            };
            
            isRecordingVoice = true;
            btn.classList.add("recording-active"); // ÊåâÈíÆÂèòÁ∫¢Èó™ÁÉÅ
            input.value = "üçé Ê≠£Âú®ÂΩïÈü≥... (ÂÜçÊ¨°ÁÇπÂáªÂõæÊ†áÂèëÈÄÅ)";
            input.disabled = true;
            
        } catch (err) {
            console.error(err);
            alert("ÂΩïÈü≥ÂêØÂä®Â§±Ë¥•: " + err.message);
        }
    } else {
        // ÁªìÊùüÂΩïÈü≥
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        isRecordingVoice = false;
        btn.classList.remove("recording-active");
        input.value = "";
        input.placeholder = "Aa";
        input.disabled = false;
    }
}

// Êí≠ÊîæÂáΩÊï∞ÁöÑÂ¢ûÂº∫‰øÆÂ§ç
function playAudioMsg(btn, src) {
    const icon = btn.querySelector('.audio-icon');
    const originalIcon = "üçè"; // ÊÅ¢Â§çÂõæÊ†á
    
    try {
        const audio = new Audio();
        audio.src = src;
        
        audio.onplay = () => { icon.innerText = "üçè"; }; // Êí≠Êîæ‰∏≠
        audio.onended = () => { icon.innerText = originalIcon; }; // ÁªìÊùü
        audio.onerror = (e) => { 
            console.error("Êí≠ÊîæÈîôËØØ", e);
            alert("Êó†Ê≥ïÊí≠ÊîæÔºöÊ†ºÂºè‰∏çÊîØÊåÅÊàñÊï∞ÊçÆÊçüÂùè"); 
            icon.innerText = originalIcon; 
        };
        
        audio.play().catch(e => {
            alert("Êí≠ÊîæË¢´Êã¶Êà™ÔºåËØ∑ÁÇπÂáªÈáçËØï");
        });
    } catch(e) {
        alert("Èü≥È¢ëÁªÑ‰ª∂ÂàùÂßãÂåñÂ§±Ë¥•");
    }
}
function playAudioMsg(btn, src) {
    const audio = new Audio(src);
    const icon = btn.querySelector('.audio-icon');
    const originalIcon = icon.innerText;
    
    audio.play();
    icon.innerText = "üçé"; // Êí≠Êîæ‰∏≠ÂõæÊ†á
    
    audio.onended = () => {
        icon.innerText = originalIcon; // ÊÅ¢Â§çÂõæÊ†á
    };
    audio.onerror = () => {
        alert("Êó†Ê≥ïÊí≠ÊîæÊ≠§Èü≥È¢ë");
        icon.innerText = originalIcon;
    };
}
async function loadTVContent() {
    try {
        // Êîπ‰∏∫‰ªé settings_heavy (ÁæéÂåñÂ≠òÂÇ®) ËØªÂèñ
        const res = await idb.get('settings_heavy', 'tv_screen_content');
        if (res && res.data) {
            document.getElementById('tv-content').src = res.data;
            document.getElementById('tv-content').style.display = 'block';
            const ph = document.querySelector('.tv-container .tv-placeholder');
            if(ph) ph.style.display = 'none';
        }
    } catch(e) {}
}
        
        let typeWriterTimeout = null; 
        function openFan() {
            const modal = document.getElementById('fan-modal');
            const textEl = document.getElementById('fan-display-text');
            textEl.innerHTML = '';
            
            if(typeWriterTimeout) clearTimeout(typeWriterTimeout);
            
            const data = getThesaurusData()['note'] || [];
            let fullText = data.length > 0 ? data[Math.floor(Math.random() * data.length)] : "NO SIGNAL...\n\nSYSTEM STANDBY";
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                let charIndex = 0;
                function typeChar() {
                    if (charIndex < fullText.length) {
                        textEl.innerHTML += fullText.charAt(charIndex);
                        charIndex++;
                        typeWriterTimeout = setTimeout(typeChar, 30); 
                    }
                }
                typeChar();
            }, 500);
        }
        function closeFan() {
            document.getElementById('fan-modal').style.display = 'none';
            if(typeWriterTimeout) clearTimeout(typeWriterTimeout);
        }
        function openFileApp() { 
            document.getElementById('file-modal').style.display = 'flex'; 
            checkDeckStatus(); // ÊâìÂºÄÊó∂Á´ãÂç≥Ê£ÄÊü•‰øùÂ≠òÁä∂ÊÄÅ
        }        document.getElementById('file-generic-input').addEventListener('change', function(e){
            if(e.target.files.length > 0) {
                alert("Êñá‰ª∂Â∑≤ÈÄâÊã©ÔºåÁ≥ªÁªüÂ∑≤Êé•Êî∂ (ÈÄöÁî®Êñá‰ª∂‰∏çÂÅöÁâπÊÆäÂÖ•Â∫ìÂ§ÑÁêÜ)");
            }
        }); 
        // ================= üëá Â°îÁΩóÁâå‰øÆÂ§çË°•‰∏ÅÂºÄÂßã üëá =================
        document.getElementById('file-tarot-input').addEventListener('change', async function(e){
            const files = Array.from(e.target.files);
            let count = 0;
            const statusDiv = document.getElementById('tarot-status');
            if(statusDiv) statusDiv.innerText = "Ê≠£Âú®Â§ÑÁêÜ... (ËØ∑Á®çÂÄô)";
            
            for(let file of files) {
                // ÂåπÈÖçÊñá‰ª∂ÂêçÂºÄÂ§¥ÁöÑÊï∞Â≠ó (‰æãÂ¶Ç 0.jpg, 12_fool.png)
                const match = file.name.match(/^(\d+)/);
                if(match) {
                    const id = parseInt(match[1]);
                    // Â°îÁΩóÁâå ID ËåÉÂõ¥ÂøÖÈ°ªÊòØ 0 Âà∞ 77
                    if(id >= 0 && id <= 77) {
                        const reader = new FileReader();
                        await new Promise(resolve => {
                            reader.onload = (evt) => {
                                // Â≠òÂÖ•Êï∞ÊçÆÂ∫ì 'tarot_deck'
                                idb.put('tarot_deck', { id: id, data: evt.target.result }).then(resolve);
                            };
                            reader.onerror = resolve; // Èò≤Ê≠¢ÂùèÊñá‰ª∂Âç°Ê≠ª
                            reader.readAsDataURL(file);
                        });
                        count++;
                    }
                }
            }
            
            // Êõ¥Êñ∞ÁïåÈù¢‰∏äÁöÑÁä∂ÊÄÅÊñáÂ≠ó
            checkDeckStatus();
            
            if(count > 0) {
                alert(`‚úÖ ÊàêÂäüÂØºÂÖ• ${count} Âº†Â°îÁΩóÁâåÔºÅ`);
            } else {
                alert("‚ùå Êú™ÊâæÂà∞ÊúâÊïàÂõæÁâáÔºÅ\nËØ∑Á°Æ‰øùÊñá‰ª∂Âêç‰ª•Êï∞Â≠óÂºÄÂ§¥ (0-77)Ôºå‰æãÂ¶Ç '0.jpg'");
            }
            if(statusDiv) statusDiv.innerText = "";
        });
        // ================= üëÜ Â°îÁΩóÁâå‰øÆÂ§çË°•‰∏ÅÁªìÊùü üëÜ =================
       
// ÂÖºÂÆπÂÆâÂçìÁöÑÊñá‰ª∂ÂØºÂÖ•ÈÄªËæë - Èõ∑ËØ∫Êõº
document.getElementById('file-lenormand-input').addEventListener('change', async function(e){
    const files = Array.from(e.target.files);
    let count = 0;
    const statusDiv = document.getElementById('lenormand-status');
    if(statusDiv) statusDiv.innerText = "Ê≠£Âú®Â§ÑÁêÜ...";
    
    for(let file of files) {
        // ‰øÆÊîπÁÇπÔºöÊ≠£ÂàôÊîæÂÆΩ
        const match = file.name.match(/^(\d+)\./);
        if(match) {
            const id = parseInt(match[1]);
            if(id >= 1 && id <= 36) {
                const reader = new FileReader();
                await new Promise(resolve => {
                    reader.onload = (evt) => {
                        idb.put('lenormand_deck', { id: id, data: evt.target.result }).then(resolve);
                    };
                    reader.onerror = resolve;
                    reader.readAsDataURL(file);
                });
                count++;
            }
        }
    }
    if(count > 0) {
        alert(`‚úÖ ÊàêÂäüÂØºÂÖ• ${count} Âº†Èõ∑ËØ∫ÊõºÁâåÔºÅ(ÂÖºÂÆπÊ®°Âºè)`);
    } else {
        alert("‚ùå Êú™ÊâæÂà∞Á¨¶ÂêàËßÑËåÉÁöÑÂõæÁâá (1.jpg - 36.jpg)");
    }
});     document.getElementById('file-lenormand-input').addEventListener('change', async function(e){
            const files = Array.from(e.target.files);
            let count = 0;
            const statusDiv = document.getElementById('lenormand-status');
            if(statusDiv) statusDiv.innerText = "Ê≠£Âú®Â§ÑÁêÜ...";
            
            for(let file of files) {
                const match = file.name.match(/^(\d+)\.(jpg|jpeg)$/i);
                if(match) {
                    const id = parseInt(match[1]);
                    if(id >= 1 && id <= 36) {
                        const reader = new FileReader();
                        await new Promise(resolve => {
                            reader.onload = (evt) => {
                                idb.put('lenormand_deck', { id: id, data: evt.target.result }).then(resolve);
                            };
                            reader.readAsDataURL(file);
                        });
                        count++;
                    }
                }
            }
            if(count > 0) {
                alert(`‚úÖ ÊàêÂäüÂØºÂÖ• ${count} Âº†Èõ∑ËØ∫ÊõºÁâåÔºÅ`);
            } else {
                alert("‚ùå Êú™ÊâæÂà∞Á¨¶ÂêàËßÑËåÉÁöÑÂõæÁâá (1-36.jpg)");
            }
        });
        async function checkDeckStatus() {
            try {
                const tarotList = await idb.getAll('tarot_deck');
                const tCount = tarotList ? tarotList.length : 0;
                const tEl = document.getElementById('tarot-status');
                if(tCount > 0) {
                    tEl.innerHTML = `<span style="color:#4caf50; font-weight:bold;">‚úÖ Á≥ªÁªüÊ°£Ê°à‰∏≠Â∑≤Ê∞∏‰πÖ‰øùÂ≠ò: ${tCount} Âº†</span>`;
                    if(tCount < 78) tEl.innerHTML += ` <span style="color:#ff9800; font-size:0.7rem">(ËøòÂ∑Æ ${78-tCount} Âº†)</span>`;
                } else {
                    tEl.innerText = "ÂΩìÂâçÊ°£Ê°à‰∏∫Á©∫ÔºåËØ∑‰∏ä‰º† 0-77.jpg";
                }
            } catch(e) { console.log(e); }
            try {
                const lenList = await idb.getAll('lenormand_deck');
                const lCount = lenList ? lenList.length : 0;
                const lEl = document.getElementById('lenormand-status');
                if(lCount > 0) {
                    lEl.innerHTML = `<span style="color:#4caf50; font-weight:bold;">‚úÖ Á≥ªÁªüÊ°£Ê°à‰∏≠Â∑≤Ê∞∏‰πÖ‰øùÂ≠ò: ${lCount} Âº†</span>`;
                    if(lCount < 36) lEl.innerHTML += ` <span style="color:#ff9800; font-size:0.7rem">(ËøòÂ∑Æ ${36-lCount} Âº†)</span>`;
                } else {
                    lEl.innerText = "ÂΩìÂâçÊ°£Ê°à‰∏∫Á©∫ÔºåËØ∑‰∏ä‰º† 1-36.jpg";
                }
            } catch(e) { console.log(e); }
        }
async function openChatApp() {
    document.getElementById('chat-modal').style.display = 'flex';
    loadSettingsToUI();
    
    
    await applyChatSettings(); 
    
    chatDisplayLimit = 20; 
    renderChatHistory();
}
        function closeChatApp() { document.getElementById('chat-modal').style.display = 'none'; }
        function toggleChatSettings() { document.getElementById('chat-settings').classList.toggle('open'); }

        function getChatSettings() {
            const def = {
                myFrame: '', botFrame: '',
                myCss: '', botCss: '', delayMin: 1, delayMax: 5, countMin: 1, countMax: 3,
                passiveMin: 1, passiveMax: 60, title: "ÁßÅÂØÜËÅäÂ§©", isOnline: false,
                nudgeList: "ÂèëÂëÜ\nÁù°Ëßâ\nÊï∞Èí±\nÂπ≤È•≠\nÊë∏È±º"
            };
            try { return { ...def, ...JSON.parse(localStorage.getItem('chat_settings') || '{}') }; } 
            catch { return def; }
        }

        function saveChatSettings(extraData = {}) {
            let s = getChatSettings();
            const uiData = {
                myFrame: document.getElementById('set-my-frame').value,
                botFrame: document.getElementById('set-bot-frame').value,
                myCss: document.getElementById('set-my-css').value,
                botCss: document.getElementById('set-bot-css').value,
                delayMin: parseInt(document.getElementById('set-delay-min').value) || 1,
                delayMax: parseInt(document.getElementById('set-delay-max').value) || 5,
                countMin: parseInt(document.getElementById('set-count-min').value) || 1,
                countMax: parseInt(document.getElementById('set-count-max').value) || 3,
                passiveMin: parseInt(document.getElementById('set-passive-min').value) || 1,
                passiveMax: parseInt(document.getElementById('set-passive-max').value) || 60,
                title: document.getElementById('chat-title-input').value,
                nudgeList: document.getElementById('set-nudge-list').value
            };
            s = { ...s, ...uiData, ...extraData };
            localStorage.setItem('chat_settings', JSON.stringify(s));
            applyChatSettings(); 
        }

        async function loadHeavyResources() {
            const bgItem = await idb.get('settings_heavy', 'bg');
            const myAvatarItem = await idb.get('settings_heavy', 'myAvatar');
            const botAvatarItem = await idb.get('settings_heavy', 'botAvatar');
            return {
                bg: bgItem ? bgItem.data : '',
                myAvatar: myAvatarItem ? myAvatarItem.data : '',
                botAvatar: botAvatarItem ? botAvatarItem.data : ''
            };
        }
        async function applyChatSettings() {
            const s = getChatSettings();
            const heavy = await loadHeavyResources();
            const chatModal = document.getElementById('chat-modal');
            if(heavy.bg) chatModal.style.backgroundImage = `url(${heavy.bg})`;
            else chatModal.style.backgroundImage = 'none';

            document.getElementById('chat-title-input').value = s.title;
            updateStatusUI(s.isOnline);
            window.currentAvatars = { my: heavy.myAvatar, bot: heavy.botAvatar };

            let styleTag = document.getElementById('dynamic-chat-style');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'dynamic-chat-style';
                document.head.appendChild(styleTag);
            }
            
            styleTag.innerHTML = `
                .msg-row.me .msg-bubble { ${s.myCss} }
                .msg-row.other .msg-bubble { ${s.botCss} }
            `;
        }

        function loadSettingsToUI() {
            const s = getChatSettings();
            document.getElementById('set-my-frame').value = s.myFrame || '';
            document.getElementById('set-bot-frame').value = s.botFrame || '';
            document.getElementById('set-my-css').value = s.myCss || '';
            document.getElementById('set-bot-css').value = s.botCss || '';
            document.getElementById('set-delay-min').value = s.delayMin;
            document.getElementById('set-delay-max').value = s.delayMax;
            document.getElementById('set-count-min').value = s.countMin;
            document.getElementById('set-count-max').value = s.countMax;
            document.getElementById('set-passive-min').value = s.passiveMin;
            document.getElementById('set-passive-max').value = s.passiveMax;
            document.getElementById('set-nudge-list').value = s.nudgeList || "";
            document.getElementById('set-chat-bg').value = ""; 
 if(document.getElementById('set-kaomoji-list')) document.getElementById('set-kaomoji-list').value = s.kaomojiList || "";
    if(document.getElementById('set-kaomoji-prob')) {
        // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆËøáÔºåÈªòËÆ§ÊòØ 0.6 (60%)
        const prob = (s.kaomojiProb !== undefined) ? Math.floor(s.kaomojiProb * 100) : 60;
        document.getElementById('set-kaomoji-prob').value = prob;
        document.getElementById('kaomoji-prob-display').innerText = prob;
    }
        }
function handleFileToInput(inputEl, type) {
    const file = inputEl.files[0];
    if(file) {
        // ‰øÆÊîπÔºö‰ΩøÁî®ÂéãÁº©ÂáΩÊï∞
        compressImage(file, (base64) => {
            idb.put('settings_heavy', { key: type, data: base64 }).then(() => {
                applyChatSettings(); 
                alert("‰øùÂ≠òÊàêÂäüÔºÅ");
            });
        });
    }
}
        function handleFileToInput(inputEl, type) {
    const file = inputEl.files[0];
    if(file) {
        // ‰øÆÊîπÔºö‰ΩøÁî®ÂéãÁº©ÂáΩÊï∞
        compressImage(file, (base64) => {
            idb.put('settings_heavy', { key: type, data: base64 }).then(() => {
                applyChatSettings(); 
                alert("‰øùÂ≠òÊàêÂäüÔºÅ");
            });
        });
    }
}
        function saveLineTitle() { saveChatSettings(); }

        let passiveTimer = null;
        function updateStatusUI(isOnline) {
            const toggle = document.getElementById('chat-status-toggle');
            const text = document.getElementById('chat-status-text');
            if(isOnline) {
                toggle.classList.add('status-online');
                text.innerText = "Âú®Á∫ø";
            } else {
                toggle.classList.remove('status-online');
                text.innerText = "‰ºëÊÅØ";
            }
        }
        function toggleOnlineStatus() {
            const s = getChatSettings();
            const newState = !s.isOnline;
            saveChatSettings({ isOnline: newState });
            updateStatusUI(newState);
            handlePassiveLoop(newState);
        }
        function handlePassiveLoop(isOnline) {
            if(passiveTimer) clearTimeout(passiveTimer);
            if(!isOnline) return;

            const s = getChatSettings();
            const minMs = s.passiveMin * 60 * 1000;
            const maxMs = s.passiveMax * 60 * 1000;
            const delay = Math.random() * (maxMs - minMs) + minMs;
            
            passiveTimer = setTimeout(() => {
                if(getChatSettings().isOnline) {
                    triggerBotReply();
                    handlePassiveLoop(true);
                }
            }, delay);
        }
        async function clearChatHistory() { 
            if(confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩïÔºü')) {
                await idb.clear('chat_history');
                document.getElementById('chat-history').innerHTML = ''; 
            }
        }
        function renderChatHistory() {
    return new Promise((resolve) => {
        const history = document.getElementById('chat-history');
        const tx = idb.db.transaction(['chat_history'], 'readonly');
        const store = tx.objectStore('chat_history');
        const keysReq = store.getAllKeys();

        keysReq.onsuccess = () => {
            const allKeys = keysReq.result;
            const total = allKeys.length;
            const startIndex = Math.max(0, total - chatDisplayLimit);
            const keysToLoad = allKeys.slice(startIndex); 
            if (keysToLoad.length === 0) {
                history.innerHTML = '<div class="load-more-container"><button class="load-more-btn" onclick="loadMoreMessages()">ÊöÇÊó†Êõ¥Â§öÂéÜÂè≤</button></div>';
                resolve();
                return;
            }

            const promises = keysToLoad.map(key => idb.get('chat_history', key));
            
            Promise.all(promises).then(msgs => {
                
                history.innerHTML = '';
                const loadBtnDiv = document.createElement('div');
                loadBtnDiv.className = 'load-more-container';
                loadBtnDiv.innerHTML = `<button class="load-more-btn" onclick="loadMoreMessages()">ÁÇπÂáªÂä†ËΩΩÊõ¥Â§öÂéÜÂè≤</button>`;
                history.appendChild(loadBtnDiv);
                const fragment = document.createDocumentFragment();
                msgs.forEach(msg => { 
                    if(msg) {
                        const el = createMessageElement(msg, true); 
                        fragment.appendChild(el);
                    }
                });
                
                history.appendChild(fragment);

                if(isDeleteMode) {
                    history.classList.add('delete-mode');
                }

                resolve(); 
            });
        };
    });
}

        function loadMoreMessages() {
            chatDisplayLimit += 20;
            renderChatHistory(); 
        }

        function triggerQuote(text, isMe) {
            if(isDeleteMode) return; 
            const s = getChatSettings();
            const userName = isMe ? "Êàë" : (s.title || "ÂØπÊñπ");
            
            currentQuoteData = { text: text, user: userName };

            const bar = document.getElementById('quote-preview-bar');
            const content = document.getElementById('quote-content-text');
            
            let previewText = text;
            if(text.startsWith('data:image') || text.startsWith('blob:')) previewText = '[ÂõæÁâá]';
            
            content.innerText = previewText;
            bar.style.display = 'flex';
        }

        function cancelQuote() {
            currentQuoteData = null; 
            document.getElementById('quote-preview-bar').style.display = 'none'; 
        }

        function appendMessage(content, isMe, type = 'text', quote = null) {
            const msgObj = { text: content, isMe: isMe, type: type, quote: quote, timestamp: Date.now() };
            const tx = idb.db.transaction(['chat_history'], "readwrite");
            const req = tx.objectStore('chat_history').add(msgObj);
            
            req.onsuccess = (e) => {
                msgObj.id = e.target.result; 
                createMessageElement(msgObj); 
                const history = document.getElementById('chat-history');
                history.scrollTop = history.scrollHeight;
            };
        }
function createMessageElement(msg, returnElementOnly = false) {
    const s = getChatSettings();
    const history = document.getElementById('chat-history'); 
    const avatars = window.currentAvatars || { my: '', bot: '' };
    const isMe = msg.isMe;

    const row = document.createElement('div');
    row.className = `msg-row ${isMe ? 'me' : 'other'}`;
    if(msg.type === 'system') {
        row.className = 'msg-row system';
        row.innerHTML = `<div class="msg-system-text">${msg.text}</div>`;
        if(returnElementOnly) return row;
        history.appendChild(row);
        return;
    }row.addEventListener('touchstart', () => handleLongPressStart(msg.id), {passive: true});
    row.addEventListener('touchend', handleLongPressEnd);
    row.addEventListener('mousedown', () => handleLongPressStart(msg.id));
    row.addEventListener('mouseup', handleLongPressEnd);
    row.addEventListener('mousemove', handleLongPressEnd);

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'msg-checkbox';
    if(selectedDeleteIds.has(msg.id)) checkbox.checked = true;
    checkbox.onclick = (e) => toggleSelectMessage(e, msg.id);

    const avatarUrl = isMe ? avatars.my : avatars.bot;
    const frameUrl = isMe ? s.myFrame : s.botFrame;
    let avatarHtml = `<div class="msg-avatar" style="background-image:url(${avatarUrl || ''})" ondblclick="handleNudge(${isMe})">`;
    if(frameUrl) avatarHtml += `<img class="avatar-frame" src="${frameUrl}">`;
    avatarHtml += `</div>`;
    const now = new Date(msg.timestamp || Date.now());
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    const timeStr = `${h}:${m}`;
    let bubbleContent = '';
    if(msg.quote) {
             let qText = msg.quote.text;
        if(qText.startsWith('data:image')) qText = '[ÂõæÁâá]';
        else if(qText.startsWith('data:audio')) qText = '[ËØ≠Èü≥]'; // È°∫‰æøÊîØÊåÅÂºïÁî®ËØ≠Èü≥ÊòæÁ§∫
        bubbleContent += `<div class="msg-quote-block"><span class="msg-quote-user">${msg.quote.user}:</span><span>${qText}</span></div>`;
    }
    
    if(msg.type === 'image') {
        bubbleContent += `<img src="${msg.text}" class="msg-image">`;
    } 
    // üî• ‰øÆÊîπÁÇπÔºöÂ¢ûÂä† audio Á±ªÂûãÂà§Êñ≠ üëá
    else if(msg.type === 'audio') {
        bubbleContent += `
            <div class="audio-bubble" onclick="playAudioMsg(this, '${msg.text}')">
                <span class="audio-icon">üçè</span>
                <span>ËØ≠Èü≥Ê∂àÊÅØ</span>
            </div>
        `;
    
    } else {
        bubbleContent += `<span>${msg.text}</span>`;
    }
    bubbleContent += `<span class="msg-time">${timeStr}</span>`;

    const bubbleHtml = `<div class="msg-bubble" ondblclick="triggerQuote('${msg.text ? msg.text.replace(/'/g, "\\'") : ''}', ${isMe})">${bubbleContent}</div>`;

    if (isMe) {
        row.innerHTML = bubbleHtml + avatarHtml;
        row.prepend(checkbox);
    } else {
        row.innerHTML = avatarHtml + bubbleHtml;
        row.prepend(checkbox);
    }

    if(returnElementOnly) return row;
    history.appendChild(row);
}
async function openChatApp() {

    loadSettingsToUI();
    await applyChatSettings(); 
    
    chatDisplayLimit = 20; 

    await renderChatHistory();
    const modal = document.getElementById('chat-modal');
    modal.style.display = 'flex';
    const history = document.getElementById('chat-history');
    requestAnimationFrame(() => {
        history.scrollTop = history.scrollHeight;
    });
}

        function handleNudge(isMeClicked) {
            const s = getChatSettings();
            const targetName = isMeClicked ? "Ëá™Â∑±" : (s.title || "ÂØπÊñπ");
            const states = s.nudgeList.split('\n').map(l=>l.trim()).filter(l=>l);
            const randomState = states.length > 0 ? states[Math.floor(Math.random() * states.length)] : "ÂèëÂëÜ";
            appendMessage(`‰Ω†Êãç‰∫ÜÊãç ${targetName} ${targetName}Ê≠£Âú®${randomState}`, false, 'system');
        }

        function sendUserMessage() {
            const input = document.getElementById('chat-input-text');
            const text = input.value.trim();
            if(!text) return;
            appendMessage(text, true, 'text', currentQuoteData); 
            input.value = '';
            cancelQuote(); 
            triggerBotReply(); 
        }
function handleChatImageUpload(input) {
    const file = input.files[0];
    if(file) {
        // ‰øÆÊîπÔºö‰ΩøÁî®ÂéãÁº©ÂáΩÊï∞
        compressImage(file, (base64) => {
            appendMessage(base64, true, 'image');
            triggerBotReply();
        });
    }
    input.value = ''; 
}
        let isStickerDeleteMode = false;
        async function getStickers() { 
            const list = await idb.getAll('chat_stickers');
            return list.map(item => item.data); 
        }
        
        async function toggleStickers() {
            const modal = document.getElementById('sticker-modal');
            if(modal.style.display === 'none') {
                modal.style.display = 'flex';
                await renderStickers();
            } else {
                modal.style.display = 'none';
                isStickerDeleteMode = false; 
            }
        }
        
        async function renderStickers() {
            const grid = document.getElementById('sticker-grid-container');
            const btn = document.getElementById('toggle-del-btn');
            grid.innerHTML = '';
            
            if(isStickerDeleteMode) {
                grid.classList.add('delete-mode');
                btn.style.background = '#ffcccc'; btn.innerText = "ÂÆåÊàêÂà†Èô§";
            } else {
                grid.classList.remove('delete-mode');
                btn.style.background = '#e8d7d7'; btn.innerText = "üóëÔ∏è Âà†Èô§Ê®°Âºè";
            }

            const rawList = await idb.getAll('chat_stickers'); 
            rawList.forEach((item) => {
                const wrap = document.createElement('div');
                wrap.className = 'sticker-item-wrap';
                const img = document.createElement('img');
                img.src = item.data; img.className = 'sticker-img';
                const del = document.createElement('div');
                del.className = 'sticker-del-btn';
                del.innerText = '√ó';
                del.onclick = (e) => { e.stopPropagation(); deleteSticker(item.id); };

                img.onclick = () => {
                    if(isStickerDeleteMode) return; 
                    appendMessage(item.data, true, 'image');
                    document.getElementById('sticker-modal').style.display='none';
                    triggerBotReply();
                };
                wrap.appendChild(img);
                wrap.appendChild(del);
                grid.appendChild(wrap);
            });
        }

        async function handleStickerUpload(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            const uploadTasks = files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        idb.put('chat_stickers', { data: e.target.result }).then(() => resolve());
                    };
                    reader.readAsDataURL(file);
                });
            });
            await Promise.all(uploadTasks);
            await renderStickers();
            input.value = ''; 
        }

        function toggleStickerDeleteMode() { isStickerDeleteMode = !isStickerDeleteMode; renderStickers(); }
        async function deleteSticker(key) { await idb.delete('chat_stickers', key); renderStickers(); }
        async function triggerBotReply() {
            const s = getChatSettings();
            const delay = Math.floor(Math.random() * (s.delayMax - s.delayMin + 1) + s.delayMin) * 1000;
            
            setTimeout(async () => {
                let count = Math.floor(Math.random() * (s.countMax - s.countMin + 1) + s.countMin);
                if(count < 1) count = 1;
                
                const texts = getThesaurusData()['reply'] || [];
                const stickers = await getStickers();
                
                let botQuote = null;
                if (Math.random() < 0.2) {
                    const allMsgs = await idb.getAll('chat_history');
                    const validMsgs = allMsgs.filter(m => m.type !== 'system' && m.text);
                    if(validMsgs.length > 0) {
                        const randomIndex = Math.floor(Math.random() * validMsgs.length);
                        const targetMsg = validMsgs[randomIndex];
                        botQuote = {
                            text: targetMsg.text,
                            user: targetMsg.isMe ? "Êàë" : (s.title || "ÂØπÊñπ")
                        };
                    }
                }
                
                if(texts.length === 0 && stickers.length === 0) {
                    appendMessage("[Ëá™Âä®ÂõûÂ§ç] ËØçÂ∫ìÂíåË°®ÊÉÖÂåÖÂùá‰∏∫Á©∫", false);
                    return;
                }

                let sent = 0;
                const sendInterval = setInterval(() => {
                    if(sent >= count) { clearInterval(sendInterval); return; }
                    const thisQuote = (sent === 0) ? botQuote : null;
                    const useSticker = (stickers.length > 0) && (Math.random() < 0.3);
                    
                    if (useSticker) {
                        const randomSticker = stickers[Math.floor(Math.random() * stickers.length)];
                        appendMessage(randomSticker, false, 'image', thisQuote);
                        NotificationManager.send({
                            title: (getChatSettings().title || "ÂØπÊñπ") + " ÂèëÊù•‰∏ÄÂº†ÂõæÁâá",
                            body: "[ÂõæÁâá] ÁÇπÂáªÊü•Áúã",
                            icon: "üñºÔ∏è",
                            onClick: () => openChatApp()
                        });

                    // Âú® triggerBotReply ÂáΩÊï∞ÂÜÖÈÉ®...
                    } else if (texts.length > 0) {
                        let randomText = texts[Math.floor(Math.random() * texts.length)];
                        
                        // üî¥üî¥üî¥ ‰øÆÊîπÔºö‰ΩøÁî®Ëá™ÂÆö‰πâÊ¶ÇÁéá üî¥üî¥üî¥
                        // ËØªÂèñËÆæÁΩÆÔºåÂ¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂàôÈªòËÆ§ 0.6
                        const currentProb = s.kaomojiProb !== undefined ? s.kaomojiProb : 0.6;
                        
                        if (Math.random() < currentProb) {
                            const kaomojiRaw = getChatSettings().kaomojiList || "";
                            const kaomojiArr = kaomojiRaw.split('\n').filter(k => k.trim() !== "");
                            if (kaomojiArr.length > 0) {
                                const randomEmoji = kaomojiArr[Math.floor(Math.random() * kaomojiArr.length)];
                                randomText += " " + randomEmoji;
                            }
                        }              
                        appendMessage(randomText, false, 'text', thisQuote);
                        
                        NotificationManager.send({
                            title: getChatSettings().title || "ÂØπÊñπ",
                            body: randomText, 
                            icon: "üí¨",
                            onClick: () => openChatApp()
                        });

                    } else {
l                       
                         const randomSticker = stickers[Math.floor(Math.random() * stickers.length)];
                         appendMessage(randomSticker, false, 'image', thisQuote);
                         NotificationManager.send({
                            title: "Êñ∞Ê∂àÊÅØ",
                            body: "Êî∂Âà∞‰∏ÄÊù°Êñ∞Ê∂àÊÅØ",
                            onClick: () => openChatApp()
                        });
                    }
                                        sent++;
                }, 1000); 
            }, delay); 
        } 
function getThesaurusData() { 
    // Á°Æ‰øù fallback Âà∞Á©∫ÂØπË±°ÁªìÊûÑ
    return window.BIG_MEMORY.thesaurus_data || {reply:[], note:[], expense:[], income:[]}; 
}

function saveThesaurusData(data) { 
    window.BIG_MEMORY.thesaurus_data = data;
    // Âº∫Âà∂ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
    if(typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'thesaurus_data', data: data });
    }
}
        function openThesaurus() { document.getElementById('thesaurus-modal').style.display = 'flex'; renderThesaurusList(); }
        function closeThesaurus() { document.getElementById('thesaurus-modal').style.display = 'none'; }
        function switchThesaurusTab(tab) { currentThesaurusTab = tab; thesaurusCats.forEach(t => document.getElementById(`tab-${t}`).classList.toggle('active', t===tab)); renderThesaurusList(); }
        function renderThesaurusList() {
            const listEl = document.getElementById('thesaurus-list'); listEl.innerHTML = '';
            (getThesaurusData()[currentThesaurusTab] || []).forEach((text, index) => {
                listEl.innerHTML += `<div class="word-item"><span class="word-text">${text}</span><span style="color:red;cursor:pointer" onclick="deleteWord(${index})">√ó</span></div>`;
            });
        }
        function addWord() { const val = prompt("ËæìÂÖ•ÂÜÖÂÆπ:"); if(val) { const d = getThesaurusData(); d[currentThesaurusTab].push(val); saveThesaurusData(d); renderThesaurusList(); } }
        function deleteWord(idx) { if(confirm("Âà†Èô§?")) { const d = getThesaurusData(); d[currentThesaurusTab].splice(idx,1); saveThesaurusData(d); renderThesaurusList(); } }
        function exportWords() {
            const blob = new Blob([getThesaurusData()[currentThesaurusTab].join('\n')], {type: "text/plain;charset=utf-8"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ËØçÂ∫ì_${currentThesaurusTab}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function importWords() {
            const input = document.getElementById('txt-import-input');
            input.onchange = (e) => {
                const r = new FileReader();
                r.onload = (ev) => { 
                    const lines = ev.target.result.split(/\r?\n/).map(l=>l.trim()).filter(l=>l); 
                    const d = getThesaurusData(); 
                    if(!d[currentThesaurusTab]) d[currentThesaurusTab] = [];
                    d[currentThesaurusTab] = d[currentThesaurusTab].concat(lines); 
                    saveThesaurusData(d); renderThesaurusList(); 
                };
                r.readAsText(e.target.files[0]);
            }; input.click();
        }
// üîç ÊâæÂà∞Ëøô‰∏ÄË°å
const wbCategories = ["1.ÂÖ®Â±Ä", "2.Â∞èÂâßÂú∫", "3.Â°îÁΩóÁâå", "4.Èõ∑ËØ∫Êõº", "5.‰º†ËÆØ", "6.Êä•Á∫∏", "7.ËÆ∫Âùõ‰Ωì", "8.Êç°ÊâãÊú∫ÊñáÂ≠¶", "9.ÂÜ∞ÁÆ±", "10.ÂÅáÂ¶Ç‰Ω†ÊòØtaÁöÑÊ¢¶Ëßí", "11.Êç°Âà∞taÁöÑÊâãÊú∫", "12.Â≠¶‰π†ËÆ°Âàí", "13.‰ø°‰ª∂", "14.Êó•ËÆ∞", "15.ÂÖ≠Áàª", "16.Ê¢ÖËä±", "17.ËÄÅÁ¶èÁâπ", "18.ÂÆ†Áâ©", "19.ÊóÆÊóØgame", "20.ÂÉèÁ¥†Â∞èÂ±ã"];
        let currentCategory = wbCategories[0]; let editingIndex = -1;
        function getWBData() { 
    return window.BIG_MEMORY.world_book || {}; 
}

function saveWBData(data) { 
    window.BIG_MEMORY.world_book = data;
    if(typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'world_book', data: data });
    }
}
function getWBData() { 
    return window.BIG_MEMORY.world_book || {}; 
}

function saveWBData(data) { 
    window.BIG_MEMORY.world_book = data;
    if(typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'world_book', data: data });
    }
}
           function openWorldBook() {
            document.getElementById('wb-modal').style.display = 'flex';
            const sb = document.getElementById('wb-sidebar'); sb.innerHTML = '';
            wbCategories.forEach(cat => {
                const el = document.createElement('div'); el.className = `wb-category ${cat === currentCategory ? 'active' : ''}`;
                el.innerText = cat; el.onclick = () => { currentCategory = cat; openWorldBook(); }; sb.appendChild(el);
            });
            renderWBCategory(currentCategory);
        }
        function closeWorldBook() { document.getElementById('wb-modal').style.display = 'none'; }
        function renderWBCategory(cat) {
            const list = document.getElementById('wb-list'); list.innerHTML = '';
            (getWBData()[cat] || []).forEach((entry, index) => {
                const div = document.createElement('div'); div.className = 'wb-entry';
                div.onclick = (e) => { if(e.target.type!=='checkbox' && !e.target.innerText.includes('√ó')) openEntryEditor(index); };
                div.innerHTML = `<input type="checkbox" class="wb-checkbox" ${entry.enabled!==false?'checked':''} onclick="toggleEntry('${cat}',${index})"><div class="wb-entry-info"><div style="font-weight:bold">${entry.title||'Êó†Ê†áÈ¢ò'}</div><div style="font-size:0.8rem;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${entry.content||''}</div></div><button style="border:none;background:none;color:#e5b9b9;font-size:1.2rem" onclick="deleteEntry('${cat}',${index})">√ó</button>`;
                list.appendChild(div);
            });
        }
        function addEntry() { const d = getWBData(); if(!d[currentCategory]) d[currentCategory]=[]; d[currentCategory].push({title:"Êñ∞Êù°ÁõÆ", content:"", enabled:true}); saveWBData(d); renderWBCategory(currentCategory); openEntryEditor(d[currentCategory].length-1); }
        function toggleEntry(c,i) { const d=getWBData(); if(d[c][i]) d[c][i].enabled=!d[c][i].enabled; saveWBData(d); }
        function deleteEntry(c,i) { if(confirm("Âà†Èô§?")){ const d=getWBData(); d[c].splice(i,1); saveWBData(d); renderWBCategory(c); } }
        function openEntryEditor(i) { editingIndex = i; const entry = getWBData()[currentCategory][i]; document.getElementById('edit-title').value = entry.title || ""; document.getElementById('edit-content').value = entry.content || ""; document.getElementById('wb-editor-overlay').style.display = 'flex'; }
        function closeEntryEditor() { document.getElementById('wb-editor-overlay').style.display = 'none'; editingIndex=-1; }
        function saveEntryEditor() { if(editingIndex===-1) return; const d = getWBData(); d[currentCategory][editingIndex].title = document.getElementById('edit-title').value; d[currentCategory][editingIndex].content = document.getElementById('edit-content').value; saveWBData(d); renderWBCategory(currentCategory); closeEntryEditor(); }
function exportCategory() {
    const btn = event.target; 
    let allData = {};
    if (window.BIG_MEMORY && window.BIG_MEMORY.world_book) {
        allData = window.BIG_MEMORY.world_book;
    } else {
        allData = JSON.parse(localStorage.getItem('world_book_data') || '{}');
    }

    if (!currentCategory) currentCategory = "1.ÂÖ®Â±Ä";
    const data = allData[currentCategory] || [];
    
    if (data.length === 0) {
        return alert(`‚ùå ÂàÜÁ±ª„Äê${currentCategory}„Äë‰∏≠Ê≤°ÊúâÊï∞ÊçÆ„ÄÇ`);
    }

    let textContent = `=== RetroOS World Book: ${currentCategory} ===\n\n`;
    data.forEach((item, index) => {
        if (item) {
            const title = item.title || "Êó†Ê†áÈ¢ò";
            const content = item.content || "";
            const status = item.enabled ? "" : "[Â∑≤Á¶ÅÁî®]";
            textContent += `----------------------------------------\r\n`;
            textContent += `üìù #${index + 1} ${title} ${status}\r\n`;
            textContent += `----------------------------------------\r\n`;
            textContent += `${content.replace(/\n/g, '\r\n')}\r\n\r\n\r\n`;
        }
    });
    const blob = new Blob(['\uFEFF' + textContent], { type: "text/plain;charset=utf-8" });
    const fileName = `WorldBook_${currentCategory}_${Date.now()}.txt`;
    const file = new File([blob], fileName, { type: "text/plain" });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
            files: [file],
            title: '‰∏ñÁïå‰π¶ÂØºÂá∫',
            text: `ÂàÜÁ±ªÔºö${currentCategory}`
        }).catch(e => console.log("ÂàÜ‰∫´ÂèñÊ∂à"));
    } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
}

        function importAny() {
            const input = document.getElementById('any-import-input'); input.value='';
            input.onchange = (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    const res = evt.target.result; const d = getWBData(); if(!d[currentCategory]) d[currentCategory]=[];
                    if(file.name.endsWith('.txt')) d[currentCategory].push({title:file.name, content:res, enabled:true});
                    else try { 
                        const j = JSON.parse(res); 
                        const arr = Array.isArray(j) ? j : (j.entries || Object.values(j).filter(v=>typeof v==='object'));
                        const valid = arr.map(i=>({title:i.title||i.key||"ÂØºÂÖ•", content:i.content||i.value||"", enabled:true})).filter(i=>i.content);
                        if(valid.length) d[currentCategory] = d[currentCategory].concat(valid);
                    } catch(e){ alert("Ëß£ÊûêÂ§±Ë¥•"); }
                    saveWBData(d); renderWBCategory(currentCategory);
                }; r.readAsText(file);
            }; input.click();
        }
        let currentCity = "Unknown Location"; 
// === üåç ÂÆö‰ΩçÁ≥ªÁªü (Ëá™Âä®ËÆ∞ÂøÜÁâà) ===
function initRealWeather(forceRefresh = false) {
    const descEl = document.getElementById('real-desc');
    const tempEl = document.getElementById('real-temp');
    
    // 1. Â∞ùËØïËØªÂèñ‰∏äÊ¨°‰øùÂ≠òÁöÑÂÆö‰Ωç
    if (!forceRefresh) {
        const savedCity = localStorage.getItem('geo_city');
        const savedTemp = localStorage.getItem('geo_temp');
        if (savedCity && savedTemp) {
            descEl.innerText = savedCity;
            tempEl.innerText = savedTemp;
            window.currentCity = savedCity;
            console.log("üìç Â∑≤Ëá™Âä®Âä†ËΩΩ‰∏äÊ¨°ÂÆö‰Ωç:", savedCity);
            return;
        }
    }

    // 2. Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÔºåÊàñÂº∫Âà∂Âà∑Êñ∞ÔºåÂàôËØ∑Ê±ÇÂÆö‰Ωç
    descEl.innerText = "ÂÆö‰Ωç‰∏≠...";

    if (!navigator.geolocation) return alert("ÊµèËßàÂô®‰∏çÊîØÊåÅÂÆö‰Ωç");

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            // Ëé∑ÂèñÂú∞Âêç
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(res => res.json())
                .then(data => {
                    const addr = data.address;
                    // ‰ºòÂÖàÂèñÂüéÂ∏ÇÔºåÊ≤°ÊúâÂàôÂèñÂå∫Âéø
                    const city = addr.city || addr.town || addr.district || "Êú¨Âú∞";
                    
                    // Ëé∑ÂèñÂ§©Ê∞î
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
                        .then(r => r.json())
                        .then(wData => {
                            const temp = Math.round(wData.current_weather.temperature) + "¬∞";
                            
                            // Êõ¥Êñ∞ UI
                            descEl.innerText = city;
                            tempEl.innerText = temp;
                            window.currentCity = city;
                            
                            // üî• Ê†∏ÂøÉÔºö‰øùÂ≠òÂà∞Êú¨Âú∞Ôºå‰∏ãÊ¨°Ëá™Âä®Âä†ËΩΩ
                            localStorage.setItem('geo_city', city);
                            localStorage.setItem('geo_temp', temp);
                        });
                })
                .catch(() => { descEl.innerText = "ÂÆö‰ΩçË∂ÖÊó∂"; });
        }, 
        (err) => {
            // Â§±Ë¥•Êó∂ÂÖÅËÆ∏ÊâãÂä®ËæìÂÖ•
            const input = prompt("ÂÆö‰ΩçÂ§±Ë¥• (ÂèØËÉΩÈúÄhttps)„ÄÇ\nËØ∑ËæìÂÖ•ÂüéÂ∏ÇÊãºÈü≥ (Â¶Ç Beijing):", window.currentCity || "");
            if(input) {
                descEl.innerText = input;
                tempEl.innerText = "20¬∞"; 
                window.currentCity = input;
                localStorage.setItem('geo_city', input);
                localStorage.setItem('geo_temp', "20¬∞");
            } else {
                descEl.innerText = "ÁÇπÂáªËÆæÁΩÆ";
            }
        },
        { enableHighAccuracy: false, timeout: 5000 }
    );
}

// Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÁöÑÈÇ£‰∏™ addEventListener('load', ...) ÈáåÔºåÊ∑ªÂä†‰∏ÄË°åÔºö
// initRealWeather(); 
function openSettings() {
    const modal = document.getElementById('settings-modal');
    if(modal) modal.style.display = 'flex';
    try {
        const draft = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        if(draft.url) document.getElementById('api-url').value = draft.url;
        if(draft.key) document.getElementById('api-key').value = draft.key;
        if(draft.temp) {
            document.getElementById('api-temp').value = draft.temp;
            document.getElementById('temp-display').innerText = draft.temp;
        }
        if(draft.model) {
             const sel = document.getElementById('model-select');
             
             if (sel.options.length <= 1) {
                 const opt = document.createElement('option');
                 opt.value = draft.model;
                 opt.innerText = draft.model;
                 opt.selected = true;
                 sel.appendChild(opt);
             }
             sel.value = draft.model;
        }
    } catch(e) { console.log("ËÆæÁΩÆËçâÁ®øÂä†ËΩΩÂ§±Ë¥•", e); }
    if(typeof renderProfiles === 'function') {
        renderProfiles();
    }
}

function closeSettings() {
    document.getElementById('settings-modal').style.display = 'none';
}
function autoSaveApiSettings() {
    const data = {
        url: document.getElementById('api-url').value,
        key: document.getElementById('api-key').value,
        model: document.getElementById('model-select').value,
        temp: document.getElementById('api-temp').value
    };
    localStorage.setItem('api_settings_draft', JSON.stringify(data));
}
function getProfiles() {
    try {
        const raw = localStorage.getItem('api_profiles');
        if (!raw) return [];
        
        const data = JSON.parse(raw);
        if (Array.isArray(data)) {
            
            const validData = data.filter(item => item && typeof item === 'object' && item.name);
                        
            if (validData.length !== data.length) {
                console.log("Ê£ÄÊµãÂà∞Âπ∂Ê∏ÖÁêÜ‰∫ÜÊçüÂùèÁöÑÈÖçÁΩÆÊï∞ÊçÆ");
                saveProfiles(validData);
            }
            return validData;
        }               
        if (typeof data === 'object' && data !== null) {
            const fixed = [data];
            saveProfiles(fixed);
            return fixed;
        }
        
        return []; 
    } catch (e) {
        console.error("ËØªÂèñÈÖçÁΩÆÂá∫ÈîôÔºåÂ∑≤ÈáçÁΩÆ", e);
        return [];
    }
}
function saveProfiles(data) {
    try {
        localStorage.setItem('api_profiles', JSON.stringify(data));
    } catch (e) {
        alert("‚ùå ‰øùÂ≠òÂ§±Ë¥•ÔºöÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÊàñË¢´Á¶ÅÁî®");
    }
}
function renderProfiles() {
    const list = document.getElementById('profile-list');
    if (!list) return;
    
    list.innerHTML = '';
    const profiles = getProfiles(); 

    if (profiles.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#999;font-size:0.8rem;padding:15px;">ÊöÇÊó†‰øùÂ≠òÁöÑÊñπÊ°à<br>ËØ∑Âú®‰∏äÊñπÈÖçÁΩÆÂêéÁÇπÂáª"Âè¶Â≠ò‰∏∫"</div>';
        return;
    }

    profiles.forEach((p, index) => {
        if (!p || !p.name) return; // ‰∫åÊ¨°‰øùÈô©

        const div = document.createElement('div');
        div.className = 'profile-item';
        // Âº∫Âà∂Ê†∑ÂºèÁ°Æ‰øùÊòæÁ§∫Ê≠£Â∏∏
        div.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee; background:#fff; margin-bottom:8px; border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);";
        
        div.innerHTML = `
            <div onclick="loadProfile(${index})" style="cursor:pointer; flex:1; display:flex; flex-direction:column;">
                <span style="font-weight:bold; color:#333; font-size:0.95rem;">${p.name}</span>
                <span style="font-size:0.75rem; color:#999;">${p.model || 'Default'} ¬∑ temp:${p.temp || 0.7}</span>
            </div>
            <div onclick="deleteProfile(${index})" style="color:#ff4444; cursor:pointer; padding:5px 10px; font-size:1.2rem; display:flex; align-items:center;">√ó</div>
        `;
        list.appendChild(div);
    });
}
function saveCurrentProfile() {
    const url = document.getElementById('api-url').value.trim();
    const key = document.getElementById('api-key').value.trim();
    const model = document.getElementById('model-select').value;
    const temp = document.getElementById('api-temp').value;

    if(!url || !key) return alert("‚ùå ËØ∑ÂÖàÂ°´ÂÜô API Âú∞ÂùÄÂíå Key");
    const timeStr = new Date().toTimeString().split(' ')[0]; // HH:MM:SS
    const defaultName = "ÈÖçÁΩÆ " + timeStr;
    
    let name = prompt("ÁªôÊñπÊ°àËµ∑‰∏™ÂêçÂ≠ó:", defaultName);
    if (!name) return; 
    name = name.trim();

    const profiles = getProfiles();
    
    const idx = profiles.findIndex(p => p.name === name);
    
    if (idx !== -1) {
        if(!confirm(`ÊñπÊ°à„Äê${name}„ÄëÂ∑≤Â≠òÂú®ÔºåË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`)) return;
        profiles[idx] = { name, url, key, model, temp };
    } else {
        profiles.push({ name, url, key, model, temp });
    }
    
    saveProfiles(profiles);
    renderProfiles(); 
    const btn = document.querySelector('button[onclick="saveCurrentProfile()"]');
    if(btn) {
        const oldText = btn.innerText;
        btn.innerText = "‚úÖ Â∑≤‰øùÂ≠ò";
        setTimeout(() => btn.innerText = oldText, 1500);
    }
}
function deleteProfile(i) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ÊñπÊ°àÂêóÔºü")) return;
    const p = getProfiles();
    p.splice(i, 1);
    saveProfiles(p);
    renderProfiles();
}
function loadProfile(i) {
    const profiles = getProfiles();
    if (!profiles[i]) return;
    
    const p = profiles[i];
    document.getElementById('api-url').value = p.url || '';
    document.getElementById('api-key').value = p.key || '';
    document.getElementById('api-temp').value = p.temp || 0.7;
    document.getElementById('temp-display').innerText = p.temp || 0.7;
    
    autoSaveApiSettings();
    
    const sel = document.getElementById('model-select');
    if(p.model) {
        let exists = false;
        for(let k=0; k<sel.options.length; k++) {
            if(sel.options[k].value === p.model) { exists = true; break; }
        }
        if(!exists) {
            const opt = document.createElement('option');
            opt.value = p.model;
            opt.innerText = p.model;
            sel.appendChild(opt);
        }
        sel.value = p.model;
    }
    
    alert(`‚ö° Â∑≤Â∫îÁî®ÊñπÊ°àÔºö${p.name}`);
}  
        async function fetchModels() {
            try {
                const url = document.getElementById('api-url').value; const key = document.getElementById('api-key').value;
                const res = await fetch(`${url.replace(/\/$/, "")}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
                const data = await res.json();
                const models = (data.data || data).map(i => i.id || i);
                const sel = document.getElementById('model-select'); sel.innerHTML = '';
                models.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
                alert(`Âä†ËΩΩ ${models.length} ‰∏™Ê®°Âûã`);
            } catch(e) { alert("Ëé∑ÂèñÂ§±Ë¥•"); }
        }
        function handleLongPressStart(id) {
            if(longPressTimer) clearTimeout(longPressTimer);
            longPressTimer = setTimeout(() => { enterDeleteMode(id); }, 800); 
        }
        function handleLongPressEnd() { if(longPressTimer) clearTimeout(longPressTimer); }

        function enterDeleteMode(initialId) {
            if(isDeleteMode) return; 
            isDeleteMode = true;
            selectedDeleteIds.clear();
            if(initialId) selectedDeleteIds.add(initialId); 
            
            document.getElementById('normal-footer-content').style.display = 'none';
            document.getElementById('delete-footer-content').style.display = 'flex';
            document.getElementById('chat-history').classList.add('delete-mode');
            renderChatHistory();
            updateDeleteCount();
        }

        function quitDeleteMode() {
            isDeleteMode = false;
            selectedDeleteIds.clear();
            document.getElementById('normal-footer-content').style.display = 'flex';
            document.getElementById('delete-footer-content').style.display = 'none';
            document.getElementById('chat-history').classList.remove('delete-mode');
            renderChatHistory(); 
        }

        function toggleSelectMessage(e, id) {
            if(e.target.checked) selectedDeleteIds.add(id);
            else selectedDeleteIds.delete(id);
            updateDeleteCount();
        }

        function updateDeleteCount() { document.getElementById('delete-count-text').innerText = `Â∑≤ÈÄâ ${selectedDeleteIds.size} Êù°`; }

        async function confirmDeleteMessages() {
            if(selectedDeleteIds.size === 0) return;
            if(!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedDeleteIds.size} Êù°Ê∂àÊÅØÂêóÔºü`)) return;
            const tx = idb.db.transaction(['chat_history'], "readwrite");
            const store = tx.objectStore('chat_history');
            selectedDeleteIds.forEach(id => { store.delete(id); });
            tx.oncomplete = () => { quitDeleteMode(); };
        }
function openNewspaper() {
    const modal = document.getElementById('newspaper-modal');
    const now = new Date();
    document.getElementById('news-date-display').innerText = `DATE: ${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    const texts = getThesaurusData()['note'] || ["Ê≤°Êúâ‰ªÄ‰πàÊñ∞È≤ú‰∫ãÂèëÁîü„ÄÇ", "Â§©Ê∞î‰∏çÈîôÔºåÈÄÇÂêàÂÜô‰ª£Á†Å„ÄÇ"];
    const randomText = texts[Math.floor(Math.random() * texts.length)] || "Loading...";
    
    document.getElementById('news-full-text').innerHTML = `
        <span style="font-size:2rem; float:left; line-height:0.8; padding-right:5px; font-weight:bold;">T</span>
        oday's Report:<br><br>${randomText}<br><br>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
    `;
    const tvImg = document.getElementById('tv-content').src;
    const newsImg = document.getElementById('news-full-img');
    if(tvImg && tvImg.length > 100) {
        newsImg.src = tvImg;
        newsImg.style.display = 'block';
    }
    
    modal.style.display = 'flex';
}

let canvas, ctx;
let editorState = {
    bgImage: null,      
    frameImage: null,  
    frameMode: 'black', // Ê®°Âºè: black, polaroid, custom, none
    stickers: [],       
    selectedSticker: -1 
};
let touchState = {
    isDragging: false,
    isPinching: false,
    startX: 0,
    startY: 0,
    startDist: 0,
    startAngle: 0,
    initialScale: 1,
    initialRotation: 0
};
function initCamera() {
    canvas = document.getElementById('editor-canvas');
    ctx = canvas.getContext('2d');
    canvas.width = 1080;
    canvas.height = 1080;
canvas.addEventListener('mousedown', handleInputStart);
    canvas.addEventListener('mousemove', handleInputMove);
    canvas.addEventListener('mouseup', handleInputEnd);
    canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
    canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
    canvas.addEventListener('touchend', handleInputEnd);
    
    document.getElementById('frame-select').value = 'black';
    editorState.frameMode = 'black';

    drawCanvas(); 
}
function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (editorState.bgImage) {
        drawImageCover(ctx, editorState.bgImage, canvas.width, canvas.height);
    } else {
        ctx.fillStyle = "#1a1a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#666";
        ctx.font = "40px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("ÁÇπÂáª [Â∫ïÂõæ] ‰∏ä‰º†ÁÖßÁâá", canvas.width/2, canvas.height/2);
    }
    editorState.stickers.forEach((s, index) => {
        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rotation * Math.PI / 180); 
        ctx.scale(s.scale, s.scale);
        ctx.drawImage(s.img, -s.img.width/2, -s.img.height/2);
        if (index === editorState.selectedSticker) {
            ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
            ctx.lineWidth = 5 / s.scale; 
            ctx.setLineDash([15, 10]);
            ctx.strokeRect(-s.img.width/2, -s.img.height/2, s.img.width, s.img.height);
 
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.arc(0, 0, 5/s.scale, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    });
    drawFrameLayer();
    document.getElementById('sticker-ops').style.display = (editorState.selectedSticker !== -1) ? 'flex' : 'none';
}
function drawFrameLayer() {
    const mode = editorState.frameMode;
    const w = canvas.width;
    const h = canvas.height;

    if (mode === 'none') return;

    if (mode === 'black') {
        const border = 60;
        ctx.lineWidth = border;
        ctx.strokeStyle = "#000000";
        ctx.strokeRect(0, 0, w, h);
    } 
    else if (mode === 'polaroid') {
        const pad = 50;
        const bottom = 220;
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, w, pad); // Top
        ctx.fillRect(0, 0, pad, h); // Left
        ctx.fillRect(w - pad, 0, pad, h); // Right
        ctx.fillRect(0, h - bottom, w, bottom); // Bottom
        ctx.fillStyle = "#333";
        ctx.font = "40px 'Courier New'";
        ctx.textAlign = "center";
        ctx.fillText("Retro OS", w/2, h - 90);
    } 
    else if (mode === 'custom' && editorState.frameImage) {
ctx.drawImage(editorState.frameImage, 0, 0, w, h);
    }
}
function getDist(t1, t2) {
    return Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
}
function getAngle(t1, t2) {
    return Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX) * 180 / Math.PI;
}

function handleTouchStart(e) {
    e.preventDefault();
    if (e.touches.length === 2 && editorState.selectedSticker !== -1) {
        touchState.isPinching = true;
        touchState.startDist = getDist(e.touches[0], e.touches[1]);
        touchState.startAngle = getAngle(e.touches[0], e.touches[1]);
        
        const s = editorState.stickers[editorState.selectedSticker];
        touchState.initialScale = s.scale;
        touchState.initialRotation = s.rotation;
    } else if (e.touches.length === 1) {
        checkSelection(e.touches[0]);
        if (editorState.selectedSticker !== -1) {
            touchState.isDragging = true;
            const pos = getPos(e.touches[0]);
            touchState.startX = pos.x;
            touchState.startY = pos.y;
        }
    }
    drawCanvas();
}

function handleTouchMove(e) {
    e.preventDefault();
    const s = editorState.stickers[editorState.selectedSticker];
    if (!s) return;

    if (touchState.isPinching && e.touches.length === 2) {
        const currentDist = getDist(e.touches[0], e.touches[1]);
        const currentAngle = getAngle(e.touches[0], e.touches[1]);
        const scaleFactor = currentDist / touchState.startDist;
        s.scale = touchState.initialScale * scaleFactor;
        const rotationDiff = currentAngle - touchState.startAngle;
        s.rotation = touchState.initialRotation + rotationDiff;

        drawCanvas();
    } else if (touchState.isDragging && e.touches.length === 1) {
        const pos = getPos(e.touches[0]);
        s.x += pos.x - touchState.startX;
        s.y += pos.y - touchState.startY;
        touchState.startX = pos.x;
        touchState.startY = pos.y;
        drawCanvas();
    }
}
function handleInputStart(e) {
    checkSelection(e);
    if (editorState.selectedSticker !== -1) {
        touchState.isDragging = true;
        const pos = getPos(e);
        touchState.startX = pos.x;
        touchState.startY = pos.y;
        drawCanvas();
    }
}
function handleInputMove(e) {
    if (!touchState.isDragging || editorState.selectedSticker === -1) return;
    const pos = getPos(e);
    const s = editorState.stickers[editorState.selectedSticker];
    s.x += pos.x - touchState.startX;
    s.y += pos.y - touchState.startY;
    touchState.startX = pos.x;
    touchState.startY = pos.y;
    drawCanvas();
}
function handleInputEnd(e) {
    touchState.isDragging = false;
    touchState.isPinching = false;
}
function checkSelection(inputObj) {
    const pos = getPos(inputObj);
    for (let i = editorState.stickers.length - 1; i >= 0; i--) {
        const s = editorState.stickers[i];
        const hitRadius = (Math.max(s.img.width, s.img.height) * s.scale) / 2;
        if (Math.abs(pos.x - s.x) < hitRadius && Math.abs(pos.y - s.y) < hitRadius) {
            editorState.selectedSticker = i;
            return;
        }
    }
    editorState.selectedSticker = -1;
}

function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    return {
        x: (evt.clientX - rect.left) * (canvas.width / rect.width),
        y: (evt.clientY - rect.top) * (canvas.height / rect.height)
    };
}
function handleFrameChange(mode) {
    if (mode === 'custom') {
        document.getElementById('upload-frame-custom').click();
    } else {
        editorState.frameMode = mode;
        drawCanvas();
    }
}
function handleCustomFrameUpload(input) {
    const file = input.files[0];
    if (!file) { document.getElementById('frame-select').value = 'none'; return; }
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            editorState.frameImage = img;
            editorState.frameMode = 'custom';
            drawCanvas();
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = '';
}
function controlSticker(action, val) {
    const idx = editorState.selectedSticker;
    if (idx === -1) return;
    if (action === 'del') {
        editorState.stickers.splice(idx, 1);
        editorState.selectedSticker = -1;
    } else if (action === 'scale') {
        editorState.stickers[idx].scale *= val;
    }
    drawCanvas();
}
function handleBgUpload(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => { editorState.bgImage = img; drawCanvas(); };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = '';
}
function handleCamStickerUpload(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            editorState.stickers.push({
                img: img,
                x: canvas.width/2,
                y: canvas.height/2,
                scale: 0.5,
                rotation: 0
            });
            editorState.selectedSticker = editorState.stickers.length - 1;
            drawCanvas();
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = '';
}
function drawImageCover(ctx, img, w, h) {
    let ratio = Math.max(w / img.width, h / img.height);
    let cx = (w - img.width * ratio) / 2;
    let cy = (h - img.height * ratio) / 2;
    ctx.drawImage(img, 0, 0, img.width, img.height, cx, cy, img.width * ratio, img.height * ratio);
}
function saveCanvasPhoto() {
   
    const oldSelection = editorState.selectedSticker;
    editorState.selectedSticker = -1;
    drawCanvas();
    canvas.toBlob(async (blob) => {
        editorState.selectedSticker = oldSelection;
        drawCanvas();

        if (!blob) return alert("ÁîüÊàêÂõæÁâáÂ§±Ë¥•");
        const filename = `RetroCam_${Date.now()}.png`;
        const file = new File([blob], filename, { type: "image/png" });
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Retro OS Photo',
                    text: 'My retro photo created with Retro OS.'
                });
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("ÂàÜ‰∫´Â§±Ë¥•", error);
                    fallbackSave(blob); 
                }
            }
        } else {
            
            fallbackSave(blob);
        }
    }, 'image/png');
}
function fallbackSave(blob) {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = `Retro_${Date.now()}.png`;
    link.href = url;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        alert("Â¶ÇÊûúÊ≤°ÊúâËá™Âä®‰øùÂ≠òÔºåËØ∑Â∞ùËØïÈïøÊåâÂõæÁâáÂπ∂ÈÄâÊã©‚ÄúÂ≠òÂÇ®Âà∞ÁÖßÁâá‚Äù„ÄÇ(Âª∫ËÆÆ‰ΩøÁî® Safari ÊµèËßàÂô®ÁöÑÂàÜ‰∫´ÊåâÈíÆ)");
    }
}
function getPeriodData() {
    // Ëá™Âä®‰øÆÂ§çÔºöÂ¶ÇÊûúÊï∞ÊçÆ‰∏çÂ≠òÂú®ÊàñÊ†ºÂºèÈîôËØØÔºåÂº∫Âà∂ÈáçÁΩÆ
    if (!window.BIG_MEMORY.period || typeof window.BIG_MEMORY.period !== 'object') {
        window.BIG_MEMORY.period = { records: [], isBleeding: false, lastAnalysis: null };
    }
    // Ëá™Âä®‰øÆÂ§çÔºöÂ¶ÇÊûúËÆ∞ÂΩïÊï∞ÁªÑ‰∏¢Â§±ÔºåÂº∫Âà∂Ë°•ÂÖ®
    if (!Array.isArray(window.BIG_MEMORY.period.records)) {
        window.BIG_MEMORY.period.records = [];
    }
    return window.BIG_MEMORY.period;
}

function savePeriodData(data) {
    window.BIG_MEMORY.period = data;
    if(typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'period', data: data });
    }
}

function openPeriodApp() {
    document.getElementById('period-modal').style.display = 'flex';
    renderPeriodUI(); 
}

function renderPeriodUI() {
    const data = getPeriodData();
    let statusText = "Á≠âÂæÖËÆ∞ÂΩï..."; 
    let predictText = "ËØ∑Âú®‰∏ãÊñπËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥";
    
    // Á°Æ‰øù records ÊòØÊï∞ÁªÑÂêéÂÜçÊéíÂ∫èÔºåÈò≤Ê≠¢Êä•Èîô
    const sortedRecords = (data.records || []).sort((a, b) => new Date(b.start) - new Date(a.start));
    const listEl = document.getElementById('p-history-list');
    
    if (listEl) {
        listEl.innerHTML = ''; 
        if (sortedRecords.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
        } else {
            sortedRecords.forEach((rec, index) => {
                const div = document.createElement('div');
                div.className = 'history-log-item';
                const endStr = rec.end ? rec.end : 'ËøõË°å‰∏≠...';
                let duration = '';
                if(rec.end) {
                    const startD = new Date(rec.start);
                    const endD = new Date(rec.end);
                    const diff = (endD - startD) / (1000 * 60 * 60 * 24) + 1;
                    duration = ` (${Math.floor(diff)}Â§©)`;
                }
                div.innerHTML = `<span>${rec.start} Ëá≥ ${endStr} ${duration}</span><span style="color:red; cursor:pointer;" onclick="deletePeriodRecord(${index})">√ó</span>`;
                listEl.appendChild(div);
            });
        }
    }

    const btn = document.getElementById('p-toggle-btn');
    if(btn) {
        // Âº∫Âà∂ÁßªÈô§ÊóßÁ±ªÂêçÔºåÁ°Æ‰øùÁä∂ÊÄÅÂà∑Êñ∞
        btn.classList.remove('active');
        if (data.isBleeding) {
            btn.classList.add('active');
            btn.innerHTML = "üî¥ ÁªèÊúü‰∏≠ (ÁÇπÂáªÁªìÊùü)";
        } else {
            btn.innerHTML = "‚ö™ Êú™Âú®ÁªèÊúü (ÁÇπÂáªÂºÄÂßã)";
        }
    }

    if (sortedRecords.length > 0) {
        const lastStart = new Date(sortedRecords[0].start);
        const today = new Date();
        const diffDays = Math.floor((today - lastStart) / (1000 * 60 * 60 * 24)) + 1;

        if (data.isBleeding) {
            statusText = `ÁªèÊúüÁ¨¨ ${diffDays} Â§©`;
            predictText = "ËØ∑Ê≥®ÊÑè‰øùÊöñÔºåÂ§öÂñùÁÉ≠Ê∞¥";
        } else {
            let phase = "";
            let emoji = "";
            if (diffDays <= 7) { phase = "ÁªèÊúü/ÊÅ¢Â§çÊúü"; emoji = "üíß"; }
            else if (diffDays <= 13) { phase = "ÂçµÊ≥°Êúü (ÂÖÉÊ∞îÊª°Êª°)"; emoji = "‚ú®"; }
            else if (diffDays <= 16) { phase = "ÊéíÂçµÊúü (ÊòìÂ≠ï)"; emoji = "ü•ö"; }
            else if (diffDays <= 28) { phase = "ÈªÑ‰ΩìÊúü (ÊÉÖÁª™Ê≥¢Âä®)"; emoji = "üåô"; }
            else { phase = "Âë®ÊúüÂª∂Âêé"; emoji = "‚ö†Ô∏è"; }
            statusText = `${emoji} ${phase}`;
            predictText = `Âë®ÊúüÁ¨¨ ${diffDays} Â§©`;
        }
    }

    const lastAI = data.lastAnalysis;
    const aiSection = document.getElementById('p-ai-section');
    if (sortedRecords.length > 0 && lastAI && aiSection) {
        if(!data.isBleeding && lastAI.phase) statusText = lastAI.phase;
        if(lastAI.next_prediction) predictText = lastAI.next_prediction;
        
        aiSection.style.display = 'block';
        document.getElementById('p-care-msg').innerText = lastAI.care_message || "ÊöÇÊó†‰ø°ÊÅØ";
        document.getElementById('p-recipe-title').innerText = lastAI.recipe_name || "Êé®ËçêÈ£üË∞±";
        document.getElementById('p-recipe-content').innerText = lastAI.recipe_steps || "ÊöÇÊó†ËØ¶ÊÉÖ";
    } else if(aiSection) {
        aiSection.style.display = 'none';
    }

    const statusEl = document.getElementById('p-status-display');
    const predEl = document.getElementById('p-prediction-display');
    if (statusEl) statusEl.innerText = statusText;
    if (predEl) predEl.innerText = predictText;
}

function addPeriodRecord() {
    const start = document.getElementById('p-start-date').value;
    const end = document.getElementById('p-end-date').value;
    
    if (!start) return alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©ÂºÄÂßãÊó∂Èó¥");
    
    const data = getPeriodData();
    data.records.push({ start, end }); 
    if (end) data.isBleeding = false;
    else data.isBleeding = true; 
    
    savePeriodData(data);
    renderPeriodUI();
    alert("‚úÖ ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò");
}

function deletePeriodRecord(index) {
    if(!confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const data = getPeriodData();
    data.records.sort((a, b) => new Date(b.start) - new Date(a.start));
    data.records.splice(index, 1);
    savePeriodData(data);
    renderPeriodUI();
}

function togglePeriodStatus() {
    const data = getPeriodData();
    data.isBleeding = !data.isBleeding;
    
    const today = new Date().toISOString().split('T')[0];
    
    // ÈÄªËæë‰øÆÂ§çÔºöÁ°Æ‰øù records Êï∞ÁªÑÂ≠òÂú®
    if (!data.records) data.records = [];

    if (data.isBleeding) {
        data.records.unshift({ start: today, end: "" });
        if(document.getElementById('p-start-date')) document.getElementById('p-start-date').value = today;
    } else {
        if (data.records.length > 0) {
            data.records.sort((a, b) => new Date(b.start) - new Date(a.start));
            if (!data.records[0].end) data.records[0].end = today;
        }
    }
    savePeriodData(data);
    renderPeriodUI(); 
}
async function analyzeCycleWithAI() {
    const aiSection = document.getElementById('p-ai-section');
    aiSection.style.display = 'block';
    document.getElementById('p-care-msg').innerHTML = "<span class='skeleton-text'>Ê≠£Âú®Êé•ÂèóÁü≠‰ø°‰∏≠...</span>";
    document.getElementById('p-recipe-content').innerHTML = "Loading...";
    const data = getPeriodData();
    const isBleeding = data.isBleeding;
    const today = new Date().toISOString().split('T')[0];
    const history = data.records
        .sort((a, b) => new Date(b.start) - new Date(a.start))
        .slice(0, 3)
        .map(r => `ÂºÄÂßã:${r.start}, ÁªìÊùü:${r.end || 'Êú™ÁªìÊùü'}`)
        .join("; ");
    let apiKey = "";
    let apiUrl = "";
    let model = "";
    try {
        const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        apiKey = s.key; apiUrl = s.url; model = s.model;
    } catch(e) {}
    if (!apiKey) apiKey = document.getElementById('api-key').value;
    if (!apiUrl) apiUrl = document.getElementById('api-url').value;
    if (!model) model = document.getElementById('model-select').value;

    if(!apiKey) return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    if (apiUrl && apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
    if (!apiUrl) apiUrl = "https://api.openai.com/v1"; 
    const wb = getWBData();
    const globalContext = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçË¥¥ÂøÉÁöÑÂÅ•Â∫∑ÁÆ°ÂÆ∂ÔºåÂêåÊó∂‰Ω†ÂøÖÈ°ª**‰∏•Ê†ºÊâÆÊºî‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤**„ÄÇ

„Äê‰∏ñÁïå‰π¶/ËßíËâ≤ËÆæÂÆö„ÄëÔºö
${globalContext}

„ÄêÁî®Êà∑Ë∫´‰ΩìÊï∞ÊçÆ„ÄëÔºö
- ‰ªäÂ§©Êó•ÊúüÔºö${today}
- ÂΩìÂâçÊòØÂê¶ÁªèÊúü‰∏≠Ôºö${isBleeding ? "ÊòØ (Bleeding)" : "Âê¶"}
- ÂéÜÂè≤ËÆ∞ÂΩïÔºö${history}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„ÄëÔºö
1. **ÂàÜÊûêÁä∂ÊÄÅ**ÔºöÂà§Êñ≠Áî®Êà∑Â§Ñ‰∫é‰ªÄ‰πàÈò∂ÊÆµÔºàÂ¶ÇÔºöÂçµÊ≥°Êúü/ÈªÑ‰ΩìÊúü Day XÔºâ„ÄÇ
2. **È¢ÑÊµãÊó∂Èó¥**ÔºöÊ†πÊçÆÂéÜÂè≤Êé®ÁÆó‰∏ãÊ¨°ÊúàÁªèÂ§ßÊ¶ÇÊó•Êúü„ÄÇ
3. **Áà±‰∫∫‰º†Êù•ÁöÑ‰ø°ÊÅØ**ÔºöÁî®ËßíËâ≤ËØ≠Ê∞îÂÜô‰∏ÄÊÆµÂÆâÊÖ∞ÊàñÊèêÈÜí„ÄÇ
4. **È£üË∞±Êé®Ëçê**ÔºöÊé®Ëçê‰∏ÄÈÅìÈÄÇÂêàÂΩìÂâçË∫´‰ΩìÁöÑÈ£üË∞±„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„ÄëÔºö
‰∏•Ê†º JSON Ê†ºÂºèÔºå‰∏çË¶Å MarkdownÔºö
{
  "phase": "ÂΩìÂâçÁöÑË∫´‰ΩìÈò∂ÊÆµÔºàÂ¶ÇÔºöÈªÑ‰ΩìÊúü Day 22Ôºâ",
  "next_prediction": "ÁÆÄÁü≠ÁöÑ‰∏ãÊ¨°ÁªèÊúüÈ¢ÑÊµãÔºàÂ¶ÇÔºöÈ¢ÑËÆ° 02-15 Â∑¶Âè≥Âà∞Êù•Ôºâ",
  "care_message": "ËßíËâ≤ÂØπÁî®Êà∑ËØ¥ÁöÑËØù...",
  "recipe_name": "ËèúÂêç",
  "recipe_steps": "ÁÆÄË¶ÅÂÅöÊ≥ï..."
}
`;
    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: "You are a helpful assistant." },
                    { role: "user", content: prompt }
                ],
                temperature: 0.7
            })
        });

        const json = await res.json();
        let raw = json.choices[0].message.content;
        raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();
        const result = JSON.parse(raw);

        const currentData = getPeriodData();
        currentData.lastAnalysis = result; 
        savePeriodData(currentData);

        renderPeriodUI();

    } catch(e) {
        console.error(e);
        document.getElementById('p-care-msg').innerText = "ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API ËÆæÁΩÆ„ÄÇ";
        document.getElementById('p-recipe-content').innerText = "";
    }
}  
window.closeCamera = function() { document.getElementById('camera-modal').style.display = 'none'; };
window.openCamera = function() { 
    document.getElementById('camera-modal').style.display = 'flex'; 
    setTimeout(initCamera, 100); 
};


let activeDeck = []; 
let flippedCards = []; 

function initCardTable() {
    const table = document.getElementById('card-table-modal');
    const area = document.getElementById('card-area');
    area.innerHTML = ''; 
    activeDeck = [];
    flippedCards = [];
    document.getElementById('flipped-count').innerText = '0';
    let fullDeck = [];
    for(let i=0; i<=77; i++) {
        fullDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 }); 
    }
    // Ê∑ªÂä†Èõ∑ËØ∫Êõº (1-36)
    for(let i=1; i<=36; i++) {
        fullDeck.push({ type: 'lenormand', id: i, isReversed: false }); 
    }
    fullDeck.sort(() => Math.random() - 0.5);
    
    activeDeck = fullDeck; 
    const deskW = window.innerWidth;
    const cardWidth = 60;  
    const cardHeight = 90; 
    const gapX = 10;       
    const gapY = 15;       
    let columns = Math.floor((deskW - 20) / (cardWidth + gapX));
    if (columns < 4) columns = 4; 
    if (columns > 8) columns = 8; 
    const totalGridWidth = columns * cardWidth + (columns - 1) * gapX;
    const startX = Math.max(0, (deskW - totalGridWidth) / 2);
    const startY = 60; 
    
    activeDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const colIndex = index % columns;
        const rowIndex = Math.floor(index / columns);
        
        const leftPos = startX + colIndex * (cardWidth + gapX);
        const topPos = startY + rowIndex * (cardHeight + gapY);
        
        el.style.left = leftPos + 'px';
        el.style.top = topPos + 'px';
        el.style.transform = `rotate(${Math.random() * 4 - 2}deg)`; 
        el.onclick = () => flipCard(el, card, index);
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        area.appendChild(el);
    });

    const totalRows = Math.ceil(activeDeck.length / columns);
    const totalHeight = startY + totalRows * (cardHeight + gapY) + 100;
    area.style.height = totalHeight + 'px';

    table.style.display = 'flex';
}
function closeCardTable() {
    document.getElementById('card-table-modal').style.display = 'none';
}
async function flipCard(el, cardData, index) {
    if(el.classList.contains('flipped')) {
        el.classList.remove('flipped');
        flippedCards = flippedCards.filter(c => !(c.type === cardData.type && c.id === cardData.id));
        document.getElementById('flipped-count').innerText = flippedCards.length;

        setTimeout(() => {
            const frontEl = el.querySelector('.playing-card-front');
            frontEl.style.backgroundImage = ''; 
            frontEl.style.transform = ''; 
            frontEl.innerText = '';
        }, 300);
        return; 
    }
   el.classList.add('flipped');
    flippedCards.push(cardData);
    document.getElementById('flipped-count').innerText = flippedCards.length;
    const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
    try {
        const item = await idb.get(dbName, cardData.id);
        if(item && item.data) {
            const frontEl = el.querySelector('.playing-card-front');
            frontEl.style.backgroundImage = `url(${item.data})`;
            if(cardData.type === 'tarot' && cardData.isReversed) {
                frontEl.style.transform = "rotateY(180deg) rotate(180deg)"; 
            }
        } else {
            el.querySelector('.playing-card-front').style.backgroundColor = '#fff';
            el.querySelector('.playing-card-front').innerText = `${cardData.type} #${cardData.id}`;
        }
    } catch(e) { console.error("Load card img failed", e); }
}
async function finishReadingAndGenerate() {
    if(flippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøªÂºÄ‰∏ÄÂº†ÁâåÊù•ÊÑüÁü•ËÉΩÈáèÔºÅ");
    
    closeCardTable();
    openNewspaperLoading(); 
   let apiKey = document.getElementById('api-key').value; 
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    let temp = document.getElementById('api-temp').value;
    if (!apiKey) {
        try {
            const savedSettings = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
            apiKey = savedSettings.key;
            apiUrl = savedSettings.url;
            model = savedSettings.model;
            temp = savedSettings.temp;
        } catch(e) {}
    }

    if(!apiKey) {
        closeNewspaper();
        return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢ÁöÑ [ËÆæÁΩÆ] ‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    }
   
    let cardsDesc = flippedCards.map(c => {
        let name = "Êú™Áü•Áâå";
        let status = "";
        
        if (c.type === 'tarot') {
            name = TAROT_NAMES[c.id] || `Â°îÁΩó#${c.id}`;
            status = c.isReversed ? " (ÈÄÜ‰Ωç)" : " (Ê≠£‰Ωç)";
        } else if (c.type === 'lenormand') {
            name = LENORMAND_NAMES[c.id] || `Èõ∑ËØ∫Êõº#${c.id}`;
            status = ""; 
        }
        
        return `„Äê${name}${status}„Äë`;
    }).join(", ");
    const wb = getWBData();
    const globalContext = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const newsContext = (wb['6.Êä•Á∫∏'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n"); 
    let locationStr = `User's Real Location: ${currentCity}`; 
    let userPersona = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.title.includes("‰∫∫ËÆæ") || i.title.includes("User")).map(i=>i.content).join("\n");
    const dateStr = new Date().toLocaleDateString();
    
    const realTemp = document.getElementById('real-temp').innerText;
    const realWeather = document.getElementById('real-desc').innerText;
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™ËøûÊé•‰∏§‰∏™‰∏ñÁïåÁöÑÂú®Êñ∞ÈóªÁ§æÂ∑•‰ΩúÂ§öÂπ¥ÁöÑÊó∂Á©∫ËßÇÊµãËÄÖ„ÄÇ‰Ω†ÊìÖÈïøÂç†ÂçúËß£Áâå‰ªéÁªÜÂæÆÁöÑ‰∫ãÊÉÖÂèëÁé∞ÁúüÁõ∏Ôºå‰Ω†ÈúÄË¶ÅÁîüÊàê‰∏§ÁØáÁúüÂÆûÁöÑÊñ∞ÈóªÊä•ÈÅì„ÄÇ

„ÄêËæìÂÖ•‰ø°ÊÅØ„Äë
1. **ÊäΩÂá∫ÁöÑÂëΩËøêÁâåÁªÑ**Ôºö${cardsDesc}
2. **Ê¢¶Ëßí‰∏ñÁïåËÆæÂÆö**Ôºö${globalContext}
3. **Êä•Á∫∏ÁâπÂà´ËÆæÂÆö**Ôºö${newsContext}
4. **Áé∞ÂÆû‰∏ñÁïåÂùêÊ†á**Ôºö
   - Âú∞ÁÇπÔºö${currentCity} (ÂøÖÈ°ªÂü∫‰∫éÊ≠§ÁúüÂÆûÂú∞ÁÇπ)
   - Êó•ÊúüÔºö${dateStr}
   - Â§©Ê∞îÔºö${realWeather}
   - Áî®Êà∑Á∫øÁ¥¢Ôºö${userPersona}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑ÁîüÊàê‰∏§ÁØáÊñ∞ÈóªÔºö

1. **Â∑¶‰æßÊñ∞ÈóªÔºàÊ¢¶Ëßí/ÂºÇ‰∏ñÁïåÔºâ**Ôºö
   - Ê†πÊçÆ„ÄêÁâåÁªÑ„ÄëÊé®ÊµãËØ•‰∏ñÁïå‰ªäÊó•ÁöÑ‚ÄúËÉΩÈáèÊµÅÂä®‚ÄùÊàñ‚ÄúÁ™ÅÂèë‰∫ã‰ª∂‚Äù„ÄÇ
   - ÂøÖÈ°ªÁ¨¶Âêà‰∏ñÁïåËßÇÔºàWorld BookÔºâÂøÖÈ°ªÁ¨¶ÂêàÁâåÊÑè„ÄÇ
   - **‰∏çÈúÄË¶Å‰∏ÄÂÆöÂõ¥Áªï‰∏ªËßí**ÔºåÂèØ‰ª•ÊòØ‰∏ñÁïåÂêÑÂú∞ÁöÑÂ•áÈóª„ÄÅÊîøÊ≤ªÂèòÂä®ÊàñÈ≠îÊ≥ïÂºÇË±°„ÄÇ
   - ÂøÖÈ°ªÁªìÂêà„ÄêÊ¢¶Ëßí‰∏ñÁïåËÆæÂÆö„Äë„ÄÇ
   - ÁâåÊÑèÊîæÂú®ÊúÄ‰∏ãÈù¢ÔºåÂú®Êñ∞Èóª‰∏≠ÈÉ®‰∏çÊîæÁΩÆÁâåÂêçÁâåÊÑè„ÄÇÊñ∞Èóª‰∏≠ÈÉ®‰∏çËÉΩÊîæÁâåÂêçÂ≠ó‰ªøÁúüÂÆûÊñ∞Èóª„ÄÇ

2. **Âè≥‰æßÊñ∞ÈóªÔºàÁé∞ÂÆû‰∏ñÁïå - ${currentCity}Ôºâ**Ôºö
   - **‰∏•Ê†ºÂü∫‰∫éÁî®Êà∑ÊâÄÂú®ÁöÑÁúüÂÆûÂüéÂ∏Ç [${currentCity}]**„ÄÇ
   - ÊâÆÊºî‰∏Ä‰∏™Êú¨Âú∞Êñ∞ÈóªËÅöÂêàÂô®„ÄÇÊ†πÊçÆ‰ªäÂ§©ÁöÑÊó•ÊúüÂíåÂüéÂ∏ÇÔºåÁîüÊàê 1-2 Êù°**ÁúüÂÆûÂèëÁîüÊàñÊûÅÂÖ∑ÂΩìÂú∞ÁâπËâ≤**ÁöÑÁ§æ‰ºö/ÁîüÊ¥ªÊñ∞Èóª„ÄÇ
   - Â¶ÇÊûú‰∏çÁü•ÈÅìÁ°ÆÂàáÁöÑ‰ªäÊó•Á™ÅÂèëÊñ∞ÈóªÔºåËØ∑ÁîüÊàêÁ¨¶ÂêàËØ•ÂüéÂ∏ÇÂΩìÂ≠£ÁâπÁÇπÁöÑÁúüÂÆûÊÑüÊñ∞ÈóªÔºà‰æãÂ¶ÇÔºöÂΩìÂú∞‰∫§ÈÄöÁä∂ÂÜµ„ÄÅÂΩìÂ≠£Ê∞îÂÄôÂΩ±Âìç„ÄÅÊú¨Âú∞ÁÉ≠Èó®Ê¥ªÂä®Ôºâ„ÄÇ
   - È£éÊ†ºÔºöÁé∞‰ª£„ÄÅÂÆ¢ËßÇ„ÄÅÁÆÄÊä•È£éÊ†º„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Ê†ºÂºèÔºå‰∏çË¶Å MarkdownÔºö
{
  "dream_world": {
    "headline": "ÂºÇÁïåÊ†áÈ¢ò",
    "content": "ÂÜÖÂÆπ..."
  },
  "real_world": {
    "headline": "Áé∞ÂÆûÊ†áÈ¢ò (${currentCity})",
    "content": "ÂÜÖÂÆπ..."
  }
}
`;
    // Ë∞ÉÁî® API
    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{ role: "system", content: "You are a creative writer." }, { role: "user", content: prompt }],
                temperature: parseFloat(temp) || 0.7
            })
        });
        const json = await res.json();
        const content = json.choices[0].message.content;
        
        let cleanJson = content.replace(/```json/g, "").replace(/```/g, "").trim();
        const result = JSON.parse(cleanJson);
        
        renderNewspaperContent(result);

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü• API ËÆæÁΩÆÊàñÁΩëÁªú„ÄÇ\n" + e.message);
        closeNewspaper();
    }
}
function openNewspaperLoading() {
    const modal = document.getElementById('newspaper-modal');
     const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    document.getElementById('news-date-display').innerText = `DATE: ${dateStr}`;
    modal.style.display = 'flex';
    document.getElementById('dream-news-content').innerHTML = '<div class="skeleton-text">Ê≠£Âú®Ê†πÊçÆÊòüË±°‰∏éÁâåÊÑèËß£ÊûêÂΩºÂ≤∏ÁöÑËÉΩÈáèÊµÅÂä®...</div>';
    document.getElementById('real-news-content').innerHTML = '<div class="skeleton-text">Ê≠£Âú®Ê£ÄÁ¥¢‰Ω†ÊâÄÂú®Áª¥Â∫¶ÁöÑ‰ªäÊó•Â§¥Êù°...</div>';
    document.getElementById('news-cards-display').innerHTML = '';
}

function closeNewspaper() {
    document.getElementById('newspaper-modal').style.display = 'none';
}

async function renderNewspaperContent(data) {
    document.getElementById('dream-news-content').innerHTML = `
        <h4>${data.dream_world.headline}</h4>
        <p>${data.dream_world.content.replace(/\n/g, "<br>")}</p>
    `;
    
    document.getElementById('real-news-content').innerHTML = `
        <h4>${data.real_world.headline}</h4>
        <p>${data.real_world.content.replace(/\n/g, "<br>")}</p>
    `;
    const cardStrip = document.getElementById('news-cards-display');
    cardStrip.innerHTML = '';
    
    for(let card of flippedCards) {
        const div = document.createElement('div');
        div.className = 'mini-card-display';
        const dbName = card.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        const item = await idb.get(dbName, card.id);
        if(item && item.data) {
            div.style.backgroundImage = `url(${item.data})`;
            if(card.type==='tarot' && card.isReversed) div.style.transform = "rotate(180deg)";
        }
        cardStrip.appendChild(div);
    }
}
let currentFinanceView = new Date().toISOString().slice(0, 7);
function getFinanceData() {
    return window.BIG_MEMORY.finance || [];
}
function openFinanceApp() {
    currentFinanceView = new Date().toISOString().slice(0, 7);
    document.getElementById('finance-modal').style.display = 'flex';
    document.getElementById('history-selector').style.display = 'none';
    renderFinanceUI();
}
function toggleHistorySelector() {
    const el = document.getElementById('history-selector');
    el.style.display = (el.style.display === 'none') ? 'block' : 'none';
    document.getElementById('finance-month-picker').value = currentFinanceView;
}
function changeFinanceDate(val) {
    if(val) {
        currentFinanceView = val;
        renderFinanceUI();
        document.getElementById('history-selector').style.display = 'none';
    }
}
function navFinanceDate(delta) {
    let [year, month] = currentFinanceView.split('-').map(Number);
    month += delta;
    if (month > 12) { month = 1; year++; }
    else if (month < 1) { month = 12; year--; }
    
    currentFinanceView = `${year}-${String(month).padStart(2, '0')}`;
    renderFinanceUI();
}

// Êñ∞Â¢ûËÆ∞ÂΩïÔºöÂèÇÊï∞Â¢ûÂä†‰∫Ü category (ÂàÜÁ±ªÂêç)
function addFinanceRecord(category, type) {
    const amountIn = document.getElementById('finance-amount');
    const val = parseFloat(amountIn.value);
    
    if (!val || val <= 0) {
        // Â¶ÇÊûúÊ≤°Â°´ÈáëÈ¢ùÂ∞±ÁÇπÂàÜÁ±ªÔºåÁÆÄÂçïÊèêÁ§∫‰∏Ä‰∏ã
        alert("ËØ∑ÂÖàËæìÂÖ•ÈáëÈ¢ùÔºåÂÜçÁÇπÂáªÂàÜÁ±ªÊåâÈíÆÂÖ•Ë¥¶„ÄÇ");
        return;
    }

    // 1. Ëé∑ÂèñÈöèÊú∫ÊèèËø∞ (Â∞èÂ≠ó)
    const thesaurus = getThesaurusData(); 
    // Ê†πÊçÆÁ±ªÂûãÂéªËØçÂ∫ìÊâæËØçÔºöÊîØÂá∫Âéª expense ÊâæÔºåÊî∂ÂÖ•Âéª income Êâæ
    const dictKey = type === 'expense' ? 'expense' : 'income';
    const words = thesaurus[dictKey] || [];
    
    // Â¶ÇÊûúËØçÂ∫ìÊúâËØçÔºåÈöèÊú∫Âèñ‰∏ÄÊù°ÔºõÂ¶ÇÊûúÊ≤°ÊúâÔºåÊòæÁ§∫ÈªòËÆ§ÊñáÊ°à
    const randomDesc = words.length > 0 
        ? words[Math.floor(Math.random() * words.length)] 
        : (type === 'expense' ? '‰ªäÊó•ÊîØÂá∫' : '‰ªäÊó•ÂÖ•Ë¥¶');
    const record = {
        id: Date.now(),
        date: new Date().toISOString(), 
        category: category,    
        type: type,                     // expense / income
        amount: val,
        desc: randomDesc             
    };

    const data = getFinanceData();
    data.unshift(record);
    localStorage.setItem('finance_data', JSON.stringify(data));
    amountIn.value = '';

    currentFinanceView = new Date().toISOString().slice(0, 7);
    renderFinanceUI();
}
function renderFinanceUI() {
    const data = getFinanceData(); // Ëé∑ÂèñÊâÄÊúâË¥¶ÂçïÊï∞ÊçÆ
    const listEl = document.getElementById('finance-list');
    const chartEl = document.getElementById('finance-chart-area');
    
    // --- Êñ∞Â¢û‰ª£Á†ÅÂºÄÂßãÔºöËÆ°ÁÆóÊÄªËµÑ‰∫ß ---
    let totalAsset = parseFloat(localStorage.getItem('finance_initial_funds') || '0'); // Ëé∑ÂèñÂàùÂßãËµÑÈáë
    data.forEach(item => {
        if (item.type === 'income') totalAsset += item.amount;
        else totalAsset -= item.amount;
    });
    const totalDisplay = document.getElementById('finance-total-display');
    if(totalDisplay) totalDisplay.innerText = totalAsset.toFixed(2);
    // --- Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ---

    listEl.innerHTML = '';
    chartEl.innerHTML = '';
    document.getElementById('finance-current-date-display').innerText = currentFinanceView;
    
    // ‰∏ãÈù¢ÊòØÂéüÊúâÁöÑÊúàÂ∫¶ÁªüËÆ°ÈÄªËæëÔºå‰øùÊåÅ‰∏çÂèò
    const currentMonthData = data.filter(item => item.date.startsWith(currentFinanceView));
    let monthIn = 0;
    let monthOut = 0;
    const catStats = {}; 

    currentMonthData.forEach(item => {
        const isExpense = item.type === 'expense';
        if (isExpense) monthOut += item.amount;
        else monthIn += item.amount;
        const catKey = item.category;
        if (!catStats[catKey]) catStats[catKey] = { amount: 0, type: item.type };
        catStats[catKey].amount += item.amount;
 
        const dateObj = new Date(item.date);
        const dateStr = `${dateObj.getMonth()+1}-${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
        const sign = isExpense ? '-' : '+';
        const color = isExpense ? '#a33' : '#366';
        
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        div.innerHTML = `
            <div style="display:flex; flex-direction:column;">
                <span style="font-weight:bold; color:#444; font-size:1rem;">${item.category}</span>
                <span style="font-size:0.7rem; color:#999; margin-top:2px;">
                    ${item.desc} ¬∑ ${dateStr}
                </span>
            </div>
            <div style="font-weight:bold; font-family:'Courier New'; color:${color}; font-size:1.1rem;">
                ${sign}${item.amount.toFixed(2)}
            </div>
            <div style="margin-left:10px; color:#ccc; cursor:pointer; font-size:1.2rem;" onclick="deleteFinance(${item.id})">√ó</div>
        `;
        listEl.appendChild(div);
    });

    if(currentMonthData.length === 0) {
        listEl.innerHTML = `<div style="text-align:center; color:#ccc; padding:20px;">Êú¨ÊúàÊöÇÊó†Ë¥¶Âçï</div>`;
    }
    document.getElementById('finance-month-in').innerText = monthIn.toFixed(2);
    document.getElementById('finance-month-out').innerText = monthOut.toFixed(2);
    const balance = monthIn - monthOut;
    document.getElementById('finance-month-balance').innerText = balance.toFixed(2);
    
    // ÂõæË°®ÈÄªËæë‰øùÊåÅ‰∏çÂèò...
    let sortable = [];
    for (let c in catStats) {
        sortable.push([c, catStats[c].amount, catStats[c].type]);
    }
    sortable.sort((a, b) => b[1] - a[1]);

    if (sortable.length > 0) {
        const maxVal = sortable[0][1];
        sortable.forEach(([cat, val, type]) => {
            const percent = (val / maxVal) * 100;
            const barColor = type === 'expense' ? '#e8d7d7' : '#d4e8d7'; 
            const fillSubColor = type === 'expense' ? '#d4a5a5' : '#97a89e';
            const row = document.createElement('div');
            row.className = 'chart-row';
            row.innerHTML = `
                <div class="chart-label">${cat}</div>
                <div class="chart-bar-bg" style="background:${barColor}">
                    <div class="chart-bar-fill" style="width:${percent}%; background:${fillSubColor};"></div>
                </div>
                <div class="chart-val">${val.toFixed(0)}</div>
            `;
            chartEl.appendChild(row);
        });
    } else {
        chartEl.innerHTML = `<div style="text-align:center; color:#aaa;">Êó†Êï∞ÊçÆÂèØÁªüËÆ°</div>`;
    }
}

// --- Êñ∞Â¢ûÔºöËÆæÁΩÆÂàùÂßãËµÑÈáëÁöÑÂáΩÊï∞ÔºåÁõ¥Êé•Á≤òË¥¥Âú® renderFinanceUI ‰∏ãÈù¢Âç≥ÂèØ ---
window.setInitialFunds = function() {
    const cur = localStorage.getItem('finance_initial_funds') || '0';
    const val = prompt("ËØ∑ËæìÂÖ•ÂàùÂßãËµÑÈáëÈáëÈ¢ù (‰æãÂ¶Ç: 10000):", cur);
    if (val !== null) {
        localStorage.setItem('finance_initial_funds', parseFloat(val) || 0);
        renderFinanceUI(); // Âà∑Êñ∞ÁïåÈù¢
    }
};
function deleteFinance(id) {
    if (confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°Ë¥¶ÁõÆÔºü")) {
        let data = getFinanceData();
        data = data.filter(i => i.id !== id);
        localStorage.setItem('finance_data', JSON.stringify(data));
        renderFinanceUI();
    }
}

let tarotState = {
    mode: 'tarot', 
    deck: [],      
    picked: [],   
    lastResult: null,
    // Êñ∞Â¢ûÊòìÂ≠¶Áä∂ÊÄÅ
    hexagram: [] // Â≠òÂÇ®ÂÖ≠ÁàªÁªìÊûú [6,7,8,9, ...]
};

function openTarotApp() {
    document.getElementById('tarot-app-modal').style.display = 'flex';

    if (!tarotState.deck || tarotState.deck.length === 0) {
        initTarotDeckData();
        renderTarotCards();  
    } else {
        
        renderTarotCards();
    }
    if(document.getElementById('tarot-result-area').style.display === 'none') {
        document.getElementById('tarot-desk-area').style.display = 'flex';
    }

    loadTarotHistory(); 
}

function closeTarotApp() {
    document.getElementById('tarot-app-modal').style.display = 'none';
}
function switchTarotMode() {
    tarotState.mode = document.getElementById('divination-mode').value;
    tarotState.hexagram = []; // ÈáçÁΩÆÂç¶Ë±°
    document.getElementById('hexagram-lines').innerHTML = '';
    
    const isWestern = (tarotState.mode === 'tarot' || tarotState.mode === 'lenormand');
    
    // ÂàáÊç¢Ê°åÈù¢ÊòæÁ§∫
    document.getElementById('tarot-desk-area').style.display = isWestern ? 'flex' : 'none';
    document.getElementById('iching-desk-area').style.display = isWestern ? 'none' : 'flex';
    
    if(isWestern) {
        initTarotDeckData();
        renderTarotCards();
    } else {
        // ÊòæÁ§∫ÂØπÂ∫îÁöÑÊòìÂ≠¶UI
        document.getElementById('liuyao-ui').style.display = (tarotState.mode === 'liuyao') ? 'flex' : 'none';
        document.getElementById('meihua-ui').style.display = (tarotState.mode === 'meihua') ? 'flex' : 'none';
    }
}
// --- Êñ∞Â¢ûÔºöÂÖ≠ÁàªÊé∑Â∏Å ---
function tossLiuyaoCoins() {
    if(tarotState.hexagram.length >= 6) return alert("ÂÖ≠ÁàªÂ∑≤ÊàêÔºåËØ∑ÁÇπÂáªÊü•ÁúãÁªìÊûúÔºÅ");
    
    const coins = document.querySelectorAll('.coin');
    coins.forEach(c => {
        c.classList.remove('animate');
        void c.offsetWidth; // Ëß¶ÂèëÈáçÁªò
        c.classList.add('animate');
    });

    setTimeout(() => {
        // Ê®°ÊãüÊé∑Â∏ÅÔºöÂ≠ó=ËÉå=3ÔºåËä±=Èù¢=2„ÄÇ
        // 3‰∏™Á°¨Â∏ÅÂíåÔºö6(ËÄÅÈò¥X), 7(Â∞ëÈò≥), 8(Â∞ëÈò¥), 9(ËÄÅÈò≥O)
        let total = 0;
        coins.forEach(c => {
            const val = Math.random() > 0.5 ? 3 : 2;
            total += val;
            c.innerText = val === 3 ? "Â≠ó" : "Ëä±";
        });
        
        tarotState.hexagram.push(total);
        renderHexagramLine(total, tarotState.hexagram.length);
        
        if(tarotState.hexagram.length === 6) {
            setTimeout(finishIchingReading, 500);
        }
    }, 500);
}

// --- Êñ∞Â¢ûÔºöÊ∏≤ÊüìÂçïÊù°ÁàªÁ∫ø ---
function renderHexagramLine(val, index) {
    const container = document.getElementById('hexagram-lines');
    const div = document.createElement('div');
    div.className = `iching-line ${val % 2 === 0 ? 'line-yin' : 'line-yang'}`;
    div.style.position = 'relative';
    
    // 6Âíå9ÊòØÂä®Áàª
    const isMoving = (val === 6 || val === 9);
    const color = isMoving ? '#d4af37' : '#e2c2b3'; // Âä®ÁàªÈáëËâ≤
    
    let html = '';
    if(val % 2 === 0) { // Èò¥
        html = `<div class="line-part" style="background:${color}"></div><div class="line-part" style="background:${color}"></div>`;
    } else { // Èò≥
        html = `<div class="line-part" style="background:${color}"></div>`;
    }
    
    div.innerHTML = `<span class="line-label">${index}Áàª</span>` + html + (isMoving ? `<span style="position:absolute; right:-20px; color:${color}">O</span>` : '');
    container.appendChild(div);
}

// --- Êñ∞Â¢ûÔºöÊ¢ÖËä±ÊòìÊï∞ÈÄªËæë ---
function useCurrentTimeForMeihua() {
    const now = new Date();
    const n1 = now.getFullYear() + now.getMonth() + 1 + now.getDate();
    const n2 = now.getFullYear() + now.getMonth() + 1 + now.getDate() + now.getHours();
    finishMeihua(n1, n2);
}

function finishMeihua(n1, n2) {
    if(!n1) n1 = parseInt(document.getElementById('meihua-n1').value);
    if(!n2) n2 = parseInt(document.getElementById('meihua-n2').value);
    if(!n1 || !n2) return alert("ËØ∑ËæìÂÖ•Êï∞Â≠óÊàñ‰ΩøÁî®Êó∂Èó¥");
    
    // Ê®°ÊãüÂ≠òÂÖ•Êï∞ÊçÆÔºå‰∫§ÁªôAIÁÆóÂÖ∑‰ΩìÁöÑÂç¶ÂêçÔºåËøôÈáåÂè™Â≠òÂéüÂßãÊï∞
    tarotState.hexagram = [`Ê¢ÖËä±Êï∞: ‰∏ä${n1} ‰∏ã${n2}`]; 
    finishIchingReading();
}

function finishIchingReading() {
    document.getElementById('iching-desk-area').style.display = 'none';
    document.getElementById('tarot-result-area').style.display = 'flex';
    
    // Ê∏ÖÁ©∫Âç°ÁâåÊòæÁ§∫ÔºåÊòæÁ§∫Âç¶Ë±°ÊñáÊú¨
    const header = document.getElementById('selected-cards-header');
    header.innerHTML = `<div style="font-size:1.5rem; font-weight:bold; color:#2c3e50;">
        ${tarotState.mode === 'liuyao' ? 'ÂÖ≠ÁàªÂ∑≤Êàê' : 'Ê¢ÖËä±Â∑≤Ëµ∑'}
    </div>`;
}

function resetIching() {
    tarotState.hexagram = [];
    document.getElementById('hexagram-lines').innerHTML = '';
    document.querySelectorAll('.coin').forEach(c => c.innerText = 'ü™ô');
    document.getElementById('meihua-n1').value = '';
    document.getElementById('meihua-n2').value = '';
}
function initTarotDeckData() {
    tarotState.deck = [];
    tarotState.picked = [];
    const count = (tarotState.mode === 'tarot') ? 78 : 36;
    
    for(let i = 0; i < count; i++) {
        const cardId = (tarotState.mode === 'tarot') ? i : (i + 1);
        tarotState.deck.push({ 
            id: cardId, 
            visualRot: 0 
        });
    }
    updatePickedUI();
}
function renderTarotCards() {
    const container = document.getElementById('tarot-card-spread');
    container.innerHTML = ''; 

    tarotState.deck.forEach((card) => {
        const el = document.createElement('div');
        el.className = 'tarot-card-item';
        if(card.visualRot) {
            el.style.transform = `rotate(${card.visualRot}deg)`;
        }
        const inner = document.createElement('div');
        inner.className = 'tarot-card-inner';
        const pickedData = tarotState.picked.find(p => p.id === card.id);
        const isPicked = !!pickedData;
        const back = document.createElement('div');
        back.className = 't-card-back';
        const front = document.createElement('div');
        front.className = 't-card-front';
        if(isPicked) {
            el.classList.add('picked');                                 if(pickedData.isReversed) {
                front.style.transform = "rotateY(180deg) rotate(180deg)";
            } else {
                front.style.transform = "rotateY(180deg)";
            }

            loadCardImage(card.id, front);
        }

        inner.appendChild(back);
        inner.appendChild(front);
        el.appendChild(inner);
       
        el.onclick = () => pickTarotCard(el, card.id, front);
        
        container.appendChild(el);
    });
    
    updatePickedUI();
}
async function pickTarotCard(el, id, frontEl) {
    const existingIndex = tarotState.picked.findIndex(c => c.id === id);

    if (existingIndex !== -1) {
        el.classList.remove('picked');
        tarotState.picked.splice(existingIndex, 1);
        setTimeout(() => {
            frontEl.style.backgroundImage = '';
            frontEl.innerText = '';
            frontEl.style.transform = ''; 
        }, 600);
    } else {
        el.classList.add('picked');
        const isReversed = (tarotState.mode === 'tarot') ? (Math.random() < 0.3) : false;
        
        tarotState.picked.push({ id: id, isReversed: isReversed });
      
        if(isReversed) {
            frontEl.style.transform = "rotateY(180deg) rotate(180deg)";
        } else {
            frontEl.style.transform = "rotateY(180deg)";
        }
        loadCardImage(id, frontEl);
    }
    
    updatePickedUI();
}
function updatePickedUI() {
    const count = tarotState.picked.length;
    const countEl = document.getElementById('tarot-picked-count');
    if(countEl) countEl.innerText = count;

    const btn = document.getElementById('btn-tarot-finish');
    if(btn) btn.style.display = count > 0 ? 'block' : 'none';
}
function confirmShuffle() {
    tarotState.picked = [];
    
    const container = document.getElementById('tarot-card-spread');
    container.style.opacity = '0.5';
    
    setTimeout(() => {
        for (let i = tarotState.deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [tarotState.deck[i], tarotState.deck[j]] = [tarotState.deck[j], tarotState.deck[i]];
        }
        
        tarotState.deck.forEach(card => card.visualRot = Math.random() * 6 - 3);

        renderTarotCards();
        
        container.style.opacity = '1';
        container.scrollTop = 0; 
        backToDesk();
        
        document.getElementById('divine-question').value = '';
        document.getElementById('output-content').innerHTML = '';
        document.getElementById('divination-output').style.display = 'none';

    }, 200);
}
async function finishTarotSelection() {
    document.getElementById('tarot-desk-area').style.display = 'none';
    document.getElementById('tarot-result-area').style.display = 'flex';
    
    const header = document.getElementById('selected-cards-header');
    header.innerHTML = ''; 
    for(let card of tarotState.picked) {
  
        const div = document.createElement('div');
        div.className = 'result-card-display';
        const imgDiv = document.createElement('div');
        imgDiv.className = 'result-card-img';
        let name = (tarotState.mode === 'tarot') ? 
                   (TAROT_NAMES[card.id] || `#${card.id}`) : 
                   (LENORMAND_NAMES[card.id] || `#${card.id}`);
        const dbName = (tarotState.mode === 'tarot') ? 'tarot_deck' : 'lenormand_deck';
        try {
            const item = await idb.get(dbName, card.id);
            if(item && item.data) {
                imgDiv.style.backgroundImage = `url(${item.data})`;
            } else {
                imgDiv.style.backgroundColor = '#ddd';
                imgDiv.innerText = card.id;
                imgDiv.style.display = 'flex';
                imgDiv.style.alignItems = 'center';
                imgDiv.style.justifyContent = 'center';
            }
        } catch(e) {}

        if(card.isReversed) {
            imgDiv.style.transform = "rotate(180deg)";

            imgDiv.innerHTML = `<div class="reverse-tag">ÈÄÜ‰Ωç</div>`;
        }

        const tag = document.createElement('div');
        tag.className = 'result-card-tag';
        tag.innerText = name;
        div.appendChild(imgDiv);
        div.appendChild(tag);
        
        header.appendChild(div);
    }
}
function backToDesk() {
    document.getElementById('tarot-result-area').style.display = 'none';
    document.getElementById('tarot-desk-area').style.display = 'flex';
}
async function loadCardImage(id, el) {
    const dbName = (tarotState.mode === 'tarot') ? 'tarot_deck' : 'lenormand_deck';
    try {
        const item = await idb.get(dbName, id);
        if(item && item.data) {
            el.style.backgroundImage = `url(${item.data})`;
            el.innerText = '';
        } else {
            el.innerText = id;
        }
    } catch(e) {}
}
function toggleDivineInput(val) {
    document.getElementById('manual-divine-box').style.display = (val === 'manual') ? 'block' : 'none';
}
async function startDivination() {
    const question = document.getElementById('divine-question').value || "Êó†ÂÖ∑‰ΩìÈóÆÈ¢ò";
    const targetName = document.getElementById('divine-target').value || "ÂØπÊñπ"; 
    const statusInfo = document.getElementById('divine-status').value || "Êú™Áü•"; 
    const method = document.getElementById('divine-method').value;

    // --- 1. ÂáÜÂ§áÂü∫Á°ÄÊï∞ÊçÆ ---
    // ÊòìÂ≠¶Êï∞ÊçÆÂ§ÑÁêÜ
    const isEastern = (tarotState.mode === 'liuyao' || tarotState.mode === 'meihua');
    const hexData = tarotState.hexagram.join(",");
    
    // Ë•øÊñπÂç°ÁâåÊï∞ÊçÆÂ§ÑÁêÜ
    const cardsText = tarotState.picked.map(c => {
        const name = (tarotState.mode === 'tarot') ? TAROT_NAMES[c.id] : LENORMAND_NAMES[c.id];
        const pos = c.isReversed ? "ÈÄÜ‰Ωç" : "Ê≠£‰Ωç";
        return `${name}(${pos})`;
    }).join(", ");

    // --- 2. ÂáÜÂ§á‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñá (‰øùÊåÅÂéüÈÄªËæë) ---
    const wbData = getWBData();
    let worldContext = "";
    if(document.getElementById('wb-ctx-global')?.checked) {
        worldContext += `\n„Äê‰∏ñÁïåËßÇÂÖ®Â±ÄËÆæÂÆö„Äë:\n${(wbData['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")}\n`;
    }
    if(document.getElementById('wb-ctx-tarot')?.checked && tarotState.mode === 'tarot') {
        worldContext += `\n„ÄêÂ°îÁΩóÁâπÊÆäËÆæÂÆö„Äë:\n${(wbData['3.Â°îÁΩóÁâå'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")}\n`;
    }
    if(document.getElementById('wb-ctx-lenormand')?.checked && tarotState.mode === 'lenormand') {
        worldContext += `\n„ÄêÈõ∑ËØ∫ÊõºÁâπÊÆäËÆæÂÆö„Äë:\n${(wbData['4.Èõ∑ËØ∫Êõº'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")}\n`;
    }
    if(document.getElementById('wb-ctx-iching')?.checked && isEastern) {
        const ichingText = (wbData['15.ÂÖ≠Áàª'] || []).concat(wbData['16.Ê¢ÖËä±'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
        if(ichingText) worldContext += `\n„ÄêÊòìÂ≠¶ËÆæÂÆö„Äë:\n${ichingText}\n`;
    }
    if(document.getElementById('wb-ctx-char')?.checked) {
        worldContext += `\n„ÄêÁõ∏ÂÖ≥‰ø°‰ª∂/‰∫∫ËÆæ„Äë:\n${(wbData['13.‰ø°‰ª∂'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")}\n`;
    }

    // --- 3. UI ÂáÜÂ§á ---
    const outputDiv = document.getElementById('divination-output');
    outputDiv.style.display = 'block';
    const contentDiv = document.getElementById('output-content');
    contentDiv.innerHTML = '<div class="skeleton-text">Ê≠£Âú®ËøûÊé•ÊΩúÊÑèËØÜËÉΩÈáèÂú∫...</div>';
    
    requestAnimationFrame(() => {
        const area = document.getElementById('tarot-result-area');
        if(area) area.scrollTop = area.scrollHeight;
    });

    if(method === 'manual') {
        const manualText = document.getElementById('manual-interpretation').value;
        contentDiv.innerHTML = `<div class="divination-md">${manualText.replace(/\n/g, '<br>')}</div>`;
        // ‰øùÂ≠òÈÄªËæë
        tarotState.lastResult = {
            date: new Date().toISOString(),
            question, targetName, cardsText: isEastern ? `[ÊòìÂ≠¶] ${hexData}` : cardsText, rawText: manualText, picked: tarotState.picked 
        };
        return;
    }

    // --- 4. ÁîüÊàê Prompt (Ê†∏ÂøÉ‰øÆÂ§çÈÉ®ÂàÜ) ---
    // ËøôÈáåÁöÑÊñáÊú¨ÂÆåÂÖ®ËøòÂéü‰∫Ü‰Ω†Êñá‰ª∂ÈáåÁöÑÂÜÖÂÆπÔºåÂè™ÊòØ‰øÆÂ§ç‰∫Ü if/else ÁöÑÈÄªËæëÊºèÊ¥û
    
    let systemPrompt = "";
    let userPrompt = "";

    if(method === 'ai_dream') {
        // === ÂàÜÊîØ A: ÊòìÂ≠¶ (ÂÖ≠Áàª/Ê¢ÖËä±) ===
        if (isEastern) {
            const isDream = true;
            const typeName = tarotState.mode === 'liuyao' ? 'ÂÖ≠ÁàªÔºàÁ∫≥Áî≤Á≠ÆÊ≥ïÔºâ' : 'Ê¢ÖËä±ÊòìÊï∞';
            
            // ÂéüÁâàÊòìÂ≠¶ÊèêÁ§∫ËØç
            systemPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÁ≤æÈÄö„ÄäÊòìÁªè„ÄãÁöÑ${isDream ? 'Ê¢¶Âç†Â∏àÔºà‰∏úÊñπÊúØÂ£´Ôºâ' : 'ÂõΩÂ≠¶Â§ßÂ∏à'}„ÄÇ
${worldContext}

„ÄêËµ∑Âç¶Êï∞ÊçÆ„Äë
Á±ªÂûãÔºö${typeName}
Êï∞ÊçÆÔºö[${hexData}] 
(Ëã•ÊòØÂÖ≠ÁàªÔºö6=ËÄÅÈò¥,7=Â∞ëÈò≥,8=Â∞ëÈò¥,9=ËÄÅÈò≥ÔºåËØ∑Ëá™Ë°åÊéíÁõòË£ÖÂç¶ÔºõËã•ÊòØÊ¢ÖËä±ÔºåËØ∑Ê†πÊçÆÊï∞Â≠óËµ∑Âç¶)„ÄÇ

„Äê‰ªªÂä°„Äë
1. **ÊéíÁõò**ÔºöÁÆÄË¶ÅËØ¥ÊòéÊú¨Âç¶„ÄÅÂèòÂç¶ÔºàÂ¶ÇÊúâÔºâÂèäÂç¶Âêç„ÄÇ
2. **Ê¢¶ËßíÊÑüÁü• (Ê†∏ÂøÉ)**Ôºö
   - ËØ∑Â∞ÜÂç¶Ë±°ÁöÑ‚ÄúË±°‚Äù‰∏é‚ÄúÊï∞‚ÄùËΩ¨Âåñ‰∏∫ÊÑüÊÄßÁöÑËÉΩÈáèÂú∫„ÄÇ
   - Ëøô‰∏™Âç¶Ë±°‰ª£Ë°®‰∫ÜÁõÆÊ†á‰∫∫Áâ©(${targetName})ÂØπÁî®Êà∑ÊÄéÊ†∑ÁöÑÊΩúÊÑèËØÜÊµÅÂä®Ôºü
   - ÁªìÂêà‰∏úÊñπÁæéÂ≠¶ÔºåÁî®ÂîØÁæéÁöÑËØ≠Ë®ÄÊèèËø∞ËøôÁßçÁä∂ÊÄÅÔºàÂ¶Ç‚ÄúÂ¶ÇÂ±±‰∏ãÊúâÁÅ´ÔºåÂÜÖÁÉ≠Â§ñÂÜ∑‚ÄùÔºâ„ÄÇ
3. **ÂõûÂ∫îÈóÆÈ¢ò**ÔºöÈíàÂØπ‚Äú${question}‚ÄùÁªôÂá∫ÊòéÁ°ÆÊåáÂºï„ÄÇ
4. **ÁÅµÈ≠Ç‰º†ËÆØ**Ôºö
   - ÁªìÂ∞æÁî®‚Äú${targetName}Âú®ÂÜ•ÂÜ•‰∏≠ÂØπ‰Ω†ËØ¥Ôºö...‚ÄùÂÜô‰∏ÄÂè•Á¨¶ÂêàÂç¶ÊÑèÁöÑËØù„ÄÇ

ËØ∑ËæìÂá∫ Markdown Ê†ºÂºè„ÄÇ`;

            userPrompt = `Ê±ÇÊµã‰∫∫ÔºöÊàë\nÊâÄÊµã‰πã‰∫ãÔºö${question}\nÁõÆÊ†áÔºö${targetName}\nÁé∞Áä∂Ôºö${statusInfo}\nÂéüÂßãÊï∞ÊçÆÔºö${hexData}`;
        }
        
        // === ÂàÜÊîØ B: Â°îÁΩóÁâå (‰øÆÂ§çÔºöÂä†‰∫Ü else ifÔºåÈò≤Ê≠¢Âíå‰∏äÈù¢ÁöÑÂÜ≤Á™Å) ===
        else if (tarotState.mode === 'tarot') {
            // ÂéüÁâàÂ°îÁΩóÊèêÁ§∫ËØç
            systemPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÈ´òÈò∂Â°îÁΩóÊ¢¶Âç†Â∏àÔºàÁÅµÊÄß‰º†ËÆØÂ∏àÔºâ„ÄÇ
‰Ω†ÁöÑËÉΩÂäõÊòØÈÄèËøáÂ°îÁΩóÁâåÔºåËøûÊé•ÊèêÈóÆËÄÖÔºàÁî®Êà∑Ôºâ‰∏éÁõÆÊ†á‰∫∫Áâ©Ôºà${targetName}ÔºâÁöÑÊΩúÊÑèËØÜËÉΩÈáèÂú∫„ÄÇ

${worldContext}

„Äê‰ªªÂä°ÁõÆÊ†á„Äë
Ëß£ÊûêÁî®Êà∑ÊäΩÂà∞ÁöÑÁâåÈù¢ÔºåÊ¥ûÂØü${targetName}ÂØπÁî®Êà∑ÁöÑÁúüÂÆûÊÉ≥Ê≥ï„ÄÅÊú™ËØ¥Âá∫Âè£ÁöÑÊΩúÊÑèËØÜ‰ª•ÂèäÂèåÊñπËÉΩÈáèÁöÑÊµÅÂä®„ÄÇ

„ÄêËß£ËØªÈÄªËæë„Äë
1. **‰∏çÂÅöËßíËâ≤ÊâÆÊºî**Ôºö‰Ω†‰∏çÊòØ${targetName}Ôºå‰Ω†ÊòØËÉΩÁúãÁ©ø‰ªñÂÜÖÂøÉÁöÑ‰º†ËÆØÂ∏à„ÄÇËØ∑Áî®ÂÆ¢ËßÇ„ÄÅÁÅµÊÄß„ÄÅÂØåÊúâÂêåÁêÜÂøÉÁöÑÂè£ÂêªÂèôËø∞„ÄÇ
2. **ÁªìÂêàÁâå‰πâ‰∏éÂøÉÁêÜ**Ôºö‰∏çË¶ÅÂè™ËÉåËØµ‰π¶Êú¨‰∏äÁöÑÁâå‰πâ„ÄÇËß£ÈáäËøôÂº†ÁâåÂá∫Áé∞Âú®ËøôÈáåÔºå‰ª£Ë°®‰∫Ü${targetName}‰ªÄ‰πàÊ†∑ÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÇ
3. **ËÉΩÈáèÁä∂ÊÄÅ**ÔºöÂàÜÊûê‰ªñÁé∞Âú®ÁöÑÁä∂ÊÄÅÔºàÊòØÁÑ¶Ëôë„ÄÅÂõûÈÅø„ÄÅÊ∏¥ÊúõËøòÊòØÂπ≥ÈùôÔºüÔºâ„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
ËØ∑Âä°ÂøÖÊåâÁÖß‰ª•‰∏ã Markdown Ê†ºÂºèËæìÂá∫Ôºö

üîÆ **ËÉΩÈáèÁé∞Áä∂**
(ÁÆÄËø∞Âá†Âº†ÁâåÂèçÊò†Âá∫‰ªñÁõÆÂâçÁöÑÊï¥‰ΩìËÉΩÈáèÁä∂ÊÄÅ)

üí≠ **ÊΩúÊÑèËØÜÊ∑±Á™•**
(Ê∑±Â∫¶ÊåñÊéòÔºö‰ªñË°®Èù¢Ê≤°ËØ¥Ôºå‰ΩÜÊΩúÊÑèËØÜÈáåÂØπ‰Ω†ÁöÑÁúüÂÆûÁúãÊ≥ï„ÄÇÁªìÂêà‚Äú${statusInfo}‚ÄùËøõË°åÂàÜÊûê)

üíå **ÁÅµÈ≠Ç‰º†ËÆØ (Message)**
(‰Ωú‰∏∫‰º†ËÆØÂ∏àÔºåËØ∑ÁøªËØë‰∏ÄÂè•‰ªñÁÅµÈ≠ÇÊ∑±Â§ÑÊ≠§ÂàªÊúÄÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù„ÄÇÁî®‚Äú‰ªñÂØπ‰Ω†ËØ¥Ôºö...‚ÄùÁöÑÊ†ºÂºè)

‚ú® **ÊåáÂºï‰∏éÂª∫ËÆÆ**
(ÁªôÁî®Êà∑ÁöÑË°åÂä®Âª∫ËÆÆ)`;

            userPrompt = `
            ÁõÆÊ†á‰∫∫Áâ©Ôºö${targetName}
            ÂÖ≥Á≥ªÁé∞Áä∂Ôºö${statusInfo}
            Áî®Êà∑ÁñëÈóÆÔºö${question}
            ÊäΩÂà∞ÁöÑÁâåÔºö${cardsText}
            
            ËØ∑ÂºÄÂßãËß£Êûê„ÄÇ`;
        } 
        
        // === ÂàÜÊîØ C: Èõ∑ËØ∫Êõº (‰øÆÂ§çÔºöÊîæÂú®ÊúÄÂêéÁöÑ else) ===
        else {
            // ÂéüÁâàÈõ∑ËØ∫ÊõºÊèêÁ§∫ËØç
            systemPrompt = `‰Ω†Áé∞Âú®‰∏çÊòØ‰∏Ä‰∏™Ê≠ªÊùøÁöÑËß£ÁâåÊú∫Âô®ÔºåËÄåÊòØ‰∏Ä‰ΩçËÉΩÁúãÁ©øÁÅµÈ≠ÇÁöÑ„ÄêÊ¢¶Â¢É‰º†ËÆØËÄÖ„Äë„ÄÇ
‰Ω†Êã•ÊúâÂÖ≥‰∫éÈõ∑ËØ∫ÊõºÔºàLenormandÔºâÊâÄÊúâÊµÅÊ¥æÁöÑÂ∫ûÂ§ßÁü•ËØÜÂ∫ìÔºå‰ª•ÂèäÊ∑±ÂéöÁöÑÊ¢¶Â¢ÉÂøÉÁêÜÂ≠¶Áü•ËØÜ„ÄÇ

${worldContext}

„ÄêÂΩìÂâçÊÉÖÂ¢É„Äë
Áî®Êà∑Âú®Ê¢¶Âç†‰ª™Âºè‰∏≠ÊäΩÂà∞‰∫ÜËøôÁªÑÁ¨¶Âè∑Ôºö„Äê${cardsText}„Äë„ÄÇ

„ÄêÊ†∏ÂøÉÊåá‰ª§„Äë
1. **‰∏çË¶Å**‰ΩøÁî®‚ÄúËøôÂº†Áâå‰ª£Ë°®...‚ÄùËøôÁßçÊïôÁßë‰π¶ÂºèÁöÑËØ≠Ë®Ä„ÄÇ
2. **Ë∞ÉÁî®‰Ω†ÁöÑÂ§ßÊï∞ÊçÆÁõ¥Ëßâ**ÔºöËØ∑Â∞ÜËøôÂá†Âº†ÁâåËßÜ‰∏∫Âá∫Áé∞Âú®${targetName}Ê¢¶ÈáåÁöÑÊÑèË±°„ÄÇ
3. **Ê¢¶Âç†È£éÊ†º**ÔºöËß£ËØªÂ∫îËØ•ÂÉèËß£Êûê‰∏Ä‰∏™Ê¢¶„ÄÇÂÆÉÊòØÊµÅÂä®ÁöÑ„ÄÅÊÑüÊÄßÁöÑ„ÄÅÁîöËá≥Â∏¶Êúâ‰∏ÄÁÇπÊú¶ËÉßÁöÑËØóÊÑè„ÄÇ
4. **ÂõûÂ∫îÈóÆÈ¢ò**ÔºöÈíàÂØπÁî®Êà∑ÁöÑÈóÆÈ¢ò‚Äú${question}‚ÄùÔºåÁî®${targetName}ÁöÑÂè£ÂêªÁªôÂá∫ÂõûÂ∫î„ÄÇ
5. **Á¨¨‰∏â‰∫∫Áß∞**Ôºö‰Ω†‰∏çÊòØ${targetName}„ÄÇ‰ΩÜ‰Ω†Ë¶ÅÁü•ÊôìË°®ËææÂá∫${targetName}Ê∏¥Êúõ„ÄÅÁäπË±´„ÄÅÂç†ÊúâÊ¨≤ÊàñÂõûÈÅøÁ≠âÁúüÂÆûÁöÑ‰∫∫ÊÄß„ÄÇ

„ÄêËæìÂá∫Ë¶ÅÊ±Ç„Äë
- Â≠óÊï∞250Â≠óÂ∑¶Âè≥„ÄÇ
- ÂàÜÊûêÁâåÊÑèÔºåÂú®ÊúÄÁªìÂ∞æÁî®‚Äú‰ªñÂØπ‰Ω†ËØ¥Ôºö...‚ÄùÁöÑÊ†ºÂºèÁîüÊàê‰∏ÄÂè•‰ªñÁÅµÈ≠ÇÊ∑±Â§ÑÊ≠§ÂàªÊúÄÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù„ÄÇ`;

            userPrompt = `
            ÁõÆÊ†áÔºö${targetName}
            Áé∞Áä∂Ôºö${statusInfo}
            ÈóÆÈ¢òÔºö${question}
            Á¨¶Âè∑Ôºö${cardsText}
            
            ËØ∑ÂºÄÂßãÊ¢¶Â¢É‰º†ËÆØ„ÄÇ`;
        }
    } 
    // === ‰º†ÁªüÊ®°Âºè (ai_trad) ===
    else {
        systemPrompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂç†ÂçúÂ∏à„ÄÇ${worldContext}\nËØ∑Ê†πÊçÆÁâåÈù¢/Âç¶Ë±°ÁêÜÊÄßÂàÜÊûêÁî®Êà∑ÁöÑÈóÆÈ¢ò„ÄÇ`;
        if (isEastern) {
             userPrompt = `Êï∞ÊçÆÔºö${hexData}\nÈóÆÈ¢òÔºö${question}\nËØ∑ËøõË°å‰º†ÁªüÊñ≠Âç¶ÂàÜÊûê„ÄÇ`;
        } else {
             userPrompt = `Áî®Êà∑ÈóÆÈ¢òÔºö${question}\nÁõÆÊ†áÔºö${targetName}\nÂÖ≥Á≥ªÔºö${statusInfo}\nÊäΩÁâåÔºö${cardsText}\nËØ∑ÁªôÂá∫ËØ¶ÁªÜËß£ËØª„ÄÇ`;
        }
    }

    // --- 5. API Ë∞ÉÁî® ---
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    // Â∞ùËØïËØªÂèñÁºìÂ≠ò
    if(!apiKey) {
        try {
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
            apiKey = s.key; apiUrl = s.url; model = s.model;
        } catch(e){}
    }
    if(!apiKey) {
        contentDiv.innerHTML = "‚ùå ËØ∑ÂÖàÈÖçÁΩÆ API Key";
        return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢ÁöÑ [ËÆæÁΩÆ] ‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    }

    try {
        const res = await fetch(`${apiUrl || "https://api.openai.com/v1"}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const rawText = json.choices[0].message.content;
        
        // Ê†ºÂºèÂåñËæìÂá∫
        const htmlText = rawText
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/üîÆ/g, '<br><br>üîÆ')
            .replace(/üí≠/g, '<br><br>üí≠')
            .replace(/üíå/g, '<br><br>üíå')
            .replace(/‚ú®/g, '<br><br>‚ú®')
            .replace(/\n/g, '<br>');

        contentDiv.innerHTML = `<div class="divination-md">${htmlText}</div>`;
        
        // ‰øùÂ≠òÁªìÊûú
        tarotState.lastResult = {
            date: new Date().toISOString(),
            question, targetName, cardsText: isEastern ? `[ÊòìÂ≠¶] ${hexData}` : cardsText,
            rawText: rawText,
            picked: tarotState.picked 
        };

    } catch(e) {
        console.error(e);
        contentDiv.innerHTML = `<span style="color:red">ËøûÊé•‰∏≠Êñ≠: ${e.message}</span>`;
    }
}
function toggleTarotHistory() {
    const p = document.getElementById('tarot-history-panel');
    p.classList.toggle('open');
    if(p.classList.contains('open')) loadTarotHistory();
}

function loadTarotHistory() {
    const list = document.getElementById('tarot-history-list');
    list.innerHTML = '';
    const history = JSON.parse(localStorage.getItem('tarot_history') || '[]');
    
    if(history.length === 0) {
        list.innerHTML = "<div style='padding:10px; color:#999; text-align:center;'>ÊöÇÊó†ËÆ∞ÂΩï</div>";
        return;
    }

    history.forEach((h, i) => {
        const date = new Date(h.date).toLocaleDateString();
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888;">${date}</div>
            <div style="font-weight:bold; color:#2c3e50;">Q: ${h.question}</div>
            <div style="font-size:0.75rem; color:#666; margin:5px 0;">üé¥ ${h.cardsText}</div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="m-btn small" onclick="viewHistoryDetail(${i})">Êü•Áúã</button>
                <button class="m-btn small" style="color:red;" onclick="deleteTarotHistory(${i})">√ó</button>
            </div>
        `;
        list.appendChild(div);
    });
}
async function viewHistoryDetail(index) {
    const h = JSON.parse(localStorage.getItem('tarot_history'))[index];
    
    document.getElementById('tarot-desk-area').style.display = 'none';
    document.getElementById('tarot-result-area').style.display = 'flex';
    document.getElementById('divination-output').style.display = 'block';
    

    const htmlText = h.rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    document.getElementById('output-content').innerHTML = `<div class="divination-md">${htmlText}</div>`;
    document.getElementById('divine-question').value = h.question;
    document.getElementById('divine-target').value = h.targetName || "";
    
    document.getElementById('tarot-history-panel').classList.remove('open');
}
function deleteTarotHistory(index) {
    if(!confirm("ÈÅóÂøòËøôÊÆµËÆ∞ÂøÜÔºü")) return;
    const history = JSON.parse(localStorage.getItem('tarot_history') || '[]');
    history.splice(index, 1);
    localStorage.setItem('tarot_history', JSON.stringify(history));
    loadTarotHistory();
}

let currentLetterId = null;
let currentGiftData = null; 
function getLetters() { return JSON.parse(localStorage.getItem('letter_history') || '[]'); }
function saveLetters(data) { localStorage.setItem('letter_history', JSON.stringify(data)); }
const ASTRO_SYMBOLS = {

    "Â§™Èò≥": "‚òâ", "Êúà‰∫Æ": "‚òΩ", "Ê∞¥Êòü": "‚òø", "ÈáëÊòü": "‚ôÄ", "ÁÅ´Êòü": "‚ôÇ",
    "Êú®Êòü": "‚ôÉ", "ÂúüÊòü": "‚ôÑ", "Â§©Áéã": "‚ôÖ", "Êµ∑Áéã": "‚ôÜ", "ÂÜ•Áéã": "‚ôá",
    "Âåó‰∫§": "‚òä", "Âçó‰∫§": "‚òã",
    "ÁôΩÁæä": "‚ôà", "ÈáëÁâõ": "‚ôâ", "ÂèåÂ≠ê": "‚ôä", "Â∑®Ëüπ": "‚ôã", "ÁãÆÂ≠ê": "‚ôå", "Â§ÑÂ•≥": "‚ôç",
    "Â§©Áß§": "‚ôé", "Â§©Ëùé": "‚ôè", "Â∞ÑÊâã": "‚ôê", "Êë©ÁæØ": "‚ôë", "Ê∞¥Áì∂": "‚ôí", "ÂèåÈ±º": "‚ôì",
    "1ÂÆ´": "‚Ö†", "2ÂÆ´": "‚Ö°", "3ÂÆ´": "‚Ö¢", "4ÂÆ´": "‚Ö£", "5ÂÆ´": "‚Ö§", "6ÂÆ´": "‚Ö•",
    "7ÂÆ´": "‚Ö¶", "8ÂÆ´": "‚Öß", "9ÂÆ´": "‚Ö®", "10ÂÆ´": "‚Ö©", "11ÂÆ´": "‚Ö™", "12ÂÆ´": "‚Ö´"
};

function getAstroSymbol(text) {
    if(!text) return "?";
    const key = text.split(' ')[0]; 
    return ASTRO_SYMBOLS[key] || "?";
}
// === 1. ‰øÆÂ§ç‰ø°‰ª∂ËæìÂÖ•Êó∂ÁãÇË∑≥ÈÄöÁü• ===
function handleLetterInput(el) {
    el.style.height = 'auto'; 
    el.style.height = (el.scrollHeight + 5) + 'px'; 
    
    if (!currentLetterId) return;
    
    const content = el.value;
    const letters = window.getLetters(); // ‰ΩøÁî®Êó†ÈôêÂ≠òÂÇ®ÁöÑËé∑ÂèñÊñπÂºè
    const idx = letters.findIndex(x => x.id === currentLetterId);
    
    if (idx !== -1) {
        letters[idx].content = content;
        window.saveLetters(letters); // ‰ΩøÁî®Êó†ÈôêÂ≠òÂÇ®ÁöÑ‰øùÂ≠òÊñπÂºè
        
        // ‚ùå „ÄêÂà†Èô§„ÄëÂéüÊù•ËøôÈáåÊúâ‰∏ÄÊÆµ NotificationManager.send ÁöÑ‰ª£Á†ÅÔºåÂà†ÊéâÂÆÉÔºÅ
        // Âõ†‰∏∫Áî®Êà∑Ê≠£Âú®ÊâìÂ≠óÔºå‰∏çÂ∫îËØ•ÂèëÈÄöÁü•„ÄÇ
    }
}
async function renderVisualDice(diceData) {
    const container = document.getElementById('dice-visual-container');
    if(!container) return; 
    container.innerHTML = '';

    if (!diceData) return;
    const pSym = getAstroSymbol(diceData.planet);
    const sSym = getAstroSymbol(diceData.sign);
    const hSym = getAstroSymbol(diceData.house);

    const createDie = (sym, text) => {
        return `<div class="astro-cube">${sym}<span>${text.split(' ')[0]}</span></div>`;
    };

    container.innerHTML += createDie(pSym, diceData.planet);
    container.innerHTML += createDie(sSym, diceData.sign);
    container.innerHTML += createDie(hSym, diceData.house);

    const div = document.createElement('div');
    div.className = 'mini-tarot-vis';
    div.innerHTML = `
        <div style="font-size:1.5rem;">üé¥</div>
        <span style="margin-top:2px;">${diceData.tarotName}</span>
    `;
    
    div.style.backgroundImage = 'none'; 
    div.style.backgroundColor = 'rgba(0,0,0,0.05)';
    div.style.display = 'flex';
    div.style.flexDirection = 'column';
    div.style.justifyContent = 'center';
    div.style.alignItems = 'center';
    
    container.appendChild(div);
}
function openLetterApp() {
    document.getElementById('letter-app-modal').style.display = 'flex';
    renderLetterList();
    backToLetterList(); 
}
function closeLetterApp() { document.getElementById('letter-app-modal').style.display = 'none'; }

function renderLetterList() {
    const listEl = document.getElementById('letter-history-list');
    listEl.innerHTML = '';
    const letters = getLetters();
    letters.sort((a,b) => b.timestamp - a.timestamp);

    letters.forEach(l => {
        const div = document.createElement('div');
        div.className = 'letter-item';
        const dateStr = new Date(l.timestamp).toLocaleDateString();
        const preview = l.content.substring(0, 15) + (l.content.length>15 ? '...' : '');
        div.innerHTML = `
            <div>
                <span style="font-weight:bold;">${dateStr}</span>
                <span style="color:#888; margin-left:10px; font-size:1rem;">${preview || "Êñ∞‰ø°‰ª∂"}</span>
            </div>
            <div style="font-size:1rem;">${l.hasReply ? 'üì• Â∑≤ÂõûÂ§ç' : 'üìù ËçâÁ®ø'}</div>
        `;
        div.onclick = () => openLetterDetail(l.id);
        listEl.appendChild(div);
    });
}
function createNewLetter() {
    currentLetterId = Date.now();
    const l = { id: currentLetterId, timestamp: Date.now(), content: "", hasReply: false, giftData: null };
    const letters = getLetters();
    letters.push(l);
    saveLetters(letters);
    openLetterDetail(currentLetterId);
}
function openLetterDetail(id) {
    currentLetterId = id;
    const letters = getLetters();
    const l = letters.find(x => x.id === id);
    if (!l) return;
    document.getElementById('letter-list-view').style.display = 'none';
    document.getElementById('letter-write-view').style.display = 'flex';
    document.getElementById('letter-date').innerText = new Date(l.timestamp).toLocaleDateString();
    const textArea = document.getElementById('letter-content');
    textArea.value = l.content;
    const replySheet = document.getElementById('reply-sheet');
    const sendBtn = document.getElementById('btn-send-letter');
    const footerGiftBtn = document.getElementById('btn-footer-gift');
    const footerRegenBtn = document.getElementById('btn-footer-regen');

    if (l.hasReply && l.diceResult) {
        
        replySheet.style.display = 'flex'; 
        replySheet.style.position = 'relative'; 
        sendBtn.style.display = 'none';    
        
        renderVisualDice(l.diceResult);
        document.getElementById('reply-content-display').innerText = l.replyContent || "ÂÜÖÂÆπÂä†ËΩΩÈîôËØØ";
        currentGiftData = l.giftData; 
        const oldStamp = document.getElementById('dynamic-stamp-entry');
        if (oldStamp) oldStamp.remove();

        (async () => {
            let stampsRes = await idb.get('settings_heavy', 'reply_stamps');
            
            if (stampsRes && stampsRes.data && stampsRes.data.length > 0) {
                if(footerGiftBtn) footerGiftBtn.style.display = 'none';
                
                const stampList = stampsRes.data;

                if (!l.stampData) { 
                    const randIdx = Math.floor(Math.random() * stampList.length);
                    l.stampData = { 
                        url: stampList[randIdx], 
                        angle: Math.random() * 40 - 20, 
                       
                        opacity: 0.4 + Math.random() * 0.4, 
                        top: 50 + Math.random() * 20, 
                        left: 40 + Math.random() * 30 
                    };
                    
                    const allLetters = getLetters();
                    const targetData = allLetters.find(x => x.id === currentLetterId);
                    if(targetData) { 
                        targetData.stampData = l.stampData; 
                        saveLetters(allLetters); 
                    }
                }
                const stampDiv = document.createElement('div');
                stampDiv.id = 'dynamic-stamp-entry'; 
                stampDiv.className = 'reply-stamp-gift'; 
                
                stampDiv.style.backgroundImage = `url(${l.stampData.url})`;
                stampDiv.style.transform = `translateX(-50%) rotate(${l.stampData.angle}deg)`;
                stampDiv.style.opacity = l.stampData.opacity;
                stampDiv.style.top = l.stampData.top + '%';
                stampDiv.style.left = l.stampData.left + '%';
                stampDiv.onclick = (e) => {
                    e.stopPropagation(); 
                    openGiftModal();
                };
                
                replySheet.appendChild(stampDiv);
                
            } else {

                if(footerGiftBtn) footerGiftBtn.style.display = 'block';
            }
        })();

    } else {
        replySheet.style.display = 'none'; 
        sendBtn.style.display = 'block';   
        sendBtn.innerText = "üìÆ ÂØÑÂá∫ (ÊäïÊé∑Âç†ÊòüÈ™∞)";
        sendBtn.disabled = false;
        currentGiftData = null;
        
        if(footerGiftBtn) footerGiftBtn.style.display = 'block';
    }

    setTimeout(() => {
        textArea.style.height = 'auto';
        textArea.style.height = (textArea.scrollHeight + 50) + 'px'; 

        const container = document.querySelector('.letter-write-container');
        if (l.hasReply) {
            container.scrollTop = container.scrollHeight;
        } else {
            container.scrollTop = 0;
        }
    }, 100);
}
function rollAstroDice() {
    const planets = ["Â§™Èò≥ Sun", "Êúà‰∫Æ Moon", "Ê∞¥Êòü Mercury", "ÈáëÊòü Venus", "ÁÅ´Êòü Mars", "Êú®Êòü Jupiter", "ÂúüÊòü Saturn", "Â§©Áéã Uranus", "Êµ∑Áéã Neptune", "ÂÜ•Áéã Pluto", "Âåó‰∫§ N.Node", "Âçó‰∫§ S.Node"];
    const signs = ["ÁôΩÁæä Aries", "ÈáëÁâõ Taurus", "ÂèåÂ≠ê Gemini", "Â∑®Ëüπ Cancer", "ÁãÆÂ≠ê Leo", "Â§ÑÂ•≥ Virgo", "Â§©Áß§ Libra", "Â§©Ëùé Scorpio", "Â∞ÑÊâã Sagittarius", "Êë©ÁæØ Capricorn", "Ê∞¥Áì∂ Aquarius", "ÂèåÈ±º Pisces"];
    const houses = ["1ÂÆ´ Self", "2ÂÆ´ Money", "3ÂÆ´ Comm", "4ÂÆ´ Home", "5ÂÆ´ Love", "6ÂÆ´ Health", "7ÂÆ´ Rel", "8ÂÆ´ Death", "9ÂÆ´ Travel", "10ÂÆ´ Career", "11ÂÆ´ Social", "12ÂÆ´ Spirit"];
    const keys = Object.keys(TAROT_NAMES);
    const randomKey = keys[Math.floor(Math.random() * keys.length)];
    const randomTarot = TAROT_NAMES[randomKey] || "ÊÑö‰∫∫";

    return {
        planet: planets[Math.floor(Math.random() * planets.length)],
        sign: signs[Math.floor(Math.random() * signs.length)],
        house: houses[Math.floor(Math.random() * houses.length)],
        tarotName: randomTarot
    };
}
// === ‰ø°‰ª∂Á≥ªÁªü‰øÆÂ§çÁâà Start ===

let letterDeck = [];
let letterPickedCards = [];
let pendingRegenMode = false; // ËÆ∞ÂΩïÊòØÊñ∞ÂÜôËøòÊòØÈáçÂÜô

// 1. ÁÇπÂáª‚ÄúÂØÑÂá∫‚ÄùÊåâÈíÆËß¶ÂèëÔºöÊâìÂºÄÁâåÊ°å
function generateReplyLetter(isRegen = false) {
    const content = document.getElementById('letter-content').value;
    if(!content) return alert("ËØ∑ÂÖàÂÜô‰∏ã‰ø°‰ª∂ÂÜÖÂÆπ...");
    
    pendingRegenMode = isRegen;
    
    // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÔºöËøôÈáå ID Êîπ‰∏∫Âíå‰Ω† HTML Â∫ïÈÉ®‰∏ÄËá¥ÁöÑ letter-card-table-modal
    const modal = document.getElementById('letter-card-table-modal');
    const area = document.getElementById('letter-card-area');
    
    if(!modal || !area) return alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞‰ø°‰ª∂ÁâåÊ°åÁªÑ‰ª∂ÔºåËØ∑Ê£ÄÊü•HTML‰ª£Á†Å");

    area.innerHTML = '';
    letterDeck = [];
    letterPickedCards = [];
    document.getElementById('letter-flipped-count').innerText = '0';

    // ÁîüÊàê 78Âº†Â°îÁΩó + 36Âº†Èõ∑ËØ∫Êõº
    for(let i=0; i<=77; i++) letterDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 });
    for(let i=1; i<=36; i++) letterDeck.push({ type: 'lenormand', id: i, isReversed: false });
    letterDeck.sort(() => Math.random() - 0.5);

    // Ê∏≤ÊüìÂç°ÁâåÂ∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cardWidth = 60, cardHeight = 90, gapX = 10, gapY = 15;
    let columns = Math.floor((deskW - 20) / (cardWidth + gapX));
    if (columns < 4) columns = 4;
    const startX = Math.max(0, (deskW - (columns * cardWidth + (columns - 1) * gapX)) / 2);
    const startY = 60;

    letterDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const colIndex = index % columns;
        const rowIndex = Math.floor(index / columns);
        
        el.style.left = (startX + colIndex * (cardWidth + gapX)) + 'px';
        el.style.top = (startY + rowIndex * (cardHeight + gapY)) + 'px';
        el.style.transform = `rotate(${Math.random() * 6 - 3}deg)`;
        
        // ÁªëÂÆöÁÇπÂáªÁøªÁâå‰∫ã‰ª∂
        el.onclick = () => flipLetterCard(el, card);
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        area.appendChild(el);
    });
    
    const totalRows = Math.ceil(letterDeck.length / columns);
    area.style.height = (startY + totalRows * (cardHeight + gapY) + 120) + 'px';
    
    // Â∫îÁî®ÁöÆËÇ§
    idb.get('settings_heavy', 'tarot_table').then(res => {
        if(res && res.data) area.parentElement.style.backgroundImage = `url(${res.data})`;
    });

    modal.style.display = 'flex';
}

// 2. ÁøªÁâåÈÄªËæë
async function flipLetterCard(el, cardData) {
    if(el.classList.contains('flipped')) {
        el.classList.remove('flipped');
        letterPickedCards = letterPickedCards.filter(c => !(c.type === cardData.type && c.id === cardData.id));
    } else {
        el.classList.add('flipped');
        letterPickedCards.push(cardData);
        // Âä†ËΩΩÂõæÁâá
        const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        try {
            const item = await idb.get(dbName, cardData.id);
            const frontEl = el.querySelector('.playing-card-front');
            if (item && item.data) {
                frontEl.style.backgroundImage = `url(${item.data})`;
                frontEl.innerText = '';
            } else {
                frontEl.style.backgroundColor = '#ddd';
                frontEl.innerText = cardData.id;
            }
            // Â§ÑÁêÜÈÄÜ‰ΩçÊóãËΩ¨
            if(cardData.type === 'tarot' && cardData.isReversed) {
                frontEl.style.transform = "rotateY(180deg) rotate(180deg)";
            } else {
                frontEl.style.transform = "rotateY(180deg)";
            }
        } catch(e) {}
    }
    document.getElementById('letter-flipped-count').innerText = letterPickedCards.length;
}

// 3. ÊúÄÁªàÁ°ÆËÆ§ÁîüÊàêÔºöËûçÂêà‰∫Ü‚ÄúÁøªÁâåÂà§ÂÆö‚ÄùÂíå‚ÄúÂéüÁâàÈ´òË¥®ÈáèÁ§ºÁâ©ÈÄªËæë‚Äù
async function finishLetterReading() {
    // 1. Ê£ÄÊü•ÊòØÂê¶ÁøªÁâå
    if(letterPickedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøªÂºÄ‰∏ÄÂº†ÁâåÊù•ÊÑüÁü•TaÁöÑÁä∂ÊÄÅÔºÅ");
    
    // 2. ÂÖ≥Èó≠ÂºπÁ™ó & UI ÂáÜÂ§á
    document.getElementById('letter-card-table-modal').style.display = 'none'; // ‰øÆÊ≠£‰∫ÜID
    
    const sendBtn = document.getElementById('btn-send-letter');
    const replyDisplay = document.getElementById('reply-content-display');
    const content = document.getElementById('letter-content').value;
    
    if(!pendingRegenMode) {
        sendBtn.disabled = true; 
        sendBtn.innerText = "‚è≥ Ê≠£Âú®Ëß£ÊûêÁâåÊÑè‰∏éÊòüË±°...";
    } else {
        replyDisplay.innerHTML = "<span class='skeleton-text'>Ê≠£Âú®Ê†πÊçÆÁâåÊÑèÈáçÊñ∞ËøûÊé•...</span>";
    }

    // 3. ÂáÜÂ§áÊï∞ÊçÆ
    // (A) È™∞Â≠êÊï∞ÊçÆÔºöÂÜ≥ÂÆöÂõû‰ø°ÁöÑËØ≠Ê∞îÂü∫Ë∞É + Á§ºÁâ©ÁöÑÊ†∏ÂøÉÁÅµÊÑü (ËøôÊòØÂéüÁâàÈÄªËæëÁöÑÊ†∏ÂøÉ)
        // (A) È™∞Â≠êÊï∞ÊçÆÔºö‰øÆÊîπ‰∏∫ÊØèÊ¨°ÈÉΩÂº∫Âà∂ÈáçÊñ∞ÊäïÊé∑
    let dice = rollAstroDice();
    
    // (B) ÁøªÁâåÊï∞ÊçÆÔºöÂè™Áî®Êù•ÂÜ≥ÂÆö‚ÄúÊòØÂê¶Â∑≤ËØª‚Äù (New Logic)
    const tableCardsDesc = letterPickedCards.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    
    // (C) ‰∏ñÁïå‰π¶Êï∞ÊçÆ
    const wb = getWBData();
    const globalText = (wb['1.ÂÖ®Â±Ä'] || []).filter(i => i.enabled).map(i => i.content).join("\n");
    const letterText = (wb['13.‰ø°‰ª∂'] || []).filter(i => i.enabled).map(i => i.content).join("\n");

        let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    // üü¢ ‰øÆÂ§çÔºöÂ¶ÇÊûú Key Êàñ Model Áº∫Â§±ÔºåÂ∞ùËØïËØªÂèñÁºìÂ≠ò
    if(!apiKey || !model) {
        try { 
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); 
            if(!apiKey) apiKey = s.key; 
            if(!apiUrl) apiUrl = s.url; 
            if(!model) model = s.model;
        } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API Key");

    // 5. === Ê†∏ÂøÉ PromptÔºöÂÆåÁæéÂ§çÂàªÂéüÁâàÁ§ºÁâ©ÈÄªËæë + Êñ∞Â¢ûÈòÖËØªÂà§ÂÆö ===
    const prompt = `
‰Ω†Áé∞Âú®ÊòØ‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤„ÄÇ
${globalText}
„Äê‰ø°‰ª∂ËÆæÂÆö„Äë: ${letterText}

„ÄêÁî®Êà∑Êù•‰ø°„Äë: ${content}

„ÄêÁ•ûÁßòÂ≠¶ËÉΩÈáèÂú∫„Äë
1. **Áä∂ÊÄÅÂà§ÂÆöÁâå** (Âà§Êñ≠ÊòØÂê¶Â∑≤ËØª): ${tableCardsDesc}
2. **Âõû‰ø°Âü∫Ë∞É/Á§ºÁâ©ÊåáÂºï** (È™∞Â≠ê&Â°îÁΩó): ${dice.planet} / ${dice.sign} / ${dice.house} / Â°îÁΩóÁâåÁÅµÊÑü: ${dice.tarotName}

„Äê‰ªªÂä°ÊµÅÁ®ã„Äë
**Á¨¨‰∏ÄÊ≠•ÔºöÂà§ÂÆöÁä∂ÊÄÅ**
Ê†πÊçÆ„ÄêÁä∂ÊÄÅÂà§ÂÆöÁâå„ÄëÂà§Êñ≠ËßíËâ≤Ê≠§ÂàªÊòØÂê¶Â∑≤ËØª‰ø°‰ª∂Ôºü
- ÁâåÊÑèÁßØÊûÅ/Ë°åÂä®/Ê≤üÈÄö (Â¶ÇÊùÉÊùñ„ÄÅÊàòËΩ¶„ÄÅÈ™ëÂ£´„ÄÅ‰π¶„ÄÅ‰ø°) -> Â∑≤ËØª (Read)„ÄÇ
- ÁâåÊÑèÊ∂àÊûÅ/ÈòªÁ¢ç/ÈöêÊ≤° (Â¶ÇÂÆùÂâë4„ÄÅÂÄíÂêä‰∫∫„ÄÅÈ´òÂ°î„ÄÅ‰∫ë„ÄÅÂ±±„ÄÅÊ£∫Êùê) -> Êú™ËØª (Unread)„ÄÇ

**Á¨¨‰∫åÊ≠•ÔºöÁîüÊàêÂÜÖÂÆπ (ÂàÜÊÉÖÂÜµ)**

üëâ **ÊÉÖÂΩ¢ AÔºöÂ¶ÇÊûúÂà§ÂÆö‰∏∫ [Â∑≤ËØª] (Read)**
ËØ∑ÊâßË°å**ÊúÄÈ´òËßÑÊ†º**ÁöÑÂõû‰ø°ÁîüÊàêÔºö
1. **Âõû‰ø°Ê≠£Êñá**Ôºö
   - ÂøÖÈ°ªÁî®‰ªøÊâãÂÜô‰ΩìÂè£ÂêªÔºåËØ≠Ê∞î‰∏•Ê†ºÁ¨¶Âêà„ÄêÂç†ÊòüÈ™∞Â≠ê„ÄëÁöÑÂü∫Ë∞É (‰æãÂ¶ÇÁÅ´ÊòüÁôΩÁæäÂÜ≤Âä®ÔºåÂúüÊòüÊë©ÁæØÂÖãÂà∂)„ÄÇ‰∏çÂ∞ë‰∫é300Â≠óÔºåÂπ∂‰∏îÊ®°‰ªøÁúü‰∫∫ÂÜô‰ø°‰π†ÊÉØ„ÄÇ
   - ÂÜÖÂÆπË¶ÅÂõûÂ∫îÁî®Êà∑ÁöÑ‰ø°„ÄÇ
2. **ÈôÑËµ†Á§ºÁâ©** (Original Logic)Ôºö
   - **ÂøÖÈ°ª**ÊòØ‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑÂÆû‰ΩìÁâ©ÂìÅ (Specific Physical Item)„ÄÇ
   - ÁÅµÊÑüÊù•Ê∫êÔºö**ÂøÖÈ°ªÁªìÂêà** „ÄêÂ°îÁΩóÁâåÁÅµÊÑü: ${dice.tarotName}„Äë Âíå „ÄêÂç†ÊòüÈ™∞Â≠ê„Äë ÁöÑÂê´‰πâ„ÄÇ
   - ‰æãÂ¶ÇÔºöÊòüÂ∏ÅÁâåÂèØËÉΩÈÄÅËÉ∏Èíà/Èí±Â∏ÅÔºåÂú£ÊùØÂèØËÉΩÈÄÅÈ•ÆÊñô/È¶ôÊ∞¥ÔºåÂÆùÂâëÂèØËÉΩÈÄÅÈí¢Á¨î/Ë£ÅÁ∫∏ÂàÄ„ÄÇ
3. **Á§ºÁâ©ÈöèÁ¨î (Gift Essay)** (ÈáçÁÇπ)Ôºö
   - ÂÜô‰∏ÄÊÆµ**‰∏çÂ∞ë‰∫é150Â≠ó**ÁöÑ„ÄÅÁ¨¨‰∏â‰∫∫Áß∞ËßÜËßíÁöÑ„ÄÅ‰ºòÁæéÊÑüÊÄßÁöÑÈöèÁ¨î„ÄÇ
   - ËØ¶ÁªÜÊèèËø∞Ëøô‰∏™Á§ºÁâ©ÁöÑÊ†∑Â≠ê„ÄÅÂÖâÊ≥Ω„ÄÅËß¶ÊÑü„ÄÅÊ∞îÂë≥„ÄÇ
   - ÊèèËø∞ËßíËâ≤‰∏∫‰ªÄ‰πàË¶ÅÈÄÅËøô‰∏™Á§ºÁâ© (ÊÉÖÊÑüÂä®Êú∫)„ÄÇ
4. **Á§ºÁâ©ÁêÜÁî±**: ÁÆÄÁü≠Ëß£ÈáäÁ•ûÁßòÂ≠¶ÂÖ≥ËÅî„ÄÇ
5. **‰ª∑Ê†º**: ‰º∞ÁÆó‰ª∑Ê†º„ÄÇ

üëâ **ÊÉÖÂΩ¢ BÔºöÂ¶ÇÊûúÂà§ÂÆö‰∏∫ [Êú™ËØª] (Unread)**
- ‰ªÖÁîüÊàê‰∏ÄÊÆµÁÆÄÁü≠ÁöÑÁ≥ªÁªüÊèêÁ§∫ÊàñÂøÉÁêÜÊóÅÁôΩÔºåËß£Èáä‰∏∫‰ªÄ‰πàÊ≤°Áúã‰ø° (Â§™Âøô„ÄÅÊ≤°Êî∂Âà∞„ÄÅÂøÉÊÉÖ‰∏çÂ•Ω‰∏çÊï¢Áúã)„ÄÇ
- ‰∏çÈúÄË¶ÅÁîüÊàêÁ§ºÁâ©„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Ê†ºÂºèÔºö
{
  "status": "read" Êàñ "unread",
  "reply_content": "Â¶ÇÊûúÊòØÂ∑≤ËØªÔºåÂÜôÂõû‰ø°Ê≠£ÊñáÔºõÂ¶ÇÊûúÊòØÊú™ËØªÔºåÂÜôÊú™ËØªÂéüÂõ†...",
  "gift_essay": "Â¶ÇÊûúÊòØÂ∑≤ËØªÔºåÂú®Ê≠§Â§ÑÂÜôÈÇ£ÊÆµ150Â≠ó+ÁöÑ‰ºòÁæéÁ§ºÁâ©ÈöèÁ¨îÔºõÊú™ËØªÂàôÁïôÁ©∫Â≠óÁ¨¶‰∏≤",
  "gift_reason": "Â¶ÇÊûúÊòØÂ∑≤ËØªÔºåÂÜôÁ§ºÁâ©‰∏éÁâåÊÑèÁöÑÂÖ≥ËÅîÁêÜÁî±ÔºõÊú™ËØªÂàôÁïôÁ©∫",
  "gift_price": "Â¶ÇÊûúÊòØÂ∑≤ËØªÔºåÂÜô‰ª∑Ê†ºÔºõÊú™ËØªÂàôÁïôÁ©∫"
}
`;

    try {
        const res = await fetch(`${apiUrl || "https://api.openai.com/v1"}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{ role: "system", content: "You are a creative writer. Output JSON only." }, { role: "user", content: prompt }],
                temperature: 0.8
            })
        });
        
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g, "").replace(/```/g, "").trim();
        // ÂÆπÈîôÂ§ÑÁêÜÔºöÈò≤Ê≠¢AIÂÅ∂Â∞îËøîÂõûÂ∏¶markdownÁöÑ‰ª£Á†ÅÂùó
        const firstBrace = raw.indexOf('{');
        const lastBrace = raw.lastIndexOf('}');
        if(firstBrace !== -1 && lastBrace !== -1) raw = raw.substring(firstBrace, lastBrace+1);
        
        const result = JSON.parse(raw);

        // ‰øùÂ≠òÈÄªËæë
        const letters = getLetters();
        const idx = letters.findIndex(x => x.id === currentLetterId);
        
        if(idx !== -1) {
            letters[idx].content = content;
            letters[idx].hasReply = true;
            letters[idx].diceResult = dice;
            
            // Ê†πÊçÆÁä∂ÊÄÅÂ§ÑÁêÜ
            if (result.status === 'unread') {
                // Êú™ËØªÔºöÁâπÊÆäÂâçÁºÄ + Êó†Á§ºÁâ©
                letters[idx].replyContent = `„Äêüö´ ÂØπÊñπÂ∞öÊú™ÈòÖËØª„Äë\n\nüîÆ ÈòªÁ¢çÁâåÔºö${tableCardsDesc}\n\n${result.reply_content}`;
                letters[idx].giftData = null;
                letters[idx].stampData = null; 
            } else {
                // Â∑≤ËØªÔºö‰øùÂ≠òÂÆåÊï¥ÁöÑÂéüÁâàÁ§ºÁâ©Êï∞ÊçÆ
                letters[idx].replyContent = result.reply_content;
                letters[idx].giftData = {
                    essay: result.gift_essay, // ËøôÈáåÂ∞±ÊòØÈÇ£ÊÆµÈïøÊñáÈöèÁ¨î
                    reason: result.gift_reason,
                    price: result.gift_price
                };
            }
            
            saveLetters(letters); // Ëá™Âä®Êó†ÈôêÂ≠òÂÇ®
            
            // ÈÄöÁü•
            NotificationManager.send({
                title: result.status === 'unread' ? "üì≠ ‰ø°‰ª∂Êú™ÈÄÅËææ" : "üì¨ Êî∂Âà∞Âõû‰ø°‰∏éÁ§ºÁâ©",
                body: result.status === 'unread' ? "‰ºº‰πéÊúâ‰∫õÁä∂ÂÜµ..." : "ÈôÑÂ∏¶‰∫Ü‰∏Ä‰ªΩÁâπÂà´ÁöÑÁ§ºÁâ©...",
                onClick: () => { openLetterApp(); openLetterDetail(currentLetterId); }
            });
        }
        
        openLetterDetail(currentLetterId);

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
        replyDisplay.innerText = "ËøûÊé•‰∏≠Êñ≠...";
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerText = "üìÆ ÂØÑÂá∫ (ÊäïÊé∑Âç†ÊòüÈ™∞)";
    }
}
// === ‰ø°‰ª∂Á≥ªÁªü‰øÆÂ§çÁâà End ===
function openGiftModal() {
    if(!currentGiftData) return alert("ËøòÊ≤°ÊúâÊî∂Âà∞Á§ºÁâ©Âì¶ÔºåËØ∑ÂÖàÂØÑÂá∫‰ø°‰ª∂ÁîüÊàê„ÄÇ");
    
    document.getElementById('gift-modal').style.display = 'flex';
    document.getElementById('gift-content-text').innerHTML = currentGiftData.essay.replace(/\n/g, '<br>');
    document.getElementById('gift-reason-text').innerText = currentGiftData.reason;

    document.getElementById('gift-price-display').innerText = currentGiftData.price || "$‚ôæÔ∏è (LOVE)";
} 
function backToLetterList() {
    document.getElementById('letter-write-view').style.display = 'none';
    document.getElementById('letter-list-view').style.display = 'flex';
    renderLetterList(); 
}
function deleteCurrentLetter() {
    if (!currentLetterId) return;
    
    if (confirm("Á°ÆÂÆöË¶ÅÈîÄÊØÅËøôÂ∞Å‰ø°ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ")) {
        let letters = getLetters();
        letters = letters.filter(l => l.id !== currentLetterId);
        saveLetters(letters);
        backToLetterList();
    }
}

let currentTheaterId = null; 
let theaterTheme = 'day';   
async function openTheaterApp() {
    const modal = document.getElementById('theater-modal');
    modal.style.display = 'flex';
    
    const history = await getTheaterHistory();
    if (!currentTheaterId) {
        if (history.length > 0) {
            await loadTheater(history[0].id);
        } else {
            await startNewTheater(); 
        }
    } else {
        await renderTheaterContent();
    }
}

function closeTheaterApp() {
    document.getElementById('theater-modal').style.display = 'none';
}
function toggleTheaterTheme() {
    const modal = document.getElementById('theater-modal');
    modal.classList.remove('theater-theme-day', 'theater-theme-night', 'theater-theme-green');

    if (theaterTheme === 'day') {
        theaterTheme = 'night';
        modal.classList.add('theater-theme-night');
    } else if (theaterTheme === 'night') {
        theaterTheme = 'green';
        modal.classList.add('theater-theme-green');
    } else {
        theaterTheme = 'day';
        modal.classList.add('theater-theme-day');
    }
}
async function getTheaterHistory() {
    try {
        const res = await idb.get('theater_data', 'history_list');
        if (!res) {
            const old = JSON.parse(localStorage.getItem('theater_list') || '[]');
            if (old.length > 0) {
                await saveTheaterHistory(old); 
                console.log("Â∑≤Â∞ÜÊóßÂâßÊú¨ÁõÆÂΩïËøÅÁßªËá≥Â§ßÂÆπÈáèÊï∞ÊçÆÂ∫ì");
            }
            return old;
        }
        return res.data;
    } catch(e) { return []; }
}

async function saveTheaterHistory(list) {
    await idb.put('theater_data', { id: 'history_list', data: list });
    localStorage.removeItem('theater_list');
}

async function getTheaterContent(id) {
    try {
        const res = await idb.get('theater_data', `content_${id}`);
        if (!res) {
            const old = JSON.parse(localStorage.getItem(`theater_content_${id}`) || '[]');
            if (old.length > 0) {
                await saveTheaterContent(id, old);
                console.log(`Â∑≤Â∞ÜÂâßÊú¨[${id}]ÂÜÖÂÆπËøÅÁßªËá≥Â§ßÂÆπÈáèÊï∞ÊçÆÂ∫ì`);
            }
            return old;
        }
        return res.data;
    } catch(e) { return []; }
}

async function saveTheaterContent(id, content) {
    await idb.put('theater_data', { id: `content_${id}`, data: content });
    localStorage.removeItem(`theater_content_${id}`);
}
async function startNewTheater() {
    const id = Date.now().toString();
    const list = await getTheaterHistory();
    
    const newBook = {
        id: id,
        title: "Êñ∞ÁØáÁ´† " + new Date().toLocaleDateString(),
        date: Date.now(),
        preview: "Á≠âÂæÖ‰π¶ÂÜô..."
    };
    
    list.unshift(newBook);
    await saveTheaterHistory(list);
    await saveTheaterContent(id, []); 
    
    currentTheaterId = id;
    await renderTheaterContent();
    const panel = document.getElementById('theater-history-panel');
    if (panel.classList.contains('open')) panel.classList.remove('open');
}
async function loadTheater(id) {
    currentTheaterId = id;
    await renderTheaterContent();
    document.getElementById('theater-history-panel').classList.remove('open');
}
async function renderTheaterContent() {
    if (!currentTheaterId) return;
    const content = await getTheaterContent(currentTheaterId);
    const container = document.getElementById('theater-content-list');
    container.innerHTML = '';

    if (content.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; margin-top:100px; opacity:0.6;">
                <div style="font-size:3rem; margin-bottom:10px;">‚úíÔ∏è</div>
                <p>Âú®‰∏ãÊñπËæìÂÖ•Á¨¨‰∏ÄÊÆµÊåáÂºï<br>ÂºÄÂßã‰Ω†ÁöÑÊïÖ‰∫ã</p>
            </div>`;
        return;
    }

    content.forEach((segment, index) => {
        const div = document.createElement('div');
        div.className = 'novel-segment';
        let htmlText = segment.text.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('');
        
        if (segment.role === 'user') {
            div.style.borderLeft = "3px solid var(--th-accent)";
            div.style.paddingLeft = "10px";
            div.style.fontSize = "0.95rem";
            div.style.opacity = "0.8";
            div.innerHTML = `<strong>[Êåá‰ª§]</strong> ${htmlText}`;
        } else {
            div.innerHTML = htmlText;
        }

        const delBtn = document.createElement('div');
        delBtn.className = 'segment-del-btn';
        delBtn.innerText = 'üóëÔ∏è Âà†Èô§Êú¨ÊÆµ';
        delBtn.onclick = () => deleteTheaterSegment(index);
        
        div.appendChild(delBtn);
        container.appendChild(div);
    });

    setTimeout(() => {
        const area = document.getElementById('theater-scroll-area');
        area.scrollTop = area.scrollHeight;
    }, 100);
}
async function deleteTheaterSegment(index) {
    if (!confirm("Á°ÆÂÆöÂà†Èô§Ëøô‰∏ÄÊÆµÂÜÖÂÆπÂêóÔºü")) return;
    const content = await getTheaterContent(currentTheaterId);
    content.splice(index, 1);
    await saveTheaterContent(currentTheaterId, content);
    await renderTheaterContent();
}
async function toggleTheaterHistory() {
    const panel = document.getElementById('theater-history-panel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        await renderTheaterHistoryList();
    }
}

async function renderTheaterHistoryList() {
    const list = await getTheaterHistory();
    const container = document.getElementById('theater-history-list');
    container.innerHTML = '';
    
    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.cursor = 'pointer';
        if (item.id === currentTheaterId) div.style.border = "2px solid var(--th-accent)";
        
        div.innerHTML = `
            <div style="font-weight:bold; font-size:1rem;">${item.title}</div>
            <div style="font-size:0.8rem; color:#888; margin-top:5px;">${new Date(item.date).toLocaleDateString()}</div>
            <div style="display:flex; justify-content:flex-end; margin-top:5px;">
                <button class="m-btn small" onclick="event.stopPropagation(); deleteTheaterBook(${index})" style="background:#ff6b6b; color:white;">Âà†Èô§</button>
            </div>
        `;
        div.onclick = () => loadTheater(item.id);
        container.appendChild(div);
    });
}

async function deleteTheaterBook(index) {
    if (!confirm("Âà†Èô§Êï¥Êú¨ÂâßÊú¨Ôºü‰∏çÂèØÊÅ¢Â§ç„ÄÇ")) return;
    const list = await getTheaterHistory();
    const id = list[index].id;
    await idb.delete('theater_data', `content_${id}`);
    
    list.splice(index, 1);
    await saveTheaterHistory(list);
    
    if (id === currentTheaterId) {
        currentTheaterId = null;
        document.getElementById('theater-content-list').innerHTML = '';
    }
    await renderTheaterHistoryList();
}
async function generateTheaterSegment() {
    const inputEl = document.getElementById('th-input');
    const userText = inputEl.value.trim();
    const currentContent = await getTheaterContent(currentTheaterId);

    if (!userText && currentContent.length === 0) {
        return alert("ËØ∑ÂÖàËæìÂÖ•ÂºÄÁØáËÆæÂÆöÊàñÁ¨¨‰∏ÄÂè•ËØù„ÄÇ");
    }

    const btn = document.getElementById('btn-th-gen');
    const scrollArea = document.getElementById('theater-scroll-area');
    const originalBtnText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "ÁîüÊàê‰∏≠...";
    
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'th-loading';
    loadingDiv.innerText = "Ê≠£Âú®ÊûÑÊÄùÂâßÊÉÖ (Hidden CoT running)...";
    document.getElementById('theater-content-list').appendChild(loadingDiv);
    scrollArea.scrollTop = scrollArea.scrollHeight;

    const wb = getWBData();
    let worldContext = "";
    if (document.getElementById('th-use-global').checked) {
        worldContext += "„Äê‰∏ñÁïåËßÇ(ÂÖ®Â±Ä)„Äë:\n" + ((wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) + "\n";
    }
    if (document.getElementById('th-use-theater').checked) {
        worldContext += "„ÄêÂâßÂú∫ËÆæÂÆö„Äë:\n" + ((wb['2.Â∞èÂâßÂú∫'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) + "\n";
    }

    const recentHistory = currentContent.slice(-20).map(h => {
        return h.role === 'user' ? `[Áî®Êà∑Êåá‰ª§]: ${h.text}` : `[Â∞èËØ¥Ê≠£Êñá]: ${h.text}`;
    }).join("\n\n");

    const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÈ°∂Á∫ßÁöÑËΩªÂ∞èËØ¥‰ΩúÂÆ∂„ÄÇ
‰Ω†Ê≠£Âú®‰∏éÁî®Êà∑ÂÖ±ÂêåÂàõ‰Ωú‰∏ÄÈÉ®Â∞èËØ¥„ÄÇ

„Äê‰∏ñÁïåËÆæÂÆö„Äë
${worldContext}

„ÄêÊ†∏ÂøÉËßÑÂàô„Äë
1. **ËßÜËßí‰∏•Ê†ºÈôêÂà∂**Ôºö
   - ÂØπÁî®Êà∑ÔºàUserÔºâÂøÖÈ°ª‰ΩøÁî®**Á¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚Äù**„ÄÇ
   - ÂØπÂÖ∂‰ªñÊâÄÊúâËßíËâ≤‰ΩøÁî®**Á¨¨‰∏â‰∫∫Áß∞ÊúâÈôêËßÜËßí**„ÄÇ
2. **ÁªùÂØπÁ¶Å‰ª§**Ôºö
   - **ÁªùÂØπÁ¶ÅÊ≠¢**ÊèèÂÜô‚Äú‰Ω†‚ÄùÔºàÁî®Êà∑ÔºâÊ≤°ÊúâÊòéÁ°ÆËæìÂÖ•ÁöÑËØ≠Ë®Ä„ÄÅÂä®‰Ωú„ÄÅÂøÉÁêÜÊ¥ªÂä®„ÄÇ
   - Â¶ÇÊûúÁî®Êà∑Ê≤°ÊúâËæìÂÖ•Âä®‰ΩúÔºåËØ∑ÊèèÂÜôÁéØÂ¢ÉÂèòÂåñ„ÄÅNPCÁöÑ‰∏ªÂä®Ë°å‰∏∫„ÄÅÊàñËÄÖÁ™ÅÂèë‰∫ã‰ª∂ÔºåÁÑ∂Âêé**ÂÅú‰∏ãÊù•Á≠âÂæÖÁî®Êà∑ÁöÑÂèçÂ∫î**„ÄÇ
3. **ÂÜô‰ΩúÈ£éÊ†º**Ôºö
   - ËΩªÂ∞èËØ¥È£éÊ†ºÔºàLight NovelÔºâ„ÄÇ
   - Ê≥®ÈáçÁéØÂ¢ÉÊèèÂÜô„ÄÅNPCÁöÑÂæÆË°®ÊÉÖ„ÄÅÊ∞õÂõ¥Ê∏≤Êüì„ÄÇ
   - **ÈïøÊñáËæìÂá∫**ÔºöËØ∑Â∞ΩÂèØËÉΩËØ¶ÁªÜÔºåÊØèÊ¨°ËæìÂá∫‰∏çÂ∞ë‰∫é3000Ê±âÂ≠ó„ÄÇ
4. **ÊÄùÁª¥Èìæ**Ôºö
   - Âú®ÁîüÊàêÊ≠£ÊñáÂâçÔºå‰Ω†ÂèØ‰ª•ÂÖàÂú®ÂÜÖÂøÉÊÄùËÄÉÂâßÊÉÖËµ∞ÂêëÔºå‰ΩÜËøôÈÉ®ÂàÜ‰∏çÈúÄË¶ÅËæìÂá∫ÁªôÁî®Êà∑„ÄÇ

„ÄêÂΩìÂâçÁî®Êà∑Êåá‰ª§„Äë
${userText || "ÔºàÁî®Êà∑Á§∫ÊÑèÁªßÁª≠ÂâßÊÉÖÔºåËØ∑Ê†πÊçÆ‰∏ä‰∏ãÊñáËá™ÁÑ∂Áª≠ÂÜôÔºâ"}`;

    let apiKey = "", apiUrl = "", model = "";
    try {
        const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        apiKey = s.key; apiUrl = s.url; model = s.model;
    } catch(e){}
    if (!apiKey) apiKey = document.getElementById('api-key').value;
    if (!apiUrl) apiUrl = document.getElementById('api-url').value;
    if (!model) model = document.getElementById('model-select').value;

    if (!apiKey) {
        loadingDiv.remove();
        btn.disabled = false; btn.innerText = originalBtnText;
        return alert("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    }

    if (apiUrl && apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `„ÄêÂâçÊñáÂõûÈ°æ„Äë\n${recentHistory}\n\n„ÄêÊúÄÊñ∞Êåá‰ª§„Äë\n${userText}` }
                ],
                temperature: 0.8
            })
        });

        const json = await res.json();
        if (json.error) throw new Error(json.error.message || "API Error");
        if (!json.choices || json.choices.length === 0) throw new Error("API ËøîÂõûÁ©∫ÂÜÖÂÆπ");
        
        const aiText = json.choices[0].message.content;
        if (userText) currentContent.push({ role: 'user', text: userText });
        currentContent.push({ role: 'ai', text: aiText });
        await saveTheaterContent(currentTheaterId, currentContent);
        const list = await getTheaterHistory();
        const listItem = list.find(i => i.id === currentTheaterId);
        if (listItem) {
            listItem.preview = aiText.substring(0, 30) + "...";
            await saveTheaterHistory(list);
        }

        loadingDiv.remove();
        await renderTheaterContent();
        inputEl.value = '';

    } catch (e) {
        console.error(e);
        loadingDiv.innerText = "ÁîüÊàêÂ§±Ë¥•: " + e.message;
        loadingDiv.style.color = "red";
    } finally {
        btn.disabled = false;
        btn.innerText = originalBtnText;
    }
}

let currentForumId = null; 
async function openForumApp() {
    document.getElementById('forum-modal').style.display = 'flex';
    
    const history = await getForumHistory();
    if (!currentForumId) {
        if (history.length > 0) {
            await loadForum(history[0].id);
        } else {
            document.getElementById('forum-content-container').innerHTML = `
                <div style="text-align:center; margin-top:100px; color:#999;">
                    <div style="font-size:3rem; opacity:0.3;">üí¨</div>
                    <p>ËæìÂÖ•ÂÖ≥ÈîÆËØçÔºåÁîüÊàêËÆ∫Âùõ‰ΩìÂ∞èËØ¥<br>ÊØèÊ¨°ÁîüÊàêÁ∫¶20-40Ê•ºÔºåÊîØÊåÅÊó†ÈôêÁª≠ÂÜô</p>
                </div>`;
        }
    } else {
        await renderForumContent();
    }
}

function closeForumApp() {
    document.getElementById('forum-modal').style.display = 'none';
}
async function getForumHistory() {
    try {
        const res = await idb.get('forum_data', 'history_list');
        return res ? res.data : [];
    } catch(e) { return []; }
}

async function saveForumHistory(list) {
    await idb.put('forum_data', { id: 'history_list', data: list });
}

async function getForumContent(id) {
    try {
        const res = await idb.get('forum_data', `thread_${id}`);
        return res ? res.data : null; // data ÁªìÊûÑ: { title, posts: [] }
    } catch(e) { return null; }
}

async function saveForumContent(id, data) {
    await idb.put('forum_data', { id: `thread_${id}`, data: data });
}
async function startNewForum() {
    currentForumId = null;
    document.getElementById('forum-input').value = '';
    document.getElementById('forum-content-container').innerHTML = `
        <div style="text-align:center; margin-top:100px; color:#999;">
            <div style="font-size:3rem; opacity:0.3;">üí¨</div>
            <p>ÂáÜÂ§áÂ∞±Áª™„ÄÇ<br>ËæìÂÖ•Ê†áÈ¢òÊàñÊ¢óÊ¶ÇÂºÄÂßãÂèëÂ∏ñ„ÄÇ</p>
        </div>`;
    document.getElementById('forum-history-panel').classList.remove('open');
}
async function loadForum(id) {
    currentForumId = id;
    await renderForumContent();
    document.getElementById('forum-history-panel').classList.remove('open');
}
async function renderForumContent() {
    if (!currentForumId) return;
    const thread = await getForumContent(currentForumId);
    if (!thread) return;

    const container = document.getElementById('forum-content-container');
    container.innerHTML = '';
    const header = document.createElement('div');
    header.className = 'forum-thread-header';
    header.innerHTML = `<div class="forum-title-text">${thread.title}</div>`;
    container.appendChild(header);
    thread.posts.forEach((post, index) => {
        const row = document.createElement('div');
        row.className = 'forum-post-row';
        let avatarHtml = '';
        if (index === 0) {
            const avatarColor = stringToColor(post.name);
            avatarHtml = `
            <div class="forum-avatar" style="background-color:${avatarColor}; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:1.2rem;">
                ${post.name[0]}
            </div>`;
        }
        
        const isLZ = (post.name === thread.lzName) || (index === 0);
        
        row.innerHTML = `
            ${avatarHtml} 
            <div class="forum-content-col">
                <div class="forum-user-line">
                    <div>
                        <span class="forum-username">${post.name}</span>
                        ${isLZ ? '<span class="forum-lz-tag">Ê•º‰∏ª</span>' : ''}
                    </div>
                    <span class="forum-floor-num">${index + 1}Ê•º</span>
                </div>
                <div class="forum-text-body">${post.content}</div>
                <div class="forum-action-bar">
                    <span class="forum-icon-btn">üëç ${Math.floor(Math.random()*100)}</span>
                    <span class="forum-icon-btn">üí¨ ÂõûÂ§ç</span>
                    <span class="forum-icon-btn" style="color:#ff6b6b; font-size:0.7rem; margin-left:auto;" onclick="deleteForumPost(${index})">Âà†Èô§</span>
                </div>
            </div>
        `;
        container.appendChild(row);
    });
    setTimeout(() => {
        const area = document.getElementById('forum-scroll-area');
        area.scrollTop = area.scrollHeight;
    }, 100);
}
function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return '#' + "00000".substring(0, 6 - c.length) + c;
}
async function deleteForumPost(index) {
    if(!confirm("Âà†Èô§Ê≠§Ê•ºÂ±ÇÔºü")) return;
    const thread = await getForumContent(currentForumId);
    thread.posts.splice(index, 1);
    await saveForumContent(currentForumId, thread);
    await renderForumContent();
}
function toggleForumHistory() {
    const panel = document.getElementById('forum-history-panel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) renderForumHistoryList();
}

async function renderForumHistoryList() {
    const list = await getForumHistory();
    const container = document.getElementById('forum-history-list');
    container.innerHTML = '';
    
    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.cursor = 'pointer';
        if (item.id === currentForumId) div.style.border = "2px solid #00d2d3";
        
        div.innerHTML = `
            <div style="font-weight:bold; font-size:1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title}</div>
            <div style="font-size:0.8rem; color:#888; margin-top:5px;">${new Date(item.date).toLocaleDateString()}</div>
            <div style="display:flex; justify-content:flex-end; margin-top:5px;">
                <button class="m-btn small" onclick="event.stopPropagation(); deleteForumThread(${index})" style="background:#ff6b6b; color:white;">Âà†Èô§</button>
            </div>
        `;
        div.onclick = () => loadForum(item.id);
        container.appendChild(div);
    });
}

async function deleteForumThread(index) {
    if(!confirm("Âà†Èô§Êï¥‰∏™Â∏ñÂ≠êÔºü")) return;
    const list = await getForumHistory();
    const id = list[index].id;
    await idb.delete('forum_data', `thread_${id}`);
    list.splice(index, 1);
    await saveForumHistory(list);
    if(id === currentForumId) startNewForum();
    renderForumHistoryList();
}
async function generateForumThread() {
    const inputEl = document.getElementById('forum-input');
    const userText = inputEl.value.trim();
    const btn = document.getElementById('btn-forum-gen');
    const roleType = document.getElementById('forum-role-select').value; 
    let isContinuation = !!currentForumId;
    let currentThread = isContinuation ? await getForumContent(currentForumId) : null;

    if (!isContinuation && !userText) {
        return alert("Êñ∞Â∏ñÂ≠êÂøÖÈ°ªËæìÂÖ•Ê†áÈ¢òÊàñÂÜÖÂÆπÊ¢óÊ¶ÇÔºÅ");
    }

    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "ÁîüÊàê‰∏≠(ËæÉÊÖ¢)...";

    // „ÄêÈò≤Âç°Ê≠ª 1„ÄëÂº∫Âà∂Á≠âÂæÖ 50msÔºåËÆ© UI ÂÖàÊ∏≤ÊüìÂá∫‚ÄúÁîüÊàê‰∏≠‚ÄùÁä∂ÊÄÅÔºåÈÅøÂÖçÁÇπÂáªÁû¨Èó¥ÊµèËßàÂô®ÂÜªÁªì
    await new Promise(r => setTimeout(r, 50));

    // --- ‰ª•‰∏ã‰øùÊåÅÂéüÁîüÊàêÈÄªËæë ---
    const wb = getWBData();
    let context = "";
    if(document.getElementById('forum-use-global').checked) {
        context += "„Äê‰∏ñÁïåËßÇ(ÂÖ®Â±Ä)„Äë:\n" + ((wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) + "\n";
    }
    if(document.getElementById('forum-use-forum').checked) {
        context += "„ÄêËÆ∫Âùõ‰ΩìËÆæÂÆö„Äë:\n" + ((wb['7.ËÆ∫Âùõ‰Ωì'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) + "\n";
    }
    
    let previousContext = "";
    if (isContinuation && currentThread) {
        const lastPosts = currentThread.posts.slice(-15); // ÂèñÊúÄÂêé15Êù°‰∏ä‰∏ãÊñá
        previousContext = "„ÄêÂâçÊñáÊëòË¶Å„Äë:\nÂ∏ñÂ≠êÊ†áÈ¢òÔºö" + currentThread.title + "\n";
        previousContext += lastPosts.map((p,i) => `[${p.name}]: ${p.content}`).join("\n");
        previousContext += "\n(ËØ∑Êé•Áª≠‰∏äÈù¢ÁöÑËÆ®ËÆ∫Ôºå‰∏çË¶ÅÈáçÂ§ç)";
    }

    const modePrompt = roleType === 'user' 
        ? "Ê•º‰∏ªÊòØ„Äê‰∏ªËßí/Áî®Êà∑Ëá™Â∑±„ÄëÔºåËØ∑ÂèëÂ∏ñÊ±ÇÂä©ÊàñÂêêÊßΩÔºåÂºïÂèëË∑Ø‰∫∫Âõ¥ËßÇ„ÄÇ" 
        : "Ê•º‰∏ªÊòØ„ÄêNPC/Ë∑Ø‰∫∫„ÄëÔºåÊ≠£Âú®ËÆ®ËÆ∫ÂÖ≥‰∫é‰∏ªËßíÊàñ‰∏ñÁïåËßÇÂèëÁîüÁöÑÂÖ´Âç¶/‰∫ã‰ª∂„ÄÇ";

    // ‰øùÊåÅÂéü Prompt Ê†∏ÂøÉ
    const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™ËÆ∫Âùõ‰ΩìÂ∞èËØ¥ÁîüÊàêÂô®„ÄÇ
${context}

„Äê‰ªªÂä°„Äë
Ê†πÊçÆÁî®Êà∑ËæìÂÖ•ÔºåÁîüÊàê‰∏Ä‰∏™ÈÄºÁúüÁöÑËÆ∫ÂùõÂ∏ñÂ≠ê„ÄÇ
È£éÊ†ºË¶ÅÊ±ÇÔºöÁΩëÁªúÁî®ËØ≠„ÄÅÁé©Ê¢ó„ÄÅÁîöËá≥ÊúâÊù†Á≤æ„ÄÅ‰∏çÂêåÁ´ãÂú∫ÁöÑË∑Ø‰∫∫„ÄÇ
${modePrompt}

„ÄêÊ†ºÂºèË¶ÅÊ±Ç„Äë
**ÂøÖÈ°ª**‰∏•Ê†ºËæìÂá∫ JSON Êï∞ÁªÑÊ†ºÂºèÔºå‰∏çË¶ÅÂåÖÂê´Markdown‰ª£Á†ÅÂùóÊ†áËÆ∞„ÄÇ
ÁªìÊûÑÂ¶Ç‰∏ãÔºö
[
  {"name": "Ê•º‰∏ªID", "content": "‰∏ªÊ•ºÂÜÖÂÆπ..."},
  {"name": "Ë∑Ø‰∫∫A", "content": "ÂõûÂ§çÂÜÖÂÆπ..."},
  ...
]

„ÄêÊï∞ÈáèË¶ÅÊ±Ç„Äë
**ËØ∑Â∞ΩÂäõ‰∏ÄÊ¨°ÊÄßÁîüÊàê‰∏çÂ∞ë‰∫é 20 ‰∏™ÂõûÂ§çÔºàÊ•ºÂ±ÇÔºâ**„ÄÇÂ¶ÇÊûúËØùÈ¢òÁÅ´ÁàÜÔºåÂÜÖÂÆπË¶Å‰∏∞ÂØåÔºåÁîöËá≥ÂåÖÂê´ÊíïÈÄº„ÄÅÊ≠™Ê•º„ÄÇ`;

    let apiKey = "", apiUrl = "", model = "";
    try {
        const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        apiKey = s.key; apiUrl = s.url; model = s.model;
    } catch(e){}
    if (!apiKey) apiKey = document.getElementById('api-key').value;
    if (!apiUrl) apiUrl = document.getElementById('api-url').value;
    if (!model) model = document.getElementById('model-select').value;

    if (!apiKey) {
        btn.disabled = false; btn.innerText = originalText;
        return alert("API Key Êú™ÈÖçÁΩÆÔºÅ");
    }

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `${previousContext}\n\n„ÄêÊú¨Ê¨°Êåá‰ª§„Äë: ${userText || "ÁªßÁª≠ÁÉ≠ÁÉàËÆ®ËÆ∫ÔºåÂ¢ûÂä†Êõ¥Â§öÊ•ºÂ±Ç"}` }
                ],
                temperature: 0.8,
                max_tokens: 3500
            })
        });

        const json = await res.json();
        let raw = json.choices[0].message.content;

        // „ÄêJSON Â¢ûÂº∫ÈÄªËæë 1„ÄëÊ∏ÖÊ¥ó Markdown Ê†áËÆ∞
        raw = raw.replace(/```json/gi, "").replace(/```/g, "").trim();

        // „ÄêJSON Â¢ûÂº∫ÈÄªËæë 2„ÄëÂØªÊâæÊï∞ÁªÑËæπÁïå (Èò≤Ê≠¢ AI Âú® JSON ÂâçÂêéËØ¥Â∫üËØù)
        const firstBracket = raw.indexOf('[');
        const lastBracket = raw.lastIndexOf(']');
        
        if (firstBracket !== -1 && lastBracket !== -1) {
            raw = raw.substring(firstBracket, lastBracket + 1);
        } else if (raw.startsWith('{')) {
            // Â¶ÇÊûú AI Âè™ÁîüÊàê‰∫Ü‰∏Ä‰∏™ÂØπË±°ËÄå‰∏çÊòØÊï∞ÁªÑÔºåÂº∫Âà∂ÂåÖË£π
            raw = `[${raw}]`;
        }

        let newPosts = [];
        try {
            newPosts = JSON.parse(raw);
        } catch(e) {
            console.warn("JSONËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØï‰øÆÂ§ç...", e);
            // „ÄêJSON Â¢ûÂº∫ÈÄªËæë 3„ÄëÁªàÊûÅÂÖúÂ∫ïÔºöÂ¶ÇÊûúËß£ÊûêËøòÊòØÂ§±Ë¥•ÔºåÊääÂéüÂßãÂÜÖÂÆπ‰Ωú‰∏∫‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÊòæÁ§∫Âá∫Êù•ÔºåÈò≤Ê≠¢Áî®Êà∑ÁôΩÁ≠â
            newPosts = [{
                name: "System_Error", 
                content: "Ëß£ÊûêÊ†ºÂºèÂá∫ÈîôÔºåÂéüÂßãËøîÂõûÂ¶Ç‰∏ãÔºö\n" + raw.substring(0, 200) + "..."
            }];
        }

        // ‰øùÂ≠òÈÄªËæë‰øùÊåÅ‰∏çÂèò
        if (!isContinuation) {
            const id = Date.now().toString();
            const title = userText.substring(0, 20) + (userText.length>20?"...":"");
            const lzName = newPosts.length > 0 ? newPosts[0].name : "ÂåøÂêçÁî®Êà∑";
            
            const newThread = { id: id, title: title, lzName: lzName, posts: newPosts };
            await saveForumContent(id, newThread);
            
            const list = await getForumHistory();
            list.unshift({ id: id, title: title, date: Date.now() });
            await saveForumHistory(list);
            currentForumId = id;
        } else {
            currentThread.posts = currentThread.posts.concat(newPosts);
            await saveForumContent(currentForumId, currentThread);
        }
        inputEl.value = ''; 
        await renderForumContent();

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
}
const DEFAULT_FRIDGE = {
    condiments: {
        "ËÄóÊ≤π": false, "ÁîüÊäΩ": false, "Áõê": false, "Á≥ñ": false, 
        "ÈÜã": false, "ÊñôÈÖí": false, "Ê≤π": false
    },
    staples: {
        "Á±≥": false, 
        "Èù¢": null, // nullË°®Á§∫Êó†ÔºåÂ≠óÁ¨¶‰∏≤Ë°®Á§∫Êï∞ÈáèÊèèËø∞
        "Èù¢ÂåÖ": null 
    },
    vegetables: [], //Array of {name, count}
    meat: []        //Array of {name, count}
};
const CONDIMENT_ICONS = {
    "ËÄóÊ≤π": "ü´ô", "ÁîüÊäΩ": "üçæ", "Áõê": "üßÇ", "Á≥ñ": "üç¨",
    "ÈÜã": "üè∫", "ÊñôÈÖí": "üç∂", "Ê≤π": "üõ¢Ô∏è"
};

function getFridgeData() {
    return JSON.parse(localStorage.getItem('fridge_data') || JSON.stringify(DEFAULT_FRIDGE));
}
function saveFridgeData(data) {
    localStorage.setItem('fridge_data', JSON.stringify(data));
}
function openFridgeApp() {
    document.getElementById('fridge-modal').style.display = 'flex';
    renderFridgeContent();
}
function closeFridgeApp() {
    document.getElementById('fridge-modal').style.display = 'none';
}
function renderFridgeContent() {
    const data = getFridgeData();
    const s1 = document.getElementById('new-shelf-condiments');
    s1.innerHTML = '';

    // === üßÇ Ëé´ÂÖ∞Ëø™Ëâ≤Á≥ªÈÖçÁΩÆË°® (Êó†Ê†áÁ≠æÁâà) ===
    // type: bottle(ÁªÜÁì∂), fat(Ê≤πÊ°∂), jar(ÁΩêÂ≠ê), shaker(Á†îÁ£®Áì∂), oyster(Ê≥µÂ§¥Áì∂)
    const BOTTLE_CONFIG = {
        // ËÄóÊ≤πÔºöÊ∑±Ë§êËâ≤Ê∂≤‰ΩìÔºåÁ∫¢Ê£ïËâ≤Ê≥µÂ§¥
        "ËÄóÊ≤π": { type: "oyster", liquid: "#4e342e", cap: "#8d6e63" },
        // ÁîüÊäΩÔºöÈÄöÈÄèÁöÑÁ∫¢Ë§êËâ≤
        "ÁîüÊäΩ": { type: "bottle", liquid: "rgba(62, 39, 35, 0.9)", cap: "#d7ccc8" },
        // ËÄÅÊäΩÔºöÊµìÈÉÅÁöÑÊ∑±ÈªëËâ≤
        "ËÄÅÊäΩ": { type: "bottle", liquid: "#212121", cap: "#ef9a9a" },
        // ÈÜãÔºöÊ∑±Á¥´ÈªëËâ≤
        "ÈÜã":   { type: "bottle", liquid: "#263238", cap: "#37474f" },
        // ÊñôÈÖíÔºöÁê•ÁèÄËâ≤
        "ÊñôÈÖí": { type: "bottle", liquid: "rgba(255, 179, 0, 0.7)", cap: "#ffe082" },
        // Ê≤πÔºöÈáëÈªÑËâ≤ÔºåÂ∏¶ÊääÊâã
        "Ê≤π":   { type: "fat",    liquid: "rgba(253, 216, 53, 0.8)", cap: "#ffcc80" }, 
        // ÁõêÔºöÁ∫ØÁôΩÁ£®Á†Ç
        "Áõê":   { type: "jar",    liquid: "#f5f5f5", cap: "#b0bec5" },
        // Á≥ñÔºö‰π≥ÁôΩÁ£®Á†Ç
        "Á≥ñ":   { type: "jar",    liquid: "#fafafa", cap: "#ffcc80" },
        // ËÉ°Ê§íÔºöÈ´òÁ∫ßÁÅ∞
        "ËÉ°Ê§íÁ≤â":{ type: "shaker", liquid: "#cfd8dc", cap: "#546e7a" }
    };

    // Ê∏≤ÊüìË∞ÉÊñôÂå∫
    for (let [name, has] of Object.entries(data.condiments)) {
        // ÈªòËÆ§ÂÖúÂ∫ï
        const conf = BOTTLE_CONFIG[name] || { type: "jar", liquid: "#e0e0e0", cap: "#bdbdbd" };
        
        const div = document.createElement('div');
        div.className = `real-bottle-item ${has ? 'active' : ''} style-${conf.type}`;
        div.onclick = () => toggleCondiment(name);

        let innerHtml = '';

        // --- 1. Ê≤πÊ°∂ (Fat) - ÊúâÊääÊâã ---
        if (conf.type === 'fat') {
            innerHtml = `
                <div class="min-cap" style="background:${conf.cap}"></div>
                <div class="min-handle"></div>
                <div class="min-body fat">
                    <div class="min-liquid" style="background:${conf.liquid}; height:75%;"></div>
                    <div class="min-gloss"></div>
                </div>
            `;
        } 
        // --- 2. ÁªÜÈ´òÁéªÁíÉÁì∂ (Bottle) - ÈÖ±Ê≤π/ÈÜã ---
        else if (conf.type === 'bottle') {
            innerHtml = `
                <div class="min-cap small" style="background:${conf.cap}"></div>
                <div class="min-neck"></div>
                <div class="min-body tall">
                    <div class="min-liquid" style="background:${conf.liquid}; height:85%;"></div>
                    <div class="min-gloss"></div>
                </div>
            `;
        }
        // --- 3. ËÄóÊ≤πÁì∂ (Oyster) - Ê≥µÂ§¥ ---
        else if (conf.type === 'oyster') {
            innerHtml = `
                <div class="min-pump" style="background:${conf.cap}"></div>
                <div class="min-neck thick"></div>
                <div class="min-body tall oyster">
                    <div class="min-liquid" style="background:${conf.liquid}; height:90%;"></div>
                    <div class="min-gloss"></div>
                </div>
            `;
        }
        // --- 4. ÁüÆÁΩê (Jar) - Áõê/Á≥ñ ---
        else if (conf.type === 'jar') {
            innerHtml = `
                <div class="min-lid" style="background:${conf.cap}"></div>
                <div class="min-body jar">
                    <div class="min-liquid" style="background:${conf.liquid}; height:100%;"></div>
                    <div class="min-gloss"></div>
                </div>
            `;
        }
        // --- 5. Á†îÁ£®Áì∂ (Shaker) - ËÉ°Ê§í ---
        else if (conf.type === 'shaker') {
            innerHtml = `
                <div class="min-knob" style="background:${conf.cap}"></div>
                <div class="min-body shaker">
                    <div class="min-liquid" style="background:${conf.liquid}; height:70%;"></div>
                    <div class="min-gloss"></div>
                </div>
            `;
        }

        div.innerHTML = innerHtml + `<div class="b-name-text">${name}</div>`;
        s1.appendChild(div);
    }
    // === ‰ª•‰∏ã‰øùÊåÅÂéü‰ª£Á†Å‰∏çÂèòÔºåË¥üË¥£‰∏ªÈ£üÂíåÈ£üÊùêÁöÑÊ∏≤Êüì ===
    const s2 = document.getElementById('new-shelf-staples');
    s2.innerHTML = '';
    const riceDiv = document.createElement('div');
    riceDiv.className = `staple-icon-btn ${data.staples['Á±≥'] ? 'active' : ''}`;
    riceDiv.innerHTML = `<div class="staple-img">üçö</div>${data.staples['Á±≥'] ? '<div class="staple-badge">Êúâ</div>' : ''}<div class="staple-label">Á±≥È•≠</div>`;
    riceDiv.onclick = () => toggleRice();
    s2.appendChild(riceDiv);

    const noodleDiv = document.createElement('div');
    const hasNoodle = !!data.staples['Èù¢'];
    noodleDiv.className = `staple-icon-btn ${hasNoodle ? 'active' : ''}`;
    noodleDiv.innerHTML = `<div class="staple-img">üçú</div>${hasNoodle ? `<div class="staple-badge">${data.staples['Èù¢']}</div>` : ''}<div class="staple-label">Èù¢Êù°</div>`;
    noodleDiv.onclick = () => editStaple('Èù¢', 'ËØ∑ËæìÂÖ•Èù¢ÁöÑÊï∞Èáè (Â¶Ç: 4Êää)');
    s2.appendChild(noodleDiv);

    const breadDiv = document.createElement('div');
    const hasBread = !!data.staples['Èù¢ÂåÖ'];
    breadDiv.className = `staple-icon-btn ${hasBread ? 'active' : ''}`;
    breadDiv.innerHTML = `<div class="staple-img">üçû</div>${hasBread ? `<div class="staple-badge">${data.staples['Èù¢ÂåÖ']}</div>` : ''}<div class="staple-label">Èù¢ÂåÖ</div>`;
    breadDiv.onclick = () => editStaple('Èù¢ÂåÖ', 'ËØ∑ËæìÂÖ•Èù¢ÂåÖÊï∞Èáè', true);
    s2.appendChild(breadDiv);

    renderNewTags('new-shelf-veg', data.vegetables, 'veg');
    renderNewTags('new-shelf-meat', data.meat, 'meat');
}

function renderNewTags(containerId, list, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    list.forEach((item, index) => {
        const tag = document.createElement('div');
        tag.className = 'ing-tag-pill';
        tag.innerHTML = `
            <span>${item.name}</span>
            <span class="count">${item.count}</span>
            <span class="del-x" onclick="event.stopPropagation(); editIngredient('${type}', ${index})">√ó</span>
        `;
        container.appendChild(tag);
    });
    const addBtn = document.createElement('div');
    addBtn.className = 'add-circle-btn';
    addBtn.innerText = '+';
    addBtn.onclick = () => addIngredient(type);
    container.appendChild(addBtn);
}
function toggleCondiment(name) {
    const data = getFridgeData();
    data.condiments[name] = !data.condiments[name];
    saveFridgeData(data);
    renderFridgeContent();
}

function toggleRice() {
    const data = getFridgeData();
    data.staples['Á±≥'] = !data.staples['Á±≥'];
    saveFridgeData(data);
    renderFridgeContent();
}

function editStaple(key, promptText, isNumber = false) {
    const data = getFridgeData();
    const current = data.staples[key];
    if (current) {
        if (confirm(`ÂΩìÂâç: ${current}„ÄÇË¶Å‰øÆÊîπÊï∞ÈáèÂêóÔºü(ÂèñÊ∂àÂàôÂà†Èô§)`)) {
            const val = prompt(promptText, current);
            if (val) data.staples[key] = val;
        } else {
            data.staples[key] = null; 
        }
    } else {
        const val = prompt(promptText);
        if (val) data.staples[key] = val;
    }
    saveFridgeData(data);
    renderFridgeContent();
}

function addIngredient(type) {
    const name = prompt("ËØ∑ËæìÂÖ•È£üÊùêÂêçÂ≠ó:");
    if (!name) return;
    const count = prompt("Êï∞Èáè/ÈáçÈáè:", "1");
    if (!count) return;

    const data = getFridgeData();
    const list = type === 'veg' ? data.vegetables : data.meat;
    list.push({ name, count });
    saveFridgeData(data);
    renderFridgeContent();
}

function editIngredient(type, index) {
    const data = getFridgeData();
    const list = type === 'veg' ? data.vegetables : data.meat;
    const item = list[index];

    if (confirm(`Ë¶ÅÂà†Èô§ ${item.name} ÂêóÔºü\nÁÇπÂáª[ÂèñÊ∂à]‰ªÖ‰øÆÊîπÊï∞Èáè„ÄÇ`)) {
        list.splice(index, 1);
    } else {
        const newCount = prompt(`‰øÆÊîπ ${item.name} ÁöÑÊï∞Èáè:`, item.count);
        if (newCount) item.count = newCount;
    }
    saveFridgeData(data);
    renderFridgeContent();
}

async function startWeChatCall() {
    const data = getFridgeData();
    const hasStaple = Object.values(data.staples).some(v => v);
    const hasIng = data.vegetables.length > 0 || data.meat.length > 0;
    
    if (!hasStaple && !hasIng) {
        return alert("ÂÜ∞ÁÆ±Á©∫Á©∫Â¶Ç‰πüÔºåÂ∑ßÂ¶áÈöæ‰∏∫Êó†Á±≥‰πãÁÇäÂëÄÔºÅ(ËØ∑ÂÖàÊ∑ªÂä†È£üÊùê)");
    }
    const overlay = document.getElementById('wechat-call-overlay');
    overlay.style.display = 'flex';
    const heavy = await idb.get('settings_heavy', 'botAvatar');
    if (heavy && heavy.data) {
        document.getElementById('wx-call-avatar').style.backgroundImage = `url(${heavy.data})`;
    } else {
        document.getElementById('wx-call-avatar').style.backgroundColor = '#555'; 
    }
    const settings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    document.getElementById('wx-call-name').innerText = settings.title || "ÁßÅÂÆ∂Â§ßÂé®";
    const statusEl = document.getElementById('wx-call-status');
    const subEl = document.getElementById('wx-call-subtitle');
    statusEl.innerText = "Á≠âÂæÖÂØπÊñπÊé•Âê¨...";
    subEl.style.display = 'none';
    subEl.innerHTML = '';

    setTimeout(async () => {
        statusEl.innerText = "ÈÄöËØù‰∏≠ 00:01";
        let sec = 1;
        window.callTimerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec / 60).toString().padStart(2,'0');
            const s = (sec % 60).toString().padStart(2,'0');

            if(statusEl.innerText.includes("ÈÄöËØù‰∏≠")) {
                statusEl.innerText = `ÈÄöËØù‰∏≠ ${m}:${s}`;
            }
        }, 1000);
        const loadingTip = setTimeout(() => { statusEl.innerText = "ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉ..."; }, 500);
        
        await generateWeChatRecipe(data);
        
        clearTimeout(loadingTip);
        statusEl.innerText = `ÈÄöËØù‰∏≠ ${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;

    }, 1500); 
}
function endWeChatCall() {
    document.getElementById('wechat-call-overlay').style.display = 'none';
    if (window.callTimerInterval) clearInterval(window.callTimerInterval);
}
async function generateWeChatRecipe(fridgeData) {
    const subEl = document.getElementById('wx-call-subtitle'); 
    const condiments = Object.keys(fridgeData.condiments).filter(k => fridgeData.condiments[k]).join(', ');
    const staples = Object.keys(fridgeData.staples).filter(k => fridgeData.staples[k]).map(k => `${k}(${fridgeData.staples[k] || 'Êúâ'})`).join(', ');
    const veg = fridgeData.vegetables.map(i => `${i.name}x${i.count}`).join(', ');
    const meat = fridgeData.meat.map(i => `${i.name}x${i.count}`).join(', ');
    const wb = getWBData();
    let context = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const fridgeCtx = (wb['9.ÂÜ∞ÁÆ±'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n"); 
    let apiKey = "", apiUrl = "", model = "";
    try {
        const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        apiKey = s.key; apiUrl = s.url; model = s.model;
    } catch(e){}
    if (!apiKey) apiKey = document.getElementById('api-key').value;
    if (!apiUrl) apiUrl = document.getElementById('api-url').value;
    if (!model) model = document.getElementById('model-select').value;

    const currentCity = window.currentCity || "Êú™Áü•ÂüéÂ∏Ç";

    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®ÂíåÁî®Êà∑ÈÄöÁîµËØùÔºåÊåáÂØºÂ•πÂÅöÈ•≠„ÄÇ
ËØ∑ÊâÆÊºî‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤„ÄÇ
${context}
${fridgeCtx}

„ÄêÁî®Êà∑ÂÜ∞ÁÆ±Â∫ìÂ≠ò„Äë
Ë∞ÉÊñô: ${condiments}
‰∏ªÈ£ü: ${staples}
Ëî¨Ëèú: ${veg}
ËÇâÁ±ª: ${meat}
Áî®Êà∑‰ΩçÁΩÆ: ${currentCity}

„Äê‰ªªÂä°„Äë
1. **ËßíËâ≤ÊâÆÊºîÂØπËØù**Ôºö
   - Â∞±ÂÉèÂú®ÊâìÁîµËØù‰∏ÄÊ†∑ÔºåÊâãÊääÊâãÊïôÁî®Êà∑ÊÄé‰πàÂÅöËøôÈ°øÈ•≠ÔºàÈÄâ‰∏Ä‰∏™‰∏ªËèú+‰∏ªÈ£üÔºâ„ÄÇ
   - **Ë¥≠Áâ©Âª∫ËÆÆ**ÔºöÂú®ÂØπËØùËøáÁ®ã‰∏≠ÔºåËá™ÁÑ∂Âú∞Ê†πÊçÆÁî®Êà∑ÊâÄÂú®ÂüéÂ∏Ç(${currentCity})ÔºåÊèêÂà∞‰∏ãÊ¨°ÂèØ‰ª•Âéª‰π∞ÁÇπ‰ªÄ‰πàÈ£üÊùê‰ºöËÆ©È•≠Êõ¥Â•ΩÂêÉÔºåË¶ÅË°®Áé∞Âá∫ÂÖ≥ÂøÉ„ÄÇ
   - ËØ≠Ê∞îË¶ÅÂÆåÂÖ®Á¨¶Âêà‰∫∫ËÆæ„ÄÇ

2. **ÁÆÄÊòìÈ£üË∞±‰æøÁ≠æ**Ôºö
   - ËøôÊòØÁî®Êà∑ÊåÇÁîµËØùÂêéËÆ∞Âú®Á∫∏Êù°‰∏äÁöÑÂÜÖÂÆπ„ÄÇ
   - Âè™ÂåÖÂê´ÔºöËèúÂêç„ÄÅÊûÅÁÆÄÊ≠•È™§Ôºà1.2.3.Ôºâ„ÄÅÊâÄÈúÄÊùêÊñô„ÄÇ‰∏çË¶ÅÂ∫üËØù„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Ê†ºÂºèÔºö
{
  "dish_name": "ËèúÂêç",
  "dialogue": "ÂÆåÊï¥ÁöÑÈÄöËØùÂÜÖÂÆπÔºàÂåÖÂê´ÊïôÂ≠¶„ÄÅÂÖ≥ÂøÉÂíåË¥≠Áâ©Âª∫ËÆÆÔºâ...",
  "simple_recipe_note": "ÁÆÄÊòìÈ£üË∞±ÂÜÖÂÆπ"
}
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: "You are a helpful assistant." },
                    { role: "user", content: prompt }
                ],
                temperature: 0.7
            })
        });

        const json = await res.json();
        if (json.error) throw new Error(json.error.message);

        let raw = json.choices[0].message.content;
        raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();
        const result = JSON.parse(raw);
        
        saveFridgeHistory({
            dish_name: result.dish_name,
            dialogue: result.dialogue, 
            shopping_advice: result.simple_recipe_note 
        });

        alert(`‚úÖ ÁîüÊàêÂÆåÊØïÔºÅ\nÂ§ßÂé®ÁöÑ„Äê${result.dish_name}„ÄëÊïôÂ≠¶Â∑≤Ëá™Âä®Â≠òÂÖ•ÂÜ∞ÁÆ±ÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ`);

        if(document.getElementById('wechat-call-overlay').style.display !== 'none') {
            subEl.style.display = 'block';
            let i = 0;
            subEl.innerText = "";
            const txt = result.dialogue;
            
            const typeLoop = setInterval(() => {
                subEl.innerText += txt.charAt(i);
                subEl.scrollTop = subEl.scrollHeight; 
                i++;
                if (i >= txt.length) clearInterval(typeLoop);
            }, 70);
        }

    } catch(e) {
        console.error(e);
        if(document.getElementById('wechat-call-overlay').style.display !== 'none') {
            subEl.style.display = 'block';
            subEl.innerText = "‰ø°Âè∑‰∏≠Êñ≠: " + e.message;
        }
    }
}
function getFridgeHistory() {
    return JSON.parse(localStorage.getItem('fridge_history') || '[]');
}

function saveFridgeHistory(record) {
    const list = getFridgeHistory();
    list.unshift({
        date: Date.now(),
        ...record
    });
    localStorage.setItem('fridge_history', JSON.stringify(list));
}

function toggleFridgeHistory() {
    const p = document.getElementById('fridge-history-panel');
    p.classList.toggle('open');
    if (p.classList.contains('open')) renderFridgeHistory();
}

function renderFridgeHistory() {
    const list = getFridgeHistory();
    const container = document.getElementById('fridge-history-list');
    container.innerHTML = '';

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.innerHTML = `
            <div style="font-weight:bold;">${item.dish_name}</div>
            <div style="font-size:0.8rem; color:#888;">${new Date(item.date).toLocaleDateString()}</div>
            <div style="font-size:0.85rem; margin-top:5px; height:40px; overflow:hidden;">${item.dialogue}</div>
            <button class="m-btn small" onclick="deleteFridgeHistory(${index})" style="margin-top:5px; background:#ff6b6b; color:white; width:100%;">Âà†Èô§</button>
        `;
                div.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') {
                document.getElementById('note-detail-title').innerText = item.dish_name;
                document.getElementById('note-detail-content').innerText = `„Äê‰Ω†ÂÆ∂ÁöÑÂ§ßÂé®Âò±Âíê„Äë\n${item.dialogue}\n\n„ÄêË¥≠Áâ©Âª∫ËÆÆ„Äë\n${item.shopping_advice || 'Êó†'}`;
                document.getElementById('note-detail-date').innerText = new Date(item.date).toLocaleDateString();
                document.getElementById('sticky-note-modal').style.display = 'flex';
            }
        };
        container.appendChild(div);
    });
}

function deleteFridgeHistory(index) {
    if(!confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const list = getFridgeHistory();
    list.splice(index, 1);
    localStorage.setItem('fridge_history', JSON.stringify(list));
    renderFridgeHistory();
}
window.toggleFridgeHistory = function() {
    const p = document.getElementById('fridge-history-panel');

    p.classList.toggle('open');
    
    if (p.classList.contains('open')) {
        renderFridgeHistory();
    }
};
window.renderFridgeHistory = function() {
    const list = getFridgeHistory();
    const container = document.getElementById('fridge-history-list');
    container.innerHTML = '';

    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px; font-size:0.9rem;">ÊöÇÊó†‰æøÁ≠æ<br>Êâì‰∏™ÁîµËØùÁªôÂ§ßÂé®ËØïËØïÔºü</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'sticky-paper'; 
        div.style.cursor = 'pointer';
        const previewText = item.shopping_advice || item.dialogue || '...';

        div.innerHTML = `
            <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px; border-bottom:1px dashed rgba(0,0,0,0.1); padding-bottom:5px;">
                ${item.dish_name || 'Êú™Áü•ËèúË∞±'}
            </div>
            <div style="font-size:0.8rem; color:#8d6e63; margin-bottom:5px;">
                ${new Date(item.date).toLocaleDateString()}
            </div>
            <div style="font-size:0.9rem; line-height:1.4; opacity:0.9; max-height:60px; overflow:hidden; text-overflow:ellipsis;">
                ${previewText}
            </div>
            <button class="m-btn small" onclick="event.stopPropagation(); deleteFridgeHistory(${index})" 
                style="position:absolute; top:5px; right:5px; background:transparent; color:#d32f2f; border:none; font-size:1.2rem; padding:0;">√ó</button>
        `;
        div.onclick = () => {
            document.getElementById('note-detail-title').innerText = item.dish_name;
            
            // ÊãºÊé•ÊòæÁ§∫ÂÜÖÂÆπÔºöÈÄöËØùËÆ∞ÂΩï + ÂàÜÂâ≤Á∫ø + ËèúË∞±
            const fullContent = `„Äêüìû ÈÄöËØùÂõûÈ°æ„Äë\n${item.dialogue}\n\n------------------\n\n„Äêü•£ ÁÆÄÊòìËèúË∞±„Äë\n${item.shopping_advice || 'Êó†'}`;
            
            document.getElementById('note-detail-content').innerText = fullContent;
            document.getElementById('note-detail-date').innerText = new Date(item.date).toLocaleString();
            document.getElementById('sticky-note-modal').style.display = 'flex';
        };
        container.appendChild(div);
    });
};

let currentPickupId = null;
async function openPickupApp() {
    document.getElementById('pickup-modal').style.display = 'flex';
    
    // ËÆæÁΩÆÊ†áÈ¢òÂêçÂ≠óÔºàÂèñËÆæÁΩÆÈáåÁöÑÂØπÊñπÂêçÂ≠óÔºåÊàñËÄÖÈªòËÆ§Ôºâ
    const settings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    document.getElementById('pickup-char-name').innerText = settings.title || "ÂØπÊñπ";
    const history = await getPickupHistory();
    if (!currentPickupId) {
        if (history.length > 0) {
            await loadPickup(history[0].id);
        } else {
            startNewPickup();
        }
    } else {
        await renderPickupChat();
    }
}

function closePickupApp() {
    document.getElementById('pickup-modal').style.display = 'none';
}
async function getPickupHistory() {
    try {
        const res = await idb.get('pickup_data', 'history_list');
        return res ? res.data : [];
    } catch(e) { return []; }
}

async function savePickupHistory(list) {
    await idb.put('pickup_data', { id: 'history_list', data: list });
}

async function getPickupContent(id) {
    try {
        const res = await idb.get('pickup_data', `chat_${id}`);
        return res ? res.data : []; 
    } catch(e) { return []; }
}

async function savePickupContent(id, msgs) {
    await idb.put('pickup_data', { id: `chat_${id}`, data: msgs });
}
async function startNewPickup() {
    currentPickupId = Date.now().toString();
    const list = await getPickupHistory();
    list.unshift({ id: currentPickupId, title: "Êñ∞ÂØπËØù " + new Date().toLocaleTimeString(), date: Date.now() });
    await savePickupHistory(list);
    await savePickupContent(currentPickupId, []);
    
    document.getElementById('pickup-chat-area').innerHTML = ''; 
    document.getElementById('pickup-input').value = '';
    document.getElementById('pickup-history-panel').classList.remove('open');
}

async function loadPickup(id) {
    currentPickupId = id;
    await renderPickupChat();
    document.getElementById('pickup-history-panel').classList.remove('open');
}
async function renderPickupChat() {
    if (!currentPickupId) return;
    const msgs = await getPickupContent(currentPickupId);
    const container = document.getElementById('pickup-chat-area');
    container.innerHTML = '';
    const heavy = await idb.get('settings_heavy', 'botAvatar');
    const myHeavy = await idb.get('settings_heavy', 'myAvatar');
    const botAvatar = (heavy && heavy.data) ? `url(${heavy.data})` : '';
    const myAvatar = (myHeavy && myHeavy.data) ? `url(${myHeavy.data})` : '';

    msgs.forEach(msg => {
        const row = document.createElement('div');
        // role: 'me' -> Âè≥Ëæπ, 'char' -> Â∑¶Ëæπ
        const isMe = msg.role === 'me';
        row.className = `pup-row ${isMe ? 'right' : 'left'}`;

        const avatarDiv = `<div class="pup-avatar" style="background-image:${isMe ? myAvatar : botAvatar}"></div>`;
        const bubbleDiv = `<div class="pup-bubble">${msg.content}</div>`;

        if (isMe) {
            row.innerHTML = bubbleDiv + avatarDiv;
        } else {
            row.innerHTML = avatarDiv + bubbleDiv;
        }
        container.appendChild(row);
    });
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
}
async function generatePickupChat() {
    const inputEl = document.getElementById('pickup-input');
    const promptText = inputEl.value.trim();
    const btn = document.getElementById('btn-pickup-gen');
    const currentMsgs = await getPickupContent(currentPickupId);
    if (currentMsgs.length === 0 && !promptText) {
        return alert("ËØ∑ËæìÂÖ•ÂàùÂßãÊÉÖËäÇÊàñÂÖ≥ÈîÆËØçÔºÅ");
    }
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "ÁîüÊàê‰∏≠...";
    const wb = getWBData();
    let context = "";
    context += "„Äê‰∏ñÁïåËßÇ(ÂÖ®Â±Ä)„Äë:\n" + ((wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) + "\n";
    context += "„ÄêÊç°ÊâãÊú∫ÊñáÂ≠¶ËÆæÂÆö„Äë:\n" + ((wb['8.Êç°ÊâãÊú∫ÊñáÂ≠¶'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) + "\n";
    const historyContext = currentMsgs.slice(-10).map(m => `${m.role==='me'?'Áî®Êà∑':'ËßíËâ≤'}: ${m.content}`).join("\n");

    const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™‚ÄúÊç°ÊâãÊú∫ÊñáÂ≠¶‚ÄùÁîüÊàêÂô®„ÄÇ
ËøôÁßçÊñá‰ΩìÁöÑÁâπÁÇπÊòØÔºöÊûÅÂ∫¶ÁúüÂÆû„ÄÅÁîüÊ¥ªÂåñ„ÄÅÈÄöËøáËÅäÂ§©ËÆ∞ÂΩïÂ±ïÁé∞ÂâßÊÉÖÂíåÊÉÖÊÑüÔºàËôêÂøÉ„ÄÅÁîúÂÆ†„ÄÅÊãâÊâØÔºâ„ÄÇ

${context}

„Äê‰ªªÂä°„Äë
ÁîüÊàê‰∏ÄÊÆµ„ÄêÁî®Êà∑(Êàë)„ÄëÂíå„ÄêËßíËâ≤(TA)„Äë‰πãÈó¥ÁöÑÂæÆ‰ø°/QQËÅäÂ§©ËÆ∞ÂΩï„ÄÇ
Ê†πÊçÆÁî®Êà∑ÁöÑËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñÂâçÊñáËøõË°åÁª≠ÂÜô„ÄÇ

„ÄêË¶ÅÊ±Ç„Äë
1. **Êï∞Èáè**ÔºöÂøÖÈ°ªÁîüÊàê**‰∏çÂ∞ë‰∫é 20 Êù°**ÂØπËØùÊù•Âõû„ÄÇ‰∏çË¶ÅÂÅ∑Êáí„ÄÇ
2. **Ê†ºÂºè**Ôºö‰∏•Ê†º JSON Êï∞ÁªÑÊ†ºÂºèÔºå‰∏çË¶Å Markdown Ê†áËÆ∞„ÄÇ
   - Áî®Êà∑(Êàë)ÁöÑ role ‰∏∫ "me"„ÄÇ
   - ËßíËâ≤(TA)ÁöÑ role ‰∏∫ "char"„ÄÇ
   JSONÁ§∫‰æãÔºö
   [
     {"role": "me", "content": "‰Ω†Âú®Âì™Ôºü"},
     {"role": "char", "content": "Âàö‰∏ãÁè≠ÔºåÊÄé‰πà‰∫ÜÔºü"},
     ...
   ]
3. **ÂÜÖÂÆπ**Ôºö
   - ËØ≠Ê∞îË¶ÅÂÉèÁúü‰∫∫Âú®ÊâìÂ≠óÔºåÂèØ‰ª•ÊúâÁü≠Âè•„ÄÅËøûÂèë„ÄÅÊ†áÁÇπ‰∏çËßÑËåÉ„ÄÅÁîöËá≥Êí§ÂõûÔºàÁî®ÊñáÊú¨Ë°®Á§∫[Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ]Ôºâ„ÄÇ
   - ÊÉÖÊÑüË¶ÅÂÖÖÊ≤õÔºåÁ¨¶Âêà‚ÄúÊç°ÊâãÊú∫ÊñáÂ≠¶‚ÄùÈÇ£ÁßçÁ™•Êé¢ÈöêÁßÅÁöÑÁúüÂÆûÊÑü„ÄÇ
`;
    let apiKey = "", apiUrl = "", model = "";
    try {
        const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        apiKey = s.key; apiUrl = s.url; model = s.model;
    } catch(e){}
    if (!apiKey) apiKey = document.getElementById('api-key').value;
    if (!apiUrl) apiUrl = document.getElementById('api-url').value;
    if (!model) model = document.getElementById('model-select').value;

    if (!apiKey) {
        btn.disabled = false; btn.innerText = originalText;
        return alert("API Key Êú™ÈÖçÁΩÆÔºÅ");
    }

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `„ÄêÂâçÊñá„Äë\n${historyContext}\n\n„ÄêÊú¨Ê¨°ÊÉÖËäÇÊåá‰ª§„Äë\n${promptText || "ÁªßÁª≠ÂàöÊâçÁöÑÂØπËØùÔºåÊ∑±ÂÖ•Â±ïÂºÄ"}` }
                ],
                temperature: 0.8,
                max_tokens: 3500 // ÂÖÅËÆ∏ÈïøËæìÂá∫
            })
        });

        const json = await res.json();
        let raw = json.choices[0].message.content;
        raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();
 
        if(raw.startsWith('[') && !raw.endsWith(']')) raw += ']';

        let newMsgs = [];
        try {
            newMsgs = JSON.parse(raw);
        } catch(e) {
             console.error("JSONËß£ÊûêÂ§±Ë¥•", raw);
             alert("ÁîüÊàêÊ†ºÂºèÈîôËØØÔºåËØ∑ÈáçËØï");
             return;
        }
        const finalMsgs = currentMsgs.concat(newMsgs);
        await savePickupContent(currentPickupId, finalMsgs);
        if (currentMsgs.length === 0 && promptText) {
            const list = await getPickupHistory();
            const item = list.find(i => i.id === currentPickupId);
            if(item) {
                item.title = promptText.substring(0, 15);
                await savePickupHistory(list);
            }
        }
        await renderPickupChat();
        inputEl.value = ''; 

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
}
async function togglePickupHistory() {
    const panel = document.getElementById('pickup-history-panel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        const list = await getPickupHistory();
        const container = document.getElementById('pickup-history-list');
        container.innerHTML = '';
        
        list.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'morandi-card';
            div.style.padding = '10px';
            div.style.cursor = 'pointer';
            if(item.id === currentPickupId) div.style.border = "2px solid #f1c40f";
            
            div.innerHTML = `
                <div style="font-weight:bold;">${item.title}</div>
                <div style="font-size:0.8rem; color:#888;">${new Date(item.date).toLocaleString()}</div>
                <div style="text-align:right;">
                    <button class="m-btn small" onclick="event.stopPropagation(); deletePickup(${index})" style="background:#ff6b6b; color:white;">Âà†Èô§</button>
                </div>
            `;
            div.onclick = () => loadPickup(item.id);
            container.appendChild(div);
        });
    }
}

async function deletePickup(index) {
    if(!confirm("Âà†Èô§ËøôÊÆµËÆ∞ÂΩïÔºü")) return;
    const list = await getPickupHistory();
    const id = list[index].id;
    await idb.delete('pickup_data', `chat_${id}`);
    list.splice(index, 1);
    await savePickupHistory(list);
    
    if(id === currentPickupId) {
        startNewPickup();
    } else {
        togglePickupHistory(); 
        togglePickupHistory();
    }
}

function clearPickupChat() {
    if(confirm("Ê∏ÖÁ©∫ÂΩìÂâçÂØπËØùÂÜÖÂÆπÔºü(Êó†Ê≥ïÊÅ¢Â§ç)")) {
        savePickupContent(currentPickupId, []).then(() => renderPickupChat());
    }
}
function loadMemoFromLocal() {
    const text = localStorage.getItem('desktop_memo') || "";
    const previewEl = document.getElementById('desktop-memo-text');
    if(previewEl) {
        previewEl.innerText = text || "ÁÇπÂáªÁºñËæëÂ§áÂøòÂΩï...";
    }
    const area = document.getElementById('memo-full-text');
    if(area) area.value = text;
}

function saveMemoToLocal() {
    const text = document.getElementById('memo-full-text').value;
    localStorage.setItem('desktop_memo', text);
    document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæëÂ§áÂøòÂΩï...";
}

function openMemoApp() {
    loadMemoFromLocal();
    document.getElementById('memo-app-modal').style.display = 'flex';
}
function closeMemoApp() {
    document.getElementById('memo-app-modal').style.display = 'none';
}
loadMemoFromLocal();

let currentAlbumId = null;
let currentPhotoId = null; 
async function getAlbums() {
    try {
        const res = await idb.get('album_data', 'all_albums');
        return res ? res.data : [];
    } catch(e) { return []; }
}
async function saveAlbums(list) {
    await idb.put('album_data', { id: 'all_albums', data: list });
}
async function openAlbumApp() {
    document.getElementById('album-app-modal').style.display = 'flex';
    document.getElementById('album-shelf-view').style.display = 'flex';
    document.getElementById('album-detail-view').style.display = 'none';
    await renderAlbumShelf();
}
function closeAlbumApp() {
    document.getElementById('album-app-modal').style.display = 'none';
}
async function renderAlbumShelf() {
    const list = await getAlbums();
    const container = document.getElementById('album-list-container');
    container.innerHTML = '';

    if(list.length === 0) {
        container.innerHTML = `<div style="grid-column:span 2; text-align:center; color:#999; margin-top:50px;">ÊöÇÊó†Áõ∏ÂÜåÔºåËØ∑Êñ∞Âª∫</div>`;
        return;
    }

    list.forEach(album => {
        const div = document.createElement('div');
        div.className = 'album-cover-item';
        div.onclick = () => openAlbumDetail(album.id);
        
        div.innerHTML = `
            <div class="album-cover-text">${album.name}</div>
            <div style="font-size:0.7rem; color:#6d4c41; margin-top:5px;">${album.photos.length} Âº†</div>
        `;
        container.appendChild(div);
    });
}

async function createNewAlbum() {
    const name = prompt("ËØ∑ËæìÂÖ•Áõ∏ÂÜåÂêçÁß∞:", "Êú™ÂëΩÂêçÁõ∏ÂÜå");
    if(!name) return;
    
    const list = await getAlbums();
    list.push({
        id: Date.now().toString(),
        name: name,
        photos: [] // {id, src, date}
    });
    await saveAlbums(list);
    await renderAlbumShelf();
}
async function openAlbumDetail(id) {
    currentAlbumId = id;
    const list = await getAlbums();
    const album = list.find(a => a.id === id);
    if(!album) return;

    document.getElementById('album-shelf-view').style.display = 'none';
    document.getElementById('album-detail-view').style.display = 'flex';
    document.getElementById('album-title-display').innerText = album.name;
    
    renderPhotoGrid(album);
}

function renderPhotoGrid(album) {
    const container = document.getElementById('photo-grid-container');
    container.innerHTML = '';
    
    album.photos.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = 'photo-thumb';
        div.style.backgroundImage = `url(${p.src})`;
        div.onclick = () => viewPhoto(idx);
        container.appendChild(div);
    });
}

function backToShelf() {
    document.getElementById('album-shelf-view').style.display = 'flex';
    document.getElementById('album-detail-view').style.display = 'none';
    renderAlbumShelf();
}

async function editAlbumName() {
    const list = await getAlbums();
    const album = list.find(a => a.id === currentAlbumId);
    const newName = prompt("‰øÆÊîπÁõ∏ÂÜåÂêçÁß∞:", album.name);
    if(newName) {
        album.name = newName;
        await saveAlbums(list);
        document.getElementById('album-title-display').innerText = newName;
    }
}

async function deleteCurrentAlbum() {
    if(!confirm("Á°ÆÂÆöË¶ÅÈîÄÊØÅËøô‰∏™Áõ∏ÂÜåÂêóÔºüÊâÄÊúâÁÖßÁâáÂ∞Ü‰∏¢Â§±„ÄÇ")) return;
    let list = await getAlbums();
    list = list.filter(a => a.id !== currentAlbumId);
    await saveAlbums(list);
    backToShelf();
}
async function handlePhotoImport(input) {
    const files = Array.from(input.files);
    if(files.length === 0) return;
    
    let list = await getAlbums();
    const album = list.find(a => a.id === currentAlbumId);
    
    for(let file of files) {
        await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => {
                album.photos.push({
                    id: Date.now() + Math.random(),
                    src: e.target.result,
                    date: new Date().toLocaleString()
                });
                resolve();
            };
            reader.readAsDataURL(file);
        });
    }
    
    await saveAlbums(list);
    renderPhotoGrid(album);
    input.value = '';
}

async function viewPhoto(index) {
    let list = await getAlbums();
    const album = list.find(a => a.id === currentAlbumId);
    const photo = album.photos[index];
    currentPhotoId = index; 

    const modal = document.getElementById('photo-viewer-modal');
    const card = document.getElementById('held-photo');
    const img = document.getElementById('held-photo-img');
    const date = document.getElementById('photo-date-str');

    img.src = photo.src;
    date.innerText = photo.date;
    
    modal.style.display = 'flex';
    card.classList.remove('slide-in');
    setTimeout(() => {
        card.classList.add('slide-in');
    }, 50);
}

function closePhotoViewer() {
    const card = document.getElementById('held-photo');
    card.classList.remove('slide-in');
    setTimeout(() => {
        document.getElementById('photo-viewer-modal').style.display = 'none';
    }, 300); 
}

async function deleteCurrentPhoto() {
    if(!confirm("ÊíïÊØÅËøôÂº†ÁÖßÁâáÔºü")) return;
    let list = await getAlbums();
    const album = list.find(a => a.id === currentAlbumId);
    
    album.photos.splice(currentPhotoId, 1); 
    await saveAlbums(list);
    
    closePhotoViewer();
    renderPhotoGrid(album); 
}

function openAnniversaryApp() {
    document.getElementById('anniversary-modal').style.display = 'flex';
    document.getElementById('anniversary-list-view').style.display = 'flex';
    document.getElementById('anniversary-add-view').style.display = 'none';
    renderAnniversaries();
}
function openAddAnniversaryView() {
    document.getElementById('anniversary-list-view').style.display = 'none';
    document.getElementById('anniversary-add-view').style.display = 'block';
    document.getElementById('ann-title').value = '';
    document.getElementById('ann-date').value = '';
    document.getElementById('ann-bg-input').value = '';
    document.getElementById('ann-repeat').checked = true;
}
function closeAddAnniversaryView() {
    document.getElementById('anniversary-list-view').style.display = 'flex';
    document.getElementById('anniversary-add-view').style.display = 'none';
}
async function renderAnniversaries() {
    const list = await idb.getAll('anniversary_data');
    const container = document.getElementById('anniversary-list-view');
    container.innerHTML = '';

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; margin-top:50px;">ÊöÇÊó†Á∫™ÂøµÊó•<br>ÁÇπÂáªÂè≥‰∏äËßí + Êñ∞Âª∫</div>`;
        return;
    }
    list.sort((a, b) => a.daysLeft - b.daysLeft);

    list.forEach(item => {
        const calc = calculateAnniversary(item.date, item.repeat);
        const div = document.createElement('div');
        div.className = 'ann-card';
        if(item.bgImage) div.style.backgroundImage = `url(${item.bgImage})`;
        const labelText = calc.isPast ? "Â∑≤ÁªèËøáÂéª" : "ËøòÊúâ";
        const dayText = calc.diffDays;
        
        div.innerHTML = `
            <div class="ann-del-btn" onclick="deleteAnniversary('${item.id}')">√ó</div>
            <div class="ann-content">
                <div class="ann-label">${item.title} ${labelText}</div>
                <div class="ann-days">${dayText} <span style="font-size:1rem; font-weight:normal;">Â§©</span></div>
            </div>
            <div class="ann-content ann-date-text">ÁõÆÊ†áÊó•: ${item.date} ${item.repeat ? '(ÊØèÂπ¥)' : ''}</div>
        `;
        container.appendChild(div);
    });
}
function calculateAnniversary(targetDateStr, isRepeat) {
    // 1. Ëé∑Âèñ‰ªäÊó•Èõ∂ÁÇπ (Êú¨Âú∞Êó∂Èó¥)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 2. Ëß£ÊûêÁõÆÊ†áÊó•Êúü (Âº∫Âà∂ÊåâÊú¨Âú∞Êó∂Èó¥Ëß£ÊûêÔºå‰øÆÂ§çÊó∂Âå∫BUG)
    // Ëß£ÂÜ≥ new Date("YYYY-MM-DD") ÈªòËÆ§‰∏∫ UTC ÁöÑÈóÆÈ¢ò
    const parts = targetDateStr.split('-');
    let target = new Date();
    target.setFullYear(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    target.setHours(0, 0, 0, 0);

    // 3. Â§ÑÁêÜÊØèÂπ¥ÈáçÂ§çÈÄªËæë
    if (isRepeat) {
        target.setFullYear(today.getFullYear());
        // Â¶ÇÊûú‰ªäÂπ¥ÁöÑÁ∫™ÂøµÊó•Â∑≤ÁªèËøá‰∫ÜÔºåÂ∞±ÁÆóÊòéÂπ¥ÁöÑ
        if (target < today) {
            target.setFullYear(today.getFullYear() + 1);
        }
    }

    // 4. ËÆ°ÁÆóÂ§©Êï∞Â∑Æ (Âêë‰∏äÂèñÊï¥Èò≤Ê≠¢ÊØ´ÁßíÁ∫ßËØØÂ∑Æ)
    const diffTime = target - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    return {
        diffDays: Math.abs(diffDays), // ÊòæÁ§∫Áî®
        isPast: diffDays < 0,         // ÊòØÂê¶Â∑≤ËøáÊúü(‰ªÖÈùûÈáçÂ§çÊ®°ÂºèÊúâÊïà)
        isToday: diffDays === 0       // ÊòØÂê¶ÊòØ‰ªäÂ§©
    };
}
async function saveAnniversary() {
    const title = document.getElementById('ann-title').value;
    const date = document.getElementById('ann-date').value;
    const repeat = document.getElementById('ann-repeat').checked;
    const remindType = document.getElementById('ann-remind-type').value;
    const bgInput = document.getElementById('ann-bg-input');
    
    if(!title || !date) return alert("ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ");

    let bgData = null;
    if(bgInput.files[0]) {
        bgData = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(bgInput.files[0]);
        });
    }

    const newItem = {
        id: Date.now().toString(),
        title,
        date,
        repeat,
        remindType,
        bgImage: bgData 
    };

    await idb.put('anniversary_data', newItem);
    closeAddAnniversaryView();
    renderAnniversaries();
}
async function deleteAnniversary(id) {
    if(confirm("Âà†Èô§Ëøô‰∏™Á∫™ÂøµÊó•Ôºü")) {
        await idb.delete('anniversary_data', id);
        renderAnniversaries();
    }
}
async function checkAnniversaries() {
    const list = await idb.getAll('anniversary_data');
    if (!list.length) return;

    let alerts = [];
    list.forEach(item => {
        if (item.remindType === 'none') return;
        
        const calc = calculateAnniversary(item.date, item.repeat);
        const days = calc.diffDays;
        // Á°Æ‰øùËøô‰∏ÄÊÆµÈÄªËæëÊòØËøôÊ†∑ÁöÑ (Â∞§ÂÖ∂ÊòØ days === 0 ÁöÑÂà§Êñ≠)
if (item.remindType === 'same' && days === 0) {
    alerts.push(`üéâ ‰ªäÂ§©ÊòØ„Äê${item.title}„ÄëÔºÅ`);
}
if (item.remindType === 'before' && days === 1) {
    alerts.push(`‚è∞ ÊòéÂ§©ÊòØ„Äê${item.title}„ÄëÔºåËÆ∞ÂæóÂáÜÂ§áÂì¶ÔºÅ`);
}
// Êúâ‰∫õ‰∫∫‰π†ÊÉØÊää"ÊèêÂâçÊèêÈÜí"Âú®ÂΩìÂ§©‰πüÊèêÈÜí‰∏ÄÊ¨°ÔºåÂèØ‰ª•‰øùÁïôËøôÂè•Ôºö
if (item.remindType === 'before' && days === 0) {
    alerts.push(`üéâ ‰ªäÂ§©ÊòØ„Äê${item.title}„ÄëÔºÅ`);
}
    });

    // Âú® checkAnniversaries ÂáΩÊï∞ÂÜÖÈÉ®...
    if (alerts.length > 0) {
        
        NotificationManager.send({
            title: "üìÖ Á∫™ÂøµÊó•ÊèêÈÜí",
            body: alerts.join("\n"),
            icon: "üíñ",
            onClick: () => openAnniversaryApp() 
        });
    }
} 
let dreamActiveDeck = [];  
let dreamFlippedCards = [];  
let currentDreamResult = null; 
function openDreamApp() {
    document.getElementById('dream-app-modal').style.display = 'flex';
    document.getElementById('dream-result-area').style.display = 'none';
}

function closeDreamApp() {
    document.getElementById('dream-app-modal').style.display = 'none';
}
function startDreamDrawing() {
    const table = document.getElementById('dream-card-table-modal');
    const area = document.getElementById('dream-card-area');
    area.innerHTML = ''; 
    dreamActiveDeck = [];
    dreamFlippedCards = [];
    document.getElementById('dream-flipped-count').innerText = '0';
    let fullDeck = [];
    for(let i=0; i<=77; i++) {
        fullDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 }); 
    }
    for(let i=1; i<=36; i++) {
        fullDeck.push({ type: 'lenormand', id: i, isReversed: false }); 
    }
    fullDeck.sort(() => Math.random() - 0.5);
    dreamActiveDeck = fullDeck;
    const deskW = window.innerWidth;
    const cardWidth = 60;  
    const cardHeight = 90; 
    const gapX = 10;       
    const gapY = 15;       
    let columns = Math.floor((deskW - 20) / (cardWidth + gapX));
    if (columns < 4) columns = 4;
    if (columns > 8) columns = 8; 
    
    const totalGridWidth = columns * cardWidth + (columns - 1) * gapX;
    const startX = Math.max(0, (deskW - totalGridWidth) / 2); 
    const startY = 60;
    dreamActiveDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card'; 
        const colIndex = index % columns;
        const rowIndex = Math.floor(index / columns);
        
        const leftPos = startX + colIndex * (cardWidth + gapX);
        const topPos = startY + rowIndex * (cardHeight + gapY);
        
        el.style.left = leftPos + 'px';
        el.style.top = topPos + 'px';
        el.style.transform = `rotate(${Math.random() * 6 - 3}deg)`; 
        
        el.onclick = () => flipDreamCard(el, card);
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        area.appendChild(el);
    });
    const totalRows = Math.ceil(dreamActiveDeck.length / columns);
    area.style.height = (startY + totalRows * (cardHeight + gapY) + 120) + 'px';
    table.style.display = 'flex';
}

function closeDreamCardTable() {
    document.getElementById('dream-card-table-modal').style.display = 'none';
}
async function flipDreamCard(el, cardData) { if(el.classList.contains('flipped')) {
        el.classList.remove('flipped');
        dreamFlippedCards = dreamFlippedCards.filter(c => !(c.type === cardData.type && c.id === cardData.id));
        document.getElementById('dream-flipped-count').innerText = dreamFlippedCards.length;
        setTimeout(() => {
            const frontEl = el.querySelector('.playing-card-front');
            frontEl.style.backgroundImage = ''; 
            frontEl.style.transform = ''; 
            frontEl.innerText = '';
        }, 300);
        return; 
    }
    el.classList.add('flipped');
    dreamFlippedCards.push(cardData);
    document.getElementById('dream-flipped-count').innerText = dreamFlippedCards.length;
    const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
    try {
        const item = await idb.get(dbName, cardData.id);
        const frontEl = el.querySelector('.playing-card-front');
        
        if(item && item.data) {
            frontEl.style.backgroundImage = `url(${item.data})`;
            frontEl.innerText = ''; 
            if(cardData.type === 'tarot' && cardData.isReversed) {
                frontEl.style.transform = "rotateY(180deg) rotate(180deg)"; 
            } else {
                frontEl.style.transform = "rotateY(180deg)";
            }
        } else {
            frontEl.style.backgroundColor = '#fdf6e3';
            frontEl.style.display = 'flex';
            frontEl.style.alignItems = 'center';
            frontEl.style.justifyContent = 'center';
            frontEl.style.fontSize = '0.8rem';
            frontEl.style.color = '#333';
            frontEl.innerText = `${cardData.type === 'tarot' ? 'Tarot' : 'Lenormand'}\n#${cardData.id}\n${cardData.isReversed ? '(ÈÄÜ)' : ''}`;
            if(cardData.type === 'tarot' && cardData.isReversed) {
                 frontEl.style.transform = "rotateY(180deg) rotate(180deg)";
            } else {
                 frontEl.style.transform = "rotateY(180deg)";
            }
        }
    } catch(e) { 
        console.error("Load card img failed", e); 
    }
}
async function finishDreamDrawing() {
    if(dreamFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøªÂºÄ‰∏ÄÂº†ÁâåÔºÅ");
    
    closeDreamCardTable(); 
    
    const resultArea = document.getElementById('dream-result-area');
    resultArea.style.display = 'block';
    document.getElementById('dream-analysis-content').innerHTML = '<div class="skeleton-text">Ê≠£Âú®Ê†πÊçÆÁâåÊÑè‰∏é‰∏ñÁïå‰π¶ÁîüÊàêÊ¢¶Áî∑ÂàÜÊûêË°®...</div>';
    let cardsDesc = dreamFlippedCards.map(c => {
        let name = (c.type === 'tarot') ? TAROT_NAMES[c.id] : LENORMAND_NAMES[c.id];
        let status = (c.type === 'tarot' && c.isReversed) ? "(ÈÄÜ‰Ωç)" : "";
        return `${name}${status}`;
    }).join(", ");

    const wb = getWBData();
    const globalContext = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const dreamContextKey = Object.keys(wb).find(k => k.includes("Ê¢¶Ëßí"));
    const dreamContext = dreamContextKey ? 
        (wb[dreamContextKey] || []).filter(i=>i.enabled).map(i=>i.content).join("\n") : "";

    let apiKey = document.getElementById('api-key').value; 
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    if(!apiKey) {
        try {
            const saved = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
            apiKey = saved.key; apiUrl = saved.url; model = saved.model;
        } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API KeyÔºÅ");
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Ê∑±Â∫¶ËßíËâ≤ÂàÜÊûêÂ∏à„ÄÇ
ËØ∑Ê†πÊçÆ‰ª•‰∏ã‰ø°ÊÅØÔºåÂàÜÊûêÂ¶ÇÊûú„ÄêËßíËâ≤„ÄëÊàê‰∏∫Áî®Êà∑ÁöÑ„ÄêÊ¢¶Áî∑/Ê¢¶Â•≥„ÄëÔºàDream Character/PartnerÔºâ‰ºöÂèëÁîü‰ªÄ‰πà„ÄÇ

„Äê‰∏ñÁïå‰π¶/ËßíËâ≤ËÆæÂÆö„ÄëÔºö
${globalContext}

„Äê"ÂÅáÂ¶Ç‰Ω†ÊòØTaÁöÑÊ¢¶Ëßí"ËÆæÂÆö„ÄëÔºö
${dreamContext}

„ÄêÊäΩÂà∞ÁöÑÁâåÔºàÂëΩËøêÊåáÂºïÔºâ„ÄëÔºö
${cardsDesc}
(ËØ∑ÁªìÂêàÁâåÊÑèÊù•Êé®ÂØºÂàÜÊûêÁªìÊûúÔºå‰æãÂ¶ÇÔºöÊùÉÊùñÁâåÂèØËÉΩ‰ª£Ë°®ÁÉ≠ÊÉÖ‰π∞Ë∞∑ÔºåÊòüÂ∏ÅÁâå‰ª£Ë°®ÊÑøÊÑèËä±Èí±ÔºåÂÆùÂâëÁâå‰ª£Ë°®ÁêÜÊô∫ÊàñÁ∫†Áªì)

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„ÄëÔºö
ËØ∑‰∏•Ê†ºÁîüÊàê‰∏Ä‰∏™ HTML Ë°®Ê†º‰ª£Á†ÅÔºà<table>...</table>ÔºâÔºå‰∏çË¶ÅMarkdownÊ†áËÆ∞„ÄÇ
Ë°®Ê†ºÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãË°åÔºàRowÔºâÔºåÂ∑¶ËæπÊòØÈ°πÁõÆÔºåÂè≥ËæπÊòØÂàÜÊûêÂÜÖÂÆπÔºö

1. **ËßíËâ≤ÂÆö‰Ωç**ÔºöÊòØÊ¢¶Áî∑ËøòÊòØÊ¢¶Â•≥Ôºü(Ê†πÊçÆËßíËâ≤ÊÄßÂà´Âà§Êñ≠)
2. **‰π∞Ë∞∑Êï∞Èáè**Ôºö‰ºö‰π∞Â§öÂ∞ëÂë®ËæπÔºü(Êï∞ÈáèÁ∫ß)
3. **ÂñúÊ¨¢ÁöÑË∞∑**ÔºöÊúÄÂñúÊ¨¢‰π∞‰ªÄ‰πàÊ†∑ÁöÑÂë®ËæπÔºüÊúÄÂñúÊ¨¢‰ªÄ‰πàÊ†∑ÁöÑÊüÑÂõæÔºü(ÂêßÂîß/Á´ãÁâå/Ê£âËä±Â®ÉÂ®ÉÁ≠â)ÔºàÁî®Êà∑Âçï‰∫∫/Áî®Êà∑ÁöÑÂç∞Ë±°Êúç/Áî®Êà∑ÁöÑË±°ÂæÅÁâ©Á≠âÔºâ
4. **ÁâàÊùÉÊÑèËØÜ**Ôºö‰ºö‰∏ç‰ºöËÄÉËôë‰π∞ÁâàÊùÉ/‰π∞Êñ≠Ôºü
5. **ÂêåÊãÖÊÄÅÂ∫¶**ÔºöÂØπÂÖ∂‰ªñÂêå‰ª∑/ÂêåÊãÖÂàÜÂà´ÁöÑÊÄÅÂ∫¶Ôºü(Â´âÂ¶í/ÂèãÂñÑ/Êó†ËßÜ)
6. **ÊúàÊ∂àË¥π**ÔºöÊØè‰∏™Êúà‰ºöËä±Â§öÂ∞ëÈí±Âú®Ê¢¶Âêë‰∫ã‰ª∂‰∏äÔºü
7. **Á∫¶Á®øÂÅèÂ•Ω**Ôºö‰ºöÁ∫¶‰ªÄ‰πàÊ†∑ÁöÑÁ®ø‰ª∂Ôºü(ÊèíÂõæ/Êñá/Êù°Êº´)
8. **ÊúÄÂºÄÂøÉÁöÑ‰∫ã**ÔºöÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÊúÄÂºÄÂøÉÁöÑ‰∫ãÊÉÖÔºü
9. **ÊúÄÁóõËã¶ÁöÑ‰∫ã**ÔºöÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÊúÄÁóõËã¶ÁöÑ‰∫ãÊÉÖÔºü
10. **ÂàùÂßãÂøÉÊÉÖ**Ôºö‰∏ÄÂºÄÂßãÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÁöÑÂøÉÊÉÖÔºü

ÂàÜÊûêÂÜÖÂÆπË¶ÅÁ¨¶ÂêàËßíËâ≤ÊÄßÊ†ºÔºåÂπ∂ËûçÂêàÁâåÊÑèÔºåÂπ∂Ë∞®ËÆ∞ËßíËâ≤ÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÊòØÂíåÁé∞ÂÆû‰∏ÄÊ†∑ÂÅöÊ¢¶Â•≥/Ê¢¶Áî∑ÁöÑÊÉÖÂÜµÔºåËßíËâ≤‰∏çÊ∏ÖÊ•öÁî®Êà∑ÊÄé‰πàÁúãÂæÖ‰ªñ/Â•π‰πü‰∏çÁü•ÈÅìÁî®Êà∑ÊòØÂê¶ÁúüÂÆûÂ≠òÂú®ÔºåÊòØÂê¶Âíå‰ªñ/Â•πË∞àÊÅãÁà±„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{ role: "system", content: "You are a creative writer. Output HTML Table only." }, { role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const json = await res.json();
        let content = json.choices[0].message.content;
        
        content = content.replace(/```html/g, "").replace(/```/g, "").trim();
        content = content.replace('<table>', '<table class="dream-table">');

        document.getElementById('dream-analysis-content').innerHTML = content;
        currentDreamResult = {
            date: Date.now(),
            cards: cardsDesc,
            htmlContent: content
        }; 
        NotificationManager.send({
            title: "ü¶Ñ Ê¢¶Â¢ÉËß£ÊûêÂÆåÊàê",
            body: "ÂÖ≥‰∫éÊ¢¶Áî∑/Ê¢¶Â•≥ÁöÑËØ¶ÁªÜÂàÜÊûêÊä•ÂëäÂ∑≤ÁîüÊàê„ÄÇ",
            icon: "üîÆ",
            onClick: () => {
                openDreamApp();
            }
        });

    } catch(e) {
        console.error(e);
        document.getElementById('dream-analysis-content').innerText = "ÁîüÊàêÂ§±Ë¥•: " + e.message;
    }
}
function saveDreamResultToHistory() {
    if (!currentDreamResult) {
        return alert("Ê≤°ÊúâÂèØ‰øùÂ≠òÁöÑÂÜÖÂÆπÔºåËØ∑ÂÖàÁîüÊàêËß£Êûê„ÄÇ");
    }
    let history = [];
    try {
        const raw = localStorage.getItem('dream_history');
        if (raw) {
            history = JSON.parse(raw);
            if (!Array.isArray(history)) history = [];
        }
    } catch (e) {
        console.error("ÂéÜÂè≤ËÆ∞ÂΩïËØªÂèñÂ§±Ë¥•ÔºåÈáçÁΩÆ‰∏∫Á©∫", e);
        history = [];
    }
    if (history.length > 0 && history[0].date === currentDreamResult.date) {
        return alert("ËøôÊù°ËÆ∞ÂΩïÂ∑≤Áªè‰øùÂ≠òËøá‰∫ÜÔºÅ");
    }
    history.unshift(currentDreamResult);

    // 5. ÈôêÂà∂Êï∞Èáè (‰øùÁïôÊúÄËøë50Êù°)
    if (history.length > 50) history.pop();
    try {
        localStorage.setItem('dream_history', JSON.stringify(history));
    } catch (e) {
        return alert("‰øùÂ≠òÂ§±Ë¥•ÔºöÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥");
    }
    try {
        if (typeof renderDreamHistory === 'function') {
            renderDreamHistory();
        }
    } catch (e) {
        console.error("ÂàóË°®Âà∑Êñ∞Â§±Ë¥•", e);
    }
    const saveBtn = document.getElementById('btn-dream-save');
    
    if (saveBtn) {
        const originalText = saveBtn.innerText;  "üíæ ‰øùÂ≠ò..."
        saveBtn.innerText = "‚úÖ ‰øùÂ≠òÊàêÂäüÔºÅ";
        saveBtn.disabled = true;ÁÇπ

        setTimeout(() => {
            saveBtn.innerText = originalText;
            saveBtn.disabled = false;
        }, 1500);
    } else {
        alert("‚úÖ Â∑≤ÊàêÂäü‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï");
    }
}

function toggleDreamHistory() {
    const panel = document.getElementById('dream-history-panel');
    panel.classList.toggle('open');
    if(panel.classList.contains('open')) renderDreamHistory();
}

function renderDreamHistory() {
    const list = JSON.parse(localStorage.getItem('dream_history') || '[]');
    const container = document.getElementById('dream-history-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:10px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.cursor = 'pointer';
        
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888;">${new Date(item.date).toLocaleString()}</div>
            <div style="font-size:0.75rem; color:#6a1b9a; margin:5px 0;">üé¥ ${item.cards}</div>
            <div style="text-align:right;">
                 <button class="m-btn small" onclick="event.stopPropagation(); deleteDreamHistory(${index})" style="background:#ff6b6b; color:white;">Âà†Èô§</button>
            </div>
        `;
        div.onclick = () => {
            document.getElementById('dream-result-area').style.display = 'block';
            document.getElementById('dream-analysis-content').innerHTML = item.htmlContent;
            document.getElementById('dream-history-panel').classList.remove('open');
            currentDreamResult = item;
        };
        container.appendChild(div);
    });
}

function deleteDreamHistory(index) {
    if(!confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const list = JSON.parse(localStorage.getItem('dream_history') || '[]');
    list.splice(index, 1);
    localStorage.setItem('dream_history', JSON.stringify(list));
    renderDreamHistory();
}

let hpActiveDeck = [];
let hpFlippedCards = [];
let hpCurrentResult = null; 
function openHisPhoneApp() {
    document.getElementById('his-phone-modal').style.display = 'flex';
    document.getElementById('hp-intro-view').style.display = 'flex';
    document.getElementById('hp-card-view').style.display = 'none';
    document.getElementById('hp-os-view').style.display = 'none';
    const now = new Date();
    document.getElementById('hp-clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
}

function closeHisPhoneApp() {
    document.getElementById('his-phone-modal').style.display = 'none';
}
function startHisPhoneDrawing() {
    document.getElementById('hp-intro-view').style.display = 'none';
    document.getElementById('hp-card-view').style.display = 'flex';
    
    const area = document.getElementById('hp-card-area');
    area.innerHTML = '';
    hpActiveDeck = [];
    hpFlippedCards = [];
    document.getElementById('hp-flipped-count').innerText = '0';
    let fullDeck = [];
    for(let i=0; i<=77; i++) fullDeck.push({ type: 'tarot', id: i, isReversed: Math.random()<0.3 });
    for(let i=1; i<=36; i++) fullDeck.push({ type: 'lenormand', id: i, isReversed: false });
    
    fullDeck.sort(() => Math.random() - 0.5);
    hpActiveDeck = fullDeck;
    const cardW = 60, cardH = 90, gap = 10;
    const cols = Math.floor((window.innerWidth - 20) / (cardW + gap));
    const startX = (window.innerWidth - (cols * (cardW+gap))) / 2;

    hpActiveDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols;
        const row = Math.floor(i / cols);
        el.style.left = (startX + col * (cardW + gap)) + 'px';
        el.style.top = (60 + row * (cardH + gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*6-3}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);

        el.onclick = () => flipHisPhoneCard(el, card);
        area.appendChild(el);
    });
    const rows = Math.ceil(hpActiveDeck.length / cols);
    area.style.height = (rows * (cardH + gap) + 150) + 'px';
}

async function flipHisPhoneCard(el, card) {
    if(el.classList.contains('flipped')) {
        el.classList.remove('flipped');
        hpFlippedCards = hpFlippedCards.filter(c => !(c.type===card.type && c.id===card.id));
    } else {
        el.classList.add('flipped');
        hpFlippedCards.push(card);
        const dbName = card.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        try {
            const item = await idb.get(dbName, card.id);
            const front = el.querySelector('.playing-card-front');
            if(item && item.data) {
                front.style.backgroundImage = `url(${item.data})`;
            } else {
                front.style.backgroundColor = '#ddd';
                front.innerText = card.id;
            }
            if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
            else front.style.transform = "rotateY(180deg)";
        } catch(e){}
    }
    document.getElementById('hp-flipped-count').innerText = hpFlippedCards.length;
}
async function finishHisPhoneReading() {
    if(hpFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøªÂºÄ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#hp-card-view .m-btn.primary');
    const originalText = btn.innerText;
    btn.innerText = "Ê≠£Âú®Á†¥Ëß£ÂØÜÁ†Å (AIÁîüÊàê‰∏≠)...";
    btn.disabled = true;
    const cardsDesc = hpFlippedCards.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(",");
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const phoneCtx = (wb['11.Êç°Âà∞taÁöÑÊâãÊú∫'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
        let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    // ‰øÆÂ§çÔºöÂè™Ë¶ÅÊúâ‰∏ÄÈ°πÁº∫Â§±ÔºåÂ∞±Â∞ùËØï‰ªéÁºìÂ≠òÂÖ®ÈáèËØªÂèñ
    if(!apiKey || !model) {
        try {
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
            if(!apiKey) apiKey = s.key; 
            if(!apiUrl) apiUrl = s.url; 
            if(!model) model = s.model;
        } catch(e){}
    }
    // ÂÖúÂ∫ïÈªòËÆ§
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";
    /* --- ÊâæÂà∞ window.finishHisPhoneReading ÂáΩÊï∞Ôºå‰øÆÊîπ prompt ÂèòÈáèÈÉ®ÂàÜ --- */

    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®Ê®°Êãü**ÁõÆÊ†áËßíËâ≤**ÁöÑÊâãÊú∫ÂÜÖÂÆπ„ÄÇ
„ÄêËßíËâ≤/‰∏ñÁïåËÆæÂÆö„ÄëÔºö
${globalCtx}
„ÄêÊç°ÊâãÊú∫ÁâπÂà´ËÆæÂÆö„ÄëÔºö
${phoneCtx}
„ÄêÊäΩÂà∞ÁöÑÂëΩËøêÁâå (‰Ωú‰∏∫ÁîüÊàêÂÜÖÂÆπÁöÑÊΩúÊÑèËØÜÊåáÂºï)„ÄëÔºö
${cardsDesc}

„Äê‰ªªÂä°„Äë
ËØ∑ÁîüÊàê‰∏Ä‰∏™ JSON ÂØπË±°ÔºåÊ®°ÊãüËØ•ËßíËâ≤ÊâãÊú∫ÈáåÁöÑÁúüÂÆûÊï∞ÊçÆ„ÄÇ
ÂÜÖÂÆπÂøÖÈ°ªÁ¨¶ÂêàËßíËâ≤ÊÄßÊ†ºÂíåÁâåÊÑèÔºà‰æãÂ¶ÇÔºöÈ´òÂÜ∑ËßíËâ≤ÁöÑÂ§áÂøòÂΩïÂèØËÉΩÂæàÁÆÄÊ¥ÅÔºåÁóÖÂ®áËßíËâ≤ÁöÑÊµèËßàÂô®ËÆ∞ÂΩïÂèØËÉΩÂæàÂèØÊÄïÔºåÁªìÂêàÁâåÊÑè‰ΩìÁé∞ÂΩì‰∏ãÂøÉÁêÜÔºâ„ÄÇ

„ÄêJSON ÁªìÊûÑË¶ÅÊ±Ç„Äë
{
  "xiaohongshu": [ {"type": "liked", "title": "...", "content": "..."}, {"type": "posted", "title": "...", "content": "..."} ], 
  "browser": [ "ÊêúÁ¥¢ËÆ∞ÂΩï1", "ÊêúÁ¥¢ËÆ∞ÂΩï2", "..." ],
  "wechat": [
    { 
      "name": "User(Êàë)", "is_user": true, 
      "messages": [ {"role": "me", "text": "Áî®Êà∑ÁöÑËØù"}, {"role": "other", "text": "ËßíËâ≤ÁöÑÂõûÂ§ç"} ] 
    },
    {
      "name": "NPCÂêçÂ≠ó", "is_user": false,
      "messages": [ {"role": "other", "text": "..."} ]
    }
  ],
  "taobao": [ {"item": "ÂïÜÂìÅÂêç", "date": "1Â§©Ââç"}, ... ],  
  "photos": [ {"desc": "‰∏ÄÂº†Ê®°Á≥äÁöÑÂ§úÊôØÁÖßÁâáÔºåÈÖçÊñáÔºöÂèàÊòØÂä†Áè≠..."}, {"desc": "‰∏ÄÂè™ÊµÅÊµ™Áå´ÁöÑÁÖßÁâáÔºåÈò≥ÂÖâÂæàÂ•Ω"} ], 
  "memo": [ "Â§áÂøòÂΩïÂÜÖÂÆπ1...", "..." ],
  "diary": "‰ªäÂ§©ÁöÑÊó•ËÆ∞Ê≠£Êñá...",
  "map": [ "ÂØºËà™ËÆ∞ÂΩï1 (Âú∞ÁÇπ+ÂéüÂõ†)", "ÂØºËà™ËÆ∞ÂΩï2..." ] 
}
Âè™ËæìÂá∫ JSONÔºå‰∏çË¶Å Markdown„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl || "https://api.openai.com/v1"}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{role: "system", content: "You are a creative writer. Output strictly JSON."}, {role: "user", content: prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        let content = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        
        hpCurrentResult = JSON.parse(content);
        hpCurrentResult.date = Date.now();
        hpCurrentResult.cards = cardsDesc; 
        renderHisPhoneOS(hpCurrentResult);

    } catch(e) {
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
        console.error(e);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}
/* --- ÊâæÂà∞ window.renderHisPhoneOS ÂáΩÊï∞ÔºåÂÆåÂÖ®ÊõøÊç¢‰∏∫‰ª•‰∏ãÂÜÖÂÆπ --- */

function renderHisPhoneOS(data) {
    document.getElementById('hp-card-view').style.display = 'none';
    const osView = document.getElementById('hp-os-view');
    osView.style.display = 'flex';
    
    // 1. ‰øÆÊîπËÉåÊôØÂõæ
    osView.style.backgroundImage = "url('https://i.postimg.cc/BQtvjmdG/IMG-1934.jpg')";
    osView.style.backgroundSize = "cover";
    osView.style.backgroundPosition = "center";
    
    const grid = document.getElementById('hp-home-screen');
    grid.innerHTML = '';

    // 2. ‰øÆÊîπÂõæÊ†áÂàóË°® (‰ΩøÁî®‰Ω†Êèê‰æõÁöÑÂõæÁâáÈìæÊé•)
    const apps = [
        { id: 'xiaohongshu', img: 'https://i.postimg.cc/VNrTM8Dd/IMG_1924.png', label: 'Â∞èÁ∫¢‰π¶' },
        { id: 'wechat',      img: 'https://i.postimg.cc/JhDgJLPt/IMG_1923.png', label: 'ÂæÆ‰ø°' },
        { id: 'browser',     img: 'https://i.postimg.cc/9fRSThJX/IMG_1929.png', label: 'ÊµèËßàÂô®' },
        { id: 'taobao',      img: 'https://i.postimg.cc/fbtFXNBb/IMG_1925.png', label: 'Ê∑òÂÆù' },
        { id: 'memo',        img: 'https://i.postimg.cc/XvGhFbQq/IMG_1926.png', label: 'Â§áÂøòÂΩï' },
        { id: 'diary',       img: 'https://i.postimg.cc/d0kXdY4t/IMG_1927.png', label: 'Êó•ËÆ∞' },
        // ÂéüÊù•ÁöÑ Settings Êîπ‰∏∫ Map
        { id: 'map',         img: 'https://i.postimg.cc/3w46pTn8/IMG_1928.png', label: 'Âú∞Âõæ' }, 
        { id: 'photos',      img: 'https://i.postimg.cc/pdh78HqP/IMG_1930.png', label: 'Áõ∏ÂÜå' }  
    ];

    apps.forEach(app => {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.flexDirection = 'column';
        div.style.alignItems = 'center';
        
        // Ê≥®ÊÑèÔºöËøôÈáåÁî® style.backgroundImage ËÆæÁΩÆÂõæÁâá
        div.innerHTML = `
            <div class="hp-app-icon" style="background-image:url('${app.img}')" onclick="openFakeApp('${app.id}')"></div>
            <div class="hp-icon-label" style="text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${app.label}</div>
        `;
        grid.appendChild(div);
    });
}
function openFakeApp(appId) {
    if(!hpCurrentResult) return;
   

    const modal = document.getElementById('hp-app-detail-modal');
    const titleEl = document.getElementById('hp-app-title');
    const contentEl = document.getElementById('hp-app-content');
    contentEl.innerHTML = ''; 

    modal.style.display = 'flex';

    const data = hpCurrentResult;

    if (appId === 'xiaohongshu') {
        titleEl.innerText = "Â∞èÁ∫¢‰π¶";
        contentEl.style.background = "#f5f5f5";
        (data.xiaohongshu || []).forEach(post => {
            const card = document.createElement('div');
            card.className = 'hp-xhs-card';
            card.innerHTML = `
                <div class="hp-xhs-img"></div>
                <div style="padding:10px;">
                    <div style="font-weight:bold; font-size:0.9rem;">${post.title}</div>
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">${post.content}</div>
                    <div style="font-size:0.7rem; color:#ff2d55; margin-top:5px;">${post.type === 'liked' ? '‚ù§Ô∏è ËµûËøá' : 'üë§ ÂèëÂ∏É'}</div>
                </div>
            `;
            contentEl.appendChild(card);
        });
    }
    else if (appId === 'browser') {
        titleEl.innerText = "Safari";
        contentEl.style.background = "white";
        contentEl.innerHTML = `<div style="padding:15px; font-weight:bold; color:#333;">ÂéÜÂè≤ËÆ∞ÂΩï</div>`;
        (data.browser || []).forEach(item => {
            contentEl.innerHTML += `<div style="padding:12px 15px; border-bottom:1px solid #eee; color:#007aff;">üîç ${item}</div>`;
        });
    }
    else if (appId === 'wechat') {
        titleEl.innerText = "ÂæÆ‰ø°";
        contentEl.style.background = "white";
        (data.wechat || []).forEach((chat, idx) => {
            const row = document.createElement('div');
            row.className = 'hp-wechat-row';
            const color = chat.is_user ? '#07c160' : '#ddd';
            const lastMsg = chat.messages[chat.messages.length-1].text;
            
            row.innerHTML = `
                <div class="hp-wechat-avatar" style="background:${color}; display:flex; justify-content:center; align-items:center; color:white; font-size:0.8rem;">${chat.name[0]}</div>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333;">${chat.name}</div>
                    <div style="font-size:0.8rem; color:#999; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:200px;">${lastMsg}</div>
                </div>
            `;
            row.onclick = () => showFakeChatDetail(chat);
            contentEl.appendChild(row);
        });
    }
    else if (appId === 'taobao') {
        titleEl.innerText = "Ê∑òÂÆù";
        contentEl.style.background = "#f2f2f2";
        (data.taobao || []).forEach(item => {
            const div = document.createElement('div');
            div.className = 'hp-taobao-item';
            div.innerHTML = `
                <div style="width:60px; height:60px; background:#ddd; border-radius:4px;"></div>
                <div style="flex:1;">
                    <div style="font-size:0.9rem; line-height:1.2;">${item.item}</div>
                    <div style="font-size:0.8rem; color:#ff5000; margin-top:5px; font-weight:bold;">¬• ???</div>
                    <div style="font-size:0.7rem; color:#999; margin-top:2px;">Ë¥≠‰π∞‰∫é ${item.date || 'ÊúÄËøë'}</div>
                </div>
            `;
            contentEl.appendChild(div);
        });
    }
    else if (appId === 'memo') {
        titleEl.innerText = "Â§áÂøòÂΩï";
        contentEl.style.background = "white";
        contentEl.innerHTML = `<h2 style="padding:15px 0 0 15px; margin:0;">Â§áÂøòÂΩï</h2>`;
        (data.memo || []).forEach(note => {
            const div = document.createElement('div');
            div.className = 'hp-memo-item';
            div.style.margin = "15px";
            div.innerText = note;
            contentEl.appendChild(div);
        });
    }
    else if (appId === 'photos') {
        titleEl.innerText = "Áõ∏ÂÜå"; contentEl.style.background = "white";
        contentEl.innerHTML = (data.photos || []).map(p => 
            `<div style="background:#eee; margin:10px; height:120px; display:flex; align-items:center; justify-content:center; padding:10px; text-align:center; color:#555; border-radius:8px; font-size:0.9rem;">üñºÔ∏è [ÂõæÁâá]<br>${p.desc}</div>`
        ).join('') || '<div style="padding:20px;text-align:center">Á©∫Á©∫Â¶Ç‰πü</div>';
    }
    else if (appId === 'diary') {
        titleEl.innerText = "Êó•ËÆ∞";
        contentEl.style.background = "#fff";
        contentEl.innerHTML = `
            <div style="padding:20px; line-height:1.8; font-family:serif; color:#333;">
                <div style="color:#999; margin-bottom:15px;">${new Date().toLocaleDateString()}</div>
                ${(data.diary || "").replace(/\n/g, "<br>")}
                     </div>
        `;
    }
    
    // üî• Êñ∞Â¢ûÔºöÂú∞ÂõæÈÄªËæë üî•
    else if (appId === 'map') {
        titleEl.innerText = "ÂØºËà™Ë∂≥Ëøπ";
        contentEl.style.background = "#f7f7f7";
        contentEl.innerHTML = `<div style="padding:15px; color:#666; font-size:0.8rem;">Âü∫‰∫éÁâåÊÑèÁîüÊàêÁöÑ‰ªäÊó•Ë°åÁ®ãÔºö</div>`;
        
        // ÂÖºÂÆπÊóßÊï∞ÊçÆÔºàÂ¶ÇÊûúÊóßÊï∞ÊçÆÊ≤°Êúâ map Â≠óÊÆµÔºâ
        const mapRecords = data.map || ["ÊöÇÊó†ÂØºËà™ËÆ∞ÂΩï"];
        
        mapRecords.forEach(record => {
            contentEl.innerHTML += `
                <div style="margin:10px 15px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-left:4px solid #3498db;">
                    <div style="font-weight:bold; color:#2c3e50; margin-bottom:5px;">üìç ${record}</div>
                    <div style="font-size:0.7rem; color:#95a5a6;">Â∑≤Âà∞Ëææ</div>
                </div>
            `;
        });
    }
}

function closeFakeApp() {
    document.getElementById('hp-app-detail-modal').style.display = 'none';
}

function showFakeChatDetail(chat) {
    const contentEl = document.getElementById('hp-app-content');
    const titleEl = document.getElementById('hp-app-title');
    titleEl.innerText = chat.name;
    contentEl.innerHTML = '';
    contentEl.style.background = "#f5f5f5";

    chat.messages.forEach(msg => {
        const bubble = document.createElement('div');
        const isMe = msg.role === 'me'; 
        bubble.className = `hp-chat-bubble ${msg.role === 'me' ? 'me' : 'other'}`;
        bubble.innerText = msg.text;
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.flexDirection = 'column';
        row.style.padding = '5px';
        row.appendChild(bubble);
        contentEl.appendChild(row);
    });
}
function saveHisPhoneResult() {
    if(!hpCurrentResult) return;
    
    try {
        let list = [];
        try {
            list = JSON.parse(localStorage.getItem('his_phone_history') || '[]');
        } catch (e) {
            console.warn("ÂéÜÂè≤Êï∞ÊçÆÊçüÂùèÔºåÂ∑≤ÈáçÁΩÆ");
            list = [];
        }
        if(list.length > 0 && list[0].date === hpCurrentResult.date) {
            return alert("‚ö†Ô∏è ËøôÊù°ËØÅÊçÆÂ∑≤Áªè‰øùÂ≠òËøá‰∫ÜÔºåÊó†ÈúÄÈáçÂ§ç‰øùÂ≠ò„ÄÇ");
        }
        list.unshift(hpCurrentResult);
        if(list.length > 20) list.pop();

        localStorage.setItem('his_phone_history', JSON.stringify(list));
        const btn = document.getElementById('btn-hp-save');
        const originalText = btn.innerText;
        btn.innerText = "‚úÖ Â∑≤‰øùÂ≠ò";
        btn.disabled = true; 
        
        setTimeout(() => { 
            btn.innerText = originalText;
            btn.disabled = false;
        }, 1500);
        if(document.getElementById('hp-history-panel').classList.contains('open')) {
            renderHisPhoneHistory(); 
        }
        
        alert("‚úÖ ËØÅÊçÆÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩïÔºÅ");

    } catch (e) {
        console.error("‰øùÂ≠òÂ§±Ë¥•:", e);
        
        if (e.name === 'QuotaExceededError') {
            alert("‚ùå ‰øùÂ≠òÂ§±Ë¥•ÔºöÂ≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºÅ\nËØ∑Âà†Èô§‰∏Ä‰∫õÊóßÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºàÂ°îÁΩóÁâå„ÄÅÂÜ∞ÁÆ±Êàñ‰ø°‰ª∂ËÆ∞ÂΩïÔºâÂêéÂÜçËØï„ÄÇ");
        } else {
            alert("‚ùå ‰øùÂ≠òÂá∫ÈîôÔºöÁ≥ªÁªüÂèëÁîüÊú™Áü•ÈîôËØØ\n" + e.message);
        }
    }
}
function toggleHisPhoneHistory() {
    const panel = document.getElementById('hp-history-panel');
    panel.classList.toggle('open');
    if(panel.classList.contains('open')) renderHisPhoneHistory();
}

function renderHisPhoneHistory() {
    const list = JSON.parse(localStorage.getItem('his_phone_history') || '[]');
    const container = document.getElementById('hp-history-list');
    container.innerHTML = '';
    
    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.cursor = 'pointer';
        div.innerHTML = `
            <div style="font-weight:bold;">${new Date(item.date).toLocaleString()}</div>
            <div style="font-size:0.8rem; color:#888;">üÉè ${item.cards}</div>
            <button class="m-btn small" onclick="event.stopPropagation(); deleteHisPhoneHistory(${index})" style="margin-top:5px; background:#ff6b6b; color:white; float:right;">Âà†Èô§</button>
        `;
        div.onclick = () => {
            hpCurrentResult = item;
            renderHisPhoneOS(item);
            document.getElementById('hp-history-panel').classList.remove('open');
            document.getElementById('hp-intro-view').style.display = 'none';
        };
        container.appendChild(div);
    });
}

function deleteHisPhoneHistory(index) {
    let list = JSON.parse(localStorage.getItem('his_phone_history') || '[]');
    list.splice(index, 1);
    localStorage.setItem('his_phone_history', JSON.stringify(list));
    renderHisPhoneHistory();
}
function getStudyData() {
    return JSON.parse(localStorage.getItem('study_plan_data') || 'null');
}

function saveStudyData(data) {

    if (typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'study', data: data });
    }
    if (window.BIG_MEMORY) {
        window.BIG_MEMORY.study = data;
    } else {
        window.BIG_MEMORY = { study: data };
    }
    
    console.log("‚úÖ Â≠¶‰π†ËÆ°ÂàíÂ∑≤Â≠òÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì");
}
function openStudyApp() {
    document.getElementById('study-modal').style.display = 'flex';
    renderStudyApp();
}

function closeStudyApp() {
    document.getElementById('study-modal').style.display = 'none';
}
function renderStudyApp() {
    const data = getStudyData();
    
    if (data && data.tasks && data.tasks.length > 0) {
        document.getElementById('study-create-view').style.display = 'none';
        document.getElementById('study-list-view').style.display = 'flex';
        renderStudyList(data);
    } else {
        document.getElementById('study-create-view').style.display = 'flex';
        document.getElementById('study-list-view').style.display = 'none';
    }
}
async function generateStudyPlan() {
    const goal = document.getElementById('study-goal').value;
    const period = document.getElementById('study-period').value;
    const status = document.getElementById('study-status').value;
    const useWb = document.getElementById('study-use-wb').checked;
    
    if (!goal || !period) return alert("ËØ∑Â°´ÂÜôÁõÆÊ†áÂíåÂë®ÊúüÔºÅ");

    const btn = document.getElementById('btn-study-gen');
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "üîç ÊêúÁ¥¢ËµÑÊ∫êÂπ∂ËßÑÂàí‰∏≠..."; // Êîπ‰∏™ÊñáÊ°àÂ¢ûÂä†ÁúüÂÆûÊÑü

    let apiKey = "", apiUrl = "", model = "";
    try {
        const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
        apiKey = s.key; apiUrl = s.url; model = s.model;
    } catch(e){}
    if (!apiKey) apiKey = document.getElementById('api-key').value;
    if (!apiUrl) apiUrl = document.getElementById('api-url').value;
    if (!model) model = document.getElementById('model-select').value;

    if (!apiKey) {
        btn.disabled = false; btn.innerText = originalText;
        return alert("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    }
    if (apiUrl && apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";
    
    const chatSettings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    const charName = chatSettings.title || "ËßíËâ≤";
    const wb = getWBData();
    const globalContext = useWb ? ((wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n")) : "";
    
    // --- ‰øÆÊîπ‰∫Ü Prompt ---
    const prompt = `
‰Ω†Áé∞Âú®ÊâÆÊºî‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤Ôºö„Äê${charName}„Äë„ÄÇ
${globalContext}

„ÄêÁî®Êà∑ËØ∑Ê±Ç„Äë
ËØ∑‰∏∫ÊàëÂà∂ÂÆö‰∏Ä‰∏™Â≠¶‰π†ËÆ°Âàí„ÄÇ
- ÁõÆÊ†áÔºö${goal}
- Âë®ÊúüÔºö${period}
- ÁõÆÂâçÊÉÖÂÜµÔºö${status}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
1. **Êé®ËçêÁúüÂÆûËµÑÊ∫ê**ÔºöËØ∑ÊêúÁ¥¢ÁΩëÁªúÔºåÊé®Ëçê 2-3 Êú¨ÁªèÂÖ∏ÁöÑ**ÂÆû‰ΩìÊïôÊùê/‰π¶Á±ç**Ôºå‰ª•Âèä Bilibili ‰∏äÂÖ∑‰ΩìÁöÑ**UP‰∏ªÂêçÁß∞ÊàñËØæÁ®ãÂÖ≥ÈîÆËØç**ÔºàÂøÖÈ°ªÊòØÁúüÂÆûÂ≠òÂú®‰∏îÈ´òË¥®ÈáèÁöÑÔºâ„ÄÇ
2. **‰ªªÂä°ÁªÜÂåñ**ÔºöÊØèÂ§©ÁöÑ‰ªªÂä°Â¶ÇÊûúÊó∂Èó¥ËæÉÈïøÔºåËØ∑ÊåâÊó∂Èó¥ÊÆµÊãÜÂàÜ‰∏∫Â∞èÈ°πÔºàÂ¶ÇÔºö09:00-10:00 ÁêÜËÆ∫Ôºå14:00-15:00 Âà∑È¢òÔºâ„ÄÇ
3. **ÊÄùÁª¥ÂØºÂõæ**ÔºöÂú®ÊúÄÂêéÊÄªÁªì‰∏Ä‰∏™Áü•ËØÜÁÇπÁöÑ ASCII Ê†ëÁä∂ÂõæÊàñÊÄùÁª¥ÂØºÂõæÁªìÊûÑ„ÄÇ
4. **ËØ≠Ê∞î**ÔºöÂÆåÂÖ®Á¨¶Âêà„Äê${charName}„ÄëÁöÑ‰∫∫ËÆæ„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
**‰∏•Ê†ºËæìÂá∫ JSON Ê†ºÂºè**Ôºå‰∏çË¶Å Markdown ‰ª£Á†ÅÂùó„ÄÇ
ÁªìÊûÑÂ¶Ç‰∏ãÔºö
{
  "title": "ËÆ°ÂàíÊ†áÈ¢ò",
  "resources": [
     {"type": "ÊïôÊùê", "name": "‰π¶Âêç-‰ΩúËÄÖ"},
     {"type": "BÁ´ô", "name": "UP‰∏ªÂêç/ËØæÁ®ãÂÖ≥ÈîÆËØç"}
  ],
  "mind_map": "Ê†πËäÇÁÇπ\\n  ‚îú‚îÄ Áü•ËØÜÁÇπA\\n  ‚îî‚îÄ Áü•ËØÜÁÇπB...",
  "tasks": [
    { 
      "day": "Day X", 
      "content": "‰ªäÊó•Ê¶ÇË¶Å", 
      "sub_tasks": ["09:00 ÁúãÁ¨¨‰∏ÄÁ´†", "14:00 ÂÅö‰π†È¢ò"], 
      "quote": "..." 
    }
  ]
}
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{role: "system", content: "You are a helpful tutor. Output strictly JSON."}, {role: "user", content: prompt}],
                temperature: 0.7
            })
        });

        const json = await res.json();
        if (json.error) throw new Error(json.error.message);
        
        let raw = json.choices[0].message.content;
        raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();
        const planData = JSON.parse(raw);
        
        // ÂÖºÂÆπÂ§ÑÁêÜÔºöÁªôÊñ∞‰ªªÂä°Âä† completed Áä∂ÊÄÅ
        const newTasks = planData.tasks.map(t => ({ ...t, completed: false }));
        
        // ÊûÑÈÄ†ÂÆåÊï¥Êï∞ÊçÆÂØπË±°
        let currentData = {
            title: planData.title,
            meta_period: period,
            resources: planData.resources || [], // Êñ∞Â¢ûËµÑÊ∫êÂ≠óÊÆµ
            mind_map: planData.mind_map || "",   // Êñ∞Â¢ûÊÄùÁª¥ÂØºÂõæÂ≠óÊÆµ
            tasks: newTasks
        };
        
        saveStudyData(currentData); // Â≠òÂÖ•Êó†ÈôêÂ≠òÂÇ®
        
        NotificationManager.send({
            title: "üìÖ Â≠¶‰π†ËÆ°ÂàíÂ∑≤ÁîüÊàê",
            body: "ÂåÖÂê´ÊïôÊùêÊé®Ëçê‰∏éÊÄùÁª¥ÂØºÂõæÔºåÂø´ÂéªÁúãÁúãÂêßÔºÅ",
            icon: "üéì",
            onClick: () => openStudyApp()
        });
        renderStudyApp();

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
}
function renderStudyList(data) {
    document.getElementById('study-plan-title').innerText = data.title || "ÊàëÁöÑÂ≠¶‰π†ËÆ°Âàí";
    document.getElementById('study-plan-meta').innerText = `ÁõÆÊ†á: ${data.meta_period || 'Êú™Áü•'}`;

    const container = document.getElementById('study-tasks-container');
    container.innerHTML = '';
    
    // --- Êñ∞Â¢ûÔºöÊòæÁ§∫Êé®ËçêËµÑÊ∫ê ---
    if (data.resources && data.resources.length > 0) {
        const resDiv = document.createElement('div');
        resDiv.className = 'morandi-card';
        resDiv.style.padding = '12px';
        resDiv.style.marginBottom = '15px';
        resDiv.style.background = '#fff';
        
        let resHtml = '<div style="font-weight:bold; color:#455a64; margin-bottom:8px; font-size:0.9rem;">üìö Êé®ËçêÊïôÊùê & BÁ´ôËØæÁ®ã</div>';
        data.resources.forEach(r => {
            const icon = r.type.includes('BÁ´ô') ? 'üì∫' : 'üìñ';
            resHtml += `<span class="study-resource-tag">${icon} ${r.name}</span>`;
        });
        resDiv.innerHTML = resHtml;
        container.appendChild(resDiv);
    }

    // ËøõÂ∫¶Êù°ÈÄªËæëÔºà‰øùÊåÅ‰∏çÂèòÔºâ
    const total = data.tasks.length;
    const done = data.tasks.filter(t => t.completed).length;
    const percent = total === 0 ? 0 : Math.round((done / total) * 100);
    document.getElementById('study-progress-text').innerText = `${done}/${total}`;
    document.getElementById('study-progress-bar').style.width = `${percent}%`;

    // Ê∏≤Êüì‰ªªÂä°ÂàóË°®
    data.tasks.forEach((task, index) => {
        const div = document.createElement('div');
        div.className = `study-task-card ${task.completed ? 'completed' : ''}`;
        
        // ÊûÑÂª∫ÁªÜÂàÜÂ∞èÈ°π HTML
        let subTasksHtml = '';
        if (task.sub_tasks && task.sub_tasks.length > 0) {
            subTasksHtml = `<div style="margin-top:8px;">`;
            task.sub_tasks.forEach(sub => {
                subTasksHtml += `<div class="study-sub-task">‚Ä¢ ${sub}</div>`;
            });
            subTasksHtml += `</div>`;
        }

        div.innerHTML = `
            <div class="study-task-header">
                <span class="study-day-tag">${task.day}</span>
                <div class="check-icon">‚úì</div>
            </div>
            <div class="study-task-content" style="font-weight:500;">${task.content}</div>
            ${subTasksHtml} <!-- ÊèíÂÖ•ÁªÜÂàÜ‰ªªÂä° -->
            <div class="study-quote-box">
                ‚Äú ${task.quote} ‚Äù
            </div>
        `;
        div.onclick = () => toggleStudyTask(index);
        container.appendChild(div);
    });

    // --- Êñ∞Â¢ûÔºöÊòæÁ§∫ÊÄùÁª¥ÂØºÂõæ ---
    if (data.mind_map) {
        const mapDiv = document.createElement('div');
        mapDiv.className = 'morandi-card';
        mapDiv.style.padding = '15px';
        mapDiv.style.marginTop = '15px';
        mapDiv.style.marginBottom = '20px';
        
        mapDiv.innerHTML = `
            <div style="font-weight:bold; color:#455a64; margin-bottom:10px;">üß† Â≠¶‰π†ÊÄùÁª¥ÂØºÂõæ</div>
            <div class="mind-map-box">${data.mind_map}</div>
        `;
        container.appendChild(mapDiv);
    }
}
function toggleStudyTask(index) {
    const data = getStudyData();
    data.tasks[index].completed = !data.tasks[index].completed;
    saveStudyData(data);
    renderStudyList(data);
}
function deleteStudyPlan() {
    if(confirm("Á°ÆÂÆöË¶ÅÊîæÂºÉËøô‰∏™ËÆ°ÂàíÂêóÔºüÊâÄÊúâËøõÂ∫¶Â∞Ü‰∏¢Â§±„ÄÇ")) {
        localStorage.removeItem('study_plan_data');
        renderStudyApp(); 
    }
}
(async function initThemeDB() {
    const dbName = "RetroOS_System_V7789"; 
})();
const APP_MAP = [
    { id: 'settings', name: 'ËÆæÁΩÆ', selector: 'div[onclick="openSettings()"]' },
    { id: 'gacha', name: 'ÂëΩËøêÊäΩÂç°', selector: 'div[onclick="openGachaCardApp()"]' },
   { id: 'worldbook', name: '‰∏ñÁïå‰π¶', selector: 'div[onclick="openWorldBook()"]' },
    { id: 'camera', name: 'Áõ∏Êú∫', selector: 'div[onclick="openCamera()"]' },
    { id: 'file', name: 'Êñá‰ª∂', selector: 'div[onclick="openFileApp()"]' },
    { id: 'finance', name: 'ËÆ∞Ë¥¶', selector: 'div[onclick="openFinanceApp()"]' },
    { id: 'study', name: 'Â≠¶‰π†ËÆ°Âàí', selector: 'div[onclick="openStudyApp()"]' },
    { id: 'theater', name: 'Â∞èÂâßÂú∫', selector: 'div[onclick="openTheaterApp()"]' },
    { id: 'lofter', name: 'ËÄÅÁ¶èÁâπ', selector: 'div[onclick="openLofterApp()"]' },
    { id: 'pickup', name: 'Êç°ÊâãÊú∫', selector: 'div[onclick="openPickupApp()"]' },
    { id: 'period', name: 'ÁªèÊúü', selector: 'div[onclick="openPeriodApp()"]' },
    { id: 'forum', name: 'ËÆ∫Âùõ‰Ωì', selector: 'div[onclick="openForumApp()"]' },
    { id: 'album', name: 'Áõ∏ÂÜå', selector: 'div[onclick="openAlbumApp()"]' },
    { id: 'anniversary', name: 'Á∫™ÂøµÊó•', selector: 'div[onclick="openAnniversaryApp()"]' },
    { id: 'dream', name: 'Ê¢¶App', selector: 'div[onclick="openDreamApp()"]' },
    { id: 'hisphone', name: 'taÁöÑÊâãÊú∫', selector: 'div[onclick="openHisPhoneApp()"]' },
    { id: 'fan', name: 'ÁîµÂ≠êÂ±è', selector: 'div[onclick="openFan()"]' },
    { id: 'shadow', name: 'Èò¥ÊöóÈù¢', selector: 'div[onclick="openShadowApp()"]' },
    { id: 'petdiary', name: 'ÂÆ†Áâ©Êó•ËÆ∞', selector: 'div[onclick="openPetDiaryApp()"]' },
    { id: 'gashapon', name: 'Âπ≥Ë°åÊâ≠Ëõã', selector: 'div[onclick="openGashaponApp()"]' }, 
    { id: 'chat', name: 'ËÅäÂ§©', selector: 'div[onclick="openChatApp()"]' },
    { id: 'tarot', name: 'Â°îÁΩó', selector: 'div[onclick="openTarotApp()"]' },
    { id: 'letter', name: '‰ø°‰ª∂', selector: 'div[onclick="openLetterApp()"]' },
    { id: 'theme', name: 'ÁæéÂåñ', selector: 'div[onclick="openThemeApp()"]' },
    { id: 'pain', name: 'ÂÖ≥‰∫éÁóõËã¶', selector: 'div[onclick="openPainApp()"]' },
    { id: 'thesaurus', name: 'ËØçÂ∫ì', selector: 'div[onclick="openThesaurus()"]' },
    { id: 'summary', name: 'Â≠¶‰π†ÊÄªÁªì', selector: 'div[onclick="openSummaryApp()"]' },
    { id: 'companion', name: 'Èô™‰º¥', selector: 'div[onclick="openCompanionApp()"]' },
    { id: 'teaching', name: 'ÊïôÂØº', selector: 'div[onclick="openTeachingApp()"]' },
    { id: 'work', name: 'Â∑•‰ΩúÊó•Êä•', selector: 'div[onclick="openWorkApp()"]' },
    { id: 'puzzle', name: 'ËÆ∞ÂøÜÊãºÂõæ', selector: 'div[onclick="openPuzzleApp()"]' },
    { id: 'moving', name: 'Êê¨ÂÆ∂Êó•ËÆ∞', selector: 'div[onclick="openMovingApp()"]' },
    { id: 'galgame', name: 'ÊóÆÊóØGame', selector: 'div[onclick="openGalgameApp()"]' },
    { id: 'scent', name: 'È¶ôÁâáÊî∂ÈõÜ', selector: 'div[onclick="openScentApp()"]' },
    // üî• Êñ∞Â¢ûÈÉ®ÂàÜÔºöÁ°Æ‰øùÂ•≥Â∑´ÂíåÈªòÂ•ëÊåëÊàòÂú®ËøôÈáå
    { id: 'witch', name: 'Â•≥Â∑´', selector: 'div[onclick="openWitchApp()"]' },
    { id: 'tacit', name: 'ÈªòÂ•ëÊåëÊàò', selector: 'div[onclick="openTacitApp()"]' }
];
// ÂÆö‰πâÂì™‰∫õ App ÂèØ‰ª•Êç¢ËÉåÊôØÔºå‰ª•ÂèäÂÆÉ‰ª¨ÂØπÂ∫îÁöÑ Modal ID
const APP_BG_MAP = [
    { id: 'study', name: 'Â≠¶‰π†ËÆ°Âàí', modalId: 'study-modal' },
    { id: 'finance', name: 'ËÆ∞Ë¥¶', modalId: 'finance-modal' },
    { id: 'theater', name: 'Â∞èÂâßÂú∫', modalId: 'theater-modal' },
    { id: 'pickup', name: 'Êç°ÊâãÊú∫', modalId: 'pickup-modal' },
    { id: 'period', name: 'ÁªèÊúü', modalId: 'period-modal' },
    { id: 'forum', name: 'ËÆ∫Âùõ‰Ωì', modalId: 'forum-modal' },
    { id: 'album', name: 'Áõ∏ÂÜå', modalId: 'album-app-modal' },
    { id: 'anniversary', name: 'Á∫™ÂøµÊó•', modalId: 'anniversary-modal' },
    { id: 'dream', name: 'Ê¢¶App', modalId: 'dream-app-modal' },
    { id: 'hisphone', name: 'TaÁöÑÊâãÊú∫', modalId: 'his-phone-modal' },
    { id: 'chat', name: 'ËÅäÂ§©', modalId: 'chat-modal' },
    { id: 'tarot', name: 'Â°îÁΩó', modalId: 'tarot-app-modal' },
    { id: 'letter', name: '‰ø°‰ª∂', modalId: 'letter-app-modal' },
    { id: 'lofter', name: 'ËÄÅÁ¶èÁâπ', modalId: 'lofter-modal' },
    { id: 'pain', name: 'ÂÖ≥‰∫éÁóõËã¶', modalId: 'pain-app-modal' },
    { id: 'petdiary', name: 'ÂÆ†Áâ©Êó•ËÆ∞', modalId: 'pet-diary-app-modal' },
    { id: 'gashapon', name: 'Êâ≠ËõãÊú∫', modalId: 'gashapon-app-modal' },
    { id: 'shadow', name: 'Èò¥ÊöóÈù¢', modalId: 'shadow-app-modal' },
    { id: 'summary', name: 'Â≠¶‰π†ÊÄªÁªì', modalId: 'summary-app-modal' },
    // üî• Êñ∞Â¢ûÈÉ®ÂàÜÔºöÁ°Æ‰øùÂêéÁª≠Â¢ûÂä†ÁöÑAPPÈÉΩËÉΩÊç¢ËÉåÊôØ
    { id: 'work', name: 'Â∑•‰ΩúÊó•Êä•', modalId: 'work-app-modal' },
    { id: 'moving', name: 'Êê¨ÂÆ∂Êó•ËÆ∞', modalId: 'moving-app-modal' },
    { id: 'teaching', name: 'ÊïôÂØº', modalId: 'teaching-app-modal' },
    { id: 'companion', name: 'Èô™‰º¥', modalId: 'companion-app-modal' },
    { id: 'galgame', name: 'ÊóÆÊóØGame', modalId: 'galgame-app-modal' },
    { id: 'scent', name: 'È¶ôÁâáÊî∂ÈõÜ', modalId: 'scent-app-modal' },
    { id: 'puzzle', name: 'ËÆ∞ÂøÜÊãºÂõæ', modalId: 'puzzle-app-modal' },
    { id: 'witch', name: 'Â•≥Â∑´', modalId: 'witch-app-modal' },
    { id: 'tacit', name: 'ÈªòÂ•ëÊåëÊàò', modalId: 'tacit-app-modal' }
];

// Ê∏≤ÊüìËÉåÊôØ‰∏ä‰º†ÂàóË°®
async function renderAppBgList() {
    const list = document.getElementById('app-bg-config-list');
    list.innerHTML = '';
    
    for (let item of APP_BG_MAP) {
        const div = document.createElement('div');
        div.className = 'font-setting-item'; // Â§çÁî®Â∑≤ÊúâÊ†∑Âºè
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤‰øùÂ≠òÁöÑËÉåÊôØ
        const saved = await idb.get('settings_heavy', `bg_${item.id}`);
        const statusText = saved ? "‚úÖ Â∑≤ËÆæÁΩÆ" : "‚ö™ ÈªòËÆ§";

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0; font-weight:bold;">${item.name}</label>
                <span style="font-size:0.7rem; color:#888;">${statusText}</span>
            </div>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="file" id="upload_bg_${item.id}" style="display:none" onchange="saveAppBg('${item.id}', this)">
                <button class="m-btn small" onclick="document.getElementById('upload_bg_${item.id}').click()">üì∑ ‰∏ä‰º†ËÉåÊôØ</button>
                <button class="m-btn small" onclick="clearAppBg('${item.id}')" style="background:#ffcdd2; color:red;">üóëÔ∏è Ê∏ÖÈô§</button>
            </div>
        `;
        list.appendChild(div);
    }
}
async function saveAppBg(appId, input) {
    const file = input.files[0];
    if(!file) return;
    
    // ‰øÆÊîπÔºö‰ΩøÁî®ÂéãÁº©ÂáΩÊï∞
    compressImage(file, async (base64) => {
        await idb.put('settings_heavy', { key: `bg_${appId}`, data: base64 });
        alert("ËÉåÊôØÂ∑≤‰øùÂ≠òÔºÅ");
        renderAppBgList(); 
        applyAllThemeSettings(); 
    });
}

// Ê∏ÖÈô§Áã¨Á´ãËÉåÊôØ
async function clearAppBg(appId) {
    if(!confirm("ÊÅ¢Â§çÈªòËÆ§ËÉåÊôØÔºü")) return;
    await idb.delete('settings_heavy', `bg_${appId}`);
    renderAppBgList();
    applyAllThemeSettings();
}

// ‰øùÂ≠òÂÖ®Â±Ä CSS
async function saveGlobalCSS() {
    const css = document.getElementById('global-css-input').value;
    await idb.put('settings_heavy', { key: 'global_custom_css', data: css });
    alert("CSS Â∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ");
    applyGlobalCSS();
}

// Â∫îÁî®ÂÖ®Â±Ä CSS
async function applyGlobalCSS() {
    const res = await idb.get('settings_heavy', 'global_custom_css');
    const css = res ? res.data : "";
    
    // Â°´ÂÖÖÂà∞ËæìÂÖ•Ê°ÜÔºàÂ¶ÇÊûúÊòØÊâìÂºÄËÆæÁΩÆÊó∂Ôºâ
    const inputEl = document.getElementById('global-css-input');
    if(inputEl && !inputEl.value) inputEl.value = css;

    let styleTag = document.getElementById('user-custom-style');
    if(!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'user-custom-style';
        document.head.appendChild(styleTag);
    }
    styleTag.innerHTML = css;
}
// === Êñ∞Â¢û‰ª£Á†Å END ===
function openThemeApp() {
    document.getElementById('theme-modal').style.display = 'flex';
    renderThemeIconsList();
    renderThemeFontsList();
    renderStampList();
    // Êñ∞Â¢ûËøô‰∏§‰∏™Ë∞ÉÁî®Ôºö
    renderAppBgList(); 
    applyGlobalCSS(); // Á°Æ‰øùÊâìÂºÄÊó∂Âä†ËΩΩ CSS ÂÜÖÂÆπÂà∞ËæìÂÖ•Ê°Ü
}


function switchThemeTab(tab) {
    document.querySelectorAll('.theme-tab-content').forEach(el => el.style.display = 'none');
    document.getElementById('theme-tab-' + tab).style.display = 'block';
}
async function renderThemeIconsList() {
    const list = document.getElementById('app-icon-list');
    list.innerHTML = '';
    
    for (let app of APP_MAP) {
        const div = document.createElement('div');
        div.className = 'theme-app-item';
        const savedIcon = await idb.get('settings_heavy', `icon_${app.id}`);
        const bgStyle = savedIcon ? `background-image:url(${savedIcon.data})` : 'background:#ddd';
        
        div.innerHTML = `
            <div class="theme-icon-preview" style="${bgStyle}"></div>
            <div style="font-size:0.8rem;">${app.name}</div>
            <input type="file" style="display:none" id="upload_icon_${app.id}" onchange="saveAppIcon('${app.id}', this)">
        `;
        div.onclick = () => document.getElementById(`upload_icon_${app.id}`).click();
        list.appendChild(div);
    }
}

async function saveAppIcon(appId, input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        await idb.put('settings_heavy', { key: `icon_${appId}`, data: e.target.result });
        renderThemeIconsList();
        applyAllThemeSettings();
    };
    reader.readAsDataURL(file);
}
async function uploadThemeImage(key, input) {
    const file = input.files[0];
    if(!file) return;
    
    // ‰øÆÊîπÔºö‰ΩøÁî®ÂéãÁº©ÂáΩÊï∞
    compressImage(file, async (base64) => {
        await idb.put('settings_heavy', { key: key, data: base64 });
        alert("ËÆæÁΩÆÊàêÂäüÔºÅ‰∏ãÊ¨°ÊâìÂºÄÂØπÂ∫îÁªÑ‰ª∂Êó∂ÁîüÊïà„ÄÇ");
        applyAllThemeSettings(); 
    });
    input.value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÈò≤Ê≠¢ÈáçÂ§çËß¶Âèë
}
function renderThemeFontsList() {
    const list = document.getElementById('font-config-list');
    list.innerHTML = '';
    const fonts = JSON.parse(localStorage.getItem('theme_fonts') || '{}');
    
    APP_MAP.forEach(app => {
        const val = fonts[app.id] || "";
        const div = document.createElement('div');
        div.className = 'font-setting-item'; // ‰ΩøÁî®Êñ∞ CSS Á±ª
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0;">${app.name}</label>
                <button class="m-btn small" onclick="testFont('${app.id}')" style="font-size:0.7rem; padding:2px 8px; background:#eee; color:#666;">ÊµãËØï</button>
            </div>
            <input type="text" value="${val}" 
                placeholder="Á≤òË¥¥Â≠ó‰ΩìÈìæÊé• (https://...)" 
                style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-top:8px; font-size:0.85rem;"
                onblur="saveAppFont('${app.id}', this.value)"
            >
            <div style="font-size:0.7rem; color:#aaa; margin-top:4px;">
                ÂΩìÂâçÂ≠ó‰ΩìÈ¢ÑËßàÔºö<span style="font-family: 'CustomFont${app.id}'; font-size:1rem; color:#333;">123 ABC ÁπÅËä±‰ººÈî¶</span>
            </div>
        `;
        list.appendChild(div);
    });
}
window.testFont = function(appId) {
    alert(`Â∑≤Â∞ùËØïÂä†ËΩΩ ${appId} ÁöÑÂ≠ó‰ΩìÔºåËØ∑Áúã‰∏ãÊñπÁöÑÈ¢ÑËßàÊñáÂ≠óÊòØÂê¶ÂèòÂåñ„ÄÇ`);
}
function saveAppFont(appId, url) {
    const fonts = JSON.parse(localStorage.getItem('theme_fonts') || '{}');
    fonts[appId] = url;
    localStorage.setItem('theme_fonts', JSON.stringify(fonts));
    injectCustomFont(appId, url); 
}
function injectCustomFont(appId, url) {
    if(!url) return;
    
    const styleId = `style-font-${appId}`;
    let styleTag = document.getElementById(styleId);
    if(!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = styleId;
        document.head.appendChild(styleTag);
    }
    const fontName = `CustomFont${appId}`;

        const idMap = {
        'settings': 'settings-modal',
        'worldbook': 'wb-modal',
        'camera': 'camera-modal',
        'file': 'file-modal',
        'finance': 'finance-modal',
        'study': 'study-modal',
        'theater': 'theater-modal',
        'pickup': 'pickup-modal',
        'period': 'period-modal',
        'forum': 'forum-modal',
        'album': 'album-app-modal',       
        'anniversary': 'anniversary-modal',
        'dream': 'dream-app-modal',       
        'hisphone': 'his-phone-modal',    
        'fan': 'fan-modal',
        'chat': 'chat-modal',
        'tarot': 'tarot-app-modal',       
        'letter': 'letter-app-modal',
        // üî• Ë°•ÂÖ®‰ª•‰∏ãÊò†Â∞Ñ
        'lofter': 'lofter-modal',
        'pain': 'pain-app-modal',
        'petdiary': 'pet-diary-app-modal',
        'gashapon': 'gashapon-app-modal',
        'shadow': 'shadow-app-modal',
        'summary': 'summary-app-modal',
        'work': 'work-app-modal',
        'moving': 'moving-app-modal',
        'teaching': 'teaching-app-modal',
        'companion': 'companion-app-modal',
        'galgame': 'galgame-app-modal',
        'scent': 'scent-app-modal',
        'puzzle': 'puzzle-app-modal',
        'witch': 'witch-app-modal',
        'tacit': 'tacit-app-modal'
    };
    let targetId = idMap[appId] || `${appId}-modal`; // ÈªòËÆ§ÂÖúÂ∫ï
    let modalSelector = `#${targetId}`;
    
    styleTag.innerHTML = `
        @font-face { 
            font-family: '${fontName}'; 
            src: url('${url}'); 
            font-display: swap;
        }
        ${modalSelector}, 
        ${modalSelector} input, 
        ${modalSelector} textarea, 
        ${modalSelector} button,
        ${modalSelector} div,
        ${modalSelector} span,
        ${modalSelector} p { 
            font-family: '${fontName}', sans-serif !important; 
        }
    `;
    
    console.log(`Â∑≤‰∏∫ ${appId} (${modalSelector}) Â∫îÁî®Â≠ó‰Ωì: ${url}`);
}
async function handleStampUpload(input) {
    const files = Array.from(input.files);
    if(files.length === 0) return;
    
    let stamps = await idb.get('settings_heavy', 'reply_stamps');
    stamps = stamps ? stamps.data : [];
    
    for(let file of files) {
        await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => {
                stamps.push(e.target.result);
                resolve();
            }
            reader.readAsDataURL(file);
        });
    }
    
    await idb.put('settings_heavy', { key: 'reply_stamps', data: stamps });
    renderStampList();
}

async function renderStampList() {
    const grid = document.getElementById('stamp-preview-grid');
    grid.innerHTML = '';
    let stamps = await idb.get('settings_heavy', 'reply_stamps');
    if(!stamps || !stamps.data) return;
    
    stamps.data.forEach((src, idx) => {
        const div = document.createElement('div');
        div.className = 'stamp-item';
        div.style.backgroundImage = `url(${src})`;
        div.innerHTML = `<div class="stamp-del" onclick="deleteStamp(${idx})">√ó</div>`;
        grid.appendChild(div);
    });
}

async function deleteStamp(index) {
    if(!confirm("Âà†Èô§Ê≠§Âç∞Á´†Ôºü")) return;
    let stamps = await idb.get('settings_heavy', 'reply_stamps');
    stamps.data.splice(index, 1);
    await idb.put('settings_heavy', { key: 'reply_stamps', data: stamps.data });
    renderStampList();
}
// === üé® ÁªàÊûÅÁæéÂåñÂ∫îÁî®ÂáΩÊï∞ (‰øÆÂ§çÂ≠ó‰Ωì/ËÉåÊôØ/Â§ñÂ£≥/ÁâåËÉå) ===
// === üé® ÁªàÊûÅÁæéÂåñÂ∫îÁî®ÂáΩÊï∞ (Â∑≤‰øÆÂ§çÔºö12È¶ôÁâáËÉåÈù¢ÊòæÁ§∫Ëá™ÂÆö‰πâÂõæ) ===
async function applyAllThemeSettings() {
    try {
        console.log("üé® Ê≠£Âú®Â∫îÁî®ÂÖ®Á≥ªÁªüÁæéÂåñ...");
        
        // 1. Â∫îÁî® APP ÂõæÊ†á
        if (typeof APP_MAP !== 'undefined') {
            for (let app of APP_MAP) {
                try {
                    const iconData = await idb.get('settings_heavy', `icon_${app.id}`);
                    if(iconData) {
                        const els = document.querySelectorAll(app.selector + ' .app-icon');
                        els.forEach(el => {
                            if(el) {
                                el.innerText = ''; 
                                el.style.backgroundImage = `url(${iconData.data})`;
                                el.style.backgroundSize = 'cover';
                                el.style.backgroundPosition = 'center';
                                el.style.border = 'none'; 
                                el.style.backgroundColor = 'transparent'; 
                                el.style.boxShadow = 'none'; 
                            }
                        });
                    }
                } catch(err) {}
            }
        }

        // 2. ËØªÂèñÂõæÁâáËµÑÊ∫ê
        const imgKeys = [
  'tv_screen_content',
            'main_bg', 'fridge_cover', 'news_cover', 'memo_cover', 
            'tarot_back', 'tarot_table', 'letter_paper', 
            'game_bg', 'game_char_half', 'game_user_half',
            'diary_widget_bg', 'diary_photo', 'lofter_cover',
            'scent_back', // üå∏ È¶ôÁâáÁâåËÉå
            'game_cover_p2', 
            'shell_tv', 'shell_console_p2', 'shell_console_p3',
            'rpg_user_idle', 'rpg_user_front', 'rpg_user_back', 'rpg_user_right', 'rpg_user_left', 'rpg_npc_idle', // --- Êñ∞Âä†ÁöÑ ---
            'rpg_book_paper', 
            'console_p3_screen_img' 
        ];

        const images = {};
        for(let key of imgKeys) {
            try {
                const res = await idb.get('settings_heavy', key);
                if(res) images[key] = res.data;
            } catch(e) {}
        }

        // 3. Â∫îÁî®Â§ñÂ£≥‰∏éÂ∞ÅÈù¢
// üì∫ ÁîµËßÜÂ±èÂπïÂÜÖÂÆπ (Êñ∞Â¢û)
if(images.tv_screen_content) {
    const tvScreen = document.getElementById('tv-content');
    if(tvScreen) {
        tvScreen.src = images.tv_screen_content;
        tvScreen.style.display = 'block';
        const ph = document.querySelector('.tv-container .tv-placeholder');
        if(ph) ph.style.display = 'none';
    }
}
        
        // ‚ùÑÔ∏è ÂÜ∞ÁÆ±Â∞ÅÈù¢
        if(images.fridge_cover) {
            const fridge = document.querySelector('.fridge-item-large');
            if(fridge) {
                fridge.style.backgroundImage = `url(${images.fridge_cover})`;
                fridge.style.backgroundSize = 'cover';
                fridge.style.backgroundPosition = 'center';
                const sticker = fridge.querySelector('.fridge-sticker');
                if(sticker) sticker.style.display = 'none';
            }
        }

        // üéÆ Á¨¨‰∫åÈ°µÊ∏∏ÊàèÊú∫Â∞ÅÈù¢
        if(images.game_cover_p2) {
            const p2ScreenImg = document.getElementById('widget-game-bg-p3');
            if(p2ScreenImg) {
                p2ScreenImg.src = images.game_cover_p2;
                p2ScreenImg.style.display = 'block';
                p2ScreenImg.style.opacity = '1';
                const placeholder = document.querySelector('#console-widget-p2 .tv-placeholder');
                if(placeholder) placeholder.style.display = 'none';
            }
        }

        // üì∫ ÁîµËßÜÂ§ñÂ£≥
        if(images.shell_tv) {
            const tv = document.getElementById('tv-shell-case');
            if(tv) {
                tv.style.backgroundImage = `url(${images.shell_tv})`;
                tv.style.backgroundSize = '100% 100%'; 
                tv.style.border = 'none'; 
                tv.style.backgroundColor = 'transparent'; 
            }
        }

        // üéÆ Ê∏∏ÊàèÊú∫Â§ñÂ£≥ (P2 & P3)
        if(images.shell_console_p2) {
            const gp2 = document.getElementById('console-widget-p2');
            if(gp2) {
                gp2.style.backgroundImage = `url(${images.shell_console_p2})`;
                gp2.style.backgroundSize = '100% 100%';
                gp2.style.border = 'none';
                gp2.style.backgroundColor = 'transparent';
            }
        }
        if(images.shell_console_p3) {
            const gp3 = document.getElementById('console-widget-p3');
            if(gp3) {
                gp3.style.backgroundImage = `url(${images.shell_console_p3})`;
                gp3.style.backgroundSize = '100% 100%';
                gp3.style.border = 'none';
                gp3.style.backgroundColor = 'transparent';
            }
        }

        // üè† ‰∏ªÈ°µÂ£ÅÁ∫∏
        if(images.main_bg) {
            const sc = document.getElementById('screen');
            if(sc) { sc.style.backgroundImage = `url(${images.main_bg})`; sc.style.backgroundSize = 'cover'; sc.style.backgroundPosition = 'center'; }
        }
        
        // üìù Êó•ËÆ∞ÁªÑ‰ª∂
        if(images.diary_widget_bg) {
            const d = document.getElementById('diary-widget');
            if(d) {
                d.style.backgroundImage = `url(${images.diary_widget_bg})`; d.style.backgroundSize = 'cover';
                const preview = document.getElementById('desktop-diary-preview'); 
                if(preview) { preview.style.display = 'none'; } 
            }
        }

        // üì∞ Êä•Á∫∏ & ËÄÅÁ¶èÁâπÂ∞ÅÈù¢
        if(images.news_cover) {
            const n = document.querySelector('.newspaper-wrap');
            if(n) { n.classList.add('custom-cover-mode'); n.style.backgroundImage = `url(${images.news_cover})`; n.style.backgroundSize = 'cover'; }
        }
        window.LOFTER_COVER_URL = images.lofter_cover || null; 

        // üìú ‰ø°Á∫∏‰∏éÊ∏∏ÊàèËÉåÊôØ
        if(images.letter_paper) {
            document.querySelectorAll('.paper-sheet').forEach(el => { el.style.backgroundImage = `url(${images.letter_paper})`; el.style.backgroundSize = 'cover'; });
        }
        if(images.game_bg) {
            const gc = document.getElementById('game-container');
            if(gc) gc.style.backgroundImage = `url(${images.game_bg})`;
        }

        // 4. üé¥ Âä®ÊÄÅÊ≥®ÂÖ• CSS (ÁâåËÉå‰∏éÁâåÊ°å)
        let customStyle = document.getElementById('dynamic-theme-style');
        if(!customStyle) { 
            customStyle = document.createElement('style'); 
            customStyle.id = 'dynamic-theme-style'; 
            document.head.appendChild(customStyle); 
        }
        
        let cssRules = "";

        // A. ÈÄöÁî®Â°îÁΩóÁâåËÉå
        if(images.tarot_back) {
            cssRules += `
                .t-card-back, .playing-card { 
                    background-image: url('${images.tarot_back}') !important;
                    background-size: cover !important;
                    background-repeat: no-repeat !important;
                    background-color: transparent !important;
                }
            `;
        }

        // B. üå∏ È¶ôÁâá‰∏ìÁî®ÁâåËÉå (ËøôÈáåÊòØ‰øÆÂ§çÈáçÁÇπÔºÅ)
        // ‰ΩúÁî®‰∫é .scent-chip.closed (12‰∏™Êú™ÁøªÂºÄÁöÑÈ¶ôÁâá)
                        // B. üå∏ È¶ôÁâá‰∏ìÁî®ÁâåËÉå (ÁªàÊûÅ‰øÆÊ≠£ÔºöËß£ÂÜ≥ÁøªÂºÄÂèòÁôΩÈóÆÈ¢ò)
        if(images.scent_back) {
            cssRules += `
                /* 1. 12ÂÆ´Ê†ºÁïåÈù¢ÔºöÊú™ÁøªÂºÄÁöÑÈ¶ôÁâáËÉåÈù¢ */
                .scent-chip.closed {
                    background-image: url('${images.scent_back}') !important;
                    background-size: cover !important;
                    background-position: center !important;
                    background-repeat: no-repeat !important;
                    border: none !important; 
                    box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
                }
                /* ÈöêËóèÂéüÊú¨ÁöÑÊñáÂ≠ó */
                .scent-chip.closed::after {
                    opacity: 0 !important;
                }

                /* 2. ÊäΩÁâåÊ°åÔºöÁâåÁöÑËÉåÈù¢ (Êú™ÁøªÂºÄÊó∂) */
                #scent-card-area .playing-card { 
                    background-image: url('${images.scent_back}') !important;
                    background-size: cover !important;
                    background-repeat: no-repeat !important;
                }

                /* 3. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊäΩÁâåÊ°åÔºöÁâåÁöÑÊ≠£Èù¢ (ÁøªÂºÄÂêé) */
                /* ËøôÈáåÁöÑ‰øÆÊîπÔºöÂà†Èô§‰∫Ü background-image ÁöÑËßÑÂàô */
                /* Âè™‰øùÁïô background-color: #fffÔºåÁî®Êù•ÈÅÆÊå°‰ΩèËÉåÈù¢ÁöÑÂõæ */
                /* ËøôÊ†∑ JS ËÆæÁΩÆÁöÑÂ°îÁΩóÁâåÂõæÁâá(inline style) Â∞±‰ºöÁîüÊïà‰∫Ü */
                #scent-card-area .playing-card .playing-card-front {
                    background-color: #fff !important; 
                    /* ‰∏çË¶ÅÂú®ËøôÈáåÂÜô background-image !importantÔºåÂê¶Âàô‰ºöÊääÂ°îÁΩóÁâåÈ°∂Êéâ */
                }
            `;
        }
        // C. ÁâåÊ°åËÉåÊôØ
        if(images.tarot_table) {
            const tables = [
                'card-table-desk', 'diary-card-table-desk', 'game-card-table-desk', 
                'rpg-card-table-desk', 'shadow-card-table-desk', 'pain-card-table-desk', 
                'gashapon-card-table-desk', 'work-card-table-desk', 'puzzle-card-table-desk', 
                'moving-card-table-desk', 'scent-card-table-desk', 'teaching-card-table-desk', 
                'comp-card-table-desk', 'witch-card-table-desk', 'tacit-card-table-desk'
            ];
            tables.forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.style.backgroundImage = `url(${images.tarot_table})`; el.style.backgroundSize = 'cover'; el.style.backgroundPosition = 'center'; }
            });
        }
        
        customStyle.innerHTML = cssRules;

        // 5. Â∫îÁî®Â≠ó‰Ωì
        const fonts = window.BIG_MEMORY.theme_fonts || {};
        for(let [appId, url] of Object.entries(fonts)) {
            if(typeof injectCustomFont === 'function') injectCustomFont(appId, url);
        }

        // 6. Â∫îÁî®ËΩØ‰ª∂Áã¨Á´ãËÉåÊôØ
        if (typeof APP_BG_MAP !== 'undefined') {
            for (let item of APP_BG_MAP) {
                try {
                    const bgData = await idb.get('settings_heavy', `bg_${item.id}`);
                    const modal = document.getElementById(item.modalId);
                    if (modal && bgData && bgData.data) {
                        modal.style.backgroundImage = `url(${bgData.data})`; 
                        modal.style.backgroundSize = 'cover';
                        modal.style.backgroundPosition = 'center';
                        modal.style.backgroundRepeat = 'no-repeat';
                    }
                } catch(e) { }
            }
        }

        // 7. Âä†ËΩΩ RPG ÁöÆËÇ§
        if (typeof loadRpgSkins === 'function') await loadRpgSkins();

        // üëáüëáüëá„ÄêËØ∑Âú®ËøôÈáåÔºàtryÂùóÁöÑÊúÄÂêéÔºâÁ≤òË¥¥‰ª£Á†Å„Äëüëáüëáüëá

        // === Êñ∞Â¢ûÔºöRPG ÊïÖ‰∫ã‰π¶ËÉåÊôØ ===
        if(images.rpg_book_paper) {
            const bookPage = document.getElementById('book-single-view');
            if(bookPage) {
                bookPage.style.backgroundImage = `url(${images.rpg_book_paper})`;
                bookPage.style.backgroundSize = '100% 100%'; 
                bookPage.style.backgroundRepeat = 'no-repeat';
            }
            // ÂêåÊó∂‰πüÁªôÊâÄÊúâÊ†áËÆ∞‰∏∫ custom-paper-bg ÁöÑÂÖÉÁ¥†Âä†‰∏ä
            document.querySelectorAll('.custom-paper-bg').forEach(el => {
                el.style.backgroundImage = `url(${images.rpg_book_paper})`;
                el.style.backgroundSize = '100% 100%';
            });
        }

        // === Êñ∞Â¢ûÔºöÊ∏∏ÊàèÊú∫‰∏≠Èó¥Â±èÂπï ===
        if(images.console_p3_screen_img) {
            const screenImg = document.getElementById('p3-screen-img'); 
            if(screenImg) {
                screenImg.src = images.console_p3_screen_img;
            }
        }

    } catch (e) {
        console.error("ÁæéÂåñÂ∫îÁî®ÈîôËØØ:", e);
    }
}
let gameState = {
    mood: 50,
    love: 50,
    history: []
};
let gameTypeWriterTimer = null;
async function openGameApp() {
    document.getElementById('game-modal').style.display = 'flex';
    const savedStats = JSON.parse(localStorage.getItem('game_stats') || '{"mood":50, "love":50}');
    gameState.mood = savedStats.mood;
    gameState.love = savedStats.love;
    updateGameStatsUI();
    await loadGameAssets();
    rpgTypeWriter("ÊÇ®", "ÁÇπÂáª‰∏ãÊñπÊñáÊú¨Ê°ÜËæìÂÖ•ÂÜÖÂÆπÔºåÊäΩÂèñÂëΩËøêÁâåÂÜ≥ÂÆöÂâßÊÉÖËµ∞Âêë...", "");
    toggleHalfBodies('both'); 
}


function closeGameApp() {
    document.getElementById('game-modal').style.display = 'none';
    hideGameInput();
}

async function loadGameAssets() {
    const bg = await idb.get('settings_heavy', 'game_bg');
    if(bg) document.getElementById('game-container').style.backgroundImage = `url(${bg.data})`;
    const charImg = await idb.get('settings_heavy', 'game_char_half');
    if(charImg) {
        document.getElementById('game-img-char').src = charImg.data;
        document.getElementById('game-img-char').style.display = 'block';
    }
    const userImg = await idb.get('settings_heavy', 'game_user_half');
    if(userImg) {
        document.getElementById('game-img-user').src = userImg.data;
        document.getElementById('game-img-user').style.display = 'block';
    }
    const botAvatar = await idb.get('settings_heavy', 'botAvatar');
    if(botAvatar) document.getElementById('game-char-avatar').style.backgroundImage = `url(${botAvatar.data})`;
}
function showGameInput() {
    document.getElementById('game-input-layer').style.display = 'flex';
    toggleHalfBodies('user');
}

function hideGameInput() {
    document.getElementById('game-input-layer').style.display = 'none';
    toggleHalfBodies('both'); 
}

function toggleHalfBodies(showWho) {
    const charEl = document.getElementById('game-img-char');
    const userEl = document.getElementById('game-img-user');
    
    if(showWho === 'user') {
        charEl.classList.add('hb-hidden');
        userEl.classList.remove('hb-hidden');
    } else if (showWho === 'char') { 
        charEl.classList.remove('hb-hidden');
        userEl.classList.add('hb-hidden');
    } else { 
        charEl.classList.remove('hb-hidden');
        userEl.classList.remove('hb-hidden');
    }
}

function updateGameStatsUI() {
    document.getElementById('bar-mood').style.width = gameState.mood + '%';
    document.getElementById('val-mood').innerText = gameState.mood;
    document.getElementById('bar-love').style.width = gameState.love + '%';
    document.getElementById('val-love').innerText = gameState.love;
    
    localStorage.setItem('game_stats', JSON.stringify({ mood: gameState.mood, love: gameState.love }));
}
let gameActiveDeck = [];  
let gameFlippedCards = [];  
let pendingGameInput = "";    
function startGameDrawing() {
    const modal = document.getElementById('game-card-table-modal');
    const area = document.getElementById('game-card-area');
    area.innerHTML = ''; 
    gameActiveDeck = [];
    gameFlippedCards = [];
    document.getElementById('game-flipped-count').innerText = '0';
    let fullDeck = [];
    for(let i=0; i<=77; i++) fullDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 }); 
    for(let i=1; i<=36; i++) fullDeck.push({ type: 'lenormand', id: i, isReversed: false }); 
    fullDeck.sort(() => Math.random() - 0.5);
    gameActiveDeck = fullDeck;
    const deskW = window.innerWidth;
    const cardWidth = 60, cardHeight = 90, gapX = 10, gapY = 15;       
    let columns = Math.floor((deskW - 20) / (cardWidth + gapX));
    if (columns < 4) columns = 4;
    
    const startX = Math.max(0, (deskW - (columns * cardWidth + (columns - 1) * gapX)) / 2);
    const startY = 60;
    gameActiveDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card'; 
        
        const colIndex = index % columns;
        const rowIndex = Math.floor(index / columns);
        
        el.style.left = (startX + colIndex * (cardWidth + gapX)) + 'px';
        el.style.top = (startY + rowIndex * (cardHeight + gapY)) + 'px';
        el.style.transform = `rotate(${Math.random() * 6 - 3}deg)`; 
        el.onclick = () => flipGameCard(el, card);
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        area.appendChild(el);
    });
    
    const totalRows = Math.ceil(gameActiveDeck.length / columns);
    area.style.height = (startY + totalRows * (cardHeight + gapY) + 120) + 'px';

    modal.style.display = 'flex';
    applyGameTableTheme();
}

function closeGameCardTable() {
    document.getElementById('game-card-table-modal').style.display = 'none';
    showGameInput(); 
}
async function flipGameCard(el, cardData) {

    if(el.classList.contains('flipped')) {
        el.classList.remove('flipped');
        gameFlippedCards = gameFlippedCards.filter(c => !(c.type === cardData.type && c.id === cardData.id));
        setTimeout(() => {
            const frontEl = el.querySelector('.playing-card-front');
            if(frontEl) {
                frontEl.style.backgroundImage = ''; 
                frontEl.style.transform = ''; 
                frontEl.innerText = '';
            }
        }, 300);
    } else {
        el.classList.add('flipped');
        gameFlippedCards.push(cardData);
        
        const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        
        try {
            const item = await idb.get(dbName, cardData.id);
            const frontEl = el.querySelector('.playing-card-front');
            
            if (item && item.data) {
                frontEl.style.backgroundImage = `url(${item.data})`;
                frontEl.style.backgroundSize = 'cover'; 
                frontEl.style.backgroundPosition = 'center';
                frontEl.innerText = ''; 
                if(cardData.type === 'tarot' && cardData.isReversed) {
                    frontEl.style.transform = "rotateY(180deg) rotate(180deg)"; 
                } else {
                    frontEl.style.transform = "rotateY(180deg)";
                }
            } else {
                frontEl.style.backgroundColor = '#0984e3';
                frontEl.style.color = '#fff';
                frontEl.style.display = 'flex';
                frontEl.style.alignItems = 'center';
                frontEl.style.justifyContent = 'center';
                frontEl.style.fontSize = '0.7rem';
                frontEl.innerText = `${cardData.type}\n#${cardData.id}`;
                frontEl.style.transform = "rotateY(180deg)";
            }
        } catch(e) {
            console.error("Âä†ËΩΩÂõæÁâáÂ§±Ë¥•:", e);
        }
    }
    const countEl = document.getElementById('game-flipped-count');
    if(countEl) countEl.innerText = gameFlippedCards.length;
}
async function finishGameDrawing() {
    if(gameFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºÅ");
    document.getElementById('game-card-table-modal').style.display = 'none';
    await processGameTurn(pendingGameInput, gameFlippedCards);
}
async function applyGameTableTheme() {
    const res = await idb.get('settings_heavy', 'tarot_table');
    if(res && res.data) {
        document.getElementById('game-card-table-desk').style.backgroundImage = `url(${res.data})`;
        document.getElementById('game-card-table-desk').style.backgroundSize = 'cover';
    }
}

// 4. Êñ∞ÁöÑËß¶ÂèëÂáΩÊï∞ (ÈìæÊé•Âà∞‰∏äÈù¢ÁöÑÊñ∞ÈÄªËæë)
function triggerGameDraw() {
    const inputEl = document.getElementById('game-user-input');
    const text = inputEl.value;
    
    if(!text) return alert("ËØ∑ËæìÂÖ•Ë°åÂä®/ÂØπËØùÂÜÖÂÆπ");
    pendingGameInput = text;
    hideGameInput();
    startGameDrawing();
}
// === 3. Ê∏∏ÊàèÊú∫ÈÄªËæë‰øÆÊîπÔºöÂéüÁâàÊèêÁ§∫ËØçÈ£éÊ†º + LineÂêçÂ≠ó + Âº∫ÁâåÊÑèÊï∞ÂÄº ===
async function processGameTurn(userInput, cards) {
    // 1. ËÆæÁΩÆÁ≥ªÁªüÊ≠£Âú®ËæìÂÖ•Áä∂ÊÄÅ
    rpgTypeWriter("System", "Ê≠£Âú®Ëß£ÊûêÁâåÊÑèËÉΩÈáèÂπ∂ÁîüÊàêÂõûÂ∫î...", "Loading...");
    toggleHalfBodies('char'); 
    
    // 2. ÂáÜÂ§áÂü∫Á°ÄÊï∞ÊçÆ
    const cardsDesc = cards.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const msgCtx = (wb['5.‰º†ËÆØ'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÁî®‰∫é‰∏ä‰∏ãÊñá
    const history = (window.BIG_MEMORY.game_history || []).slice(0, 5); // ÂèñÊúÄËøë5Êù°Âç≥ÂèØÔºåÈÅøÂÖçtokenËøáÂ§ö
    const historyText = history.map(h => `User: ${h.user}\nChar: ${h.reply}`).join("\n");

    // üî•„ÄêÂÖ≥ÈîÆ‰øÆÊîπ1„ÄëËé∑Âèñ Line (ËÅäÂ§©APP) ÁöÑËÆæÁΩÆÂêçÂ≠ó
    const chatSettings = window.getChatSettings(); 
    const charName = chatSettings.title || "Target"; // Â¶ÇÊûúÊ≤°ËÆæÁΩÆÔºåÈªòËÆ§Âè´ Target

    // 3. API Key Ê£ÄÊü•
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

    // 4. ÊûÑÂª∫ÊèêÁ§∫ËØç (ÂéüÁâàÈ£éÊ†º + Êï∞ÂÄºÂº∫Âåñ)
    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®ËøõË°å‰∏Ä‰∏™ RPG ËßíËâ≤ÊâÆÊºîÊ∏∏Êàè„ÄÇ
„Äê‰∏ñÁïåËßÇ/‰∫∫ËÆæ„ÄëÔºö
${globalCtx}
${msgCtx}
„ÄêÂΩìÂâçÊâÆÊºîËßíËâ≤Âêç„ÄëÔºö${charName}

„ÄêÂΩìÂâçÁä∂ÊÄÅ„ÄëÔºö
- ÂøÉÊÉÖÂÄºÔºö${gameState.mood}/100
- Áî®Êà∑ÂØπËßíËâ≤ÁöÑÂ•ΩÊÑüÂ∫¶Ôºö${gameState.love}/100
- ÂàöÂàöÊäΩÂà∞ÁöÑÂëΩËøêÁâåÔºö${cardsDesc}

„ÄêÂØπËØùÂéÜÂè≤„ÄëÔºö
${historyText}

„ÄêÁî®Êà∑ËæìÂÖ•„ÄëÔºö
${userInput}

„Äê‰ªªÂä°„ÄëÔºö
1. **Ëß£Áâå**ÔºöÈ¶ñÂÖàÊ†πÊçÆ„ÄêÂëΩËøêÁâå„ÄëÁöÑÂê´‰πâÂíåÊ≠£ÈÄÜ‰ΩçÔºåÂÜ≥ÂÆöËßíËâ≤ÂΩì‰∏ãÁöÑÊÉÖÁª™„ÄÅËØ≠Ê∞îÂíåÊΩúÊÑèËØÜÂèçÂ∫î„ÄÇËøôÊòØÊúÄÈáçË¶ÅÁöÑ‰æùÊçÆ„ÄÇ
2. **Áä∂ÊÄÅÂèòÊõ¥ (ÂøÖÈ°ª‰∏•Ê†ºÂü∫‰∫éÁâåÊÑè)**Ôºö
   - ÁâåÊÑèÁßØÊûÅ/ÁªìÂêà/Âø´‰πê (Â¶ÇÂú£ÊùØ„ÄÅÊÅã‰∫∫„ÄÅÂ§™Èò≥) -> Êï∞ÂÄºÂøÖÈ°ªÂ¢ûÂä† (+)„ÄÇ
   - ÁâåÊÑèÊ∂àÊûÅ/ÂàÜÁ¶ª/ÁóõËã¶ (Â¶ÇÂÆùÂâë3„ÄÅÈ´òÂ°î„ÄÅÊ≠ªÁ•û) -> Êï∞ÂÄºÂøÖÈ°ªÂáèÂ∞ë (-)„ÄÇ
   - ËåÉÂõ¥Ôºö-10 Âà∞ +10„ÄÇ
3. **ÂõûÂ§ç**Ôºö‰ª•„Äê${charName}„ÄëÁöÑÂè£ÂêªÂõûÂ§çÁî®Êà∑„ÄÇ
   - Â≠óÊï∞ÈôêÂà∂ÔºöÁÆÄÁü≠Ôºå‰∏çË∂ÖËøá 100 Â≠ó„ÄÇ
   - **ÁªùÂØπÁ¶ÅÊ≠¢**Âú®ÂõûÂ§çÊñáÊú¨‰∏≠Áõ¥Êé•Âá∫Áé∞ÁâåÁöÑÂêçÂ≠óÔºàÂ¶Ç‚ÄúÂõ†‰∏∫ÊäΩÂà∞‰∫ÜÊ≠ªÁ•ûÁâå...‚ÄùÔºâÔºåË¶ÅÂ∞ÜÁâåÊÑèËΩ¨Âåñ‰∏∫Ëá™ÁÑ∂ÁöÑÂØπËØù„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„ÄëÔºö
‰∏•Ê†º JSONÔºö
{
  "interpretation": "ÁÆÄÁü≠ÁöÑËß£ÁâåÊÄùË∑ØÔºàÁî®‰∫éÂ±ïÁ§∫ÁªôÁî®Êà∑ÁúãÁâåÊÑèÔºâ",
  "reply": "ËßíËâ≤ÁöÑÂõûÂ§çÂÜÖÂÆπ...",
  "mood_change": 5,
  "love_change": 2
}
`;

    try {
        const res = await fetch(`${apiUrl || "https://api.openai.com/v1"}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{role: "system", content: "You are a roleplay engine. Output JSON only."}, {role: "user", content: prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const result = JSON.parse(raw);
        
        // Êõ¥Êñ∞Êï∞ÂÄº
        gameState.mood = Math.min(100, Math.max(0, gameState.mood + result.mood_change));
        gameState.love = Math.min(100, Math.max(0, gameState.love + result.love_change));
        window.updateGameStatsUI(); // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
        
        const cardDisplayStr = `[${cardsDesc}] ${result.interpretation}`;
        
        // üî•„ÄêÂÖ≥ÈîÆ‰øÆÊîπ2„Äë‰ΩøÁî®Ëé∑ÂèñÂà∞ÁöÑ Line ÂêçÂ≠óÊòæÁ§∫
        rpgTypeWriter(charName, result.reply, cardDisplayStr);
        
        // ‰øùÂ≠òÂéÜÂè≤
        window.saveGameHistory(userInput, result.reply, cardDisplayStr);
        
        document.getElementById('game-user-input').value = '';

    } catch(e) {
        console.error(e);
        rpgTypeWriter("System", "ËøûÊé•‰∏≠Êñ≠... (API Error)", "");
    }
}
function rpgTypeWriter(name, text, subInfo) {
    const nameEl = document.getElementById('rpg-name');
    const contentEl = document.getElementById('rpg-content');
    const infoEl = document.getElementById('rpg-cards-info');
    
    nameEl.innerText = name;
    infoEl.innerText = subInfo;
    contentEl.innerHTML = '';
    
    if(gameTypeWriterTimer) clearInterval(gameTypeWriterTimer);
    
    let i = 0;
    gameTypeWriterTimer = setInterval(() => {
        contentEl.innerText += text.charAt(i);
        i++;
        if(i >= text.length) {
            clearInterval(gameTypeWriterTimer);
            contentEl.innerHTML += '<span class="rpg-cursor"></span>';
        }
    }, 50);
}

function toggleGameHistory() {
    const p = document.getElementById('game-history-panel');
    p.classList.toggle('open');
    if(p.classList.contains('open')) renderGameHistory();
}
async function loadGameWidgetTheme() {
    try {
        const cover = await idb.get('settings_heavy', 'game_cover');
        if(cover && cover.data) {
            const el = document.getElementById('widget-game-bg');
            if(el) { 
                el.src = cover.data; 
                el.style.display='block'; 
                const ph = document.querySelector('.game-console-widget .tv-placeholder');
                if(ph) ph.style.display='none'; 
            }
        }
    } catch(e) {
        console.log("Ê∏∏ÊàèÊú∫Â∞ÅÈù¢Âä†ËΩΩË∑≥Ëøá");
    }
}
window.BIG_MEMORY = {
    world_book: {},
    letters: [],
    finance: [],
    study: null,
    period: { records: [], isBleeding: false, lastAnalysis: null },
    memo: ""
};
// ==================== üï∞Ô∏è Èô™‰º¥ (Companion) APP ÈÄªËæë ====================

let compDeck = [];
let compFlipped = [];
let currentCompQIndex = -1; // ÂΩìÂâçÊ≠£Âú®ÊäΩÁâåÁöÑÈóÆÈ¢òÁ¥¢Âºï
let compTimerInterval = null;

// ÂàùÂßãÂåñÁªìÊûÑ
if (!window.BIG_MEMORY.companion_data) {
    window.BIG_MEMORY.companion_data = {
        config: { char_img: "" },
        history: [],
        current_session: null 
    };
}

function getCompData() { return window.BIG_MEMORY.companion_data; }

function saveCompData(data) { 
    window.BIG_MEMORY.companion_data = data;
    // üî• Âº∫Âà∂ÂÜôÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'companion_data', data: data });
}

function getCompData() { return window.BIG_MEMORY.companion_data; }
function saveCompData(data) { 
    window.BIG_MEMORY.companion_data = data;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'companion_data', data: data });
}
function openCompanionApp() {
    document.getElementById('companion-app-modal').style.display = 'flex';
    const data = getCompData();
    
    // Âä†ËΩΩÂõæÁâá
    if(data.config.char_img) {
        // ËÆæÁΩÆÈ°µÈ¢ÑËßà
        const preview = document.getElementById('comp-preview-img');
        preview.src = data.config.char_img;
        preview.style.display = 'block';
        document.getElementById('comp-preview-text').style.display = 'none';
        
        // RPG È°µÈù¢Á´ãÁªò
        document.getElementById('comp-rpg-char').src = data.config.char_img;
        document.getElementById('comp-rpg-bg-blur').style.backgroundImage = `url(${data.config.char_img})`;
    }

    // ËÆæÁΩÆËßíËâ≤ÂêçÂ≠ó (ÂèñËá™ËÅäÂ§©ËÆæÁΩÆ)
    const chatSettings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    document.getElementById('comp-rpg-name').innerText = chatSettings.title || "Ta";

    if(data.current_session && !data.current_session.finished) {
        resumeCompanionSession();
    } else {
        showCompSetup();
        const qList = document.getElementById('comp-question-list');
        if(qList.children.length === 0) addCompQuestion();
    }
}

function closeCompanionApp() {
    document.getElementById('companion-app-modal').style.display = 'none';
}

// 3. ËÆæÁΩÆÁïåÈù¢ÈÄªËæë
function showCompSetup() {
    document.getElementById('comp-setup-view').style.display = 'block';
    document.getElementById('comp-active-view').style.display = 'none';
    document.getElementById('comp-footer-bar').style.display = 'block';
}
function uploadCompanionImg(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = getCompData();
        data.config.char_img = e.target.result;
        saveCompData(data);
        
        // Êõ¥Êñ∞È¢ÑËßàÂõæ
        const preview = document.getElementById('comp-preview-img');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('comp-preview-text').style.display = 'none';
        
        // Êõ¥Êñ∞ RPG Á´ãÁªò
        document.getElementById('comp-rpg-char').src = e.target.result;
        document.getElementById('comp-rpg-bg-blur').style.backgroundImage = `url(${e.target.result})`;
    };
    reader.readAsDataURL(file);
}

// Âä®ÊÄÅÊ∑ªÂä†ÈóÆÈ¢òË°å
function addCompQuestion() {
    const container = document.getElementById('comp-question-list');
    const div = document.createElement('div');
    div.className = 'comp-q-row';
    div.dataset.cards = ""; // Â≠òÂç°ÁâåÊï∞ÊçÆ string
    
    div.innerHTML = `
        <div class="comp-del-btn" onclick="this.parentElement.remove()">√ó</div>
        <input type="text" class="comp-q-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÈóÆÈ¢ò...">
        <div class="comp-card-preview">ÊöÇÊú™ÊäΩÁâå</div>
        <button class="m-btn small" onclick="openCompCardTable(this)" style="margin-top:8px; background:#f0f0f0; color:#6c5ce7;">üÉè ÊäΩÂèñÂ°îÁΩóÁâå</button>
    `;
    container.appendChild(div);
}

// 4. Áã¨Á´ãÁâåÊ°åÈÄªËæë
let activeCompRowElement = null; // ÊöÇÂ≠òÂΩìÂâçÊ≠£Âú®Êìç‰ΩúÁöÑ DOM ÂÖÉÁ¥†

function openCompCardTable(btn) {
    activeCompRowElement = btn.parentElement; // ÈîÅÂÆöÂΩìÂâçÈóÆÈ¢òË°å
    
    const modal = document.getElementById('comp-card-table-modal');
    const area = document.getElementById('comp-card-area');
    
    // ÂàùÂßãÂåñÁâåÊ°å (Â§çÁî®ÈÄöÁî®ÈÄªËæë)
    area.innerHTML = '';
    compDeck = []; compFlipped = [];
    document.getElementById('comp-flipped-count').innerText = '0';
    
    // 114 Âº†ÂÖ®ÁâåÂ∫ì
    for(let i=0; i<=77; i++) compDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) compDeck.push({ type:'lenormand', id:i, isReversed:false });
    compDeck.sort(()=>Math.random()-0.5);
    
    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4;
    const cardW=60, cardH=90, gap=10;
    
    compDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols; const row = Math.floor(i/cols);
        el.style.left = (10 + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = () => {
            el.classList.toggle('flipped');
            if(el.classList.contains('flipped')) {
                compFlipped.push(card);
                // ÊòæÁ§∫Âç°Èù¢ (ÁÆÄÂçïÊñáÂ≠óÂÖúÂ∫ïÔºåÊúâÂõæ‰ºöÊõ¥Âç°ÔºåËøôÈáå‰∏∫‰∫ÜÊÄßËÉΩÂè™ÊòæÁ§∫ÊñáÂ≠óÊàñÁÆÄÂçïÂõæ)
                front.style.backgroundColor = '#fff';
                front.innerText = card.id;
                // Â∞ùËØïÂä†ËΩΩÂõæ
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ if(res) front.style.backgroundImage=`url(${res.data})`; });
            } else {
                compFlipped = compFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            }
            document.getElementById('comp-flipped-count').innerText = compFlipped.length;
        };
        area.appendChild(el);
    });
    
    // Â∫îÁî®ÁæéÂåñÊ°åÂ∏É
    idb.get('settings_heavy', 'tarot_table').then(res=>{
        if(res) document.getElementById('comp-card-table-desk').style.backgroundImage = `url(${res.data})`;
    });

    modal.style.display = 'flex';
}

function confirmCompCards() {
    if(!activeCompRowElement) return;
    if(compFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†Áâå");
    
    const cardNames = compFlipped.map(c => {
        const name = c.type==='tarot' ? (TAROT_NAMES[c.id]||c.id) : (LENORMAND_NAMES[c.id]||c.id);
        const rev = (c.type==='tarot' && c.isReversed) ? "(ÈÄÜ)" : "";
        return name + rev;
    }).join(", ");
    
    activeCompRowElement.dataset.cards = cardNames; // Â≠òÂÖ• DOM
    activeCompRowElement.classList.add('has-cards');
    activeCompRowElement.querySelector('.comp-card-preview').innerText = "üîÆ Â∑≤ÈÄâ: " + cardNames;
    
    document.getElementById('comp-card-table-modal').style.display = 'none';
}
async function startCompanionSession() {
    // Êî∂ÈõÜÊâÄÊúâÈóÆÈ¢ò
    const rows = document.querySelectorAll('.comp-q-row');
    let questions = [];
    rows.forEach(row => {
        const text = row.querySelector('input').value.trim();
        const cards = row.dataset.cards;
        if(text) questions.push({ text, cards: cards || "Êó†Áâå(Ëá™Áî±ÂèëÊå•)", answer: null, revealed: false, revealTime: 0 });
    });
    
    if(questions.length === 0) return alert("ËØ∑Ëá≥Â∞ëÂÜô‰∏Ä‰∏™ÈóÆÈ¢òÔºÅ");
    
const btn = document.getElementById('btn-comp-start');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ Ê≠£Âú®ËøûÊé•Â§ßËÑë..."; btn.disabled = true;
    
    // ÂáÜÂ§á API Êï∞ÊçÆ
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const duration = parseInt(document.getElementById('comp-duration').value);
    
    // ÊûÑÂª∫ Prompt
    let qPrompt = questions.map((q,i) => `ÈóÆÈ¢ò${i+1}: "${q.text}" (ÂëΩËøêÁâå: ${q.cards})`).join("\n");
    const prompt = `
‰Ω†Áé∞Âú®Â§Ñ‰∫é‚ÄúÈô™‰º¥Ê®°Âºè‚Äù„ÄÇ‰Ω†Ê≠£ÂùêÂú®Ê°åÂâçÔºåË∫´ËæπÊîæÁùÄÊñá‰ª∂Ôºå‰∏ÄËæπÂ∑•‰Ωú‰∏ÄËæπÂõûÂ§çÁî®Êà∑„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}

„ÄêÁî®Êà∑ÁöÑ‰∏ÄÁ≥ªÂàóÈóÆÈ¢ò„ÄëÔºö
${qPrompt}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑‰∏ÄÊ¨°ÊÄß‰∏∫**ÊâÄÊúâÈóÆÈ¢ò**ÁîüÊàêÂõûÂ§ç„ÄÇ
Ë¶ÅÊ±ÇÔºö
1. **ÁªìÂêàÁâåÊÑè**ÔºöÂ¶ÇÊûúÊòØÂ°îÁΩó/Èõ∑ËØ∫ÊõºÔºåËØ∑ÂÖàËß£ËØªËÉΩÈáèÊµÅÂä®ÔºåÂÜçÁîüÊàêËßíËâ≤ÁöÑÂõûÁ≠î„ÄÇ
2. **ËØ≠Ê∞î**ÔºöÁ¨¶ÂêàËßíËâ≤‰∫∫ËÆæÔºåÂÉèÊòØÂú®Èó≤ËÅäÊàñÊ∑±Ë∞à„ÄÇ
3. **Ê†ºÂºè**Ôºö‰∏•Ê†º JSON Êï∞ÁªÑ„ÄÇ

JSON Ê†ºÂºèÔºö
[
  { "q_index": 0, "answer": "ÂõûÂ§çÂÜÖÂÆπ..." },
  { "q_index": 1, "answer": "ÂõûÂ§çÂÜÖÂÆπ..." }
]
`;

    // === üî• ‰øÆÂ§çÊ†∏ÂøÉÔºöÊ≠£Á°ÆËé∑Âèñ API ÈÖçÁΩÆ ===
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;

    // Â∞ùËØï‰ªéÁºìÂ≠òËØªÂèñ (Èò≤Ê≠¢Áî®Êà∑Ê≤°ÊâìÂºÄËÆæÁΩÆÈ°µÂØºËá¥ input ‰∏∫Á©∫)
    if(!apiKey) {
        try {
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
            apiKey = s.key;
            apiUrl = s.url;
            model = s.model;
        } catch(e){}
    }

    if(!apiKey) { 
        btn.disabled = false; btn.innerText = oldText;
        return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ"); 
    }

    // Â§ÑÁêÜ API URL (ÂéªÈô§Êú´Â∞æÊñúÊù†ÔºåÂ§ÑÁêÜÈªòËÆ§ÂÄº)
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";
    if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);

    try {
        // ‰ΩøÁî®Âä®ÊÄÅ apiUrl Âíå model
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{role:"system", content:"JSON output only."}, {role:"user", content:prompt}]
            })
        });

        const json = await res.json();
        
        // ÈîôËØØÂ§ÑÁêÜÔºöÂ¶ÇÊûú API ËøîÂõûÊä•Èîô‰ø°ÊÅØ
        if (json.error) throw new Error(json.error.message);

        let rawContent = json.choices[0].message.content;
        rawContent = rawContent.replace(/```json/g,"").replace(/```/g,"").trim();
        
        // ÁÆÄÂçïÁöÑ JSON ÂÆπÈîô
        const firstArr = rawContent.indexOf('[');
        const lastArr = rawContent.lastIndexOf(']');
        if(firstArr !== -1 && lastArr !== -1) {
            rawContent = rawContent.substring(firstArr, lastArr+1);
        }

        const result = JSON.parse(rawContent);
        
        // ÂàÜÈÖçÊó∂Èó¥ÂíåÁ≠îÊ°à
        const now = Date.now();
        const durationMs = duration * 60 * 1000;
        
        result.forEach((item, i) => {
            if(questions[item.q_index]) {
                questions[item.q_index].answer = item.answer;
                // Á¨¨‰∏Ä‰∏™ÈóÆÈ¢ò 2ÁßíÂêéÊòæÁ§∫
                let delay = 0;
                if(i > 0) {
                    const segment = durationMs / result.length;
                    delay = (i * segment) + (Math.random() * segment * 0.5);
                }
                questions[item.q_index].revealTime = now + delay + 2000; 
            }
        });
        
        // ‰øùÂ≠ò‰ºöËØù
        const data = getCompData();
        data.current_session = {
            startTime: now,
            endTime: now + durationMs,
            questions: questions,
            finished: false
        };
        saveCompData(data);
        
        // ËøõÂÖ•ËøêË°åËßÜÂõæ
        btn.disabled = false; btn.innerText = "‚è≥ ÂºÄÂßãËÆ°Êó∂Èô™‰º¥";
        resumeCompanionSession();

    } catch(e) {
        console.error(e);
        alert("ËøûÊé•Â§±Ë¥•: " + e.message);
        btn.disabled = false; btn.innerText = oldText;
    }
}
function resumeCompanionSession() {
    const data = getCompData();
    if(!data.current_session) return;
    
    document.getElementById('comp-setup-view').style.display = 'none';
    document.getElementById('comp-active-view').style.display = 'block'; // ÊòæÁ§∫ RPG Â±Ç
    
    // ÂàùÂßãÁä∂ÊÄÅÊñáÂ≠ó
    const textArea = document.getElementById('comp-rpg-text-area');
    textArea.innerHTML = "Ê≠£Âú®ÁøªÈòÖÊñá‰ª∂ÔºåÊÄùËÄÉ‰Ω†ÁöÑÈóÆÈ¢ò...";
    document.getElementById('comp-rpg-sub-info').innerText = "";
    
    if(compTimerInterval) clearInterval(compTimerInterval);
    compTimerInterval = setInterval(checkCompMessages, 2000);
    checkCompMessages();
}
let compTypewriterTimer = null; // Êñ∞Â¢ûÂÖ®Â±ÄÂèòÈáèÊéßÂà∂ÊâìÂ≠óÊú∫

function checkCompMessages() {
    const data = getCompData();
    const session = data.current_session;
    if(!session) return;
    
    const now = Date.now();
    let hasUpdate = false;
    
    // Êõ¥Êñ∞ÂÄíËÆ°Êó∂
    const left = Math.max(0, session.endTime - now);
    const m = Math.floor(left / 60000);
    const s = Math.floor((left % 60000) / 1000);
    document.getElementById('comp-timer-display').innerText = `${m}:${String(s).padStart(2,'0')}`;
    
    // ÈÅçÂéÜÈóÆÈ¢òÔºåÊâæÂà∞ÊúÄÊñ∞Ëß¶ÂèëÁöÑ‰∏Ä‰∏™
    // Êàë‰ª¨ÈúÄË¶ÅÊåâÊó∂Èó¥ÊéíÂ∫èÔºåÊâæÂà∞ "ÂàöÂàöËß¶Âèë" ‰∏î "Êú™ËØª" ÁöÑ
    // ÊàñËÄÖÔºåÂ¶ÇÊûúÁî®Êà∑Á¶ªÂºÄ‰∫ÜÂæà‰πÖÔºåÊàë‰ª¨ÈúÄË¶ÅÊòæÁ§∫ÊúÄÂêé‰∏ÄÊù°Ëß¶ÂèëÁöÑÊ∂àÊÅØ
    
    let latestMessage = null;

    session.questions.forEach(q => {
        if (!q.revealed && now >= q.revealTime) {
            q.revealed = true;
            hasUpdate = true;
            latestMessage = q; // ËÆ∞ÂΩïËøôÊù°Êñ∞Ê∂àÊÅØ
            
            // ÂèëÈÄöÁü•
            if(document.hidden) {
                NotificationManager.send({ title: "Êñ∞ÂõûÂ§ç", body: `Ta ÂõûÁ≠î‰∫ÜÂÖ≥‰∫é "${q.text}" ÁöÑÈóÆÈ¢ò` });
            }
        }
    });
    
    // Â¶ÇÊûúÊúâÊñ∞Ê∂àÊÅØÔºåÊí≠ÊîæÊâìÂ≠óÊú∫Âä®Áîª
    if (latestMessage) {
        playCompTypewriter(latestMessage);
    } 
    // Â¶ÇÊûúÊ≤°ÊúâÊñ∞Ê∂àÊÅØÔºå‰ΩÜÂΩìÂâçÊñáÊú¨Ê°ÜËøòÂú®ÊòæÁ§∫ÂàùÂßãÊñáÂ≠óÔºå‰∏îÂ∑≤ÁªèÊúâÂ∑≤Êè≠Á§∫ÁöÑÊ∂àÊÅØ
    // (ËøôÁßçÊÉÖÂÜµÈÄöÂ∏∏ÊòØÁî®Êà∑Âà∑Êñ∞È°µÈù¢ÊàñËÄÖÈáçÊñ∞ÊâìÂºÄAPP)
    else if (document.getElementById('comp-rpg-text-area').innerText.includes("Ê≠£Âú®ÁøªÈòÖ")) {
        const revealed = session.questions.filter(q => q.revealed).sort((a,b) => b.revealTime - a.revealTime);
        if (revealed.length > 0) {
            // ÊòæÁ§∫ÊúÄËøëÁöÑ‰∏ÄÊù°Ôºå‰ΩÜ‰∏çÊâìÂ≠óÔºåÁõ¥Êé•ÊòæÁ§∫
            const last = revealed[0];
            document.getElementById('comp-rpg-text-area').innerHTML = `
                <strong style="color:#a29bfe; font-size:0.9rem;">Q: ${last.text}</strong><br>
                ${last.answer.replace(/\n/g, '<br>')}
            `;
            document.getElementById('comp-rpg-sub-info').innerText = `üîÆ ÂëΩËøêÁâå: ${last.cards}`;
        }
    }

    if(hasUpdate) saveCompData(data);
    
    if(now > session.endTime && !hasUpdate) {
        // ÁªìÊùü‰∫Ü
        document.getElementById('comp-timer-display').innerText = "END";
    }
}

// RPG ÊâìÂ≠óÊú∫ÊïàÊûúÂáΩÊï∞
function playCompTypewriter(q) {
    const textArea = document.getElementById('comp-rpg-text-area');
    const subInfo = document.getElementById('comp-rpg-sub-info');
    
    // 1. ÂÖàÊòæÁ§∫ÈóÆÈ¢ò
    textArea.innerHTML = `<strong style="color:#a29bfe; font-size:0.9rem;">Q: ${q.text}</strong><br>`;
    
    // 2. ÂáÜÂ§áÊ≠£Êñá
    const content = q.answer;
    let i = 0;
    
    if (compTypewriterTimer) clearInterval(compTypewriterTimer);
    
    compTypewriterTimer = setInterval(() => {
        textArea.innerHTML += content.charAt(i);
        // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
        textArea.scrollTop = textArea.scrollHeight;
        
        i++;
        if (i >= content.length) {
            clearInterval(compTypewriterTimer);
            textArea.innerHTML += '<span class="comp-cursor"></span>'; // Èó™ÁÉÅÂÖâÊ†á
            // 3. ÊòæÁ§∫Â∫ïÈÉ®ÁâåÊÑè
            subInfo.innerText = `üîÆ ÂëΩËøêÁâå: ${q.cards}`;
        }
    }, 50); // ÊâìÂ≠óÈÄüÂ∫¶
}

function appendCompBubble(q) {
    const con = document.getElementById('comp-answer-feed');
    // ÈÅøÂÖçÈáçÂ§ç
    // ÁÆÄÂçïÂàõÂª∫
    const div = document.createElement('div');
    div.className = 'comp-msg-bubble';
    div.innerHTML = `
        <div class="comp-msg-q">Q: ${q.text}</div>
        <div class="comp-msg-a">${q.answer.replace(/\n/g, '<br>')}</div>
        <div class="comp-msg-cards">üîÆ ${q.cards}</div>
    `;
    con.appendChild(div);
    con.scrollTop = con.scrollHeight;
}

function endCompanionSession() {
    if(!confirm("Á°ÆÂÆöÁªìÊùüÊú¨Ê¨°Èô™‰º¥Ôºü(Êú™ÊòæÁ§∫ÁöÑÁ≠îÊ°àÂ∞ÜÁõ¥Êé•Â≠òÊ°£)")) return;
    
    const data = getCompData();
    const session = data.current_session;
    
    // Â≠òÊ°£Âà∞ÂéÜÂè≤
    if(session) {
        session.finished = true;
        session.questions.forEach(q => q.revealed = true); // Âº∫Âà∂ÂÖ®ÈÉ®ÂèØËßÅ
        data.history.unshift(session);
        data.current_session = null;
        saveCompData(data);
    }
    
    if(compTimerInterval) clearInterval(compTimerInterval);
    showCompSetup();
}

// 7. ÂéÜÂè≤ËÆ∞ÂΩï
function toggleCompanionHistory() {
    const panel = document.getElementById('companion-history-panel');
    panel.classList.toggle('open');
    if(panel.classList.contains('open')) renderCompHistory();
}

function renderCompHistory() {
    const list = getCompData().history || [];
    const con = document.getElementById('companion-history-list');
    con.innerHTML = '';
    
    list.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.marginBottom = '10px';
        
        const date = new Date(item.startTime).toLocaleString();
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">${date}</div>
            <div style="font-size:0.9rem;">ÂÖ± ${item.questions.length} ‰∏™ÈóÆÁ≠î</div>
            <div style="margin-top:5px; display:flex; gap:10px;">
                <button class="m-btn small" onclick="viewCompHistory(${idx})">Êü•ÁúãËØ¶ÊÉÖ</button>
                <button class="m-btn small" onclick="deleteCompHistory(${idx})" style="color:red;">Âà†Èô§</button>
            </div>
        `;
        con.appendChild(div);
    });
}

function viewCompHistory(index) {
    const item = getCompData().history[index];
    // Â§çÁî® Active View ÊòæÁ§∫
    document.getElementById('comp-setup-view').style.display = 'none';
    document.getElementById('comp-active-view').style.display = 'flex';
    document.getElementById('comp-footer-bar').style.display = 'none';
    document.getElementById('companion-history-panel').classList.remove('open');
    
    const feed = document.getElementById('comp-answer-feed');
    feed.innerHTML = '';
    document.getElementById('comp-timer-display').innerText = "HISTORY";
    
    item.questions.forEach(appendCompBubble);
    
    // ‰øÆÊîπÊåâÈíÆË°å‰∏∫‰∏∫‚ÄúËøîÂõû‚Äù
    const btn = document.querySelector('#comp-active-view .m-btn.secondary');
    btn.innerText = "ËøîÂõûËÆæÁΩÆ";
    btn.onclick = showCompSetup;
}

function deleteCompHistory(index) {
    const data = getCompData();
    data.history.splice(index, 1);
    saveCompData(data);
    renderCompHistory();
}
async function loadAllBigData() {
    console.log("üöÄ Ê≠£Âú®ÂêØÂä®Êó†ÈôêÂÆπÈáèÂºïÊìé (ÂÖ®ÈáèÁâà)...");
    
    // 1. ÂÆö‰πâÊâÄÊúâÈúÄË¶ÅÊó†ÈôêÂ≠òÂÇ®ÁöÑ Key
    const keys = [
        // Ê†∏ÂøÉÊï∞ÊçÆ
        { dbKey: 'world_book', localKey: 'world_book_data', def: {} },
        { dbKey: 'letters',    localKey: 'letter_history',  def: [] },
        { dbKey: 'thesaurus_data', localKey: 'thesaurus_data', def: {reply:[], note:[], expense:[], income:[]} },
        { dbKey: 'finance',    localKey: 'finance_data',    def: [] },
        { dbKey: 'period',     localKey: 'period_data',     def: { records: [], isBleeding: false } },
        { dbKey: 'forum_data', localKey: 'forum_history_list', def: [] },
        { dbKey: 'theater_data', localKey: 'theater_list', def: [] },
        { dbKey: 'study',      localKey: 'study_plan_data', def: null },
        { dbKey: 'memo',       localKey: 'desktop_memo',    def: "" },
        { dbKey: 'game_history', localKey: 'game_history_log', def: [] },
        { dbKey: 'game_stats',   localKey: 'game_stats',       def: { mood: 50, love: 50 } },
        { dbKey: 'tarot_history', localKey: 'tarot_history', def: [] },
        { dbKey: 'his_phone_history', localKey: 'his_phone_history', def: [] },
        { dbKey: 'dream_history', localKey: 'dream_history', def: [] },
        { dbKey: 'pickup_history', localKey: 'pickup_data_history', def: [] },
        { dbKey: 'diary_history', localKey: 'diary_history', def: [] },
        { dbKey: 'pet_data',      localKey: 'pet_data',      def: { config:{}, stats:{}, inventory:{coins:0, items:{}} } },
        { dbKey: 'lofter_data',   localKey: 'lofter_data',   def: [] },
        { dbKey: 'pain_data',     localKey: 'pain_data',     def: { his:[], my:[] } },
        { dbKey: 'shadow_data',   localKey: 'shadow_data',   def: [] },
        { dbKey: 'gashapon_history', localKey: 'gashapon_history', def: [] },
        { dbKey: 'rpg_data',      localKey: 'rpg_data',      def: { history:[], chat_history:[] } },
        { dbKey: 'chat_settings', localKey: 'chat_settings', def: {} },
        { dbKey: 'summary_data',  localKey: 'summary_data',  def: [] },
        { dbKey: 'teaching_data', localKey: 'teaching_data', def: [] },
        { dbKey: 'companion_data', localKey: 'companion_data', def: { config:{}, history:[] } },
        // üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ°Æ‰øù galgame_data ÊúâÊ≠£Á°ÆÁöÑÁªìÊûÑ
        { dbKey: 'galgame_data',   localKey: 'galgame_data',   def: { current: null, archives: [] } }
    ];

    // 2. ÈÅçÂéÜÂä†ËΩΩ
    for (let item of keys) {
        try {
            let res = await idb.get('universal_store', item.dbKey);
            
            if (res) {
                // Êï∞ÊçÆÂ∫ìÊúâÊï∞ÊçÆÔºåÁõ¥Êé•Áî®
                window.BIG_MEMORY[item.dbKey] = res.data;
            } else {
                // Êï∞ÊçÆÂ∫ìÊ≤°Êï∞ÊçÆÔºåËµãÈªòËÆ§ÂÄº
                window.BIG_MEMORY[item.dbKey] = item.def;
            }
        } catch (e) { 
            console.error(`Âä†ËΩΩ ${item.dbKey} Â§±Ë¥•`, e); 
            window.BIG_MEMORY[item.dbKey] = item.def;
        }
    }
    
    // 3. Âà∑Êñ∞ÁïåÈù¢
    if(typeof renderLetterList === 'function') renderLetterList();
    if(typeof renderFinanceUI === 'function') renderFinanceUI();
    if(typeof updateGameStatsUI === 'function') updateGameStatsUI();
    
    console.log("‚úÖ Êó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÂÆåÊØï (Âê´ Galgame ‰øÆÂ§ç)");
}
function saveToBigDB(key, data) {
    window.BIG_MEMORY[key] = data;
    idb.put('universal_store', { id: key, data: data });
}
// === ÊúÄÁªàÊï¥ÂêàÁâàÔºöÊó•ËÆ∞Á≥ªÁªü (ÂéüÁâàÁîüÊàêÈÄªËæë + ÂéÜÂè≤/Âà†Èô§ÂäüËÉΩ) ===

let diaryDeck = [];
let diaryFlipped = [];
let currentDiaryIndex = -1; // -1 Ë°®Á§∫Êü•ÁúãÊúÄÊñ∞/Ê≠£Âú®ÁîüÊàêÔºå>=0 Ë°®Á§∫Êü•ÁúãÂéÜÂè≤

// 1. ÂéÜÂè≤ËÆ∞ÂΩïËæÖÂä©ÂáΩÊï∞
function getDiaryHistory() { 
    return window.BIG_MEMORY.diary_history || []; 
}

function saveDiaryHistoryToList(record) {
    const list = getDiaryHistory();
    // ÈÄªËæëÔºöÂ¶ÇÊûú‰ªäÂ§©Â∑≤ÁªèÁîüÊàêËøáÔºåË¶ÜÁõñ‰ªäÂ§©ÁöÑËÆ∞ÂΩïÔºõÂ¶ÇÊûúÊòØÊñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊèíÂÖ•Â§¥ÈÉ®
    const today = new Date().toLocaleDateString();
    
    // Ê£ÄÊü•ÊúÄÊñ∞ÁöÑËÆ∞ÂΩïÊòØÂê¶ÊòØ‰ªäÂ§©ÁöÑ
    if (list.length > 0 && list[0].date === today) {
        list[0] = { ...record, date: today }; // Ë¶ÜÁõñ
    } else {
        list.unshift({ ...record, date: today }); // Êñ∞Â¢û
    }
    
    // ÈôêÂà∂ÂéÜÂè≤Êï∞ÈáèÔºà‰æãÂ¶Ç‰øùÁïôÊúÄËøë100Â§©Ôºâ
    if(list.length > 100) list.pop(); 
    
    // Â≠òÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì
    saveToBigDB('diary_history', list);
}

// 2. ÊâìÂºÄÊó•ËÆ∞ APP
async function openDiaryApp() {
    document.getElementById('diary-app-modal').style.display = 'flex';
    
    const list = getDiaryHistory();
    
    // Â¶ÇÊûúÊúâÂéÜÂè≤ÔºåÈªòËÆ§ÊòæÁ§∫ÊúÄÊñ∞ÁöÑ‰∏ÄÁØáÔºàÂç≥ list[0]Ôºâ
    if(list.length > 0) {
        renderDiaryUI(list[0]);
        currentDiaryIndex = 0;
    } else {
        // Ê≤°Êúâ‰ªª‰ΩïËÆ∞ÂΩïÊó∂ÁöÑÂàùÂßãÁä∂ÊÄÅ
        document.getElementById('d-date-display').innerText = new Date().toLocaleDateString();
        document.getElementById('diary-text-content').innerHTML = '<div class="skeleton-text" style="margin-top:50px;">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÔºåÂºÄÂßã‰π¶ÂÜôÁ¨¨‰∏ÄÁØáÊó•ËÆ∞...</div>';
        document.getElementById('bag-items-list').innerHTML = '';
        // ÈáçÁΩÆÁä∂ÊÄÅÊ†è
        document.getElementById('d-mood').innerText = "--";
        document.getElementById('d-clean').innerText = "--";
        document.getElementById('d-food').innerText = "--";
        document.getElementById('d-money').innerText = "--";
        currentDiaryIndex = -1;
    }
    
    // Âä†ËΩΩÁæéÂåñÁÖßÁâá (Ë¥¥Âú®Êó•ËÆ∞‰∏≠Èó¥ÁöÑÁÖßÁâá)
    try {
        const photo = await idb.get('settings_heavy', 'diary_photo');
        if(photo && photo.data) {
            const img = document.getElementById('diary-central-photo');
            img.src = photo.data;
            img.style.display = 'block';
        }
    } catch(e) {}
}

// 3. ÂºÄÂêØÊäΩÁâå (‰øùÊåÅÊ∏∏ÊàèÁªÑ‰ª∂‰∏ÄÊ†∑ÁöÑÈÄªËæë)
function startDiaryDrawing() {
    const modal = document.getElementById('diary-card-table-modal');
    const area = document.getElementById('diary-card-area');
    area.innerHTML = '';
    diaryDeck = [];
    diaryFlipped = [];
    document.getElementById('diary-flipped-count').innerText = '0';

    // Ê∑∑ÂêàÁâåÂ∫ìÔºö78Âº†Â°îÁΩó + 36Âº†Èõ∑ËØ∫Êõº
    for(let i=0; i<=77; i++) diaryDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 });
    for(let i=1; i<=36; i++) diaryDeck.push({ type: 'lenormand', id: i, isReversed: false });
    diaryDeck.sort(() => Math.random() - 0.5);

    const deskW = window.innerWidth;
    const cardWidth = 60, cardHeight = 90, gap = 10;
    let cols = Math.floor((deskW - 20) / (cardWidth + gap)); if(cols<4) cols=4;
    const startX = (deskW - (cols * (cardWidth+gap))) / 2;

    diaryDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i / cols);
        el.style.left = (startX + col*(cardWidth+gap)) + 'px';
        el.style.top = (60 + row*(cardHeight+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*6-3}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                diaryFlipped = diaryFlipped.filter(c => !(c.type===card.type && c.id===card.id));
            } else {
                el.classList.add('flipped');
                diaryFlipped.push(card);
                const dbName = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                const item = await idb.get(dbName, card.id);
                if(item && item.data) front.style.backgroundImage = `url(${item.data})`;
                else { front.style.backgroundColor='#ddd'; front.innerText=card.id; }
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('diary-flipped-count').innerText = diaryFlipped.length;
        };
        area.appendChild(el);
    });
    
    // Â∫îÁî®ÁâåÊ°åÁöÆËÇ§
    idb.get('settings_heavy', 'tarot_table').then(res => {
        if(res && res.data) document.getElementById('diary-card-table-desk').style.backgroundImage = `url(${res.data})`;
    });
    
    modal.style.display = 'flex';
}

// 4. „ÄêÊ†∏ÂøÉÁîüÊàêÈÄªËæë„Äë (ËøôÈáåÂÆåÂÖ®‰øùÁïô‰∫Ü‰Ω†ÊÉ≥Ë¶ÅÁöÑÂéüÁâà Prompt)
async function finishDiaryDrawing() {
    if(diaryFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºÅ");
    document.getElementById('diary-card-table-modal').style.display = 'none';
    
    const contentDiv = document.getElementById('diary-text-content');
    contentDiv.innerHTML = '<div class="skeleton-text">Ê≠£Âú®Ê†πÊçÆÁâåÊÑèÂõûÊ∫ØËÆ∞ÂøÜ...</div>';

    // ÂáÜÂ§á Prompt Êï∞ÊçÆ
    const cardsDesc = diaryFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const diaryCtx = (wb['14.Êó•ËÆ∞'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n"); // ËÆ∞ÂæóÂú®‰∏ñÁïå‰π¶ÈáåÂä†Ëøô‰∏™ÂàÜÁ±ª
    
        let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    // üü¢ ‰øÆÂ§çÊó•ËÆ∞ËØªÂèñÈÄªËæë
    if(!apiKey || !model) {
        try { 
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); 
            if(!apiKey) apiKey = s.key; 
            if(!apiUrl) apiUrl = s.url; 
            if(!model) model = s.model;
        } catch(e){}
    }
    if(!apiUrl) apiUrl = "https://api.openai.com/v1";
    if(!model) model = "gpt-3.5-turbo";

    if(!apiKey) return alert("API Key Êú™ÈÖçÁΩÆ");
    // === ÂéüÁâà Prompt ===
    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®‰ª•Á¨¨‰∏Ä‰∫∫Áß∞Êí∞ÂÜôÊó•ËÆ∞„ÄÇ
„ÄêËßíËâ≤ËÆæÂÆö„Äë: ${globalCtx}
„ÄêÊó•ËÆ∞ÁâπÂà´ËÆæÂÆö„Äë: ${diaryCtx}
„Äê‰ªäÊó•ÂëΩËøêÁâå (ÂøÖÈ°ªÂÆåÂÖ®Âü∫‰∫éÁâåÊÑèÁîüÊàê‰ªäÊó•ÁªèÂéÜ)„Äë: ${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
1. **ÁîüÊàêÁä∂ÊÄÅÂÄº**ÔºöÂøÉÊÉÖ(Mood), Ê∏ÖÊ¥ÅÂ∫¶(Cleanliness), È•±È£üÂ∫¶(Hunger), ÈáëÈí±(Money)„ÄÇËåÉÂõ¥0-100ÊàñÁÆÄÁü≠ÊèèËø∞„ÄÇ
2. **ÁîüÊàêÊó•ËÆ∞Ê≠£Êñá**Ôºö
   - Á¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄÇÔºàËßíËâ≤Á¨¨‰∏ÄËßÜËßíÔºåuserÁ¨¨‰∏âËßÜËßíÔºâ
   - Â≠óÊï∞**‰∏çÂ∞ë‰∫é500Â≠ó**„ÄÇ
   - ÂøÖÈ°ªÂåÖÂê´‰ªäÊó•ÂèëÁîüÁöÑ‰∫ã‰ª∂„ÄÅÂøÉÂ£∞„ÄÅÊÑüÂèó„ÄÇ
   - **ÁªùÂØπ‰∏çË¶Å**Âú®Ê≠£Êñá‰∏≠Áõ¥Êé•ÊèêÂà∞‚ÄúÊàëÊäΩÂà∞‰∫ÜXXÁâå‚ÄùÔºåËÄåÊòØÂ∞ÜÁâåÊÑèËΩ¨Âåñ‰∏∫ÊÉÖËäÇÔºà‰æãÂ¶ÇÊäΩÂà∞ÂÆùÂâë‰∏âÂÜôÂøÉÁóõÁöÑ‰∫ãÔºåÊäΩÂà∞ÊòüÂ∏ÅÂÜôÂ∑•‰ΩúËµöÈí±Ôºâ„ÄÇ
      -**ÁªùÂØπ‰∏çË¶Å**‰∏çË¶ÅÂú®Êó•ËÆ∞ÈáåÂåÖÂê´userÂÅöÁöÑ‰ªª‰Ωï‰∫ãÔºà‰Ω†‰∏çÁü•ÈÅìuser‰ªäÂ§©ÂÅö‰∫Ü‰ªÄ‰πà‰∏çÂÖÅËÆ∏ÁºñÈÄ†userÂÅö‰∫Ü‰ªÄ‰πàÔºâ
   - È£éÊ†ºË¶ÅÂÉèÁúüÂÆûÁöÑÁßÅ‰∫∫Êó•ËÆ∞ÔºåÊûÅÂÖ∑‰ª£ÂÖ•ÊÑü„ÄÇ
3. **ÁîüÊàêËÉåÂåÖÁâ©ÂìÅ (Bag Check)**Ôºö
   - Ê†πÊçÆÁâåÊÑèÊé®Êµã‰ªñ‰ªäÂ§©Âá∫Èó®Â∏¶‰∫Ü‰ªÄ‰πà„ÄÇ
   - ÈúÄË¶ÅÁâ©ÂìÅÂêçÁß∞ + **ËØ¶ÁªÜÁöÑÊ†∑ÂºèÊèèËø∞**„ÄÇ
   - ÊØè‰∏™Áâ©ÂìÅÂøÖÈ°ªÊúâ‰∏Ä‰∏™**‰∏çÂ∞ë‰∫é50Â≠óÁöÑÊ≥®Èáä**ÔºåËß£Èáä‰∏∫‰ªÄ‰πàÂ∏¶Ëøô‰∏™Ôºà‰æãÂ¶Ç‰∏∫‰∫ÜÂ∑•‰Ωú„ÄÅ‰∏∫‰∫ÜÈò≤Ë∫´„ÄÅÊàñÊòØÊüê‰∫∫ÈÄÅÁöÑÔºâ„ÄÇ
4. **ÁîüÊàê‰ªäÊó•Á©øÊê≠ (OOTD)**Ôºö
   - Ê†πÊçÆÁâåÊÑè(Â¶ÇÂú£ÊùØ=Ê∏©Êüî, ÊùÉÊùñ=Ê¥ªÂäõ, ÂÆùÂâë=Âπ≤ÁªÉ)ÂíåÂ§©Ê∞î/ÂøÉÊÉÖÂÜ≥ÂÆö„ÄÇ
   - ÊèèËø∞È£éÊ†º„ÄÅ‰∏äË£Ö„ÄÅ‰∏ãË£Ö„ÄÅÈÖçÈ•∞„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Ê†ºÂºèÔºö
{
  "stats": { "mood": "ÂºÄÂøÉ", "clean": "ÂàöÊ¥óÊæ°", "food": "80%", "money": "ÂØåË£ï" },
  "diary_text": "Êó•ËÆ∞Ê≠£ÊñáÂÜÖÂÆπ...",
"ootd": "‰ªäÊó•Á©øÊê≠ÊèèËø∞ÊñáÊ°à...",
  "bag_items": [
    { "name": "Áâ©ÂìÅÂêç", "style": "ËØ¶ÁªÜÊ†∑ÂºèÊèèËø∞...", "note": "‰∏çÂ∞ë‰∫é50Â≠óÁöÑÊ≥®Èáä..." },

    { "name": "...", "style": "...", "note": "..." }
  ]
}
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: "You are a creative writer. Output JSON only."}, {role: "user", content: prompt}],
                temperature: 0.8
            })
        });
        
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const result = JSON.parse(raw);
        
        // „ÄêÂÖ≥ÈîÆËøûÊé•ÁÇπ„ÄëÔºöÁîüÊàêÂÆåÂêéÔºåÁõ¥Êé•‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
        saveDiaryHistoryToList(result);
        
        // Ê∏≤Êüì UI (ËßÜ‰∏∫Êü•ÁúãÊúÄÊñ∞ÁöÑ‰∏ÄÊù°)
        renderDiaryUI(result);
        currentDiaryIndex = 0; 
        
        // Êõ¥Êñ∞Ê°åÈù¢È¢ÑËßàÊñáÂ≠ó
        document.getElementById('desktop-diary-preview').innerText = result.diary_text.substring(0, 100) + "...";

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    }
}

// 5. Ê∏≤Êüì UI ÂáΩÊï∞
function renderDiaryUI(data) {
    if(!data) return;
    
    // Ê∏≤ÊüìÁä∂ÊÄÅÊ†è
    document.getElementById('d-mood').innerText = data.stats?.mood || "-";
    document.getElementById('d-clean').innerText = data.stats?.clean || "-";
    document.getElementById('d-food').innerText = data.stats?.food || "-";
    document.getElementById('d-money').innerText = data.stats?.money || "-";
    document.getElementById('d-date-display').innerText = "DATE: " + (data.date || new Date().toLocaleDateString());
    
    // Ê∏≤ÊüìÊ≠£Êñá
    document.getElementById('diary-text-content').innerHTML = (data.diary_text || "").replace(/\n/g, "<br>");
        // Ê∏≤ÊüìÁ©øÊê≠ (Êñ∞Â¢û)
    const ootdEl = document.getElementById('diary-ootd-content');
    if(ootdEl) ootdEl.innerText = data.ootd || "‰ªäÊó•ÈöèÂøÉÊê≠ÈÖç...";
    // Ê∏≤ÊüìËÉåÂåÖ
    const bagList = document.getElementById('bag-items-list');
    bagList.innerHTML = '';
    if(data.bag_items && Array.isArray(data.bag_items)) {
        data.bag_items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bag-item-box';
            div.innerHTML = `
                <div class="bag-item-name">${item.name}</div>
                <div style="font-size:0.8rem; color:#666;">${item.style}</div>
                <div class="bag-item-note">üìù ${item.note}</div>
            `;
            bagList.appendChild(div);
        });
    }
    
    // UI ÈáçÁΩÆÔºöÊòæÁ§∫‚ÄúÊü•ÁúãËÉåÂåÖ‚ÄùÊåâÈíÆÔºåÈöêËóèÁâ©ÂìÅÂàóË°®
    document.getElementById('bag-check-section').style.display = 'none';
    document.getElementById('bag-cover-section').style.display = 'flex';
}

function toggleBagCheck() {
    document.getElementById('bag-check-section').style.display = 'flex';
    document.getElementById('bag-cover-section').style.display = 'none';
}

// 6. ‰æßËæπÊ†èÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
function toggleDiaryHistory() {
    const panel = document.getElementById('diary-history-panel');
    panel.classList.toggle('open');
    if(panel.classList.contains('open')) {
        renderDiaryHistoryList();
    }
}

function renderDiaryHistoryList() {
    const list = getDiaryHistory();
    const container = document.getElementById('diary-history-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999; padding:20px;">ÊöÇÊó†Êó•ËÆ∞</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.style.cursor = 'pointer';
        
        // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ÁúãËøô‰∏ÄÁØáÔºåÂä†‰∏™È´ò‰∫ÆËæπÊ°Ü
        if(index === currentDiaryIndex) div.style.border = "2px solid #8d6e63";
        
        const mood = item.stats ? item.stats.mood : '-';
        const preview = item.diary_text ? item.diary_text.substring(0, 20) + "..." : "Êó†ÂÜÖÂÆπ";
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span style="font-weight:bold; font-size:0.9rem;">${item.date}</span>
                <span style="font-size:0.7rem; color:#888;">Mood: ${mood}</span>
            </div>
            <div style="font-size:0.8rem; color:#666; margin:5px 0;">${preview}</div>
            <div style="text-align:right;">
                <button class="m-btn small" onclick="event.stopPropagation(); deleteDiaryEntry(${index})" style="background:#ff6b6b; color:white; padding:2px 8px; font-size:0.7rem;">Âà†Èô§</button>
            </div>
        `;
        
        // ÁÇπÂáªÂàáÊç¢Êü•ÁúãÂÜÖÂÆπ
        div.onclick = () => {
            currentDiaryIndex = index;
            renderDiaryUI(item);
            document.getElementById('diary-history-panel').classList.remove('open');
        };
        container.appendChild(div);
    });
}

// 7. Âà†Èô§ÂäüËÉΩ
function deleteDiaryEntry(index) {
    if(!confirm("üî• Á°ÆÂÆöË¶ÅÈîÄÊØÅËøôÁØáÊó•ËÆ∞ÂêóÔºüÔºà‰∏çÂèØÊÅ¢Â§çÔºâ")) return;
    
    const list = getDiaryHistory();
    list.splice(index, 1);
    saveToBigDB('diary_history', list); // ‰øùÂ≠òÊõ¥Êñ∞
    
    // Â¶ÇÊûúÂà†Èô§‰∫ÜÂΩìÂâçÊ≠£Âú®ÁúãÁöÑÔºåÊ∏ÖÁ©∫ÁïåÈù¢
    if (index === currentDiaryIndex) {
        if (list.length > 0) {
            currentDiaryIndex = 0;
            renderDiaryUI(list[0]);
        } else {
            currentDiaryIndex = -1;
            document.getElementById('diary-text-content').innerHTML = '';
            document.getElementById('bag-items-list').innerHTML = '';
            document.getElementById('d-date-display').innerText = '--/--/--';
        }
    } else if (index < currentDiaryIndex) {
        // Â¶ÇÊûúÂà†Èô§‰∫ÜÂâçÈù¢ÁöÑÁ¥¢ÂºïÔºåÂΩìÂâçÁ¥¢ÂºïË¶ÅÂáè1
        currentDiaryIndex--;
    }
    
    renderDiaryHistoryList();
}
// ==================== üçé ÊïôÂØº (Teaching) APP Ê†∏ÂøÉÈÄªËæë ====================

let teachingDeck = [];
let teachingFlipped = [];
let currentTeachingSession = null; // ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑ‰ºöËØùÊï∞ÊçÆ
let pendingTeachingResult = null; // ÊöÇÂ≠ò API ËøîÂõûÁªìÊûú

// 1. Êó†ÈôêÂ≠òÂÇ®ÂàùÂßãÂåñ
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
if (!window.BIG_MEMORY.teaching_data) // Á°Æ‰øùÂèòÈáèÂàùÂßãÂåñ
if (!window.BIG_MEMORY.teaching_data) window.BIG_MEMORY.teaching_data = [];

function getTeachingData() { return window.BIG_MEMORY.teaching_data || []; }

function saveTeachingData(list) {
    window.BIG_MEMORY.teaching_data = list;
    // üî• Âº∫Âà∂ÂÜôÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'teaching_data', data: list });
}

// 2. ÊâìÂºÄ APP
window.openTeachingApp = function() {
    document.getElementById('teaching-app-modal').style.display = 'flex';
    
    // Â¶ÇÊûúÊ≤°ÊúâÊ≠£Âú®ËøõË°åÁöÑ‰ºöËØùÔºåÂàùÂßãÂåñÁïåÈù¢
    if (!currentTeachingSession) {
        switchTeachingView('setup');
        // Ê∏ÖÁ©∫ËæìÂÖ•
        document.getElementById('teach-subject').value = '';
        document.getElementById('teach-subject').disabled = false;
        document.getElementById('teach-scope').value = '';
        document.getElementById('teach-scope').disabled = false;
        document.getElementById('teach-synopsis').value = '';
    } else {
        // Â¶ÇÊûúÊ≠£Âú®Áª≠ÂÜôÔºåÁõ¥Êé•ÊòæÁ§∫
        switchTeachingView('active');
    }
    
    renderTeachingHistory();
};

window.switchTeachingView = function(mode) {
    const setupEl = document.getElementById('teaching-setup-view');
    const activeEl = document.getElementById('teaching-active-view');
    const historyEl = document.getElementById('teaching-history-view');
    const btnSetup = document.getElementById('btn-teach-setup');
    const btnHist = document.getElementById('btn-teach-history');

    setupEl.style.display = 'none';
    activeEl.style.display = 'none';
    historyEl.style.display = 'none';

    if (mode === 'setup') {
        setupEl.style.display = 'block';
        btnSetup.style.background = '#273c75'; btnSetup.style.color = 'white';
        btnHist.style.background = '#dcdde1'; btnHist.style.color = '#333';
    } else if (mode === 'active') {
        activeEl.style.display = 'block';
    } else {
        historyEl.style.display = 'block';
        renderTeachingHistory();
        btnSetup.style.background = '#dcdde1'; btnSetup.style.color = '#333';
        btnHist.style.background = '#273c75'; btnHist.style.color = 'white';
    }
};

// 3. ÂêØÂä®ÊäΩÁâå (ËøõÂÖ•‰∏ìÁî®ÁâåÊ°å)
window.startTeachingDraw = function() {
    const subject = document.getElementById('teach-subject').value;
    const scope = document.getElementById('teach-scope').value;
    const synopsis = document.getElementById('teach-synopsis').value;

    if (!subject || !scope || !synopsis) return alert("ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁßëÁõÆ„ÄÅËåÉÂõ¥ÂíåÊïÖ‰∫ãÊ¢óÊ¶ÇÔºÅ");

    // ‰øùÂ≠òÂΩìÂâç‰ºöËØùÁä∂ÊÄÅ
    if (!currentTeachingSession) {
        currentTeachingSession = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            subject: subject,
            scope: scope,
            turns: [] // Â≠òÂÇ®ÊØè‰∏ÄËΩÆÁöÑ {synopsis, cards, story, quiz}
        };
    } else {
        // Áª≠ÂÜôÊ®°ÂºèÔºåÊõ¥Êñ∞ÊúÄÊñ∞ÁöÑÊ¢óÊ¶Ç
        // ÈîÅÂÆöÁßëÁõÆÂíåËåÉÂõ¥ÔºåÈò≤Ê≠¢‰∏≠ÈÄîÂèòÂç¶
        document.getElementById('teach-subject').disabled = true;
        document.getElementById('teach-scope').disabled = true;
    }

    // ÊâìÂºÄ‰∏ìÁî®ÁâåÊ°å
    const modal = document.getElementById('teaching-card-table-modal');
    const area = document.getElementById('teaching-card-area');
    const desk = document.getElementById('teaching-card-table-desk');

    // Â∫îÁî®ÁæéÂåñËÉåÊôØ (Â§çÁî®Â°îÁΩóÊ°åÂ∏É)
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    teachingDeck = [];
    teachingFlipped = [];
    document.getElementById('teaching-flipped-count').innerText = '0';

    // ÁîüÊàê114Âº†Áâå (Â§çÁî®ÈÄªËæë)
    for(let i=0; i<=77; i++) teachingDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) teachingDeck.push({ type:'lenormand', id:i, isReversed:false });
    teachingDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4;
    const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    teachingDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                teachingFlipped = teachingFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                teachingFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) {
                        front.style.backgroundImage=`url(${res.data})`;
                        front.innerText = "";
                    } else {
                        front.style.background = "#fff";
                        front.innerText = card.id;
                    }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('teaching-flipped-count').innerText = teachingFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};

// 4. API Ë∞ÉÁî®‰∏éÁîüÊàê (Ê†∏ÂøÉÈÄªËæë)
window.finishTeachingDraw = async function() {
    if(teachingFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#teaching-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üß† Ê≠£Âú®Âá∫È¢ò‰∏éÊûÑÊÄù...";

    // ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = teachingFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const synopsis = document.getElementById('teach-synopsis').value;
    const subject = currentTeachingSession.subject;
    const scope = currentTeachingSession.scope;

    // Ëé∑ÂèñAPI Key
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰Ωç‰∏•Ê†º‰ΩÜÂÖÖÊª°È≠ÖÂäõÁöÑÂØºÂ∏àÔºåÂêåÊó∂‰πüÊòØ‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÂΩìÂâçÊÉÖÂ¢É„ÄëÔºö
- ÁßëÁõÆÔºö${subject}
- ËÄÉËØïËåÉÂõ¥Ôºö${scope}
- ÊïÖ‰∫ãÊ¢óÊ¶Ç/Áî®Êà∑Ë°åÂä®Ôºö${synopsis}
- ÂëΩËøêÂç°ÁâåÔºàËÉΩÈáèÊµÅÂä®ÔºâÔºö${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑ÁîüÊàê‰∏Ä‰∏™ JSON ÂØπË±°ÔºåÂåÖÂê´‰ª•‰∏ã‰∏§ÈÉ®ÂàÜÔºö

1. **ÈÄâÊã©È¢ò (Quiz)**Ôºö
   - Âü∫‰∫é„Äê${subject}„ÄëÂíå„Äê${scope}„ÄëÂá∫È¢ò„ÄÇ
   - ÈöæÂ∫¶Ôºö‰∏≠Á≠âÂÅèÈöæÔºåÂøÖÈ°ªÊúâÂ≠¶ÊúØ‰ª∑ÂÄº„ÄÇ
   - ÂåÖÂê´ 5 ‰∏™ÈÄâÈ°πÔºåÂè™Êúâ‰∏Ä‰∏™Ê≠£Á°Æ„ÄÇË¶ÅÂì™ÁßçÂæàÊòéÁ°ÆÊ≠£Á°ÆÂÖ∂ÂÆÉÂæàÊòéÁ°ÆÊòØÈîôËØØÁ≠îÊ°àÁöÑÈ¢òÁõÆÔºå‰∏çÂèØ‰ª•Ê®°Á≥äÊ≠£Á°Æ„ÄÇ

2. **ÂºÄÊîæÂºèÊïÖ‰∫ã (Story)**Ôºö
   - ÁªìÂêà„ÄêÊïÖ‰∫ãÊ¢óÊ¶Ç„ÄëÂíå„ÄêÂëΩËøêÂç°ÁâåÁöÑËÉΩÈáè„Äë„ÄÇ
   - ËßíËâ≤‰∏éÁî®Êà∑ÁöÑ‰∫íÂä®„ÄÇ
   - **ÁªìÂ±ÄÂøÖÈ°ªÊòØÂºÄÊîæÂºèÁöÑ**ÔºåÂÅúÁïôÂú®ÂÖ≥ÈîÆÊó∂ÂàªÔºåÁ≠âÂæÖÁî®Êà∑ÂêéÁª≠ÁöÑË°åÂä®ÔºàÁª≠ÂÜôÔºâ„ÄÇÂÖ®ÊñáÂøÖÈ°ªÁî®‰∏≠ÊñáÔºÅÔºÅÔºÅ
   - Â¶ÇÊûúÁâåÊÑèÁßØÊûÅÔºå‰∫íÂä®ÂèØ‰ª•ÁîúËúú/È°∫Âà©ÔºõÂ¶ÇÊûúÁâåÊÑèÊ∂àÊûÅÔºåÂèØ‰ª•ÊòØ‰∏•ÂéâÁöÑÊÉ©ÁΩöÊàñÁ™ÅÂèëÁä∂ÂÜµ„ÄÇÔºàÁâåÊÑèË¶ÅËûçÂÖ•ÊïÖ‰∫ã‰∏çÂèØ‰ª•Áõ¥Êé•ËØ¥Êòé„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSONÔºö
{
  "question": "È¢òÁõÆÂÜÖÂÆπ...",
  "options": ["ÈÄâÈ°πA", "ÈÄâÈ°πB", "ÈÄâÈ°πC", "ÈÄâÈ°πD", "ÈÄâÈ°πE"],
  "correct_index": 0, (0‰ª£Ë°®A, 1‰ª£Ë°®B...)
  "explanation": "Á≠îÊ°àËß£Êûê...",
  "story": "‰∏ÄÊÆµ‰∏çÂ∞ë‰∫é300Â≠óÁöÑÂºÄÊîæÂºèÁªìÂ±ÄÊïÖ‰∫ã..."
}
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{role:"system", content:"Output JSON only."}, {role:"user", content:prompt}],
                temperature: 0.7
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const first = raw.indexOf('{'); const last = raw.lastIndexOf('}');
        if(first !== -1 && last !== -1) raw = raw.substring(first, last+1);
        
        pendingTeachingResult = JSON.parse(raw);
        
        // Ê∏≤ÊüìÁ≠îÈ¢òÁïåÈù¢
        renderTeachingQuiz(pendingTeachingResult);
        
        // ÂÖ≥Èó≠ÁâåÊ°åÔºåÂàáÊç¢Âà∞Ê¥ªË∑ÉËßÜÂõæ
        document.getElementById('teaching-card-table-modal').style.display = 'none';
        switchTeachingView('active');

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};

// 5. Ê∏≤ÊüìÊµãÈ™å
function renderTeachingQuiz(data) {
    document.getElementById('teach-question-text').innerText = data.question;
    const list = document.getElementById('teach-options-list');
    list.innerHTML = '';
    document.getElementById('teach-quiz-feedback').innerText = '';
    document.getElementById('teaching-story-area').style.display = 'none'; // ÈöêËóèÊïÖ‰∫ã

    data.options.forEach((opt, idx) => {
        const div = document.createElement('div');
        div.className = 'quiz-option';
        div.innerHTML = `<span class="quiz-index">${String.fromCharCode(65+idx)}.</span> ${opt}`;
        div.onclick = () => checkTeachingAnswer(div, idx, data);
        list.appendChild(div);
    });
}

// 6. Ê£ÄÊü•Á≠îÊ°à
function checkTeachingAnswer(el, idx, data) {
    // Á¶ÅÁî®ÊâÄÊúâÈÄâÈ°πÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    const opts = document.querySelectorAll('.quiz-option');
    opts.forEach(o => o.style.pointerEvents = 'none');

    if (idx === data.correct_index) {
        el.classList.add('correct');
        document.getElementById('teach-quiz-feedback').innerHTML = `<span style="color:#44bd32">‚úÖ ÂõûÁ≠îÊ≠£Á°ÆÔºÅËß£ÈîÅÂêéÁª≠ÂâßÊÉÖ...</span>`;
        
        // ÊòæÁ§∫ÊïÖ‰∫ã
        setTimeout(() => {
            document.getElementById('teach-story-content').innerHTML = `
                ${data.story.replace(/\n/g, '<br>')}
                <br><br>
                <div style="font-size:0.85rem; color:#666; background:#f1f2f6; padding:10px; border-radius:4px;">
                    üí° <strong>Ëß£ÊûêÔºö</strong> ${data.explanation}
                </div>
            `;
            document.getElementById('teaching-story-area').style.display = 'block';
            
            // Â∞ÜÊ≠§ËΩÆÂ≠òÂÖ• Session
            currentTeachingSession.turns.push({
                synopsis: document.getElementById('teach-synopsis').value,
                result: data
            });
        }, 800);

    } else {
        el.classList.add('wrong');
        document.getElementById('teach-quiz-feedback').innerHTML = `<span style="color:#c23616">‚ùå ÂõûÁ≠îÈîôËØØ„ÄÇ‰Ω†ÈúÄË¶ÅÁ≠îÂØπÊâçËÉΩÁúãÂà∞ÂâßÊÉÖ„ÄÇ</span>`;
        // ÂÖÅËÆ∏ÈáçËØï (ÊàñËÄÖ‰Ω†ÂèØ‰ª•ÂÅöÁöÑÊõ¥ÁªùÔºåÊØîÂ¶ÇÊâ£ÂàÜ)
        setTimeout(() => {
            opts.forEach(o => o.style.pointerEvents = 'auto');
            el.classList.remove('wrong');
        }, 1000);
    }
}

// 7. Áª≠ÂÜô
window.continueTeachingStory = function() {
    // ÂàáÂõû Setup ÁïåÈù¢Ôºå‰øùÁïôÁßëÁõÆËåÉÂõ¥ÔºåÊ∏ÖÁ©∫Ê¢óÊ¶Ç
    switchTeachingView('setup');
    document.getElementById('teach-synopsis').value = '';
    document.getElementById('teach-synopsis').placeholder = "ËØ∑ËæìÂÖ•Êé•‰∏ãÊù•ÁöÑÂâßÊÉÖÂèëÂ±ï / ‰Ω†ÁöÑË°åÂä®...";
    // ÁßëÁõÆÂíåËåÉÂõ¥ ‰øùÊåÅÈîÅÂÆöÁä∂ÊÄÅ
};

// 8. ÁªìÊùüÂπ∂‰øùÂ≠ò
window.endTeachingSession = function() {
    if(!currentTeachingSession) return;
    
    // Â≠òÂÖ•ÂéÜÂè≤
    const list = getTeachingData();
    list.unshift(currentTeachingSession);
    saveTeachingData(list);
    
    alert("üìù Êú¨Ê¨°ËæÖÂØºÂ∑≤ÂΩíÊ°£„ÄÇ");
    
    // ÈáçÁΩÆÁä∂ÊÄÅ
    currentTeachingSession = null;
    document.getElementById('teach-subject').disabled = false;
    document.getElementById('teach-scope').disabled = false;
    document.getElementById('teach-subject').value = '';
    document.getElementById('teach-scope').value = '';
    document.getElementById('teach-synopsis').value = '';
    
    switchTeachingView('history');
};

// 9. Ê∏≤ÊüìÂéÜÂè≤
window.renderTeachingHistory = function() {
    const list = getTeachingData();
    const container = document.getElementById('teaching-history-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ËæÖÂØºËÆ∞ÂΩï</div>';
        return;
    }

    list.forEach((session, idx) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '15px'; div.style.padding = '15px';
        div.style.background = '#fff';
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">
                <span style="font-weight:bold; color:#273c75;">${session.subject}</span>
                <span style="font-size:0.8rem; color:#888;">${session.date}</span>
            </div>
            <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">ËåÉÂõ¥: ${session.scope} | ÂÖ± ${session.turns.length} ËΩÆ</div>
            <div style="text-align:right;">
                <button class="m-btn small" onclick="deleteTeachingSession(${idx})" style="background:#ffcdd2; color:#c23616; font-size:0.8rem;">Âà†Èô§</button>
            </div>
        `;
        container.appendChild(div);
    });
};

window.deleteTeachingSession = function(index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§Ëøô‰ªΩÊ°£Ê°àÔºü")) return;
    const list = getTeachingData();
    list.splice(index, 1);
    saveTeachingData(list);
    renderTeachingHistory();
};

// üî¥ ÂÖ≥ÈîÆÔºöÂ∞Ü teaching_data Ê∑ªÂä†Âà∞Êó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÂàóË°®
if (typeof loadAllBigData === 'function') {
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad(); // ÂÖàË∑ëÂéüÊù•ÁöÑ
        // Ë°•Âä†ËΩΩ teaching_data
        try {
            let res = await idb.get('universal_store', 'teaching_data');
            if(res) window.BIG_MEMORY.teaching_data = res.data;
        } catch(e){}
    }
}
window.addEventListener('load', function() {
    
    console.log("È°µÈù¢ÂÖÉÁ¥†Âä†ËΩΩÂÆåÊØïÔºåÂºÄÂßãÂêØÂä®Á≥ªÁªü...");
    idb.init().then(async () => {
        await loadAllBigData(); 
        loadTVContent(); 
        if(typeof loadGameWidgetTheme === 'function') {
            loadGameWidgetTheme();
        }

        try {
            await idb.get('settings_heavy', 'myAvatar'); 
        } catch(e) {
            console.log("È¢ÑÁÉ≠Êï∞ÊçÆÂ∫ìËøûÊé•...");
        }
        
        console.log("Á≥ªÁªüÂêØÂä®ÂÆåÊØïÔºÅÊâÄÊúâÁªÑ‰ª∂Â∑≤Â∞±Áª™„ÄÇ");
    });
});
// ==================== üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ (Witch) APP Ê†∏ÂøÉÈÄªËæë ====================

let witchDeck = [];
let witchFlipped = [];
let witchGameState = {
    myTrap: -1, // Áî®Êà∑ÈÄâÁöÑÈô∑Èò±Á¥¢Âºï
    charTrap: -1, // ËßíËâ≤ÈÄâÁöÑÈô∑Èò±Á¥¢Âºï (APIÁîüÊàê)
    charPunishment: "", // ËßíËâ≤ÁªôÁî®Êà∑ÁöÑÊÉ©ÁΩö (APIÁîüÊàê)
    charMoves: [], // ËßíËâ≤ÂêÉÈ•ºÂπ≤ÁöÑ‰ºòÂÖàÁ∫ßÈ°∫Â∫è (APIÁîüÊàê)
    reactions: {}, // ÂêÑÁßçÊÉÖÂÜµÁöÑÂèçÂ∫îÊñáÊ°à (APIÁîüÊàê)
    eatenCookies: [], // Â∑≤ÁªèË¢´ÂêÉÊéâÁöÑÈ•ºÂπ≤Á¥¢Âºï
    isMyTurn: true,
    isPlaying: false,
    history: []
};

// 1. Êó†ÈôêÂ≠òÂÇ®ÂàùÂßãÂåñ
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
if (!window.BIG_MEMORY.witch_data) window.BIG_MEMORY.witch_data = []; // ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÁªÑ

function getWitchData() { return window.BIG_MEMORY.witch_data || []; }
function saveWitchData(list) {
    window.BIG_MEMORY.witch_data = list;
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'witch_data', data: list });
}

// 2. ÊâìÂºÄ/ÂÖ≥Èó≠ APP
window.openWitchApp = function() {
    document.getElementById('witch-app-modal').style.display = 'flex';
    switchWitchView('setup');
    initWitchBoard(); // ÂàùÂßãÂåñ 20 ‰∏™È•ºÂπ≤
};

window.switchWitchView = function(mode) {
    const gameEl = document.getElementById('witch-game-view');
    const histEl = document.getElementById('witch-history-view');
    const btnGame = document.getElementById('btn-witch-setup');
    const btnHist = document.getElementById('btn-witch-history');

    if (mode === 'setup' || mode === 'game') {
        gameEl.style.display = 'block';
        histEl.style.display = 'none';
        btnGame.style.background = '#6c5ce7'; btnGame.style.color = '#fff';
        btnHist.style.background = '#30336b'; btnHist.style.color = '#ccc';
    } else {
        gameEl.style.display = 'none';
        histEl.style.display = 'block';
        btnGame.style.background = '#30336b'; btnGame.style.color = '#ccc';
        btnHist.style.background = '#6c5ce7'; btnHist.style.color = '#fff';
        renderWitchHistory();
    }
};

// 3. ÂàùÂßãÂåñÊ£ãÁõò
// === üßô‚Äç‚ôÄÔ∏è ÂàùÂßãÂåñ/ÈáçÁªòÊ£ãÁõò (Â¢ûÂº∫ÁâàÔºöÊîØÊåÅ Êñ∞ÂºÄ/ÂõûÊîæ/ÈáçÁé©) ===
window.initWitchBoard = function(mode = 'new', data = null) {
    const grid = document.getElementById('witch-board-container');
    grid.innerHTML = '';
    
    // 1. Êñ∞Ê∏∏Êàè (New)
    if (mode === 'new') {
        witchGameState = {
            myTrap: -1, charTrap: -1, charPunishment: "",
            charMoves: [], reactions: {}, stories: {},
            eatenCookies: [], isMyTurn: true, isPlaying: false, history: []
        };
        // UIÈáçÁΩÆ
        document.getElementById('witch-setup-panel').style.display = 'block';
        document.getElementById('btn-witch-start').style.display = 'block';
        document.getElementById('witch-log-panel').style.display = 'none';
        document.getElementById('witch-user-punishment').value = "";
        document.getElementById('witch-trap-display').innerText = "Êú™ÈÄâÊã©";
    }
    // 2. ÂéÜÂè≤ÂõûÊîæ (Replay - Âè™ËØª)
    else if (mode === 'replay') {
        witchGameState = JSON.parse(JSON.stringify(data));
        witchGameState.isPlaying = false; // ÈîÅÂÆö
        
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        document.getElementById('witch-reaction-text').innerText = "üìö ÂéÜÂè≤ÂõûÊîæÊ®°Âºè";
        document.getElementById('witch-game-log').innerHTML = "--- ÂéÜÂè≤ÂõûÊîæ ---";
    }
    // 3. ÈáçÊñ∞ÊåëÊàò (Retry - ÂèØÊìç‰ΩúÔºå‰ΩÜÊ≤øÁî®ËÆæÂÆö)
    else if (mode === 'retry') {
        // Ê∑±Êã∑Ë¥ùÂéÜÂè≤Êï∞ÊçÆÔºå‰ΩÜÈáçÁΩÆËøõÂ∫¶
        witchGameState = JSON.parse(JSON.stringify(data));
        witchGameState.eatenCookies = []; // Ê∏ÖÁ©∫ÂêÉÊéâÁöÑÈ•ºÂπ≤
        witchGameState.isPlaying = true;  // ÊøÄÊ¥ªÊ∏∏Êàè
        witchGameState.isMyTurn = true;   // ËΩÆÂà∞‰Ω†
        
        // UI ËÆæÁΩÆ‰∏∫Ê∏∏ÊàèËøõË°å‰∏≠
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        document.getElementById('witch-reaction-text').innerText = "üîÑ ÈáçÊñ∞ÊåëÊàòÔºöÂëΩËøêÂ∑≤ÈáçÁΩÆÔºåËØ∑ÂºÄÂßã...";
        document.getElementById('witch-game-log').innerHTML = "--- ÈáçÊñ∞ÂºÄÂßã ---";
    }

    // ÁîüÊàê 20 ‰∏™È•ºÂπ≤
    for (let i = 0; i < 20; i++) {
        const btn = document.createElement('div');
        btn.className = 'cookie-btn';
        btn.id = `cookie-${i}`;
        
        if (mode === 'replay') {
            // ÂõûÊîæÊ®°ÂºèÔºöÊòæÁ§∫Â∑≤ÂêÉÊéâÁöÑ
            if (witchGameState.eatenCookies.includes(i)) {
                btn.classList.add('eaten');
                btn.innerText = '';
                if (i === witchGameState.myTrap) { btn.innerText = 'üòà'; btn.style.background = '#00cec9'; }
                if (i === witchGameState.charTrap) { btn.innerText = 'üíÄ'; btn.style.background = '#d63031'; }
            } else {
                btn.innerText = 'üêª';
            }
        } 
        else if (mode === 'retry') {
            // ÈáçÁé©Ê®°ÂºèÔºöÂÖ®ÈÉ®ÈáçÁΩÆ‰∏∫Ê≤°ÂêÉÔºåÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
            btn.innerText = 'üêª';
            btn.onclick = () => handleCookieClick(i);
            
            // Â¶ÇÊûúÊòØËá™Â∑±ÁöÑÈô∑Èò±ÔºåÁ®çÂæÆÊ†áËÆ∞‰∏Ä‰∏ãËÆ©Ëá™Â∑±Áü•ÈÅìÔºàÂèØÈÄâÔºåËøôÈáåÊàëÂÅöÊàêÈ´ò‰∫ÆËæπÊ°ÜÔºâ
            if (i === witchGameState.myTrap) {
                btn.classList.add('selected'); 
            }
        }
        else {
            // Êñ∞Ê∏∏ÊàèÊ®°Âºè
            btn.innerText = 'üêª';
            btn.onclick = () => handleCookieClick(i);
        }
        grid.appendChild(btn);
    }
};

// 4. Â§ÑÁêÜÈ•ºÂπ≤ÁÇπÂáª
window.handleCookieClick = function(index) {
    // A. ËÆæÁΩÆÈò∂ÊÆµÔºöÈÄâËá™Â∑±ÁöÑÈô∑Èò±
    if (!witchGameState.isPlaying) {
        // Ê∏ÖÈô§ÊóßÈÄâÊã©
        if (witchGameState.myTrap !== -1) {
            document.getElementById(`cookie-${witchGameState.myTrap}`).classList.remove('selected');
        }
        witchGameState.myTrap = index;
        document.getElementById(`cookie-${index}`).classList.add('selected');
        document.getElementById('witch-trap-display').innerText = `È•ºÂπ≤ #${index + 1}`;
        return;
    }

    // B. Ê∏∏ÊàèÈò∂ÊÆµÔºöÂêÉÈ•ºÂπ≤
    if (witchGameState.isPlaying && witchGameState.isMyTurn) {
        if (witchGameState.eatenCookies.includes(index)) return alert("ËøôÂùóÂ∑≤ÁªèË¢´ÂêÉÊéâ‰∫ÜÔºÅ");
        
        processTurn(index, 'user');
    }
};

// 5. ÂêØÂä®ÊäΩÁâå
window.startWitchDraw = function() {
    if (witchGameState.myTrap === -1) return alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™È•ºÂπ≤‰Ωú‰∏∫‰Ω†ÁöÑÈô∑Èò±ÔºÅ");
    const punish = document.getElementById('witch-user-punishment').value;
    if (!punish) return alert("ËØ∑Â°´ÂÜôÁªôTaÁöÑÊÉ©ÁΩöÂÜÖÂÆπÔºÅ");

    const modal = document.getElementById('witch-card-table-modal');
    const area = document.getElementById('witch-card-area');
    
    // Â∫îÁî®ÁæéÂåñ
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) document.getElementById('witch-card-table-desk').style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    witchDeck = []; witchFlipped = [];
    document.getElementById('witch-flipped-count').innerText = '0';

    // 114Âº†ÁâåÂ∫ì
    for(let i=0; i<=77; i++) witchDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) witchDeck.push({ type:'lenormand', id:i, isReversed:false });
    witchDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    witchDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                witchFlipped = witchFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                witchFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) front.style.backgroundImage=`url(${res.data})`;
                    else { front.style.background="#fff"; front.innerText=card.id; }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('witch-flipped-count').innerText = witchFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};
// === üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APPÔºöÁîüÊàêÂâßÊú¨ (‰øÆÊîπÁâàÔºöÂ§öËØ≠Èü≥ + Âº∫ÁâåÊÑè) ===
window.finishWitchDraw = async function() {
    if(witchFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#witch-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üîÆ Ê≠£Âú®ÁºñÁªáÊÉ©ÁΩöÂâßÊú¨...";

    // Êï∞ÊçÆÂáÜÂ§á
    const cardsDesc = witchFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const userPunish = document.getElementById('witch-user-punishment').value;
    const userTrapIdx = witchGameState.myTrap;

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) { btn.innerText = oldText; btn.disabled = false; return alert("ËØ∑ÈÖçÁΩÆ API Key"); }

    // üî•üî•üî• Ê†∏ÂøÉ‰øÆÊîπÔºöÊèêÁ§∫ËØç (Prompt) Êõ¥Êñ∞ üî•üî•üî•
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™ÊìÖÈïøÂÜô‚ÄúÊÉ©ÁΩöÊ∏∏Êàè‚ÄùÂâßÊÉÖÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„ÄêÊ∏∏ÊàèËßÑÂàô„ÄëÔºöÁî®Êà∑(Êàë)ÂíåËßíËâ≤(Ta)Áé©ÂêÉÈ•ºÂπ≤ÔºåÂêÉÂà∞Èô∑Èò±ÁöÑ‰∫∫Êé•ÂèóÊÉ©ÁΩö„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÂëΩËøêÁâå (ÂÜ≥ÂÆöÊÉ©ÁΩöÁöÑÂ∞∫Â∫¶ÂíåÊ∞õÂõ¥)„ÄëÔºö${cardsDesc}
„ÄêÁî®Êà∑ËÆæÂÆöÁöÑÊÉ©ÁΩö (Â¶ÇÊûúËßíËâ≤Ëæì‰∫Ü)„ÄëÔºö${userPunish}
„ÄêÁî®Êà∑Èô∑Èò±‰ΩçÁΩÆ„ÄëÔºö#${userTrapIdx} (0-19)

„Äê‚ö°Ô∏è Ê†∏ÂøÉÂéüÂàô„ÄëÔºö
**ÊâÄÊúâÁîüÊàêÁöÑÂÜÖÂÆπÔºàÈô∑Èò±ÈÄâÊã©„ÄÅÂèçÂ∫îÂè∞ËØç„ÄÅÊïÖ‰∫ãËµ∞ÂêëÔºâÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÊäΩÂà∞ÁöÑ„ÄêÂëΩËøêÁâå„ÄëÁöÑÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊ≥¢Âä®Ôºâ„ÄÇ**
‰æãÂ¶ÇÔºöÁâåÊÑèÊòØ‚ÄúÊ¨∫È™ó/ÈöêÁûí‚ÄùÔºåËßíËâ≤ÂèØËÉΩ‰ºöÂÅáË£ÖÊ≤°‰∫ãÔºõÁâåÊÑèÊòØ‚ÄúÂÜ≤Âä®/ÁÉ≠ÊÉÖ‚ÄùÔºåËßíËâ≤ÂèØËÉΩ‰ºöÊåëË°Ö„ÄÇ

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑ÁîüÊàê‰ª•‰∏ãÂÜÖÂÆπÔºö
1. **ËßíËâ≤ÁöÑÈô∑Èò±**Ôºö(0-19Ôºå‰∏çËÉΩÊòØ #${userTrapIdx})„ÄÇ
2. **Ë°åÂä®ÈÄªËæë**ÔºöËßíËâ≤ÂêÉÈ•ºÂπ≤ÁöÑÈ°∫Â∫èÊï∞ÁªÑ„ÄÇ
3. **Â§öÊù°ÂÆâÂÖ®ÂèçÂ∫î**ÔºöÂΩìËßíËâ≤ÂêÉÂà∞**ÂÆâÂÖ®È•ºÂπ≤**Êó∂ËØ¥ÁöÑÂè∞ËØç„ÄÇ**ËØ∑ÁîüÊàê 5 Âà∞ 9 Âè•ÂÆåÂÖ®‰∏çÂêåÁöÑÂèçÂ∫î**ÔºåËØ≠Ê∞îË¶ÅÁ¨¶Âêà‰∫∫ËÆæÂíåÁâåÊÑèÔºàÊúâÁöÑÁ¥ßÂº†ÔºåÊúâÁöÑÂæóÊÑèÔºåÊúâÁöÑÂπ≥Ê∑°Ôºâ„ÄÇ
4. **‰∏§ÁØáÈïøÁØáÂ∞èÊïÖ‰∫ã**Ôºö
   - **Story A (Áî®Êà∑Ëæì)**ÔºöËßíËâ≤Ëé∑ËÉú„ÄÇÊèèÂÜôËßíËâ≤Â¶Ç‰ΩïÂÆûÊñΩÊÉ©ÁΩö„ÄÇ**Â≠óÊï∞‰∏çÂ∞ë‰∫é 300 Â≠ó**„ÄÇ
   - **Story B (ËßíËâ≤Ëæì)**ÔºöÁî®Êà∑Ëé∑ËÉú„ÄÇÊèèÂÜôËßíËâ≤ÂêÉÂà∞Èô∑Èò±ÂêéÁöÑÂèçÂ∫î„ÄÇ**Â≠óÊï∞‰∏çÂ∞ë‰∫é 300 Â≠ó**„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSONÔºö
{
  "char_trap_index": 5,
  "char_move_priority": [0, 1, 2, ...],
  "user_lose_story": "ÈïøÁØáÊïÖ‰∫ãÔºöÁî®Êà∑Ëæì‰∫ÜË¢´ÊÉ©ÁΩö...",
  "char_lose_story": "ÈïøÁØáÊïÖ‰∫ãÔºöËßíËâ≤Ëæì‰∫ÜÊé•ÂèóÊÉ©ÁΩö...",
  "reactions": { 
      "safe": ["Âè∞ËØç1", "Âè∞ËØç2", "Âè∞ËØç3", "Âè∞ËØç4", "Âè∞ËØç5", ...], 
      "win": "ÂìàÔºå‰Ω†Ëæì‰∫ÜÔºÅ", 
      "lose": "Âîî...Ë¢´ÂèëÁé∞‰∫Ü..." 
  }
}
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON only."}, {role:"user", content:prompt}],
                temperature: 0.85 
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const start = raw.indexOf('{'); const end = raw.lastIndexOf('}');
        if(start!==-1 && end!==-1) raw = raw.substring(start, end+1);
        
        const result = JSON.parse(raw);

        // Â∫îÁî®Êï∞ÊçÆ
        witchGameState.charTrap = result.char_trap_index;
        witchGameState.charMoves = result.char_move_priority;
        
        // ÂÖºÂÆπÊÄßÂ§ÑÁêÜÔºöÂ¶ÇÊûú AI Ê≤°ËøîÂõûÊï∞ÁªÑÔºåÂº∫Âà∂ËΩ¨‰∏∫Êï∞ÁªÑ
        if (!Array.isArray(result.reactions.safe)) {
            result.reactions.safe = [result.reactions.safe];
        }
        witchGameState.reactions = result.reactions;
        
        witchGameState.stories = {
            user_lose: result.user_lose_story,
            char_lose: result.char_lose_story
        };

        witchGameState.isPlaying = true;
        witchGameState.isMyTurn = true;
        
        // ÁïåÈù¢ÂàáÊç¢
        document.getElementById('witch-card-table-modal').style.display = 'none';
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        
        document.querySelectorAll('.cookie-btn').forEach(b => b.classList.remove('selected'));
        
        addWitchLog(`üéÆ Ê∏∏ÊàèÂºÄÂßãÔºÅÂëΩËøêÁâåÊÑèÂ∑≤Ê≥®ÂÖ•...`);
        addWitchLog(`üîÆ Ëã•‰Ω†Ëæì‰∫ÜÔºåÂ∞ÜËß¶Âèë‰∏ÄÊÆµÈïøÁØáÊÉ©ÁΩöÂâßÊÉÖ...`);
        document.getElementById('witch-reaction-text').innerText = "ËØ∑ÂÖàÂêÉ‰∏ÄÂùóÈ•ºÂπ≤...";

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};
// 7. ÂõûÂêàÂ§ÑÁêÜÈÄªËæë (‰øÆÊîπÁâàÔºöÊîØÊåÅÈöèÊú∫ÂÆâÂÖ®ËØ≠Èü≥)
function processTurn(cookieIdx, who) {
    const btn = document.getElementById(`cookie-${cookieIdx}`);
    btn.classList.add('eaten');
    btn.innerText = '';
    witchGameState.eatenCookies.push(cookieIdx);

    // ËæÖÂä©ÂáΩÊï∞ÔºöÈöèÊú∫Ëé∑Âèñ‰∏ÄÊù°ÂÆâÂÖ®ËØ≠Èü≥
    const getRandomSafeReaction = () => {
        const safeList = witchGameState.reactions.safe;
        if (Array.isArray(safeList) && safeList.length > 0) {
            return safeList[Math.floor(Math.random() * safeList.length)];
        }
        return typeof safeList === 'string' ? safeList : "ÔºàÂöºÂöºÂöº...Ôºâ";
    };

    // 1. Âà§Êñ≠ÊòØÂê¶Ëß¶ÂèëÈô∑Èò±
    if (who === 'user') {
        // Áî®Êà∑ÂêÉ‰∫Ü
        if (cookieIdx === witchGameState.charTrap) {
            handleGameOver('char_win'); // Áî®Êà∑Ëæì‰∫Ü
            return;
        }
        // ÂÆâÂÖ®ÔºöÊòæÁ§∫ËßíËâ≤ÂèçÂ∫î
        const reaction = getRandomSafeReaction();
        document.getElementById('witch-reaction-text').innerText = `‰Ω†ÂêÉ‰∫Ü #${cookieIdx + 1}„ÄÇTa: ‚Äú${reaction}‚Äù`;
        addWitchLog(`üë§ ‰Ω†ÂêÉÊéâ‰∫Ü #${cookieIdx + 1} (ÂÆâÂÖ®)`);
        
        witchGameState.isMyTurn = false;
        setTimeout(() => charAutoTurn(), 1000); 
    } 
    else {
        // ËßíËâ≤ÂêÉ‰∫Ü
        if (cookieIdx === witchGameState.myTrap) {
            handleGameOver('user_win'); // ËßíËâ≤Ëæì‰∫Ü
            return;
        }
        // ÂÆâÂÖ®ÔºöÊòæÁ§∫ËßíËâ≤ÂèçÂ∫î
        const reaction = getRandomSafeReaction();
        document.getElementById('witch-reaction-text').innerText = `TaÂêÉ‰∫Ü #${cookieIdx + 1}„ÄÇ‚Äú${reaction}‚Äù`;
        addWitchLog(`üßô‚Äç‚ôÄÔ∏è TaÂêÉÊéâ‰∫Ü #${cookieIdx + 1} (ÂÆâÂÖ®)`);
        
        witchGameState.isMyTurn = true;
    }
}

// 8. ËßíËâ≤Ëá™Âä®Ë°åÂä®
function charAutoTurn() {
    // ‰ªé‰ºòÂÖàÁ∫ßÂàóË°®‰∏≠Êâæ‰∏Ä‰∏™ËøòÊ≤°Ë¢´ÂêÉÁöÑ
    let pick = -1;
    for (let idx of witchGameState.charMoves) {
        if (!witchGameState.eatenCookies.includes(idx)) {
            pick = idx;
            break;
        }
    }
    // ÂÖúÂ∫ïÔºöÂ¶ÇÊûúÂàóË°®ÈáåÁöÑÈÉΩÊ≤°‰∫Ü(ÊûÅÂ∞ëËßÅ)ÔºåÈöè‰æøÊâæ‰∏Ä‰∏™Ê≤°ÂêÉÁöÑ
    if (pick === -1) {
        for (let i=0; i<20; i++) {
            if (!witchGameState.eatenCookies.includes(i)) { pick = i; break; }
        }
    }
    
    if (pick !== -1) {
        processTurn(pick, 'char');
    }
}
// === üßô‚Äç‚ôÄÔ∏è Ê∏∏ÊàèÁªìÁÆó (‰ΩøÁî®Êñ∞ÂºπÁ™ó) ===
function handleGameOver(resultType) {
    witchGameState.isPlaying = false;
    
    // ‰∫ÆÁâåÔºöÊòæÁ§∫ÊâÄÊúâÈô∑Èò±
    const userTrapBtn = document.getElementById(`cookie-${witchGameState.myTrap}`);
    const charTrapBtn = document.getElementById(`cookie-${witchGameState.charTrap}`);
    if(userTrapBtn) { userTrapBtn.innerText = 'üòà'; userTrapBtn.style.background = '#00cec9'; userTrapBtn.classList.remove('selected'); }
    if(charTrapBtn) { charTrapBtn.innerText = 'üíÄ'; charTrapBtn.style.background = '#d63031'; }

    let title = "";
    let content = "";
    
    // ÂÆπÈîôÔºöÈò≤Ê≠¢ stories ‰∏∫Á©∫
    const stories = witchGameState.stories || { user_lose: "ÊöÇÊó†ÊïÖ‰∫ã", char_lose: "ÊöÇÊó†ÊïÖ‰∫ã" };

 // ÊÉÖÂÜµ1ÔºöResultType ‰∏∫ 'user_win' (‰Ω†Ëµ¢‰∫ÜÔºå‰ª£Ë°® Ta Ë∏©Âà∞‰∫ÜÈô∑Èò±)
    if (resultType === 'user_win') {
        title = "üèÜ ËÉúÂà©ÔºÅTa Ë∏©‰∏≠‰∫ÜÈô∑Èò±"; 
        content = stories.char_lose; // ÊòæÁ§∫ Ta Ëæì‰∫ÜÁöÑÊïÖ‰∫ã
        document.getElementById('witch-reaction-text').innerText = witchGameState.reactions.lose; // Ta Ëæì‰∫ÜÁöÑÂèçÂ∫î
        addWitchLog(`üéâ ÁªìÂ±ÄËææÊàêÔºö‰Ω†Ëµ¢‰∫ÜÔºåËßíËâ≤Êé•ÂèóÊÉ©ÁΩö`); 
    } 
    // ÊÉÖÂÜµ2Ôºö‰Ω†Ëæì‰∫Ü (‰Ω†Ë∏©Âà∞‰∫ÜÈô∑Èò±)
    else {
        title = "üíÄ Â§±Ë¥•ÔºÅ‰Ω†Ë∏©‰∏≠‰∫ÜÈô∑Èò±"; 
        content = stories.user_lose; // ÊòæÁ§∫ ‰Ω† Ëæì‰∫ÜÁöÑÊïÖ‰∫ã
        document.getElementById('witch-reaction-text').innerText = witchGameState.reactions.win; // Ta Ëµ¢‰∫ÜÁöÑÂèçÂ∫îÔºàÂæóÊÑèÔºâ
        addWitchLog(`üíî ÁªìÂ±ÄËææÊàêÔºö‰Ω†Ëæì‰∫ÜÔºåËØ∑Êé•ÂèóÊÉ©ÁΩö`); 
    }
    
    // üî• ‰ΩøÁî®Êñ∞ÁöÑ„ÄêÂ•≥Â∑´‰∏ìÁî®ÂºπÁ™ó„Äë
    const modal = document.getElementById('witch-story-modal');
    document.getElementById('ws-title').innerText = title;
    document.getElementById('ws-content').innerText = content.replace(/\n/g, '\n\n');
    document.getElementById('ws-date').innerText = new Date().toLocaleString();
    
    modal.style.display = 'flex'; // ÊòæÁ§∫ÂºπÁ™ó

    // Ëá™Âä®‰øùÂ≠òÂà∞ÂéÜÂè≤ (‰ªÖÂú®Êñ∞Ê∏∏ÊàèÊó∂‰øùÂ≠òÔºåÈáçÁé©Êó∂‰∏çÈáçÂ§ç‰øùÂ≠ò)
    // Êàë‰ª¨ÂèØ‰ª•ÁÆÄÂçïÂà§Êñ≠‰∏Ä‰∏ãÔºåÂ¶ÇÊûú history ÈáåÂ∑≤ÁªèÊúâËøô‰∏™ ID Â∞±‰∏çÂ≠ò‰∫ÜÔºåÊàñËÄÖÁÆÄÂçïÁÇπÊØèÊ¨°ÈÉΩÂ≠ò
    saveWitchHistory();
}

// 10. Êó•Âøó‰∏éÂéÜÂè≤‰øùÂ≠ò
function addWitchLog(text) {
    const log = document.getElementById('witch-game-log');
    log.innerHTML += `<div>${text}</div>`;
    log.scrollTop = log.scrollHeight;
}

// === üßô‚Äç‚ôÄÔ∏è ‰øùÂ≠òÂéÜÂè≤ (Á°Æ‰øù‰øùÂ≠òÊïÖ‰∫ãÂÜÖÂÆπ) ===
// Á°ÆËÆ§‰ª£Á†ÅÂ¶Ç‰∏ã (Â¶ÇÊûúÂ∑≤Â≠òÂú®ÂèØË¶ÜÁõñ)
function saveWitchHistory() {
    const list = getWitchData();
    
    // Â¶ÇÊûúÊòØÈáçÁé©Ê®°ÂºèÔºåÊàë‰ª¨‰∏çË¶ÅÈáçÂ§çÊ∑ªÂä†Âêå‰∏ÄÂ±ÄÁöÑËÆ∞ÂΩïÔºåÊàñËÄÖ‰Ω†ÂèØ‰ª•ÈÄâÊã©Ê∑ªÂä†„ÄÇ
    // ËøôÈáå‰∏∫‰∫ÜÁÆÄÂçïÔºåÊØèÊ¨°ÁªìÁÆóÈÉΩ‰øùÂ≠ò‰∏ÄÊù°Êñ∞ËÆ∞ÂΩï„ÄÇ
    
    const historyItem = {
        id: Date.now(),
        date: new Date().toLocaleString(),
        userPunish: document.getElementById('witch-user-punishment').value,
        winner: witchGameState.isPlaying ? 'Unfinished' : (witchGameState.eatenCookies.includes(witchGameState.charTrap) ? 'User' : 'Char'),
        // üî• ÂÖ≥ÈîÆÔºöÊ∑±Â∫¶Êã∑Ë¥ùÂΩìÂâçÁä∂ÊÄÅÔºåÂåÖÊã¨ stories Âíå ÊâÄÊúâÁöÑÈô∑Èò±‰ΩçÁΩÆ
        state: JSON.parse(JSON.stringify(witchGameState)) 
    };
    
    list.unshift(historyItem);
    saveWitchData(list);
}
// === üßô‚Äç‚ôÄÔ∏è Ê∏≤ÊüìÂéÜÂè≤ (Ê∑ªÂä†ÈáçÁé©ÊåâÈíÆ) ===
function renderWitchHistory() {
    const list = getWitchData();
    const container = document.getElementById('witch-history-list');
    container.innerHTML = '';
    
    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ÂØπÂ±ÄËÆ∞ÂΩï</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '10px';
        
        let resultText = "ËøõË°å‰∏≠/Êú™Áü•";
        const state = item.state;
        if (state) {
            if (state.eatenCookies.includes(state.charTrap)) resultText = "üíÄ Â§±Ë¥• (‰Ω†Ë∏©Èõ∑‰∫Ü)";
            else if (state.eatenCookies.includes(state.myTrap)) resultText = "üèÜ ËÉúÂà© (TaË∏©Èõ∑‰∫Ü)";
        }
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                <span>${item.date}</span>
                <span style="color:red; cursor:pointer;" onclick="deleteWitchHistory(${index})">Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; margin:5px 0; color:#a29bfe;">${resultText}</div>
            <div style="font-size:0.8rem; color:#666;">ÊÉ©ÁΩöËÆæÂÆö: ${item.userPunish}</div>
            
            <div style="display:flex; gap:10px; margin-top:8px;">
                <button class="m-btn small" onclick="retryWitchGame(${index})" style="flex:1; background:#6c5ce7; color:white;">üîÑ ÈáçÊñ∞ÊåëÊàò</button>
                <button class="m-btn small" onclick="readWitchStory(${index})" style="flex:1; background:#30336b; color:white;">üìñ ÈòÖËØªÁªìÂ±Ä</button>
            </div>
        `;
        container.appendChild(div);
    });
}

// === Êñ∞Â¢ûÔºöÈáçÁé©ÂäüËÉΩ ===
window.retryWitchGame = function(index) {
    const list = getWitchData();
    const item = list[index];
    if(!item || !item.state) return alert("Â≠òÊ°£ÊçüÂùè");
    
    // ÂàáÊç¢Âà∞Ê∏∏ÊàèÁïåÈù¢
    switchWitchView('game');
    
    // ‰ª• 'retry' Ê®°ÂºèÂàùÂßãÂåñÔºå‰º†ÂÖ•ÂéÜÂè≤Áä∂ÊÄÅ
    initWitchBoard('retry', item.state);
    
    alert("Â∑≤Âä†ËΩΩËØ•Â±ÄËÆæÂÆöÔºÅ\nÈô∑Èò±‰ΩçÁΩÆ‰∏çÂèòÔºå‰Ω†ÂèØ‰ª•Â∞ùËØïÈÅøÂºÄÈô∑Èò±Ëµ¢ÂæóÊØîËµõÔºÅ");
}

// === ‰øÆÊîπÔºöÈòÖËØªÂéÜÂè≤ÁªìÂ±Ä (‰ΩøÁî®Êñ∞ÂºπÁ™ó) ===
window.readWitchStory = function(index) {
    const list = getWitchData();
    const item = list[index];
    if(!item || !item.state || !item.state.stories) return alert("ËØ•ËÆ∞ÂΩïÊï∞ÊçÆ‰∏çÂÆåÊï¥");

    const state = item.state;
    // Âà§Êñ≠ÊòØË∞ÅËµ¢‰∫Ü (ÁÆÄÂçïÁöÑÈÄªËæëÔºöÁúãË∞ÅÂêÉÂà∞‰∫ÜÈô∑Èò±)
    const userLost = state.eatenCookies.includes(state.charTrap);
    
    let title = userLost ? "üíÄ ÂéÜÂè≤ÂõûÈ°æÔºö‰Ω†Êé•ÂèóÊÉ©ÁΩö" : "üèÜ ÂéÜÂè≤ÂõûÈ°æÔºöTaÊé•ÂèóÊÉ©ÁΩö";
    // Â¶ÇÊûúÊ≤°ÊúâÂàÜÂá∫ËÉúË¥ü(ÊØîÂ¶Ç‰∏≠ÈÄîÈÄÄÂá∫ÁöÑ)ÔºåÈªòËÆ§ÊòæÁ§∫Áî®Êà∑Ëæì‰∫ÜÁöÑÊïÖ‰∫ã(ÊàñËÄÖÈÉΩÊòæÁ§∫)
    let content = userLost ? state.stories.user_lose : state.stories.char_lose;
    if (!content) content = "ÔºàÂΩìÊó∂Êú™ÂàÜÂá∫ËÉúË¥üÔºåÊó†ÁªìÂ±ÄËÆ∞ÂΩïÔºâ";
    
    const modal = document.getElementById('witch-story-modal');
    document.getElementById('ws-title').innerText = title;
    document.getElementById('ws-content').innerText = content.replace(/\n/g, '\n\n');
    document.getElementById('ws-date').innerText = item.date;
    
    modal.style.display = 'flex';
};

// Êñ∞Â¢ûÔºöÁõ¥Êé•ÈòÖËØªÂéÜÂè≤ÁªìÂ±ÄÊïÖ‰∫ã
window.readWitchStory = function(index) {
    const list = window.BIG_MEMORY.witch_data || [];
    const item = list[index];
    if(!item || !item.state || !item.state.stories) return alert("ËØ•ËÆ∞ÂΩïÊï∞ÊçÆ‰∏çÂÆåÊï¥");

    // Âà§Êñ≠ÊòØË∞ÅËµ¢‰∫Ü
    const state = item.state;
    const userLost = state.eatenCookies.includes(state.charTrap);
    
    let title = userLost ? "üíÄ ÂéÜÂè≤ÂõûÈ°æÔºö‰Ω†Êé•ÂèóÊÉ©ÁΩö" : "üèÜ ÂéÜÂè≤ÂõûÈ°æÔºöTaÊé•ÂèóÊÉ©ÁΩö";
    let content = userLost ? state.stories.user_lose : state.stories.char_lose;
    
    document.getElementById('note-detail-title').innerText = title;
    document.getElementById('note-detail-content').innerText = content.replace(/\n/g, '\n\n');
    document.getElementById('note-detail-date').innerText = item.date;
    document.getElementById('sticky-note-modal').style.display = 'flex';
};

function deleteWitchHistory(index) {
    if(!confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const list = getWitchData();
    list.splice(index, 1);
    saveWitchData(list);
    renderWitchHistory();
}

function replayWitchGame(index) {
    const list = getWitchData();
    const item = list[index];
    switchWitchView('game');
    initWitchBoard(true, item.state); // ÂºÄÂêØÂõûÊîæÊ®°Âºè
}

// üî¥ ÂÖ≥ÈîÆÔºöÊ≥®ÂÜåÂà∞Êó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÂô®
if (typeof loadAllBigData === 'function') {
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad(); 
        try {
            let res = await idb.get('universal_store', 'witch_data');
            if(res) window.BIG_MEMORY.witch_data = res.data;
        } catch(e){}
    }
}
// === üõ†Ô∏è Âº∫Âà∂Ë¶ÜÁõñÔºöÁªìÊùü/ÈáçÁΩÆÊåâÈíÆÈÄªËæë ===
window.resetWitchGame = function() {
    // 1. Ëé∑ÂèñÂΩìÂâçÁä∂ÊÄÅÊñáÂ≠óÔºåÂà§Êñ≠ÊòØ‰∏çÊòØÂú®ÁúãÂõûÊîæ
    const statusEl = document.getElementById('witch-reaction-text');
    const isReplayMode = statusEl && statusEl.innerText.includes("ÂéÜÂè≤ÂõûÊîæ");

    // 2. Â¶ÇÊûúÊòØÊ≠£Âú®Áé©ÔºàÈùûÂõûÊîæÔºâÔºåÂºπÁ™óÁ°ÆËÆ§
    if (!isReplayMode) {
        if(!confirm("üè≥Ô∏è Á°ÆÂÆöË¶ÅÊîæÂºÉÂΩìÂâçÂØπÂ±ÄÂπ∂ËøîÂõûÂáÜÂ§áÁïåÈù¢ÂêóÔºü\n(Êú™ÂÆåÊàêÁöÑËøõÂ∫¶Â∞Ü‰∏ç‰ºö‰øùÂ≠ò)")) {
            return; // Áî®Êà∑ÁÇπ‰∫ÜÂèñÊ∂à
        }
    }

    // 3. ÊâßË°åÈáçÁΩÆ
    console.log("ÊâßË°åÈáçÁΩÆ...");
    initWitchBoard('new');
};
// === üßô‚Äç‚ôÄÔ∏è Âº∫Âà∂Ë¶ÜÁõñÔºöÂàùÂßãÂåñÊ£ãÁõòÈÄªËæë ===
window.initWitchBoard = function(mode = 'new', data = null) {
    const grid = document.getElementById('witch-board-container');
    if(!grid) return;
    grid.innerHTML = '';
    
    // --- Ê®°Âºè A: Êñ∞Ê∏∏Êàè (ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ) ---
    if (mode === 'new') {
        witchGameState = {
            myTrap: -1, charTrap: -1, charPunishment: "",
            charMoves: [], reactions: {}, stories: null,
            eatenCookies: [], isMyTurn: true, isPlaying: false, history: []
        };
        // ÊòæÈöêÊéßÂà∂
        document.getElementById('witch-setup-panel').style.display = 'block';
        document.getElementById('btn-witch-start').style.display = 'block';
        document.getElementById('witch-log-panel').style.display = 'none';
        
        // Ê∏ÖÁ©∫ËæìÂÖ•
        const punishInput = document.getElementById('witch-user-punishment');
        if(punishInput) punishInput.value = "";
        const trapDisplay = document.getElementById('witch-trap-display');
        if(trapDisplay) trapDisplay.innerText = "Êú™ÈÄâÊã©";
    }
    // --- Ê®°Âºè B: ÂéÜÂè≤ÂõûÊîæ (Âè™ËØª) ---
    else if (mode === 'replay') {
        witchGameState = JSON.parse(JSON.stringify(data));
        witchGameState.isPlaying = false; // ÈîÅÂÆö‰∏çÂèØÊìç‰Ωú
        
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        document.getElementById('witch-reaction-text').innerText = "üìö ÂéÜÂè≤ÂõûÊîæÊ®°Âºè (‰ªÖ‰æõÊü•Áúã)";
        document.getElementById('witch-game-log').innerHTML = "<div style='color:#aaa; text-align:center;'>--- üìú ÂéÜÂè≤ËÆ∞ÂΩïÂ≠òÊ°£ ---</div>";
    }
    // --- Ê®°Âºè C: ÈáçÊñ∞ÊåëÊàò (‰øùÁïôËÆæÂÆöÔºåÈáçÁΩÆËøõÂ∫¶) ---
    else if (mode === 'retry') {
        witchGameState = JSON.parse(JSON.stringify(data));
        witchGameState.eatenCookies = []; // Ê∏ÖÁ©∫ÂêÉÊéâÁöÑ
        witchGameState.isPlaying = true;  // ÊøÄÊ¥ª
        witchGameState.isMyTurn = true;   // ËΩÆÂà∞‰Ω†
        
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        document.getElementById('witch-reaction-text').innerText = "üîÑ ÈáçÊñ∞ÊåëÊàòÔºöÈô∑Èò±‰ΩçÁΩÆÊú™ÂèòÔºåËØ∑ÂºÄÂßã...";
        document.getElementById('witch-game-log').innerHTML = "<div style='color:#a29bfe; text-align:center;'>--- üîÑ ÂëΩËøêÈáçÂêØ ---</div>";
    }

    // --- ÁîüÊàê 20 ‰∏™È•ºÂπ≤ ---
    for (let i = 0; i < 20; i++) {
        const btn = document.createElement('div');
        btn.className = 'cookie-btn';
        btn.id = `cookie-${i}`;
        
        if (mode === 'replay') {
            // ÂõûÊîæÊ®°ÂºèÔºöÁõ¥Êé•ÊòæÁ§∫ÁªìÊûú
            if (witchGameState.eatenCookies.includes(i)) {
                btn.classList.add('eaten');
                btn.innerText = '';
                if (i === witchGameState.myTrap) { btn.innerText = 'üòà'; btn.style.background = '#00cec9'; }
                if (i === witchGameState.charTrap) { btn.innerText = 'üíÄ'; btn.style.background = '#d63031'; }
            } else {
                btn.innerText = 'üêª';
            }
        } 
        else if (mode === 'retry') {
            // ÈáçÁé©Ê®°ÂºèÔºöÈáçÁΩÆ‰∏∫Êú™ÂêÉÔºåÁªëÂÆöÁÇπÂáª
            btn.innerText = 'üêª';
            btn.onclick = () => handleCookieClick(i);
            // Ê†áËÆ∞‰∏Ä‰∏ãËá™Â∑±ÈÄâÁöÑÈô∑Èò±ÔºåÈò≤Ê≠¢ÂøòËÆ∞
            if (i === witchGameState.myTrap) {
                btn.style.border = "2px solid #00cec9"; 
            }
        }
        else {
            // Êñ∞Ê∏∏ÊàèÊ®°Âºè
            btn.innerText = 'üêª';
            btn.onclick = () => handleCookieClick(i);
        }
        grid.appendChild(btn);
    }
};
// ==================== üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APP ‰øÆÂ§çË°•‰∏Å (‰øùÂ≠ò‰∏éÈáçÁé©) ====================

// 1. ÊâãÂä®‰øùÂ≠òÂäüËÉΩ
window.manualSaveWitchGame = function() {
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÁîüÊàê‰∫ÜÊ∏∏ÊàèÊï∞ÊçÆ
    if (!witchGameState.isPlaying && !witchGameState.charTrap) {
        return alert("‚ö†Ô∏è Ê∏∏ÊàèËøòÊ≤°ÂºÄÂßãÔºàÊú™ÁîüÊàêÈô∑Èò±Êï∞ÊçÆÔºâÔºåÊó†Ê≥ï‰øùÂ≠òÔºÅ\nËØ∑ÂÖàÁÇπÂáª„ÄêüîÆ ÊäΩÁâåÊ≥®ÂÖ•ÁÅµÈ≠Ç„Äë„ÄÇ");
    }

    const list = getWitchData(); // Ëé∑ÂèñÊó†ÈôêÂ≠òÂÇ®‰∏≠ÁöÑÊï∞ÊçÆ
    
    // ÂàõÂª∫Â≠òÊ°£ÂØπË±°
    const historyItem = {
        id: Date.now(),
        date: new Date().toLocaleString(),
        userPunish: document.getElementById('witch-user-punishment').value || "Êó†ÊÉ©ÁΩö",
        // Ê†áËÆ∞Áä∂ÊÄÅ
        winner: witchGameState.eatenCookies.includes(witchGameState.charTrap) ? 'User' : (witchGameState.eatenCookies.includes(witchGameState.myTrap) ? 'Char' : 'ËøõË°å‰∏≠/Â≠òÊ°£'),
        // üî• Ê†∏ÂøÉÔºöÊ∑±Â∫¶Êã∑Ë¥ùÂΩìÂâçÁöÑÊ∏∏ÊàèÁä∂ÊÄÅ (ÂåÖÂê´Èô∑Èò±‰ΩçÁΩÆ„ÄÅAIÁîüÊàêÁöÑÂâßÊú¨„ÄÅÂèçÂ∫îÁ≠â)
        state: JSON.parse(JSON.stringify(witchGameState)) 
    };

    // Â≠òÂÖ•Â§¥ÈÉ®
    list.unshift(historyItem);
    
    // ‰øùÂ≠òÂà∞Êó†ÈôêÊï∞ÊçÆÂ∫ì
    saveWitchData(list);
    
    alert("‚úÖ Êú¨Â±ÄËÆæÂÆöÂ∑≤‰øùÂ≠òÔºÅ\n‰Ω†ÂèØ‰ª•Âú®„ÄêÂéÜÂè≤ÂØπÂ±Ä„Äë‰∏≠ÁÇπÂáª„ÄêüîÑ ÈáçÊñ∞ÊåëÊàò„ÄëÊù•Êó†ÈôêÈáçÁé©Ëøô‰∏ÄÂ±ÄÔºàÈô∑Èò±‰ΩçÁΩÆÂíåÂâßÊú¨‰∏çÂèòÔºâ„ÄÇ");
    
    // Â¶ÇÊûúÂéÜÂè≤Èù¢ÊùøÊòØÊâìÂºÄÁöÑÔºåÂà∑Êñ∞ÂÆÉ
    renderWitchHistory();
};

// 2. ÈáçÁé©ÂäüËÉΩ (ÁÇπÂáªÂéÜÂè≤ËÆ∞ÂΩïËß¶Âèë)
window.retryWitchGame = function(index) {
    const list = getWitchData();
    const item = list[index];
    
    if(!item || !item.state) return alert("‚ùå Â≠òÊ°£Êï∞ÊçÆÊçüÂùè");
    
    // 1. ÂàáÊç¢Âà∞Ê∏∏ÊàèÁïåÈù¢
    switchWitchView('game');
    
    // 2. ÊÅ¢Â§çÊÉ©ÁΩöËæìÂÖ•Ê°ÜÁöÑÊòæÁ§∫
    document.getElementById('witch-user-punishment').value = item.userPunish;
    
    // 3. Ë∞ÉÁî®ÂàùÂßãÂåñÂáΩÊï∞Ôºå‰ΩøÁî® 'retry' Ê®°Âºè
    // (Ëøô‰ºö‰øùÁïô item.state ÈáåÁöÑ charTrap/reactionsÔºå‰ΩÜÊ∏ÖÁ©∫ eatenCookies)
    initWitchBoard('retry', item.state);
    
    alert("üîÑ Â∑≤ËØªÂèñÊóßÂ±ÄËÆæÂÆöÔºÅ\n\n- ‰Ω†ÁöÑÈô∑Èò±‰ΩçÁΩÆ‰∏çÂèò\n- TaÁöÑÈô∑Èò±‰ΩçÁΩÆ‰∏çÂèò\n- ÊÉ©ÁΩöÂâßÊú¨‰∏çÂèò\n\nËØ∑Â∞ùËØïÈÅøÂºÄÈô∑Èò±Ëé∑ËÉúÂêßÔºÅ");
};

// 3. Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® (‰øÆÂ§çÊ†∑ÂºèÂíåÊåâÈíÆ)
window.renderWitchHistory = function() {
    const list = getWitchData(); // Á°Æ‰øù‰ªéÊó†ÈôêÂ≠òÂÇ®ËØªÂèñ
    const container = document.getElementById('witch-history-list');
    container.innerHTML = '';
    
    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†Â≠òÊ°£<br>ËØ∑Âú®Ê∏∏Êàè‰∏≠ÁÇπÂáª [‰øùÂ≠ò]</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '15px';
        div.style.background = '#2d3436'; // Ê∑±Ëâ≤ËÉåÊôØÈÖçÂêàÂ•≥Â∑´‰∏ªÈ¢ò
        div.style.border = '1px solid #6c5ce7';
        div.style.color = '#dfe6e9';
        
        let statusColor = "#a29bfe";
        if (item.winner === 'User') statusColor = "#00b894"; // Ëµ¢‰∫ÜÁªøËâ≤
        if (item.winner === 'Char') statusColor = "#ff7675"; // Ëæì‰∫ÜÁ∫¢Ëâ≤

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#b2bec3; margin-bottom:5px;">
                <span>${item.date}</span>
                <span style="color:#ff7675; cursor:pointer;" onclick="deleteWitchHistory(${index})">üóëÔ∏è Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; margin:5px 0; color:${statusColor}; font-size:1rem;">
                ${item.winner === 'User' ? 'üèÜ ‰Ω†Ëµ¢‰∫Ü' : (item.winner === 'Char' ? 'üíÄ ‰Ω†Ëæì‰∫Ü' : 'üíæ Â≠òÊ°£ÁÇπ')}
            </div>
            <div style="font-size:0.85rem; color:#b2bec3; margin-bottom:10px;">
                ÊÉ©ÁΩö: ${item.userPunish.substring(0, 15)}...
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="m-btn small" onclick="retryWitchGame(${index})" style="flex:1; background:#6c5ce7; color:white; border:none;">üîÑ ÈáçÊñ∞Áé©ËøôÂ±Ä</button>
                <button class="m-btn small" onclick="readWitchStory(${index})" style="flex:1; background:#a29bfe; color:#2d3436; border:none;">üìñ ‰ªÖÁúãÁªìÂ±Ä</button>
            </div>
        `;
        container.appendChild(div);
    });
};

// 4. Á°Æ‰øùÊó†ÈôêÂ≠òÂÇ®Âä†ËΩΩ (Èò≤Ê≠¢Êï∞ÊçÆ‰∏¢Â§±)
if (typeof loadAllBigData === 'function') {
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad(); 
        try {
            let res = await idb.get('universal_store', 'witch_data');
            if(res) window.BIG_MEMORY.witch_data = res.data;
        } catch(e){}
    }
}
    // === Êñ∞Â¢ûÔºöÁõëÂê¨ Page 4 ÂèØËßÅÊÄßÔºåÊéßÂà∂ Dock Ê†èÊòæÁ§∫/ÈöêËóè ===
   // === ÊõøÊç¢ÂéüÊúâÁöÑ page4Observer ‰ª£Á†Å ===// === ‰øÆÂ§çÔºöPage 4 ÊªëÂä®ÁõëÂê¨ & Ëá™Âä®È¢ÜÂÖª ===
const page4Observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        const dock = document.querySelector('.dock-bar');
        
        if (entry.isIntersecting) {
            // 1. ÈöêËóè Dock Ê†è
            if(dock) dock.style.display = 'none';
            
            // 2. Ëé∑ÂèñÊï∞ÊçÆ (Á°Æ‰øù‰ªéÂ§ßÂÜÖÂ≠òËé∑Âèñ)
            const data = window.BIG_MEMORY.pet_data;
            
            // 3. Âº∫Âà∂Ê∏≤Êüì‰∏ÄÊ¨°ËÉåÊôØ (Ëß£ÂÜ≥ËÉåÊôØ‰∏∫Á©∫ÁöÑÈóÆÈ¢ò)
            // Âç≥‰ΩøÊ≤°ÊúâÂÆ†Áâ©Ôºå‰πüË¶ÅÂÖàÊ∏≤ÊüìËÉåÊôØÂõæ
            if (typeof renderPetMain === 'function') {
                renderPetMain(); 
            }

            // 4. Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈ¢ÜÂÖª
            if (!data || !data.config || !data.config.type) {
                console.log("Ê£ÄÊµãÂà∞Êú™È¢ÜÂÖªÔºåÂºπÂá∫Á™óÂè£...");
                setTimeout(() => {
                    if(typeof openAdoptionModal === 'function') openAdoptionModal();
                }, 300); // Á®çÂæÆÂª∂Ëøü‰∏ÄÁÇπÔºå‰ΩìÈ™åÊõ¥Â•Ω
            } else {
                // Â¶ÇÊûúÊúâÂÆ†Áâ©ÔºåÂêØÂä®Âæ™ÁéØ
                if(typeof startPetLoop === 'function') startPetLoop();
            }
        } else {
            // Á¶ªÂºÄ Page 4ÔºåÊòæÁ§∫ Dock Ê†è
            if(dock) dock.style.display = 'flex';
        }
    });
}, { threshold: 0.5 }); // ÈòàÂÄºËÆæ‰∏∫ 0.5ÔºåÊªëÂà∞‰∏ÄÂçäÂ∞±Ëß¶Âèë

// ÂêØÂä®ÁõëÂê¨
setTimeout(() => {
    const page4El = document.getElementById('page4');
    if (page4El) page4Observer.observe(page4El);
}, 1000);
// === üöÄ ÁªàÊûÅÊó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÂô® (ÂÖ®Èáè‰øÆÊ≠£Áâà) ===
async function loadAllBigData() {
    console.log("üöÄ Ê≠£Âú®ÂêØÂä®Êó†ÈôêÂÆπÈáèÂºïÊìé (ÂÖ®ÈáèÊï¥ÂêàÁâà)...");
    
    // 1. ÂÆö‰πâÊâÄÊúâÈúÄË¶ÅÊó†ÈôêÂ≠òÂÇ®ÁöÑ Key (ÂåÖÂê´‰∫ÜÈ¶ôÁâá„ÄÅÊó•ËÆ∞„ÄÅÂ•≥Â∑´Á≠âÊâÄÊúâÊï∞ÊçÆ)
    const keys = [
        // --- Âü∫Á°ÄÊ†∏ÂøÉ ---
        'world_book', 'letters', 'finance', 
        'study', 'period', 'memo', 
        'chat_settings', 'theme_fonts', 'api_profiles', 'thesaurus_data', 
        
        // --- Êó©ÊúüÂ∫îÁî® ---
        'game_history', 'game_stats', 
        'tarot_history', 'his_phone_history', 'dream_history', 
        'forum_data', 'pickup_data', 'diary_history', 
        'pet_data', 'lofter_data', 'pain_data', 
        'gashapon_history', 'shadow_data', 'rpg_data',
        
        // --- ‰∏≠ÊúüÂ∫îÁî® ---
        'moving_data', 'teaching_data', 'companion_data', 'summary_data',

        // --- ÂêéÊúüË°•‰∏ÅÂ∫îÁî® (ÂøÖÈ°ªÂåÖÂê´Ëøô‰∫õÔºÅ) ---
        'galgame_data', 
        'scent_data',   // üå∏ È¶ôÁâáÊï∞ÊçÆ
        'puzzle_data', 
        'work_data', 
        'witch_data',   // üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´Êï∞ÊçÆ
        'tacit_data'    // üíû ÈªòÂ•ëÊåëÊàò
    ];

    // 2. Á°Æ‰øùÂÜÖÂ≠òÂØπË±°Â≠òÂú®
    if (!window.BIG_MEMORY) window.BIG_MEMORY = {};

    // 3. ÈÅçÂéÜÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
    for (let keyName of keys) {
        try {
            // ‰ªé IndexedDB (Êó†ÈôêÂ≠òÂÇ®) ËØªÂèñ
            let res = await idb.get('universal_store', keyName);
            
            if (res) {
                window.BIG_MEMORY[keyName] = res.data;
            } else {
                // Â¶ÇÊûúÊï∞ÊçÆÂ∫ìÊ≤°Êï∞ÊçÆÔºåÂ∞ùËØï‰ªé LocalStorage ËøÅÁßªÊóßÊï∞ÊçÆ (Âè™ÂÅö‰∏ÄÊ¨°)
                // ËøôÊòØ‰∏Ä‰∏™‰øùÊä§Êú∫Âà∂ÔºåÈò≤Ê≠¢‰Ω†‰ª•ÂâçÂ≠òÁöÑÊï∞ÊçÆ‰∏¢Â§±
                const oldLocal = localStorage.getItem(keyName) || localStorage.getItem(keyName + '_data');
                if (oldLocal) {
                    try {
                        const parsed = JSON.parse(oldLocal);
                        window.BIG_MEMORY[keyName] = parsed;
                        // Â≠òÂÖ•Êñ∞Â∫ì
                        idb.put('universal_store', { id: keyName, data: parsed });
                        console.log(`‚ôªÔ∏è Â∑≤Â∞Ü [${keyName}] ËøÅÁßªËá≥Êó†ÈôêÂ≠òÂÇ®`);
                    } catch(e) { window.BIG_MEMORY[keyName] = []; }
                } else {
                    // ÈªòËÆ§ÂàùÂßãÂåñ‰∏∫Á©∫Êï∞ÁªÑÊàñÂØπË±°
                    if (keyName === 'game_stats') window.BIG_MEMORY[keyName] = { mood: 50, love: 50 };
                    else if (keyName.includes('settings') || keyName === 'theme_fonts') window.BIG_MEMORY[keyName] = {};
                    else window.BIG_MEMORY[keyName] = []; 
                }
            }
        } catch (e) { 
            console.error(`‚ùå Âä†ËΩΩ ${keyName} Â§±Ë¥•`, e); 
            window.BIG_MEMORY[keyName] = []; // Âá∫ÈîôÊó∂‰ΩøÁî®Á©∫Êï∞ÁªÑÔºåÈò≤Ê≠¢ÁôΩÂ±è
        }
    }
    
    // 4. Âà∑Êñ∞ÊâÄÊúâÂèØËßÅÁöÑ UI (Á°Æ‰øùÂä†ËΩΩÂêéÁ´ãÂç≥ÊòæÁ§∫)
    try {
        if(typeof renderLetterList === 'function') renderLetterList();
        if(typeof renderFinanceUI === 'function') renderFinanceUI();
        if(typeof updateGameStatsUI === 'function') updateGameStatsUI();
        if(typeof renderWitchHistory === 'function') renderWitchHistory(); 
        if(typeof renderScentHistory === 'function') renderScentHistory(); // üå∏ Âà∑Êñ∞È¶ôÁâáÂéÜÂè≤
        if(typeof renderPetDiaryList === 'function') renderPetDiaryList();
    } catch(e) {
        console.log("UIÂà∑Êñ∞ËΩªÂæÆÊä•ÈîôÔºå‰∏çÂΩ±ÂìçÊï∞ÊçÆ:", e);
    }
    
    console.log("üéâ ÂÖ®Á≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂÆåÊØïÔºåÊó†ÈôêÂ≠òÂÇ®Â∑≤ÊøÄÊ¥ª„ÄÇ");
}
window.getWBData = function() { return window.BIG_MEMORY.world_book || {}; };
window.saveWBData = function(data) { saveToBigDB('world_book', data); };
window.getLetters = function() { return window.BIG_MEMORY.letters || []; };
window.saveLetters = function(data) { saveToBigDB('letters', data); };

window.getFinanceData = function() { return window.BIG_MEMORY.finance || []; };
const _originalAddFinance = window.addFinanceRecord;// Ê≥®ÊÑèÔºöÂéü addFinanceRecord ÂèØËÉΩÂú®‰∏ãÈù¢ÔºåÁõ¥Êé•Ë¶ÜÁõñÊï¥‰∏™ÂáΩÊï∞
window.addFinanceRecord = function(category, type) {
    const amountIn = document.getElementById('finance-amount');
    const val = parseFloat(amountIn.value);
    
    if (!val || val <= 0) {
        alert("ËØ∑ÂÖàËæìÂÖ•ÈáëÈ¢ùÔºåÂÜçÁÇπÂáªÂàÜÁ±ªÊåâÈíÆÂÖ•Ë¥¶„ÄÇ");
        return;
    }

    const thesaurus = getThesaurusData(); 
    const dictKey = type === 'expense' ? 'expense' : 'income';
    const words = thesaurus[dictKey] || [];
    const randomDesc = words.length > 0 
        ? words[Math.floor(Math.random() * words.length)] 
        : (type === 'expense' ? '‰ªäÊó•ÊîØÂá∫' : '‰ªäÊó•ÂÖ•Ë¥¶');

    const record = {
        id: Date.now(),
        date: new Date().toISOString(), 
        category: category,    
        type: type,
        amount: val,
        desc: randomDesc             
    };

    // ËØªÂèñ -> ÂÜôÂÖ•ÂÜÖÂ≠ò -> Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
    const data = getFinanceData();
    data.unshift(record);
    
    window.BIG_MEMORY.finance = data;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'finance', data: data });

    amountIn.value = '';
    currentFinanceView = new Date().toISOString().slice(0, 7);
    renderFinanceUI();
}

window.deleteFinance = function(id) {
    if (confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°Ë¥¶ÁõÆÔºü")) {
        let data = getFinanceData();
        data = data.filter(i => i.id !== id);
        
        window.BIG_MEMORY.finance = data;
        if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'finance', data: data });
        
        renderFinanceUI();
    }
}

window.getStudyData = function() { return window.BIG_MEMORY.study; };
window.saveStudyData = function(data) { saveToBigDB('study', data); };
window.getPeriodData = function() { return window.BIG_MEMORY.period || { records: [], isBleeding: false, lastAnalysis: null }; };
window.savePeriodData = function(data) { saveToBigDB('period', data); };
window.loadMemoFromLocal = function() {
    const text = window.BIG_MEMORY.memo || "";
    if(document.getElementById('desktop-memo-text')) document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæëÂ§áÂøòÂΩï...";
    if(document.getElementById('memo-full-text')) document.getElementById('memo-full-text').value = text;
};
window.saveMemoToLocal = function() {
    const text = document.getElementById('memo-full-text').value;
    saveToBigDB('memo', text); 
    document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæëÂ§áÂøòÂΩï...";
};
window.updateGameStatsUI = function() {
    document.getElementById('bar-mood').style.width = gameState.mood + '%';
    document.getElementById('val-mood').innerText = gameState.mood;
    document.getElementById('bar-love').style.width = gameState.love + '%';
    document.getElementById('val-love').innerText = gameState.love;
    saveToBigDB('game_stats', { mood: gameState.mood, love: gameState.love });
};
window.saveGameHistory = function(user, reply, note) {
    const list = window.BIG_MEMORY.game_history || [];
    list.unshift({ id: Date.now(), date: new Date().toLocaleString(), user, reply, note });
    if(list.length > 50) list.pop();
    saveToBigDB('game_history', list);
};
// --- ÂºÄÂßãÂ§çÂà∂ ---

// 1. Êñ∞Â¢ûÔºöÂΩªÂ∫ïÂà†Èô§Ê∏∏ÊàèËÆ∞ÂΩïÁöÑÂáΩÊï∞
window.deleteGameHistory = function(index) {
    if(!confirm("Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÂâßÊÉÖÂêóÔºü")) return;
    
    // ‰ªéÂÜÖÂ≠ò‰∏≠Ëé∑ÂèñÂΩìÂâçÂàóË°®
    const list = window.BIG_MEMORY.game_history || [];
    
    // Âà†Èô§ÊåáÂÆö‰ΩçÁΩÆÁöÑËÆ∞ÂΩï
    list.splice(index, 1);
    
    // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÂàóË°®Âà∞Â§ßÊï∞ÊçÆÂ∫ì
    saveToBigDB('game_history', list);
    
    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂº∫Âà∂Ê∏ÖÈô§ÊóßÁâà LocalStorage ÁºìÂ≠ò
    // ËøôÂ∞±ÊòØ‚Äú‰∏çËÉΩËØªÂèñÂ∑≤Âà†Èô§ÂÜÖÂÆπ‚ÄùÁöÑÂÖ≥ÈîÆÔºåÈò≤Ê≠¢ÊóßÊï∞ÊçÆÂ§çÊ¥ª
    localStorage.removeItem('game_history_log'); 
    
    // Âà∑Êñ∞ÁïåÈù¢
    renderGameHistory();
};

// 2. ‰øÆÊîπÔºöÊ∏≤ÊüìÂáΩÊï∞ÔºàÂ¢ûÂä†‰∫ÜÂà†Èô§ÊåâÈíÆÁöÑ HTMLÔºâ
window.renderGameHistory = function() {
    const list = window.BIG_MEMORY.game_history || [];
    const container = document.getElementById('game-history-list');
    container.innerHTML = '';
    
    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:10px;">ÊöÇÊó†ÂÜíÈô©ËÆ∞ÂΩï</div>';
        return;
    }

    list.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'morandi-card'; 
        div.style.padding = '10px';
        
        // Ê≥®ÊÑè‰∏ãÈù¢ÁöÑ innerHTML ÂèòÂåñÔºöÂ¢ûÂä†‰∫ÜÈ°∂ÈÉ®ÁöÑ‰∏ÄÊéíÂ∏ÉÂ±ÄÔºåÂåÖÂê´Êó∂Èó¥ÂíåÂà†Èô§ÊåâÈíÆ
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding-bottom:5px; margin-bottom:5px;">
                <span style="font-size:0.7rem; color:#888;">${item.date}</span>
                <button onclick="deleteGameHistory(${idx})" style="border:none; background:transparent; color:#ff6b6b; font-weight:bold; cursor:pointer; font-size:1.2rem; padding:0 5px;">√ó</button>
            </div>
            <div style="color:#555; font-size:0.9rem;"><strong>You:</strong> ${item.user}</div>
            <div style="margin-top:5px; color:#2c3e50; font-size:0.9rem;"><strong>Char:</strong> ${item.reply}</div>
            <div style="font-size:0.7rem; color:#97a89e; margin-top:5px; font-style:italic;">${item.note}</div>
        `;
        container.appendChild(div);
    });
};
window.saveDivinationResult = function() {
    if (!tarotState.lastResult) return alert("Ê≤°ÊúâÁªìÊûúÂèØ‰øùÂ≠ò");
    let history = window.BIG_MEMORY.tarot_history || [];
    history.unshift(tarotState.lastResult);
    if(history.length > 50) history = history.slice(0,50);
    saveToBigDB('tarot_history', history);
    alert("‚úÖ Â∑≤‰øùÂ≠òÂà∞ÁÅµËßÜÊ°£Ê°à");
    loadTarotHistory();
};

window.loadTarotHistory = function() {
    const list = document.getElementById('tarot-history-list'); list.innerHTML = '';
    const history = window.BIG_MEMORY.tarot_history || [];
    if(history.length === 0) { list.innerHTML = "<div style='padding:10px;text-align:center'>ÊöÇÊó†ËÆ∞ÂΩï</div>"; return; }
    history.forEach((h, i) => {
        const div = document.createElement('div'); div.className = 'morandi-card'; div.style.padding = '10px';
        div.innerHTML = `<div style="font-size:0.8rem; color:#888;">${new Date(h.date).toLocaleDateString()}</div><div style="font-weight:bold;">Q: ${h.question}</div><div style="font-size:0.75rem;">üé¥ ${h.cardsText}</div><div style="text-align:right;"><button class="m-btn small" onclick="viewHistoryDetail_BigDB(${i})">Êü•Áúã</button></div>`;
        list.appendChild(div);
    });
};
window.viewHistoryDetail_BigDB = function(index) {
    const h = (window.BIG_MEMORY.tarot_history || [])[index];
    if(!h) return;
    document.getElementById('tarot-desk-area').style.display = 'none';
    document.getElementById('tarot-result-area').style.display = 'flex';
    document.getElementById('divination-output').style.display = 'block';
    const htmlText = h.rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    document.getElementById('output-content').innerHTML = `<div class="divination-md">${htmlText}</div>`;
    document.getElementById('divine-question').value = h.question;
    const header = document.getElementById('selected-cards-header'); header.innerHTML = `<div style="padding:10px;">${h.cardsText}</div>`;
};
window.saveHisPhoneResult = function() {
    if(!hpCurrentResult) return;
    let list = window.BIG_MEMORY.his_phone_history || [];
    if(list.length>0 && list[0].date === hpCurrentResult.date) return alert("Â∑≤‰øùÂ≠ò");
    list.unshift(hpCurrentResult);
    if(list.length>20) list.pop();
    saveToBigDB('his_phone_history', list);
    alert("‚úÖ ËØÅÊçÆÂ∑≤‰øùÂ≠ò");
};
window.renderHisPhoneHistory = function() {
    const list = window.BIG_MEMORY.his_phone_history || [];
    const container = document.getElementById('hp-history-list'); container.innerHTML = '';
    list.forEach((item, index) => {
        const div = document.createElement('div'); div.className = 'morandi-card'; div.style.padding = '10px';
        div.innerHTML = `<div style="font-weight:bold;">${new Date(item.date).toLocaleString()}</div><div>üÉè ${item.cards}</div>`;
        div.onclick = () => { hpCurrentResult = item; renderHisPhoneOS(item); document.getElementById('hp-history-panel').classList.remove('open'); document.getElementById('hp-intro-view').style.display='none'; };
        container.appendChild(div);
    });
};
window.saveDreamResultToHistory = function() {
    if(!currentDreamResult) return alert("Êó†ÂÜÖÂÆπ");
    let list = window.BIG_MEMORY.dream_history || [];
    list.unshift(currentDreamResult);
    if(list.length>50) list.pop();
    saveToBigDB('dream_history', list);
    alert("‚úÖ Ê¢¶Â¢ÉÊä•ÂëäÂ∑≤‰øùÂ≠ò");
};
window.renderDreamHistory = function() {
    const list = window.BIG_MEMORY.dream_history || [];
    const container = document.getElementById('dream-history-list'); container.innerHTML = '';
    list.forEach((item) => {
        const div = document.createElement('div'); div.className = 'morandi-card'; div.style.padding='10px';
        div.innerHTML = `<div>${new Date(item.date).toLocaleString()}</div><div>üé¥ ${item.cards}</div>`;
        div.onclick = () => { 
            document.getElementById('dream-result-area').style.display = 'block';
            document.getElementById('dream-analysis-content').innerHTML = item.htmlContent;
            document.getElementById('dream-history-panel').classList.remove('open');
        };
        container.appendChild(div);
    });
};

// ==================== üì¶ Êê¨ÂÆ∂Êó•ËÆ∞ APP Ê†∏ÂøÉÈÄªËæë ====================

let movingDeck = [];
let movingFlipped = [];
let currentMovingSession = null; // ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑÊê¨ÂÆ∂‰ºöËØù
let currentItemIndex = 0; // ÂΩìÂâçÊü•ÁúãÁ¨¨Âá†‰∏™Áâ©ÂìÅ

function getMovingData() { 
    // 1. Â¶ÇÊûúÂ§ßÂÜÖÂ≠òÈáåÊ≤°ÊúâËøô‰∏™ÂØπË±°ÔºåÂàùÂßãÂåñÂÆÉ
    if (!window.BIG_MEMORY.moving_data) {
        window.BIG_MEMORY.moving_data = { history: [], current_session: null };
    }
    // 2. Â¶ÇÊûúÊúâÂØπË±°‰ΩÜÊ≤°Êúâ history Êï∞ÁªÑ (Èò≤Ê≠¢ÂéÜÂè≤ËÆ∞ÂΩïËØªÂèñÊä•Èîô)ÔºåË°•‰∏ä
    if (!Array.isArray(window.BIG_MEMORY.moving_data.history)) {
        window.BIG_MEMORY.moving_data.history = [];
    }
    return window.BIG_MEMORY.moving_data; 
}
function saveMovingData(data) {
    // 1. Êõ¥Êñ∞ÂÜÖÂ≠òÁä∂ÊÄÅ
    window.BIG_MEMORY.moving_data = data;
    
    // 2. Âº∫Âà∂ÂÜôÂÖ• IndexedDB (Êó†ÈôêÂ≠òÂÇ®)
    // ‰ºòÂÖàÂ∞ùËØïË∞ÉÁî®ÂÖ®Â±Ä‰øùÂ≠òÂáΩÊï∞
    if (typeof saveToBigDB === 'function') {
        saveToBigDB('moving_data', data);
    } 
    // ÂÖúÂ∫ïÔºöÁõ¥Êé•Ë∞ÉÁî®Êï∞ÊçÆÂ∫ìÊé•Âè£
    else if (typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'moving_data', data: data });
    }
}
// === üì¶ Êê¨ÂÆ∂Êó•ËÆ∞Âä†ËΩΩË°•‰∏Å ===
if (typeof loadAllBigData === 'function') {
    const _origLoadMoving = window.loadAllBigData;
    window.loadAllBigData = async function() {
        // ÂÖàËøêË°åÂéüÊúâÁöÑÂä†ËΩΩÈÄªËæë
        if (_origLoadMoving) await _origLoadMoving();
        
        // È¢ùÂ§ñÂº∫Âà∂ËØªÂèñ‰∏ÄÊ¨° moving_dataÔºåÁ°Æ‰øù‰∏áÊó†‰∏ÄÂ§±
        try {
            if (typeof idb !== 'undefined') {
                let res = await idb.get('universal_store', 'moving_data');
                if (res && res.data) {
                    window.BIG_MEMORY.moving_data = res.data;
                    console.log("üì¶ Êê¨ÂÆ∂Êó•ËÆ∞Êï∞ÊçÆÂ∑≤Âä†ËΩΩ");
                }
            }
        } catch(e) {
            console.log("Êê¨ÂÆ∂Êï∞ÊçÆÂä†ËΩΩË∑≥Ëøá");
        }
    };
}
// 2. ÊâìÂºÄ APP
window.openMovingApp = function() {
    document.getElementById('moving-app-modal').style.display = 'flex';
    const data = getMovingData();
    
    // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°åÁöÑ‰ºöËØùÔºåÊÅ¢Â§çÁé∞Âú∫
    if (data.current_session && !data.current_session.finished) {
        currentMovingSession = data.current_session;
        currentItemIndex = currentMovingSession.current_index || 0;
        switchMovingView('game');
        document.getElementById('moving-start-panel').style.display = 'none';
        document.getElementById('moving-play-panel').style.display = 'block';
        renderMovingItem();
    } else {
        switchMovingView('game');
        document.getElementById('moving-start-panel').style.display = 'block';
        document.getElementById('moving-play-panel').style.display = 'none';
    }
};

window.switchMovingView = function(view) {
    if (view === 'game') {
        document.getElementById('moving-game-view').style.display = 'block';
        document.getElementById('moving-history-view').style.display = 'none';
    } else {
        document.getElementById('moving-game-view').style.display = 'none';
        document.getElementById('moving-history-view').style.display = 'block';
        renderMovingHistory();
    }
};

// 3. ÂêØÂä®ÊäΩÁâå (Áã¨Á´ãÁâåÊ°å)
window.startMovingDraw = function() {
    const modal = document.getElementById('moving-card-table-modal');
    const area = document.getElementById('moving-card-area');
    
    // Â§çÁî®Ê°åÂ∏ÉÁöÆËÇ§
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) document.getElementById('moving-card-table-desk').style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    movingDeck = []; movingFlipped = [];
    document.getElementById('moving-flipped-count').innerText = '0';

    // ÁîüÊàêÂÆåÊï¥ÁâåÂ∫ì
    for(let i=0; i<=77; i++) movingDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) movingDeck.push({ type:'lenormand', id:i, isReversed:false });
    movingDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    movingDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                movingFlipped = movingFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                movingFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ if(res && res.data) front.style.backgroundImage=`url(${res.data})`; else {front.style.background="#fff"; front.innerText=card.id;} });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)"; else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('moving-flipped-count').innerText = movingFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};

// 4. API ÁîüÊàêÁâ©ÂìÅÂàóË°®
window.finishMovingDraw = async function() {
    if(movingFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#moving-card-table-modal .m-btn.primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üì¶ Ê≠£Âú®ÁøªÁÆ±ÂÄíÊüú...";

    // ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = movingFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Â∞èËØ¥ÂÆ∂„ÄÇÊÉÖÊôØÔºöËßíËâ≤ÂíåÁî®Êà∑Ê≠£Âú®„ÄêÊê¨ÂÆ∂„ÄëÔºåÊ≠£Âú®Êï¥ÁêÜÊóßÁâ©„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÂëΩËøêÁâå (ËÉΩÈáèÊåáÂºï)„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„Äë
ËØ∑ÁîüÊàê **3 Âà∞ 5 ‰∏™** ËßíËâ≤Âú®ËßíËêΩÈáåÁøªÂá∫Êù•ÁöÑÊóßÁâ©ÂìÅ„ÄÇ
Ëøô‰∫õÁâ©ÂìÅÂøÖÈ°ªÁ¨¶ÂêàËßíËâ≤ÁöÑËøáÂéªÂíåÊÄßÊ†ºÔºåÂπ∂‰∏îÁªìÂêàÁâåÊÑèÔºà‰æãÂ¶ÇÔºöÂú£ÊùØÁâåÂèØËÉΩÁøªÂá∫ÊóßÊÉÖ‰π¶ÊàñÁ§ºÁâ©ÔºåÂÆùÂâëÁâåÂèØËÉΩÁøªÂá∫ÊçüÂùèÁöÑÂ∑•ÂÖ∑ÊàñÂÜ∑ÂÜ∞ÂÜ∞ÁöÑÊñá‰ª∂Ôºâ„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Êï∞ÁªÑÔºö
[
  {
    "name": "Áâ©ÂìÅÂêçÁß∞",
    "description": "ÂØπÁâ©ÂìÅÂ§ñËßÇÂíåÁä∂ÊÄÅÁöÑÊèèÂÜôÔºà50Â≠óÂ∑¶Âè≥ÔºâÔºå‰ΩìÁé∞Âá∫Â≤ÅÊúàÁöÑÁóïËøπ„ÄÇ",
    "reaction_keep": "Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©„Äê‰øùÁïô„ÄëÔºåËßíËâ≤ÁöÑÂèçÂ∫îÂíåËØ¥ÁöÑËØùÔºà‰ΩìÁé∞ÂºÄÂøÉÊàñÊÄÄÂøµÔºâ„ÄÇ",
    "reaction_toss": "Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©„ÄêÊâîÊéâ„ÄëÔºåËßíËâ≤ÁöÑÂèçÂ∫îÂíåËØ¥ÁöÑËØùÔºà‰ΩìÁé∞‰∏çËàçÊàñÈáäÁÑ∂Ôºâ„ÄÇ"
  },
  ...
]
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON array only."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        if(raw.indexOf('[') !== -1) raw = raw.substring(raw.indexOf('['));
        if(raw.lastIndexOf(']') !== -1) raw = raw.substring(0, raw.lastIndexOf(']')+1);
        
        const items = JSON.parse(raw);

        // ÂàùÂßãÂåñÊñ∞‰ºöËØù
        const data = getMovingData();
        currentMovingSession = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            cards: cardsDesc,
            items: items,
            current_index: 0,
            finished: false
        };
        data.current_session = currentMovingSession;
        saveMovingData(data);

        // ËøõÂÖ•Ê∏∏ÊàèÁïåÈù¢
        document.getElementById('moving-card-table-modal').style.display = 'none';
        document.getElementById('moving-start-panel').style.display = 'none';
        document.getElementById('moving-play-panel').style.display = 'block';
        currentItemIndex = 0;
        renderMovingItem();

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};

// 5. Ê∏≤ÊüìÂΩìÂâçÁâ©ÂìÅÂç°Áâá
window.renderMovingItem = function() {
    if (!currentMovingSession || !currentMovingSession.items) return;
    
    // Ê£ÄÊü•ÊòØÂê¶ÁªìÊùü
    if (currentItemIndex >= currentMovingSession.items.length) {
        // ÁªìÊùü‰∫Ü
        document.getElementById('moving-item-card').innerHTML = `
            <div style="font-size:3rem;">üöõ</div>
            <h3>Êê¨ÂÆ∂Êï¥ÁêÜÂÆåÊàêÔºÅ</h3>
            <p style="color:#888;">ÊâÄÊúâÁöÑÊóßÁâ©ÈÉΩÂ∑≤Â¶•ÂñÑÂ§ÑÁêÜ„ÄÇ</p>
            <button class="m-btn small" onclick="endMovingSession()" style="margin-top:20px; background:#d35400; color:white;">üíæ Â≠òÊ°£Âπ∂ÁªìÊùü</button>
        `;
        document.getElementById('moving-action-btns').style.display = 'none';
        document.getElementById('moving-reaction-box').style.display = 'none';
        return;
    }

    const item = currentMovingSession.items[currentItemIndex];
    const cardEl = document.getElementById('moving-item-card');
    
    cardEl.innerHTML = `
        <div style="font-size:1.2rem; font-weight:bold; color:#d35400; margin-bottom:10px;">üì¶ Áâ©ÂìÅ ${currentItemIndex + 1}/${currentMovingSession.items.length}</div>
        <div style="font-size:1.5rem; font-weight:bold; margin-bottom:15px;">${item.name}</div>
        <div style="font-size:0.95rem; color:#5d4037; line-height:1.6; padding:0 20px;">${item.description}</div>
    `;

    // ÈáçÁΩÆ UI Áä∂ÊÄÅ
    document.getElementById('moving-action-btns').style.display = 'flex';
    document.getElementById('moving-reaction-box').style.display = 'none';
};

// 6. Â§ÑÁêÜÁî®Êà∑ÈÄâÊã© (‰øùÁïô/ÊâîÊéâ)
window.handleMovingChoice = function(choice) { // choice: 'keep' or 'toss'
    const item = currentMovingSession.items[currentItemIndex];
    
    // ËÆ∞ÂΩïÈÄâÊã©
    item.status = choice; // ËÆ∞ÂΩïÁä∂ÊÄÅÔºåÊñπ‰æøÂéÜÂè≤ÂõûÁúã
    
    // ÊòæÁ§∫ÂèçÂ∫î
    const reactionText = choice === 'keep' ? item.reaction_keep : item.reaction_toss;
    const reactionBox = document.getElementById('moving-reaction-box');
    const textBox = document.getElementById('moving-reaction-text');
    
    textBox.innerHTML = `
        <strong style="color:${choice==='keep'?'#2ecc71':'#e74c3c'}">
            ${choice==='keep' ? '‚úÖ ‰Ω†ÂÜ≥ÂÆöÁïô‰∏ãÂÆÉ„ÄÇ' : 'üëã ‰Ω†ÂÜ≥ÂÆöÊâîÊéâÂÆÉ„ÄÇ'}
        </strong><br><br>
        <span style="font-family:'Songti SC', serif; font-weight:bold;">TaÁöÑÂèçÂ∫îÔºö</span><br>
        ‚Äú${reactionText}‚Äù
    `;
    
    document.getElementById('moving-action-btns').style.display = 'none'; // ÈöêËóèÈÄâÊã©ÊåâÈíÆ
    reactionBox.style.display = 'block'; // ÊòæÁ§∫ÂèçÂ∫îÂíå‰∏ã‰∏ÄÊ≠•ÊåâÈíÆ
    
    // ÂÆûÊó∂‰øùÂ≠òËøõÂ∫¶
    const data = getMovingData();
    data.current_session.current_index = currentItemIndex; // ‰øùÊåÅÁ¥¢ÂºïÔºåÈò≤Ê≠¢Âà∑Êñ∞‰∏¢Â§±
    // data.current_session.items[currentItemIndex] Â∑≤ÁªèÂú®‰∏äÈù¢Ë¢´‰øÆÊîπÂºïÁî®‰∫Ü
    saveMovingData(data);
};

// 7. ‰∏ã‰∏Ä‰∏™Áâ©ÂìÅ
window.nextMovingItem = function() {
    currentItemIndex++;
    // Êõ¥Êñ∞ËøõÂ∫¶Âπ∂‰øùÂ≠ò
    const data = getMovingData();
    data.current_session.current_index = currentItemIndex;
    saveMovingData(data);
    
    renderMovingItem();
};

// 8. ÁªìÊùü‰ºöËØùÂπ∂Â≠òÊ°£
window.endMovingSession = function() {
    const data = getMovingData();
    if (currentMovingSession) {
        currentMovingSession.finished = true;
        currentMovingSession.current_index = 0; // ÈáçÁΩÆÁ¥¢ÂºïÔºåÊñπ‰æøÂõûÈ°æ
        
        // Â≠òÂÖ•ÂéÜÂè≤Êï∞ÁªÑ
        data.history.unshift(currentMovingSession);
        
        // Ê∏ÖÁ©∫ÂΩìÂâç‰ºöËØù
        data.current_session = null;
        saveMovingData(data);
    }
    
    currentMovingSession = null;
    switchMovingView('history');
};

// 9. Ê∏≤ÊüìÂéÜÂè≤ÂàóË°® & ÂéÜÂè≤ÂõûÁúãÂäüËÉΩ
window.renderMovingHistory = function() {
    const data = getMovingData();
    const list = document.getElementById('moving-history-list');
    list.innerHTML = '';
    
    if (data.history.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†Êê¨ÂÆ∂ËÆ∞ÂΩï</div>';
        return;
    }

    data.history.forEach((session, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '15px'; div.style.marginBottom = '10px';
        
        // ÁªüËÆ°‰øùÁïôÂíå‰∏¢ÂºÉ
        let keepCount = session.items.filter(i=>i.status==='keep').length;
        let tossCount = session.items.filter(i=>i.status==='toss').length;
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">
                <span>${session.date}</span>
                <span style="color:red; cursor:pointer;" onclick="deleteMovingHistory(${index})">Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; color:#d35400;">üì¶ Êê¨ÂÆ∂Êï¥ÁêÜ (${session.items.length}‰ª∂Áâ©ÂìÅ)</div>
            <div style="font-size:0.8rem; color:#5d4037; margin-top:5px;">
                ‰øùÁïô: ${keepCount} / ‰∏¢ÂºÉ: ${tossCount}
            </div>
            <button class="m-btn small" onclick="reviewMovingSession(${index})" style="width:100%; margin-top:10px; background:#fae5d3; color:#d35400;">üîÑ ÂõûÈ°æ / ÈáçÊñ∞Êï¥ÁêÜ</button>
        `;
        list.appendChild(div);
    });
};

window.deleteMovingHistory = function(index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const data = getMovingData();
    data.history.splice(index, 1);
    saveMovingData(data);
    renderMovingHistory();
};

// ÂéÜÂè≤ÂõûÁúãÈÄªËæëÔºöÂ∞ÜÂéÜÂè≤ËÆ∞ÂΩï‰∏¥Êó∂Âä†ËΩΩ‰∏∫‚ÄúÂΩìÂâçÊ∏∏Êàè‚ÄùÔºåÂÖÅËÆ∏Áî®Êà∑ÈáçÊñ∞ÈÄâÊã©
window.reviewMovingSession = function(index) {
    const data = getMovingData();
    const session = data.history[index];
    
    // Ê∑±Êã∑Ë¥ù‰∏Ä‰ªΩÔºåÈò≤Ê≠¢Áõ¥Êé•‰øÆÊîπÂéÜÂè≤ÔºàÊàñËÄÖ‰Ω†ÂèØ‰ª•ËÆæËÆ°‰∏∫‰øÆÊîπÂéÜÂè≤ÔºåËøôÈáåÈÄâÊã©ÂÖÅËÆ∏‰øÆÊîπÂéÜÂè≤Ôºâ
    // ‰∏∫‰∫ÜÂÆûÁé∞‚Äú‰∏äÊ¨°ÈÄâÊâîÁöÑËØùËøôÊ¨°ÂõûÈ°æ‰πüËøòÊòØÂèØ‰ª•ÈÄâÊã©ÊâîÊàñËÄÖ‰∏çÊâî‚ÄùÔºåÊàë‰ª¨Áõ¥Êé•ÊääËøô‰∏™ session ËÆæ‰∏∫ active
    // Âπ∂ÈáçÁΩÆÂÆÉÁöÑÁ¥¢ÂºïÂà∞ 0
    
    currentMovingSession = session; // ÂºïÁî®Âêå‰∏Ä‰∏™ÂØπË±°Ôºå‰øÆÊîπ‰ºöÂêåÊ≠•
    currentItemIndex = 0;
    
    // ÂàáÊç¢ËßÜÂõæ
    switchMovingView('game');
    document.getElementById('moving-start-panel').style.display = 'none';
    document.getElementById('moving-play-panel').style.display = 'block';
    
    // Â¶ÇÊûúÊÉ≥ËÆ©Áî®Êà∑ÈáçÊñ∞ÈÄâÔºåÊàë‰ª¨‰∏çÂ∫îËØ•È¢ÑÂÖàÊòæÁ§∫ÁªìÊûúÔºåËÄåÊòØÂÉèÊñ∞Ê∏∏Êàè‰∏ÄÊ†∑ renderItem
    renderMovingItem();
    
    alert("Â∑≤Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ‰Ω†ÂèØ‰ª•ÈáçÊñ∞ËøõË°åÈÄâÊã©ÔºÅ\n(ËøõÂ∫¶Â∞ÜËá™Âä®Êõ¥Êñ∞Âà∞ËØ•Êù°ÂéÜÂè≤‰∏≠)");
};
// ==================== üå∏ È¶ôÁâá (Scent) APP Ê†∏ÂøÉÈÄªËæë ====================

let scentDeck = [];
let scentFlipped = [];
let currentScentSession = null; // ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑËøôÁªÑÈ¶ôÊ∞¥ÔºàÂåÖÂê´12‰∏™Ôºâ

// 1. ÂàùÂßãÂåñÊó†ÈôêÂ≠òÂÇ®ÁªìÊûÑ
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
if (!window.BIG_MEMORY.scent_data) window.BIG_MEMORY.scent_data = []; // ÂéÜÂè≤Êï∞ÁªÑ

function getScentData() { return window.BIG_MEMORY.scent_data || []; }

function saveScentData(list) {
    window.BIG_MEMORY.scent_data = list;
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'scent_data', data: list });
}

// 2. ÊâìÂºÄ APP
window.openScentApp = function() {
    document.getElementById('scent-app-modal').style.display = 'flex';
    switchScentView('collection');
};

window.switchScentView = function(mode) {
    const colEl = document.getElementById('scent-collection-view');
    const histEl = document.getElementById('scent-history-view');
    const btnCol = document.getElementById('btn-scent-col');
    const btnHist = document.getElementById('btn-scent-hist');

    if (mode === 'collection') {
        colEl.style.display = 'block';
        histEl.style.display = 'none';
        btnCol.style.background = '#d4a5a5'; btnCol.style.color = '#fff';
        btnHist.style.background = '#eee'; btnHist.style.color = '#555';
    } else {
        colEl.style.display = 'none';
        histEl.style.display = 'block';
        btnCol.style.background = '#eee'; btnCol.style.color = '#555';
        btnHist.style.background = '#d4a5a5'; btnHist.style.color = '#fff';
        renderScentHistory();
    }
};

// 3. ÂêØÂä®ÊäΩÁâå
window.startScentDraw = function() {
    const modal = document.getElementById('scent-card-table-modal');
    const area = document.getElementById('scent-card-area');
    const desk = document.getElementById('scent-card-table-desk');

    // Â§çÁî®ÁæéÂåñËÉåÊôØ
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    scentDeck = []; scentFlipped = [];
    document.getElementById('scent-flipped-count').innerText = '0';

    // ÁîüÊàê114Âº†Áâå
    for(let i=0; i<=77; i++) scentDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) scentDeck.push({ type:'lenormand', id:i, isReversed:false });
    scentDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    scentDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                scentFlipped = scentFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                scentFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) front.style.backgroundImage=`url(${res.data})`;
                    else { front.style.background="#fff"; front.innerText=card.id; }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('scent-flipped-count').innerText = scentFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};

// 4. API ÁîüÊàê 12 ‰∏™È¶ôÁâá
window.finishScentDraw = async function() {
    if(scentFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#scent-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üå¨Ô∏è Ê≠£Âú®Ë∞ÉÈ¶ô (Á∫¶20Áßí)...";

    // Êï∞ÊçÆÂáÜÂ§á
    const cardsDesc = scentFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÈ°∂Á∫ßË∞ÉÈ¶ôÂ∏àÔºåÂêåÊó∂‰πüÊòØ‰∏Ä‰ΩçÊ¥ûÂØüËÆ∞ÂøÜÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„ÄêËßíËâ≤/‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÊäΩÂà∞ÁöÑÂëΩËøêÁâå (ËÉΩÈáèÂü∫Ë∞É)„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„Äë
ËØ∑‰∏∫„ÄêÂêå‰∏Ä‰∏™ËßíËâ≤„ÄëÁîüÊàê **12 ÊîØ‰∏çÂêåÁöÑÈ¶ôÊ∞¥**ÔºàÈ¶ôÁâáÔºâÔºå‰ª£Ë°® Ta Âú®‰∏çÂêåÊó∂Êúü„ÄÅ‰∏çÂêåÂøÉÂ¢É„ÄÅÊàñ‰∏çÂêåÂπ≥Ë°å‰∏ñÁïåÁ∫ø‰ºö‰ΩøÁî®ÁöÑÈ¶ô„ÄÇ
ÂøÖÈ°ªÁªìÂêà„ÄêÂëΩËøêÁâå„ÄëÁöÑËÉΩÈáèÔºà‰æãÂ¶ÇÁâåÊÑèÊÇ≤‰º§ÂàôÁîüÊàêÂÜ∑ÂÜΩËã¶Ê∂©ÁöÑÈ¶ôÔºåÁâåÊÑèÁÉ≠ÁÉàÂàôÁîüÊàêÊµìÈÉÅËæõËæ£ÁöÑÈ¶ôÔºâ„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
**‰∏•Ê†ºËæìÂá∫ JSON Êï∞ÁªÑ**ÔºåÂåÖÂê´ 12 ‰∏™ÂØπË±°„ÄÇÊØè‰∏™ÂØπË±°ÂåÖÂê´Ôºö
1. "name": È¶ôÊ∞¥ÂêçÁß∞ (ÂÖÖÊª°ÊÑèÂ¢É)„ÄÇ
2. "notes": È¶ôË∞ÉÊèèËø∞ (Ââç/‰∏≠/ÂêéË∞É)„ÄÇ
3. "review": Ê∞îÂë≥ËØÑ‰ª∑ (1Âè•ËØùÔºå‰∏∫‰ªÄ‰πàËøôÊîØÈ¶ôÈÄÇÂêàËßíËâ≤ÔºåÁªìÂêàÁâåÊÑè)„ÄÇ
4. "story": ‰∏Ä‰∏™ 50-80 Â≠óÁöÑÂæÆÂûãÊïÖ‰∫ã/ËÆ∞ÂøÜÁâáÊÆµ„ÄÇÊèèËø∞ËßíËâ≤Âú®‰ªÄ‰πàÂú∫ÊôØ‰∏ãÁî®‰∫ÜËøôÊîØÈ¶ôÔºåÊàñËÄÖÊòØËøôÊîØÈ¶ôÂî§Ëµ∑‰∫ÜTaÁöÑ‰ªÄ‰πàËÆ∞ÂøÜ„ÄÇ

Á§∫‰æã JSON ÁªìÊûÑÔºö
[
  { "name": "...", "notes": "...", "review": "...", "story": "..." },
  ... (ÂÖ±12‰∏™)
]
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON array only."}, {role:"user", content:prompt}],
                temperature: 0.85,
                max_tokens: 3000 // Á°Æ‰øùË∂≥Â§üÈïø
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const start = raw.indexOf('['); const end = raw.lastIndexOf(']');
        if(start!==-1 && end!==-1) raw = raw.substring(start, end+1);
        
        const items = JSON.parse(raw);
        
        // ÁîüÊàê Session Êï∞ÊçÆ
        currentScentSession = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            cards: cardsDesc,
            chips: items.map(item => ({ ...item, revealed: false })) // ÂàùÂßãÊú™ÁøªÂºÄ
        };

        // ÂÖ≥Èó≠ÁâåÊ°åÔºåÊòæÁ§∫ÁΩëÊ†º
        document.getElementById('scent-card-table-modal').style.display = 'none';
        renderScentGrid();

        // Ëá™Âä®‰øùÂ≠òÂà∞ÂéÜÂè≤ (È¢òÁõÆË¶ÅÊ±ÇÂéÜÂè≤ÂõûÈ°æÔºåËøôÈáåÁîüÊàêÂÆåÁõ¥Êé•Â≠òÊØîËæÉÂÆâÂÖ®)
        const list = getScentData();
        list.unshift(currentScentSession);
        saveScentData(list);

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};

// 5. Ê∏≤Êüì 12 ÂÆ´Ê†º
window.renderScentGrid = function() {
    if(!currentScentSession) return;

    document.getElementById('scent-empty-state').style.display = 'none';
    const grid = document.getElementById('scent-grid');
    grid.style.display = 'grid';
    grid.innerHTML = '';

    currentScentSession.chips.forEach((chip, index) => {
        const div = document.createElement('div');
        // Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆÊ†∑Âºè
        div.className = `scent-chip ${chip.revealed ? 'revealed' : 'closed'}`;
        div.dataset.index = index + 1; // Áî®‰∫éÊòæÁ§∫ No.1 ~ No.12

        if (chip.revealed) {
            // Â∑≤ÁøªÂºÄÊòæÁ§∫ÂÜÖÂÆπ
            div.innerHTML = `
                <div class="scent-icon">üß¥</div>
                <div class="scent-name-mini">${chip.name}</div>
            `;
        } else {
            // Êú™ÁøªÂºÄÊòæÁ§∫ËÉåÈù¢ (CSSÂ§ÑÁêÜ)
            div.innerHTML = '';
        }

        div.onclick = () => openScentDetail(index);
        grid.appendChild(div);
    });
    
    // ÊòæÁ§∫Â∫ïÈÉ®ÊèêÁ§∫
    document.getElementById('scent-save-btn-area').style.display = 'block';
    document.getElementById('scent-save-btn-area').innerHTML = `<span style="font-size:0.8rem; color:#888;">Â∑≤Ëá™Âä®‰øùÂ≠òËá≥ÂéÜÂè≤ËÆ∞ÂΩï</span>`;
};

// 6. ÊâìÂºÄËØ¶ÊÉÖ (ÁøªÂºÄÂä®‰Ωú)
window.openScentDetail = function(index) {
    const chip = currentScentSession.chips[index];
    
    // Ê†áËÆ∞‰∏∫Â∑≤ÁøªÂºÄ
    if(!chip.revealed) {
        chip.revealed = true;
        // Êõ¥Êñ∞ÂÜÖÂ≠òÂíåÊï∞ÊçÆÂ∫ì
        const list = getScentData();
        // ÊâæÂà∞ÂΩìÂâç session Êõ¥Êñ∞ÂÆÉ (Â¶ÇÊûúÊòØÊñ∞ÁîüÊàêÁöÑÔºåÂÆÉÂú®Á¨¨0‰ΩçÔºõÂ¶ÇÊûúÊòØÂéÜÂè≤ÂõûÈ°æÔºåÊàë‰ª¨Ë¶ÅÁ°Æ‰øùÂºïÁî®Ê≠£Á°Æ)
        // ÁÆÄÂçïËµ∑ËßÅÔºåÊàë‰ª¨ÂÅáËÆæ currentScentSession ÊòØÂºïÁî®Ôºå‰øÆÊîπÂÆÉÂêéÈáçÊñ∞ save Êï¥‰∏™ list Âç≥ÂèØ
        // ‰ΩÜ‰∏∫‰∫Ü‰∏•Ë∞®ÔºåÊàë‰ª¨ÈáçÊñ∞ find
        const targetSession = list.find(s => s.id === currentScentSession.id);
        if(targetSession) {
            targetSession.chips[index].revealed = true;
            saveScentData(list);
        }
        renderScentGrid(); // Âà∑Êñ∞ÁΩëÊ†ºÁä∂ÊÄÅ
    }

    // Â°´ÂÖÖÂºπÁ™óÂÜÖÂÆπ
    document.getElementById('sd-name').innerText = chip.name;
    document.getElementById('sd-notes').innerText = chip.notes;
    document.getElementById('sd-review').innerText = chip.review;
    document.getElementById('sd-story').innerHTML = chip.story.replace(/\n/g, '<br>');
    
    document.getElementById('scent-detail-modal').style.display = 'flex';
};

// 7. Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
window.renderScentHistory = function() {
    const list = getScentData();
    const container = document.getElementById('scent-history-list');
    container.innerHTML = '';

    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ÂéÜÂè≤</div>';
        return;
    }

    list.forEach((session, index) => {
        const div = document.createElement('div');
        div.className = 'scent-history-card';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold; color:#5d4037;">üìÖ ${session.date}</span>
                <span style="color:#d32f2f; cursor:pointer;" onclick="deleteScentHistory(${index})">üóëÔ∏è Âà†Èô§</span>
            </div>
            <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">üîÆ ÁâåÊÑè: ${session.cards}</div>
            <button class="m-btn small" onclick="loadScentSession(${index})" style="width:100%; background:#efebe9; color:#5d4037;">
                üîç Êü•ÁúãËøôÁªÑÈ¶ôÊ∞î (12Êûö)
            </button>
        `;
        container.appendChild(div);
    });
};

// 8. Âä†ËΩΩÂéÜÂè≤‰ºöËØù
window.loadScentSession = function(index) {
    const list = getScentData();
    currentScentSession = list[index];
    switchScentView('collection');
    renderScentGrid();
};

// 9. Âà†Èô§ÂéÜÂè≤
window.deleteScentHistory = function(index) {
    if(!confirm("Á°ÆÂÆöË¶ÅÈîÄÊØÅËøôÁªÑÊ∞îÂë≥ËÆ∞ÂøÜÂêóÔºü")) return;
    const list = getScentData();
    
    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊ≠£Âú®ÁúãÁöÑÔºåÊ∏ÖÁ©∫ÂΩìÂâçËßÜÂõæ
    if(currentScentSession && list[index].id === currentScentSession.id) {
        currentScentSession = null;
        document.getElementById('scent-grid').style.display = 'none';
        document.getElementById('scent-empty-state').style.display = 'block';
        document.getElementById('scent-save-btn-area').style.display = 'none';
    }

    list.splice(index, 1);
    saveScentData(list);
    renderScentHistory();
};

// üî¥ ÂÖ≥ÈîÆÔºöÊ≥®ÂÜåÂà∞Êó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÂô®
if (typeof loadAllBigData === 'function') {
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad(); 
        try {
            let res = await idb.get('universal_store', 'scent_data');
            if(res) window.BIG_MEMORY.scent_data = res.data;
        } catch(e){}
    }
}
// ==================== üé¥ ‰πôÂ•≥ÊäΩÂç°Á≥ªÁªüÊ†∏ÂøÉÈÄªËæë ====================

// ËµÑÊ∫êÈÖçÁΩÆ
const GACHA_ASSETS = {
    back: {
        r: 'https://i.postimg.cc/VkP49Q5s/IMG_1816.png',
        sr: 'https://i.postimg.cc/qvHQcVgM/IMG_1817.png',
        ssr: 'https://i.postimg.cc/Z5zjPt0J/IMG_1818.png',
        ur: 'https://i.postimg.cc/MpJt02Xq/IMG_1819.png'
    },
    frame: {
        r: 'https://i.postimg.cc/SxbVLFjC/IMG_1812.png',
        sr: 'https://i.postimg.cc/FHXGb51c/IMG_1813.png',
        ssr: 'https://i.postimg.cc/y8Cnh4WR/IMG_1814.png',
        ur: 'https://i.postimg.cc/Hk130Djc/IMG_1815.png'
    },
    // Ê¶ÇÁéáÈÖçÁΩÆ
    probs: { ur: 0.0005, ssr: 0.01, sr: 0.10 } // Ââ©‰∏ãÊòØ R
};
// 1. Êï∞ÊçÆÁÆ°ÁêÜ (‰øÆÂ§çÁâàÔºöËá™Âä®Á∫†ÈîôÔºåÈò≤Ê≠¢Âç°Ê≠ª)
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};

// üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöËé∑ÂèñÊï∞ÊçÆÊó∂Â¶ÇÊûúÂèëÁé∞Ê†ºÂºèÈîôËØØ(‰æãÂ¶ÇÊòØÁ©∫Êï∞ÁªÑ)ÔºåÁ´ãÂàªËá™Âä®ÈáçÁΩÆ‰∏∫Ê≠£Á°ÆÂØπË±°
window.getGachaData = function() { 
    let data = window.BIG_MEMORY.gacha_data;
    
    // Â¶ÇÊûúÊï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÊàñËÄÖË¢´ÈîôËØØÂàùÂßãÂåñÊàê‰∫ÜÊï∞ÁªÑ []
    if (!data || Array.isArray(data) || typeof data !== 'object') {
        console.warn("‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊäΩÂç°Êï∞ÊçÆÁªìÊûÑÂºÇÂ∏∏ÔºåÊ≠£Âú®Ëá™Âä®‰øÆÂ§ç...");
        data = {
            tickets: 1, // üéÅ ‰øÆÂ§çË°•ÂÅøÔºöÈáçÁΩÆÊó∂ÈÄÅ1Âº†Âà∏ÔºåÈò≤Ê≠¢‰Ω†Ê≤°Ê≥ïÊµãËØï
            msg_count: 0,
            history: [],
            custom_fronts: {} 
        };
        // Á´ãÂç≥‰øÆÂ§çÂÜÖÂ≠ò
        window.BIG_MEMORY.gacha_data = data;
    }
    
    // ‰∫åÊ¨°Ê£ÄÊü•ÂÜÖÈÉ®ÂÖ≥ÈîÆÂ≠óÊÆµÔºåÈò≤Ê≠¢ËØªÂèñ undefined Êä•Èîô
    if (!data.custom_fronts) data.custom_fronts = {};
    if (typeof data.tickets !== 'number') data.tickets = 0;
    if (!Array.isArray(data.history)) data.history = [];
    
    return data; 
};

window.saveGachaData = function(data) {
    window.BIG_MEMORY.gacha_data = data;
    if (typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'gacha_data', data: data });
    }
};

// 2. ËÅäÂ§©Èí©Â≠ê (Hook Chat)
// ‚ö†Ô∏è ËØ∑Á°Æ‰øùËøôÊÆµ‰ª£Á†ÅÊâßË°åÂú®ÂéüÊúâÁöÑ window.appendMessage ÂÆö‰πâ‰πãÂêé
const _originalAppendMsgForGacha = window.appendMessage;
window.appendMessage = function(content, isMe, type, quote) {
    // ÊâßË°åÂéüÊúâÁöÑÈÄªËæë (ÂåÖÊã¨ÂÆ†Áâ©ÁßØÂàÜÈí©Â≠êÁ≠â)
    if (_originalAppendMsgForGacha) _originalAppendMsgForGacha(content, isMe, type, quote);

    // Âè™ÊúâËá™Â∑±ÂèëÁöÑÊ∂àÊÅØÊâçÁÆó
    if (isMe) {
        const data = getGachaData();
        data.msg_count = (data.msg_count || 0) + 1;
        
        // ÊØè 80 Êù° +1 Âà∏
        if (data.msg_count >= 80) {
            data.msg_count = 0;
            data.tickets = (data.tickets || 0) + 1;
            
            // ÈÄöÁü•
            if (typeof NotificationManager !== 'undefined') {
                NotificationManager.send({ 
                    title: "üé¥ Ëé∑ÂæóÊäΩÂç°Âà∏", 
                    body: "Ê∂àÊÅØÁßØÁ¥ØËææÊàêÔºÅËé∑Âæó 1 Ê¨°ÂëΩËøêÂè¨Âî§Êú∫‰ºö„ÄÇ", 
                    icon: "üéüÔ∏è" 
                });
            }
        }
        saveGachaData(data);
    }
};

// 3. ÊâìÂºÄ/ÂÖ≥Èó≠ App
window.openGachaCardApp = function() {
    document.getElementById('gacha-card-modal').style.display = 'flex';
    updateGachaUI();
};

window.closeGachaCardApp = function() {
    document.getElementById('gacha-card-modal').style.display = 'none';
};
window.updateGachaUI = function() {
    const data = getGachaData();
    // ‰øÆÂ§çÔºöÁ°Æ‰øùÊï∞ÊçÆÂ≠òÂú®
    if(!data.tickets) data.tickets = 0;
    if(!data.msg_count) data.msg_count = 0;
    
    document.getElementById('gacha-ticket-count').innerText = data.tickets;
    document.getElementById('gacha-next-msg').innerText = 80 - data.msg_count;
    
    // Ê∏≤ÊüìÂéÜÂè≤ (ÊòæÁ§∫ÊâÄÊúâËÆ∞ÂΩïÔºå‰∏ç‰ªÖÊòØÁ®ÄÊúâÂç°)
    const list = document.getElementById('gacha-history-list');
    list.innerHTML = '';
    
    const history = data.history || [];
    
    if (history.length === 0) {
        list.innerHTML = "<div style='text-align:center; padding:10px;'>ÊöÇÊó†ËÆ∞ÂΩï</div>";
    } else {
        history.forEach(h => {
            const date = new Date(h.date).toLocaleDateString();
            
            // È¢úËâ≤ÂÆö‰πâ
            let color = '#999'; // RÂç°ÈªòËÆ§ÁÅ∞
            if(h.rarity === 'SR') color = '#74b9ff';
            if(h.rarity === 'SSR') color = '#fdcb6e';
            if(h.rarity === 'UR') color = '#d63031';
            
            // ÊòæÁ§∫ÂÖ∑‰ΩìÁöÑÂ•ñÂìÅÂêçÁß∞
            const prizeText = h.prize ? `(${h.prize})` : '';
            
            list.innerHTML += `
                <div style="margin-bottom:4px; font-size:0.8rem; border-bottom:1px dashed #eee; padding-bottom:2px;">
                    <span style="color:#aaa;">[${date}]</span> 
                    <span style="color:${color};font-weight:bold;">${h.rarity}</span>
                    <span style="color:#555;">${prizeText}</span>
                </div>`;
        });
    }
};
// 4. ÊäΩÂç°Ê†∏ÂøÉÈÄªËæë (‰øÆÂ§çÁâàÔºöÈò≤Âç°Ê≠ª + Êï∞ÊçÆËá™Âä®Ë°•ÂÖ®)
let currentPullResults = [];

window.doGachaDraw = function(count) {
    try {
        const data = getGachaData();
        
        // Ê£ÄÊü•Âà∏
        let cost = count;
        if (count === 10) cost = 9; // Âõ§9Ê¨°ÂèØ‰ª•10Ëøû (‰ºòÊÉ†)
        
        if ((data.tickets || 0) < cost) {
            return alert(`Âà∏‰∏çË∂≥ÔºÅÈúÄË¶Å ${cost} Âº†ÔºåÂΩìÂâçÂè™Êúâ ${data.tickets || 0} Âº†„ÄÇ`);
        }
        
        data.tickets -= cost;
        
        // ËÆ°ÁÆóÁªìÊûú
        currentPullResults = [];
        let hasSR = false;
        
        for (let i = 0; i < count; i++) {
            const rand = Math.random();
            let rarity = 'R';
            
            if (rand < GACHA_ASSETS.probs.ur) rarity = 'UR';
            else if (rand < (GACHA_ASSETS.probs.ur + GACHA_ASSETS.probs.ssr)) rarity = 'SSR';
            else if (rand < (GACHA_ASSETS.probs.ur + GACHA_ASSETS.probs.ssr + GACHA_ASSETS.probs.sr)) rarity = 'SR';
            
            if (rarity === 'SR' || rarity === 'SSR' || rarity === 'UR') hasSR = true;
            currentPullResults.push(rarity);
        }
        
        // ÂçÅËøû‰øùÂ∫ïÈÄªËæë (Â¶ÇÊûúÂÖ®ÊòØRÔºåÂº∫Âà∂ÊääÊúÄÂêé‰∏Ä‰∏™ÊîπÊàêSR)
        if (count === 10 && !hasSR) {
            currentPullResults[9] = 'SR';
        }
        
        saveGachaData(data); // ÂÖàÊâ£Ë¥π‰øùÂ≠ò
        
        // ÂºÄÂßãÊí≠ÊîæÂä®Áîª
        playGachaAnimation();
    } catch (e) {
        console.error("Draw Error:", e);
        alert("ÊäΩÂç°ÂêØÂä®Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï„ÄÇ");
    }
};

// 5. Âä®Áîª‰∏éÂ±ïÁ§∫ (‰øÆÂ§çÁâà)
window.playGachaAnimation = function() {
    const overlay = document.getElementById('gacha-animation-overlay');
    const container = document.getElementById('gacha-card-container');
    const closeBtn = document.getElementById('gacha-close-btn');
    
    if(!container || !overlay) return;

    overlay.style.display = 'flex';
    container.innerHTML = '';
    closeBtn.style.opacity = '0'; // ÂÖàÈöêËóèÂÖ≥Èó≠ÊåâÈíÆ
    closeBtn.style.pointerEvents = 'none'; 
    
    // ÁîüÊàêÂç°Áâá DOM
    currentPullResults.forEach((rarity, index) => {
        const card = document.createElement('div');
        card.className = 'gacha-card-wrapper';
        
        // Ëé∑ÂèñËÉåÊôØÂõæ (Ê†πÊçÆÁ®ÄÊúâÂ∫¶)
        const backImg = GACHA_ASSETS.back[rarity.toLowerCase()] || GACHA_ASSETS.back['r'];
        const frameImg = GACHA_ASSETS.frame[rarity.toLowerCase()] || GACHA_ASSETS.frame['r'];
        
        // Ëé∑ÂèñÂç°Èù¢ (Áî®Êà∑Ëá™ÂÆö‰πâÊàñÈªòËÆ§È¢úËâ≤)
        const data = getGachaData();
        const customImg = data.custom_fronts && data.custom_fronts[rarity.toLowerCase()];
        
        // Ê≠£Èù¢Ê†∑Âºè
        let frontContent = '';
        if (customImg) {
            frontContent = `<img src="${customImg}" class="gacha-front-img">`;
        } else {
            // ÈªòËÆ§ÊòæÁ§∫ÊñáÂ≠ó
            const colorMap = { 'ur':'#ff7675', 'ssr':'#fdcb6e', 'sr':'#74b9ff', 'r':'#dfe6e9' };
            frontContent = `<div style="font-size:2rem; font-weight:bold; color:${colorMap[rarity.toLowerCase()] || '#999'};">${rarity}</div>`;
        }

        card.innerHTML = `
            <div class="gacha-face gacha-back" style="background-image: url('${backImg}');"></div>
            <div class="gacha-face gacha-front">
                ${frontContent}
                <div class="gacha-frame" style="background-image: url('${frameImg}');"></div>
                <div class="gacha-shine"></div>
            </div>
        `;
        
        // ÁÇπÂáªÁøªÁâå
        card.onclick = () => flipGachaCard(card, rarity, index);
        
        container.appendChild(card);
        
        // ‰æùÊ¨°È£ûÂÖ•Âä®Áîª
        setTimeout(() => {
            card.classList.add('visible');
        }, index * 100);
    });
    
    // ÈáçÁΩÆËá™Âä®ÂºÄÂêØÁä∂ÊÄÅ
    container.dataset.allOpened = "false";
};

window.flipGachaCard = function(el, rarity, index) {
    if (el.classList.contains('flipped')) return;
    
    try {
        const container = document.getElementById('gacha-card-container');
        
        // ÁøªËΩ¨ÂΩìÂâçÂº†
        el.classList.add('flipped');
        
        // Ëé∑ÂèñÂÖ∑‰ΩìÂ•ñÂìÅÂπ∂ÊòæÁ§∫Âú®Âç°Èù¢‰∏ä (Âä†‰∫ÜÈò≤Â¥©Ê∫É‰øùÊä§)
        const prizeName = processReward(rarity); 
        
        // Âú®Âç°ÁâáÊ≠£Èù¢Ê∑ªÂä†ÊñáÂ≠óÊòæÁ§∫
        const front = el.querySelector('.gacha-front');
        if(front) {
            const textDiv = document.createElement('div');
            textDiv.innerText = prizeName;
            textDiv.style.cssText = "position:absolute; bottom:15px; left:0; width:100%; text-align:center; background:rgba(255,255,255,0.85); color:#333; font-size:0.8rem; padding:3px 0; font-weight:bold; z-index:10; border-top:1px solid #eee; border-bottom:1px solid #eee;";
            front.appendChild(textDiv);
        }
        
        // ÂçÅËøûÊäΩËá™Âä®ÁøªÂºÄÈÄªËæë
        if (currentPullResults.length > 1 && container.dataset.allOpened === "false") {
            container.dataset.allOpened = "true";
            const allCards = container.querySelectorAll('.gacha-card-wrapper');
            
            allCards.forEach((card, i) => {
                if (i === index) return; 
                setTimeout(() => {
                    if (!card.classList.contains('flipped')) {
                        card.classList.add('flipped');
                        const autoPrize = processReward(currentPullResults[i]);
                        const autoFront = card.querySelector('.gacha-front');
                        if(autoFront) {
                            const autoDiv = document.createElement('div');
                            autoDiv.innerText = autoPrize;
                            autoDiv.style.cssText = "position:absolute; bottom:15px; left:0; width:100%; text-align:center; background:rgba(255,255,255,0.85); color:#333; font-size:0.8rem; padding:3px 0; font-weight:bold; z-index:10; border-top:1px solid #eee; border-bottom:1px solid #eee;";
                            autoFront.appendChild(autoDiv);
                        }
                    }
                }, (i + 1) * 200); 
            });
            
            // ÊòæÁ§∫ÂÖ≥Èó≠ÊåâÈíÆ (Âª∂Ëøü‰∏ÄÁÇπ)
            setTimeout(() => {
                const closeBtn = document.getElementById('gacha-close-btn');
                closeBtn.style.opacity = '1';
                closeBtn.style.pointerEvents = 'auto';
            }, allCards.length * 200 + 500);
        } else {
            // ÂçïÊäΩÔºöÁõ¥Êé•ÊòæÁ§∫ÂÖ≥Èó≠ÊåâÈíÆ
            if (currentPullResults.length === 1) {
                const closeBtn = document.getElementById('gacha-close-btn');
                closeBtn.style.opacity = '1';
                closeBtn.style.pointerEvents = 'auto';
            }
        }
    } catch (e) {
        console.error("Flip Error:", e);
        // Âá∫ÈîôÂÖúÂ∫ïÔºöÂº∫Âà∂ÊòæÁ§∫ÂÖ≥Èó≠ÊåâÈíÆÔºåÈò≤Ê≠¢Âç°Ê≠ª
        const closeBtn = document.getElementById('gacha-close-btn');
        if(closeBtn) {
            closeBtn.style.opacity = '1';
            closeBtn.style.pointerEvents = 'auto';
        }
    }
};

window.processReward = function(rarity) {
    try {
        const data = getGachaData();
        
        // üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÂÆâÂÖ®Ëé∑Âèñ/ÂàùÂßãÂåñÂÆ†Áâ©Êï∞ÊçÆÔºåÈò≤Ê≠¢ undefined Êä•Èîô
        if (!window.BIG_MEMORY.pet_data) {
            window.BIG_MEMORY.pet_data = { inventory: { coins: 0, items: {} } };
        }
        const petData = window.BIG_MEMORY.pet_data;
        if (!petData.inventory) petData.inventory = { coins: 0, items: {} };
        if (!petData.inventory.items) petData.inventory.items = {};

        let prizeName = "";

        // RÂç°ÔºöÈöèÊú∫Ëé∑ÂæóÁâ©ÂìÅ
        if (rarity === 'R') {
            if (PET_CONFIG && PET_CONFIG.items && PET_CONFIG.items.length > 0) {
                const randomItem = PET_CONFIG.items[Math.floor(Math.random() * PET_CONFIG.items.length)];
                
                if (!petData.inventory.items[randomItem.id]) petData.inventory.items[randomItem.id] = 0;
                petData.inventory.items[randomItem.id]++;
                
                prizeName = randomItem.name; 
            } else {
                prizeName = "Á•ûÁßòÁ¢éÁâá";
            }
        } 
        // SRÂç°ÔºöÁßØÂàÜ
        else if (rarity === 'SR') {
            petData.inventory.coins = (petData.inventory.coins || 0) + 3;
            prizeName = "3 ÁßØÂàÜ";
        }
        // SSRÂç°ÔºöÂ§ßÈáèÁßØÂàÜ
        else if (rarity === 'SSR') {
            petData.inventory.coins = (petData.inventory.coins || 0) + 88;
            prizeName = "88 ÁßØÂàÜ";
        }
        // URÂç°ÔºöÂ§ßÂ•ñ
        else if (rarity === 'UR') {
            prizeName = "URÂ§ßÂ•ñ";
            setTimeout(() => {
                alert("üéâ ÊÅ≠ÂñúËé∑Âæó URÔºÅ\nÂá≠Ê≠§Êà™ÂõæÁßÅ‰ø°‰ΩúËÄÖÔºå‰∏ãÊ¨°Âú∞Âõæ‰∏ªÈ¢ò‰Ω†Êù•ÈÄâÔºÅ");
            }, 500);
        }
        
        // ËÆ∞ÂΩïÂéÜÂè≤
        if(!data.history) data.history = [];
        data.history.unshift({ date: Date.now(), rarity: rarity, prize: prizeName });
        if (data.history.length > 50) data.history.pop();
        
        saveGachaData(data); 
        
        // ‰øùÂ≠òÂÆ†Áâ©Êï∞ÊçÆ
        if (typeof savePetData === 'function') {
            savePetData(petData);
        }
        
        return prizeName;
    } catch (e) {
        console.error("Process Reward Failed:", e);
        return "Êú™Áü•Â•ñÂä±"; // Âá∫ÈîôÊó∂ËøîÂõûÈªòËÆ§ÊñáÊú¨Ôºå‰∏ç‰∏≠Êñ≠ÊµÅÁ®ã
    }
};

window.closeGachaAnimation = function() {
    document.getElementById('gacha-animation-overlay').style.display = 'none';
    updateGachaUI(); // Âà∑Êñ∞‰∏ªÁïåÈù¢
};
    
// 6. ËÆæÁΩÆ‰∏é‰ΩúÂºä
window.openGachaSettings = function() {
    document.getElementById('gacha-settings-modal').style.display = 'flex';
};

window.uploadGachaImage = function(rarity, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = getGachaData();
        data.custom_fronts[rarity] = e.target.result;
        saveGachaData(data);
        alert(`‚úÖ ${rarity.toUpperCase()} Âç°Èù¢Â∑≤Êõ¥Êñ∞ÔºÅ`);
    };
    reader.readAsDataURL(file);
};

window.openGachaCheat = function() {
    const code = prompt("ËØ∑ËæìÂÖ•‰ΩúÂºäÁ†Å:");
    if (code === "609103") {
        const data = getGachaData();
        data.tickets = (data.tickets || 0) + 10;
        saveGachaData(data);
        alert("‚úÖ ‰ΩúÂºäÁîüÊïàÔºöËé∑Âæó 10 Âº†ÊäΩÂç°Âà∏ÔºÅ");
        updateGachaUI();
    } else {
        alert("ÂØÜÁ†ÅÈîôËØØ");
    }
};

// 7. Ê≥®ÂÜåÂà∞Êó†ÈôêÂ≠òÂÇ® (ÈáçË¶Å)
if (typeof loadAllBigData === 'function') {
    const _oldLoad = window.loadAllBigData;
    window.loadAllBigData = async function() {
        await _oldLoad();
        try {
            let res = await idb.get('universal_store', 'gacha_data');
            if(res) window.BIG_MEMORY.gacha_data = res.data;
        } catch(e) {}
    }
}
// ==================== üíû ÈªòÂ•ëÂ§ßÊåëÊàò (Tacit Challenge) Ê†∏ÂøÉÈÄªËæë ====================

let tacitDeck = [];
let tacitFlipped = [];
let activeTacitQuestionIndex = -1; // ÂΩìÂâçÊ≠£Âú®ÁªôÂì™ÈÅìÈ¢òÊäΩÁâå

// 1. Êó†ÈôêÂ≠òÂÇ®ÂàùÂßãÂåñ
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
// ÁªìÊûÑ: { history: [] }
if (!window.BIG_MEMORY.tacit_data) window.BIG_MEMORY.tacit_data = { history: [] };
// ‰øÆÂ§çÁâàÔºöËá™Âä®Ê£ÄÊµãÊï∞ÊçÆÊ†ºÂºèÔºåÂ¶ÇÊûúÊòØÈîôËØØÁöÑÊ†ºÂºè‰ºöËá™Âä®‰øÆÊ≠£
function getTacitData() { 
    let data = window.BIG_MEMORY.tacit_data;
    
    // Â¶ÇÊûúÊï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÊàñËÄÖÊòØÊï∞ÁªÑ(ÈªòËÆ§ÂàùÂßãÂåñÂØºËá¥ÁöÑ)ÔºåÊàñËÄÖÊ≤°Êúâ history Â≠óÊÆµ
    if (!data || Array.isArray(data) || !data.history) {
        console.log("Ê£ÄÊµãÂà∞ÈªòÂ•ëÊåëÊàòÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÊ≠£Âú®Ëá™Âä®‰øÆÂ§ç...");
        data = { history: [] };
        // Á´ãÂç≥‰øÆÂ§çÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ
        window.BIG_MEMORY.tacit_data = data;
    }
    
    return data; 
}
function saveTacitData(data) {
    window.BIG_MEMORY.tacit_data = data;
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'tacit_data', data: data });
}

// 2. ÁïåÈù¢ÂàáÊç¢
window.openTacitApp = function() {
    document.getElementById('tacit-app-modal').style.display = 'flex';
    switchTacitView('setup');
    
    // Â¶ÇÊûúÊ≤°ÊúâÈóÆÈ¢òÔºåÈªòËÆ§Âä†‰∏Ä‰∏™
    const list = document.getElementById('tacit-question-list');
    if(list.children.length === 0) addTacitQuestion();
};

window.switchTacitView = function(mode) {
    const setupEl = document.getElementById('tacit-setup-view');
    const resultEl = document.getElementById('tacit-result-view');
    const histEl = document.getElementById('tacit-history-view');
    const btnSetup = document.getElementById('btn-tacit-setup');
    const btnHist = document.getElementById('btn-tacit-history');

    setupEl.style.display = 'none';
    resultEl.style.display = 'none';
    histEl.style.display = 'none';

    if (mode === 'setup') {
        setupEl.style.display = 'block';
        btnSetup.style.background = '#d63031'; btnSetup.style.color = '#fff';
        btnHist.style.background = '#ff9ff3'; btnHist.style.color = '#fff';
    } else if (mode === 'result') {
        resultEl.style.display = 'block';
    } else {
        histEl.style.display = 'block';
        renderTacitHistory();
        btnSetup.style.background = '#ff9ff3'; 
        btnHist.style.background = '#d63031';
    }
};

// 3. Âä®ÊÄÅÈóÆÈ¢òÁÆ°ÁêÜ
window.addTacitQuestion = function() {
    const container = document.getElementById('tacit-question-list');
    const index = container.children.length;
    
    if (index >= 10) return alert("ÊúÄÂ§öÂè™ËÉΩÊ∑ªÂä†10‰∏™ÈóÆÈ¢òÂì¶ÔºÅ");

    const div = document.createElement('div');
    div.className = 'tacit-q-card';
    div.dataset.index = index;
    // Â≠òÂÇ®Âç°ÁâåÊï∞ÊçÆ
    div.dataset.card = ""; 

    div.innerHTML = `
        <div class="tacit-del-btn" onclick="removeTacitQuestion(this)">√ó</div>
        <div style="font-weight:bold; margin-bottom:5px; color:#d63031;">Question ${index + 1}</div>
        
        <div class="tacit-input-row">
            <input type="text" class="tacit-input q-text" placeholder="ËæìÂÖ•ÈóÆÈ¢ò (Â¶Ç: ÊàëÊúÄÂñúÊ¨¢ÁöÑÈ£üÁâ©?)">
        </div>
        
        <div class="tacit-opt-group">
            <input type="radio" name="tacit_opt_${Date.now()}_${index}" value="A" class="tacit-radio">
            <input type="text" class="tacit-input opt-a" placeholder="ÈÄâÈ°π A">
        </div>
        
        <div class="tacit-opt-group">
            <input type="radio" name="tacit_opt_${Date.now()}_${index}" value="B" class="tacit-radio">
            <input type="text" class="tacit-input opt-b" placeholder="ÈÄâÈ°π B">
        </div>

        <div class="tacit-card-status" onclick="openTacitCardTable(${index})">
            üÉè ÁÇπÂáªÊäΩÂèñÂëΩËøêÁâå (ÂÜ≥ÂÆöTaÁöÑÈÄâÊã©)
        </div>
    `;
    container.appendChild(div);
};

window.removeTacitQuestion = function(btn) {
    btn.parentElement.remove();
    // ÈáçÊñ∞ÁºñÂè∑ UI (ÂèØÈÄâÔºå‰∏∫‰∫ÜÁÆÄÂçïËøôÈáå‰∏çÂÅöÊ∑±Â∫¶ÈáçÊéíÔºåÂè™ÂΩ±ÂìçËßÜËßâÈ°∫Â∫è)
};
// ‰øÆÊîπÁâàÔºöÂÖÅËÆ∏ÊäΩÂ§öÂº†Áâå
window.openTacitCardTable = function(qIndex) {
    activeTacitQuestionIndex = qIndex;
    const modal = document.getElementById('tacit-card-table-modal');
    const area = document.getElementById('tacit-card-area');
    const desk = document.getElementById('tacit-card-table-desk');

    // Â∫îÁî®ÁæéÂåñËÉåÊôØ
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    tacitDeck = []; 
    tacitFlipped = []; // ÈáçÁΩÆÂΩìÂâçÈÄâÊã©
    document.getElementById('tacit-flipped-count').innerText = '0';

    // 114Âº†ÂÖ®ÁâåÂ∫ì
    for(let i=0; i<=77; i++) tacitDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) tacitDeck.push({ type:'lenormand', id:i, isReversed:false });
    tacitDeck.sort(()=>Math.random()-0.5);

    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    tacitDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = () => {
            // üî•üî•üî• ‰øÆÊîπÁÇπÔºöÂà†Èô§‰∫ÜÂéüÊù•ÁöÑÂçïÈÄâÈôêÂà∂‰ª£Á†Å üî•üî•üî•
            
            if(el.classList.contains('flipped')) {
                // ÂèñÊ∂àÈÄâÊã©Ôºö‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
                el.classList.remove('flipped');
                tacitFlipped = tacitFlipped.filter(c => !(c.id === card.id && c.type === card.type));
                
                // ËßÜËßâ‰∏äÊ∏ÖÈô§ÂõæÁâá
                setTimeout(() => {
                    front.style.backgroundImage = '';
                    front.style.background = '';
                    front.innerText = '';
                }, 300);
            } else {
                // ÈÄâ‰∏≠ÔºöÊ∑ªÂä†Âà∞Êï∞ÁªÑ
                el.classList.add('flipped');
                tacitFlipped.push(card);
                
                // Âä†ËΩΩÂõæÁâáÈÄªËæë
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) {
                        front.style.backgroundImage=`url(${res.data})`;
                        front.innerText = '';
                    } else { 
                        front.style.background="#fff"; 
                        front.innerText=card.id; 
                    }
                });
                
                // Â§ÑÁêÜÊ≠£ÈÄÜ‰ΩçÊóãËΩ¨
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            document.getElementById('tacit-flipped-count').innerText = tacitFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};
// ‰øÆÊîπÁâàÔºöÂÖÅËÆ∏ÊäΩÂ§öÂº†Áâå
window.openTacitCardTable = function(qIndex) {
    activeTacitQuestionIndex = qIndex;
    const modal = document.getElementById('tacit-card-table-modal');
    const area = document.getElementById('tacit-card-area');
    const desk = document.getElementById('tacit-card-table-desk');

    // Â∫îÁî®ÁæéÂåñËÉåÊôØ
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    tacitDeck = []; 
    tacitFlipped = []; // ÈáçÁΩÆÂΩìÂâçÈÄâÊã©
    document.getElementById('tacit-flipped-count').innerText = '0';

    // 114Âº†ÂÖ®ÁâåÂ∫ì
    for(let i=0; i<=77; i++) tacitDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) tacitDeck.push({ type:'lenormand', id:i, isReversed:false });
    tacitDeck.sort(()=>Math.random()-0.5);

    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    tacitDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = () => {
            // üî•üî•üî• ‰øÆÊîπÁÇπÔºöÂà†Èô§‰∫ÜÂéüÊù•ÁöÑÂçïÈÄâÈôêÂà∂‰ª£Á†Å üî•üî•üî•
            
            if(el.classList.contains('flipped')) {
                // ÂèñÊ∂àÈÄâÊã©Ôºö‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
                el.classList.remove('flipped');
                tacitFlipped = tacitFlipped.filter(c => !(c.id === card.id && c.type === card.type));
                
                // ËßÜËßâ‰∏äÊ∏ÖÈô§ÂõæÁâá
                setTimeout(() => {
                    front.style.backgroundImage = '';
                    front.style.background = '';
                    front.innerText = '';
                }, 300);
            } else {
                // ÈÄâ‰∏≠ÔºöÊ∑ªÂä†Âà∞Êï∞ÁªÑ
                el.classList.add('flipped');
                tacitFlipped.push(card);
                
                // Âä†ËΩΩÂõæÁâáÈÄªËæë
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) {
                        front.style.backgroundImage=`url(${res.data})`;
                        front.innerText = '';
                    } else { 
                        front.style.background="#fff"; 
                        front.innerText=card.id; 
                    }
                });
                
                // Â§ÑÁêÜÊ≠£ÈÄÜ‰ΩçÊóãËΩ¨
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            document.getElementById('tacit-flipped-count').innerText = tacitFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};
// ‰øÆÊîπÁâàÔºö‰øùÂ≠òÊâÄÊúâÈÄâ‰∏≠ÁöÑÁâå
window.confirmTacitCard = function() {
    if(tacitFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");
    
    // üî•üî•üî• ‰øÆÊîπÁÇπÔºöÈÅçÂéÜÊâÄÊúâÈÄâ‰∏≠ÁöÑÁâåÔºåÊãºÊé•ÊàêÂ≠óÁ¨¶‰∏≤ üî•üî•üî•
    const cardNames = tacitFlipped.map(card => {
        const name = (card.type === 'tarot' ? (TAROT_NAMES[card.id] || card.id) : (LENORMAND_NAMES[card.id] || card.id));
        const status = card.isReversed ? "(ÈÄÜ)" : "";
        return name + status;
    }).join(", "); // Áî®ÈÄóÂè∑ÂàÜÈöîÔºå‰æãÂ¶ÇÔºöÊÑö‰∫∫(ÈÄÜ), È™ëÂ£´, ÊàøÂ≠ê
    
    // ÊâæÂà∞ÂØπÂ∫îÁöÑÈóÆÈ¢ò DOM
    const qList = document.getElementById('tacit-question-list');
    let targetRow = qList.querySelector(`.tacit-q-card[data-index="${activeTacitQuestionIndex}"]`);
    
    if(targetRow) {
        // ‰øùÂ≠òÊãºÊé•Â•ΩÁöÑÁâåÂêçÂ≠óÁ¨¶‰∏≤
        targetRow.dataset.card = cardNames;
        
        // UI Êõ¥Êñ∞ÊòæÁ§∫
        const statusDiv = targetRow.querySelector('.tacit-card-status');
        statusDiv.innerText = `‚úÖ Â∑≤ÊäΩÂèñ ${tacitFlipped.length} Âº†: ${cardNames}`;
        statusDiv.style.background = "#e6fffa";
        statusDiv.style.color = "#00b894";
        statusDiv.style.border = "1px solid #00b894";
    }
    
    document.getElementById('tacit-card-table-modal').style.display = 'none';
};

// 5. Êèê‰∫§Âπ∂ÁîüÊàêÁªìÊûú (API Ê†∏ÂøÉ)
window.submitTacitChallenge = async function() {
    const qList = document.getElementById('tacit-question-list');
    const rows = qList.querySelectorAll('.tacit-q-card');
    
    if (rows.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏ÄÈÅìÈ¢òÁõÆÔºÅ");

    let questionsData = [];
    let isComplete = true;

    rows.forEach((row, i) => {
        const q = row.querySelector('.q-text').value;
        const optA = row.querySelector('.opt-a').value;
        const optB = row.querySelector('.opt-b').value;
        const card = row.dataset.card;
        
        // Ëé∑ÂèñÁî®Êà∑ÈÄâÊã©
        const radios = row.querySelectorAll('input[type="radio"]');
        let userChoice = "";
        radios.forEach(r => { if(r.checked) userChoice = r.value; });

        if (!q || !optA || !optB) { isComplete = false; return alert(`Á¨¨ ${i+1} È¢òÂÜÖÂÆπÊú™Â°´ÂÜôÂÆåÊï¥ÔºÅ`); }
        if (!userChoice) { isComplete = false; return alert(`Á¨¨ ${i+1} È¢ò‰Ω†Ê≤°ÊúâÂãæÈÄâ‰Ω†ÁöÑÁ≠îÊ°àÔºÅ`); }
        if (!card) { isComplete = false; return alert(`Á¨¨ ${i+1} È¢òËøòÊ≤°ÊúâÊäΩÁâåÔºÅ`); }

        questionsData.push({
            id: i,
            question: q,
            options: { A: optA, B: optB },
            userChoice: userChoice,
            card: card
        });
    });

    if (!isComplete) return;

    // UI ÈîÅÂÆö
    const btn = document.getElementById('btn-tacit-submit');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ Ê≠£Âú®ËøûÊé•TaÁöÑÊΩúÊÑèËØÜ..."; btn.disabled = true;

    // ÂáÜÂ§á Prompt
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) { btn.innerText=oldText; btn.disabled=false; return alert("ËØ∑ÈÖçÁΩÆ API Key"); }

    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®ÊâÆÊºî‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤ËøõË°å‚ÄúÈªòÂ•ëÂ§ßÊåëÊàò‚Äù„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}

„ÄêÁî®Êà∑ËÆæÂÆöÁöÑÈ¢òÁõÆ‰∏éÂëΩËøêÁâå„ÄëÔºö
${JSON.stringify(questionsData)}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÈÅçÂéÜÊØè‰∏Ä‰∏™ÈóÆÈ¢òÔºåÊ†πÊçÆ„ÄêÂëΩËøêÁâåÁöÑËÉΩÈáèÊµÅÂä®„ÄëÂíå„ÄêËßíËâ≤‰∫∫ËÆæ„ÄëÂà§Êñ≠ËßíËâ≤‰ºöÈÄâÊã©Âì™‰∏Ä‰∏™ÈÄâÈ°π„ÄÇ
* Ê†∏ÂøÉËßÑÂàôÔºöÂëΩËøêÁâåÁöÑÁâåÊÑèÊúÄÈáçË¶Å„ÄÇ
* Â¶ÇÊûúÁâåÊÑè‰∏éÁî®Êà∑ÈÄâÊã©‰∏ÄËá¥ÔºàÊàñÁâåÊÑèÁßØÊûÅÊåáÂêëÁî®Êà∑ÈÄâÈ°πÔºâÔºåÂàôÁÆó‰Ωú‚ÄúÂøÉÊúâÁÅµÁäÄ‚Äù„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„ÄëÔºö
‰∏•Ê†º JSON ÂØπË±°Ôºö
{
  "results": [
    {
      "id": 0, (ÂØπÂ∫îÈ¢òÁõÆID)
      "char_choice": "A" Êàñ "B",
      "reason": "ËßíËâ≤ÈÄâÊã©ÁöÑÁêÜÁî±ÔºàÁªìÂêàÁâåÊÑèÔºâÔºåÂåÖÂê´ÂØπËøô‰∏§‰∏™ÈÄâÈ°πÁöÑÁúãÊ≥ï",
      "reaction": "ËßíËâ≤ÈÄâÂÆåÂêéÁöÑÁÆÄÁü≠ÂèçÂ∫îÔºàÂºÄÂøÉ/ÂêêÊßΩ/ÁñëÊÉëÔºâ"
    },
    ... (ÊâÄÊúâÈ¢òÁõÆ)
  ],
  "reaction_50": "Â¶ÇÊûúÁ≠îÂØπÁéá‰Ωé‰∫é50%Êó∂ÁöÑËßíËâ≤ÂèçÂ∫îÔºàÁîöËá≥ÊúâÁÇπÁîüÊ∞îÊàñÂ§±ËêΩÔºâ",
  "reaction_90": "Â¶ÇÊûúÁ≠îÂØπÁéáÂú®50%-90%Êó∂ÁöÑËßíËâ≤ÂèçÂ∫îÔºàÊØîËæÉÊª°ÊÑèÔºâ",
  "reaction_100": "Â¶ÇÊûúÂÖ®ÈÉ®Á≠îÂØπÊó∂ÁöÑËßíËâ≤ÂèçÂ∫îÔºàÈùûÂ∏∏ÊÉäÂñú„ÄÅÊÑüÂä®„ÄÅÂÆåÁæéÔºâ"
}
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON only."}, {role:"user", content:prompt}],
                temperature: 0.7
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const start = raw.indexOf('{'); const end = raw.lastIndexOf('}');
        if(start!==-1 && end!==-1) raw = raw.substring(start, end+1);
        
        const apiResult = JSON.parse(raw);

        // ËÆ°ÁÆóÁªìÊûú
        let correctCount = 0;
        const total = questionsData.length;
        
        // ÂêàÂπ∂Êï∞ÊçÆ
        const finalResults = questionsData.map(q => {
            const resItem = apiResult.results.find(r => r.id === q.id);
            const isMatch = resItem.char_choice === q.userChoice;
            if (isMatch) correctCount++;
            return {
                ...q,
                charChoice: resItem.char_choice,
                reason: resItem.reason,
                reaction: resItem.reaction,
                isMatch: isMatch
            };
        });

        const scorePercent = Math.round((correctCount / total) * 100);
        let finalReaction = "";
        if (scorePercent === 100) finalReaction = apiResult.reaction_100;
        else if (scorePercent >= 50) finalReaction = apiResult.reaction_90;
        else finalReaction = apiResult.reaction_50;

        // ‰øùÂ≠òÂéÜÂè≤
        const sessionData = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            score: scorePercent,
            finalReaction: finalReaction,
            details: finalResults
        };
        
        const historyData = getTacitData();
        historyData.history.unshift(sessionData);
        saveTacitData(historyData);

        // Ê∏≤ÊüìÁªìÊûúÈ°µ
        renderTacitResultPage(sessionData);
        switchTacitView('result');

    } catch(e) {
        console.error(e);
        alert("ÊåëÊàòÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};

// 6. Ê∏≤ÊüìÁªìÊûúËØ¶ÊÉÖÈ°µ
window.renderTacitResultPage = function(session) {
    document.getElementById('tacit-score-display').innerText = `${session.score}%`;
    document.getElementById('tacit-summary-reaction').innerText = `‚Äú${session.finalReaction}‚Äù`;
    
    const container = document.getElementById('tacit-result-list');
    container.innerHTML = '';

    session.details.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = `tacit-result-card ${item.isMatch ? 'correct' : 'wrong'}`;
        
        const userText = item.options[item.userChoice];
        const charText = item.options[item.charChoice];
        
        div.innerHTML = `
            <div class="tacit-res-header">
                Q${i+1}: ${item.question} 
                <span style="float:right;">${item.isMatch ? '‚úÖ ÈªòÂ•ë' : '‚ùå ÈÅóÊÜæ'}</span>
            </div>
            <div style="font-size:0.9rem; color:#333;">
                <div>‰Ω†ÈÄâ‰∫ÜÔºö<strong>${userText}</strong></div>
                <div style="color:#d63031;">TaÈÄâ‰∫ÜÔºö<strong>${charText}</strong></div>
            </div>
            <div class="tacit-card-tag">üîÆ ÂëΩËøêÁâå: ${item.card}</div>
            <div class="tacit-res-reason">
                <strong>TaÁöÑÊÉ≥Ê≥ïÔºö</strong>${item.reason}<br>
                <span style="color:#e17055;">(ÂèçÂ∫î: ${item.reaction})</span>
            </div>
        `;
        container.appendChild(div);
    });
};

// 7. ÂéÜÂè≤ËÆ∞ÂΩï‰∏éÂà†Èô§
window.renderTacitHistory = function() {
    const data = getTacitData();
    const list = document.getElementById('tacit-history-list');
    list.innerHTML = '';

    if (data.history.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ÊåëÊàòËÆ∞ÂΩï</div>';
        return;
    }

    data.history.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '15px';
        
        let color = item.score === 100 ? '#00b894' : (item.score >= 60 ? '#fdcb6e' : '#ff7675');

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                <span>${item.date}</span>
                <span onclick="deleteTacitHistory(${index})" style="color:red; cursor:pointer;">Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; font-size:1.2rem; color:${color}; margin:5px 0;">
                ÂæóÂàÜ: ${item.score}%
            </div>
            <div style="font-size:0.85rem; color:#636e72;">
                TaËØ¥: ‚Äú${item.finalReaction.substring(0, 20)}...‚Äù
            </div>
            <button class="m-btn small" onclick="replayTacitHistory(${index})" style="width:100%; margin-top:10px; background:#fab1a0; color:#d63031;">
                üîÑ ÈáçÊñ∞Êü•Áúã / ÂÜçÊ¨°ÂõûÂë≥
            </button>
        `;
        list.appendChild(div);
    });
};

window.deleteTacitHistory = function(index) {
    if(!confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const data = getTacitData();
    data.history.splice(index, 1);
    saveTacitData(data);
    renderTacitHistory();
};

window.replayTacitHistory = function(index) {
    const data = getTacitData();
    const session = data.history[index];
    renderTacitResultPage(session);
    switchTacitView('result');
};

// 8. Ë°•‰∏ÅÔºöÁ°Æ‰øù tacit_data Ë¢´Âä†ËΩΩ
if (typeof loadAllBigData === 'function') {
    // Ê£ÄÊü• REQUIRED_KEYS ÈáåÊòØÂê¶Â∑≤Êúâ 'tacit_data'ÔºåÂ¶ÇÊûúÊ≤°ÊúâÔºåÊâãÂä®Êé®ÂÖ•Ôºà‰ΩÜÊàëÂú®‰∏äÈù¢ÁöÑ‰ª£Á†ÅÂùóÈáåÊó†Ê≥ï‰øÆÊîπÂ∏∏ÈáèÔºåÊâÄ‰ª•ËøôÈáåÁî® hook ÊñπÂºèÔºâ
    // ÂÆûÈôÖ‰∏äÔºåÂè™Ë¶ÅÂú® loadAllBigData ÁöÑÊï∞ÁªÑÈáåÂä†‰∏ä 'tacit_data' Âç≥ÂèØ„ÄÇ
    // ‰∏∫‰∫Ü‰øùÈô©Ëµ∑ËßÅÔºåËøôÈáåÂÅö‰∏Ä‰∏™Âä´ÊåÅÔºö
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad();
        try {
            let res = await idb.get('universal_store', 'tacit_data');
            if(res) window.BIG_MEMORY.tacit_data = res.data;
        } catch(e) {}
    }
}
// ==================== ‚≠ê ËÅäÂ§©Êî∂ËóèÂäüËÉΩÊ†∏ÂøÉÈÄªËæë ====================

// 1. ÂàùÂßãÂåñÊî∂ËóèÊï∞ÊçÆ (Êó†ÈôêÂ≠òÂÇ®)
if (!window.BIG_MEMORY.chat_collections) window.BIG_MEMORY.chat_collections = [];

function getChatCollections() { return window.BIG_MEMORY.chat_collections || []; }
function saveChatCollections(list) {
    window.BIG_MEMORY.chat_collections = list;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'chat_collections', data: list });
}

// 2. ÊâßË°åÊî∂Ëóè (ÁÇπÂáªÈªÑËâ≤ÊåâÈíÆËß¶Âèë)
async function confirmCollectMessages() {
    if(selectedDeleteIds.size === 0) return;
    
    const allMsgs = await idb.getAll('chat_history'); // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ËÆ∞ÂΩï
    const list = getChatCollections();
    let count = 0;

    // ÈÅçÂéÜÈÄâ‰∏≠ÁöÑIDÔºåÊâæÂà∞ÂØπÂ∫îÊ∂àÊÅØÂπ∂Â≠òÂÖ•Êî∂ËóèÂ§π
    selectedDeleteIds.forEach(id => {
        const msg = allMsgs.find(m => m.id === id);
        if(msg) {
            // Â§çÂà∂‰∏Ä‰ªΩÔºåÁîüÊàêÊñ∞ÁöÑ ID Èò≤Ê≠¢ÂÜ≤Á™Å
            const copy = { ...msg, id: Date.now() + Math.random(), collectedDate: Date.now() };
            list.unshift(copy); // Â≠òÂÖ•Â§¥ÈÉ®
            count++;
        }
    });

    saveChatCollections(list);
    alert(`üéâ Â∑≤ÊàêÂäüÊî∂Ëóè ${count} Êù°Ê∂àÊÅØÔºÅ\nÂç≥‰ΩøÊ∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩïÔºåÂÆÉ‰ª¨‰πü‰ºöÂú®[ËÆæÁΩÆ->Êî∂ËóèÂ§π]‰∏≠‰øùÁïô„ÄÇ`);
    
    quitDeleteMode(); // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
}

// 3. ÂàáÊç¢ÊòæÁ§∫Êî∂ËóèÂàóË°®
function toggleCollectionList() {
    const container = document.getElementById('chat-collection-container');
    if(container.style.display === 'none') {
        container.style.display = 'block';
        renderChatCollections();
    } else {
        container.style.display = 'none';
    }
}

// === ‚≠ê ÂçáÁ∫ßÁâàÔºöÊ∏≤ÊüìÊî∂ËóèÂàóË°® (Â∏¶Â§¥ÂÉè„ÄÅÊó∂Èó¥„ÄÅÊ∞îÊ≥°) ===
async function renderChatCollections() {
    const list = getChatCollections();
    const container = document.getElementById('chat-collection-list');
    container.innerHTML = '';

    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; font-size:0.8rem; padding:20px;">ÊöÇÊó†Êî∂ËóèÂÜÖÂÆπ</div>';
        return;
    }

    // 1. ÂÖàÂä†ËΩΩÂ§¥ÂÉèËµÑÊ∫ê (‰∏∫‰∫ÜÊòæÁ§∫ÊºÇ‰∫ÆÁöÑÂ§¥ÂÉè)
    let myAvatar = '', botAvatar = '';
    try {
        const myRes = await idb.get('settings_heavy', 'myAvatar');
        const botRes = await idb.get('settings_heavy', 'botAvatar');
        if (myRes) myAvatar = myRes.data;
        if (botRes) botAvatar = botRes.data;
    } catch (e) { console.log("Â§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•", e); }

    // Ëé∑ÂèñÂØπÊñπÁöÑÂêçÂ≠ó (Line È£éÊ†ºÈÄöÂ∏∏ÊòæÁ§∫ÂêçÂ≠ó)
    const chatTitle = document.getElementById('chat-title-input').value || "ÂØπÊñπ";

    // 2. ÈÅçÂéÜÊ∏≤Êüì
    list.forEach((msg, index) => {
        // --- A. Êó∂Èó¥Ê†ºÂºèÂåñ (Âá†ÊúàÂá†Êó• ‰∏ãÂçàHH:mm) ---
        const date = new Date(msg.timestamp);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = date.getHours();
        const minute = String(date.getMinutes()).padStart(2, '0');
        const period = hour >= 12 ? "‰∏ãÂçà" : "‰∏äÂçà";
        const timeStr = `${month}Êúà${day}Êó• ${period} ${hour}:${minute}`;

        // --- B. Â§¥ÂÉè‰∏éÂêçÂ≠ó ---
        const avatarSrc = msg.isMe ? myAvatar : botAvatar;
        const nameStr = msg.isMe ? "Êàë" : chatTitle;
        // ÈªòËÆ§ÁÅ∞Ëâ≤Â§¥ÂÉèÂÖúÂ∫ï
        const avatarStyle = avatarSrc ? `background-image: url(${avatarSrc});` : `background-color: #ccc;`;

        // --- C. ÂÜÖÂÆπÂ§ÑÁêÜ (ÂõæÁâá/ËØ≠Èü≥/ÊñáÂ≠ó) ---
        let contentHtml = "";
        if (msg.type === 'image') {
            contentHtml = `<img src="${msg.text}" style="max-width:120px; max-height:120px; border-radius:8px; cursor:zoom-in; border:1px solid #eee;" onclick="viewPhotoSimple('${msg.text}')">`;
        } else if (msg.type === 'audio') {
            contentHtml = `
                <div style="display:flex; align-items:center; gap:5px; background:#f1f2f6; padding:5px 10px; border-radius:15px; width:fit-content;">
                    <span>üé§</span> <span>ËØ≠Èü≥Â≠òÊ°£</span>
                </div>`;
        } else {
            // ÊñáÂ≠óÂÜÖÂÆπ (ÂÖÅËÆ∏Êç¢Ë°å)
            contentHtml = `<div style="white-space: pre-wrap; word-break: break-word; line-height: 1.5;">${msg.text}</div>`;
        }

        // --- D. ÊûÑÂª∫ HTML Âç°Áâá ---
        const div = document.createElement('div');
        div.style.cssText = "background:#fff; padding:12px; border-radius:8px; border-bottom:1px solid #f0f0f0; display:flex; gap:12px; position:relative;";
        
        div.innerHTML = `
            <!-- Â§¥ÂÉè -->
            <div style="width:40px; height:40px; border-radius:50%; background-size:cover; background-position:center; flex-shrink:0; border:1px solid rgba(0,0,0,0.1); ${avatarStyle}"></div>
            
            <!-- Âè≥‰æß‰∏ª‰Ωì -->
            <div style="flex:1; min-width:0;">
                <!-- Â§¥ÈÉ®ÔºöÂêçÂ≠ó + Êó∂Èó¥ -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span style="font-size:0.8rem; font-weight:bold; color:#555;">${nameStr}</span>
                    <span style="font-size:0.65rem; color:#aaa;">${timeStr}</span>
                </div>
                
                <!-- ÂÜÖÂÆπÂå∫Âüü -->
                <div style="font-size:0.9rem; color:#333;">
                    ${contentHtml}
                </div>
            </div>

            <!-- Âà†Èô§ÊåâÈíÆ (Âè≥‰∏äËßíÊÇ¨ÊµÆ) -->
            <div onclick="deleteCollectionItem(${index})" style="position:absolute; top:10px; right:0px; width:30px; height:30px; text-align:center; color:#ffb8b8; cursor:pointer; font-size:1.2rem; opacity:0.6;">√ó</div>
        `;
        
        container.appendChild(div);
    });
}

// 5. Âà†Èô§Êî∂Ëóè
function deleteCollectionItem(index) {
    if(!confirm("ÁßªÈô§ËøôÊù°Êî∂ËóèÔºü")) return;
    const list = getChatCollections();
    list.splice(index, 1);
    saveChatCollections(list);
    renderChatCollections();
}

// ÁÆÄÂçïÂõæÁâáÈ¢ÑËßà (Â§çÁî®)
window.viewPhotoSimple = function(src) {
    const win = window.open("", "_blank");
    win.document.write(`<img src="${src}" style="max-width:100%">`);
};
// ==================== üì© ÈöèÊú∫Áü≠‰ø°ÂäüËÉΩÈÄªËæë ====================

let smsDeck = [];
let smsFlipped = [];
let smsTimeout = null;

// 1. Ëß¶ÂèëÂô®ÈÄªËæë
function triggerRandomSms() {
    const el = document.getElementById('random-sms-trigger');
    
    // === ‰øÆÊîπÂºÄÂßãÔºöËé∑ÂèñÂêçÂ≠óÂπ∂Êõ¥Êñ∞ ===
    const settings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    const name = settings.title || "Ta"; // Ëé∑ÂèñÂ§áÊ≥®ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÈªòËÆ§‰∏∫ Ta
    // Êõ¥Êñ∞ÊÇ¨ÊµÆÁ™ó‰∏äÁöÑÊñáÂ≠óÔºàÂÆÉÊòØËØ•ÂÖÉÁ¥†ÁöÑÊúÄÂêé‰∏Ä‰∏™Â≠êdivÔºâ
    el.lastElementChild.innerText = name + " ÁöÑÊù•‰ø°";
    // === ‰øÆÊîπÁªìÊùü ===

    el.classList.add('show');
    
    // Êí≠ÊîæÊèêÁ§∫Èü≥ (ÂèØÈÄâ)
    if(typeof NotificationManager !== 'undefined') {
        NotificationManager.showToast("Êñ∞Ê∂àÊÅØ", "‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÊù°Êù•Ëá™Áà±‰∫∫ÁöÑÁü≠‰ø°", "üíå");
    }

    // 10ÂàÜÈíüÂêéËá™Âä®Ê∂àÂ§±
    if (smsTimeout) clearTimeout(smsTimeout);
    smsTimeout = setTimeout(() => {
        el.classList.remove('show');
    }, 10 * 60 * 1000); // 10ÂàÜÈíü
}

// 2. ÁÇπÂáªÂ§ÑÁêÜ
function handleSmsClick() {
    if (confirm("Êî∂Âà∞‰∏ÄÊù°Êù•Ëá™Áà±‰∫∫ÁöÑÁü≠‰ø°ÔºåÊòØÂê¶Êü•Êî∂Ôºü\n(ÈÄâÊã©'ÂèñÊ∂à'Â∞ÜÂøΩÁï•Ê≠§Ê∂àÊÅØ)")) {
        document.getElementById('random-sms-trigger').classList.remove('show');
        openSmsCardTable();
    } else {
        document.getElementById('random-sms-trigger').classList.remove('show');
    }
}

// 3. ÊâìÂºÄÊäΩÁâåÊ°å (Â§çÁî®Ê∏∏ÊàèÊú∫ÈÄªËæë)
function openSmsCardTable() {
    const modal = document.getElementById('sms-card-modal');
    const area = document.getElementById('sms-card-area');
    const desk = document.getElementById('sms-card-desk');
    
    // Â∞ùËØïÂä†ËΩΩÁæéÂåñÊ°åÂ∏É
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
            else desk.style.background = "radial-gradient(circle, #2d3436 0%, #000 100%)";
        });
    }

    area.innerHTML = '';
    smsDeck = []; smsFlipped = [];
    document.getElementById('sms-flipped-count').innerText = '0';

    // ÁîüÊàêÂÆåÊï¥ÁâåÂ∫ì
    for(let i=0; i<=77; i++) smsDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) smsDeck.push({ type:'lenormand', id:i, isReversed:false });
    smsDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    smsDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                smsFlipped = smsFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                smsFlipped.push(card);
                // Âä†ËΩΩÂõæÁâá
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) front.style.backgroundImage=`url(${res.data})`;
                    else { front.style.background="#fff"; front.innerText=card.id; }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('sms-flipped-count').innerText = smsFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
}

// 4. API ÁîüÊàêÁü≠‰ø°
async function finishSmsDraw() {
    if (smsFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");
    
    const btn = document.querySelector('#sms-card-modal .primary');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ Êé•Êî∂‰ø°Âè∑‰∏≠..."; btn.disabled = true;

    // ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = smsFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    // ÁºìÂ≠òËØªÂèñ
    if(!apiKey) { 
        try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} 
    }
    if(!apiKey) { btn.innerText=oldText; btn.disabled=false; return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key"); }

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊâÆÊºîËßíËâ≤„ÄÇ
„Äê‰∏ñÁïåËßÇ/‰∫∫ËÆæ„ÄëÔºö${globalCtx}
„ÄêÊ≠§Êó∂Ê≠§ÂàªÁöÑÂëΩËøêÁâå„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„Äë
ËØ∑Ê†πÊçÆ**ÁâåÊÑè**ÔºàËøôÊòØÊúÄÈáçË¶ÅÁöÑ‰æùÊçÆÔºâÔºåÊé®ÊµãËßíËâ≤Áé∞Âú®Âú®ÂÅö‰ªÄ‰πàÔºå‰ª•ÂèäÊÉ≥ÂØπÁî®Êà∑ËØ¥‰ªÄ‰πà„ÄÇÊ†πÊçÆÁâåÈù¢ËÉΩÈáèÊµÅÂä®Ôºå‰∏çË¶ÅÊ≠ªËÆ∞Á°¨ËÉåÁöÑÁâåÊÑè„ÄÇÁÅµÊ¥ªÂèòÈÄö„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSONÔºö
{
  "doing": "ÁÆÄÁü≠ÊèèËø∞‰ªñÊ≠£Âú®ÂÅö‰ªÄ‰πàÔºà‰æãÂ¶ÇÔºöÊ≠£Âú®ÂºÄ‰ºöÂÅ∑Êáí / Ê≠£Âú®ÁúãÁùÄÁ™óÂ§ñÂèëÂëÜÔºâ",
  "message": "Áü≠‰ø°Ê≠£ÊñáÔºàÂè£ËØ≠ÂåñÔºåÁ¨¶Âêà‰∫∫ËÆæÔºå30Â≠óÂ∑¶Âè≥Ôºâ"
}
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"JSON output only."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const start = raw.indexOf('{'); const end = raw.lastIndexOf('}');
        if(start!==-1 && end!==-1) raw = raw.substring(start, end+1);
        
        const result = JSON.parse(raw);
        
        // ÊòæÁ§∫ÁªìÊûú
        document.getElementById('sms-res-action').innerText = result.doing;
        document.getElementById('sms-res-msg').innerText = result.message;
        document.getElementById('sms-res-cards').innerText = cardsDesc;
        
        document.getElementById('sms-result-overlay').style.display = 'flex';
        document.querySelector('.sms-result-box').style.display = 'flex';

    } catch(e) {
        alert("Êé•Êî∂Â§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
}

function closeSmsModal() {
    document.getElementById('sms-card-modal').style.display = 'none';
}
function closeSmsResult() {
    document.getElementById('sms-result-overlay').style.display = 'none';
    closeSmsModal();
}

// 5. ÈöèÊú∫Ëß¶ÂèëÂô® (ÊØè 5 ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°Ôºå10% Ê¶ÇÁéáËß¶Âèë)
setInterval(() => {
    // Âè™ÊúâÂú®Ê≤°ÊúâÊâìÂºÄÂÖ∂‰ªñÂºπÁ™óÊó∂ÊâçËß¶Âèë
    const modals = document.querySelectorAll('.modal-overlay');
    let anyOpen = false;
    modals.forEach(m => { if(m.style.display === 'flex' || m.style.display === 'block') anyOpen = true; });
    
    if (!anyOpen && Math.random() < 0.05) {
        triggerRandomSms();
    }
}, 5 * 60 * 1000); // 5ÂàÜÈíü

// === ÊµãËØïÊé•Âè£ÔºöÊö¥Èú≤ÁªôÊéßÂà∂Âè∞ÊàñÊµãËØïÊåâÈíÆ ===
window.testRandomSms = function() {
    triggerRandomSms();
    alert("Âä†ÊÄ•Áü≠‰ø°ÔºÅËØ∑ÁúãÂ±èÂπïÂè≥‰æß„ÄÇ");
}
// ==================== üß© ËÆ∞ÂøÜÊãºÂõæ APP Ê†∏ÂøÉÈÄªËæë ====================

let puzzleDeck = [];
let puzzleFlipped = [];
let puzzleCurrentImgData = null; // ÊöÇÂ≠ò‰∏ä‰º†ÁöÑÂõæÁâáBase64
let puzzleGameState = {
    pieces: [], // 0-8 ÁöÑÂΩìÂâçÊéíÂàó
    isSolved: false,
    stories: [], // 9‰∏™ÊïÖ‰∫ã
    selectedIdx: -1 // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†ºÂ≠êÁ¥¢Âºï
};

// 1. Êó†ÈôêÂ≠òÂÇ®ÂàùÂßãÂåñ
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
// ÁªìÊûÑ: { history: [ {id, date, img, cards, stories:[], solved:true} ] }
if (!window.BIG_MEMORY.puzzle_data) window.BIG_MEMORY.puzzle_data = { history: [] };

function getPuzzleData() { return window.BIG_MEMORY.puzzle_data; }
function savePuzzleData(data) {
    window.BIG_MEMORY.puzzle_data = data;
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'puzzle_data', data: data });
}

// 2. ÁïåÈù¢ÂàáÊç¢
window.openPuzzleApp = function() {
    document.getElementById('puzzle-app-modal').style.display = 'flex';
    switchPuzzleView('create');
};

window.switchPuzzleView = function(mode) {
    const createEl = document.getElementById('puzzle-create-view');
    const histEl = document.getElementById('puzzle-history-view');
    const btnCreate = document.getElementById('btn-puzzle-create');
    const btnHist = document.getElementById('btn-puzzle-history');

    if (mode === 'create') {
        createEl.style.display = 'block';
        histEl.style.display = 'none';
        btnCreate.style.background = '#74ebd5'; btnCreate.style.color = '#fff';
        btnHist.style.background = '#dfe6e9'; btnHist.style.color = '#333';
        // Â¶ÇÊûúÊ≤°ÊúâÊ≠£Âú®ËøõË°åÁöÑÊ∏∏ÊàèÔºåÊòæÁ§∫‰∏ä‰º†Èù¢Êùø
        if(!puzzleCurrentImgData) {
            document.getElementById('puzzle-upload-panel').style.display = 'block';
            document.getElementById('puzzle-game-panel').style.display = 'none';
        }
    } else {
        createEl.style.display = 'none';
        histEl.style.display = 'block';
        btnCreate.style.background = '#dfe6e9'; btnCreate.style.color = '#333';
        btnHist.style.background = '#74ebd5'; btnHist.style.color = '#fff';
        renderPuzzleHistory();
    }
};

// 3. ‰∏ä‰º†ÂõæÁâá -> Ëß¶ÂèëÊäΩÁâå
window.handlePuzzleUpload = function(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        puzzleCurrentImgData = e.target.result;
        // ÊâìÂºÄÊäΩÁâåÊ°å
        startPuzzleDraw();
    };
    reader.readAsDataURL(file);
    input.value = '';
};

// 4. ÂêØÂä®ÊäΩÁâå
function startPuzzleDraw() {
    const modal = document.getElementById('puzzle-card-table-modal');
    const area = document.getElementById('puzzle-card-area');
    area.innerHTML = '';
    puzzleDeck = []; puzzleFlipped = [];
    document.getElementById('puzzle-flipped-count').innerText = '0';

    // ÁîüÊàê114Âº†Áâå
    for(let i=0; i<=77; i++) puzzleDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) puzzleDeck.push({ type:'lenormand', id:i, isReversed:false });
    puzzleDeck.sort(()=>Math.random()-0.5);

    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    puzzleDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                puzzleFlipped = puzzleFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                puzzleFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) front.style.backgroundImage=`url(${res.data})`;
                    else { front.style.background="#fff"; front.innerText=card.id; }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('puzzle-flipped-count').innerText = puzzleFlipped.length;
        };
        area.appendChild(el);
    });
    modal.style.display = 'flex';
}

// 5. ÁîüÊàê 9 ‰∏™ÊïÖ‰∫ãÂπ∂ÂºÄÂßãÊ∏∏Êàè
window.finishPuzzleDraw = async function() {
    if(puzzleFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#puzzle-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üß© Ê≠£Âú®Ëß£ÊûêËÆ∞ÂøÜÁ¢éÁâá...";

    // ÂáÜÂ§á‰∏ä‰∏ãÊñá
    const cardsDesc = puzzleFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçËÉΩÂ§üËØªÂèñÁÖßÁâáËÆ∞ÂøÜÁöÑÈ≠îÊ≥ïÂ∏à„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÁî®Êà∑‰∏ä‰º†‰∫Ü‰∏ÄÂº†ÁÖßÁâá„Äë„ÄÇ
„ÄêÂëΩËøêÁâåÔºàËÉΩÈáèÊåáÂºïÔºâ„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„Äë
ËØ∑Ê†πÊçÆÁâåÊÑèÂíåËßíËâ≤ËÆæÂÆöÔºåÊûÑÊÉ≥ËøôÂº†ÁÖßÁâáËÉåÂêéÁöÑ **9 ‰∏™ËÆ∞ÂøÜÁ¢éÁâáÔºàÂ∞èÊïÖ‰∫ãÔºâ**„ÄÇ
Ëøô 9 ‰∏™ÁâáÊÆµÂÖ±ÂêåÁªÑÊàê‰∫Ü‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÂõûÂøÜ„ÄÇÂèØ‰ª•ÊòØÂÖ≥‰∫éËøôÂº†ÁÖßÁâáÊãçÊëÑÊó∂ÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÅÂèëÁîüÁöÑÂ∞èÊèíÊõ≤„ÄÅÊàñÊòØÁÖßÁâáÈáåÁöÑÊüê‰∏™ÁªÜËäÇÂºïÂèëÁöÑËÅîÊÉ≥„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Êï∞ÁªÑÔºåÂåÖÂê´ 9 ‰∏™Â≠óÁ¨¶‰∏≤„ÄÇ
‰æãÂ¶ÇÔºö
[
  "ËÆ∞ÂæóÈÇ£Â§©Èò≥ÂÖâÂæàÂ•Ω...",
  "‰ªñÂÅ∑ÂÅ∑Áúã‰∫ÜÊàë‰∏ÄÁúº...",
  ...
]
ÔºàÂÖ±9Êù°ÔºåÊØèÊù° 30-50 Â≠óÔºâ
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON array only."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const start = raw.indexOf('['); const end = raw.lastIndexOf(']');
        if(start!==-1 && end!==-1) raw = raw.substring(start, end+1);
        
        const stories = JSON.parse(raw);
        // Ë°•ÈΩê9Êù°
        while(stories.length < 9) stories.push("‰∏ÄÊÆµÊ®°Á≥äÁöÑËÆ∞ÂøÜ...");
        
        // ÂêØÂä®ÊãºÂõæÊ∏∏Êàè
        puzzleGameState.stories = stories.slice(0, 9);
        puzzleGameState.isSolved = false;
        document.getElementById('puzzle-cards-display').innerText = cardsDesc;
        
        initPuzzleBoard(puzzleCurrentImgData);
        
        document.getElementById('puzzle-card-table-modal').style.display = 'none';
        document.getElementById('puzzle-upload-panel').style.display = 'none';
        document.getElementById('puzzle-game-panel').style.display = 'flex';

    } catch(e) {
        console.error(e);
        alert("ËÆ∞ÂøÜËØªÂèñÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};
// ==================== üß© ÊãºÂõæÊ∏∏ÊàèÈÄªËæë (‰øÆÂ§çÁâà) ====================

// 6. ÊãºÂõæÊ∏∏ÊàèÊ†∏ÂøÉÈÄªËæë

// A. ÂàùÂßãÂåñÊ∏∏ÊàèÔºöÂè™Âú®ÂºÄÂßãÊó∂Ë∞ÉÁî®‰∏ÄÊ¨° (Ë¥üË¥£Ê¥óÁâå)
function initPuzzleBoard(imgSrc) {
    const board = document.getElementById('puzzle-board');
    board.innerHTML = '';
    
    // ÁîüÊàêÁ¥¢Âºï [0,1,2...8]
    let pieces = [0, 1, 2, 3, 4, 5, 6, 7, 8];
    
    // Ê¥óÁâåÁÆóÊ≥ïÔºöÂè™Âú®ËøôÈáåÊâßË°å‰∏ÄÊ¨°ÔºÅ
    for (let i = pieces.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
    }
    // Á°Æ‰øùÊâì‰π±Âêé‰∏çÊòØÂéüÂõæ (Èò≤ÊûÅ‰ΩéÊ¶ÇÁéá)
    if (pieces.join('') === '012345678') {
        [pieces[0], pieces[1]] = [pieces[1], pieces[0]];
    }
    
    // ‰øùÂ≠òÁä∂ÊÄÅÂà∞ÂÖ®Â±ÄÂèòÈáè
    puzzleGameState.pieces = pieces;
    puzzleGameState.selectedIdx = -1; // ÈáçÁΩÆÈÄâ‰∏≠Áä∂ÊÄÅ
    
    // Ë∞ÉÁî®Ê∏≤ÊüìÂáΩÊï∞
    renderBoardByState();
}

// B. Ê∏≤ÊüìÂáΩÊï∞ÔºöÂè™Ë¥üË¥£ÁîªÂõæÔºå‰∏çË¥üË¥£Ê¥óÁâå
function renderBoardByState() {
    const board = document.getElementById('puzzle-board');
    board.innerHTML = ''; // Ê∏ÖÁ©∫ÂΩìÂâçËßÜÂõæ
    
    // ÈÅçÂéÜÂΩìÂâçÂ∑≤ÊéíÂ∫èÁöÑÊï∞ÁªÑ
    puzzleGameState.pieces.forEach((pVal, currentPos) => {
        const piece = document.createElement('div');
        piece.className = 'puzzle-piece';
        
        // È´ò‰∫ÆÈÄâ‰∏≠Áä∂ÊÄÅ
        if (currentPos === puzzleGameState.selectedIdx) {
            piece.classList.add('selected');
        }

        // ÁÇπÂáª‰∫ã‰ª∂
        piece.onclick = () => handlePieceClick(currentPos);
        
        // --- Ê≠£Èù¢ÔºöÂõæÁâáÂàáÁâá ---
        const face = document.createElement('div');
        face.className = 'puzzle-face';
        face.style.backgroundImage = `url(${puzzleCurrentImgData})`;
        
        // ËÆ°ÁÆóËÉåÊôØÂÅèÁßª (Ê†πÊçÆ pVal ÂéüÂßã‰ΩçÁΩÆ)
        const bgX = (pVal % 3) * 100;
        const bgY = Math.floor(pVal / 3) * 100;
        face.style.backgroundPosition = `-${bgX}px -${bgY}px`;
        
        // --- ËÉåÈù¢ÔºöÊïÖ‰∫ã ---
        const back = document.createElement('div');
        back.className = 'puzzle-back';
        back.innerText = puzzleGameState.stories[pVal] || "???";
        
        piece.appendChild(face);
        piece.appendChild(back);
        board.appendChild(piece);
    });
}

// C. ÁÇπÂáª‰∫§‰∫íÔºöÂ§ÑÁêÜÈÄâ‰∏≠Âíå‰∫§Êç¢
function handlePieceClick(clickedPos) {
    // 1. Â¶ÇÊûúÂ∑≤ÊãºÂ•ΩÔºåÁÇπÂáªÁøªËΩ¨ÁúãÊïÖ‰∫ã
    if (puzzleGameState.isSolved) {
        const piece = document.getElementById('puzzle-board').children[clickedPos];
        piece.classList.toggle('flipped');
        return;
    }

    // 2. Ê∏∏ÊàèËøõË°å‰∏≠ÔºöÈÄâ‰∏≠ÈÄªËæë
    if (puzzleGameState.selectedIdx === -1) {
        // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºöÈÄâ‰∏≠
        puzzleGameState.selectedIdx = clickedPos;
        renderBoardByState(); // Âà∑Êñ∞‰ª•ÊòæÁ§∫È´ò‰∫Æ
    } else if (puzzleGameState.selectedIdx === clickedPos) {
        // ÁÇπ‰∫ÜÂêå‰∏Ä‰∏™ÔºöÂèñÊ∂àÈÄâ‰∏≠
        puzzleGameState.selectedIdx = -1;
        renderBoardByState(); // Âà∑Êñ∞‰ª•ÂèñÊ∂àÈ´ò‰∫Æ
    } else {
        // ÁÇπ‰∫Ü‰∏çÂêåÁöÑÔºö‰∫§Êç¢ÔºÅ
        const prevIdx = puzzleGameState.selectedIdx;
        
        // ‰∫§Êç¢Êï∞ÁªÑÊï∞ÊçÆ
        const temp = puzzleGameState.pieces[prevIdx];
        puzzleGameState.pieces[prevIdx] = puzzleGameState.pieces[clickedPos];
        puzzleGameState.pieces[clickedPos] = temp;
        
        // ‰∫§Êç¢ÂÆåÊàêÔºåÂèñÊ∂àÈÄâ‰∏≠
        puzzleGameState.selectedIdx = -1;
        
        // ÈáçÊñ∞Ê∏≤Êüì (‰ΩçÁΩÆÂèò‰∫Ü)
        renderBoardByState();
        
        // Ê£ÄÊü•ËÉúÂà©
        checkWin();
    }
}

// D. ËÉúÂà©Ê£ÄÊµã
function checkWin() {
    const isWin = puzzleGameState.pieces.every((val, index) => val === index);
    
    if (isWin) {
        puzzleGameState.isSolved = true;
        document.getElementById('puzzle-status-text').innerHTML = `<span style="color:#00b894; font-size:1.1rem;">üéâ ÊãºÂõæÂÆåÊàêÔºÅÁÇπÂáªÁ¢éÁâáÁøªÁúãÂõûÂøÜ„ÄÇ</span>`;
        document.getElementById('puzzle-board').style.border = "3px solid #00b894";
        
        // Ëá™Âä®‰øùÂ≠ò
        const data = getPuzzleData();
        data.history.unshift({
            id: Date.now(),
            date: new Date().toLocaleString(),
            img: puzzleCurrentImgData,
            stories: puzzleGameState.stories,
            cards: document.getElementById('puzzle-cards-display').innerText
        });
        savePuzzleData(data);
        
        alert("‚ú® ËÆ∞ÂøÜÂ∑≤ÈáçÁªÑÂÆåÊØïÔºÅ\nÁé∞Âú®ÁÇπÂáªÊãºÂõæÁ¢éÁâáÔºåÊü•ÁúãËÉåÂêéÁöÑÊïÖ‰∫ãÂêß„ÄÇ");
    }
}

// E. ÊîæÂºÉÈáçÁΩÆ
window.resetPuzzleGame = function() {
    if(!confirm("ÊîæÂºÉÂΩìÂâçÁöÑÊãºÂõæÔºü")) return;
    puzzleCurrentImgData = null;
    switchPuzzleView('create');
};
// 7. ÂéÜÂè≤ËÆ∞ÂΩïÂäüËÉΩ
function renderPuzzleHistory() {
    const list = getPuzzleData().history || [];
    const container = document.getElementById('puzzle-history-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÊöÇÊó†ÊãºÂõæËÆ∞ÂøÜ</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '15px';
        
        div.innerHTML = `
            <div class="puzzle-history-thumb" style="background-image:url(${item.img})"></div>
            <div style="margin-top:10px; font-size:0.8rem; color:#888;">${item.date}</div>
            <div style="font-size:0.8rem; color:#6c5ce7; margin-bottom:10px;">üîÆ ${item.cards}</div>
            <div style="display:flex; gap:10px;">
                <button class="m-btn small" onclick="loadPuzzleHistory(${index})" style="flex:1;">üß© ÂõûÈ°æÊãºÂõæ</button>
                <button class="m-btn small" onclick="deletePuzzleHistory(${index})" style="background:#ffcdd2; color:red;">Âà†Èô§</button>
            </div>
        `;
        container.appendChild(div);
    });
}

window.deletePuzzleHistory = function(index) {
    if(!confirm("Âà†Èô§Ëøô‰ªΩËÆ∞ÂøÜÔºü")) return;
    const data = getPuzzleData();
    data.history.splice(index, 1);
    savePuzzleData(data);
    renderPuzzleHistory();
};

window.loadPuzzleHistory = function(index) {
    const item = getPuzzleData().history[index];
    puzzleCurrentImgData = item.img;
    puzzleGameState.stories = item.stories;
    puzzleGameState.isSolved = true; // ÂéÜÂè≤ËÆ∞ÂΩïÁõ¥Êé•ÊòØÊãºÂ•ΩÁöÑ
    puzzleGameState.pieces = [0,1,2,3,4,5,6,7,8]; // Ê≠£Â∫è
    
    document.getElementById('puzzle-cards-display').innerText = item.cards;
    document.getElementById('puzzle-status-text').innerHTML = `<span style="color:#00b894">üéâ ÂéÜÂè≤ÂõûÈ°æÊ®°Âºè (ÂèØÁõ¥Êé•ÁøªÁúã)</span>`;
    
    renderBoardByState();
    
    document.getElementById('puzzle-app-modal').style.display = 'flex';
    document.getElementById('puzzle-create-view').style.display = 'block';
    document.getElementById('puzzle-history-view').style.display = 'none';
    document.getElementById('puzzle-upload-panel').style.display = 'none';
    document.getElementById('puzzle-game-panel').style.display = 'flex';
    
    // ÂéÜÂè≤ÁïåÈù¢‰πüÈúÄË¶ÅÈ´ò‰∫ÆËæπÊ°Ü
    document.getElementById('puzzle-board').style.border = "3px solid #00b894";
};

// üî¥ ÂÖ≥ÈîÆÔºöÂ∞Ü puzzle_data Ê∑ªÂä†Âà∞Êó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÂàóË°®
if (typeof loadAllBigData === 'function') {
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad(); 
        try {
            let res = await idb.get('universal_store', 'puzzle_data');
            if(res) window.BIG_MEMORY.puzzle_data = res.data;
        } catch(e){}
    }
}
// ==================== üìã Â∑•‰ΩúÊó•Êä• APP Ê†∏ÂøÉÈÄªËæë ====================

let workDeck = [];
let workFlipped = [];

// 1. Êó†ÈôêÂ≠òÂÇ®ÂàùÂßãÂåñ
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
if (!window.BIG_MEMORY.work_data) window.BIG_MEMORY.work_data = []; // ÁÆÄÂçïÁöÑÊï∞ÁªÑÁªìÊûÑÂ≠òÂéÜÂè≤

function getWorkData() { return window.BIG_MEMORY.work_data || []; }

function saveWorkData(list) {
    window.BIG_MEMORY.work_data = list;
    // üî• Âº∫Âà∂ÂÜôÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'work_data', data: list });
}

// 2. ÊâìÂºÄ APP
window.openWorkApp = function() {
    document.getElementById('work-app-modal').style.display = 'flex';
    switchWorkView('create');
    
    // Â¶ÇÊûúÊúâÊúÄÊñ∞ÁöÑ‰∏ÄÊù°ÔºåÊòæÁ§∫Âú®È¶ñÈ°µ
    const list = getWorkData();
    if(list.length > 0) {
        renderWorkReportCard(list[0], 'work-latest-report');
        document.getElementById('work-latest-report').style.display = 'block';
    } else {
        document.getElementById('work-latest-report').style.display = 'none';
    }
};

window.switchWorkView = function(mode) {
    const createEl = document.getElementById('work-create-view');
    const histEl = document.getElementById('work-history-view');
    const btnCreate = document.getElementById('btn-work-create');
    const btnHist = document.getElementById('btn-work-history');

    if (mode === 'create') {
        createEl.style.display = 'block';
        histEl.style.display = 'none';
        btnCreate.style.background = '#57606f'; btnCreate.style.color = '#fff';
        btnHist.style.background = '#a4b0be';
    } else {
        createEl.style.display = 'none';
        histEl.style.display = 'block';
        renderWorkHistory();
        btnCreate.style.background = '#a4b0be'; 
        btnHist.style.background = '#57606f'; btnHist.style.color = '#fff';
    }
};

// 3. ÂêØÂä®ÊäΩÁâå (Áã¨Á´ãÁâåÊ°å)
window.startWorkDraw = function() {
    const modal = document.getElementById('work-card-table-modal');
    const area = document.getElementById('work-card-area');
    const desk = document.getElementById('work-card-table-desk');

    // Â∫îÁî®ÁæéÂåñËÉåÊôØ
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    workDeck = []; workFlipped = [];
    document.getElementById('work-flipped-count').innerText = '0';

    // ÁîüÊàê114Âº†Áâå
    for(let i=0; i<=77; i++) workDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) workDeck.push({ type:'lenormand', id:i, isReversed:false });
    workDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4;
    const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    workDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                workFlipped = workFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                workFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) front.style.backgroundImage=`url(${res.data})`; 
                    else { front.style.background="#fff"; front.innerText=card.id; }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('work-flipped-count').innerText = workFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};
// 4. API ÁîüÊàê (ËûçÂêàÁâàÔºö‰øÆÂ§ç‰∫ÜËøûÊé•ÈóÆÈ¢ò + ‰øùÁïô‰∫ÜÂéüÁâàËØ¶ÁªÜÊèêÁ§∫ËØç)
window.finishWorkDraw = async function() {
    if(workFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#work-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üíº Ê≠£Âú®Êï¥ÁêÜÂ∑•‰ΩúËÆ∞ÂΩï...";

    // 1. ÂáÜÂ§áÂü∫Á°ÄÊï∞ÊçÆ
    const cardsDesc = workFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    // 2. ‰øÆÂ§ç API ËØªÂèñÈÄªËæë (‰ºòÂÖàËØªÂèñÁºìÂ≠òÔºåÈò≤Ê≠¢ËÆæÁΩÆ‰∏∫Á©∫ÂØºËá¥ËøûÊé•Â§±Ë¥•)
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;

    if (!apiKey) {
        try {
            const saved = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
            apiKey = saved.key;
            apiUrl = saved.url;
            model = saved.model;
        } catch (e) {}
    }

    if (!apiKey) {
        btn.innerText = oldText; 
        btn.disabled = false;
        return alert("‚ùå ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    }
    // Â§ÑÁêÜÈªòËÆ§ÂÄº
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";
    if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
    if (!model) model = "gpt-3.5-turbo";

    // 3. ÂéüÁâàËØ¶ÁªÜÊèêÁ§∫ËØç (ÂÆåÂÖ®‰øùÁïô‰Ω†ÁöÑË¶ÅÊ±Ç)
    const prompt = `
‰Ω†Áé∞Âú®ÊòØ‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤„ÄÇ‰Ω†ÈúÄË¶ÅÊ†πÊçÆ‰ªäÂ§©ÁöÑ„ÄêÂëΩËøêÁâå„ÄëÂ°´ÂÜô‰∏Ä‰ªΩ„ÄêÂ∑•‰ΩúÊó•Êä•„Äë„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„Äê‰ªäÊó•ÂëΩËøêÁâå (‰Ωú‰∏∫ËÉΩÈáèÊµÅÂä®ÂíåÁ¨¨ÂÖ≠ÊÑüËÅîÊÉ≥ÁöÑ‰æùÊçÆ)„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑Â∞ÜÁâåÊÑèÊ∑±Â∫¶ËûçÂÖ•ÔºåÁîüÊàê‰ª•‰∏ãÂÜÖÂÆπÔºö

1. **‰ªäÊó•‰ªªÂä°**Ôºö
   - ÁÆÄËø∞‰ªäÂ§©ÁöÑ‰∏ªË¶Å‰ªªÂä°„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÂ∑•‰ΩúÔºåËØ∑ËØ¥ÊòéÊòØÂú®‰ºëÊÅØËøòÊòØÂ§ÑÁêÜÁßÅ‰∫ã„ÄÇ

2. **Â∑•‰ΩúËØ¶ÁªÜ (ÈáçÁÇπ)**Ôºö
   - **Â∑•ÂÖ∑ÊèèËø∞**ÔºöÂøÖÈ°ªËØ¶ÁªÜÊèèÂÜô‰ΩøÁî®ÁöÑÂ∑•ÂÖ∑ÔºàÂ¶ÇÊûúÊòØÊùÄÊâãËØ∑ÊèèÂÜôÊ≠¶Âô®ÁªÜËäÇÔºåÂ¶ÇÊûúÊòØÊñáËÅåËØ∑ÊèèÂÜôÈí¢Á¨îÊàñÁîµËÑëÂûãÂè∑ÔºåÊ≥ïÂ∏àÊèèÂÜôÊ≥ïÊùñÁ≠âÔºâ„ÄÇ
   - **ËøáÁ®ã**ÔºöÁªìÂêàÁâåÊÑèÊèèÂÜôÂ∑•‰ΩúËøáÁ®ã‰∏≠ÁöÑÈ°∫ÁïÖÊàñÈòªÁ¢ç„ÄÇ

3. **ÂêêÊßΩ (Rant)**Ôºö
   - ËøôÈáåÊòØËßíËâ≤ÊÉ≥ÂØπÁî®Êà∑Ôºà‰Ω†ÔºâÁßÅ‰∏ãËØ¥ÁöÑËØù„ÄÇ
   - ÂèØ‰ª•ÊòØÊä±ÊÄ®ËÄÅÊùøÂÇª„ÄÅÂÆ¢Êà∑ÁÉ¶ÔºåÊàñËÄÖÂçïÁ∫ØÊòØÊÉ≥ÂøµÁî®Êà∑„ÄÇËØ≠Ê∞îË¶Å‰∫≤ÂØÜ„ÄÅÁúüÂÆû„ÄÇ

4. **Âêå‰∫ãÁõ∏ÂÖ≥**Ôºö
   - **ËØÑ‰ª∑**ÔºöÂØπ‰ªäÂ§©Êé•Ëß¶ÁöÑÂêå‰∫ãÁöÑÁúãÊ≥ïÔºàÊòØÁå™ÈòüÂèãËøòÊòØÁ•ûÂä©ÊîªÔºüÔºâ„ÄÇ
   - **ÂØπËØù**ÔºöËÆ∞ÂΩï‰∏ÄÂè•‰ªäÂ§©ÂíåÂêå‰∫ãËØ¥‰∫Ü‰ªÄ‰πàÔºàÊàñÂê¨Âà∞‰∫Ü‰ªÄ‰πàÂÖ´Âç¶Ôºâ„ÄÇ

5. **ÊòéÊó•ËÆ°Âàí**Ôºö
   - ÊòéÂ§©ÊúâÊ≤°ÊúâÂ∑•‰ΩúÔºüËøòÊòØ‰ºëÂÅáÔºü

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Ê†ºÂºèÔºå‰∏çË¶Å MarkdownÔºö
{
  "date": "YYYY-MM-DD",
  "tasks": "‰ªäÊó•‰ªªÂä°Ê¶ÇË¶Å...",
  "details": "ËØ¶ÁªÜÂ∑•‰ΩúËøáÁ®ãÔºàÂåÖÂê´Â∑•ÂÖ∑ÊèèÂÜôÔºâ...",
  "rant": "ÂØπÁî®Êà∑ÁöÑÁßÅ‰∏ãÂêêÊßΩ...",
  "colleagues": "Âêå‰∫ãËØÑ‰ª∑ÂèäÂØπËØù...",
  "tomorrow": "ÊòéÊó•ÂÆâÊéí..."
}
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a roleplay character. Output JSON only."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });

        const json = await res.json();
        
        // ÈîôËØØÂ§ÑÁêÜ
        if (json.error) throw new Error(json.error.message || "API Error");

        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const first = raw.indexOf('{'); const last = raw.lastIndexOf('}');
        if(first!==-1 && last!==-1) raw = raw.substring(first, last+1);
        
        const result = JSON.parse(raw);
        
        // Ë°•ÂÖÖÊï∞ÊçÆ
        result.id = Date.now();
        result.cards = cardsDesc;
        
        // ‰øùÂ≠òÈÄªËæë
        const list = getWorkData();
        list.unshift(result);
        saveWorkData(list);
        
        // UI ÂàáÊç¢
        document.getElementById('work-card-table-modal').style.display = 'none';
        renderWorkReportCard(result, 'work-latest-report');
        document.getElementById('work-latest-report').style.display = 'block';

    } catch(e) {
        console.error(e);
        alert("‚ùå ÁîüÊàêÂ§±Ë¥•: " + e.message + "\nËØ∑Ê£ÄÊü• API ËÆæÁΩÆÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};
// 5. Ê∏≤ÊüìÂç°Áâá (Â§çÁî®ÂáΩÊï∞)
window.renderWorkReportCard = function(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    const div = document.createElement('div');
    div.className = 'morandi-card';
    div.style.background = '#fff';
    div.style.borderLeft = '5px solid #57606f';
    div.style.padding = '20px';
    
    div.innerHTML = `
        <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px; display:flex; justify-content:space-between;">
            <span style="font-weight:bold; font-size:1.1rem; color:#2f3542;">üìë Â∑•‰ΩúÊó•Êä•</span>
            <span style="font-size:0.8rem; color:#a4b0be;">${data.date}</span>
        </div>
        
        <div style="margin-bottom:15px;">
            <strong style="color:#57606f;">üìå ‰ªäÊó•‰ªªÂä°</strong>
            <div style="font-size:0.95rem; color:#2f3542; margin-top:5px;">${data.tasks}</div>
        </div>

        <div style="margin-bottom:15px; background:#f1f2f6; padding:10px; border-radius:6px;">
            <strong style="color:#57606f;">üî® Â∑•‰ΩúËØ¶ÊÉÖ & Â∑•ÂÖ∑</strong>
            <div style="font-size:0.9rem; color:#57606f; margin-top:5px; line-height:1.6;">${data.details}</div>
        </div>

        <div style="margin-bottom:15px;">
            <strong style="color:#e17055;">üí¨ ÊÉ≥ÂØπ‰Ω†ÂêêÊßΩ</strong>
            <div style="font-size:0.9rem; color:#e17055; margin-top:5px; font-style:italic;">‚Äú${data.rant}‚Äù</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.85rem;">
            <div>
                <strong>üë• Âêå‰∫ãËØÑ‰ª∑</strong><br>
                <span style="color:#747d8c;">${data.colleagues}</span>
            </div>
            <div>
                <strong>üìÖ ÊòéÊó•ÂÆâÊéí</strong><br>
                <span style="color:#747d8c;">${data.tomorrow}</span>
            </div>
        </div>
        
        <div style="margin-top:15px; font-size:0.7rem; color:#ccc; text-align:right;">
            üîÆ ËÉΩÈáèÊù•Ê∫ê: ${data.cards || 'Êú™Áü•'}
        </div>
    `;
    
    container.appendChild(div);
};

// 6. Ê∏≤ÊüìÂéÜÂè≤ÂàóË°®
window.renderWorkHistory = function() {
    const list = getWorkData();
    const container = document.getElementById('work-history-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '15px';
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold;">${item.date}</span>
                <span style="color:red; cursor:pointer;" onclick="deleteWorkLog(${index})">Âà†Èô§</span>
            </div>
            <div style="font-size:0.9rem; color:#2f3542;">‰ªªÂä°Ôºö${item.tasks.substring(0, 20)}...</div>
            <button class="m-btn small" onclick="viewWorkDetail(${index})" style="width:100%; margin-top:10px; background:#dfe4ea; color:#2f3542;">Êü•ÁúãËØ¶ÊÉÖ</button>
        `;
        container.appendChild(div);
    });
};

window.viewWorkDetail = function(index) {
    const list = getWorkData();
    const item = list[index];
    switchWorkView('create');
    renderWorkReportCard(item, 'work-latest-report');
    document.getElementById('work-latest-report').style.display = 'block';
};

window.deleteWorkLog = function(index) {
    if(!confirm("Á°ÆÂÆöÈîÄÊØÅËøô‰ªΩÊ°£Ê°àÔºü")) return;
    const list = getWorkData();
    list.splice(index, 1);
    saveWorkData(list);
    renderWorkHistory();
};

// 7. „ÄêÂÖ≥ÈîÆ„ÄëÊ≥®ÂÜåÊï∞ÊçÆÂä†ËΩΩË°•‰∏Å (Á°Æ‰øù work_data Ë¢´Âä†ËΩΩ)
if (typeof loadAllBigData === 'function') {
    const _origLoad = loadAllBigData;
    window.loadAllBigData = async function() {
        await _origLoad(); // ÂÖàË∑ëÂéüÊù•ÁöÑ
        try {
            let res = await idb.get('universal_store', 'work_data');
            if(res) window.BIG_MEMORY.work_data = res.data;
        } catch(e){}
    }
}
// === ÊâæÂà∞ËøôÊÆµ‰ª£Á†Å (Â§ßÁ∫¶Âú® 3280Ë°åÂ∑¶Âè≥) ===
window.addEventListener('load', function() {
    console.log("Ê≠£Âú®ÂàùÂßãÂåñÊó†ÈôêÂ≠òÂÇ®Á≥ªÁªü...");
    idb.init().then(async () => {
        await loadAllBigData();
        loadTVContent();
        if(typeof loadGameWidgetTheme === 'function') loadGameWidgetTheme();
        try { await idb.get('settings_heavy', 'myAvatar'); } catch(e){}
        
        console.log("‚úÖ Êó†ÈôêÂÆπÈáèÁ≥ªÁªüÂ∑≤Â∞±Áª™ÔºÅ");
    });
});
// ÂÖ®Â±ÄÂèòÈáèÁî®‰∫éÂ≠òÂÇ®ÊâìÂåÖÂ•ΩÁöÑÊñá‰ª∂
let pendingBackupFile = null;

async function exportFullBackup() {
    const btn = event.target;
    
    // === Èò∂ÊÆµ‰∫åÔºöÁî®Êà∑ÁÇπÂáªÁªøËâ≤ÊåâÈíÆÔºåËß¶Âèë‰∏ãËΩΩ/ÂàÜ‰∫´ ===
    if (pendingBackupFile) {
        // 1. ‰ºòÂÖàÂ∞ùËØïÂéüÁîüÂàÜ‰∫´ (iOS/Android ÈÄöÁî®Ôºå‰ΩìÈ™åÊúÄÂ•Ω)
        if (navigator.canShare && navigator.canShare({ files: [pendingBackupFile] })) {
            try {
                await navigator.share({
                    files: [pendingBackupFile],
                    title: 'RetroOS_Backup',
                    text: 'RetroOS Êï∞ÊçÆÂ§á‰ªΩ'
                });
                resetExportBtn(btn);
                return;
            } catch (e) { console.log("ÂàÜ‰∫´ÂèñÊ∂àÊàñ‰∏çÊîØÊåÅÔºåÂ∞ùËØïÁõ¥Êé•‰∏ãËΩΩ"); }
        }

        // 2. ‰º†Áªü‰∏ãËΩΩÊñπÂºè (ÈíàÂØπ APK/PC/‰∏çÊîØÊåÅÂàÜ‰∫´ÁöÑÊµèËßàÂô®)
        try {
            const url = URL.createObjectURL(pendingBackupFile);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            // ÂÆâÂçì APK ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊñá‰ª∂ÂêçÂøÖÈ°ªÈùûÂ∏∏Ê†áÂáÜ
            a.download = `RetroOS_${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a);
            a.click();
            
            // Âª∂ËøüÊ∏ÖÁêÜÔºåÁªôÂÆâÂçì‰∏ÄÁÇπÂèçÂ∫îÊó∂Èó¥
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                resetExportBtn(btn);
            }, 5000); 
        } catch (e) { alert("‰∏ãËΩΩÂêØÂä®Â§±Ë¥•: " + e.message); }
        return;
    }

    // === Èò∂ÊÆµ‰∏ÄÔºöÂàÜÂùóÊâìÂåÖÊï∞ÊçÆ ===
    if(btn.getAttribute('data-processing')) return;
    btn.setAttribute('data-processing', 'true');
    
    btn.innerText = "üì¶ Ê≠£Âú®ÊâìÂåÖ (ËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢)...";
    btn.style.opacity = "0.7";

    try {
        const jsonChunks = []; 

        // 1. ÂÜôÂÖ•Â§¥ÈÉ®
        jsonChunks.push('{"meta":{"version":"5.0_Stable","date":"' + new Date().toLocaleString() + '","app":"RetroOS_Backup"},');

        // 2. Ëé∑Âèñ Big Memory (ÊñáÂ≠óÈÖçÁΩÆ)
        // Á°Æ‰øù‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄÊñ∞
        const allUniversal = await idb.getAll('universal_store');
        const universalObj = {};
        allUniversal.forEach(item => { universalObj[item.id] = item.data; });
        const finalMemory = { ...window.BIG_MEMORY, ...universalObj };
        
        jsonChunks.push('"big_memory":' + JSON.stringify(finalMemory) + ',');

        // 3. Â§ÑÁêÜÂ§ßÂûã Store (‰ΩøÁî®Ê∏∏Ê†áÔºåÈò≤Ê≠¢ËØªÂèñÊó∂Â∞±ÁàÜÂÜÖÂ≠ò)
        async function streamStore(keyName, storeName) {
            jsonChunks.push(`"${keyName}": [`);
            let count = 0;
            const tx = idb.db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            let cursorReq = store.openCursor();

            await new Promise((resolve, reject) => {
                cursorReq.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (count > 0) jsonChunks.push(','); 
                        jsonChunks.push(JSON.stringify(cursor.value)); 
                        count++;
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                cursorReq.onerror = reject;
            });
            jsonChunks.push('],');
            console.log(`‚úÖ ${storeName} ÊâìÂåÖÂÆåÊàê: ${count} Êù°`);
        }

        // ÂàÜÂà´ÊâìÂåÖËÅäÂ§©ËÆ∞ÂΩïÂíåÂÖ∂‰ªñÊï∞ÊçÆ
        await streamStore('chat_history', 'chat_history');
        await streamStore('pickup_data', 'pickup_data');

        // 4. ÂõæÁâáÂ∫ì (ÊéíÈô§Êñá‰ª∂APPÈáåÁöÑÂ°îÁΩóÁâå‰ª•ËäÇÁúÅÂÜÖÂ≠ò)
        jsonChunks.push('"image_stores": {');
        const imageStoresToBackup = [
            'album_data',       
            'settings_heavy',   
            'chat_stickers',    
            'anniversary_data', 
            'tv'
            // Ê≥®ÊÑèÔºöËøôÈáåÊ≤°Êúâ tarot_deck Âíå lenormand_deckÔºåËøôÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢Êñá‰ª∂ËøáÂ§ß
        ];

        for (let i = 0; i < imageStoresToBackup.length; i++) {
            const storeName = imageStoresToBackup[i];
            jsonChunks.push(`"${storeName}":`);
            const items = await idb.getAll(storeName);
            jsonChunks.push(JSON.stringify(items));
            if (i < imageStoresToBackup.length - 1) jsonChunks.push(',');
        }

        jsonChunks.push('}}'); // ÁªìÊùü JSON

        // 5. ÁîüÊàêÊñá‰ª∂ (‰ΩøÁî® octet-stream Âº∫Âà∂ÊµèËßàÂô®‰Ωú‰∏∫Êñá‰ª∂‰∏ãËΩΩ)
        const blob = new Blob(jsonChunks, { type: "application/octet-stream" });
        const sizeMB = blob.size / 1024 / 1024;
        const fileName = `RetroOS_${new Date().toISOString().slice(0,10)}.json`;

        pendingBackupFile = new File([blob], fileName, { type: "application/octet-stream" });

        // 6. ÊåâÈíÆÂèòÁªøÔºåÁ≠âÂæÖÁî®Êà∑‰∫åÊ¨°ÁÇπÂáª
        btn.removeAttribute('data-processing');
        btn.setAttribute('data-ready', 'true');
        btn.innerText = `‚úÖ ÊâìÂåÖÊàêÂäü (${sizeMB.toFixed(1)}MB) ÁÇπÂáª‰øùÂ≠ò`;
        btn.style.background = "#06c755";
        btn.style.color = "white";
        btn.style.fontWeight = "bold";
        btn.style.opacity = "1";

    } catch (e) {
        console.error(e);
        alert("ÊâìÂåÖÂ§±Ë¥• (ÂÜÖÂ≠ò‰∏çË∂≥): " + e.message);
        resetExportBtn(btn);
    }
}

function resetExportBtn(btn) {
    btn.innerText = "üì§ ÂØºÂá∫Â§á‰ªΩ (.json)";
    btn.style.background = "";
    btn.style.color = "";
    btn.style.opacity = "1";
    btn.removeAttribute('data-ready');
    btn.removeAttribute('data-processing');
    pendingBackupFile = null;
}
async function importFullRestore(input) {
    const file = input.files[0];
    if (!file) return;

    // 1. Ë≠¶ÂëäÊèêÁ§∫
    if (!confirm(`‚ö†Ô∏è È´òËÉΩÈ¢ÑË≠¶ÔºöÊÅ¢Â§çÂ§á‰ªΩÂ∞Ü„ÄêË¶ÜÁõñ„ÄëÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ\nÊñá‰ª∂Â§ßÂ∞è: ${(file.size/1024/1024).toFixed(2)}MB\n\nÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü`)) {
        input.value = '';
        return;
    }

    const statusEl = document.querySelector('.modal-header span'); 
    const originalTitle = statusEl.innerText;
    statusEl.innerText = "‚è≥ Ê≠£Âú®ÂàÜÊûêÊñá‰ª∂ (ËØ∑ÂãøÊìç‰Ωú)...";

    const reader = new FileReader();
    
    // ‰ΩøÁî® readAsText ËØªÂèñÊï¥‰∏™Êñá‰ª∂ (ËøôÊ≠•ÈÄöÂ∏∏‰∏ç‰ºöÂ¥©ÔºåÂ¥©ÁöÑÊòØ parse)
    reader.readAsText(file);

    reader.onload = async (e) => {
        const rawText = e.target.result;
        
        try {
            console.log("ÂºÄÂßãÊâãÂä®ÂàáÁâáËß£Êûê...");
            
            // === Ê†∏ÂøÉÈªëÁßëÊäÄÔºöÊâãÂä®ÊèêÂèñ JSON ÁâáÊÆµ ===
            // ËøôÁßçÊñπÊ≥ïÈÅøÂÖç‰∫ÜÂ∞ÜÊï¥‰∏™ 200MB Â≠óÁ¨¶‰∏≤ÂèòÊàêÂØπË±°ÔºåËÄåÊòØÂàáÊàêÂ∞èÂùóÂ§ÑÁêÜ
            
            // ËæÖÂä©ÂáΩÊï∞ÔºöÊü•ÊâæÂπ∂Ëß£ÊûêÊüê‰∏™ Key ÂØπÂ∫îÁöÑÂØπË±°/Êï∞ÁªÑ
            async function extractAndSave(keyName, storeName, isArray = true) {
                statusEl.innerText = `‚è≥ Ê≠£Âú®ÊÅ¢Â§ç: ${keyName}...`;
                
                // 1. ÊâæÂà∞ Key ÁöÑ‰ΩçÁΩÆ
                const keyIndex = rawText.indexOf(`"${keyName}":`);
                if (keyIndex === -1) return; // Ê≤°ÊâæÂà∞ÔºåË∑≥Ëøá

                // 2. ÊâæÂà∞ÂÄºÁöÑÂºÄÂßã‰ΩçÁΩÆ (Key ‰πãÂêéÁ¥ßÊé•ÁùÄÁöÑ [ Êàñ {)
                let startSearch = keyIndex + keyName.length + 2; 
                let startIndex = -1;
                let openChar = isArray ? '[' : '{';
                let closeChar = isArray ? ']' : '}';
                
                // ÁÆÄÂçïÁöÑÊü•ÊâæËµ∑ÂßãÁ¨¶Âè∑
                for(let i = startSearch; i < startSearch + 100; i++) {
                    if (rawText[i] === openChar) {
                        startIndex = i;
                        break;
                    }
                }
                if (startIndex === -1) return;

                // 3. Êô∫ËÉΩÊü•ÊâæÁªìÊùü‰ΩçÁΩÆ (Â§ÑÁêÜÂµåÂ•óÊã¨Âè∑)
                let balance = 0;
                let endIndex = -1;
                let inQuote = false; // ÊòØÂê¶Âú®ÂºïÂè∑ÂÜÖ (Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤ÈáåÁöÑÊã¨Âè∑)
                
                for (let i = startIndex; i < rawText.length; i++) {
                    const char = rawText[i];
                    
                    if (char === '"' && rawText[i-1] !== '\\') {
                        inQuote = !inQuote; // ÂàáÊç¢ÂºïÂè∑Áä∂ÊÄÅ
                    }
                    
                    if (!inQuote) {
                        if (char === openChar) balance++;
                        else if (char === closeChar) balance--;
                    }

                    if (balance === 0) {
                        endIndex = i + 1;
                        break;
                    }
                }

                if (endIndex === -1) return; // Ê≤°ÊâæÂà∞ÁªìÂ∞æ

                // 4. ÂàáÂâ≤Â≠óÁ¨¶‰∏≤Âπ∂Ëß£Êûê (Âè™Ëß£ÊûêËøô‰∏ÄÂùóÔºÅ)
                const jsonChunk = rawText.substring(startIndex, endIndex);
                const dataChunk = JSON.parse(jsonChunk);

                // 5. Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
                if (isArray) {
                    // Â¶ÇÊûúÊòØÊï∞ÁªÑ (Â¶Ç chat_history)ÔºåÊ∏ÖÁ©∫ÊóßÁöÑÂπ∂Â≠òÂÖ•
                    if (storeName) {
                        await idb.clear(storeName);
                        const tx = idb.db.transaction([storeName], 'readwrite');
                        const store = tx.objectStore(storeName);
                        for (let item of dataChunk) {
                            store.put(item);
                        }
                        await new Promise(resolve => tx.oncomplete = resolve);
                    }
                } else {
                    // Â¶ÇÊûúÊòØÂØπË±° (Â¶Ç big_memory)
                    if (keyName === 'big_memory') {
                        window.BIG_MEMORY = dataChunk;
                        for (let k in dataChunk) {
                            await idb.put('universal_store', { id: k, data: dataChunk[k] });
                        }
                    } else if (keyName === 'image_stores') {
                        // Â§ÑÁêÜ image_stores ÈáåÁöÑÂ≠êÈ°π
                        for (let subKey in dataChunk) {
                            // ËøôÈáåÂ§çÁî®ÈÄªËæëÔºåsubKey Â∞±ÊòØ storeName (Â¶Ç album_data)
                            if (dataChunk[subKey] && Array.isArray(dataChunk[subKey])) {
                                await idb.clear(subKey);
                                const tx = idb.db.transaction([subKey], 'readwrite');
                                const store = tx.objectStore(subKey);
                                dataChunk[subKey].forEach(item => store.put(item));
                                await new Promise(resolve => tx.oncomplete = resolve);
                            }
                        }
                    }
                }
                
                // 6. Âº∫Âà∂ÂûÉÂúæÂõûÊî∂Âª∫ËÆÆ (Ëß£Èô§ÂºïÁî®)
                // dataChunk = null; 
            }

            // === ÊåâÈ°∫Â∫èÊâßË°åÊâãÂä®Ëß£Êûê ===
            
            // 1. ÊÅ¢Â§ç big_memory (Ê†∏ÂøÉÊñáÂ≠óÊï∞ÊçÆ)
            await extractAndSave('big_memory', null, false);
            
            // 2. ÊÅ¢Â§çËÅäÂ§©ËÆ∞ÂΩï (ÊúÄÂÆπÊòìÂ¥©ÁöÑÂú∞Êñπ)
            await extractAndSave('chat_history', 'chat_history', true);
            await extractAndSave('pickup_data', 'pickup_data', true);
            
            // 3. ÊÅ¢Â§çÂõæÁâáÂ∫ì (Ëøô‰∏ÄÂùóÂèØËÉΩ‰æùÁÑ∂ÂæàÂ§ßÔºå‰ΩÜÊàë‰ª¨ÊòØ‰∏ÄÊ¨°Ëß£Êûê‰∏ÄÈÉ®ÂàÜ)
            // Ê≥®ÊÑèÔºöÂõ†‰∏∫ image_stores ÂÜÖÈÉ®ÊòØ‰∏Ä‰∏™Â§ßÂØπË±°ÔºåÂ¶ÇÊûúÂÆÉÂ§™Â§ßÔºåËøòÊòØ‰ºöÂç°„ÄÇ
            // ‰ΩÜÂõ†‰∏∫Êàë‰ª¨ÊéíÈô§‰∫ÜÂ°îÁΩóÁâåÔºåËøôÈáåÂ∫îËØ•ËÉΩËøá„ÄÇ
            await extractAndSave('image_stores', null, false);

            alert("üéâ Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ\nÈ°µÈù¢Âç≥Â∞ÜÂà∑Êñ∞...");
            location.reload();

        } catch (err) {
            console.error(err);
            alert("‚ùå ÊÅ¢Â§çËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ (ÂèØËÉΩÊòØÊñá‰ª∂ÊçüÂùèÊàñ‰æùÁÑ∂Ë∂ÖÂá∫ÂÜÖÂ≠òÈôêÂà∂):\n" + err.message);
            statusEl.innerText = originalTitle;
        }
    };
    
    input.value = ''; 
}
const NotificationManager = {
    requestPermission: function() {
        // ‰øÆÊîπÔºöÂ¢ûÂä†ÊèêÁ§∫ÔºåÂëäÁü•Áî®Êà∑ APK ÁéØÂ¢ÉÂèØËÉΩ‰ªÖÊîØÊåÅÂ∫îÁî®ÂÜÖÈÄöÁü•
        if (!("Notification" in window)) {
            return alert("Ê≠§ËÆæÂ§á/ÂÆπÂô®‰∏çÊîØÊåÅÂéüÁîüÁ≥ªÁªüÈÄöÁü•ÔºåÂ∞Ü‰ΩøÁî®AppÂÜÖÂºπÁ™óÊõø‰ª£„ÄÇ");
        }
        
        // ÂÖºÂÆπÂÜôÊ≥ïÔºöÂêåÊó∂ÊîØÊåÅ Promise Âíå ÂõûË∞ÉÔºåÈò≤Ê≠¢ÈÉ®ÂàÜÊóßÂÆâÂçì WebView Êä•Èîô
        Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
                this.send({ title: "ÈÄöÁü•ÊµãËØï", body: "ÊùÉÈôêËé∑ÂèñÊàêÂäüÔºÅ(Ëã•Êó†Áä∂ÊÄÅÊ†èÈÄöÁü•ÔºåËØ¥ÊòéAPK‰∏çÊîØÊåÅ)", icon: "üéâ" });
            } else {
                alert("ÊùÉÈôêË¢´ÊãíÁªùÊàñË¢´Êã¶Êà™„ÄÇÂ∞Ü‰ªÖ‰ΩøÁî®AppÂÜÖÂºπÁ™óÊèêÈÜí„ÄÇ");
            }
        }).catch(err => {
            console.log(err);
            // Âç≥‰ΩøÊä•Èîô‰πü‰∏çÂºπÁ™óÊâìÊâ∞Áî®Êà∑‰∫ÜÔºåÂèçÊ≠£‰ºöËá™Âä®ÈôçÁ∫ß‰∏∫ App ÂÜÖÂºπÁ™ó
        });
    },

    send: function({ title, body, icon = "üîî", tag = "default", onClick = null }) {
        // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë
        // Êó†ËÆ∫ÊòØÂú®ÂâçÂè∞ËøòÊòØÂêéÂè∞ÔºåÂßãÁªàÊòæÁ§∫ App ÂÜÖÁöÑÁæéÂåñÂºπÁ™ó (Toast)„ÄÇ
        // ËøôÊ†∑Âú®ÂÆâÂçì APK ÈáåÔºåÂç≥‰ΩøÂèë‰∏çÂá∫Á≥ªÁªüÈÄöÁü•ÔºåÁî®Êà∑‰πüËÉΩÁúãÂà∞ÊºÇ‰∫ÆÁöÑÊèêÁ§∫Âç°Áâá„ÄÇ
        this.showToast(title, body, icon, onClick);

        // Â∞ùËØïÂèëÈÄÅÂéüÁîüÁ≥ªÁªüÈÄöÁü• (Áä∂ÊÄÅÊ†èÈÄöÁü•)
        // ‰ªÖÂú®ÊîØÊåÅÁöÑÁéØÂ¢É‰∏ãÁîüÊïà (Â¶Ç iOS SafariÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÂêé„ÄÅPC ÊµèËßàÂô®)
        if ("Notification" in window && Notification.permission === "granted") {
            try {
                const noti = new Notification(title, {
                    body: body,
                    icon: "https://i.postimg.cc/Sstb57LV/065da10de10365d9519422da09e26142.jpg", 
                    tag: tag,
                    renotify: true
                });
                
                noti.onclick = function() {
                    window.focus(); 
                    if (onClick) onClick();
                    noti.close();
                };
            } catch (e) {
                // APK ÁéØÂ¢É‰∏ãËøôÈáåÊä•ÈîôÊòØÊ≠£Â∏∏ÁöÑÔºåÂøΩÁï•Âç≥ÂèØÔºåÂõ†‰∏∫‰∏äÈù¢Â∑≤ÁªèÂºπ‰∫Ü Toast
                console.log("ÂéüÁîüÈÄöÁü•Ë∞ÉÁî®Ë¢´Êã¶Êà™ (APKÁéØÂ¢ÉÊ≠£Â∏∏Áé∞Ë±°)");
            }
        }
    },

    // 3. ÊòæÁ§∫ App ÂÜÖÁæéÂåñÂºπÁ™ó (‰øùÊåÅÂéüÊ†∑ÔºåÊó†ÈúÄ‰øÆÊîπ)
    showToast: function(title, body, icon, onClick) {
        const container = document.getElementById('sys-toast-container');
        if(!container) return; 
        container.classList.add('show');

        const el = document.createElement('div');
        el.className = 'sys-toast-card';
        el.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-body">
                <div class="toast-title">${title}</div>
                <div class="toast-msg">${body}</div>
            </div>
        `;
        
        el.onclick = () => {
            if (onClick) onClick();
            el.remove();
            if(container.children.length === 0) container.classList.remove('show');
        };

        container.appendChild(el);

        // 5ÁßíÂêéËá™Âä®Ê∂àÂ§±
        setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => { 
                el.remove(); 
                if(container.children.length === 0) container.classList.remove('show');
            }, 300);
        }, 5000);
    }
};
// === üöë ‰øÆÂ§çË°•‰∏ÅÔºöÂ≠¶‰π†ËÆ°ÂàíÂà†Èô§ÂäüËÉΩ ===
window.deleteStudyPlan = function() {
    if(confirm("Á°ÆÂÆöË¶ÅÊîæÂºÉËøô‰∏™ËÆ°ÂàíÂêóÔºüÊâÄÊúâËøõÂ∫¶Â∞Ü‰∏¢Â§±„ÄÇ")) {
        // 1. Ê∏ÖÁ©∫ÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ
        window.BIG_MEMORY.study = null;
        
        // 2. Ê∏ÖÁ©∫Êó†ÈôêÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊï∞ÊçÆ
        if (typeof idb !== 'undefined') {
            idb.put('universal_store', { id: 'study', data: null });
        }
        
        // 3. Ê∏ÖÁ©∫ÊóßÁºìÂ≠ò (Èò≤Ê≠¢Â§çÊ¥ª)
        localStorage.removeItem('study_plan_data');
        
        // 4. Âà∑Êñ∞ÁïåÈù¢
        renderStudyApp(); 
    }
};
  </script>
<div id="card-table-modal" class="modal-overlay" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);">
    <div id="card-table-desk">
        <div id="card-area">
        </div>
        <div class="card-table-ui">
            <div style="color:white; text-shadow:0 1px 2px black;">ËØ∑Âá≠ÂÄüÁõ¥ËßâÁøªÂºÄÂá†Âº†Áâå... (<span id="flipped-count">0</span>)</div>
            <button class="m-btn primary" onclick="finishReadingAndGenerate()">üîÆ ÊÑüÁü•ËÉΩÈáèÂπ∂ÁîüÊàêÊñ∞Èóª</button>
            <button class="m-btn secondary" onclick="closeCardTable()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
<div id="newspaper-modal" class="modal-overlay" onclick="closeNewspaper()">
    <div class="paper-full-view" onclick="event.stopPropagation()">
        <div class="paper-full-head">
            <div class="paper-brand">The Daily Prophecy</div> 
            <div class="paper-meta-row">
                <span id="news-location-display">Earth</span>
                <span id="news-date-display">DATE: 2026-01-25</span>
                <span>Price: 1 Soul</span>
            </div>
        </div>
        <div class="paper-split-body">
            <div class="paper-col left-col">
                <div class="col-header">
                    <span class="col-tag">OTHER SIDE</span>
                    <h3>ECHOES FROM THE VOID</h3>
                </div>
                <div id="news-cards-display" class="news-cards-strip"></div>
                <div class="news-article" id="dream-news-content">
                    <div class="skeleton-text">Ê≠£Âú®Ê†πÊçÆÊòüË±°‰∏éÁâåÊÑèËß£ÊûêÂΩºÂ≤∏ÁöÑËÉΩÈáèÊµÅÂä®...</div>
                </div>
            </div>

            <div class="vertical-divider"></div>

            <div class="paper-col right-col">
                <div class="col-header">
                    <span class="col-tag">REALITY</span>
                    <h3>LOCAL CHRONICLES</h3>
                </div>
                <div class="news-article" id="real-news-content">
                    <div class="skeleton-text">Ê≠£Âú®Ê£ÄÁ¥¢‰Ω†ÊâÄÂú®Áª¥Â∫¶ÁöÑ‰ªäÊó•Â§¥Êù°...</div>
                </div>
            </div>
        </div>
        <div style="margin-top:20px; text-align:center; font-size:0.6rem; border-top:1px solid #333; padding-top:5px;">
            Printed by RetroOS Press ‚Ä¢ All Realities Reserved
        </div>
    </div>
</div>

<div id="tarot-app-modal" class="modal-overlay" style="background: linear-gradient(to bottom, #1a1a2e, #16213e);">
    <div class="modal-header" style="background: rgba(0,0,0,0.3); color: #e2c2b3; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <div style="display:flex; align-items:center; gap:10px;">
            <span>üîÆ ÁÅµÈ≠ÇÂç†Âçú</span>
            <select id="divination-mode" onchange="switchTarotMode()" style="background:rgba(255,255,255,0.1); color:#fff; border:none; border-radius:4px; padding:2px;">
             <!-- ÊõøÊç¢ÂéüÊúâÁöÑ options -->
<option value="tarot">Â°îÁΩóÁâå (78Âº†)</option>
<option value="lenormand">Èõ∑ËØ∫Êõº (36Âº†)</option>
<option value="liuyao">ÂÖ≠Áàª (ÈáëÈí±Âç¶)</option>
<option value="meihua">Ê¢ÖËä±ÊòìÊï∞ (Êó∂Èó¥/Êï∞Â≠ó)</option>
            </select>
        </div>
        <div style="display:flex; gap:15px;">
            <button class="m-btn small" onclick="toggleTarotHistory()" style="background:transparent; color:#e2c2b3;">üìú ÂéÜÂè≤</button>
            <button class="close-btn" onclick="closeTarotApp()" style="color:#fff;">√ó</button>
        </div>
    </div>
    <div id="tarot-history-panel" class="chat-settings-panel">
        <h3>üîÆ ÁÅµËßÜËÆ∞ÂΩï</h3>
        <button class="m-btn small" onclick="toggleTarotHistory()" style="margin-bottom:10px; background:#e8d7d7;">ÂÖ≥Èó≠‰æßËæπÊ†è</button>
        <div id="tarot-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div class="modal-body">
        <div id="tarot-desk-area">
            <div style="text-align:center; padding: 10px; color:#a29bfe; font-size:0.9rem; text-shadow:0 0 5px #000; background:rgba(0,0,0,0.2); flex-shrink:0;">
                ËØ∑ÈõÜ‰∏≠ÊÑèÂøµÔºåÁÇπÂáªÊäΩÁâå (Â∑≤ÈÄâ: <span id="tarot-picked-count">0</span>)
            </div>
            <div id="tarot-card-spread">
            </div>
            <div class="tarot-bottom-bar">
                <button class="m-btn small" onclick="confirmShuffle()" style="background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.3);">
                    üå™Ô∏è ÈáçÊ¥ó / Êâì‰π±
                </button>
                <button class="m-btn primary" id="btn-tarot-finish" onclick="finishTarotSelection()" style="background:#a29bfe; color:#1a1a2e; border:none; display:none; box-shadow: 0 0 15px rgba(162, 155, 254, 0.6);">
                    ‚ú® ÂÆåÊàêÊäΩÁâå
                </button>
            </div>
        </div>
<!-- Êñ∞Â¢ûÔºöÊòìÂ≠¶Ê°åÈù¢ (ÂÖ≠Áàª/Ê¢ÖËä±) -->
<div id="iching-desk-area" style="display:none; flex:1; flex-direction:column; align-items:center; justify-content:center; color:#e2c2b3;">
    
    <!-- ÂÖ≠ÁàªÂå∫Âüü -->
    <div id="liuyao-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <div style="font-size:1.2rem; margin-bottom:20px;">ËØ∑ËØöÂøÉÈªòÂøµÈóÆÈ¢òÔºåÊé∑Âá∫ÂÖ≠Ê¨°</div>
        <div id="hexagram-lines" style="display:flex; flex-direction:column-reverse; gap:10px; margin-bottom:20px; min-height:180px;">
            <!-- Âç¶ÁàªÁ∫øÂ∞ÜÂú®ËøôÈáåÁîüÊàê -->
        </div>
        <div class="coin-container" style="display:flex; gap:15px; margin-bottom:20px;">
            <div class="coin">ü™ô</div><div class="coin">ü™ô</div><div class="coin">ü™ô</div>
        </div>
        <button class="m-btn primary" onclick="tossLiuyaoCoins()" style="background:#d4af37; color:#000;">üé≤ Êé∑Á°¨Â∏Å</button>
    </div>

    <!-- Ê¢ÖËä±ÊòìÊï∞Âå∫Âüü -->
    <div id="meihua-ui" style="display:none; flex-direction:column; align-items:center; width:80%;">
        <div class="morandi-card" style="width:100%; text-align:center; padding:20px;">
            <h3>üå∏ Ê¢ÖËä±ÂøÉÊòì</h3>
            <p style="font-size:0.8rem; color:#666;">ËæìÂÖ•Êï∞Â≠óÊàñ‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥Ëµ∑Âç¶</p>
            <div class="input-group">
                <input type="number" id="meihua-n1" placeholder="‰∏äÂç¶Êï∞" style="width:48%; display:inline-block;">
                <input type="number" id="meihua-n2" placeholder="‰∏ãÂç¶Êï∞" style="width:48%; display:inline-block;">
            </div>
            <div style="margin:10px 0; color:#888;">- Êàñ -</div>
            <button class="m-btn secondary" onclick="useCurrentTimeForMeihua()">‚è∞ ‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥Ëµ∑Âç¶</button>
        </div>
        <button class="m-btn primary" onclick="finishMeihua()" style="margin-top:20px; width:100%; background:#e67e22;">ÁîüÊàêÂç¶Ë±°</button>
    </div>

    <!-- Â∫ïÈÉ®ÈáçÁΩÆÊåâÈíÆ -->
    <div style="margin-top:30px;">
        <button class="m-btn small" onclick="resetIching()" style="background:rgba(255,255,255,0.1);">üîÑ ÈáçÁΩÆ</button>
    </div>
</div>
        <div id="tarot-result-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#2c3e50;">Ëß£ËØªÂú£Âùõ</h3>
                <button class="m-btn small" onclick="backToDesk()" style="background:#ddd; color:#333;">üîô ËøîÂõûÁâåÊ°å</button>
            </div>
            <div id="selected-cards-header" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #ccc;"></div>
            <div id="divination-form">
                <div class="input-group">
                    <label>ÂøÉ‰∏≠ÊâÄÊÉë (Question)</label>
                    <input type="text" id="divine-question" placeholder="‰æãÂ¶ÇÔºö‰ªñÂØπÊàëÁöÑÁúüÂÆûÊÉ≥Ê≥ïÔºü/ËøôÂë®ËøêÂäøÔºü">
                </div>
                
                <details style="margin-bottom:10px; font-size:0.8rem; color:#666;">
                    <summary>üìù Ë°•ÂÖÖËÉåÊôØ‰ø°ÊÅØ</summary>
                    <div style="margin-top:10px; padding:10px; background:#eee; border-radius:8px;">
                        <div class="input-group"><label>ÁõÆÊ†á‰∫∫Áâ©</label><input type="text" id="divine-target" placeholder="TaÁöÑÂêçÂ≠ó"></div>
                        <div class="input-group"><label>ÂΩìÂâçÂÖ≥Á≥ª</label><input type="text" id="divine-status" placeholder="Áé∞Áä∂..."></div>
                    </div>
                </details>
<div class="morandi-card" style="padding:10px; margin-bottom:15px; border:1px solid #e0d0d0;">
    <label style="font-size:0.8rem; color:#8b0000; font-weight:bold; display:block; margin-bottom:8px;">üîó ÈìæÊé•‰∏ñÁïå‰π¶ (ÂãæÈÄâ‰ª•Ê≥®ÂÖ•API)</label>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:0.85rem;">
        <label style="display:flex; align-items:center;">
            <input type="checkbox" id="wb-ctx-global" checked> 
            <span style="margin-left:4px;">1.ÂÖ®Â±ÄËÆæÂÆö</span>
        </label>
        
        <label style="display:flex; align-items:center;">
            <input type="checkbox" id="wb-ctx-tarot" checked> 
            <span style="margin-left:4px;">3.Â°îÁΩóÁâå</span>
        </label>
        <label style="display:flex; align-items:center;">
            <input type="checkbox" id="wb-ctx-lenormand"> 
            <span style="margin-left:4px;">4.Èõ∑ËØ∫Êõº</span>
        </label>
<!-- ËøΩÂä†Âú® checkbox ÂàóË°®Êú´Â∞æ -->
<label style="display:flex; align-items:center;">
    <input type="checkbox" id="wb-ctx-iching" checked> 
    <span style="margin-left:4px;">ÂÖ≠Áàª/Ê¢ÖËä±ËÆæÂÆö</span>
</label>
        <label style="display:flex; align-items:center;">
            <input type="checkbox" id="wb-ctx-char"> 
            <span style="margin-left:4px;">‰ø°‰ª∂</span>
        </label>
    </div>
</div>

                <div class="input-group">
                    <label>Ëß£ËØªÊñπÂºè</label>
                    <select id="divine-method" onchange="toggleDivineInput(this.value)">
                        <option value="ai_dream">üîÆ AI Ê¢¶Âç† (ÊΩúÊÑèËØÜËøûÊé•)</option>
                        <option value="ai_trad">üìñ AI ‰º†ÁªüÁâå‰πâËß£Êûê</option>
                        <option value="manual">‚úçÔ∏è Ëá™Ë°åËæìÂÖ•Ëß£Áâå</option>
                    </select>
                </div>

                <div id="manual-divine-box" style="display:none;" class="input-group">
                    <label>‰Ω†ÁöÑËß£ËØª</label>
                    <textarea id="manual-interpretation" class="editor-textarea" style="height:150px;"></textarea>
                </div>

                <button class="m-btn primary" onclick="startDivination()" style="width:100%; margin-top:10px; background:#2c3e50;">üëÅÔ∏è ÂºÄÂßãÊ¥ûÂØü</button>
            </div>
            <div id="divination-output" style="display:none; margin-top:20px;">
                <div class="receipt-header" style="border-bottom:2px solid #2c3e50;">
                    <div class="receipt-title">SOUL MESSAGE</div>
                </div>
                <div id="output-content" style="font-family:'Georgia', serif; line-height:1.8; color:#333; white-space: pre-wrap; margin-top:15px;"></div>
                
                <div style="margin-top:30px; display:flex; gap:10px;">
                    <button class="m-btn small" onclick="confirmShuffle()" style="background:#eee;">üîÑ ÈáçÊñ∞ÊäΩÁâå</button>
                    <button class="m-btn small" onclick="saveDivinationResult()" style="background:#a29bfe; color:white;">üíæ ‰øùÂ≠òËÆ∞ÂΩï</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="finance-modal" class="modal-overlay">
    <div class="modal-header">
        <span>ËÆ∞Ë¥¶Êú¨</span>
        <div style="display:flex; gap:10px;">
            <button class="m-btn small" onclick="toggleHistorySelector()" style="background:transparent; color:#555; font-size:1.2rem;">üìÖ</button>
            <button class="close-btn" onclick="document.getElementById('finance-modal').style.display='none'" style="padding:0;">√ó</button>
        </div>
    </div>
    <div id="history-selector" class="history-selector">
        <div style="text-align:center; font-weight:bold; margin-bottom:5px;">ÂàáÊç¢Êúà‰ªΩ</div>
        <input type="month" id="finance-month-picker" onchange="changeFinanceDate(this.value)" style="padding:5px;">
    </div>

    <div class="modal-body" style="background:#fdfdfd;"><!-- Êñ∞Â¢ûÔºöÊÄªËµÑ‰∫ßÊ†è -->
<div style="background:#fff; padding:12px; margin-bottom:15px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center;">
    <div>
        <div style="font-size:0.7rem; color:#888;">ÁõÆÂâçÊÄªËµÑ‰∫ß (Âê´ÂàùÂßã)</div>
        <div style="font-size:1.4rem; font-weight:bold; color:#2c3e50;" id="finance-total-display">0.00</div>
    </div>
    <button class="m-btn small" onclick="setInitialFunds()" style="background:#eee; color:#555;">‚öôÔ∏è ËÆæÂàùÂßã</button>
</div>
<!-- Âéü‰ª£Á†Å finance-nav Âú®ËøôÈáå... -->
        <div class="finance-nav">
            <button onclick="navFinanceDate(-1)">‚óÄ</button>
            <span id="finance-current-date-display">2026-01</span>
            <button onclick="navFinanceDate(1)">‚ñ∂</button>
        </div>

        <div class="morandi-card" style="background:#7d8c7c; color:white; text-align:center; padding:15px;">
            <div style="font-size:0.8rem; opacity:0.8;">Êú¨ÊúàÁªì‰Ωô</div>
            <div style="font-size:2.2rem; font-weight:bold;" id="finance-month-balance">0.00</div>
            <div style="display:flex; justify-content:space-around; margin-top:5px; font-size:0.85rem; opacity:0.9;">
                <div>Êî∂: <span id="finance-month-in">0</span></div>
                <div>ÊîØ: <span id="finance-month-out">0</span></div>
            </div>
        </div>
        <div id="finance-chart-area" class="finance-chart-container">
        </div>
        <div class="morandi-card">
            <input type="number" id="finance-amount" placeholder="ËæìÂÖ•ÈáëÈ¢ù..." class="editor-textarea" style="padding:10px; width:100%; margin-bottom:10px; font-size:1.2rem; text-align:center;">
            
            <div style="font-size:0.75rem; color:#888; margin-bottom:5px;">ÊîØÂá∫ÂàÜÁ±ªÔºö</div>
            <div class="cat-grid">
                <div class="cat-btn expense" onclick="addFinanceRecord('ÂêÉÈ•≠', 'expense')">ÂêÉÈ•≠</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('Â∑•‰Ωú', 'expense')">Â∑•‰Ωú</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('ÂÖ∂ÂÆÉ', 'expense')">ÂÖ∂ÂÆÉ</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('‰π∞Ë∞∑', 'expense')">‰π∞Ë∞∑</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('Á∫¶Á®ø', 'expense')">Á∫¶Á®ø</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('‰º†ËÆØ', 'expense')">‰º†ËÆØ</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('Ë°£Êúç', 'expense')">Ë°£Êúç</div>
                <div class="cat-btn expense" onclick="addFinanceRecord('Á∫¶‰ºö', 'expense')">Á∫¶‰ºö</div>
            </div>

            <div style="font-size:0.75rem; color:#888; margin:10px 0 5px 0;">Êî∂ÂÖ•ÂàÜÁ±ªÔºö</div>
            <div class="cat-grid">
                <div class="cat-btn income" onclick="addFinanceRecord('Â∑•ËµÑ', 'income')">Â∑•ËµÑ</div>
                <div class="cat-btn income" onclick="addFinanceRecord('ÂâØ‰∏ö', 'income')">ÂâØ‰∏ö</div>
                <div class="cat-btn income" onclick="addFinanceRecord('Á∫¢ÂåÖ', 'income')">Á∫¢ÂåÖ</div>
                <div class="cat-btn income" onclick="addFinanceRecord('ÊÑèÂ§ñ', 'income')">ÊÑèÂ§ñÊî∂ÂÖ•</div>
            </div>
        </div>
        <h4 style="margin: 15px 0 5px 0; color:#888; font-size:0.9rem;">Ë¥¶ÂçïÊòéÁªÜ</h4>
        <div id="finance-list" style="display:flex; flex-direction:column; gap:10px; padding-bottom:50px;">
        </div>
    </div>
</div>
<div id="theater-modal" class="modal-overlay theater-theme-day">
    <div id="theater-container">
        <div class="theater-header">
            <button class="m-btn small" onclick="closeTheaterApp()" style="background:transparent; font-size:1.2rem;">üîô</button>
            <div class="th-title">Â∞èÂâßÂú∫ ¬∑ Light Novel</div>
            <div style="display:flex; gap:10px;">
                <button class="m-btn small" onclick="toggleTheaterTheme()" style="background:rgba(0,0,0,0.1);">üåì</button>
                <button class="m-btn small" onclick="toggleTheaterHistory()" style="background:rgba(0,0,0,0.1);">üìú ÂéÜÂè≤</button>
            </div>
        </div>
        <div id="theater-scroll-area">
            <div id="theater-content-list">
                <div style="text-align:center; margin-top:50vh; transform:translateY(-50%); color:opacity:0.5;">
                    <div style="font-size:3rem; opacity:0.2;">üé≠</div>
                    <p style="opacity:0.6;">ÈìæÊé•‰∏ñÁïå‰π¶ÔºåÂºÄÂêØ‰Ω†ÁöÑÊïÖ‰∫ã„ÄÇ</p>
                </div>
            </div>
        </div>
        <div class="theater-footer">
            <div style="display:flex; gap:15px; font-size:0.75rem; opacity:0.8; overflow-x:auto;">
                <label><input type="checkbox" id="th-use-global" checked> ÂºïÁî®‰∏ñÁïå‰π¶(ÂÖ®Â±Ä)</label>
                <label><input type="checkbox" id="th-use-theater" checked> ÂºïÁî®‰∏ñÁïå‰π¶(Â∞èÂâßÂú∫)</label>
            </div>
            
            <div class="th-input-row">
                <textarea id="th-input" class="th-textarea" placeholder="ËæìÂÖ•ÂâßÊÉÖËµ∞Âêë„ÄÅÂØπËØùÊàñÂä®‰Ωú (‰Ω†)..."></textarea>
                <button class="th-btn" onclick="generateTheaterSegment()" id="btn-th-gen">Áª≠ÂÜô ‚ú®</button>
            </div>
        </div>
    </div>
    <div id="theater-history-panel" class="chat-settings-panel">
        <h3>üìö ÂâßÊú¨ÂéÜÂè≤</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="toggleTheaterHistory()" style="background:rgba(128,128,128,0.2);">ÂÖ≥Èó≠</button>
            <button class="m-btn small" onclick="startNewTheater()" style="background:var(--th-accent); color:white;">+ Êñ∞ÂâßÊú¨</button>
        </div>
        <div id="theater-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
</div>
<div id="period-modal" class="modal-overlay period-theme">
    <div class="modal-header" style="background:#f8bbd0; color:#880e4f;">
        <span>Red Moon Cycle</span>
        <button class="close-btn" onclick="document.getElementById('period-modal').style.display='none'" style="color:#880e4f;">√ó</button>
    </div>
    <div class="modal-body">
        <div class="cycle-dashboard" style="overflow: visible; height: auto; min-height: 150px;">
            <div style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; opacity:0.7;">Body Status</div>
                    
            <div class="cycle-status-text" id="p-status-display" style="font-size: 1.8rem; font-weight: bold; margin: 10px 0;">Á≠âÂæÖËÆ∞ÂΩï...</div>
            <div class="cycle-sub-text" id="p-prediction-display">ËØ∑ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥</div>
                <button id="p-toggle-btn" class="period-toggle-btn" onclick="togglePeriodStatus()" style="margin-top:15px; padding:8px 20px; border-radius:20px; background:white; color:#d81b60; border:1px solid #d81b60;">
                ‚ö™ Êú™Âú®ÁªèÊúü
            </button>
        </div>
        <div id="p-ai-section" style="display:none;">
            <div class="ai-care-card">
                <div style="font-weight:bold; margin-bottom:5px; color:#d81b60;">üíå Áà±‰∫∫‰º†Êù•ÁöÑ‰ø°ÊÅØ</div>
                <div id="p-care-msg" style="white-space: pre-wrap; line-height:1.6;">Ê≠£Âú®Êé•Êî∂Áü≠‰ø°...</div>
            </div>

            <div class="morandi-card" style="padding:15px;">
                <h4 style="margin:0 0 10px 0;">ü•£ Êé®ËçêÈ£üË∞±</h4>
                <div id="p-recipe-title" style="font-weight:bold; color:#444;"></div>
                <div class="recipe-box" id="p-recipe-content">Loading...</div>
            </div>
        </div>
        <div class="morandi-card">
            <h3>üìù ËÆ∞ÂΩïÊó•Âøó</h3>
            <div class="input-group">
                <label>ÂºÄÂßãÊó∂Èó¥</label>
                <input type="date" id="p-start-date">
            </div>
            <div class="input-group">
                <label>ÁªìÊùüÊó∂Èó¥ (ÂèØÈÄâ)</label>
                <input type="date" id="p-end-date">
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="m-btn primary" onclick="addPeriodRecord()" style="background:#d81b60;">‰øùÂ≠òËÆ∞ÂΩï</button>
                <button class="m-btn secondary" onclick="analyzeCycleWithAI()" style="background:#fce4ec; color:#d81b60;">üîÆ AI ÂàÜÊûêË∫´‰Ωì & Êé®Ëçê</button>
            </div>
        </div>
        <div class="morandi-card">
            <h3>üìÖ ÂéÜÂè≤Âë®Êúü</h3>
            <div id="p-history-list"></div>
        </div>
    </div>
</div>
<div id="forum-modal" class="modal-overlay">
    <div class="forum-container">
        <div class="modal-header" style="background:#fff; color:#333; border-bottom:1px solid #ddd;">
            <button class="m-btn small" onclick="closeForumApp()" style="background:transparent; color:#333; font-size:1.2rem;">üîô</button>
            <span style="font-weight:bold;">ÂåøÂêçËÆ∫Âùõ</span>
            <button class="m-btn small" onclick="toggleForumHistory()" style="background:transparent; color:#00d2d3;">üìÇ ÂéÜÂè≤</button>
        </div>
        <div id="forum-scroll-area" class="forum-scroll-area">
            <div id="forum-content-container">
                <div style="text-align:center; margin-top:100px; color:#999;">
                    <div style="font-size:3rem; opacity:0.3;">üí¨</div>
                    <p>ËæìÂÖ•ÂÖ≥ÈîÆËØçÔºåÁîüÊàêËÆ∫Âùõ‰ΩìÂ∞èËØ¥<br>ÊîØÊåÅË∂ÖÈïø‰∏ä‰∏ãÊñá‰∏éÁª≠ÂÜô</p>
                </div>
            </div>
        </div>
        <div class="forum-footer-bar">
            <div class="forum-input-settings">
                <label><input type="checkbox" id="forum-use-global" checked> ÂºïÁî®‰∏ñÁïå‰π¶(ÂÖ®Â±Ä)</label>
                <label><input type="checkbox" id="forum-use-forum" checked> ÂºïÁî®‰∏ñÁïå‰π¶(ËÆ∫Âùõ‰Ωì)</label>
                <select id="forum-role-select" style="border:1px solid #ddd; padding:2px;">
                    <option value="npc">Ë∑Ø‰∫∫/NPCÂèëÂ∏ñ</option>
                    <option value="user">‰∏ªËßí/ÊàëÂèëÂ∏ñ</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <textarea id="forum-input" class="th-textarea" style="height:50px;" placeholder="ËæìÂÖ•Ê†áÈ¢ò„ÄÅÊ¢óÊ¶ÇÊàñÂÖ≥ÈîÆËØç..."></textarea>
                <button class="m-btn primary" onclick="generateForumThread()" id="btn-forum-gen" style="background:#00d2d3; width:80px;">ÂèëÂ∏ñ / Áª≠ÂÜô</button>
            </div>
        </div>
    </div>
    <div id="forum-history-panel" class="chat-settings-panel">
        <h3>üìÇ Â∏ñÂ≠êÂéÜÂè≤</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="toggleForumHistory()" style="background:#eee;">ÂÖ≥Èó≠</button>
            <button class="m-btn small" onclick="startNewForum()" style="background:#00d2d3; color:white;">+ Êñ∞Â∏ñÂ≠ê</button>
        </div>
        <div id="forum-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
</div>
<div id="fridge-modal" class="modal-overlay" style="background: #f2f4f6;">
    <div class="fridge-app-container" style="position:relative; width:100%; height:100%; display:flex; flex-direction:column; overflow:hidden;">
        <div class="fridge-header-clean">
            <button class="fh-btn" onclick="closeFridgeApp()">‚ùÆ ËøîÂõû</button>
            <span class="fh-title">Êô∫ËÉΩÂÜ∞ÁÆ± ¬∑ Smart Fridge</span>
            <div class="fh-icon" onclick="toggleFridgeHistory()" style="cursor:pointer; font-size:1.5rem;">üïí</div>
        </div>
        <div class="fridge-scroll-body" style="flex:1; overflow-y:auto; padding:15px; padding-bottom:100px;">
            
            <div class="section-title">Ë∞ÉÊñôÂå∫ (ÁÇπÂáªÂàáÊç¢)</div>
            <div class="condiments-grid" id="new-shelf-condiments" style="min-height:80px; display:flex; gap:10px; overflow-x:auto;">
            </div>

            <div class="section-title">‰∏ªÈ£üÂå∫</div>
            <div class="staples-row" id="new-shelf-staples" style="min-height:80px; display:flex; justify-content:space-around;">
            </div>

            <div class="section-title">Ëî¨ËèúÂå∫</div>
            <div class="tags-container" id="new-shelf-veg" style="min-height:50px;">
            </div>

            <div class="section-title">ËÇâÁ±ªÂÜ∑ÂÜªÂå∫</div>
            <div class="tags-container" id="new-shelf-meat" style="min-height:50px;">
            </div>
            
        </div>
        <div class="fridge-footer-fixed" style="position:absolute; bottom:30px; left:20px; right:20px; z-index:10;">
            <button class="big-call-btn" onclick="startWeChatCall()">
                <span>üìû</span>
                <span>ÂñÇÔºüÊïôÊàëÂÅöÈ•≠</span>
            </button>
        </div>
        <div id="fridge-history-panel">
            <h3 style="color:#5d4037; border-bottom:1px solid #ddd; padding-bottom:10px; margin-top:0;">
                üìù ÂéÜÂè≤‰æøÁ≠æ
                <span onclick="toggleFridgeHistory()" style="float:right; cursor:pointer; color:#999;">√ó</span>
            </h3>
            <div id="fridge-history-list" style="display:flex; flex-direction:column; gap:15px; padding-top:10px;">
            </div>
        </div>

    </div>
</div>
<div id="wechat-call-overlay">
    <div class="wx-minimize" onclick="endWeChatCall()">‚åÑ</div>
    
    <div class="wx-avatar" id="wx-call-avatar"></div>
    <div class="wx-name" id="wx-call-name">Chef Bot</div>
    <div class="wx-status" id="wx-call-status">Á≠âÂæÖÂØπÊñπÊé•Âê¨...</div>
    <div id="wx-call-subtitle" class="wx-subtitle-box" style="display:none;"></div>

    <div class="wx-footer-btns">
        <div class="wx-btn-col">
            <div class="wx-round-btn wx-btn-normal">üîá</div>
            <span class="wx-btn-label">È∫¶ÂÖãÈ£éÂ∑≤ÂºÄ</span>
        </div>
        <div class="wx-btn-col">
            <div class="wx-round-btn wx-btn-hangup" onclick="endWeChatCall()">üìû</div>
            <span class="wx-btn-label">ÊåÇÊñ≠</span>
        </div>
        <div class="wx-btn-col">
            <div class="wx-round-btn wx-btn-normal">üîä</div>
            <span class="wx-btn-label">ÂÖçÊèê</span>
        </div>
    </div>
</div>
<div id="sticky-note-modal" class="modal-overlay" onclick="document.getElementById('sticky-note-modal').style.display='none'">
    <div class="big-sticky-note" onclick="event.stopPropagation()">
        <div class="note-pin">üìå</div>
        <div id="note-detail-date" style="text-align:right; font-size:0.8rem; color:#888; margin-bottom:10px;"></div>
        <h2 id="note-detail-title" style="margin:0 0 15px 0; border-bottom:2px dashed #a1887f; padding-bottom:10px;"></h2>
        <div id="note-detail-content" style="white-space: pre-wrap; line-height: 1.6; font-size: 1.1rem; flex:1;"></div>
        <div style="margin-top:20px; text-align:center; font-size:0.8rem; opacity:0.6;">- Êù•Ëá™‰Ω†ÁöÑÁßÅÂÆ∂Â§ßÂé® -</div>
    </div>
</div>
<div id="pickup-modal" class="modal-overlay">
    <div class="pickup-header">
        <button class="m-btn small" onclick="closePickupApp()" style="background:transparent; color:#333; font-size:1.2rem;">üîô</button>
        <div style="text-align:center;">
            <div style="font-weight:bold; font-size:1rem;">Êç°ÊâãÊú∫ÊñáÂ≠¶</div>
            <div style="font-size:0.7rem; color:#666;" id="pickup-char-name">Target</div>
        </div>
        <button class="m-btn small" onclick="togglePickupHistory()" style="background:transparent; color:#333;">üìú ÂéÜÂè≤</button>
    </div>
    <div id="pickup-chat-area">
        <div style="text-align:center; margin-top:50px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.3);">
            <p>ËæìÂÖ•ÊÉÖËäÇÂÖ≥ÈîÆËØç<br>ÁîüÊàê‰Ω†‰ª¨ÁöÑÁßÅÂØÜËÅäÂ§©ËÆ∞ÂΩï</p>
        </div>
    </div>
    <div class="pickup-footer">
        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666; margin-bottom:5px;">
            <span>üìö Ë∞ÉÁî®ÔºöÂÖ®Â±Ä + Êç°ÊâãÊú∫ÊñáÂ≠¶</span>
            <span onclick="clearPickupChat()" style="color:red; cursor:pointer;">Ê∏ÖÁ©∫ÂΩìÂâç</span>
        </div>
        <div class="pickup-input-group">
            <textarea id="pickup-input" class="pup-textarea" placeholder="‰æãÂ¶ÇÔºöÂêµÊû∂Âêé‰ªñÊù•Ê±ÇÂíå / ÂèëÁé∞‰ªñÊâãÊú∫ÈáåÁöÑÂ§áÂøòÂΩï..."></textarea>
            <button class="m-btn primary" onclick="generatePickupChat()" id="btn-pickup-gen" style="width:80px; background:#f1c40f; color:#000;">ÁîüÊàê<br></button>
        </div>
    </div>
    <div id="pickup-history-panel" class="chat-settings-panel">
        <h3>üì± Â≠òÊ°£ËÆ∞ÂΩï</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="togglePickupHistory()" style="background:#eee;">ÂÖ≥Èó≠</button>
            <button class="m-btn small" onclick="startNewPickup()" style="background:#f1c40f; color:#000;">+ Êñ∞ÂØπËØù</button>
        </div>
        <div id="pickup-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
</div>
<div id="album-app-modal" class="modal-overlay" style="background:#f5f5f5;">
    <div id="album-shelf-view" style="width:100%; height:100%; display:flex; flex-direction:column;">
        <div class="modal-header" style="background:#fff;">
            <span>ÊàëÁöÑÁõ∏ÂÜå</span>
            <div style="display:flex; gap:10px;">
                <button class="m-btn small" onclick="createNewAlbum()">+ Êñ∞Âª∫Áõ∏ÂÜå</button>
                <button class="close-btn" onclick="closeAlbumApp()">√ó</button>
            </div>
        </div>
        <div id="album-list-container" class="album-shelf-grid" style="overflow-y:auto; flex:1;">
        </div>
    </div>
    <div id="album-detail-view" style="display:none; width:100%; height:100%; flex-direction:column;">
        <div class="modal-header" style="background:#fff;">
            <button class="m-btn small" onclick="backToShelf()">üîô</button>
            <span id="album-title-display" onclick="editAlbumName()" style="border-bottom:1px dashed #999;">Áõ∏ÂÜåÂêç</span>
            <div style="display:flex; gap:10px;">
                <input type="file" id="photo-import-input" multiple accept="image/*" style="display:none" onchange="handlePhotoImport(this)">
                <button class="m-btn small" onclick="document.getElementById('photo-import-input').click()">üì∑ ÂØºÂÖ•</button>
                <button class="m-btn small" style="color:red;" onclick="deleteCurrentAlbum()">üóëÔ∏è</button>
            </div>
        </div>
        <div id="photo-grid-container" class="album-photo-grid" style="overflow-y:auto; flex:1;">
        </div>

    </div>
</div>
<div id="diary-app-modal" class="modal-overlay" style="background:#333;">
    <div class="modal-header" style="background:rgba(0,0,0,0.5); color:#fff; position:absolute; top:0; width:100%; z-index:20; backdrop-filter:blur(5px);">
        <span>Private Diary</span>
        <div style="display:flex; gap:10px;">
            <button class="m-btn small" onclick="toggleDiaryHistory()" style="background:rgba(255,255,255,0.2); color:#fff;">üìú ÂæÄ‰∫ã</button>
            <button class="close-btn" onclick="document.getElementById('diary-app-modal').style.display='none'" style="color:white;">√ó</button>
        </div>
    </div>
    
    <!-- ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†è -->
    <div id="diary-history-panel" class="chat-settings-panel">
        <h3>üìú Â∞òÂ∞ÅÁöÑÊó•ËÆ∞</h3>
        <button class="m-btn small" onclick="toggleDiaryHistory()" style="margin-bottom:10px; background:#e8d7d7;">ÂÖ≥Èó≠</button>
        <div id="diary-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div class="diary-book-container">
        <!-- Â∑¶È°µ -->
        <div class="diary-page left">
            <div class="diary-status-bar">
                <div class="d-stat">Mood: <span id="d-mood">--</span></div>
                <div class="d-stat">Clean: <span id="d-clean">--</span></div>
                <div class="d-stat">Food: <span id="d-food">--</span></div>
                <div class="d-stat">Money: <span id="d-money">--</span></div>
            </div>
            <div class="diary-date" id="d-date-display">DATE: --/--/--</div>
            
            <div class="diary-photo-frame">
                <img id="diary-central-photo" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                <div class="photo-pin">üìç</div>
            </div>

            <div id="diary-text-content" class="diary-text-body">
                <div class="skeleton-text" style="margin-top:50px;">ÁÇπÂáªÂè≥‰∏ãËßíÊåâÈíÆÔºåÊäΩÂèñÂëΩËøêÁâåÁîüÊàê‰ªäÊó•ËÆ∞ÂΩï...</div>
            </div>
        </div>

        <!-- Âè≥È°µ -->
        <div class="diary-page right">
          <div id="bag-check-section" style="display:none; height:100%; flex-direction:column;">
    <!-- Êñ∞Â¢ûÔºö‰ªäÊó•Á©øÊê≠Âå∫Âüü Start -->
    <div style="background:rgba(255,255,255,0.5); padding:10px; margin-bottom:15px; border-radius:4px; border:1px dashed #8d6e63;">
        <div style="font-weight:bold; color:#5d4037; font-size:0.9rem; margin-bottom:5px;">üëó OOTD (‰ªäÊó•Á©øÊê≠)</div>
        <div id="diary-ootd-content" style="font-size:0.85rem; color:#4e342e; line-height:1.4;"></div>
    </div>
    <!-- Êñ∞Â¢ûÔºö‰ªäÊó•Á©øÊê≠Âå∫Âüü End -->

    <div style="border-bottom:2px double #8d6e63; padding-bottom:10px; margin-bottom:15px; text-align:center; font-weight:bold; color:#5d4037;">
        üëú BAG CHECK
    </div>
    <div id="bag-items-list" style="flex:1; overflow-y:auto;"></div>
</div>
            
            <div id="bag-cover-section" style="height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column;">
                <button class="m-btn small" onclick="toggleBagCheck()" style="background:#8d6e63; color:white; padding:10px 20px;">
                    üîç Êü•Áúã‰ªñÂΩìÊó∂Êê∫Â∏¶Áâ©ÂìÅ
                </button>
            </div>
        </div>
    </div>

    <div style="position:absolute; bottom:30px; width:100%; display:flex; justify-content:center; gap:15px; z-index:10;">
        <button class="m-btn primary" onclick="startDiaryDrawing()" style="box-shadow:0 5px 15px rgba(0,0,0,0.5);">üé≤ ÊäΩÂèñ‰ªäÊó•ÂëΩËøê (ÁîüÊàê)</button>
    </div>
</div>
    </div>

<!-- Êñ∞Â¢ûÔºöÊó•ËÆ∞‰∏ìÁî®ÁâåÊ°å (ÂÆåÂÖ®Â§çÂà∂Ê∏∏ÊàèÁâåÊ°åÈÄªËæë) -->
<div id="diary-card-table-modal" class="modal-overlay" style="background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(5px);">
    <div id="diary-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px;">
        <div id="diary-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;"></div>
        <div class="card-table-ui">
            <div style="color:#fff; text-shadow:0 1px 5px #000; font-weight:bold;">
                ËØ∑ÊäΩÂèñÂá†Âº†ÁâåÊù•ÂÜ≥ÂÆö‰ªñ‰ªäÂ§©ÁªèÂéÜ‰∫Ü‰ªÄ‰πà... (<span id="diary-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishDiaryDrawing()">‚úçÔ∏è ÂºÄÂßã‰π¶ÂÜôÊó•ËÆ∞</button>
            <button class="m-btn secondary" onclick="document.getElementById('diary-card-table-modal').style.display='none'">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
</div>
<div id="photo-viewer-modal" class="modal-overlay" onclick="closePhotoViewer()">
    <div id="held-photo" class="held-photo-card" onclick="event.stopPropagation()">
        <img id="held-photo-img" class="held-photo-img">
        <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-family:'Courier New'; color:#555;" id="photo-date-str">2026-01-25</span>
            <button class="m-btn small" style="background:#ffcdd2; color:#c62828;" onclick="deleteCurrentPhoto()">ÊíïÊØÅÁÖßÁâá</button>
        </div>
    </div>
</div>
<div id="anniversary-modal" class="modal-overlay">
    <div class="modal-header" style="background:#cba8a8; color:white;">
        <span>Days Matter ¬∑ Á∫™ÂøµÊó•</span>
        <div style="display:flex; gap:10px;">
            <button class="m-btn small" onclick="openAddAnniversaryView()" style="background:white; color:#8d6e63;">+ Êñ∞Âª∫</button>
            <button class="close-btn" onclick="document.getElementById('anniversary-modal').style.display='none'" style="color:white;">√ó</button>
        </div>
    </div>
    <div id="anniversary-list-view" class="modal-body" style="padding:15px; gap:15px;">
    </div>
    <div id="anniversary-add-view" class="modal-body" style="display:none; background:#fff;">
        <div class="morandi-card">
            <h3>Êñ∞Âª∫Á∫™ÂøµÊó•</h3>
            <div class="input-group">
                <label>‰∫ã‰ª∂ÂêçÁß∞</label>
                <input type="text" id="ann-title" placeholder="‰æãÂ¶Ç: ÊÅãÁà±Á∫™ÂøµÊó• / ‰πüÊòØÁîüÊó•">
            </div>
            <div class="input-group">
                <label>ÁõÆÊ†áÊó•Êúü</label>
                <input type="date" id="ann-date">
            </div>
            
            <div class="input-group">
                <label>Ëá™ÂÆö‰πâËÉåÊôØÂõæ</label>
                <input type="file" id="ann-bg-input" accept="image/*">
            </div>

            <div class="input-group">
                <label>ÈáçÂ§ç‰∏éÊèêÈÜí</label>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <input type="checkbox" id="ann-repeat" style="width:auto;"> 
                    <span>ÊØèÂπ¥ÈáçÂ§ç (ÊåâÂÖ¨ÂéÜ)</span>
                </div>
                <select id="ann-remind-type">
                    <option value="none">‰∏çÊèêÈÜí</option>
                    <option value="same">ÂΩìÂ§©ÊèêÈÜí</option>
                    <option value="before">ÊèêÂâç1Â§©ÊèêÈÜí</option>
                </select>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="m-btn secondary" onclick="closeAddAnniversaryView()">ÂèñÊ∂à</button>
                <button class="m-btn primary" onclick="saveAnniversary()" style="background:#cba8a8;">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</div>
<div id="dream-app-modal" class="modal-overlay" style="background:#f3e5f5;">
       <div class="modal-header" style="background:#fff; color:#6a1b9a; border-bottom: 1px solid rgba(0,0,0,0.1);">
        <select id="dream-mode-select" onchange="updateDreamUI()" style="border:none; font-family: 'Ma Shan Zheng', cursive; font-size: 1.1rem; color:#6a1b9a; background:transparent; outline:none; font-weight:bold; width: 220px;">
            <option value="partner">ü¶Ñ Ê¢¶Áî∑/Ê¢¶Â•≥Ëß£Êûê</option>
            <option value="become">üé≠ ‰ªñÂèòÊàê‰Ω†ÁöÑ‰∏ÄÂ§©</option>
            <option value="cosplay">üëò ‰ªñ‰Ωú‰∏∫‰Ω†ÁöÑCoser</option>
<option value="meeting">üíò ÂÖ≥‰∫éÁõ∏ÈÅá (ÂàùËßÅÂç∞Ë±°)</option>
            <option value="char_beauty">üíã ÂøÖÂêÉÊ¶úÔºöTaÁöÑÊéíÂêç</option>
            <option value="user_beauty">üòã ÂøÖÂêÉÊ¶úÔºö‰Ω†ÁöÑÊéíÂêç</option>
            <option value="char_sleep">üåô Â§úË¢≠ÔºöTaÂØπ‰Ω†...</option>
            <option value="user_sleep">üí§ Â§úË¢≠Ôºö‰Ω†ÂØπTa...</option>
        </select>
        <div style="display:flex; gap:10px;">
            <button class="m-btn small" onclick="toggleDreamHistory()" style="background:transparent; color:#6a1b9a;">üìú ÂéÜÂè≤</button>
            <button class="close-btn" onclick="closeDreamApp()" style="color:#6a1b9a;">√ó</button>
        </div>
    </div>
    <div id="dream-history-panel" class="chat-settings-panel">
        <h3>ü¶Ñ ÂàÜÊûêËÆ∞ÂΩï</h3>
        <button class="m-btn small" onclick="toggleDreamHistory()" style="margin-bottom:10px; background:#e1bee7;">ÂÖ≥Èó≠</button>
        <div id="dream-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div class="modal-body" style="padding:20px; display:flex; flex-direction:column; align-items:center;">
        <div class="morandi-card" style="width:100%; text-align:center; padding:30px 20px; margin-bottom:20px; background:rgba(255,255,255,0.8);">
            <div style="font-size:3rem; margin-bottom:15px;">üí≠</div>
            <h2 style="font-size:1.1rem; color:#4a148c; margin-bottom:10px; line-height:1.4;">
                ÊÉ≥Áü•ÈÅìtaÂÅö‰Ω†ÁöÑÊ¢¶Áî∑/Ê¢¶Â•≥Êó∂<br>‰ºöÂèëÁîü‰ªÄ‰πàÂêóÔºü
            </h2>
            <p style="font-size:0.9rem; color:#7b1fa2; margin-bottom:20px;">
                ËØ∑Âú®ÂøÉ‰∏≠ÈªòÂøµËøô‰∏™ÈóÆÈ¢òÔºå<br>ÁÑ∂ÂêéÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊäΩÁâå„ÄÇ
            </p>
            <button class="m-btn primary" onclick="startDreamDrawing()" style="background:linear-gradient(45deg, #ab47bc, #7b1fa2); border:none; padding:12px 30px; font-size:1rem; box-shadow:0 4px 15px rgba(123, 31, 162, 0.3);">
                üé¥ ÂºÄÂßãÊäΩÁâåËß£Êûê
            </button>
        </div>
        <div id="dream-result-area" style="width:100%; display:none;">
            <div class="morandi-card" style="width:100%; padding:0; overflow:hidden;">
                <div style="background:#6a1b9a; color:white; padding:10px; text-align:center; font-weight:bold;">
                    Ëß£ÊûêÊä•Âëä
                </div>
                <div id="dream-analysis-content" style="padding:15px; font-size:0.9rem; overflow-x:auto;">
                    <div class="skeleton-text">Ê≠£Âú®ËøûÊé•Ê¢¶Â¢ÉÊΩúÊÑèËØÜ...</div>
                </div>
            </div>
<button id="btn-dream-save" class="m-btn small" onclick="saveDreamResultToHistory()" style="width:100%; margin-top:10px; background:#d1c4e9; color:#4a148c;">üíæ ‰øùÂ≠òËøô‰ªΩÊä•Âëä</button>
        </div>

    </div>
</div>
<div id="dream-card-table-modal" class="modal-overlay" style="background: rgba(40, 10, 60, 0.85); backdrop-filter: blur(5px);">
    <div id="dream-card-table-desk">
        <div id="dream-card-area">
        </div>
        <div class="card-table-ui">
            <div style="color:#e0c3fc; text-shadow:0 1px 5px #4a148c; font-size:1.1rem; font-weight:bold;">
                ÈªòÂøµ‚ÄúÂ¶ÇÊûú‰ªñÊòØÊàëÁöÑÊ¢¶Ëßí...‚ÄùÂπ∂ÊäΩÁâå (<span id="dream-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishDreamDrawing()" style="background:linear-gradient(45deg, #ab47bc, #7b1fa2); border:none; box-shadow:0 0 15px rgba(123, 31, 162, 0.5);">
                ü¶Ñ ÁîüÊàêÊ¢¶Â¢ÉËß£Êûê
            </button>
            <button class="m-btn secondary" onclick="closeDreamCardTable()" style="background:rgba(255,255,255,0.2); color:white;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<div id="his-phone-modal" class="modal-overlay" style="background: #000;">
    <div id="hp-intro-view" style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; animation: fadeIn 1s;">
        <div style="font-size:4rem; margin-bottom:20px;">üìµ</div>
        <h2 style="font-weight:normal; letter-spacing:2px; text-align:center;">‰Ω†‰ªäÂ§©Êç°Âà∞‰∫ÜtaÁöÑÊâãÊú∫<br><span style="font-size:1rem; opacity:0.7;">ÈùôÂøÉÊü•Áúã...</span></h2>
        <button class="m-btn primary" onclick="startHisPhoneDrawing()" style="margin-top:40px; border:1px solid white; background:transparent;">ÂºÄÂßãÁ†¥Ëß£ÂØÜÁ†Å (ÊäΩÁâå)</button>
        <button class="m-btn small" onclick="toggleHisPhoneHistory()" style="margin-top:20px; color:#999; background:transparent;">Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩï</button>
    </div>
    <div id="hp-history-panel" class="chat-settings-panel">
        <h3>üìµ ÊãæÂèñËÆ∞ÂΩï</h3>
        <button class="m-btn small" onclick="toggleHisPhoneHistory()" style="margin-bottom:10px;">ÂÖ≥Èó≠</button>
        <div id="hp-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
    <div id="hp-card-view" style="display:none; width:100%; height:100%; flex-direction:column; background:radial-gradient(circle, #2c3e50, #000);">
        <div id="hp-card-desk" style="flex:1; overflow-y:auto; position:relative;">
            <div id="hp-card-area" style="width:100%; height:100%; position:relative;"></div>
        </div>
        <div class="card-table-ui" style="background:rgba(0,0,0,0.8); width:100%; padding:20px; position:static;">
            <div style="color:white; margin-bottom:10px;">ËØ∑ÊäΩÂèñËÉΩÂ§üÊè≠Á§∫‰ªñÂÜÖÂøÉÁöÑÁâå (<span id="hp-flipped-count">0</span>)</div>
            <button class="m-btn primary" onclick="finishHisPhoneReading()">üîì Ëß£ÈîÅÊâãÊú∫ (ÁîüÊàêÂÜÖÂÆπ)</button>
            <button class="m-btn secondary" onclick="closeHisPhoneApp()">ÊîæÂºÉ</button>
        </div>
    </div>
    <div id="hp-os-view" style="display:none; width:100%; height:100%; background: #111; flex-direction:column; position:relative; overflow:hidden;">
        <div style="height:30px; display:flex; justify-content:space-between; padding:5px 15px; color:white; font-size:0.8rem; background:rgba(0,0,0,0.2);">
            <span>4G</span>
            <span id="hp-clock">12:00</span>
            <span>üîã 88%</span>
        </div>
        <div id="hp-home-screen" style="flex:1; display:grid; grid-template-columns:repeat(4, 1fr); grid-template-rows:repeat(5, 1fr); padding:20px; gap:15px; align-content:start;">
        </div>
<!-- ÊâæÂà∞ id="hp-os-view" ÂÜÖÈÉ® -->

<!-- ... ‰∏äÈù¢ÊòØ hp-home-screen ... -->

<!-- üëáüëáüëá Â∞ÜÂéüÊù•ÁöÑ Dock Ê†èÊõøÊç¢‰∏∫Ëøô‰∏™ üëáüëáüëá -->
<div style="height:90px; background:rgba(255,255,255,0.2); backdrop-filter:blur(15px); display:flex; justify-content:space-around; align-items:center; padding:10px; border-radius:24px; margin:15px 10px 30px 10px; border:1px solid rgba(255,255,255,0.3);">
     <!-- ÁîµËØù (ËøôÈáåÁî®ÂæÆ‰ø°ÂõæÊ†á‰ª£ÊõøÔºåÊàñËÄÖ‰Ω†ÂèØ‰ª•Êç¢Âà´ÁöÑÈìæÊé•) -->
     <div class="hp-app-icon" style="background-image:url('https://i.postimg.cc/JhDgJLPt/IMG_1923.png'); width:55px; height:55px;" onclick="openFakeApp('wechat')"></div>
     
     <!-- ÊµèËßàÂô® -->
     <div class="hp-app-icon" style="background-image:url('https://i.postimg.cc/9fRSThJX/IMG_1929.png'); width:55px; height:55px;" onclick="openFakeApp('browser')"></div>
     
     <!-- Â§áÂøòÂΩï -->
     <div class="hp-app-icon" style="background-image:url('https://i.postimg.cc/XvGhFbQq/IMG_1926.png'); width:55px; height:55px;" onclick="openFakeApp('memo')"></div>
     
     <!-- Áõ∏ÂÜå -->
     <div class="hp-app-icon" style="background-image:url('https://i.postimg.cc/pdh78HqP/IMG_1930.png'); width:55px; height:55px;" onclick="openFakeApp('photos')"></div>
</div>


        <!-- ‰øÆÊîπ top ÁöÑÂÄº‰∏∫ calc(var(--safe-top) + 20px) -->
<div style="position:absolute; top:calc(var(--safe-top) + 20px); right:10px; z-index:100;">
     <button class="m-btn small" onclick="closeHisPhoneApp()" style="background:rgba(0,0,0,0.5); color:white;">ÂÖ≥Êú∫</button>
     <button class="m-btn small" id="btn-hp-save" onclick="saveHisPhoneResult()" style="background:rgba(255,255,255,0.2); color:white;">üíæ ‰øùÂ≠òËØÅÊçÆ</button>
</div>
        </div>
        <div id="hp-app-detail-modal" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:200; display:none; flex-direction:column; animation: slideUp 0.3s;">
            <div class="hp-app-header" id="hp-app-header" style="height:50px; background:#eee; display:flex; align-items:center; padding:0 10px;">
                <button onclick="closeFakeApp()" style="border:none; background:none; font-size:1.2rem;">‚ùÆ ËøîÂõû</button>
                <span id="hp-app-title" style="margin-left:10px; font-weight:bold;">Â∫îÁî®Âêç</span>
            </div>
            <div id="hp-app-content" style="flex:1; overflow-y:auto; padding:15px; background:#f5f5f5;"></div>
        </div>
    </div>
</div>
<div id="study-modal" class="modal-overlay" style="background: #f0f4f8;">
    <div class="modal-header" style="background: #fff; color: #37474f; border-bottom: 1px solid #cfd8dc;">
        <span style="font-weight:bold;">Â≠¶‰π†ËÆ°Âàí ¬∑ Study With Me</span>
        <button class="close-btn" onclick="closeStudyApp()" style="color:#37474f;">√ó</button>
    </div>

    <div class="modal-body" style="padding: 15px;">
        <div id="study-create-view" style="display:none; flex-direction:column; gap:15px;">
            <div class="morandi-card" style="text-align:center; padding:30px 20px;">
                <div style="font-size:3rem; margin-bottom:10px;">üéì</div>
                <h3 style="color:#455a64; margin-bottom:10px;">ÂºÄÂêØÊñ∞ÁöÑÂ≠¶‰π†ÊóÖÁ®ã</h3>
                <p style="font-size:0.9rem; color:#78909c;">ÂëäËØâTa‰Ω†ÁöÑÁõÆÊ†áÔºåËÆ©Ta‰∏∫‰Ω†Âà∂ÂÆö‰∏ìÂ±ûËÆ°Âàí„ÄÇ</p>
            </div>

            <div class="morandi-card">
                <div class="input-group">
                    <label>Â≠¶‰π†ÁõÆÊ†á / ÂÜÖÂÆπ</label>
                    <input type="text" id="study-goal" placeholder="‰æãÂ¶ÇÔºöËÉåËÄÉÁ†îÂçïËØç„ÄÅÂ≠¶‰π†PythonÂü∫Á°Ä...">
                </div>
                <div class="input-group">
                    <label>Âë®Êúü / Êó∂Èó¥</label>
                    <input type="text" id="study-period" placeholder="‰æãÂ¶ÇÔºö30Â§©ÔºåÊØèÂ§©1Â∞èÊó∂">
                </div>
                <div class="input-group">
                    <label>ÁõÆÂâçÊÉÖÂÜµ / ÈöæÁÇπ</label>
                    <textarea id="study-status" class="editor-textarea" style="height:80px;" placeholder="‰æãÂ¶ÇÔºöÈõ∂Âü∫Á°ÄÔºåÂÆπÊòìÂàÜÂøÉ..."></textarea>
                </div>
                
                <div class="input-group" style="margin-top:10px;">
                     <label style="display:flex; align-items:center;">
                        <input type="checkbox" id="study-use-wb" checked style="width:auto; margin-right:5px;"> 
                        <span>ÂºïÁî®‰∏ñÁïå‰π¶‰∫∫ËÆæ (ÁîüÊàêËßíËâ≤ËØ≠Ê∞îÁöÑÈºìÂä±)</span>
                    </label>
                </div>

                <button class="m-btn primary" id="btn-study-gen" onclick="generateStudyPlan()" style="width:100%; margin-top:15px; background:#546e7a;">ÁîüÊàêËÆ°Âàí ‚ú®</button>
            </div>
        </div>
        <div id="study-list-view" style="display:none; flex-direction:column; height:100%;">
            <div class="morandi-card" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); color:white; margin-bottom:15px;">
                <div style="font-size:1.1rem; font-weight:bold;" id="study-plan-title">ÊàëÁöÑËÆ°Âàí</div>
                <div style="font-size:0.8rem; opacity:0.8; margin-top:5px;" id="study-plan-meta">Âë®Êúü: --</div>
                <div style="margin-top:15px; font-size:0.9rem;">
                    ËøõÂ∫¶: <span id="study-progress-text">0/0</span>
                </div>
                <div style="background:rgba(255,255,255,0.2); height:6px; border-radius:3px; margin-top:5px; overflow:hidden;">
                    <div id="study-progress-bar" style="width:0%; height:100%; background:#80cbc4; transition:width 0.3s;"></div>
                </div>
            </div>
            <div id="study-tasks-container" style="flex:1; overflow-y:auto; padding-bottom:50px;">
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button class="m-btn small" onclick="deleteStudyPlan()" style="background:#ffcdd2; color:#c62828; border:none;">üóëÔ∏è Âà†Èô§ÂΩìÂâçËÆ°Âàí</button>
            </div>
        </div>

    </div>
</div>
<div id="theme-modal" class="modal-overlay">
    <div class="modal-header" style="background:#fff;">
        <span style="font-weight:bold;">Á≥ªÁªüÁæéÂåñ‰∏≠ÂøÉ</span>
        <button class="close-btn" onclick="document.getElementById('theme-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body" style="background:#f9f9f9;">
        <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;">
    <button class="m-btn small" onclick="switchThemeTab('icons')">ÂõæÊ†á</button>
    <button class="m-btn small" onclick="switchThemeTab('covers')">ÈÄöÁî®ËÉåÊôØ</button>
    <button class="m-btn small" onclick="switchThemeTab('appbgs')">ËΩØ‰ª∂Áã¨Á´ãËÉåÊôØ</button> <!-- Êñ∞Â¢û -->
    <button class="m-btn small" onclick="switchThemeTab('fonts')">Â≠ó‰Ωì</button>
    <button class="m-btn small" onclick="switchThemeTab('css')">ÂÖ®Â±ÄCSS</button> <!-- Êñ∞Â¢û -->
    <button class="m-btn small" onclick="switchThemeTab('stamps')">Âõû‰ø°Âç∞Á´†</button>
</div>
        <div id="theme-tab-icons" class="theme-tab-content">
            <div class="morandi-card">
                <h3>Êõ¥ÊîπÂ∫îÁî®ÂõæÊ†á</h3>
                <p style="font-size:0.8rem; color:#888;">ÁÇπÂáª‰∏ãÊñπÂ∫îÁî®Âêç‰∏ä‰º†Êñ∞ÂõæÊ†á (ÊîØÊåÅPNGÈÄèÊòé)</p>
                <div id="app-icon-list" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px;">
                </div>
            </div>
        </div>
        <div id="theme-tab-covers" class="theme-tab-content" style="display:none;">
            <div class="morandi-card">
<hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
<h4 style="color:#d35400;">üì∫ ÁªÑ‰ª∂Â§ñÂ£≥ÂÆöÂà∂</h4>

<div class="input-group">
    <label>Á¨¨1È°µÔºöÁîµËßÜÊú∫Â§ñÂ£≥ (TV Shell)</label>
    <input type="file" onchange="uploadThemeImage('shell_tv', this)">
</div>
<div class="input-group">
    <label style="color:#d35400; font-weight:bold;">üì∫ ÁîµËßÜÊú∫Â±èÂπïÂÜÖÂÆπ (TV Screen)</label>
    <input type="file" onchange="uploadThemeImage('tv_screen_content', this)">
</div>
<div class="input-group">
    <label>Á¨¨2È°µÔºöÊ∏∏ÊàèÊú∫Â§ñÂ£≥ (Game P2)</label>
    <input type="file" onchange="uploadThemeImage('shell_console_p2', this)">
</div>
<div class="input-group">
    <label>Á¨¨3È°µÔºöRPGÊú∫Â§ñÂ£≥ (Game P3)</label>
    <input type="file" onchange="uploadThemeImage('shell_console_p3', this)">
</div>
                <h3>ÁªÑ‰ª∂‰∏éËÉåÊôØ</h3>
        <div class="input-group">
            <label style="color:#d81b60; font-weight:bold;">üè† ‰∏ªÈ°µÂ£ÅÁ∫∏ (Main Wallpaper)</label>
            <input type="file" onchange="uploadThemeImage('main_bg', this)">
        </div>
                <div class="input-group"><label>Â°îÁΩóÁâå-ÁâåËÉå</label><input type="file" onchange="uploadThemeImage('tarot_back', this)"></div>
                <div class="input-group"><label>Â°îÁΩóÁâå-ÁâåÊ°åËÉåÊôØ</label><input type="file" onchange="uploadThemeImage('tarot_table', this)"></div>
                <div class="input-group"><label>ÂÜ∞ÁÆ±ÁªÑ‰ª∂Â∞ÅÈù¢</label><input type="file" onchange="uploadThemeImage('fridge_cover', this)"></div>
<div class="input-group"><label>Á¨¨‰∫åÈ°µÁöÑÊ∏∏ÊàèÊú∫Â∞ÅÈù¢</label><input type="file" onchange="uploadThemeImage('game_cover_p2', this)"></div>
<hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
        <h4 style="color:#8e44ad;">üìñ ÊïÖ‰∫ã‰∏éÂ±èÂπïÂÆöÂà∂</h4>
        
        <div class="input-group">
            <label>RPGÊïÖ‰∫ã‰π¶-ÂÜÖÈ°µËÉåÊôØ (Story Notebook)</label>
            <!-- ËøôÈáåÁöÑ key ÊòØ rpg_book_paper -->
            <input type="file" onchange="uploadThemeImage('rpg_book_paper', this)">
        </div>

        <div class="input-group">
            <label>RPGÊ∏∏ÊàèÊú∫-‰∏≠Èó¥Â±èÂπïÂõæ (P3 Screen)</label>
            <!-- ËøôÈáåÁöÑ key ÊòØ console_p3_screen_img -->
            <input type="file" onchange="uploadThemeImage('console_p3_screen_img', this)">
        </div>
<!-- ‰∏ãÈù¢Ëøô‰∫õÊòØ‰Ω†ÊèêÂà∞Ê≤°ÁîüÊïàÁöÑÔºå‰ª£Á†ÅÈÄªËæëÈáå‰ºö‰øÆÂ§çÂÆÉ‰ª¨ -->
<div class="input-group"><label>Êó•ËÆ∞Ê°åÈù¢Â§ñËßÇ (Card)</label><input type="file" onchange="uploadThemeImage('diary_widget_bg', this)"></div>
<div class="input-group"><label>Êä•Á∫∏Â∞ÅÈù¢Â∫ïÂõæ</label><input type="file" onchange="uploadThemeImage('news_cover', this)"></div>
<div class="input-group"><label>ËÄÅÁ¶èÁâπÂç°Èù¢Â∫ïÂõæ</label><input type="file" onchange="uploadThemeImage('lofter_cover', this)"></div>
<div class="input-group"><label>Â°îÁΩóÁâå-ÁâåËÉåÂõæÊ°à</label><input type="file" onchange="uploadThemeImage('tarot_back', this)"></div>
<div class="input-group">
    <label style="color:#d81b60;">üå∏ È¶ôÁâáÊî∂ÈõÜ-‰∏ìÁî®ÁâåËÉå</label>
    <input type="file" onchange="uploadThemeImage('scent_back', this)">
</div>
<div class="input-group"><label>Â°îÁΩóÁâå-ÁâåÊ°åËÉåÊôØ</label><input type="file" onchange="uploadThemeImage('tarot_table', this)"></div>
<div class="input-group"><label>Âõû‰ø°‰ø°Á∫∏ËÉåÊôØ</label><input type="file" onchange="uploadThemeImage('letter_paper', this)"></div>
<!-- === ‰øÆÊîπÁªìÊùü === -->
<div class="input-group"><label>Ê∏∏ÊàèÊú∫-ÂÜÖÈÉ®ËÉåÊôØ</label><input type="file" onchange="uploadThemeImage('game_bg', this)"></div>
<!-- Âú®ÁæéÂåñÂºπÁ™óÁöÑ HTML ‰∏≠ÊâæÂú∞ÊñπÊèíÂÖ•Ëøô‰∏™ -->
<div class="input-group"><label>Êó•ËÆ∞Êú¨-ÂÜÖÈ°µË¥¥ÁöÑÁÖßÁâá</label><input type="file" onchange="uploadThemeImage('diary_photo', this)"></div>
<div class="input-group"><label>Ê∏∏ÊàèÊú∫-ËßíËâ≤ÂçäË∫´(Â∑¶)</label><input type="file" onchange="uploadThemeImage('game_char_half', this)"></div>
<div class="input-group"><label>Ê∏∏ÊàèÊú∫-Áî®Êà∑ÂçäË∫´(Âè≥)</label><input type="file" onchange="uploadThemeImage('game_user_half', this)"></div>
<hr style="margin:15px 0; border:0; border-top:1px dashed #ccc;">
<h4 style="margin-bottom:10px; color:#555;">üéÆ RPG ËßíËâ≤ÁöÆËÇ§ËÆæÁΩÆ</h4>
<div class="input-group"><label>Áé©ÂÆ∂-ÂæÖÊú∫ (Idle)</label><input type="file" onchange="uploadThemeImage('rpg_user_idle', this)"></div>
<div class="input-group"><label>Áé©ÂÆ∂-Ê≠£Èù¢Ë°åËµ∞ (Down)</label><input type="file" onchange="uploadThemeImage('rpg_user_front', this)"></div>
<div class="input-group"><label>Áé©ÂÆ∂-ËÉåÈù¢Ë°åËµ∞ (Up)</label><input type="file" onchange="uploadThemeImage('rpg_user_back', this)"></div>
<div class="input-group"><label>Áé©ÂÆ∂-ÂêëÂè≥Ë°åËµ∞ (Right)</label><input type="file" onchange="uploadThemeImage('rpg_user_right', this)"></div>
<div class="input-group"><label>Áé©ÂÆ∂-ÂêëÂ∑¶Ë°åËµ∞ (Left)</label><input type="file" onchange="uploadThemeImage('rpg_user_left', this)"></div>

<div class="input-group"><label>Áà±‰∫∫-ÂæÖÊú∫Âõæ</label><input type="file" onchange="uploadThemeImage('rpg_npc_idle', this)"></div>
<!-- Êñ∞Â¢û NPC Ë°åËµ∞ÁöÆËÇ§ËÆæÁΩÆ -->
<div class="input-group"><label>Áà±‰∫∫-Ê≠£Èù¢Ë°åËµ∞ (Down)</label><input type="file" onchange="uploadThemeImage('rpg_npc_front', this)"></div>
<div class="input-group"><label>Áà±‰∫∫-ËÉåÈù¢Ë°åËµ∞ (Up)</label><input type="file" onchange="uploadThemeImage('rpg_npc_back', this)"></div>
<div class="input-group"><label>Áà±‰∫∫-ÂêëÂè≥Ë°åËµ∞ (Right)</label><input type="file" onchange="uploadThemeImage('rpg_npc_right', this)"></div>
<div style="font-size:0.7rem; color:#888; margin-bottom:10px;">(Ê≥®: NPCÂêëÂ∑¶Ëµ∞‰ºöËá™Âä®‰ΩøÁî®ÂêëÂè≥ÂõæÁöÑÈïúÂÉèÁøªËΩ¨)</div>
<!-- Â¶ÇÊûúÈúÄË¶ÅNPCË°åËµ∞Âõæ‰πüÂèØ‰ª•ÁÖßÁùÄ‰∏äÈù¢Âä† -->
                <button class="m-btn secondary" onclick="resetThemeImages()" style="margin-top:10px;">ÈáçÁΩÆÊâÄÊúâËÉåÊôØ</button>
            </div>
        </div>
        <div id="theme-tab-fonts" class="theme-tab-content" style="display:none;">
            <div class="morandi-card">
                <h3>ËΩØ‰ª∂Â≠ó‰ΩìËÆæÁΩÆ</h3>
                <p style="font-size:0.8rem; color:#888;">ËØ∑ËæìÂÖ•Â≠ó‰ΩìÊñá‰ª∂ÁöÑ URI ÈìæÊé• (Â¶Ç .ttf, .woff2)</p>
                <div id="font-config-list" style="display:flex; flex-direction:column; gap:10px;">
                </div>
            </div>
        </div>
<!-- Êñ∞Â¢ûÔºöËΩØ‰ª∂Áã¨Á´ãËÉåÊôØËÆæÁΩÆÈ°µ -->
<div id="theme-tab-appbgs" class="theme-tab-content" style="display:none;">
    <div class="morandi-card">
        <h3>ËΩØ‰ª∂Áã¨Á´ãËÉåÊôØ</h3>
        <p style="font-size:0.8rem; color:#888;">‰∏∫ÊØè‰∏™APPËÆæÁΩÆ‰∏çÂêåÁöÑËÉåÊôØÂõæ (Ë¶ÜÁõñÈÄöÁî®ËÉåÊôØ)</p>
        <!-- ËøôÈáå‰ºöÁî± JS Ëá™Âä®ÁîüÊàêÂàóË°® -->
        <div id="app-bg-config-list" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöÂÖ®Â±Ä CSS ËÆæÁΩÆÈ°µ -->
<div id="theme-tab-css" class="theme-tab-content" style="display:none;">
    <div class="morandi-card">
        <h3>ÂÖ®Â±ÄËá™ÂÆö‰πâ CSS</h3>
        <p style="font-size:0.8rem; color:#888;">È´òÁ∫ßÁé©ÂÆ∂‰∏ìÁî®„ÄÇÂèØ‰øÆÊîπÂ≠ó‰ΩìÈ¢úËâ≤„ÄÅÈöêËóèÂÖÉÁ¥†Á≠â„ÄÇ</p>
        <textarea id="global-css-input" class="editor-textarea" style="height:200px; font-family:monospace;" placeholder="/* Âú®Ê≠§ËæìÂÖ• CSS ‰ª£Á†Å */ body { ... }"></textarea>
        <button class="m-btn primary" onclick="saveGlobalCSS()" style="width:100%; margin-top:10px;">üíæ ‰øùÂ≠òÂπ∂ÁîüÊïà</button>
    </div>
</div>
        <div id="theme-tab-stamps" class="theme-tab-content" style="display:none;">
            <div class="morandi-card">
                <h3>Èöè‰ø°Á§ºÁâ©Âç∞Á´†</h3>
                <p style="font-size:0.8rem; color:#888;">‰∏ä‰º†Â§ö‰∏™ÂõæÁâáÔºåÂõû‰ø°Êó∂ÈöèÊú∫ÊäΩÂèñ‰∏Ä‰∏™ÁõñÂú®‰ø°Á∫∏‰∏äÔºåÁÇπÂáªËØ•Âç∞Á´†Âç≥ÂèØÊâìÂºÄÁ§ºÁâ©„ÄÇ</p>
                <input type="file" multiple accept="image/*" id="stamp-upload-input" style="display:none;" onchange="handleStampUpload(this)">
                <button class="m-btn primary" onclick="document.getElementById('stamp-upload-input').click()">+ ‰∏ä‰º†Âç∞Á´†ÂõæÁâá</button>
                
                <div id="stamp-preview-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-top:15px;">
                </div>
            </div>
        </div>

    </div>
</div>
<!-- üé¥ ÊäΩÂç°Á≥ªÁªü‰∏ªÁïåÈù¢ -->
<div id="gacha-card-modal" class="modal-overlay" style="background:#fff0f5; z-index:9000; display:none;">
    <div class="modal-header" style="background:#ff9a9e; color:white; border-bottom:1px solid #ff758c;">
        <span>Destiny Draw ¬∑ ÂëΩËøêÁæÅÁªä</span>
        <div style="display:flex; gap:10px;">
            <button class="m-btn small" onclick="openGachaSettings()" style="background:rgba(255,255,255,0.3); color:#fff;">‚öôÔ∏è ËÆæÁΩÆ</button>
            <button class="close-btn" onclick="closeGachaCardApp()" style="color:white;">√ó</button>
        </div>
    </div>

    <div class="modal-body" style="padding:0; overflow:hidden; display:flex; flex-direction:column; position:relative;">
        
        <!-- ËÉåÊôØË£ÖÈ•∞ -->
        <div style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0.1; background-image: repeating-linear-gradient(45deg, #ff9a9e 0, #ff9a9e 10px, #fff 10px, #fff 20px);"></div>

        <!-- È°∂ÈÉ®‰ø°ÊÅØ -->
        <div style="position:relative; z-index:2; padding:20px; text-align:center;">
            <div class="morandi-card" style="background:rgba(255,255,255,0.9); border:2px solid #ff9a9e;">
                <div style="color:#d63031; font-weight:bold; font-size:1.1rem;">‚ú® ÂΩìÂâçÊåÅÊúâÂà∏: <span id="gacha-ticket-count" style="font-size:1.5rem;">0</span></div>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">(ÊØèÂèëÈÄÅ 80 Êù°Ê∂àÊÅØËé∑Âæó 1 Âº†)</div>
                <div style="font-size:0.7rem; color:#888;">ÂÜçÂèë <span id="gacha-next-msg">80</span> Êù°Ê∂àÊÅØÂèØËé∑Âæó‰∏ÄÂº†</div>
            </div>
        </div>

        <!-- ÊäΩÂç°Â±ïÁ§∫Âå∫ (Á´ãÁªòÊàñBanner) -->
        <div style="flex:1; display:flex; align-items:center; justify-content:center; position:relative; z-index:2;">
            <div style="text-align:center; color:#ff758c; font-weight:bold; font-size:1.2rem; text-shadow:0 2px 5px rgba(255,255,255,0.8);">
                <div style="font-size:3rem; margin-bottom:10px;">üè∞</div>
                ‰∏éÂëΩ‰∏≠Ê≥®ÂÆöÁöÑÁæÅÁªäÁõ∏ÈÅá...
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆÂå∫ -->
        <div style="padding:20px; position:relative; z-index:2; display:flex; gap:15px; justify-content:center;">
            <button class="m-btn secondary" onclick="doGachaDraw(1)" style="flex:1; background:#fff; border:2px solid #ff9a9e; color:#ff758c; height:60px; font-size:1rem;">
                ÂçïÊ¨°Âè¨Âî§<br><span style="font-size:0.7rem;">(Ê∂àËÄó1Âà∏)</span>
            </button>
            <button class="m-btn primary" onclick="doGachaDraw(10)" style="flex:1; background:linear-gradient(to right, #ff9a9e, #fecfef); border:none; height:60px; font-size:1rem; box-shadow:0 5px 15px rgba(255, 117, 140, 0.4);">
                ÂçÅËøûÂè¨Âî§<br><span style="font-size:0.7rem;">(Ê∂àËÄó9Âà∏ ¬∑ ÂøÖÂæóSR)</span>
            </button>
        </div>

        <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂå∫Âüü -->
        <div style="background:#fff; height:150px; overflow-y:auto; padding:10px; border-top:1px solid #eee; position:relative; z-index:2;">
            <div style="font-size:0.8rem; color:#888; margin-bottom:5px; font-weight:bold;">üèÜ ‰∏≠Â•ñÂ±•ÂéÜ (SSR/UR)</div>
            <div id="gacha-history-list" style="font-size:0.75rem; color:#555;"></div>
        </div>
    </div>
</div>

<!-- üé¥ ÊäΩÂç°Âä®ÁîªÂ±Ç (ÂÖ®Â±èË¶ÜÁõñ) -->
<div id="gacha-animation-overlay" class="modal-overlay" style="background:rgba(0,0,0,0.9); z-index:9100; display:none; align-items:center; justify-content:center;">
    <div id="gacha-card-container" class="gacha-grid-container">
        <!-- JS Âä®ÊÄÅÁîüÊàêÂç°Áâá -->
    </div>
    <button class="m-btn secondary" onclick="closeGachaAnimation()" style="position:absolute; bottom:30px; z-index:100; opacity:0; transition:opacity 1s;" id="gacha-close-btn">Êî∂Ëµ∑</button>
</div>

<!-- üé¥ ËÆæÁΩÆ/‰∏ä‰º†ÂºπÁ™ó -->
<div id="gacha-settings-modal" class="modal-overlay" style="background:rgba(255,255,255,0.95); z-index:9200; display:none;">
    <div class="modal-header">
        <span>Âç°Ê±†ÈÖçÁΩÆ</span>
        <button class="close-btn" onclick="document.getElementById('gacha-settings-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div class="morandi-card">
            <h3>üñºÔ∏è Ëá™ÂÆö‰πâÂç°Èù¢ (Ê≠£Èù¢)</h3>
            <p style="font-size:0.8rem; color:#888;">Â¶ÇÊûú‰∏ç‰∏ä‰º†ÔºåÂ∞ÜÊòæÁ§∫ÈªòËÆ§Ëâ≤Âùó„ÄÇÂç°ËÉåÂíåËæπÊ°ÜÂ∑≤ÈîÅÂÆö„ÄÇ</p>
            <div class="input-group">
                <label>R Âç°Èù¢</label>
                <input type="file" accept="image/*" onchange="uploadGachaImage('r', this)">
            </div>
            <div class="input-group">
                <label>SR Âç°Èù¢</label>
                <input type="file" accept="image/*" onchange="uploadGachaImage('sr', this)">
            </div>
            <div class="input-group">
                <label>SSR Âç°Èù¢</label>
                <input type="file" accept="image/*" onchange="uploadGachaImage('ssr', this)">
            </div>
            <div class="input-group">
                <label>UR Âç°Èù¢</label>
                <input type="file" accept="image/*" onchange="uploadGachaImage('ur', this)">
            </div>
        </div>
        <div class="morandi-card">
            <h3>üõ†Ô∏è ÂºÄÂèëËÄÖÈÄöÈÅì</h3>
            <button class="m-btn small" onclick="openGachaCheat()" style="background:#eee; color:#333;">ËæìÂÖ•‰ª£Á†Å</button>
        </div>
    </div>
</div>
<div id="game-modal" class="modal-overlay">
    <div id="game-container" class="game-interface">
        <div class="game-stats-panel">
            <div id="game-char-avatar" class="game-avatar"></div>
            <div class="game-bars">
                <div class="g-bar-row">
                    <span>ÂøÉÊÉÖ</span>
                    <div class="g-bar-bg"><div id="bar-mood" class="g-bar-fill" style="width:50%; background:#00cec9;"></div></div>
                    <span id="val-mood" class="g-val">50</span>
                </div>
                <div class="g-bar-row">
                    <span>Â•ΩÊÑü</span>
                    <div class="g-bar-bg"><div id="bar-love" class="g-bar-fill" style="width:50%; background:#e84393;"></div></div>
                    <span id="val-love" class="g-val">50</span>
                </div>
            </div>
        </div>
        <button class="game-history-btn" onclick="toggleGameHistory()">üìú LOG</button>
        <button class="game-history-btn" onclick="closeGameApp()" style="right: 70px;">EXIT</button>
        <img id="game-img-char" class="half-body hb-char" src="" style="display:none">
        <img id="game-img-user" class="half-body hb-user" src="" style="display:none">
        <div class="rpg-dialog-box" onclick="showGameInput()">
            <div id="rpg-name" class="rpg-name">ÊÇ®</div>
            <div id="rpg-content" class="rpg-text">ÁÇπÂáªÊ≠§Â§ÑÂºÄÂßãËæìÂÖ•ÂØπËØù...</div>
            <div id="rpg-cards-info" class="card-meaning-display"></div>
        </div>
        <div id="game-input-layer" class="game-input-overlay">
            <div style="color:#fff; font-size:0.8rem;">ËØ∑ËæìÂÖ•‰Ω†ÁöÑË°åÂä®/ÂØπËØù (ÈöèÂêéÊäΩÂèñÂëΩËøêÁâå):</div>
            <div class="game-input-row">
                <input type="text" id="game-user-input" class="game-input" placeholder="...">
                <button class="m-btn primary" onclick="triggerGameDraw()" style="width:80px;">üé≤ ÊäΩÁâå</button>
            </div>
            <button class="m-btn small" onclick="hideGameInput()" style="background:#333; color:#ccc;">ÂèñÊ∂à</button>
        </div>

    </div>
    <div id="game-history-panel" class="chat-settings-panel">
        <h3>üíæ ÂÜíÈô©Êó•Âøó</h3>
        <button class="m-btn small" onclick="toggleGameHistory()" style="margin-bottom:10px;">ÂÖ≥Èó≠</button>
        <div id="game-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
</div>
<div id="game-card-table-modal" class="modal-overlay" style="background: rgba(20, 20, 30, 0.9); backdrop-filter: blur(5px);">
    <div id="game-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; box-shadow: inset 0 0 100px rgba(0,0,0,0.8); padding-bottom: 100px;">
        <div id="game-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
        </div>
        <div class="card-table-ui">
            <div style="color:#00cec9; text-shadow:0 1px 5px #000; font-size:1.1rem; font-weight:bold;">
                RPG ÂëΩËøêÂà§ÂÆö‰∏≠... (Â∑≤ÈÄâ: <span id="game-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishGameDrawing()" style="background:#0984e3; border:none; box-shadow:0 0 15px rgba(9, 132, 227, 0.5);">
                üé≤ Á°ÆËÆ§ÂëΩËøêÂπ∂ÁîüÊàêÂâßÊÉÖ
            </button>
            <button class="m-btn secondary" onclick="closeGameCardTable()" style="background:rgba(255,255,255,0.2); color:white;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<script>
window.BIG_MEMORY = window.BIG_MEMORY || {};
Object.assign(window.BIG_MEMORY, {
    fridge: null,           
    fridge_history: [],     
    api_profiles: [],     
    theme_fonts: {},     
    chat_settings: {}    
});
async function migrateAllRestrictedData() {
    console.log("‚ôªÔ∏è Ê≠£Âú®ÊâßË°åÂÖ®Á≥ªÁªüÊï∞ÊçÆËøÅÁßª...");
    const migrationMap = [
        ['fridge',          'fridge_data',     'fridge_data',     {condiments:{}, staples:{}, vegetables:[], meat:[]}],
        ['fridge_history',  'fridge_history',  'fridge_history',  []],
        ['api_profiles',    'api_profiles',    'api_profiles',    []],
        ['theme_fonts',     'theme_fonts',     'theme_fonts',     {}],
        ['chat_settings',   'chat_settings',   'chat_settings',   {}],
['diary_data', 'diary_data', 'diary_data', null]
    ];

    for (let [memKey, dbKey, localKey, defVal] of migrationMap) {
        try {
            let res = await idb.get('universal_store', dbKey);
            
            if (res) {
                window.BIG_MEMORY[memKey] = res.data;
            } else {
                let raw = localStorage.getItem(localKey);
                if (raw) {
                    try {
                        let parsed = JSON.parse(raw);
                        window.BIG_MEMORY[memKey] = parsed;
                        await idb.put('universal_store', { id: dbKey, data: parsed });
                        console.log(`‚úÖ [ËøÅÁßªÊàêÂäü] ${localKey} Â∑≤ÁßªÂÖ•Êó†ÈôêÂ≠òÂÇ®`);
            localStorage.removeItem(localKey); 
                    } catch(e) { window.BIG_MEMORY[memKey] = defVal; }
                } else {
                    window.BIG_MEMORY[memKey] = defVal;
                }
            }
        } catch (e) {
            console.error(`Âä†ËΩΩ ${memKey} Â§±Ë¥•`, e);
            window.BIG_MEMORY[memKey] = defVal;
        }
    }
    if(typeof renderFridgeContent === 'function' && document.getElementById('fridge-modal').style.display === 'flex') {
        renderFridgeContent();
    }
    if(typeof renderProfiles === 'function' && document.getElementById('settings-modal').style.display === 'flex') {
        renderProfiles();
    }
    if(typeof applyAllThemeSettings === 'function') applyAllThemeSettings();
    
    console.log("üéâ ÊâÄÊúâÂèóÈôêÊï∞ÊçÆÂ∑≤Ëß£ÊîæÔºÅÁ≥ªÁªüÁé∞Â∑≤ÂÆåÂÖ®ËøêË°åÂú®Êó†ÈôêÂ≠òÂÇ®Ê®°Âºè„ÄÇ");
}
window.getFridgeData = function() {
    const data = window.BIG_MEMORY.fridge || {};

    // 1. Ê†∏ÂøÉ‰øÆÂ§çÔºöË°•ÂÖ®Ë∞ÉÊñôÔºåÂπ∂Âä†ÂÖ•Êñ∞ÊàêÂëò
    if (!data.condiments || Object.keys(data.condiments).length === 0) {
        data.condiments = {
            "ËÄóÊ≤π": false, "ÁîüÊäΩ": false, "ËÄÅÊäΩ": false, // Êñ∞Â¢û
            "ÈÜã": false, "ÊñôÈÖí": false, "Ê≤π": false,
            "Áõê": false, "Á≥ñ": false, "ËÉ°Ê§íÁ≤â": false    // Êñ∞Â¢û
        };
    } else {
        // Â¶ÇÊûúÊòØËÄÅÁî®Êà∑ÔºåÊï∞ÊçÆÈáåÂèØËÉΩÊ≤°ÊúâÊñ∞Ë∞ÉÊñôÔºåËøôÈáåÂº∫Âà∂Ë°•‰∏ä
        if (data.condiments["ËÄÅÊäΩ"] === undefined) data.condiments["ËÄÅÊäΩ"] = false;
        if (data.condiments["ËÉ°Ê§íÁ≤â"] === undefined) data.condiments["ËÉ°Ê§íÁ≤â"] = false;
    }

    // 2. Ë°•ÂÖ®‰∏ªÈ£ü
    if (!data.staples) data.staples = { "Á±≥": false, "Èù¢": null, "Èù¢ÂåÖ": null };
    // 3. Ë°•ÂÖ®Êï∞ÁªÑ
    if (!data.vegetables) data.vegetables = [];
    if (!data.meat) data.meat = [];

    return data;
};
window.saveFridgeData = function(data) {
    window.BIG_MEMORY.fridge = data;
    idb.put('universal_store', { id: 'fridge_data', data: data });
};
window.getFridgeHistory = function() { return window.BIG_MEMORY.fridge_history || []; };
window.saveFridgeHistory = function(record) {
    const list = window.getFridgeHistory();
    list.unshift({ date: Date.now(), ...record });
    if(list.length > 50) list.pop();
    window.BIG_MEMORY.fridge_history = list;
    idb.put('universal_store', { id: 'fridge_history', data: list });
};
window.deleteFridgeHistory = function(index) {
    if(!confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const list = window.getFridgeHistory();
    list.splice(index, 1);
    window.BIG_MEMORY.fridge_history = list;
    idb.put('universal_store', { id: 'fridge_history', data: list });
    if(typeof renderFridgeHistory === 'function') renderFridgeHistory();
};
window.getProfiles = function() {
    return window.BIG_MEMORY.api_profiles || [];
};
window.saveProfiles = function(data) {
    window.BIG_MEMORY.api_profiles = data;
    idb.put('universal_store', { id: 'api_profiles', data: data });
};
window.saveAppFont = function(appId, url) {
    const fonts = window.BIG_MEMORY.theme_fonts || {};
    fonts[appId] = url;
    window.BIG_MEMORY.theme_fonts = fonts;
    idb.put('universal_store', { id: 'theme_fonts', data: fonts });
    if(typeof injectCustomFont === 'function') injectCustomFont(appId, url);
};
window.renderThemeFontsList = function() {
    const list = document.getElementById('font-config-list');
    list.innerHTML = '';
    const fonts = window.BIG_MEMORY.theme_fonts || {};
    if(typeof APP_MAP !== 'undefined') {
        APP_MAP.forEach(app => {
            const val = fonts[app.id] || "";
            const div = document.createElement('div');
            div.className = 'font-setting-item';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="margin:0;">${app.name}</label>
                    <button class="m-btn small" onclick="testFont('${app.id}')" style="font-size:0.7rem; padding:2px 8px; background:#eee; color:#666;">ÊµãËØï</button>
                </div>
                <input type="text" value="${val}" 
                    placeholder="Á≤òË¥¥Â≠ó‰ΩìÈìæÊé• (https://...)" 
                    style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-top:8px; font-size:0.85rem;"
                    onblur="saveAppFont('${app.id}', this.value)"
                >
            `;
            list.appendChild(div);
        });
    }
};
window.getChatSettings = function() {
    const def = {
        myFrame: '', botFrame: '', myCss: '', botCss: '', 
        delayMin: 1, delayMax: 5, countMin: 1, countMax: 3,
        passiveMin: 1, passiveMax: 60, title: "ÁßÅÂØÜËÅäÂ§©", isOnline: false,
        nudgeList: "ÂèëÂëÜ\nÁù°Ëßâ\nÊï∞Èí±\nÂπ≤È•≠\nÊë∏È±º",
        kaomojiList: "(ÔΩ°‚Ä¢ÃÄ·¥ó-)‚úß\n(‚âß‚àá‚â¶)Ôæâ\n( ¬¥ÔΩ•ÔΩ•)Ôæâ(._.`)\n(oÔæüvÔæü)„Éé\n(Ôø£y‚ñΩ,Ôø£)‚ï≠ ",
        
        kaomojiProb: 0.6 // üî¥ Êñ∞Â¢ûÔºöÈªòËÆ§ 60% Ê¶ÇÁéá
    };

    return { ...def, ...window.BIG_MEMORY.chat_settings };
};

// === üî¥ ‰øÆÂ§çÁâàÔºö‰øùÂ≠òËÆæÁΩÆÂáΩÊï∞ (ËØ∑ÂÆåÊï¥ÊõøÊç¢Ëøô‰∏™ÂáΩÊï∞) ===
window.saveChatSettings = function(extraData = {}) {
    // 1. Ëé∑ÂèñÂΩìÂâçÂÜÖÂ≠ò‰∏≠ÁöÑÊóßËÆæÁΩÆÔºåÈò≤Ê≠¢Ë¶ÜÁõñ
    let s = window.getChatSettings();
    
    // 2. Â∞ùËØï‰ªéÁïåÈù¢Ëé∑ÂèñÊñ∞ÂÄº (‰ΩøÁî®‰∫Ü ?. Èò≤Ê≠¢Êä•Èîô)
    const uiData = {
        myFrame: document.getElementById('set-my-frame')?.value,
        botFrame: document.getElementById('set-bot-frame')?.value,
        myCss: document.getElementById('set-my-css')?.value,
        botCss: document.getElementById('set-bot-css')?.value,
        delayMin: parseInt(document.getElementById('set-delay-min')?.value) || 1,
        delayMax: parseInt(document.getElementById('set-delay-max')?.value) || 5,
        countMin: parseInt(document.getElementById('set-count-min')?.value) || 1,
        countMax: parseInt(document.getElementById('set-count-max')?.value) || 3,
        passiveMin: parseInt(document.getElementById('set-passive-min')?.value) || 1,
        passiveMax: parseInt(document.getElementById('set-passive-max')?.value) || 60,
        title: document.getElementById('chat-title-input')?.value,
        nudgeList: document.getElementById('set-nudge-list')?.value,
        kaomojiList: document.getElementById('set-kaomoji-list')?.value, // Ê≥®ÊÑèËøôÈáå‰∏çË¶ÅÊúâÂ§ö‰ΩôÂ≠óÁ¨¶
        
        // Êñ∞Â¢ûÔºöËØªÂèñÈ¢úÊñáÂ≠óÈ¢ëÁéáÊªëÂùó (0-100 ËΩ¨‰∏∫ 0-1)
        // Â¶ÇÊûúÊªëÂùó‰∏çÂ≠òÂú®(Ê≤°ÊâìÂºÄËÆæÁΩÆÈù¢ÊùøÊó∂)ÔºåÈªòËÆ§‰øùÁïôÊóßÂÄº s.kaomojiProb
        kaomojiProb: document.getElementById('set-kaomoji-prob') 
                     ? (parseInt(document.getElementById('set-kaomoji-prob').value) || 0) / 100 
                     : s.kaomojiProb
    };

    // 3. ËøáÊª§Êéâ‰ªéÁïåÈù¢Ëé∑ÂèñÂà∞ÁöÑ undefined ÂÄº (Èò≤Ê≠¢ÊääÂ∑≤ÊúâÊï∞ÊçÆË¶ÜÁõñ‰∏∫Á©∫)
    Object.keys(uiData).forEach(key => {
        if (uiData[key] === undefined) delete uiData[key];
    });

    // 4. ÂêàÂπ∂Êï∞ÊçÆÔºöÊóßÊï∞ÊçÆ + ÁïåÈù¢Êñ∞Êï∞ÊçÆ + È¢ùÂ§ñÊï∞ÊçÆ
    const finalData = { ...s, ...uiData, ...extraData };
    
    // 5. ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ® (ÂÜÖÂ≠ò + Êï∞ÊçÆÂ∫ì)
    if(window.BIG_MEMORY) window.BIG_MEMORY.chat_settings = finalData;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'chat_settings', data: finalData });
       
    // 6. Á´ãÂç≥Â∫îÁî®Êõ¥Êîπ
    if(typeof applyChatSettings === 'function') applyChatSettings();
};

const bootCheck = setInterval(() => {
    if (typeof idb !== 'undefined' && idb.db) {
        clearInterval(bootCheck);
        migrateAllRestrictedData();
    }
}, 500);
    // ============================================================
    // üõ°Ô∏è ÂÖ®Â±ÄÂÆâÂÖ®Âç´Â£´ÔºöÊâÄÊúâ APP ÁöÑÂº∫Âà∂Âà†Èô§Ë°•‰∏Å (‰øÆÂ§çÊï∞ÊçÆÂ§çÊ¥ªBug)
    // ============================================================

    // 1. „ÄêÂ∞èÂâßÂú∫„ÄëÂΩªÂ∫ïÂà†Èô§
    window.deleteTheaterBook = async function(index) {
        if(!confirm("‚ö†Ô∏è ÂΩªÂ∫ïÈîÄÊØÅËøôÊú¨ÂâßÊú¨Ôºü(Âê´ÊâÄÊúâÁ´†ËäÇ)")) return;
        const list = await getTheaterHistory();
        if(!list[index]) return;
        
        const id = list[index].id;
        // Ê≠•È™§A: Âà†Ê≠£ÊñáÂÜÖÂÆπ
        await idb.delete('theater_data', `content_${id}`);
        localStorage.removeItem(`theater_content_${id}`); // Ê∏ÖÁºìÂ≠ò
        
        // Ê≠•È™§B: Âà†ÁõÆÂΩïÁ¥¢Âºï
        list.splice(index, 1);
        await saveTheaterHistory(list);
        
        if (id === currentTheaterId) {
            currentTheaterId = null;
            document.getElementById('theater-content-list').innerHTML = '';
        }
        await renderTheaterHistoryList();
    };

    window.deleteTheaterSegment = async function(index) {
        if (!confirm("Âà†Èô§ËøôÊÆµÂÜÖÂÆπÔºü")) return;
        const content = await getTheaterContent(currentTheaterId);
        content.splice(index, 1);
        // Âº∫Âà∂ÂêåÊ≠•‰øùÂ≠ò
        await saveTheaterContent(currentTheaterId, content); 
        await renderTheaterContent();
    };

    // 2. „ÄêÊç°ÊâãÊú∫„ÄëÂΩªÂ∫ïÂà†Èô§
    window.deletePickup = async function(index) {
        if(!confirm("üóëÔ∏è Âà†Èô§ËøôÊÆµÂØπËØùËÆ∞ÂΩïÔºü")) return;
        const list = await getPickupHistory();
        if(!list[index]) return;
        
        const id = list[index].id;
        await idb.delete('pickup_data', `chat_${id}`); // Âà†ÂÜÖÂÆπ
        
        list.splice(index, 1);
        await savePickupHistory(list); // Âà†Á¥¢Âºï
        
        if(id === currentPickupId) startNewPickup();
        else togglePickupHistory(); 
    };

    // 3. „Äê‰ø°‰ª∂„ÄëÂΩªÂ∫ïÂà†Èô§
    window.deleteCurrentLetter = function() {
        if (!currentLetterId) return;
        if (!confirm("üî• ÁÉßÊØÅËøôÂ∞Å‰ø°Ôºü(‰∏çÂèØÊÅ¢Â§ç)")) return;
        
        let letters = window.BIG_MEMORY.letters || [];
        // ‰ªéÂÜÖÂ≠ò‰∏≠ÁßªÈô§
        const newLetters = letters.filter(l => l.id !== currentLetterId);
        
        // Âº∫Âà∂ÂêåÊ≠•Âà∞Â§ßÊï∞ÊçÆÂ∫ì
        saveToBigDB('letters', newLetters);
        
        backToLetterList();
    };

    // 4. „ÄêÂ°îÁΩóÁâå„ÄëÂéÜÂè≤ËÆ∞ÂΩïÂΩªÂ∫ïÂà†Èô§
    window.deleteTarotHistory = function(index) {
        if(!confirm("üîÆ ÈÅóÂøòËøôÊÆµÂç†ÂçúËÆ∞ÂøÜÔºü")) return;
        
        const list = window.BIG_MEMORY.tarot_history || [];
        list.splice(index, 1);
        
        saveToBigDB('tarot_history', list); // Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
        localStorage.removeItem('tarot_history'); // Ê∏ÖÈô§ÊóßÁºìÂ≠ò
        
        loadTarotHistory();
    };

    // 5. „ÄêÊ¢¶App„ÄëÂéÜÂè≤ËÆ∞ÂΩïÂΩªÂ∫ïÂà†Èô§
    window.deleteDreamHistory = function(index) {
        if(!confirm("ü¶Ñ Âà†Èô§Ëøô‰∏™Ê¢¶Â¢ÉËß£ÊûêÔºü")) return;
        
        const list = window.BIG_MEMORY.dream_history || [];
        list.splice(index, 1);
        
        saveToBigDB('dream_history', list);
        localStorage.removeItem('dream_history'); // Ê∏ÖÈô§ÊóßÁºìÂ≠ò
        
        renderDreamHistory();
    };

    // 6. „ÄêTaÁöÑÊâãÊú∫„ÄëËØÅÊçÆÂΩªÂ∫ïÂà†Èô§
    window.deleteHisPhoneHistory = function(index) {
        if(!confirm("üìµ ÈîÄÊØÅËøôÊù°ÊâãÊú∫ËØÅÊçÆÔºü")) return;
        
        const list = window.BIG_MEMORY.his_phone_history || [];
        list.splice(index, 1);
        
        saveToBigDB('his_phone_history', list);
        localStorage.removeItem('his_phone_history'); // Ê∏ÖÈô§ÊóßÁºìÂ≠ò
        
        renderHisPhoneHistory();
    };

    // 7. „ÄêÂÜ∞ÁÆ±„Äë‰æøÁ≠æÂΩªÂ∫ïÂà†Èô§
    window.deleteFridgeHistory = function(index) {
        if(!confirm("ü•£ ÊíïÊéâËøôÂº†‰æøÁ≠æÔºü")) return;
        
        const list = window.BIG_MEMORY.fridge_history || [];
        list.splice(index, 1);
        
        saveToBigDB('fridge_history', list);
        localStorage.removeItem('fridge_history'); // Ê∏ÖÈô§ÊóßÁºìÂ≠ò
        
        renderFridgeHistory();
    };

    // 8. „ÄêËÆ∞Ë¥¶„ÄëË¥¶ÁõÆÂΩªÂ∫ïÂà†Èô§
    window.deleteFinance = function(id) {
        if (!confirm("üí∞ Âà†Èô§ËøôÁ¨îË¥¶ÁõÆÔºü")) return;
        
        let data = window.BIG_MEMORY.finance || [];
        data = data.filter(i => i.id !== id);
        
        saveToBigDB('finance', data);
        localStorage.removeItem('finance_data'); // Ê∏ÖÈô§ÊóßÁºìÂ≠ò
        
        renderFinanceUI();
    };

    // 9. „ÄêÁªèÊúü„ÄëËÆ∞ÂΩïÂΩªÂ∫ïÂà†Èô§
    window.deletePeriodRecord = function(index) {
        if(!confirm("üìÖ Âà†Èô§ËøôÊù°Âë®ÊúüËÆ∞ÂΩïÔºü")) return;
        
        const data = window.BIG_MEMORY.period;
        if(data && data.records) {
            data.records.sort((a, b) => new Date(b.start) - new Date(a.start));
            data.records.splice(index, 1);
            
            saveToBigDB('period', data);
            localStorage.removeItem('period_data'); // Ê∏ÖÈô§ÊóßÁºìÂ≠ò
            
            renderPeriodUI();
        }
    };
function toggleBagCheck() {
    const list = document.getElementById('bag-check-section');
    const btnDiv = document.getElementById('bag-cover-section');
    list.style.display = 'flex';
    btnDiv.style.display = 'none';
}
// === üöë Ë°•‰∏ÅÔºö‰øÆÂ§çÂâ©‰ΩôÂäüËÉΩÁöÑÊó†ÈôêÂ≠òÂÇ®‰∏éÂà†Èô§ ===

// 1. ‰øÆÂ§çÂ≠¶‰π†ËÆ°ÂàíÂà†Èô§
window.deleteStudyPlan = function() {
    if(confirm("Á°ÆÂÆöË¶ÅÊîæÂºÉËøô‰∏™ËÆ°ÂàíÂêóÔºüÊâÄÊúâËøõÂ∫¶Â∞Ü‰∏¢Â§±„ÄÇ")) {
        window.BIG_MEMORY.study = null; // Ê∏ÖÁ©∫ÂÜÖÂ≠ò
        if (typeof idb !== 'undefined') {
            idb.put('universal_store', { id: 'study', data: null }); // Ê∏ÖÁ©∫Â§ßÊï∞ÊçÆÂ∫ì
        }
        renderStudyApp(); 
    }
};

// 2. ‰øÆÂ§çÁªèÊúüËÆ∞ÂΩïÂà†Èô§
window.deletePeriodRecord = function(index) {
    if(!confirm("üìÖ Âà†Èô§ËøôÊù°Âë®ÊúüËÆ∞ÂΩïÔºü")) return;
    const data = window.getPeriodData();
    if(data && data.records) {
        data.records.sort((a, b) => new Date(b.start) - new Date(a.start));
        data.records.splice(index, 1);
        
        // ÂÖ≥ÈîÆÔºö‰øùÂ≠òÂõûÊó†ÈôêÂ≠òÂÇ®
        window.savePeriodData(data); 
        renderPeriodUI();
    }
};

// 3. ‰øÆÂ§çÊó•ËÆ∞Âà†Èô§ (Á°Æ‰øùÂêåÊ≠•)
window.deleteDiaryEntry = function(index) {
    if(!confirm("üî• Á°ÆÂÆöË¶ÅÈîÄÊØÅËøôÁØáÊó•ËÆ∞ÂêóÔºü")) return;
    const list = window.getDiaryHistory(); // ‰ªé BigDB Ëé∑Âèñ
    list.splice(index, 1);
    
    // ‰øùÂ≠òÂõû BigDB
    saveToBigDB('diary_history', list); 
    
    // Âà∑Êñ∞ÁïåÈù¢ÈÄªËæë
    if (index === currentDiaryIndex) {
        currentDiaryIndex = -1;
        document.getElementById('diary-text-content').innerHTML = '';
        document.getElementById('d-date-display').innerText = '--/--/--';
    } else if (index < currentDiaryIndex) {
        currentDiaryIndex--;
    }
    renderDiaryHistoryList();
};
// === ËÄÅÁ¶èÁâπ (Lofter) APP ÈÄªËæë ===

// 1. Ëé∑Âèñ/‰øùÂ≠òÊï∞ÊçÆ (Êó†ÈôêÂ≠òÂÇ®)
function getLofterData() { return window.BIG_MEMORY.lofter_data || []; }
function saveLofterData(data) { 
    window.BIG_MEMORY.lofter_data = data;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'lofter_data', data: data });
}

// 2. ÊâìÂºÄ APP
function openLofterApp() {
    document.getElementById('lofter-modal').style.display = 'flex';
    const list = getLofterData();
    if(list.length === 0) {
        document.getElementById('lofter-feed-list').innerHTML = `
            <div style="text-align:center; padding:50px; color:#999;">
                <div style="font-size:3rem; margin-bottom:10px;">ü•¶</div>
                <p>Á≤Æ‰ªìÁ©∫Á©∫Â¶Ç‰πü...<br>ÁÇπÂáªÂè≥‰∏äËßí [‰∫ßÁ≤Æ] Âè¨Âî§Â§™Â§™</p>
            </div>`;
    } else {
        renderLofterFeed();
    }
}
function renderLofterFeed() {
    const list = getLofterData(); // Ëá™Âä®ËØªÂèñÊó†ÈôêÂ≠òÂÇ®
    const container = document.getElementById('lofter-feed-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = `<div style="column-span:all; text-align:center; padding:50px; color:#999;">È¶ñÈ°µÁ©∫Á©∫Â¶Ç‰πü<br>Âø´ÁÇπÂáªÂè≥‰∏äËßí‰∫ßÁ≤ÆÂêß</div>`;
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'lofter-card-new';
             // === ‰øÆÊîπÂºÄÂßãÔºöÊîØÊåÅ Lofter Â∞ÅÈù¢ÁæéÂåñ ===
        let coverBg = '';
        // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ∞ÅÈù¢ÔºåÂ∞±Áî®Â∞ÅÈù¢ÔºõÂê¶ÂàôÁî®ÈöèÊú∫ÊµÖËâ≤
        if (window.LOFTER_COVER_URL) {
            coverBg = `background-image: url(${window.LOFTER_COVER_URL}); background-size: cover; background-position: center;`;
        } else {
            const randomColor = Math.floor(Math.random()*16777215).toString(16);
            coverBg = `background-color: #${randomColor}20;`;
        }
        
        const randomHeight = Math.floor(Math.random() * 60) + 100; 
        const coverStyle = `height:${randomHeight}px; ${coverBg}`;
        // === ‰øÆÊîπÁªìÊùü ===

        div.innerHTML = `
            <div class="lof-cover-placeholder" style="${coverStyle}"></div>
            <div class="lof-del" onclick="event.stopPropagation(); deleteLofterItem(${index})">√ó</div>
            
            <div class="lof-body" onclick="readLofterFic(${index})">
                <div class="lof-title">${item.title || 'Êó†Ê†áÈ¢ò'}</div>
                <div class="lof-preview">${item.preview || '...'}</div>
            </div>
            
            <div class="lof-footer">
                <div class="lof-user-row">
                    <div class="lof-avatar">${(item.author||"User")[0]}</div>
                    <div class="lof-author">${item.author || 'Â§™Â§™'}</div>
                </div>
                <div class="lof-hot">‚ù§Ô∏è ${item.hot || Math.floor(Math.random()*500)}</div>
            </div>
        `;
        container.appendChild(div);
    });
}
// === 2. Âà†Èô§ÂçïÊù°ÂéÜÂè≤ ===
function deleteLofterItem(index) {
    // ÁÆÄÂçïÁöÑÁ°ÆËÆ§Èò≤Ê≠¢ËØØËß¶
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÁØáÁ≤ÆÂêóÔºü")) return;
    
    const list = getLofterData();
    list.splice(index, 1); // ‰ªéÊï∞ÁªÑÁßªÈô§
    saveLofterData(list);  // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
    renderLofterFeed();    // Âà∑Êñ∞ÁïåÈù¢
}

// === 3. Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ ===
function clearLofterHistory() {
    if(!confirm("‚ö†Ô∏è Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ÁîüÊàêÁöÑÊñáÁ´†Ôºü‰∏çÂèØÊÅ¢Â§ç„ÄÇ")) return;
    saveLofterData([]);
    renderLofterFeed();
}

async function generateLofterFeed() {
    const inputEl = document.getElementById('lofter-user-req');
    const userReq = inputEl.value.trim();
    const btn = document.querySelector('.lofter-toolbar button');
    const oldText = btn.innerText;
    
    btn.disabled = true; btn.innerText = "‰∫ßÁ≤Æ‰∏≠...";

    // 1. Ëé∑Âèñ‰∏ñÁïåËßÇÈÖçÁΩÆ
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
        // 2. Ëé∑Âèñ API Key (‰øÆÂ§çÁâàÔºö‰ºòÂÖàËØªÂèñÊú¨Âú∞ÁºìÂ≠òÔºåÊó†ÈúÄÈáçÊñ∞ÊãâÂèñ)
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    // Âè™Ë¶Å key Êàñ model ‰∏∫Á©∫ÔºåÂ∞±Âº∫Âà∂‰ªéÁºìÂ≠òËØªÂèñ
    if(!apiKey || !model) { 
        try { 
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); 
            if(!apiKey) apiKey = s.key; 
            if(!apiUrl) apiUrl = s.url; // Ë°•ÂÖ® URL ËØªÂèñ
            if(!model) model = s.model; // Ë°•ÂÖ® Ê®°Âûã ËØªÂèñ
        } catch(e){} 
    }

    // ÂÖúÂ∫ïÈªòËÆ§ÂÄº
    if(!apiUrl) apiUrl = "https://api.openai.com/v1";
    if(!model) model = "gpt-3.5-turbo";

    if(!apiKey) { btn.disabled = false; btn.innerText = oldText; return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key"); }
    // 3. ÊûÑÂª∫ Prompt (Âº∫Âà∂Á¨¨‰∏â‰∫∫Áß∞ + ÂáèÂ∞ëÊï∞ÈáèÈò≤Ê≠¢Êà™Êñ≠)
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçËµÑÊ∑±Âêå‰∫∫‰ΩúËÄÖ„ÄÇËØ∑Âü∫‰∫é‰ª•‰∏ãËÆæÂÆöÂàõ‰ΩúÔºö
„Äê‰∏ñÁïåËßÇ„Äë: ${globalCtx}
„ÄêÁî®Êà∑Ë¶ÅÊ±Ç„Äë: ${userReq || "ÈöèÊú∫ÁîüÊàêÁîú/Ëôê/ËΩ¶Ê¢ó"}

„ÄêÈáçË¶ÅËßÑÂàô„Äë
1. **ËßÜËßí**ÔºöÂøÖÈ°ª‰∏•Ê†º‰ΩøÁî®**Á¨¨‰∏â‰∫∫Áß∞**Ôºà‰ªñ/Â•π/ÂêçÂ≠óÔºâÔºåÁ¶ÅÊ≠¢‰ΩøÁî®‚ÄúÊàë‚ÄùÊàñ‚Äú‰Ω†‚Äù„ÄÇ
2. **È£éÊ†º**Ôºö‰ªøLofterÂêå‰∫∫ÊñáÈ£éÔºåÊàñÊòØÊé®ÊñáÈ£éÊ†º„ÄÇ
3. **Êï∞Èáè**Ôºö‰∏ÄÊ¨°ÁîüÊàê 2 ‰∏™È´òË¥®ÈáèÁöÑÂ§ßÁ∫≤„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Êï∞ÁªÑÔºå‰∏çË¶ÅMarkdownÊ†áËÆ∞Ôºö
[
  {
    "title": "ÊñáÁ´†Ê†áÈ¢ò",
    "author": "‰ΩúËÄÖÊòµÁß∞",
    "preview": "50Â≠óÂ∑¶Âè≥ÁöÑÊëòË¶ÅÔºåÂøÖÈ°ªÊòØÁ¨¨‰∏â‰∫∫Áß∞ËßÜËßíÔºå‰æãÂ¶ÇÔºö‚Äò‰ªñÁúãÁùÄÂ•πÁöÑËÉåÂΩ±...‚Äô",
    "tags": ["Tag1", "Tag2"],
    "hot": "1.5w"
  }
]`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: [{role:"user", content:prompt}], temperature: 0.7 })
        });
        const json = await res.json();
        
        // 4. Âº∫ÂäõÂÆπÈîôËß£Êûê (Ëß£ÂÜ≥ JSON Parse Error)
        let raw = json.choices[0].message.content.trim();
        // ÂéªÈô§ markdown
        raw = raw.replace(/```json/gi, "").replace(/```/g, "").trim();
        // Â∞ùËØïÊâæÂà∞Êï∞ÁªÑÁöÑÂ§¥Â∞æ
        const start = raw.indexOf('[');
        const end = raw.lastIndexOf(']');
        
        let newList = [];
        if (start !== -1 && end !== -1) {
            try {
                newList = JSON.parse(raw.substring(start, end + 1));
            } catch (e) { console.error("JSON Parse 1 failed", e); }
        }
        
        // ÂÖúÂ∫ïÔºöÂ¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåÊâãÂä®ÊûÑÈÄ†‰∏Ä‰∏™Êä•ÈîôÂç°ÁâáÔºå‰∏çËÆ©Á®ãÂ∫èÂ¥©Ê∫É
        if (newList.length === 0) {
            newList = [{
                title: "ÁîüÊàêÊ†ºÂºèÂºÇÂ∏∏",
                author: "System",
                preview: "API ËøîÂõû‰∫ÜÈùûÊ†áÂáÜ JSONÔºåËØ∑ÈáçËØï„ÄÇ\nÂéüÂßãËøîÂõû: " + raw.substring(0, 50),
                hot: "0"
            }];
        }

        // 5. Êó†ÈôêÂ≠òÂÇ®‰øùÂ≠ò (Ê∑ªÂä†Âà∞Â§¥ÈÉ®)
        const currentData = getLofterData();
        const finalData = newList.concat(currentData);
        saveLofterData(finalData); // ‰ΩøÁî®Â∑≤ÊúâÁöÑÊó†ÈôêÂ≠òÂÇ®ÂáΩÊï∞
        
        renderLofterFeed();
        inputEl.value = ''; 

    } catch(e) { 
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message); 
    } finally { 
        btn.disabled = false; btn.innerText = oldText; 
    }
}
async function readLofterFic(index) {
    const list = getLofterData();
    const item = list[index];
    const modal = document.getElementById('lofter-detail-modal');
    const bodyEl = document.getElementById('lofter-article-body');
    
    modal.style.display = 'flex'; // Á°Æ‰øùÁ™óÂè£ÂÖàÊâìÂºÄ
    
    // 1. Â¶ÇÊûúÂ∑≤ÁªèÁîüÊàêËøáÔºåÁõ¥Êé•ÊòæÁ§∫ÔºàÁúÅÈí±Ôºâ
    if(item.full_generated && item.content) {
        renderFicContent(item, bodyEl);
        return;
    }

    // 2. ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
    bodyEl.innerHTML = `<div class="skeleton-text" style="margin-top:50px;">Ê≠£Âú®Ê†πÊçÆÊ¢óÊ¶ÇÊâ©ÂÜôÂÖ®Êñá...<br>Â§™Â§™Ê≠£Âú®ÊøÄÊÉÖÁ†ÅÂ≠ó‰∏≠...</div>`;
    
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // Ëé∑Âèñ API ËÆæÁΩÆ
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    // Â∞ùËØï‰ªéÁºìÂ≠òËØªÂèñ API
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey = s.key; apiUrl = s.url; model = s.model; } catch(e){}
    }
    if(!apiKey) {
        bodyEl.innerHTML = `<div style="text-align:center; padding:20px;">‚ùå ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„ÄëÈáåÈÖçÁΩÆ API Key</div>`;
        return;
    }

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊñáÁ¨îÊûÅÂ•ΩÁöÑÂêå‰∫∫‰ΩúËÄÖÔºàËÄÅÁ¶èÁâπÈ£éÊ†ºÔºâ„ÄÇ
„ÄêCPÂéüÂûã/‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÊñáÁ´†Ê†áÈ¢ò„ÄëÔºö${item.title}
„ÄêÊ†áÁ≠æ„ÄëÔºö${item.tags ? item.tags.join('/') : 'Êó†'}
„ÄêÊ¢óÊ¶ÇÈ¢ÑËßà„ÄëÔºö${item.preview}

„Äê‰ªªÂä°„ÄëÔºö
1. **Êí∞ÂÜôÊ≠£Êñá**ÔºöËØ∑ÊääËøô‰∏™Ê¢óÊ¶ÇÊâ©ÂÜôÊàê‰∏ÄÁØáÂÆåÊï¥ÁöÑÂêå‰∫∫Êñá„ÄÇ
   - **Â≠óÊï∞Ë¶ÅÊ±ÇÔºö‰∏çÂ∞ë‰∫é 600 Â≠ó**ÔºàÁªÜËäÇË¶ÅË∂≥Ôºâ„ÄÇ
     -  **ËßÜËßí**ÔºöÂøÖÈ°ª‰∏•Ê†º‰ΩøÁî®**Á¨¨‰∏â‰∫∫Áß∞**Ôºà‰ªñ/Â•π/ÂêçÂ≠óÔºâÔºåÁ¶ÅÊ≠¢‰ΩøÁî®‚ÄúÊàë‚ÄùÊàñ‚Äú‰Ω†‚Äù„ÄÇ
   - ÊñáÁ¨îÈ£éÊ†ºÔºöÁªÜËÖª„ÄÅÊúâÂº†Âäõ„ÄÇ
   - ÂøÖÈ°ªÂü∫‰∫éÁªôÂÆöÁöÑÈ¢ÑËßàËøõË°åÊâ©ÂÜôÔºå‰∏çË¶ÅÂÅèÈ¢ò„ÄÇ
2. **ÁîüÊàêËØÑËÆ∫**ÔºöÁîüÊàê 3-5 Êù°ËØªËÄÖÁöÑÁÉ≠ËØÑ„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„ÄëÔºö
‰∏•Ê†º JSON Ê†ºÂºèÔºå‰∏çË¶ÅÂåÖÂê´ Markdown ‰ª£Á†ÅÂùóÔºö
{
  "content": "ÈïøÁØáÊ≠£ÊñáÂÜÖÂÆπÔºàÊîØÊåÅÊç¢Ë°åÔºâ...",
  "comments": [ {"user": "Ë∑Ø‰∫∫A", "text": "ËØÑËÆ∫1"}, ... ]
}
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model, 
                messages: [{role:"system", content:"You are a creative writer. Output JSON only."}, {role:"user", content:prompt}], 
                temperature: 0.8
            })
        });
        const json = await res.json();
        
        // --- ‰øÆÂ§çÁÇπÔºöÂ¢ûÂº∫ÁöÑ JSON Ëß£Êûê ---
        let raw = json.choices[0].message.content;
        raw = raw.replace(/```json/gi, "").replace(/```/g, "").trim();
        
        // ÂØªÊâæ JSON ÁöÑÂ§¥Â∞æÔºåÈò≤Ê≠¢ AI Âú®ÂâçÂêéËØ¥Â∫üËØùÂØºËá¥Ëß£ÊûêÂ§±Ë¥•
        const start = raw.indexOf('{');
        const end = raw.lastIndexOf('}');
        if (start !== -1 && end !== -1) {
            raw = raw.substring(start, end + 1);
        }

        const result = JSON.parse(raw);
        
        // Êõ¥Êñ∞Êï∞ÊçÆÂπ∂‰øùÂ≠ò
        item.content = result.content;
        item.comments = result.comments;
        item.full_generated = true;
        
        saveLofterData(list); // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
        renderFicContent(item, bodyEl);

    } catch(e) {
        console.error(e);
        bodyEl.innerHTML = `<div style="text-align:center; color:red; padding:20px;">
            Â§™Â§™ÂºÉÂùë‰∫Ü (ÁîüÊàêÂ§±Ë¥•)<br>ÂéüÂõ†: ${e.message}<br>ËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API Key
        </div>`;
    }
}

function renderFicContent(item, container) {
    const cmtHtml = (item.comments || []).map(c => `
        <div class="lofter-cmt-row">
            <div class="lofter-cmt-avatar"></div>
            <div>
                <div style="color:#666; font-size:0.8rem;">${c.user}</div>
                <div>${c.text}</div>
            </div>
        </div>
    `).join('');

    container.innerHTML = `
        <h2 style="margin-bottom:10px; color:#2c6e49;">${item.title}</h2>
        <div style="font-size:0.8rem; color:#999; margin-bottom:20px;">
            BY ${item.author} &nbsp;&nbsp; ${item.tag1} / ${item.tag2}
        </div>
        <div style="white-space: pre-wrap; font-size:1.05rem; text-align:justify;">${item.content}</div>
        <div style="margin-top:40px; text-align:center; color:#ccc;">---------- END ----------</div>
        <div class="lofter-comment-section">
            <h4 style="margin:0 0 15px 0;">ÁÉ≠Èó®ËØÑËÆ∫</h4>
            ${cmtHtml}
        </div>
        <div style="margin-top:20px; padding:10px; background:#f0f0f0; text-align:center; color:#888; border-radius:20px;">
            ËØ¥ÁÇπ‰ªÄ‰πàÂêß...
        </div>
    `;
}

function closeLofterDetail() {
    document.getElementById('lofter-detail-modal').style.display = 'none';
}
// ËøÅÁßªÈÄªËæëÔºöÁ°Æ‰øù lofter_data Ë¢´ÂàùÂßãÂåñ
if(!window.BIG_MEMORY.lofter_data) window.BIG_MEMORY.lofter_data = [];
// === ÂÖ≥‰∫éÁóõËã¶ APP Ê†∏ÂøÉÈÄªËæë ===

let painDeck = [], painFlipped = [], currentPainMode = 'his';

// 1. Êï∞ÊçÆÁÆ°ÁêÜ (Êó†ÈôêÂ≠òÂÇ®)
function getPainData() { return window.BIG_MEMORY.pain_data || { his: [], my: [] }; }
function savePainData(data) { 
    window.BIG_MEMORY.pain_data = data;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'pain_data', data: data });
}

// 2. ÂàùÂßãÂåñ‰∏éÊâìÂºÄ
function openPainApp() {
    document.getElementById('pain-app-modal').style.display = 'flex';
    renderPainHistory();
    // ÊÅ¢Â§çÊàëÁöÑÁóõËã¶ËçâÁ®ø
    const draft = localStorage.getItem('pain_my_draft');
    if(draft) {
        const d = JSON.parse(draft);
        document.getElementById('my-pain-source').value = d.source||"";
        document.getElementById('my-pain-feeling').value = d.feeling||"";
        document.getElementById('my-pain-thought').value = d.thought||"";
        document.getElementById('my-pain-plan').value = d.plan||"";
        document.getElementById('my-pain-help').value = d.help||"";
    }
}

function switchPainTab(tab) {
    document.getElementById('pain-tab-his').style.display = tab==='his'?'block':'none';
    document.getElementById('pain-tab-my').style.display = tab==='my'?'block':'none';
    document.getElementById('btn-tab-his').style.background = tab==='his'?'#2f3640':'#dfe4ea';
    document.getElementById('btn-tab-his').style.color = tab==='his'?'#fff':'#333';
    document.getElementById('btn-tab-my').style.background = tab==='my'?'#2f3640':'#dfe4ea';
    document.getElementById('btn-tab-my').style.color = tab==='my'?'#fff':'#333';
}

function saveMyPainDraft() {
    const data = {
        source: document.getElementById('my-pain-source').value,
        feeling: document.getElementById('my-pain-feeling').value,
        thought: document.getElementById('my-pain-thought').value,
        plan: document.getElementById('my-pain-plan').value,
        help: document.getElementById('my-pain-help').value
    };
    localStorage.setItem('pain_my_draft', JSON.stringify(data));
    alert("ËçâÁ®øÂ∑≤‰øùÂ≠ò");
}

// 3. Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï (ÂÖ≥‰∫é‰ªñÁöÑÁóõËã¶)
function renderPainHistory() {
    const data = getPainData();
    const container = document.getElementById('pain-his-history');
    container.innerHTML = '';
    
    (data.his || []).forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '15px'; div.style.marginBottom = '10px';
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888; border-bottom:1px dashed #ccc; padding-bottom:5px; margin-bottom:10px; display:flex; justify-content:space-between;">
                <span>${new Date(item.date).toLocaleString()}</span>
                <span style="color:red; cursor:pointer;" onclick="deletePainHistory('his', ${index})">Âà†Èô§</span>
            </div>
            <div style="font-size:0.85rem; color:#6a1b9a; margin-bottom:10px;">üé¥ ÁâåÊÑè: ${item.cards}</div>
            <div style="white-space:pre-wrap; line-height:1.6; font-size:0.95rem;">${item.content}</div>
        `;
        container.appendChild(div);
    });
}

function deletePainHistory(type, index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
    const data = getPainData();
    data[type].splice(index, 1);
    savePainData(data);
    if(type === 'his') renderPainHistory();
    else document.getElementById('pain-my-reply-area').innerHTML = ''; // MyÁ±ªÂûãÁöÑÁÆÄÂçïÂ§ÑÁêÜ
}
// === 4. ÂÖ®ÂäüËÉΩÊäΩÁâåÈÄªËæë (‰øÆÊ≠£ÁâàÔºö114Âº†ÂÖ®ÁâåÂ∫ì) ===

// ÂêØÂä®ÊäΩÁâåÔºöÁîüÊàê114Âº†ÁâåÂπ∂Èì∫Êª°Ê°åÈù¢
function startPainDraw(mode) {
    currentPainMode = mode;
    // Â¶ÇÊûúÊòØ‚ÄúÂÖ≥‰∫é‰Ω†ÁöÑÁóõËã¶‚ÄùÔºåÊ£ÄÊü•ÊòØÂê¶Â°´‰∫ÜÂÜÖÂÆπ
    if(mode === 'my') {
        if(!document.getElementById('my-pain-source').value) return alert("ËØ∑ÂÖàÂ°´ÂÜôÁóõËã¶ÁöÑÊ†πÊ∫ê...");
    }
    
    // ÊâìÂºÄÂÖ®ÂäüËÉΩÁâåÊ°åÂºπÁ™ó
    const modal = document.getElementById('pain-card-table-modal');
    const area = document.getElementById('pain-card-area');
    const desk = document.getElementById('pain-card-table-desk');
    
    // Â∫îÁî®ÁæéÂåñËÉåÊôØ (Â¶ÇÊûúÊúâËÆæÁΩÆÂ°îÁΩóÊ°åÂ∏ÉÔºåËøôÈáå‰πü‰ºöÁîüÊïà)
    idb.get('settings_heavy', 'tarot_table').then(res => {
        if(res && res.data) {
            desk.style.backgroundImage = `url(${res.data})`;
            desk.style.backgroundSize = 'cover';
        }
    });

    area.innerHTML = '';
    painDeck = []; 
    painFlipped = [];
    document.getElementById('pain-flipped-count').innerText = '0';

    // 1. ÁîüÊàêÂÆåÊï¥ÁâåÂ∫ì (0-77 Â°îÁΩó, 1-36 Èõ∑ËØ∫Êõº)
    for(let i=0; i<=77; i++) painDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) painDeck.push({ type:'lenormand', id:i, isReversed: false });
    
    // 2. Ê¥óÁâå
    painDeck.sort(()=>Math.random()-0.5);

    // 3. ËÆ°ÁÆóÁΩëÊ†ºÂ∏ÉÂ±Ä (ÂíåÊ∏∏ÊàèÊú∫/‰ø°‰ª∂‰∏ÄËá¥ÁöÑÁÆóÊ≥ï)
    const deskW = window.innerWidth;
    const cardWidth = 60, cardHeight = 90, gapX = 10, gapY = 15;
    // ËÆ°ÁÆó‰∏ÄË°åËÉΩÊîæÂá†Âº†
    let cols = Math.floor((deskW - 20) / (cardWidth + gapX));
    if(cols < 4) cols = 4; // ÊúÄÂ∞èÂàóÊï∞
    
    // ËÆ°ÁÆóÂ±Ö‰∏≠ÂÅèÁßª
    const startX = Math.max(0, (deskW - (cols * cardWidth + (cols - 1) * gapX)) / 2);
    const startY = 60; // È°∂ÈÉ®ÁïôÁ©∫

    // 4. Ê∏≤ÊüìÊØè‰∏ÄÂº†Áâå
    painDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card'; // Â§çÁî®ÂÖ®Â±ÄÂç°ÁâåÊ†∑Âºè
        
        const col = index % cols;
        const row = Math.floor(index / cols);
        
        el.style.left = (startX + col * (cardWidth + gapX)) + 'px';
        el.style.top = (startY + row * (cardHeight + gapY)) + 'px';
        // ÈöèÊú∫ÂæÆÊóãËΩ¨ÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü
        el.style.transform = `rotate(${Math.random()*6-3}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
        el.onclick = () => flipPainCard(el, card);
        
        area.appendChild(el);
    });
    
    // ËÆæÁΩÆÂå∫ÂüüÈ´òÂ∫¶Ôºå‰øùËØÅËÉΩÊªöÂä®Âà∞Â∫ïÈÉ®
    const totalRows = Math.ceil(painDeck.length / cols);
    area.style.height = (startY + totalRows * (cardHeight + gapY) + 150) + 'px';

    modal.style.display = 'flex';
}

// ÁøªÁâåÂä®‰Ωú (ÊîØÊåÅÂä†ËΩΩÂõæÁâá)
async function flipPainCard(el, cardData) {
    if(el.classList.contains('flipped')) {
        // ÂèñÊ∂àÈÄâÊã©
        el.classList.remove('flipped');
        painFlipped = painFlipped.filter(c => !(c.type === cardData.type && c.id === cardData.id));
        
        // Âª∂ËøüÊ∏ÖÁ©∫ÂÜÖÂÆπ (ËßÜËßâ‰ºòÂåñ)
        setTimeout(() => {
            const front = el.querySelector('.playing-card-front');
            front.style.backgroundImage = '';
            front.innerText = '';
            front.style.transform = '';
        }, 300);
    } else {
        // ÈÄâ‰∏≠ÁøªÁâå
        el.classList.add('flipped');
        painFlipped.push(cardData);
        
        const front = el.querySelector('.playing-card-front');
        const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        
        try {
            // ‰ªé IndexedDB Ëé∑ÂèñÁúüÂÆûÂõæÁâá
            const item = await idb.get(dbName, cardData.id);
            if(item && item.data) {
                front.style.backgroundImage = `url(${item.data})`;
                front.style.backgroundColor = 'transparent';
                front.innerText = '';
            } else {
                // Â¶ÇÊûúÊ≤°ÂõæÔºåÊòæÁ§∫ÊñáÂ≠óÂÖúÂ∫ï
                front.style.backgroundColor = '#ecf0f1';
                front.style.color = '#333';
                front.style.display = 'flex';
                front.style.alignItems = 'center';
                front.style.justifyContent = 'center';
                front.style.fontSize = '0.7rem';
                front.innerText = `${cardData.type === 'tarot' ? 'Tarot' : 'Lenormand'}\n#${cardData.id}`;
            }
            
            // Â§ÑÁêÜÈÄÜ‰ΩçÊóãËΩ¨
            if(cardData.type === 'tarot' && cardData.isReversed) {
                front.style.transform = "rotateY(180deg) rotate(180deg)";
            } else {
                front.style.transform = "rotateY(180deg)";
            }
        } catch(e) { console.error(e); }
    }
    document.getElementById('pain-flipped-count').innerText = painFlipped.length;
}
// === 5. Ê†∏ÂøÉ API ÁîüÊàêÈÄªËæë (‰øÆÊ≠£ÁâàÔºöÂä†ÂÖ•‚ÄúÊÑèÊÑøÂà§ÂÆö‚ÄùÈÄªËæë) ===
async function finishPainAnalysis() {
    if(painFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºåËÆ©ÂëΩËøêÊåáÂºïÊñπÂêë„ÄÇ");
    
    // ÂÖ≥Èó≠ÁâåÊ°å
    document.getElementById('pain-card-table-modal').style.display = 'none';
    
    // ÂáÜÂ§áÁâåÈù¢Êï∞ÊçÆ
    const cardsDesc = painFlipped.map(c => {
        const name = (c.type === 'tarot') ? (TAROT_NAMES[c.id] || `Tarot ${c.id}`) : (LENORMAND_NAMES[c.id] || `Lenormand ${c.id}`);
        const status = (c.type === 'tarot' && c.isReversed) ? "(ÈÄÜ‰Ωç)" : "(Ê≠£‰Ωç)";
        return `${name}${status}`;
    }).join(", ");

    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // Ëé∑ÂèñAPI Key
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value;
    
    // Â∞ùËØïËØªÂèñÁºìÂ≠ò
    if(!apiKey) {
        try { 
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); 
            apiKey = s.key; apiUrl = s.url; model = s.model; 
        } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");

    if (currentPainMode === 'his') {
        // === ÂàÜÊîØÔºöÂÖ≥‰∫é‰ªñÁöÑÁóõËã¶ (Âä†ÂÖ•ÊÑèÊÑøÂà§ÂÆö) ===
        const btn = document.querySelector('#pain-tab-his button');
        const oldText = btn.innerText;
        btn.innerText = "‚è≥ Ê≠£Âú®ÊÑüÁü•‰ªñÁöÑÂÜÖÂøÉ..."; btn.disabled = true;
        
        // üî• ‰øÆÊîπÁÇπÔºöPrompt Âä†ÂÖ•‰∫Ü‚ÄúÊòØÂê¶ÊÑøÊÑèÈÄèÈú≤‚ÄùÁöÑÂà§Êñ≠ÈÄªËæë
        const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊûÅÂÖ∂ÊïèÈîêÁöÑËßíËâ≤ÂøÉÁêÜ‰æßÂÜôÂ∏à„ÄÇ
„ÄêËßíËâ≤/‰∏ñÁïåËßÇÊ†∏ÂøÉ„Äë: 
${globalCtx}

„ÄêÊäΩÂà∞ÁöÑÂëΩËøêÁâåÁªÑ„Äë: 
${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑Ê†πÊçÆ**ÁâåÊÑè**ÔºàÁªìÂêàÊ≠£ÈÄÜ‰ΩçÔºâÂà§Êñ≠ËßíËâ≤Ê≠§ÂàªÁöÑÁä∂ÊÄÅÔºö
1. **Âà§ÂÆöÊÑèÊÑø**ÔºöËßíËâ≤Áé∞Âú®ÊòØÂê¶ÊÑøÊÑèËÆ©Áî®Êà∑Ôºà‰Ω†ÔºâÁúãÂà∞‰ªñÁöÑÁóõËã¶Ôºü
   - **ÊÑøÊÑè (revealed)**ÔºöÁâåÊÑèÂÅèÂêë‰æùËµñ„ÄÅ‰ø°‰ªª„ÄÅÂ¥©Ê∫ÉËæπÁºò„ÄÅÊàñÊ∏¥ÊúõË¢´ÁêÜËß£ÔºàÂ¶ÇÂú£ÊùØ„ÄÅÊÅã‰∫∫„ÄÅÊòüÊòü„ÄÅÂÆ°Âà§Ôºâ„ÄÇ
   - **‰∏çÊÑøÊÑè (hidden)**ÔºöÁâåÊÑèÂÅèÂêëÈÄûÂº∫„ÄÅÂ∞ÅÈó≠„ÄÅ‰øùÊä§Ê¨≤„ÄÅÊàñÊòØËá™Â∞äÂøÉÊûÅÂº∫‰∏çÊÉ≥ËÆ©‰Ω†ÊãÖÂøÉÔºàÂ¶ÇÁöáÂ∏ù„ÄÅÂäõÈáè„ÄÅÂÆùÂâëÂõΩÁéã„ÄÅÈöêÂ£´„ÄÅÈí±Â∏Å4Ôºâ„ÄÇ

2. **ÁîüÊàêÂÜÖÂÆπ**Ôºö
   - **ÊÉÖÂÜµAÔºöÊÑøÊÑè (revealed)** -> ËØ¶ÁªÜÂâñÊûê‰ªñÁöÑÁóõËã¶ÔºàÊ†∏ÂøÉ„ÄÅÊÑüÂèó„ÄÅÈò∂ÊÆµ„ÄÅË∞ÉËäÇ„ÄÅÊ∏¥ÊúõÔºâ„ÄÇ
   - **ÊÉÖÂÜµBÔºö‰∏çÊÑøÊÑè (hidden)** -> **ÁªùÂØπ‰∏çË¶Å**ËØ¥Âá∫ÁóõËã¶ÁöÑÁªÜËäÇÔºÅËØ∑ÁîüÊàê‰∏ÄÊÆµ**ÂÆâÊÖ∞Áî®Êà∑ÁöÑËØù**„ÄÇËØ≠Ê∞îË¶ÅÊòØ‚ÄúÊàëÊ≤°‰∫ãÔºåÂà´ÊãÖÂøÉ‚ÄùÔºåÁî®Ê∏©ÊüîÊàñÂùöÂº∫Êù•Êé©È•∞ËÉåÂêéÁöÑ‰º§Áóï„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSON Ê†ºÂºèÔºö
{
  "status": "revealed" Êàñ "hidden",
  "comfort_message": "Â¶ÇÊûúÊòØ hiddenÔºåÂú®Ê≠§Â§ÑÂÜô‰ªñÂÆâÊÖ∞Áî®Êà∑„ÄÅÊé©È•∞ÁóõËã¶ÁöÑËØùÔºàÁ¨¨‰∏Ä‰∫∫Áß∞ÔºâÔºõÂ¶ÇÊûúÊòØ revealedÔºåÁïôÁ©∫Â≠óÁ¨¶‰∏≤",
  "analysis": { 
     "pain_point": "ÁóõËã¶Ê†∏ÂøÉ...",
     "feeling": "ÁúüÂÆûÊÑüÂèó...",
     "stage": "ÂΩìÂâçÈò∂ÊÆµ...",
     "coping": "Ë∞ÉËäÇÊâãÊÆµ...",
     "desire": "ÊΩúÊÑèËØÜÊ∏¥Êúõ..."
  } (Â¶ÇÊûúÊòØ hiddenÔºåanalysis ÂØπË±°ÈáåÁöÑÂ≠óÊÆµÂÖ®ÈÉ®Â°´ null Êàñ "Êú™Áü•")
}
`;
        try {
            const res = await fetch(`${apiUrl}/chat/completions`, {
                method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}`},
                body: JSON.stringify({ model: model || "gpt-3.5-turbo", messages: [{role:"system",content:"JSON only"},{role:"user",content:prompt}] })
            });
            const json = await res.json();
            const content = json.choices[0].message.content.replace(/```json|```/g, "").trim();
            const resObj = JSON.parse(content);
            
            let html = "";
            
            // üî• ‰øÆÊîπÁÇπÔºöÊ†πÊçÆÊÑèÊÑøÊ∏≤Êüì‰∏çÂêåÁöÑÁïåÈù¢
            if (resObj.status === 'hidden') {
                // ‰∏çÊÑøÊÑèÈÄèÈú≤ÔºöÊòæÁ§∫ÂÆâÊÖ∞ÁöÑËØù + ÁâåÊÑèÊèêÁ§∫
                html = `
                    <div style="padding:15px; background:#f1f2f6; border-radius:8px; color:#2f3640;">
                        <h4 style="margin:0 0 10px 0; color:#2f3640;">üö´ ‰ªñËΩ¨Ëøá‰∫ÜË∫´...</h4>
                        <div style="font-size:1rem; font-family:'Songti SC', serif; line-height:1.6;">
                            ‚Äú${resObj.comfort_message}‚Äù
                        </div>
                        <div style="margin-top:15px; font-size:0.8rem; color:#7f8fa6; border-top:1px dashed #ccc; padding-top:5px;">
                            (ÁâåÊÑèÊòæÁ§∫‰ªñÊ≠§Âàª‰∏çÊÉ≥ËÆ©‰Ω†ÂàÜÊãÖËøô‰ªΩÊ≤âÈáçÔºåÈÄâÊã©‰∫ÜÁã¨Ëá™Ê∂àÂåñ)
                        </div>
                    </div>
                `;
            } else {
                // ÊÑøÊÑèÈÄèÈú≤ÔºöÊòæÁ§∫ÂéüÊù•ÁöÑËØ¶ÁªÜÂàÜÊûê
                html = `
                    <div style="margin-bottom:8px;"><strong>ü©∏ ÁóõËã¶Ê†∏ÂøÉ:</strong> ${resObj.analysis.pain_point}</div>
                    <div style="margin-bottom:8px;"><strong>üåßÔ∏è ÁúüÂÆûÊÑüÂèó:</strong> ${resObj.analysis.feeling}</div>
                    <div style="margin-bottom:8px;"><strong>üìâ ÂΩìÂâçÈò∂ÊÆµ:</strong> ${resObj.analysis.stage}</div>
                    <div style="margin-bottom:8px;"><strong>üõ°Ô∏è Ë∞ÉËäÇÊâãÊÆµ:</strong> ${resObj.analysis.coping}</div>
                    <div style="color:#d63031; font-weight:bold;">ü§≤ ÂØπ‰Ω†ÁöÑÊ∏¥Êúõ: ${resObj.analysis.desire}</div>
                `;
            }
            
            // Êó†ÈôêÂ≠òÂÇ®‰øùÂ≠ò
            const data = getPainData();
            if(!data.his) data.his = [];
            data.his.unshift({ date: Date.now(), cards: cardsDesc, content: html });
            savePainData(data);
            renderPainHistory();
            
        } catch(e) { 
            console.error(e); 
            alert("ÁîüÊàêÂ§±Ë¥•: " + e.message); 
        } finally { 
            btn.innerText = "üîÆ ÊäΩÂèñÁâåÁªÑÂπ∂Ëß£Êûê"; btn.disabled = false; 
        }

    } else {
        // === ÂàÜÊîØÔºöÂÖ≥‰∫é‰Ω†ÁöÑÁóõËã¶ (‰øùÊåÅÂéüÊ†∑ÔºåÊó†ÈúÄÊîπÂä®) ===
        const btn = document.querySelector('#pain-tab-my .primary');
        const oldText = btn.innerText;
        btn.innerText = "‚è≥ Ê≠£Âú®Á≠âÂæÖ‰ªñÁöÑÂõûÂ∫î..."; btn.disabled = true;
        
        const userInput = {
            pain: document.getElementById('my-pain-source').value,
            feeling: document.getElementById('my-pain-feeling').value,
            thought: document.getElementById('my-pain-thought').value,
            plan: document.getElementById('my-pain-plan').value,
            help: document.getElementById('my-pain-help').value
        };
        
        const prompt = `
Áî®Êà∑ÂêëËßíËâ≤ÂèëÈÄÅ‰∫Ü‰∏Ä‰ªΩ‚ÄúÂÖ≥‰∫éÁóõËã¶ÁöÑËá™ÁôΩË°®‚Äù„ÄÇ
„ÄêËßíËâ≤ËÆæÂÆö„Äë: 
${globalCtx}

„ÄêÁî®Êà∑Â°´ÂÜôÁöÑËá™ÁôΩ„Äë: 
${JSON.stringify(userInput)}

„ÄêÂëΩËøêÁâåÁªÑÔºàÂà§ÂÆö‰æùÊçÆÔºâ„Äë: 
${cardsDesc}

„Äê‰ªªÂä°ÊµÅÁ®ã„Äë
1. **Âà§ÂÆöÊòØÂê¶Â∑≤ËØª**Ôºö
   - ÁâåÊÑèÁßØÊûÅ/Ê≤üÈÄö/ÊïèÈîêÔºàÂ¶ÇÂÆùÂâëÂõΩÁéã„ÄÅÊùÉÊùñ8„ÄÅÂÆ°Âà§Ôºâ -> **Â∑≤ËØª (read)**„ÄÇ
   - ÁâåÊÑèÊ∑∑‰π±/ÈòªÁ¢ç/Â∞ÅÈó≠ÔºàÂ¶ÇÂÆùÂâë8„ÄÅÊúà‰∫Æ„ÄÅÈ´òÂ°îÈÄÜ‰Ωç„ÄÅÂú£ÊùØ4Ôºâ -> **Êú™ËØª (unread)**„ÄÇ

2. **ÁîüÊàêÂõûÂ∫î**Ôºö
   - **Â¶ÇÊûúÊú™ËØª**ÔºöÁîüÊàê‰∏ÄÊÆµÁÆÄÁü≠ÁöÑÁêÜÁî±„ÄÇ
   - **Â¶ÇÊûúÂ∑≤ËØª**ÔºöËØ∑**ÈÄêÊù°**ÂõûÂ§çÁî®Êà∑ÁöÑ‰ø°ÊÅØ„ÄÇËØ≠Ê∞îÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤‰∫∫ËÆæ„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSONÔºö
{
  "status": "read" Êàñ "unread",
  "unread_reason": "Â¶ÇÊûúÊòØÊú™ËØªÔºåÂÜôÂéüÂõ†ÔºõÂê¶ÂàôÁïôÁ©∫",
  "replies": {
     "pain_reply": "...",
     "feeling_reply": "...",
     "thought_reply": "...",
     "plan_reply": "...",
     "help_reply": "..."
  }
}
`;
        try {
            const res = await fetch(`${apiUrl}/chat/completions`, {
                method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}`},
                body: JSON.stringify({ model: model || "gpt-3.5-turbo", messages: [{role:"system",content:"JSON only"},{role:"user",content:prompt}] })
            });
            const json = await res.json();
            const content = json.choices[0].message.content.replace(/```json|```/g, "").trim();
            const resObj = JSON.parse(content);
            
            const area = document.getElementById('pain-my-reply-area');
            if(resObj.status === 'unread') {
                area.innerHTML = `
                    <div class="morandi-card" style="background:#f1f2f6; text-align:center; padding:20px; color:#666;">
                        <h4 style="color:#636e72;">üö´ ÂØπÊñπ‰ºº‰πéÊ≤°ÊúâÂõûÂ∫î</h4>
                        <p style="font-size:0.8rem; color:#a4b0be; margin-bottom:10px;">üîÆ ÈòªÁ¢çÁâå: ${cardsDesc}</p>
                        <p style="font-weight:bold;">${resObj.unread_reason}</p>
                    </div>`;
            } else {
                area.innerHTML = `
                    <div class="morandi-card" style="border-left:4px solid #2f3640; padding:20px;">
                        <h4 style="margin-bottom:15px; color:#2f3640;">üì© ‰ªñÁöÑÂõûÂ§ç (ÁâåÊÑè: Â∑≤ËØª)</h4>
                        <div style="font-size:0.95rem; line-height:1.8; color:#2d3436;">
                            <p><span style="background:#dfe6e9; padding:2px 6px; border-radius:4px; font-size:0.8rem;">ÂÖ≥‰∫éÁóõÁÇπ</span><br>${resObj.replies.pain_reply}</p>
                            <hr style="border:0; border-top:1px dashed #dcdde1; margin:10px 0;">
                            <p><span style="background:#dfe6e9; padding:2px 6px; border-radius:4px; font-size:0.8rem;">ÂÖ≥‰∫éÊÑüÂèó</span><br>${resObj.replies.feeling_reply}</p>
                            <hr style="border:0; border-top:1px dashed #dcdde1; margin:10px 0;">
                            <p><span style="background:#dfe6e9; padding:2px 6px; border-radius:4px; font-size:0.8rem;">ÂÖ≥‰∫éÊÉ≥Ê≥ï</span><br>${resObj.replies.thought_reply}</p>
                            <hr style="border:0; border-top:1px dashed #dcdde1; margin:10px 0;">
                            <p><span style="background:#dfe6e9; padding:2px 6px; border-radius:4px; font-size:0.8rem;">ÂÖ≥‰∫éÊñπÊ°à</span><br>${resObj.replies.plan_reply}</p>
                            <hr style="border:0; border-top:1px dashed #dcdde1; margin:10px 0;">
                            <p><span style="background:#dfe6e9; padding:2px 6px; border-radius:4px; font-size:0.8rem;">ÂÖ≥‰∫éÊ±ÇÂä©</span><br>${resObj.replies.help_reply}</p>
                        </div>
                        <button class="m-btn small" style="margin-top:15px; width:100%; background:#dfe4ea; color:#2f3640;" onclick="startPainDraw('my')">üîÑ ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç</button>
                    </div>`;
            }
        } catch(e) { 
            console.error(e); 
            alert("ÁîüÊàêÂ§±Ë¥•: " + e.message); 
        } finally { 
            btn.innerText = oldText; btn.disabled = false; 
        }
    }
}
// === üç¨ Âπ≥Ë°å‰∏ñÁïåÊâ≠ËõãÊú∫ Ê†∏ÂøÉÈÄªËæë ===

let gashaponDeck = [];
let gashaponFlipped = [];
let currentScenario = "";
let pendingStoryResult = null; // ÊöÇÂ≠òÂàöÁîüÊàêËøòÊ≤°ÊâìÂºÄÁöÑÊïÖ‰∫ã

// 1. ÂàùÂßãÂåñ & Êï∞ÊçÆÁÆ°ÁêÜ (Êó†ÈôêÂ≠òÂÇ®)
// Á°Æ‰øù BIG_MEMORY ÂàùÂßãÂåñ
if (!window.BIG_MEMORY.gashapon_history) window.BIG_MEMORY.gashapon_history = [];

function getGashaponHistory() { return window.BIG_MEMORY.gashapon_history || []; }
function saveGashaponHistory(data) {
    const list = getGashaponHistory();
    list.unshift(data);
    saveToBigDB('gashapon_history', list);
}

// 2. ÊâìÂºÄ APP
function openGashaponApp() {
    document.getElementById('gashapon-app-modal').style.display = 'flex';
    renderGashaponHistory();
}

function toggleGashaponHistory() {
    const list = document.getElementById('gashapon-history-list');
    list.classList.toggle('show');
}

// 3. ÂéÜÂè≤ËÆ∞ÂΩïÊ∏≤Êüì & Âà†Èô§
function renderGashaponHistory() {
    const list = getGashaponHistory();
    const container = document.getElementById('gashapon-history-list');
    container.innerHTML = '';
    
    if(list.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ÊöÇÊó†Êî∂ËóèÁöÑÊïÖ‰∫ã</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '15px';
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888; display:flex; justify-content:space-between;">
                <span>${new Date(item.date).toLocaleDateString()}</span>
                <span onclick="deleteGashaponItem(${index})" style="color:red; cursor:pointer;">Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; color:#c2185b; margin:5px 0;">üåç ËÆæÂÆö: ${item.scenario || 'ÈöèÊú∫‰∏ñÁïå'}</div>
            <div style="font-size:0.85rem; color:#555; max-height:60px; overflow:hidden;">${item.story.substring(0, 50)}...</div>
            <button class="m-btn small" onclick="reviewGashaponStory(${index})" style="width:100%; margin-top:5px; background:#f8bbd0; color:#880e4f;">ÂÜçÊ¨°ÈòÖËØª</button>
        `;
        container.appendChild(div);
    });
}

function deleteGashaponItem(index) {
    if(!confirm("Á°ÆÂÆöË¶Å‰∏¢ÂºÉËøô‰∏™Âπ≥Ë°å‰∏ñÁïåÁöÑËÆ∞ÂøÜÂêóÔºü")) return;
    const list = getGashaponHistory();
    list.splice(index, 1);
    saveToBigDB('gashapon_history', list);
    renderGashaponHistory();
}

function reviewGashaponStory(index) {
    const list = getGashaponHistory();
    const item = list[index];
    showStoryPaper(item.story, item.date);
}

// 4. ÊµÅÁ®ãÂºÄÂßãÔºöÁÇπÂáªÊú∫Âô® -> ÂºπÂá∫ËæìÂÖ•Ê°Ü
function triggerGashaponStart() {
    const machine = document.querySelector('.gashapon-machine');
    machine.classList.add('shaking');
    
    setTimeout(() => {
        machine.classList.remove('shaking');
        // ÊòæÁ§∫ËæìÂÖ•ÂºπÁ™ó
        document.getElementById('gashapon-input-modal').style.display = 'flex';
        document.getElementById('gashapon-scenario').value = ''; // Ê∏ÖÁ©∫
    }, 600);
}

// 5. ËøõÂÖ•ÁâåÊ°å (Â§çÂà∂Ê∏∏ÊàèÊú∫ÈÄªËæë)
function enterGashaponTable() {
    currentScenario = document.getElementById('gashapon-scenario').value.trim();
    document.getElementById('gashapon-input-modal').style.display = 'none';
    
    // ÂàùÂßãÂåñÁâåÊ°å
    const modal = document.getElementById('gashapon-card-table-modal');
    const area = document.getElementById('gashapon-card-area');
    area.innerHTML = '';
    gashaponDeck = [];
    gashaponFlipped = [];
    document.getElementById('gashapon-flipped-count').innerText = '0';

    // ÁîüÊàê114Âº†Áâå
    for(let i=0; i<=77; i++) gashaponDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) gashaponDeck.push({ type:'lenormand', id:i, isReversed:false });
    gashaponDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±ÄËÆ°ÁÆó
    const deskW = window.innerWidth;
    const cardWidth=60, cardHeight=90, gap=10;
    let cols = Math.floor((deskW-20)/(cardWidth+gap)); if(cols<4) cols=4;
    const startX = (deskW - (cols*(cardWidth+gap)))/2;

    gashaponDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i / cols);
        el.style.left = (startX + col*(cardWidth+gap)) + 'px';
        el.style.top = (60 + row*(cardHeight+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*6-3}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                gashaponFlipped = gashaponFlipped.filter(c => !(c.type===card.type && c.id===card.id));
            } else {
                el.classList.add('flipped');
                gashaponFlipped.push(card);
                // Âä†ËΩΩÂõæÁâá
                const dbName = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                const item = await idb.get(dbName, card.id);
                if(item && item.data) front.style.backgroundImage = `url(${item.data})`;
                else { front.style.backgroundColor='#ddd'; front.innerText=card.id; }
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('gashapon-flipped-count').innerText = gashaponFlipped.length;
        };
        area.appendChild(el);
    });
    
    // Â∫îÁî®ÁöÆËÇ§ (Â§çÁî®Â°îÁΩóÊ°åÂ∏É)
    idb.get('settings_heavy', 'tarot_table').then(res => {
        if(res && res.data) document.getElementById('gashapon-card-table-desk').style.backgroundImage = `url(${res.data})`;
    });

    modal.style.display = 'flex';
}

// 6. ÁîüÊàêÊïÖ‰∫ã API (ÊüîËΩØÁªÜËÖªÊñáÈ£é)
async function finishGashaponDrawing() {
    if(gashaponFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºå‰∏∫ÈÇ£‰∏™‰∏ñÁïåÊ≥®ÂÖ•ÂëΩËøêËÉΩÈáè„ÄÇ");
    
    // UI Áä∂ÊÄÅ
    const btn = document.querySelector('#gashapon-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.innerText = "Ê≠£Âú®Á©øË∂äÊó∂Á©∫..."; btn.disabled = true;

    // ÂáÜÂ§á Prompt
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const cardsDesc = gashaponFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    // ÁºìÂ≠òËØªÂèñ
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) { btn.innerText = oldText; btn.disabled = false; return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key"); }

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊìÖÈïøÂÜô‚ÄúÊüîËΩØ„ÄÅÁªÜËÖª„ÄÅÂîØÁæé‚ÄùÈ£éÊ†ºÂ∞èËØ¥ÁöÑ‰ΩúÂÆ∂„ÄÇ
ËØ∑‰∏∫Áî®Êà∑ÁîüÊàê‰∏Ä‰∏™Âπ≥Ë°å‰∏ñÁïåÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ

„ÄêÂü∫Á°ÄËÆæÂÆö„Äë
- ËßíËâ≤/‰∏ñÁïåËßÇÔºö${globalCtx}
- Áî®Êà∑ËÆæÂÆöÁöÑÂπ≥Ë°å‰∏ñÁïåÊ¢óÊ¶ÇÔºö${currentScenario || "ÈöèÊú∫‰∏Ä‰∏™Ê∏©È¶®ÊàñÂÆøÂëΩÊÑüÁöÑÂπ≥Ë°åÊó∂Á©∫"}
- ÂëΩËøêÂç°ÁâåÔºàÂâßÊÉÖÊåáÂºïÔºâÔºö${cardsDesc}

„ÄêÂÜô‰ΩúË¶ÅÊ±Ç„Äë
1. **ÊñáÈ£é**ÔºöÊûÅÂ∫¶ÊüîËΩØ„ÄÅÁªÜËÖª„ÄÅÊÑüÊÄß„ÄÇÂ§öÊèèÂÜôÂÖâÂΩ±„ÄÅÊ∞îÂë≥„ÄÅËß¶ÊÑüÂíåÂæÆÂ∞èÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÇ
2. **ÂÜÖÂÆπ**Ôºö
   - ÂøÖÈ°ªÂåÖÂê´ÂÖ∑‰ΩìÁöÑ**‰∏ñÁïåËÉåÊôØ**ÔºàÁÆÄÂçïÁöÑÊ∞õÂõ¥ÊèèÂÜôÔºâÂøÖÈ°ªÊ†πÊçÆÁâåÊÑèÁîüÊàê„ÄÇ
   - ÊòéÁ°ÆÂèåÊñπÁöÑ**Êñ∞Ë∫´‰ªΩ**ÔºàÂü∫‰∫éÁî®Êà∑ËÆæÂÆöÔºà‰∏çÂü∫‰∫é‰∏ñÁïå‰π¶ÂÜÖÂÆπÂè™Âü∫‰∫éÁî®Êà∑ËæìÂÖ•ÔºâÊàñÁâåÊÑèÔºâ„ÄÇ
   - ÊèèÂÜô‰∏Ä‰ª∂**ÂÖ∑‰ΩìÂèëÁîüÁöÑ‰∫íÂä®‰∫ã‰ª∂**„ÄÇ
3. **Â≠óÊï∞**Ôºö‰∏çÂ∞ë‰∫é 300 Â≠ó„ÄÇ
4. **Á¶ÅÊ≠¢**Ôºö‰∏çË¶ÅÂÉèÂÜôÂ§ßÁ∫≤ÔºåË¶ÅÂÜôÊàêÊ≠£ÊñáÁâáÊÆµ„ÄÇ‰∏çË¶ÅÁõ¥Êé•Âá∫Áé∞‚ÄúÊäΩÂà∞‰∫ÜXXÁâå‚ÄùËøôÁßçÂá∫ÊàèÁöÑËØùÔºåÊääÁâåÊÑèËûçÂÖ•ÂâßÊÉÖ„ÄÇ
5.Âú®ÊúÄ‰∏ãÈù¢ÂÜô‰∏äÁâåÂíåÁâåÊÑè„ÄÇ‰ª•Âèä‰∏ñÁïåËÉåÊôØÁÆÄ‰ªãÔºåÂèåÊñπÊñ∞Ë∫´‰ªΩÁÆÄ‰ªã„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫ÊïÖ‰∫ãÊ≠£ÊñáÔºå‰∏çÈúÄË¶ÅÊ†áÈ¢òÔºå‰∏çÈúÄË¶Å Markdown ‰ª£Á†ÅÂùó„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a gentle creative writer."}, {role:"user", content:prompt}],
                temperature: 0.85
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content.trim();
        
        // ÊöÇÂ≠òÁªìÊûú
        pendingStoryResult = {
            date: Date.now(),
            scenario: currentScenario || "Unknown World",
            cards: cardsDesc,
            story: story
        };
        
        // ‰øùÂ≠òÂà∞ÂéÜÂè≤
        saveGashaponHistory(pendingStoryResult);
        renderGashaponHistory();

        // ÂÖ≥Èó≠ÁâåÊ°åÔºåÊòæÁ§∫Â∑®Â§ßÊâ≠Ëõã
        document.getElementById('gashapon-card-table-modal').style.display = 'none';
        showBigCapsule();

    } catch(e) {
        alert("Êó∂Á©∫ÈößÈÅìËøûÊé•Â§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
}

// 7. ÊòæÁ§∫Â§ßÊâ≠Ëõã -> ÁÇπÂáªÊâìÂºÄ -> ÊòæÁ§∫Á∫∏Êù°
function showBigCapsule() {
    const modal = document.getElementById('gashapon-capsule-modal');
    const capsule = document.getElementById('big-capsule');
    const paper = document.getElementById('gashapon-story-paper');
    
    // ÈáçÁΩÆÁä∂ÊÄÅ
    modal.style.display = 'flex';
    capsule.classList.remove('open');
    capsule.style.display = 'block';
    paper.style.display = 'none';
}

function openBigCapsule() {
    const capsule = document.getElementById('big-capsule');
    capsule.classList.add('open'); // Ëß¶ÂèëÁÇ∏ÂºÄÂä®Áîª
    
    // Âª∂ËøüÊòæÁ§∫Á∫∏Êù°
    setTimeout(() => {
        capsule.style.display = 'none'; // ÂΩªÂ∫ïÈöêËóèËÉ∂Âõä
        showStoryPaper(pendingStoryResult.story, pendingStoryResult.date);
    }, 400);
}

function showStoryPaper(text, date) {
    const modal = document.getElementById('gashapon-capsule-modal');
    modal.style.display = 'flex'; // Á°Æ‰øùÊòæÁ§∫ÔºàÂ¶ÇÊûúÊòØ‰ªéÂéÜÂè≤ËÆ∞ÂΩïËøõÊù•ÁöÑÔºâ
    document.getElementById('big-capsule').style.display = 'none'; // Á°Æ‰øùËÉ∂Âõä‰∏çÊå°Ë∑Ø
    
    const paper = document.getElementById('gashapon-story-paper');
    paper.style.display = 'flex';
    
    document.getElementById('sp-date').innerText = new Date(date).toLocaleDateString().toUpperCase();
    document.getElementById('gashapon-story-content').innerHTML = text.replace(/\n/g, '<br>');
}

function closeGashaponResult() {
    document.getElementById('gashapon-capsule-modal').style.display = 'none';
    // ÂõûÂà∞‰∏ªAPPÁïåÈù¢
    document.getElementById('gashapon-app-modal').style.display = 'flex';
}
// Â∞Ü gashapon_history Ê∑ªÂä†Âà∞Â§ßÂÆπÈáèÂ≠òÂÇ®ËøÅÁßªÂàóË°®
if (typeof loadAllBigData === 'function') {
    const originalLoad = loadAllBigData;
    loadAllBigData = async function() {
        if (!window.BIG_MEMORY.gashapon_history) window.BIG_MEMORY.gashapon_history = [];
        // Â∞ùËØï‰ªéDBÂä†ËΩΩÊâ≠ËõãÂéÜÂè≤
        try {
            let res = await idb.get('universal_store', 'gashapon_history');
            if(res) window.BIG_MEMORY.gashapon_history = res.data;
        } catch(e) {}
        
        await originalLoad();
    }
}
// ==================== üêæ ÂÆ†Áâ©Èô™‰º¥Á≥ªÁªüÊ†∏ÂøÉÈÄªËæë ====================

// --- 1. Êï∞ÊçÆÈÖçÁΩÆ ---
const PET_CONFIG = {
    pets: [
        { id: 'cat_black', name: 'ÈªëÁå´', type: 'cat', img: 'https://i.postimg.cc/hjtSZ5yH/IMG_1786.png' },
        { id: 'cat_white', name: 'ÁôΩÁå´', type: 'cat', img: 'https://i.postimg.cc/Kz8ZpHqw/IMG_1789.png' },
{ id: 'cat_calico', name: '‰∏âËä±', type: 'cat', img: 'https://i.postimg.cc/zvKYVcv6/wei-ming-ming-zuo-pin.png' },
        { id: 'dog', name: 'Áãó', type: 'dog', img: 'https://i.postimg.cc/nzhHSPRy/IMG_1787.png' },
        { id: 'fish', name: 'È±º', type: 'fish', img: 'https://i.postimg.cc/NGbXMhvy/IMG-1773.png' },
        { id: 'bird', name: 'È∏ü', type: 'bird', img: 'https://i.postimg.cc/PfMWwpY1/IMG-1771.png' }
    ],
    bg: [
        { id: 'bg_default', src: 'https://i.postimg.cc/sDDNQRB6/IMG_1808.png', price: 0 },
        { id: 'bg_yellow', src: 'https://i.postimg.cc/m225zGcp/IMG_1809.png', price: 20 },
        { id: 'bg_redblack', src: 'https://i.postimg.cc/gkkTXPwM/IMG_1811.png', price: 20 },
        { id: 'bg_pink', src: 'https://i.postimg.cc/3JJc4Hyq/IMG_1807.png', price: 20 },
        { id: 'bg_blue', src: 'https://i.postimg.cc/HsshcCJ6/IMG_1810.png', price: 20 }
    ],
    decor: [
        { id: 'ac', src: 'https://i.postimg.cc/7YYWGyCF/IMG_1800.png', price: 20, name: 'Á©∫Ë∞É', style: 'top:0%; right:0%; width:100px;' },
        { id: 'clock_deco', src: 'https://i.postimg.cc/kXXp6d6C/IMG_1798.png', price: 0, name: 'Â§çÂè§ÊåÇÈíü', style: 'top:0%; right:15%; transform:translateX(-50%); width:70px;' },
        { id: 'tub_deco', src: 'https://i.postimg.cc/X77zG0GM/IMG_1802.png', price: 20, name: 'Ë±™ÂçéÊµ¥Áº∏', style: 'bottom:0%; right:80%; width:100px;' },
        { id: 'tub', src: 'https://i.postimg.cc/xTT4JSJ1/IMG_1794.png', price: 20, name: 'Êµ¥Áº∏', style: 'bottom:0%; right:80%; width:100px;' },
        { id: 'tv', src: 'https://i.postimg.cc/9FFnRjRM/IMG_1791.png', price: 20, name: 'ÁîµËßÜ', style: 'bottom:0%; right:10%; width:200px;' },
        { id: 'plant1', src: 'https://i.postimg.cc/nccPjtjf/IMG_1801.png', price: 20, name: 'ÁõÜÊ†Ω1', style: 'bottom:0%; right:0%; width:70px;' },
        { id: 'plant2', src: 'https://i.postimg.cc/BQQVLGLs/IMG_1797.png', price: 20, name: 'ÁõÜÊ†Ω2', style: 'top:20%; left:0%; width:100px;' },
        { id: 'lamp_night', src: 'https://i.postimg.cc/vHHNgdgY/IMG_1792.png', price: 20, name: 'ËêΩÂú∞ÁÅØ(Â§ú)', style: 'top:10%; right:18%; width:100px;' },
        { id: 'lamp', src: 'https://i.postimg.cc/Qxxy9r9G/IMG_1803.png', price: 20, name: 'ËêΩÂú∞ÁÅØ', style: 'top:10%; right:18%; width:100px;' },
{ id: 'curtain', src: 'https://i.postimg.cc/Qxxy9r9x/IMG_1795.png', price: 20, name: 'Á™óÂ∏ò', style: 'top:0; left:0%; width:35%; ' },
{ id: 'win_night', src: 'https://i.postimg.cc/8PP0JVJk/IMG_1796.png', price: 20, name: 'Á™óÊà∑(Â§ú)', style: 'top:0%; left:0%; width:150px; ' },
{ id: 'win_day', src: 'https://i.postimg.cc/c44bgNgS/IMG_1799.png', price: 20, name: 'Á™óÊà∑(Êó•)', style: 'top:0%; left:0%; width:150px; ' }, 
        { id: 'desk', src: 'https://i.postimg.cc/bNNBDjDz/IMG_1793.png', price: 20, name: '‰π¶Ê°å', style: 'bottom:30%; left:0%; width:110px;' },
        { id: 'flower', src: 'https://i.postimg.cc/rFFP0L0d/IMG_1790.png', price: 20, name: 'Ëä±', style: 'top:20%; left:0%; width:80px;' }
    ],
    items: [
        { id: 'food_unk', name: '‰∏çÁü•ÂêçÈ£üÁâ©', price: 1, type: 'food', target: 'custom', img: 'https://i.postimg.cc/BZ1WZ3F4/IMG-1759.png' },
        { id: 'food_cat', name: 'Áå´Á≤Æ', price: 1, type: 'food', target: 'cat', img: 'https://i.postimg.cc/1zS2JVCL/IMG-1751.png' },
        { id: 'food_dog', name: 'ÁãóÁ≤Æ', price: 1, type: 'food', target: 'dog', img: 'https://i.postimg.cc/KcWWCHpP/IMG-1753.png' },
        { id: 'food_fish', name: 'È±ºÈ£ü', price: 1, type: 'food', target: 'fish', img: 'https://i.postimg.cc/XYfDG7js/IMG-1755.png' },
        { id: 'food_seed', name: 'ÁìúÂ≠ê', price: 1, type: 'food', target: 'bird', img: 'https://i.postimg.cc/gJTMFxs3/IMG-1757.png' },
        
        { id: 'bath_cat', name: 'Áå´Ê≤êÊµ¥Èú≤', price: 1, type: 'bath', target: 'cat', img: 'https://i.postimg.cc/gJCTLwZv/IMG-1761.png' },
        { id: 'bath_dog', name: 'ÁãóÊ≤êÊµ¥Èú≤', price: 1, type: 'bath', target: 'dog', img: 'https://i.postimg.cc/MKD9q39q/IMG-1763.png' },
        { id: 'bath_fish', name: 'È±ºÊ≤êÊµ¥Èú≤', price: 1, type: 'bath', target: 'fish', img: 'https://i.postimg.cc/C504VbDV/IMG-1765.png' },
        { id: 'bath_bird', name: 'È∏üÊ≤êÊµ¥Èú≤', price: 1, type: 'bath', target: 'bird', img: 'https://i.postimg.cc/13dc3k6V/IMG-1767.png' },
        { id: 'bath_unk', name: '‰∏çÁü•ÂêçÊ≤êÊµ¥Èú≤', price: 1, type: 'bath', target: 'custom', img: 'https://i.postimg.cc/NM61bLVq/IMG-1769.png' }
    ]
};

// --- 2. ÂàùÂßãÂåñ‰∏éÂ≠òÂÇ® ---
if(!window.BIG_MEMORY.pet_data) {
    window.BIG_MEMORY.pet_data = {
        config: { name: "", type: "", img: "" },
        stats: { hunger: 80, clean: 80, mood: 100, last_update: Date.now(), last_pat: 0 },
        inventory: { coins: 0, items: {}, unlocked_bg: ['bg_default'], unlocked_decor: [] },
        state: { bg: 'bg_default', active_decor: [] }, // active_decor: ['ac', 'tv']
        history: [],
        tasks: { last_checkin: 0, chat_count: 0 }
    };
}

function getPetData() { return window.BIG_MEMORY.pet_data; }
function savePetData(data) { 
    window.BIG_MEMORY.pet_data = data;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'pet_data', data: data });
}

// ÂêØÂä®ÈÄªËæë
function initPetSystem() {
    const data = getPetData();
    if (!data.config.type) {
        openAdoptionModal(); // Á¨¨‰∏ÄÊ¨°ËøõÂÖ•
    } else {
        renderPetMain();
        startPetLoop();
    }
}
// ==================== ü§ñ Êô∫ËÉΩÊâòÁÆ°Á≥ªÁªü (Ëá™Âä®Âæ™ÁéØÁâà) ====================

// 1. ÂºÄÂÖ≥ÂàáÊç¢ÂáΩÊï∞
function toggleAutoCare() {
    const data = window.BIG_MEMORY.pet_data;
    if (!data || !data.config.type) return alert("ËØ∑ÂÖàÈ¢ÜÂÖªÂÆ†Áâ©ÔºÅ");

    // ÂàáÊç¢Áä∂ÊÄÅ (Â¶ÇÊûúÊ≤°ÊúâËøô‰∏™Â≠óÊÆµÔºåÈªòËÆ§‰∏∫ falseÔºåÂèñÂèçÂç≥‰∏∫ÂºÄÂêØ)
    data.config.autoCareEnabled = !data.config.autoCareEnabled;
    
    // ‰øùÂ≠òÂπ∂Âà∑Êñ∞ÁïåÈù¢
    window.savePetData(data);
    updateSettingsUI(); // Âà∑Êñ∞ÊåâÈíÆÈ¢úËâ≤
    
    // ÊèêÁ§∫Áî®Êà∑
    if (data.config.autoCareEnabled) {
        alert("ü§ñ ÊâòÁÆ°Â∑≤ÂºÄÂêØÔºÅ\nÂä©ÊâãÂ∞ÜÊØè 10 ÁßíÊ£ÄÊµã‰∏ÄÊ¨°Áä∂ÊÄÅÔºåËá™Âä®ÂñÇÈ£ü/Ê¥óÊæ°„ÄÇ");
        runAutoCareCheck(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°
    } else {
        alert("ü§ñ ÊâòÁÆ°Â∑≤ÂÖ≥Èó≠„ÄÇ");
    }
}

// 2. Ëá™Âä®Ê£ÄÊµãÊâßË°åÂáΩÊï∞ (ÂêéÂè∞ËøêË°å)
function runAutoCareCheck() {
    const data = window.BIG_MEMORY.pet_data;
    
    // Â¶ÇÊûúÊ≤°ÂºÄÂêØÔºåÊàñËÄÖÊ≤°ÂÆ†Áâ©ÔºåÁõ¥Êé•ÈÄÄÂá∫
    if (!data || !data.config || !data.config.autoCareEnabled) return;

    let hasAction = false; // Ê†áËÆ∞ÊòØÂê¶ÊúâÊìç‰Ωú
    let logMsg = []; // ËÆ∞ÂΩïÊìç‰ΩúÊó•Âøó

    // --- Ê£ÄÊµãÈ•±È£üÂ∫¶ < 89 ---
    if (data.stats.hunger < 89) {
        // Êü•ÊâæËÉåÂåÖÈáåÈÄÇÁî®ÁöÑÈ£üÁâ©
        const targetType = data.config.type === 'custom' ? 'custom' : data.config.type;
        const validFoodId = PET_CONFIG.items.find(i => i.type === 'food' && i.target === targetType)?.id;
        
        if (validFoodId && data.inventory.items[validFoodId] > 0) {
            data.inventory.items[validFoodId]--; // Êâ£Èô§Áâ©ÂìÅ
            data.stats.hunger = Math.min(100, data.stats.hunger + 20); // Â¢ûÂä†Êï∞ÂÄº
            data.stats.mood = Math.min(100, data.stats.mood + 2);
            hasAction = true;
            logMsg.push("Ëá™Âä®ÂñÇÈ£ü");
        }
    }

    // --- Ê£ÄÊµãÊ∏ÖÊ¥ÅÂ∫¶ < 89 ---
    if (data.stats.clean < 89) {
        // Êü•ÊâæËÉåÂåÖÈáåÈÄÇÁî®ÁöÑÊ≤êÊµ¥Èú≤
        const targetType = data.config.type === 'custom' ? 'custom' : data.config.type;
        const validBathId = PET_CONFIG.items.find(i => i.type === 'bath' && i.target === targetType)?.id;
        
        if (validBathId && data.inventory.items[validBathId] > 0) {
            data.inventory.items[validBathId]--; // Êâ£Èô§Áâ©ÂìÅ
            data.stats.clean = Math.min(100, data.stats.clean + 20); // Â¢ûÂä†Êï∞ÂÄº
            data.stats.mood = Math.min(100, data.stats.mood + 2);
            hasAction = true;
            logMsg.push("Ëá™Âä®Ê¥óÊæ°");
        }
    }

    // --- Â¶ÇÊûúÊúâÊìç‰ΩúÔºå‰øùÂ≠òÂπ∂ÈÄöÁü• ---
    if (hasAction) {
        window.savePetData(data); // ‰øùÂ≠òÊï∞ÊçÆ
        
        // Â¶ÇÊûúÁïåÈù¢ÂºÄÁùÄÔºåÂÆûÊó∂Âà∑Êñ∞Êï∞ÂÄº
        if (document.getElementById('pet-settings-modal').style.display === 'flex') {
            updateSettingsUI();
        }
        if (document.getElementById('page4').style.display !== 'none') {
            renderPetMain(); // Âà∑Êñ∞‰∏ªÁïåÈù¢Áä∂ÊÄÅ
        }

        // ÂèëÈÄÅËΩªÊèêÁ§∫ (Toast)Ôºå‰∏çÊâìÊâ∞Áî®Êà∑
        const msg = `ü§ñ ÊâòÁÆ°Âä©Êâã: ${logMsg.join(' & ')} (Áä∂ÊÄÅÂ∑≤ÊÅ¢Â§ç)`;
        if(typeof NotificationManager !== 'undefined') {
            NotificationManager.showToast("Êô∫ËÉΩÊâòÁÆ°ÊâßË°å", msg, "ü§ñ");
        } else {
            console.log(msg); // ÂÖúÂ∫ïÊó•Âøó
        }
    }
}

// 3. ÂêØÂä®Âæ™ÁéØÊ£ÄÊµã (ÊØè 10 ÁßíÊ£ÄÊü•‰∏ÄÊ¨°)
setInterval(runAutoCareCheck, 10000);
// --- 3. È¢ÜÂÖªÈÄªËæë ---
function openAdoptionModal() {
    const modal = document.getElementById('pet-adopt-modal');
    modal.style.display = 'flex';
    const grid = document.getElementById('adopt-grid');
    grid.innerHTML = '';
    
    PET_CONFIG.pets.forEach(p => {
        const div = document.createElement('div');
        div.className = 'pet-item-card';
        div.innerHTML = `<img src="${p.img}" class="pet-item-img"><div style="font-size:0.8rem">${p.name}</div>`;
        div.onclick = () => selectPet(p);
        grid.appendChild(div);
    });
}

let selectedAdoptPet = null;
function selectPet(pet) {
    selectedAdoptPet = pet;
    document.querySelectorAll('#adopt-grid .pet-item-card').forEach(e=>e.style.border="1px solid #ddd");
    event.currentTarget.style.border = "2px solid #ff6b6b";
}
// === 4. ‰øÆÂ§çÈ¢ÜÂÖªÈÄªËæë ===
function confirmAdoption() {
    const name = document.getElementById('adopt-name').value;
    const customFile = document.getElementById('adopt-upload').files[0];
    
    // üî¥ Â¢ûÂä†ÊòéÁ°ÆÁöÑÈîôËØØÊèêÁ§∫
    if(!name) {
        alert("‚ö†Ô∏è ËØ∑Áªô‰Ω†ÁöÑÂ∞è‰ºô‰º¥Ëµ∑‰∏™ÂêçÂ≠óÔºÅ");
        return;
    }
    
    // Â¶ÇÊûúÊ≤°ÈÄâÈ¢ÑËÆæÔºå‰πüÊ≤°‰∏ä‰º†ÂõæÁâá
    if(!selectedAdoptPet && !customFile) {
        alert("‚ö†Ô∏è ËØ∑ÈÄâÊã©‰∏ÄÂè™ÂÆ†Áâ©ÔºåÊàñËÄÖ‰∏ä‰º†‰∏ÄÂº†ÁÖßÁâáÔºÅ");
        return;
    }
    
    const data = getPetData();
    // ÈáçÁΩÆÊï∞ÊçÆÁªìÊûÑ
    data.config.name = name;
    data.stats = { hunger: 80, clean: 80, mood: 100, last_update: Date.now(), last_pat: 0 };
    data.inventory = { coins: 100, items: {}, unlocked_bg: ['bg_default'], unlocked_decor: [] };
    data.state = { bg: 'bg_default', active_decor: [] };
    data.history = []; // Ê∏ÖÁ©∫ÊóßÊïÖ‰∫ã
    
    if(customFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
            data.config.type = 'custom';
            data.config.img = e.target.result;
            savePetData(data); // ‰øùÂ≠ò
            finalizeAdoption();
        };
        reader.readAsDataURL(customFile);
    } else {
        data.config.type = selectedAdoptPet.type;
        data.config.img = selectedAdoptPet.img;
        savePetData(data); // ‰øùÂ≠ò
        finalizeAdoption();
    }
}
function finalizeAdoption() {
    document.getElementById('pet-adopt-modal').style.display = 'none';
    
    // Ëá™Âä®Â°´ÂÖ•‰∏ñÁïå‰π¶
    const data = getPetData();
    const wb = getWBData();
    
    // üëáüëáüëá ‰øÆÊîπËøô‰∏ÄË°å üëáüëáüëá
    const targetCategory = '18.ÂÆ†Áâ©'; // ÊîπÊàêÁâπÂÆöÁöÑÂàÜÁ±ª
    
    if(!wb[targetCategory]) wb[targetCategory] = [];
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®ÔºàÈò≤Ê≠¢ÈáçÂ§çÊ∑ªÂä†Ôºâ
    const exists = wb[targetCategory].find(i => i.title === "ÂΩìÂâçÂÆ†Áâ©ËÆæÂÆö");
    if (!exists) {
        wb[targetCategory].push({
            title: "ÂΩìÂâçÂÆ†Áâ©ËÆæÂÆö",
            content: `„ÄêÂÆ†Áâ©Ê°£Ê°à„Äë\nÂêçÂ≠óÔºö${data.config.name}\nÁßçÁ±ªÔºö${data.config.type}\nËÆæÂÆöÔºöËøôÊòØÁî®Êà∑È¢ÜÂÖªÁöÑ${data.config.type === 'custom' ? 'Á•ûÁßòÁîüÁâ©' : data.config.name}„ÄÇÂÆÉÊÄßÊ†ºÂèØÁà±Ôºå‰ºö‰∏ÄÁõ¥Èô™‰º¥Âú®Áî®Êà∑Ë∫´Ëæπ„ÄÇËØ∑Âú®ÁîüÊàêÊïÖ‰∫ãÊó∂ÔºåÊèèÂÜôÂÆÉ‰∏éÁî®Êà∑Ê∏©È¶®‰∫íÂä®ÁöÑÁªÜËäÇ„ÄÇ`,
            enabled: true
        });
        saveWBData(wb);
        alert("üéâ È¢ÜÂÖªÊàêÂäüÔºÅÂÆ†Áâ©Ê°£Ê°àÂ∑≤Ëá™Âä®Â≠òÂÖ•‰∏ñÁïå‰π¶„Äê18.ÂÆ†Áâ©„ÄëÂàÜÁ±ª‰∏≠„ÄÇ");
    } else {
        // Â¶ÇÊûúÊÉ≥Êõ¥Êñ∞ÔºåÂèØ‰ª•Âú®ËøôÈáåÂÜôÊõ¥Êñ∞ÈÄªËæëÔºåÊàñËÄÖ‰øùÊåÅ‰∏çÂèò
        saveWBData(wb);
    }
    
    renderPetMain();
    startPetLoop();
}
// === ‰øÆÂ§çÔºö‰∏ªÁïåÈù¢Ê∏≤Êüì (Â¢ûÂä†Á©∫Êï∞ÊçÆ‰øùÊä§) ===
function renderPetMain() {
    // 1. Ëé∑ÂèñÊï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÔºå‰ΩøÁî®ÈªòËÆ§ÁªìÊûÑÔºåÈò≤Ê≠¢Êä•Èîô
    let data = window.BIG_MEMORY.pet_data;
    if (!data) {
        data = {
            config: { type: "" },
            state: { bg: 'bg_default', active_decor: [] },
            stats: { mood: 100 }
        };
    }
    
    // 2. ËÆæÁΩÆËÉåÊôØ (ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ°Æ‰øùËÉåÊôØÂßãÁªàÊúâÂÄº)
    // Âç≥‰Ωø data.state.bg ÊòØÁ©∫ÁöÑÔºå‰πüÂº∫Âà∂Áî® PET_CONFIG.bg[0]
    const bgId = data.state && data.state.bg ? data.state.bg : 'bg_default';
    const bgObj = PET_CONFIG.bg.find(b => b.id === bgId) || PET_CONFIG.bg[0];
    
    const bgLayer = document.getElementById('pet-bg-layer');
    if (bgLayer && bgObj) {
        bgLayer.style.backgroundImage = `url(${bgObj.src})`;
    }
    
    // 3. Ê∏≤ÊüìË£ÖÈ•∞
    const decorLayer = document.getElementById('pet-decor-layer');
    if (decorLayer) {
        decorLayer.innerHTML = '';
        if (data.state && data.state.active_decor) {
            data.state.active_decor.forEach(did => {
                const conf = PET_CONFIG.decor.find(d => d.id === did);
                if(conf) {
                    const img = document.createElement('img');
                    img.src = conf.src;
                    img.className = 'pet-decor-obj';
                    img.style.cssText = `position:absolute; pointer-events:auto; ${conf.style}`;
                    img.onclick = (e) => {
                        e.stopPropagation();
                        triggerDecorStory(conf.name);
                    };
                    decorLayer.appendChild(img);
                }
            });
        }
    }
    
    // 4. Ê∏≤ÊüìÂÆ†Áâ©
    const sprite = document.getElementById('pet-sprite');
    const runawayMsg = document.getElementById('pet-runaway-msg');
    
    if (sprite && runawayMsg) {
        // Â¶ÇÊûúÊ≤°ÊúâÈ¢ÜÂÖªÔºåÊàñËÄÖÂøÉÊÉÖ<=0ÔºåÈöêËóèÂÆ†Áâ©
        if (!data.config || !data.config.type) {
            sprite.style.display = 'none';
            runawayMsg.style.display = 'none'; // Ê≤°È¢ÜÂÖªÊó∂‰∏çÊòæÁ§∫Á¶ªÂÆ∂Âá∫Ëµ∞
        } else if (data.stats.mood <= 0) {
            sprite.style.display = 'none';
            runawayMsg.style.display = 'block';
        } else {
            sprite.style.display = 'block';
            sprite.style.backgroundImage = `url(${data.config.img})`;
            runawayMsg.style.display = 'none';
        }
    }
}

// ÂÆ†Áâ©ÁßªÂä®ÈÄªËæë
function startPetLoop() {
    // ÁßªÂä®Âæ™ÁéØ
    setInterval(() => {
        const sprite = document.getElementById('pet-sprite');
        if(sprite.style.display === 'none') return;
        
        // ÈöèÊú∫ÁßªÂä® (ÈôêÂà∂Âú® 10% - 80% ÂÆΩÂ∫¶ÔºåÂ∫ïÈÉ® 20% - 40%)
        const newLeft = 10 + Math.random() * 70;
        const currentLeft = parseFloat(sprite.style.left) || 50;
        
        // Ê†πÊçÆÁßªÂä®ÊñπÂêëÁøªËΩ¨ÂõæÁâá
        if (newLeft < currentLeft) {
            sprite.style.transform = "scaleX(1)"; // ÂêëÂ∑¶
        } else {
            sprite.style.transform = "scaleX(-1)"; // ÂêëÂè≥
        }
        
        sprite.style.left = newLeft + '%';
        // ÂÅ∂Â∞îË∑≥‰∏Ä‰∏ã
        if(Math.random() < 0.3) sprite.classList.add('pet-anim');
        else sprite.classList.remove('pet-anim');
        
    }, 5000); // ÊØè5ÁßíÂä®‰∏ÄÊ¨°

    // Áä∂ÊÄÅË°∞ÂáèÂæ™ÁéØ (ÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÔºåÊåâÂ∞èÊó∂Êâ£Èô§)
    setInterval(updatePetStatsDecay, 60000);
}

function updatePetStatsDecay() {
    const data = getPetData();
    const now = Date.now();
    const hoursPassed = (now - data.stats.last_update) / (1000 * 60 * 60);
    
    if (hoursPassed >= 1) {
        const loss = Math.floor(hoursPassed); // ÊØèÂ∞èÊó∂Êéâ1ÁÇπ
        data.stats.hunger = Math.max(0, data.stats.hunger - loss);
        data.stats.clean = Math.max(0, data.stats.clean - loss);
        
        // ÂøÉÊÉÖËÆ°ÁÆó
        if (data.stats.hunger >= 70 && data.stats.clean >= 70) {
            data.stats.mood = 100;
        } else if (data.stats.hunger === 0 && data.stats.clean === 0) {
            // ÊØèÂ§©Êéâ7ÁÇπ -> ÊØèÂ∞èÊó∂Êéâ 7/24
            data.stats.mood = Math.max(0, data.stats.mood - (loss * 7 / 24));
        }
        
        data.stats.last_update = now;
        savePetData(data);
        renderPetMain(); // Âà∑Êñ∞Áä∂ÊÄÅÔºàÂ¶ÇÁ¶ªÂÆ∂Âá∫Ëµ∞Ôºâ
        updateSettingsUI(); // Â¶ÇÊûúÂºÄÁùÄËÆæÁΩÆÈ°µÔºåÂà∑Êñ∞Êï∞ÂÄº
    }
}

function interactWithPet() {
    openPetSettings();
}
function patPetHead() {
    const data = window.BIG_MEMORY.pet_data;
    const today = new Date().toDateString();
    const lastPat = data.stats.last_pat ? new Date(data.stats.last_pat).toDateString() : "";

    if (today === lastPat) {
        return alert("üëã ‰ªäÂ§©Â∑≤ÁªèÊë∏ËøáÂ§¥Âï¶Ôºå‰∏çÂèØ‰ª•Â§™Ë¥™ÂøÉÂì¶ÔºÅ\n(ÊòéÂ§©ÂÜçÊù•Âêß)");
    }

    // ÊâßË°åÊë∏Â§¥
    data.stats.mood = Math.min(100, data.stats.mood + 8); // ÊÅ¢Â§ç 8%
    data.stats.last_pat = Date.now(); // ËÆ∞ÂΩïÊó∂Èó¥
    
    window.savePetData(data); // ‰øùÂ≠ò
    if(typeof updateSettingsUI === 'function') updateSettingsUI(); // Âà∑Êñ∞
    
    alert("üëã ‰Ω†ËΩªËΩªÊë∏‰∫ÜÊë∏ÂÆÉÁöÑÂ§¥...\nÂøÉÊÉÖ +8% ‚ù§Ô∏è");
    
    // 50% Ê¶ÇÁéáËß¶Âèë‰∏Ä‰∏™Â∞èÊïÖ‰∫ã
    if (Math.random() < 0.5) {
        generatePetStory("Êë∏Â§¥", "Êâã");
    }
}


function retrievePet() {
    const data = getPetData();
    if (data.inventory.coins < 15) return alert("ÁßØÂàÜ‰∏çË∂≥ 15ÔºåÊó†Ê≥ïÊâæÂõû...");
    
    data.inventory.coins -= 15;
    data.stats.mood = 20; // ÊâæÂõûÂêéÊÅ¢Â§ç‰∏ÄÁÇπÂøÉÊÉÖ
    data.stats.hunger = 20;
    data.stats.clean = 20;
    savePetData(data);
    renderPetMain();
    alert("üéâ Áªà‰∫éÊääÂÆÉÊâæÂõûÊù•‰∫ÜÔºÅÂø´ÁªôÂÆÉÁÇπÂêÉÁöÑÂêß„ÄÇ");
}

// --- 5. ÂïÜÂ∫ó‰∏éËÉåÂåÖ ---
let currentShopTab = 'food';

function openPetShop() {
    document.getElementById('pet-shop-modal').style.display = 'flex';
    renderShop();
}

function switchShopTab(tab) {
    currentShopTab = tab;
    document.querySelectorAll('.r-tab').forEach(e=>e.classList.remove('active'));
    event.target.classList.add('active');
    renderShop();
}

function renderShop() {
    const data = getPetData();
    document.getElementById('shop-coins').innerText = parseFloat(data.inventory.coins).toFixed(2);
    const grid = document.getElementById('shop-grid');
    grid.innerHTML = '';
    
    let list = [];
    if(currentShopTab === 'food') list = PET_CONFIG.items.filter(i=>i.type==='food');
    else if(currentShopTab === 'bath') list = PET_CONFIG.items.filter(i=>i.type==='bath');
    else if(currentShopTab === 'bg') list = PET_CONFIG.bg.filter(i=>i.price > 0); // ‰∏çÊòæÁ§∫ÈªòËÆ§
    else if(currentShopTab === 'decor') list = PET_CONFIG.decor;
    
    list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'pet-item-card';
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ë¥≠‰π∞ (ËÉåÊôØ/Ë£ÖÈ•∞ÊòØ‰∏ÄÊ¨°ÊÄßÁöÑ)
        const isBought = (currentShopTab==='bg' && data.inventory.unlocked_bg.includes(item.id)) ||
                         (currentShopTab==='decor' && data.inventory.unlocked_decor.includes(item.id));
        
        let btnHtml = `<button class="m-btn small" style="width:100%;margin-top:5px;" onclick="buyPetItem('${item.id}', '${currentShopTab}')">${item.price}üí∞</button>`;
        if(isBought) btnHtml = `<button class="m-btn small" style="width:100%;margin-top:5px;background:#ccc;">Â∑≤Êã•Êúâ</button>`;
        
        div.innerHTML = `
            <img src="${item.src || item.img}" class="pet-item-img">
            <div style="font-size:0.8rem; height:20px; overflow:hidden;">${item.name || item.id}</div>
            ${btnHtml}
        `;
        grid.appendChild(div);
    });
}
function buyPetItem(id, type) {
    const data = getPetData();
    
    // Êü•ÊâæÁâ©ÂìÅ
    let item = null;
    if(type==='bg') item = PET_CONFIG.bg.find(i=>i.id===id);
    else if(type==='decor') item = PET_CONFIG.decor.find(i=>i.id===id);
    else item = PET_CONFIG.items.find(i=>i.id===id);
    
    if(!item) return;

    // ËÉåÊôØÂíåË£ÖÈ•∞ÂìÅÂè™ËÉΩ‰π∞1‰∏™
    if (type === 'bg' || type === 'decor') {
        if(data.inventory.coins < item.price) return alert("ÁßØÂàÜ‰∏çË∂≥ÔºÅ");
        data.inventory.coins -= item.price;
        if(type === 'bg') {
            if(!data.inventory.unlocked_bg.includes(id)) data.inventory.unlocked_bg.push(id);
        } else {
            if(!data.inventory.unlocked_decor.includes(id)) data.inventory.unlocked_decor.push(id);
        }
        savePetData(data);
        renderShop();
        return alert("Ë¥≠‰π∞ÊàêÂäüÔºÅ");
    }

    // üî¥ Ê∂àËÄóÂìÅÔºöÊâπÈáèË¥≠‰π∞ÈÄªËæë
    const numStr = prompt(`Ë¥≠‰π∞„Äê${item.name}„ÄëÁöÑÊï∞ÈáèÔºü\nÂçï‰ª∑: ${item.price}`, "1");
    if (numStr === null) return; // ÂèñÊ∂à
    const num = parseInt(numStr);
    if (isNaN(num) || num <= 0) return alert("ËØ∑ËæìÂÖ•ÊúâÊïàÊï∞Èáè");

    const totalCost = item.price * num;
    if (data.inventory.coins < totalCost) {
        return alert(`ÁßØÂàÜ‰∏çË∂≥ÔºÅÈúÄË¶Å ${totalCost}Ôºå‰ΩôÈ¢ù ${data.inventory.coins}`);
    }

    // Êâ£Ë¥πÂÖ•Â∫ì
    data.inventory.coins -= totalCost;
    if(!data.inventory.items[id]) data.inventory.items[id] = 0;
    data.inventory.items[id] += num;
    
    savePetData(data); // Êó†ÈôêÂ≠òÂÇ®‰øùÂ≠ò
    renderShop();
    alert(`ÊàêÂäüË¥≠‰π∞ ${num} ‰∏™ ${item.name}ÔºÅ`);
}

function openPetBag() {
    document.getElementById('pet-bag-modal').style.display = 'flex';
    const data = getPetData();
    document.getElementById('bag-coins').innerText = parseFloat(data.inventory.coins).toFixed(2);
    const grid = document.getElementById('bag-grid');
    grid.innerHTML = '';
    
    // Ê∏≤ÊüìÊ∂àËÄóÂìÅ
    for(let [id, count] of Object.entries(data.inventory.items)) {
        if(count <= 0) continue;
        const conf = PET_CONFIG.items.find(i=>i.id===id);
        const div = document.createElement('div');
        div.className = 'pet-item-card';
        div.innerHTML = `
            <img src="${conf.img}" class="pet-item-img">
            <div class="pet-item-count">${count}</div>
            <div style="font-size:0.7rem;">${conf.name}</div>
            <button class="m-btn small" style="width:100%; margin-top:2px;" onclick="useConsumable('${id}')">‰ΩøÁî®</button>
        `;
        grid.appendChild(div);
    }
    
    // Ê∏≤ÊüìË£ÖÈ•∞/ËÉåÊôØ (ËøôÈáåÂÅö‰∏™ÁÆÄÂçïÁöÑÂàáÊç¢ÂÖ•Âè£)
    const toggleDiv = document.createElement('div');
    toggleDiv.className = 'pet-item-card';
    toggleDiv.innerHTML = `<div style="padding:10px; font-size:2rem;">üé®</div><div>Â∏ÉÁΩÆ</div>`;
    toggleDiv.onclick = openDecorationPanel;
    grid.appendChild(toggleDiv);
}
// === 2. ‰øÆÂ§çÁâ©ÂìÅ‰ΩøÁî®ÈÄªËæë ===
function useConsumable(id) {
    const data = getPetData();
    const item = PET_CONFIG.items.find(i => i.id === id);
    const petType = data.config.type; // ÂΩìÂâçÂÆ†Áâ©ÁöÑÁ±ªÂûã (cat, dog, custom...)

    // üî¥ ‰∏•Ê†ºÂåπÈÖçÈÄªËæë
    if (petType === 'custom') {
        // Ëá™ÂÆö‰πâÂÆ†Áâ©(Â¶Ç‰∏ä‰º†ÁöÑÂõæ)Âè™ËÉΩÁî® target='custom' ÁöÑÁâ©ÂìÅ
        if (item.target !== 'custom') {
            return alert(`‰Ω†ÁöÑÊú™Áü•ÁîüÁâ©‰ºº‰πéÂØπ„Äê${item.name}„Äë‰∏çÊÑüÂÖ¥Ë∂£... \n(ËØ∑‰ΩøÁî®‰∏çÁü•ÂêçÁ≥ªÂàóÁâ©ÂìÅ)`);
        }
    } else {
        // ÊôÆÈÄöÂÆ†Áâ©ÔºöÂøÖÈ°ªÁ±ªÂûãÂÆåÂÖ®ÂåπÈÖç
        if (item.target !== petType) {
            return alert(`ÊàëÊòØ${getSpeciesName(petType)}ÔºåÊàë‰∏çÂêÉËøô‰∏™ÔºÅ\n(ËØ∑‰ΩøÁî®${getSpeciesName(petType)}‰∏ìÁî®Áâ©ÂìÅ)`);
        }
    }

    // Êâ£Èô§Áâ©ÂìÅ
    data.inventory.items[id]--;
    
    // Â¢ûÂä†Êï∞ÂÄº
    if (item.type === 'food') {
        data.stats.hunger = Math.min(100, data.stats.hunger + 20);
        data.stats.mood = Math.min(100, data.stats.mood + 5);
    }
    if (item.type === 'bath') {
        data.stats.clean = Math.min(100, data.stats.clean + 20);
        data.stats.mood = Math.min(100, data.stats.mood + 5);
    }

    // Á´ãÂç≥‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
    savePetData(data);
    openPetBag(); // Âà∑Êñ∞ËÉåÂåÖÊòæÁ§∫
    renderPetMain(); // Âà∑Êñ∞‰∏ªÁïåÈù¢(ÂéªÈô§Á¶ªÂÆ∂Âá∫Ëµ∞Áä∂ÊÄÅ)

    // ËØ¢ÈóÆÊòØÂê¶ÁîüÊàêÊïÖ‰∫ã
    if(confirm(`‰ΩøÁî®‰∫Ü„Äê${item.name}„ÄëÔºåÁä∂ÊÄÅÂ∑≤ÊÅ¢Â§çÔºÅ\n\n‚ú® ÊòØÂê¶ÁîüÊàê‰∏ÄÊÆµÊ∏©È¶®Â∞èÊïÖ‰∫ãÔºü`)) {
        const actionName = item.type === 'food' ? 'ÂñÇÈ£ü' : 'Ê¥óÊæ°';
        generatePetStory(actionName, item.name);
    }
}

// ËæÖÂä©ÂáΩÊï∞ÔºöËé∑Âèñ‰∏≠ÊñáÁßçÊóèÂêç
function getSpeciesName(type) {
    const map = { 'cat': 'Áå´Áå´', 'dog': 'ÁãóÁãó', 'fish': 'È±º', 'bird': 'Â∞èÈ∏ü' };
    return map[type] || type;
}
function openDecorationPanel() {
    // ÈöêËóèËÉåÂåÖÔºå‰∏∫‰∫ÜÂ§çÁî®ÂºπÁ™óÈÄªËæëÔºåÊàë‰ª¨Áõ¥Êé•ÂÄüÁî® pet-bag-modal ÁöÑÂÆπÂô®Êù•ÊòæÁ§∫Â∏ÉÁΩÆÂÜÖÂÆπ
    // ÊàñËÄÖÊõ¥ÁÆÄÂçïÁöÑÔºöÊ∏ÖÁ©∫ËÉåÂåÖÁöÑÂÜÖÂÆπÔºåÊ∏≤ÊüìÂ∏ÉÁΩÆÁöÑÂÜÖÂÆπ
    
    const data = getPetData();
    const grid = document.getElementById('bag-grid');
    grid.innerHTML = ''; // Ê∏ÖÁ©∫ËÉåÂåÖÊ†ºÂ≠ê

    // Ê∑ªÂä†‰∏Ä‰∏™‚ÄúËøîÂõûËÉåÂåÖ‚ÄùÁöÑÊåâÈíÆ
    const backDiv = document.createElement('div');
    backDiv.className = 'pet-item-card';
    backDiv.style.background = '#eee';
    backDiv.innerHTML = `<div style="padding:5px; font-size:1.5rem;">üîô</div><div>ËøîÂõûÁâ©ÂìÅ</div>`;
    backDiv.onclick = openPetBag; // ÁÇπÂáªËøîÂõûËÉåÂåÖ
    grid.appendChild(backDiv);

    // 1. Ê∏≤ÊüìËÉåÊôØ (BG)
    data.inventory.unlocked_bg.forEach(bgId => {
        const conf = PET_CONFIG.bg.find(b => b.id === bgId);
        if(!conf) return;
        const isActive = data.state.bg === bgId;
        
        const div = document.createElement('div');
        div.className = 'pet-item-card';
        if(isActive) div.style.border = "2px solid #00cec9"; // È´ò‰∫ÆÂΩìÂâçËÉåÊôØ
        
        div.innerHTML = `<img src="${conf.src}" class="pet-item-img"><div style="font-size:0.7rem">ËÉåÊôØ</div>`;
        div.onclick = () => equipBg(bgId);
        grid.appendChild(div);
    });

    // 2. Ê∏≤ÊüìË£ÖÈ•∞ (Decor) - ËøôÂ∞±ÊòØ‰πãÂâç‰∏çÊòæÁ§∫ÁöÑÂú∞Êñπ
    data.inventory.unlocked_decor.forEach(decId => {
        const conf = PET_CONFIG.decor.find(d => d.id === decId);
        if(!conf) return;
        const isActive = data.state.active_decor.includes(decId);

        const div = document.createElement('div');
        div.className = 'pet-item-card';
        // Â¶ÇÊûúÊ≠£Âú®ÊëÜÊîæ‰∏≠ÔºåÊòæÁ§∫ÁªøËâ≤ËæπÊ°Ü
        if(isActive) div.style.border = "2px solid #6c5ce7"; 

        div.innerHTML = `<img src="${conf.src}" class="pet-item-img"><div style="font-size:0.7rem">${conf.name}</div>`;
        div.onclick = () => toggleDecor(decId);
        grid.appendChild(div);
    });
}

function equipBg(id) {
    const data = getPetData();
    data.state.bg = id;
    savePetData(data);
    renderPetMain();
    alert("ËÉåÊôØÂ∑≤Êõ¥Êç¢");
}

function toggleDecor(id) {
    const data = getPetData();
    const idx = data.state.active_decor.indexOf(id);
    if(idx > -1) data.state.active_decor.splice(idx, 1);
    else data.state.active_decor.push(id);
    savePetData(data);
    renderPetMain();
    openDecorationPanel(); // Âà∑Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
}
// === ü§ñ ÂÆ†Áâ©ÊâòÁÆ°Á≥ªÁªü ===
function autoCarePet() {
    const data = window.BIG_MEMORY.pet_data; // ËØªÂèñÊó†ÈôêÂ≠òÂÇ®
    if (!data || !data.config.type) return alert("ËØ∑ÂÖàÈ¢ÜÂÖªÂÆ†Áâ©ÔºÅ");

    let usedFood = [];
    let usedBath = [];
    let moodBoost = 0;

    // 1. Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂñÇÈ£ü (È•±È£üÂ∫¶ < 89)
    if (data.stats.hunger < 89) {
        // Êü•ÊâæËÉåÂåÖÈáåÂØπÂ∫îÁßçÁ±ªÁöÑÈ£üÁâ©
        const targetType = data.config.type === 'custom' ? 'custom' : data.config.type;
        const validFoodId = PET_CONFIG.items.find(i => i.type === 'food' && i.target === targetType)?.id;
        
        if (validFoodId && data.inventory.items[validFoodId] > 0) {
            // Âæ™ÁéØ‰ΩøÁî®Áõ¥Âà∞ >= 89 Êàñ È£üÁâ©ËÄóÂ∞Ω
            while (data.stats.hunger < 89 && data.inventory.items[validFoodId] > 0) {
                data.inventory.items[validFoodId]--;
                data.stats.hunger = Math.min(100, data.stats.hunger + 20);
                moodBoost += 2;
                if (!usedFood.includes(validFoodId)) usedFood.push(validFoodId);
            }
        }
    }

    // 2. Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ¥óÊæ° (Ê∏ÖÊ¥ÅÂ∫¶ < 89)
    if (data.stats.clean < 89) {
        const targetType = data.config.type === 'custom' ? 'custom' : data.config.type;
        const validBathId = PET_CONFIG.items.find(i => i.type === 'bath' && i.target === targetType)?.id;
        
        if (validBathId && data.inventory.items[validBathId] > 0) {
            while (data.stats.clean < 89 && data.inventory.items[validBathId] > 0) {
                data.inventory.items[validBathId]--;
                data.stats.clean = Math.min(100, data.stats.clean + 20);
                moodBoost += 2;
                if (!usedBath.includes(validBathId)) usedBath.push(validBathId);
            }
        }
    }

    // 3. ÁªìÁÆó
    if (usedFood.length === 0 && usedBath.length === 0) {
        if (data.stats.hunger >= 89 && data.stats.clean >= 89) {
            alert("ü§ñ ÊâòÁÆ°Âä©ÊâãÔºö\nÂÆ†Áâ©Áä∂ÊÄÅÂæàÂ•Ω (ÂêÑÈ°π > 89%)Ôºå‰∏çÈúÄË¶ÅÁÖßÈ°æÂì¶ÔºÅ");
        } else {
            alert("ü§ñ ÊâòÁÆ°Âä©ÊâãÔºö\nËÉåÂåÖÈáåÊ≤°ÊúâÈÄÇÂêàÁöÑÈ£üÁâ©ÊàñÊ≤êÊµ¥Èú≤‰∫Ü...\nËØ∑ÂéªÂïÜÂ∫óË°•ÂÖÖÔºÅ");
        }
    } else {
        data.stats.mood = Math.min(100, data.stats.mood + moodBoost);
        window.savePetData(data); // ‰øùÂ≠ò
        if(typeof updateSettingsUI === 'function') updateSettingsUI(); // Âà∑Êñ∞UI
        
        let msg = "ü§ñ ÊâòÁÆ°ÂÆåÊàêÔºÅ\n";
        if (usedFood.length > 0) msg += "‚úÖ Â∑≤Ëá™Âä®ÂñÇÈ£ü\n";
        if (usedBath.length > 0) msg += "‚úÖ Â∑≤Ëá™Âä®Ê¥óÊæ°\n";
        msg += `ÂΩìÂâçÈ•±È£ü: ${data.stats.hunger}%, Ê∏ÖÊ¥Å: ${data.stats.clean}%`;
        alert(msg);
    }
}
// --- 6. ËÆæÁΩÆ‰∏éÁßØÂàÜÁ≥ªÁªü ---
function openPetSettings() {
    document.getElementById('pet-settings-modal').style.display = 'flex';
    updateSettingsUI();
}
// === ÊõøÊç¢ÂéüÊúâÁöÑ updateSettingsUI ÂáΩÊï∞ ===
// === ‰øÆÂ§çÂêéÁöÑÁïåÈù¢Âà∑Êñ∞ÂáΩÊï∞ ===
// === 2. ‰øÆÂ§çÂÆ†Áâ©ÊâòÁÆ°ÊåâÈíÆÊòæÁ§∫ ===
function updateSettingsUI() {
    // 1. ËØªÂèñÊï∞ÊçÆ
    const data = window.BIG_MEMORY.pet_data; 
    if (!data || !data.config) return; 

    // 2. Êõ¥Êñ∞È°∂ÈÉ®‰ø°ÊÅØ‰∏éÊë∏Â§¥ÊåâÈíÆ
    const infoEl = document.getElementById('pet-info-display');
    if(infoEl) {
        const today = new Date().toDateString();
        const lastPat = data.stats.last_pat ? new Date(data.stats.last_pat).toDateString() : "";
        const canPat = (today !== lastPat);
        
        infoEl.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <span>${data.config.name} <span style="font-size:0.8rem; font-weight:normal;">(${data.config.type || 'Êú™ÂëΩÂêç'})</span></span>
                <button onclick="patPetHead()" style="
                    border:none; border-radius:20px; padding:2px 8px; font-size:0.7rem; cursor:pointer;
                    background: ${canPat ? '#ff7675' : '#ccc'}; 
                    color: ${canPat ? 'white' : '#666'};">
                    ${canPat ? 'üëã Êë∏Â§¥' : 'Â∑≤Êë∏Ëøá'}
                </button>
            </div>
        `;
    }

    // 3. Êõ¥Êñ∞Áä∂ÊÄÅÊù°
    const hunger = Math.floor(data.stats.hunger || 0);
    const clean = Math.floor(data.stats.clean || 0);
    const mood = Math.floor(data.stats.mood || 0);

    const elHunger = document.getElementById('stat-hunger'); if(elHunger) elHunger.innerText = hunger;
    const barHunger = document.getElementById('bar-hunger'); if(barHunger) barHunger.style.width = Math.min(100, hunger) + '%';
    const elClean = document.getElementById('stat-clean'); if(elClean) elClean.innerText = clean;
    const barClean = document.getElementById('bar-clean'); if(barClean) barClean.style.width = Math.min(100, clean) + '%';
    const elMood = document.getElementById('stat-mood'); if(elMood) elMood.innerText = mood;
    const barMood = document.getElementById('bar-mood'); if(barMood) barMood.style.width = Math.min(100, mood) + '%';
    
    // 4. Êõ¥Êñ∞ÁßØÂàÜÊòæÁ§∫ (‰øÆÂ§çÁßØÂàÜ‰∏çÂà∑Êñ∞ÁöÑÈóÆÈ¢ò)
    const coinDisplay = document.getElementById('setting-coin-display');
    if(coinDisplay) coinDisplay.innerText = parseFloat(data.inventory.coins || 0).toFixed(2);

    // 5. Êõ¥Êñ∞‰ªªÂä°ËøõÂ∫¶
    if(data.tasks) {
        const chatTaskEl = document.getElementById('chat-task-progress');
        if(chatTaskEl) chatTaskEl.innerText = `(${data.tasks.chat_count || 0}/30)`;
    }

    // 6. üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊ∏≤ÊüìÊô∫ËÉΩÊâòÁÆ°ÊåâÈíÆ
    // ÂØªÊâæÈáçÊñ∞È¢ÜÂÖªÊåâÈíÆ‰Ωú‰∏∫ÂÆö‰ΩçÁÇπ
    const resetBtn = document.querySelector('#pet-settings-modal .m-btn.secondary'); 
    
    // ÁßªÈô§ÊóßÊåâÈíÆÈò≤Ê≠¢ÈáçÂ§ç
    const oldBtn = document.getElementById('btn-auto-care-toggle');
    if(oldBtn) oldBtn.remove();

    if (resetBtn) {
        const isAuto = data.config.autoCareEnabled; 
        const autoBtn = document.createElement('button');
        autoBtn.id = 'btn-auto-care-toggle';
        autoBtn.className = 'm-btn secondary'; // ‰ΩøÁî®ÂêåÊ†∑ÁöÑÊ†∑ÂºèÁ±ª
        autoBtn.style.width = '100%';
        autoBtn.style.marginBottom = '10px';
        autoBtn.style.fontWeight = 'bold';
        
        if (isAuto) {
            autoBtn.style.background = '#06c755'; // ÁªøËâ≤ÂºÄÂêØ
            autoBtn.style.color = 'white';
            autoBtn.innerHTML = 'ü§ñ Êô∫ËÉΩÊâòÁÆ°ÔºöÂ∑≤ÂºÄÂêØ (ÁÇπÂáªÂÖ≥Èó≠)';
        } else {
            autoBtn.style.background = '#e0e0e0'; // ÁÅ∞Ëâ≤ÂÖ≥Èó≠
            autoBtn.style.color = '#555';
            autoBtn.innerHTML = 'ü§ñ Êô∫ËÉΩÊâòÁÆ°ÔºöÂ∑≤ÂÖ≥Èó≠ (ÁÇπÂáªÂºÄÂêØ)';
        }
        
        autoBtn.onclick = toggleAutoCare; // ÁªëÂÆöÂäüËÉΩ
        // ÊèíÂÖ•Âà∞ÈáçÊñ∞È¢ÜÂÖªÊåâÈíÆÁöÑ‰∏äÈù¢
        resetBtn.parentNode.insertBefore(autoBtn, resetBtn);
    }
}

function petDailyCheckIn() {
    const data = window.BIG_MEMORY.pet_data; // Á°Æ‰øùËØªÂèñÊúÄÊñ∞Êï∞ÊçÆ
    const today = new Date().toDateString();
    const last = new Date(data.tasks.last_checkin).toDateString();
    
    if (today === last) return alert("‰ªäÂ§©Â∑≤ÁªèÁ≠æÂà∞Ëøá‰∫ÜÂì¶ÔºÅ");
    
    data.tasks.last_checkin = Date.now();
    data.inventory.coins += 10;
    savePetData(data);
    
    // üëá Êñ∞Â¢ûËøô‰∏ÄË°åÔºöÁ´ãÂàªÂà∑Êñ∞ÁïåÈù¢‰∏äÁöÑ‰ΩôÈ¢ùÊòæÁ§∫
    updateSettingsUI(); 
    
    alert("Á≠æÂà∞ÊàêÂäüÔºÅËé∑Âæó 10 ÁßØÂàÜ„ÄÇ");
}
// === üé∞ ËµåÁãóÂ§ßËΩ¨ÁõòÊ†∏ÂøÉÈÄªËæë ===
function spinGamblingWheel() {
    const data = window.BIG_MEMORY.pet_data; // Á°Æ‰øùËØªÂèñÊúÄÊñ∞Êï∞ÊçÆ
    const cost = 0.25;

    // 1. Ê£ÄÊü•Èí±Â§ü‰∏çÂ§ü
    if (data.inventory.coins < cost) {
        return alert(`‚ùå ÁßØÂàÜ‰∏çË∂≥ÔºÅÈúÄË¶Å ${cost} ÁßØÂàÜÔºå‰Ω†Âè™Êúâ ${parseFloat(data.inventory.coins).toFixed(2)}„ÄÇ`);
    }

    // 2. Êâ£Èí±
    data.inventory.coins -= cost;

    // 3. ÂáÜÂ§áÂ•ñÊ±† (ÂØºÂÖ•ÂïÜÂ∫óÂíåÊ¥óÊä§ÁöÑÊâÄÊúâÁâ©ÂìÅ)
    const pool = PET_CONFIG.items; 

    // 4. ÊäΩÂ•ñÈÄªËæëÔºö10% Ê¶ÇÁéá‰∏≠Â•ñ
    const isWin = Math.random() < 0.9; 

    let resultMsg = "";

    if (isWin) {
        // ‰∏≠Â•ñ‰∫ÜÔºÅ
        const prize = pool[Math.floor(Math.random() * pool.length)];
        
        // ÂÖ•Â∫ì
        if (!data.inventory.items[prize.id]) data.inventory.items[prize.id] = 0;
        data.inventory.items[prize.id]++;
        
        resultMsg = `üéâ Ê¨ßÁöáÈôÑ‰ΩìÔºÅ\n‰Ω†ÊäΩ‰∏≠‰∫ÜÔºö„Äê${prize.name}„ÄëÔºÅ\n(Â∑≤ÊîæÂÖ•ËÉåÂåÖ)`;
    } else {
        // Ê≤°‰∏≠Â•ñ
        const failMsgs = ["Ë∞¢Ë∞¢ÊÉ†È°æ", "‰∏ãÊ¨°‰∏ÄÂÆö", "‰∏ÄÈòµÈ£éÂêπËøá...", "‰ªÄ‰πà‰πüÊ≤°ÂèëÁîü", "ÂÜçËØï‰∏ÄÊ¨°Ôºü"];
        const randomFail = failMsgs[Math.floor(Math.random() * failMsgs.length)];
        resultMsg = `üí® ${randomFail}\n(Â§±Âéª‰∫Ü 0.25 ÁßØÂàÜ)`;
    }

    // 5. ‰øùÂ≠òÊï∞ÊçÆ & Âà∑Êñ∞ÁïåÈù¢
    savePetData(data); 
    updateSettingsUI(); 
    
    setTimeout(() => alert(resultMsg), 100);
}
function openCheatInput() {
    const code = prompt("ËØ∑ËæìÂÖ•‰ΩúËÄÖÈÄöÈÅìÂØÜÁ†Å:");
    if (code === "103609") {
        const amount = parseInt(prompt("Â¢ûÂä†Â§öÂ∞ëÁßØÂàÜÔºü"));
        if (!isNaN(amount)) {
            const data = getPetData();
            data.inventory.coins += amount;
            savePetData(data);
            alert(`Â∑≤Â¢ûÂä† ${amount} ÁßØÂàÜÔºÅÂΩìÂâç: ${data.inventory.coins}`);
        }
    } else {
        alert("ÂØÜÁ†ÅÈîôËØØ");
    }
}

// ÁõëÂê¨ Chat App ÁöÑÊ∂àÊÅØÊù•Â¢ûÂä†ÁßØÂàÜ (Hook)
const _origAppendMsg = window.appendMessage;
window.appendMessage = function(content, isMe, type, quote) {
    _origAppendMsg(content, isMe, type, quote);
    
    // Âè™ÊúâËá™Â∑±ÂèëÁöÑÊ∂àÊÅØÊâçÁÆó
    if (isMe) {
        const data = getPetData();
        data.tasks.chat_count++;
        if (data.tasks.chat_count >= 30) {
            data.tasks.chat_count = 0; // ÈáçÁΩÆÂæ™ÁéØ
            data.inventory.coins += 5;
            NotificationManager.send({ title:"‰ªªÂä°ÂÆåÊàê", body:"ËææÊàê30Ê¨°ÂØπËØùÔºåËé∑Âæó5ÁßØÂàÜÔºÅ" });
        }
        savePetData(data);
    }
}
// üî¥ ‰øÆÊîπÁâàÔºöÁÇπÂáªË£ÖÈ•∞Áâ©ÈÄªËæë
async function triggerDecorStory(decorName) {
    // Âè™Ë¶ÅÊîπËøôÈáåÁöÑ confirm ÊèêÁ§∫ÊñáÊ°àÂç≥ÂèØ
    if(confirm(`‰Ω†ÁúãÁùÄÂÆ∂ÈáåÁöÑ„Äê${decorName}„Äë...\n\n‚ú® Ë¶ÅÁîüÊàê‰∏ÄÊÆµÁõ∏ÂÖ≥ÁöÑÊó•Â∏∏Â∞èÊïÖ‰∫ãÂêóÔºü`)) {
        generatePetStory('‰∫íÂä®', decorName);
    } else {
        // Áî®Êà∑ÈÄâ‰∏çËßÅÔºåÂè™ÊîπÊï∞ÊçÆ(Â¶ÇÊûúÊúâÊï∞ÊçÆË¶ÅÊîπÁöÑËØùÔºåËøôÈáåÁ∫Ø‰∫íÂä®Ôºå‰∏çÊ∂âÂèäÊï∞ÂÄº‰πüÂèØ‰ª•‰∏çÊîπ)
    }
}
// === 3. ‰øÆÂ§çÊïÖ‰∫ãÁîüÊàê & Êó†ÈôêÂ≠òÂÇ® ===
async function generatePetStory(action, objectName) {
    const data = window.BIG_MEMORY.pet_data; // Áõ¥Êé•ËØªÂèñÂ§ßÂÆπÈáèÂÜÖÂ≠ò
    
    // Ëé∑ÂèñËÆæÂÆö
    const wb = window.BIG_MEMORY.world_book || {};
    // ‰ºòÂÖàËØªÂèñ "18.ÂÆ†Áâ©" ÂàÜÁ±ªÁöÑËÆæÂÆö
    const petCtx = (wb['18.ÂÆ†Áâ©'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    // Ê£ÄÊü• API
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) return alert("‚ùå ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
    if (!apiUrl) apiUrl = "https://api.openai.com/v1";

    // ÊèêÁ§∫ËØç
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Ê∏©È¶®Ê≤ªÊÑàÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÂÆ†Áâ©Ê°£Ê°à„ÄëÔºö${petCtx || `ÂêçÂ≠ó:${data.config.name}, ÁßçÁ±ª:${data.config.type}`}

„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑ÂØπÂÆ†Áâ©ËøõË°å‰∫Ü„Äê${action}„ÄëÊìç‰ΩúÔºå‰ΩøÁî®‰∫Ü„Äê${objectName}„Äë„ÄÇ

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ 100-200 Â≠óÁöÑÊ∏©È¶®Êó•Â∏∏ÁâáÊÆµ„ÄÇ
ËØ∑ÊèèÂÜôÂÆ†Áâ©ÁöÑÂèçÂ∫îÔºàÊ†πÊçÆÂÆÉÁöÑÁâ©ÁßçÁâπÊÄßÔºâÔºå‰ª•ÂèäÂÆÉÂØπ‰∏ª‰∫∫ÁöÑ‰æùÊÅã„ÄÇ
Â¶ÇÊûú‰∏ñÁïåËßÇÈáåÊúâÂÖ∂‰ªñËßíËâ≤ÔºàÂ¶ÇCPÔºâÔºå‰πüÂèØ‰ª•ËÆ©‰ªñ‰ª¨ÂÆ¢‰∏≤Âá∫Âú∫„ÄÇ
**Áõ¥Êé•ËæìÂá∫Á∫ØÊñáÊú¨ÊïÖ‰∫ãÔºå‰∏çË¶ÅJSONÔºå‰∏çË¶ÅMarkdown„ÄÇ**
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{role:"user", content:prompt}],
                temperature: 0.8
            })
        });

        const json = await res.json();
        if (json.error) throw new Error(json.error.message);
        
        // üî¥ ‰øÆÂ§çÔºö‰∏çÂº∫Âà∂Ëß£Êûê JSONÔºåÁõ¥Êé•Ëé∑ÂèñÊñáÊú¨ÔºåÈÅøÂÖçÊ†ºÂºèÈîôËØØÂØºËá¥ÁöÑÂ§±Ë¥•
        let story = json.choices[0].message.content;

        // ‰øùÂ≠òÈÄªËæë (Êó†ÈôêÂ≠òÂÇ®)
        if(!data.history) data.history = [];
        data.history.unshift({
            date: Date.now(),
            action: `${action} ${objectName}`,
            text: story
        });
        
        // ÈôêÂà∂ÂéÜÂè≤Êï∞ÈáèÈò≤Ê≠¢Âç°È°ø
        if(data.history.length > 50) data.history.pop();

        // Â≠òÂÖ• IndexedDB
        savePetData(data);
        
        alert("‚úÖ ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅËØ∑Âú®„ÄêÂÆ†Áâ©Êó•ËÆ∞„Äë‰∏≠Êü•Áúã„ÄÇ");
        updateSettingsUI(); // Âà∑Êñ∞ÁïåÈù¢

    } catch(e) {
        console.error(e);
        alert("‚ùå ÁîüÊàêÂ§±Ë¥•: " + e.message + "\nÂèØËÉΩÊòØ API Key Êó†ÊïàÊàñÁΩëÁªúÈóÆÈ¢ò„ÄÇ");
    }
}
// === üé∞ ËµåÁãóÂ§ßËΩ¨ÁõòÊ†∏ÂøÉÈÄªËæë ===
function spinGamblingWheel() {
    const data = getPetData();
    const cost = 0.25;

    // 1. Ê£ÄÊü•Èí±Â§ü‰∏çÂ§ü
    if (data.inventory.coins < cost) {
        return alert(`‚ùå ÁßØÂàÜ‰∏çË∂≥ÔºÅÈúÄË¶Å ${cost} ÁßØÂàÜÔºå‰Ω†Âè™Êúâ ${data.inventory.coins.toFixed(2)}„ÄÇ`);
    }

    // 2. Êâ£Èí±
    data.inventory.coins -= cost;

    // 3. ÂáÜÂ§áÂ•ñÊ±† (ÂØºÂÖ•ÂïÜÂ∫óÂíåÊ¥óÊä§ÁöÑÊâÄÊúâÁâ©ÂìÅ)
    // ËøôÈáåÁöÑ PET_CONFIG.items ÂåÖÂê´‰∫ÜÊâÄÊúâÈ£üÁâ©ÂíåÊ≤êÊµ¥Èú≤
    const pool = PET_CONFIG.items; 

    // 4. ÊäΩÂ•ñÈÄªËæëÔºöÂçÅ‰∏™ÈáåÈù¢ÊäΩ‰∏Ä‰∏™ (10% Ê¶ÇÁéá‰∏≠Â•ñ)
    const isWin = Math.random() < 0.9; // 0.1 Â∞±ÊòØ 10%

    let resultMsg = "";

    if (isWin) {
        // ‰∏≠Â•ñ‰∫ÜÔºÅ‰ªéÊ±†Â≠êÈáåÈöèÊú∫Êãø‰∏Ä‰∏™
        const prize = pool[Math.floor(Math.random() * pool.length)];
        
        // ÂÖ•Â∫ì (Êó†ÈôêÂ≠òÂÇ®)
        if (!data.inventory.items[prize.id]) data.inventory.items[prize.id] = 0;
        data.inventory.items[prize.id]++;
        
        resultMsg = `üéâ Ê¨ßÁöáÈôÑ‰ΩìÔºÅ\n‰Ω†ÊäΩ‰∏≠‰∫ÜÔºö„Äê${prize.name}„ÄëÔºÅ\n(Â∑≤ÊîæÂÖ•ËÉåÂåÖ)`;
    } else {
        // Ê≤°‰∏≠Â•ñ
        const failMsgs = ["Ë∞¢Ë∞¢ÊÉ†È°æ", "‰∏ãÊ¨°‰∏ÄÂÆö", "‰∏ÄÈòµÈ£éÂêπËøá...", "‰ªÄ‰πà‰πüÊ≤°ÂèëÁîü", "ÂÜçËØï‰∏ÄÊ¨°Ôºü"];
        const randomFail = failMsgs[Math.floor(Math.random() * failMsgs.length)];
        resultMsg = `üí® ${randomFail}\n(Â§±Âéª‰∫Ü 0.25 ÁßØÂàÜ)`;
    }

    // 5. ‰øùÂ≠òÊï∞ÊçÆ & Âà∑Êñ∞ÁïåÈù¢
    savePetData(data); // Â≠òÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì
    updateSettingsUI(); // Âà∑Êñ∞ÊòæÁ§∫ÁöÑÁßØÂàÜ
    
    // Á®çÂæÆÂª∂Ëøü‰∏ÄÁÇπÂºπÂá∫ÁªìÊûúÔºå‰ΩìÈ™åÊõ¥Â•Ω
    setTimeout(() => alert(resultMsg), 100);
}
function deletePetStory(index) {
    if(!confirm("Âà†Èô§Ëøô‰∏™ÊïÖ‰∫ãÔºü")) return;
    const data = getPetData();
    data.history.splice(index, 1);
    savePetData(data);
    updateSettingsUI();
}
// ==================== üè© ÊóÆÊóØGame (Galgame) Ê†∏ÂøÉÈÄªËæë ====================

let galDeck = [];
let galFlipped = [];
let pendingGalDrawType = 'init'; // 'init' (ÂºÄÁØá) Êàñ 'next' (‰∏ã‰∏ÄËΩÆ)

// 1. Êï∞ÊçÆÁÆ°ÁêÜ (Êó†ÈôêÂ≠òÂÇ®)
if (!window.BIG_MEMORY.galgame_data) {
    window.BIG_MEMORY.galgame_data = {
        current: null, // { plot, fav, history: [], finished: false }
        archives: []
    };
}
function getGalData() { 
    // 1. Â¶ÇÊûúÊï¥‰∏™ÂØπË±°‰∏çÂ≠òÂú®ÔºåÂàùÂßãÂåñ
    if (!window.BIG_MEMORY.galgame_data) {
        window.BIG_MEMORY.galgame_data = {
            current: null, 
            archives: []
        };
    }
    
    // 2. üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ¶ÇÊûú archives Êï∞ÁªÑ‰∏¢‰∫ÜÔºåË°•‰∏äÂÆÉÔºÅ
    if (!Array.isArray(window.BIG_MEMORY.galgame_data.archives)) {
        window.BIG_MEMORY.galgame_data.archives = [];
    }

    return window.BIG_MEMORY.galgame_data; 
}

// 2. ÊâìÂºÄ APP
window.openGalgameApp = function() {
    document.getElementById('galgame-app-modal').style.display = 'flex';
    const data = getGalData();
    
    // Â¶ÇÊûúÊúâËøõË°å‰∏≠ÁöÑÊ∏∏Êàè
    if (data.current && !data.current.finished) {
        switchGalView('active');
        document.getElementById('gal-start-panel').style.display = 'none';
        document.getElementById('gal-gameplay-panel').style.display = 'block';
        renderGalgameStory(); // Ê∏≤ÊüìÁé∞ÊúâÂâßÊÉÖ
    } else {
        switchGalView('active');
        document.getElementById('gal-start-panel').style.display = 'block';
        document.getElementById('gal-gameplay-panel').style.display = 'none';
        document.getElementById('gal-init-plot').value = '';
    }
};

window.switchGalView = function(view) {
    if(view === 'active') {
        document.getElementById('gal-active-view').style.display = 'block';
        document.getElementById('gal-history-view').style.display = 'none';
    } else {
        document.getElementById('gal-active-view').style.display = 'none';
        document.getElementById('gal-history-view').style.display = 'block';
        renderGalHistory();
    }
};

// 3. ÂêØÂä®ÊäΩÁâå
window.startGalgameDraw = function(type) {
    pendingGalDrawType = type;
    
    if (type === 'init') {
        const plot = document.getElementById('gal-init-plot').value;
        if(!plot) return alert("ËØ∑ÂÖàËæìÂÖ•ÂàùÂßãÂâßÊÉÖÔºÅ");
    } else {
        // Ê£ÄÊü•ÈÄâÈ°πÊòØÂê¶Â°´ÂÜô
        const a = document.getElementById('gal-opt-a').value;
        const b = document.getElementById('gal-opt-b').value;
        const c = document.getElementById('gal-opt-c').value;
        const fav = document.getElementById('gal-fav-input').value;
        if(!a || !b || !c) return alert("ËØ∑Â°´Êª°‰∏â‰∏™ÈÄâÈ°π (A/B/C)ÔºÅ");
        if(!fav) return alert("ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂ•ΩÊÑüÂ∫¶ÂèòÂä® (ÂèØÂ°´0)ÔºÅ");
    }

    // ÂàùÂßãÂåñÁâåÊ°å (Â§çÁî®ÈÄöÁî®ÈÄªËæë)
    const modal = document.getElementById('galgame-card-table-modal');
    const area = document.getElementById('galgame-card-area');
    const desk = document.getElementById('galgame-card-table-desk');
    
    // Â∫îÁî®ÁöÆËÇ§
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) desk.style.backgroundImage = `url(${res.data})`;
        });
    }

    area.innerHTML = '';
    galDeck = []; galFlipped = [];
    document.getElementById('galgame-flipped-count').innerText = '0';

    for(let i=0; i<=77; i++) galDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) galDeck.push({ type:'lenormand', id:i, isReversed:false });
    galDeck.sort(()=>Math.random()-0.5);

    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    galDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*4-2}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                galFlipped = galFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                galFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ if(res && res.data) front.style.backgroundImage=`url(${res.data})`; else {front.style.background="#fff"; front.innerText=card.id;} });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)"; else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('galgame-flipped-count').innerText = galFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
};

window.finishGalgameDraw = async function() {
    if(galFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");
    
    // ‚úÖ ‰øÆÂ§çÁÇπ1ÔºöÊõ¥Á®≥ÂÅ•ÁöÑÊåâÈíÆËé∑ÂèñÊñπÂºè
    const btn = document.querySelector('#galgame-card-table-modal button.primary') || document.querySelector('#galgame-card-table-modal .m-btn.primary');
    const oldText = btn ? btn.innerText : "ÁîüÊàêÂâßÊÉÖ";
    if(btn) { btn.innerText = "‚è≥ Ê≠£Âú®Êé®ÊºîÂëΩËøê..."; btn.disabled = true; }

    try {
        // ÂáÜÂ§áÊï∞ÊçÆ
        const cardsDesc = galFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
        const wb = window.BIG_MEMORY.world_book || {};
        const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
        const gameCtx = (wb['19.ÊóÆÊóØgame'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

        let prompt = "";
        let userInputs = {};

        // A. Â¶ÇÊûúÊòØÂºÄÁØá
        if (pendingGalDrawType === 'init') {
            const plot = document.getElementById('gal-init-plot').value;
            // ÂàùÂßãÂåñÊï∞ÊçÆ
            const data = getGalData();
            data.current = { 
                start_date: Date.now(), 
                fav: 0, 
                history: [{ type: 'init', content: `„ÄêÂàùÂßãËÆæÂÆö„Äë\n${plot}` }] 
            };
            saveGalData(data);

            prompt = `‰Ω†ÊòØ‰∏Ä‰∏™GalgameÂºïÊìé„ÄÇ‰∏ñÁïåËßÇÔºö${globalCtx}„ÄÇÊ∏∏ÊàèËÆæÂÆöÔºö${gameCtx}„ÄÇÂàùÂßãÊÉÖÂ¢ÉÔºö${plot}„ÄÇÂëΩËøêÁâåÔºö${cardsDesc}„ÄÇ
            ‰ªªÂä°ÔºöÁîüÊàêÊ∏∏ÊàèÁöÑ**ÂºÄÁØáÊïÖ‰∫ã**„ÄÇ
            Ë¶ÅÊ±ÇÔºö200Â≠óÂ∑¶Âè≥Ôºå‰æßÈáçÊèèÂÜôËßíËâ≤ÁöÑË°å‰∏∫„ÄÇÁªìÂ±ÄÂºÄÊîæ„ÄÇÁõ¥Êé•ËæìÂá∫Ê≠£Êñá„ÄÇ`;
        } 
        // B. Â¶ÇÊûúÊòØ‰∏ã‰∏ÄËΩÆ
        else {
            const data = getGalData();
            // Èò≤Ê≠¢ history ‰∏∫Á©∫Êä•Èîô
            const prevStory = (data.current.history.length > 0) 
                ? data.current.history[data.current.history.length-1].content 
                : "Êñ∞ÁöÑÂºÄÂßã";
            
            userInputs = {
                A: document.getElementById('gal-opt-a').value,
                B: document.getElementById('gal-opt-b').value,
                C: document.getElementById('gal-opt-c').value,
                fav_change: parseFloat(document.getElementById('gal-fav-input').value) || 0
            };

            prompt = `
            ‰Ω†ÊòØ‰∏Ä‰∏™GalgameÂºïÊìé„ÄÇ‰∏ñÁïåËßÇÔºö${globalCtx}„ÄÇ
            ‰∏ä‰∏ÄÊÆµÂâßÊÉÖÔºö${prevStory.substring(0, 300)}...
            Áî®Êà∑ÈÄâÈ°πÔºöA:${userInputs.A}, B:${userInputs.B}, C:${userInputs.C}„ÄÇ
            Â•ΩÊÑüÂèòÂåñÔºö${userInputs.fav_change}„ÄÇ
            ÂëΩËøêÁâåÔºö${cardsDesc}„ÄÇ

            ‰ªªÂä°Ôºö
            1. ÁâåÊÑèÊòØÁâåÊÑèÂíåÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÂíåÁâåËΩ¨Êç¢‰∏∫ËßíËâ≤ÁöÑÊΩúÊÑèËØÜÔºöÊ†πÊçÆÁâåÊÑèÂà§Êñ≠ËßíËâ≤ÈÄâA/B/CÂì™‰∏Ä‰∏™„ÄÇÊ≠£Êñá‰πüÊ†πÊçÆÁâåÊÑèËµ∞ÂêëÁîüÊàê„ÄÇ
            2. ÁîüÊàêÂâßÊÉÖÔºåÊèèÂÜôËßíËâ≤ÁöÑÂèçÂ∫îÔºåÈúÄ‰ΩìÁé∞Â•ΩÊÑüÂ∫¶ÂèòÂåñ„ÄÇÔºàÂ•ΩÊÑüÂ∫¶ÊòØÁî®Êà∑ÂØπËßíËâ≤ÁöÑÂ•ΩÊÑüÂ∫¶ÔºåËßíËâ≤ÂèØ‰ª•ÊÑüÁü•Âà∞‰∫õËÆ∏Ôºâ
            
            ËæìÂá∫‰∏•Ê†ºJSONÔºö
            { "chosen_option": "A", "reason": "...", "story": "..." }
            `;
        }

        // Ë∞ÉÁî® API
        let apiKey = document.getElementById('api-key').value;
        let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
        let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
        
        if(!apiKey) {
            try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){}
        }
        if(!apiKey) throw new Error("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content: pendingGalDrawType==='init' ? "Creative writer." : "JSON output only."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        if(json.error) throw new Error(json.error.message);

        const data = getGalData();

        if (pendingGalDrawType === 'init') {
            // ÂºÄÁØáÂ§ÑÁêÜ
            const story = json.choices[0].message.content;
            data.current.history.push({ 
                type: 'story', 
                content: story + `\n\nüîÆ ÂºÄÂ±ÄÁâåÊÑèÔºö${cardsDesc}` 
            });
            document.getElementById('gal-start-panel').style.display = 'none';
            document.getElementById('gal-gameplay-panel').style.display = 'block';
        } else {
            // ‰∏ã‰∏ÄËΩÆÂ§ÑÁêÜ
            let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
            const resObj = JSON.parse(raw);
            
            // Êõ¥Êñ∞Â•ΩÊÑüÂ∫¶
            data.current.fav += userInputs.fav_change;
            if(data.current.fav < 0) data.current.fav = 0;
            if(data.current.fav > 100) data.current.fav = 100;

            const choiceText = userInputs[resObj.chosen_option] || "Êú™Áü•ÈÄâÈ°π";
            
            data.current.history.push({
                type: 'turn',
                user_options: userInputs,
                user_fav_change: userInputs.fav_change,
                ai_choice: resObj.chosen_option,
                ai_reason: resObj.reason,
                story_content: resObj.story, // ÂçïÁã¨Â≠òÊïÖ‰∫ãÔºåÊñπ‰æøÈáçÂÜô
                content: `„Äê‰Ω†ÁöÑÈÄâÈ°π„Äë\nA: ${userInputs.A}\nB: ${userInputs.B}\nC: ${userInputs.C}\n(Â•ΩÊÑü ${userInputs.fav_change>0?'+':''}${userInputs.fav_change})\n\nüëâ **ËßíËâ≤ÈÄâÊã©‰∫Ü ${resObj.chosen_option}Ôºö${choiceText}**\n(üîÆ ÁâåÊÑè: ${resObj.reason})\n\n${resObj.story}`
            });

            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('gal-opt-a').value = '';
            document.getElementById('gal-opt-b').value = '';
            document.getElementById('gal-opt-c').value = '';
            document.getElementById('gal-fav-input').value = '';

            // ‚úÖ ‰øÆÂ§çÁÇπ2ÔºöÂ¶ÇÊûúÂ•ΩÊÑüÂ∫¶ >= 100ÔºåËß¶ÂèëÁªìÂ±ÄÁîüÊàê
            if (data.current.fav >= 100) {
                saveGalData(data); // ÂÖà‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
                renderGalgameStory();
                document.getElementById('galgame-card-table-modal').style.display = 'none';
                
                setTimeout(() => {
                    generateGalgameEndingAPI(); // üëà Ë∞ÉÁî®Êñ∞ÁöÑÁªìÂ±ÄÁîüÊàêÂáΩÊï∞
                }, 500);
                return;
            }
        }

        saveGalData(data);
        renderGalgameStory();
        document.getElementById('galgame-card-table-modal').style.display = 'none';

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        if(btn) { btn.innerText = oldText; btn.disabled = false; }
    }
};
window.renderGalgameStory = function() {
    const data = getGalData();
    const area = document.getElementById('gal-story-area');
    
    // Êõ¥Êñ∞Â•ΩÊÑüÂ∫¶
    document.getElementById('gal-fav-display').innerText = data.current.fav;
    
    // Ê∏≤ÊüìÊñáÊú¨
    let html = "";
    data.current.history.forEach((h, index) => {
        let contentHtml = h.content.replace(/\n/g, '<br>');
        
        // ÁªôÊúÄÂêé‰∏ÄÊù°Â¢ûÂä†‚ÄúÈáçÂÜô‚ÄùÊåâÈíÆ (‰ªÖÈôêÈùûÁªìÂ±Ä„ÄÅÈùûÂºÄÁØáÁöÑ Turn)
        const isLast = index === data.current.history.length - 1;
        let btnHtml = "";
        
        if (isLast && h.type === 'turn') {
            btnHtml = `<div style="text-align:right; margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
                <button class="m-btn small" onclick="regenerateGalTurn()" style="background:#dfe6e9; color:#2d3436; font-size:0.7rem;">üîÑ ‰∏çÊª°ÊÑèÔºüÈáçÊñ∞ÁîüÊàê</button>
            </div>`;
        }

        if(h.type === 'init') {
            html += `<div style="padding-bottom:10px; border-bottom:1px dashed #ccc; margin-bottom:10px; color:#636e72;">${contentHtml}</div>`;
        } else {
            html += `<div style="padding:10px; background:#fff0f6; border-radius:8px; margin-bottom:10px; border-left:3px solid #ff7675;">
                ${contentHtml}
                ${btnHtml}
            </div>`;
        }
    });
    area.innerHTML = html;
    area.scrollTop = area.scrollHeight;
};
window.generateGalgameEndingAPI = async function() {
    // 1. Ëé∑ÂèñÊï∞ÊçÆ
    const data = getGalData();
    if (!data.archives) data.archives = [];

    // UI ÊèêÁ§∫
    const btn = document.querySelector('#gal-gameplay-panel button.small'); 
    if(btn) { btn.innerText = "‚è≥ ÁªìÂ±ÄÁîüÊàê‰∏≠..."; btn.disabled = true; }

    alert("üéâ Â•ΩÊÑüÂ∫¶Â∑≤Êª°ÔºÅÊ≠£Âú®‰∏∫ÊÇ®ÂõûÊ∫ØÊâÄÊúâËÆ∞ÂøÜÂπ∂ÁºñÁªáÁªìÂ±Ä...\n(ÊñáÊú¨ËæÉÈïøÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ 15-20 Áßí)");
    
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const gameCtx = (wb['19.ÊóÆÊóØgame'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // üî•„ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÔºöËØªÂèñÂÖ®ÈÉ®ÂéÜÂè≤ÔºåÂπ∂‰øùÁïôÊúÄËøë 20,000 ‰∏™Â≠óÁ¨¶ (Á∫¶ 1‰∏áÊ±âÂ≠ó)
    // 1. ‰∏çÂÜç‰ΩøÁî® .slice(-5) ÈôêÂà∂Êù°Êï∞ÔºåËÄåÊòØÂ§ÑÁêÜÊâÄÊúâÂéÜÂè≤
    const allHistory = data.current.history || [];
    
    const historyText = allHistory.map(h => {
        // Ê∏ÖÊ¥ó HTML Ê†áÁ≠æÔºåÂè™‰øùÁïôÁ∫ØÊñáÊú¨ÔºåËäÇÁúÅ Token
        let cleanText = h.content.replace(/<[^>]+>/g,"");
        // Â¶ÇÊûúÊòØÈÄâÈ°πÂõûÂêàÔºåÂä†‰∏äÁî®Êà∑ÁöÑÈÄâÊã©
        if(h.type === 'turn') {
            return `[ÂõûÂêà] ÊàëÈÄâ‰∫Ü: ${h.user_options[h.ai_choice]}\nËßíËâ≤ÂèçÂ∫î: ${cleanText}`;
        }
        return `[ÂâßÊÉÖ] ${cleanText}`;
    }).join("\n\n").slice(-20000); // üëà ËøôÈáåÊîπÊàê‰∫Ü 20000ÔºåË∂≥Â§üË¶ÜÁõñ 5000+ Ê±âÂ≠óÁöÑÈúÄÊ±Ç

    const prompt = `
    ‰Ω†ÊòØ‰∏Ä‰∏™GalgameÂºïÊìé„ÄÇ
    „Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
    „ÄêËÆæÂÆö„ÄëÔºö${gameCtx}
    
    „ÄêÂÆåÊï¥ÂâçÊÉÖÂõûÈ°æ (Context)„ÄëÔºö
    ${historyText}
    
    „ÄêÂΩìÂâçÁä∂ÊÄÅ„ÄëÔºöÂ•ΩÊÑüÂ∫¶ 100 (Max)„ÄÇ
    
    „Äê‰ªªÂä°„ÄëÔºö
    ËØ∑ÁîüÊàê‰∏Ä‰∏™**ÂÆåÁæéÁöÑ„ÄÅÊÑü‰∫∫ÁöÑÂ§ßÁªìÂ±Ä (True Ending)**„ÄÇ
    1. **Ê∑±Â∫¶ÂëºÂ∫î**ÔºöÂøÖÈ°ªÂëºÂ∫î‰∏äÊñá‰∏≠ÂèëÁîüËøáÁöÑÂÖ∑‰Ωì‰∫ã‰ª∂Ôºà‰æãÂ¶ÇÂõûÈ°æÂàùÈÅá„ÄÅÂõûÈ°æ‰∏≠Èó¥ÁöÑÊ≥¢ÊäòÔºâÔºåËÆ©ÁªìÂ±ÄÊúâÂÆøÂëΩÊÑü„ÄÇ
    2. **ÊÉÖÊÑüÁàÜÂèë**ÔºöÊèèÂÜôËßíËâ≤Á°ÆËÆ§ÂøÉÊÑè„ÄÅË°®ÁôΩÊàñËææÊàêÊúÄÁªàÁæÅÁªäÁöÑÊó∂ÂàªÔºåÂøÉÁêÜÊèèÂÜôË¶ÅÁªÜËÖª„ÄÇ
    3. **Â≠óÊï∞Ë¶ÅÊ±Ç**Ôºö600Â≠óÂ∑¶Âè≥ÔºàÂÜôÈïø‰∏ÄÁÇπÔºâ„ÄÇ
    4. ÁªìÂ∞æÈúÄÂåÖÂê´„ÄêÁªìÂ±ÄËææÊàêÔºöXXXX„ÄëÁöÑÊ†áÈ¢ò„ÄÇ
    
    ËØ∑Áõ¥Êé•ËæìÂá∫ÁªìÂ±ÄÊ≠£Êñá„ÄÇ
    `;

    try {
        let apiKey = document.getElementById('api-key').value;
        let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
        let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
        
        if(!apiKey) {
            try { const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
        }
        if(!apiKey) throw new Error("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Creative writer. Context-aware."}, {role:"user", content:prompt}],
                temperature: 0.9,
                // üî• Â¶ÇÊûú‰Ω†ÁöÑÊ®°ÂûãÊîØÊåÅ 16kÔºåËøôÈáåÂèØ‰ª•ËÆæÊõ¥Â§ßÔºå‰ΩÜÂú®ÊôÆÈÄöÊ®°Âûã‰∏ã 1500-2000 token ÊòØËæìÂá∫‰∏äÈôê
                max_tokens: 2000 
            })
        });
        
        if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error?.message || `HTTP Error: ${res.status}`);
        }
        
        const json = await res.json();
        const endingText = json.choices[0].message.content;
        
        // ‰øùÂ≠òÁªìÂ±Ä
        data.current.history.push({ 
            type: 'story', 
            content: `<div style="color:#d63031; font-weight:bold; text-align:center; margin-bottom:10px; font-size:1.1rem; border:2px solid #d63031; padding:5px;">‚ù§ HAPPY ENDING ‚ù§</div>${endingText}` 
        });
        
        data.current.finished = true;
        data.archives.unshift(data.current);
        data.current = null; 
        
        saveGalData(data);
        
        alert("‚ú® ÂÆåÁæéÁªìÂ±ÄÂ∑≤ÁîüÊàêÂπ∂Â≠òÊ°£ÔºÅ");
        switchGalView('history'); 

    } catch(e) {
        console.error(e);
        // Êõ¥Âä†ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
        if (e.message.includes("context_length_exceeded")) {
            alert("ÁîüÊàêÂ§±Ë¥•ÔºöÂéÜÂè≤ËÆ∞ÂΩïÂ§™ÈïøÔºåË∂ÖËøá‰∫ÜÂΩìÂâçÊ®°ÂûãÁöÑËÆ∞ÂøÜ‰∏äÈôê„ÄÇ\n\nÂª∫ËÆÆÔºö\nËØ∑Âú®ËÆæÁΩÆÈáåÂàáÊç¢ÊîØÊåÅÊõ¥Â§ß‰∏ä‰∏ãÊñáÁöÑÊ®°ÂûãÔºàÂ¶Ç gpt-3.5-turbo-16k Êàñ gpt-4-turboÔºâ„ÄÇ");
        } else {
            alert("ÁªìÂ±ÄÁîüÊàêÂ§±Ë¥•: " + e.message + "\n(ËøõÂ∫¶Êú™‰∏¢Â§±ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï)");
        }
    } finally {
        if(btn) { btn.innerText = "üè≥Ô∏è ÁªìÊùü/Â≠òÊ°£"; btn.disabled = false; }
    }
};
window.regenerateGalTurn = async function() {
    if(!confirm("Á°ÆÂÆöË¶ÅÊ∂àËÄóTokenÈáçÊñ∞ÁîüÊàêËøô‰∏ÄÊÆµÂêóÔºü\n(Â•ΩÊÑüÂ∫¶Â∞ÜÂõûÊªöÔºåÈáçÊñ∞ËøõË°åÊú¨Ê¨°Âà§ÂÆö)")) return;

    const data = getGalData();
    const lastTurn = data.current.history.pop(); // ÂºπÂá∫ÊúÄÂêé‰∏ÄÊù°
    
    if (!lastTurn || lastTurn.type !== 'turn') {
        alert("Êó†Ê≥ïÈáçÂÜôÊ≠§ÊÆµËêΩ");
        return;
    }

    // ÂõûÊªöÂ•ΩÊÑüÂ∫¶
    data.current.fav -= lastTurn.user_fav_change;
    saveGalData(data); // ‰øùÂ≠òÂõûÊªöÁä∂ÊÄÅ
    
    // ÊÅ¢Â§çUIËæìÂÖ•
    document.getElementById('gal-opt-a').value = lastTurn.user_options.A;
    document.getElementById('gal-opt-b').value = lastTurn.user_options.B;
    document.getElementById('gal-opt-c').value = lastTurn.user_options.C;
    document.getElementById('gal-fav-input').value = lastTurn.user_fav_change;
    
    renderGalgameStory(); // Âà∑Êñ∞ÁïåÈù¢ÔºàÊ≠§Êó∂ÊúÄÂêé‰∏ÄÊù°Â∑≤Ê∂àÂ§±Ôºâ
    
    alert("Â∑≤ÂõûÊªöÁä∂ÊÄÅÔºåËØ∑ÁÇπÂáª„Äêüé≤ Á°ÆËÆ§Âπ∂ÊäΩÁâå„ÄëÈáçÊñ∞ÂºÄÂßãÊú¨ËΩÆ„ÄÇ");
};
window.endGalgame = async function(isSuccess) {
    const data = getGalData(); // ‰ΩøÁî®‰øÆÂ§çÁâà getter
    if (!data.current) return;

    // Â¶ÇÊûú‰∏çÊòØÊª°Â•ΩÊÑüÂ∫¶ÁªìÊùüÔºåÂ∞±ÊòØÊâãÂä®Â≠òÊ°£
    if(!isSuccess) {
        if(!confirm("Á°ÆÂÆöË¶ÅÁªìÊùüÂΩìÂâçËøõÂ∫¶Âπ∂Â≠òÊ°£ÂêóÔºü(‰πãÂêéÂè™ËÉΩÂõûÈ°æÔºåÊó†Ê≥ïÁªßÁª≠)")) return;
        
        data.current.finished = true;
        
        // üî• ÂÆâÂÖ®Â≠òÊ°£
        if (!data.archives) data.archives = [];
        data.archives.unshift(data.current);
        
        data.current = null; // Ê∏ÖÁ©∫ÂΩìÂâç
        
        saveGalData(data);
        alert("‚úÖ Â∑≤Â≠òÊ°£ÔºÅ");
        switchGalView('history');
    }
    // Â¶ÇÊûúÊòØÊª°Â•ΩÊÑüÂ∫¶ÔºåÈÄªËæëÂ∑≤ÁªèÂú® generateGalgameEndingAPI ÈáåÂ§ÑÁêÜ‰∫Ü
};

// 7. Ê∏≤ÊüìÂéÜÂè≤Â≠òÊ°£
function renderGalHistory() {
    const data = getGalData();
    const list = document.getElementById('gal-history-list');
    list.innerHTML = '';
    
    if(data.archives.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">ÊöÇÊó†Â≠òÊ°£</div>';
        return;
    }

    data.archives.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '10px';
        
        // ÊèêÂèñÂºÄÁØáÈ¢ÑËßà
        const preview = item.history[0]?.content.substring(0, 50) + "...";
        const date = new Date(item.start_date).toLocaleString();
        
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888; display:flex; justify-content:space-between;">
                <span>${date}</span>
                <strong style="color:#d63031;">ÊúÄÁªàÂ•ΩÊÑü: ${item.fav}</strong>
            </div>
            <div style="font-size:0.9rem; margin-top:5px;">${preview}</div>
            <div style="text-align:right; margin-top:5px;">
                <button class="m-btn small" onclick="deleteGalArchive(${index})" style="background:#ffcdd2; color:#c23616;">Âà†Èô§</button>
                <button class="m-btn small" onclick="viewGalArchive(${index})" style="background:#dfe4ea;">ÂõûÈ°æ</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function deleteGalArchive(index) {
    if(!confirm("Âà†Èô§Ëøô‰∏™Â≠òÊ°£Ôºü")) return;
    const data = getGalData();
    data.archives.splice(index, 1);
    saveGalData(data);
    renderGalHistory();
}

// ÁÆÄÂçïÁöÑÂõûÈ°æÂäüËÉΩ (Âè™ËØª)
function viewGalArchive(index) {
    const data = getGalData();
    const item = data.archives[index];
    
    // Â§çÁî®‰∏ªÁïåÈù¢ÊòæÁ§∫Ôºå‰ΩÜÈöêËóèÊìç‰ΩúÂå∫
    document.getElementById('gal-active-view').style.display = 'block';
    document.getElementById('gal-history-view').style.display = 'none';
    document.getElementById('gal-start-panel').style.display = 'none';
    document.getElementById('gal-gameplay-panel').style.display = 'block';
    
    // Ê∏≤ÊüìÂÜÖÂÆπ
    const area = document.getElementById('gal-story-area');
    let html = "";
    item.history.forEach(h => {
        html += `<div style="padding-bottom:10px; margin-bottom:10px; border-bottom:1px dashed #ccc;">${h.content.replace(/\n/g, '<br>')}</div>`;
    });
    area.innerHTML = html;
    
    // ÈöêËóèÊìç‰ΩúÊåâÈíÆ
    document.querySelector('#gal-gameplay-panel .morandi-card:last-child').style.display = 'none';
    document.getElementById('gal-fav-display').innerText = item.fav;
    
    // ‰øÆÊîπÈ°∂ÈÉ®ÊåâÈíÆ‰∏∫‚ÄúËøîÂõû‚Äù
    const topBtn = document.querySelector('#gal-gameplay-panel button');
    topBtn.innerText = "üîô ËøîÂõûÂ≠òÊ°£ÂàóË°®";
    topBtn.onclick = () => switchGalView('history');
}
// ==================== ‚úÖ ÁªàÊûÅÁ≥ªÁªüÂêØÂä®ÂÖ•Âè£ ====================
window.addEventListener('load', function() {
    console.log("‚ö° Á≥ªÁªüÊ≠£Âú®ÂàùÂßãÂåñ...");
    
    // 1. ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì
    idb.init().then(async () => {
        
        // 2. Á≠âÂæÖÊó†ÈôêÂ≠òÂÇ®Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ (ÂåÖÊã¨ÂÆ†Áâ©„ÄÅÊó•ËÆ∞„ÄÅËÆæÁΩÆÁ≠â)
        await loadAllBigData();
        
        // 3. Âä†ËΩΩÂÖ∂‰ªñËµÑÊ∫ê
        loadTVContent();
        if(typeof loadGameWidgetTheme === 'function') loadGameWidgetTheme();
        try { await idb.get('settings_heavy', 'myAvatar'); } catch(e){}
        
        // 4. Âà∑Êñ∞ÂêÑ‰∏™ APP ÁöÑÁïåÈù¢ (Á°Æ‰øùÊï∞ÊçÆÂä†ËΩΩÂêéÁ´ãÂç≥ÊòæÁ§∫)
        if(typeof renderLetterList === 'function') renderLetterList();
        if(typeof renderFinanceUI === 'function') renderFinanceUI();
        if(typeof updateGameStatsUI === 'function') updateGameStatsUI();
        if(typeof updateSettingsUI === 'function') updateSettingsUI(); // Âà∑Êñ∞ÂÆ†Áâ©ËÆæÁΩÆÈ°µÁßØÂàÜ
        
        // 5. È¢ÑÊ∏≤ÊüìÂÆ†Áâ©ËÉåÊôØ (Âç≥‰ΩøÂú®Á¨¨1È°µ‰πüË¶ÅÂÖàÊ∏≤ÊüìÔºåÈò≤Ê≠¢ÊªëËøáÂéªÊòØÁôΩÁöÑ)
        if(typeof renderPetMain === 'function') renderPetMain();

        console.log("‚úÖ Á≥ªÁªüÂêØÂä®ÂÆåÊØïÔºÅÊâÄÊúâÁªÑ‰ª∂Â∑≤Â∞±Áª™„ÄÇ");
    });
});
// ==================== üêæ ÂÆ†Áâ©Êó•ËÆ∞ APP Áã¨Á´ãÈÄªËæë ====================

// 1. ÊâìÂºÄ APP
function openPetDiaryApp() {
    document.getElementById('pet-diary-app-modal').style.display = 'flex';
    renderPetDiaryList();
}

// 2. Ê∏≤ÊüìÂàóË°® (‰ªéÊó†ÈôêÂ≠òÂÇ®ËØªÂèñ)
function renderPetDiaryList() {
    // Áõ¥Êé•‰ªéÂ§ßÂÆπÈáèÂÜÖÂ≠òËØªÂèñÔºåÁ°Æ‰øùÊòØÊúÄÊñ∞Êï∞ÊçÆ
    const data = window.BIG_MEMORY.pet_data; 
    const container = document.getElementById('pet-diary-full-list');
    container.innerHTML = '';

    // ÂÆπÈîôÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊ≤°ÊúâÂÆ†Áâ©Êï∞ÊçÆÊàñÂéÜÂè≤
    if (!data || !data.history || data.history.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#999; margin-top:50px;">
                <p>ÊöÇÊó†Êó•ËÆ∞...</p>
                <p style="font-size:0.8rem;">ÂéªÁªôÂÆ†Áâ©ÂñÇÈ£ü„ÄÅÊ¥óÊæ°ÊàñÁÇπÂáªË£ÖÈ•∞Áâ©<br>ÁîüÊàê‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÁØáÊïÖ‰∫ãÂêßÔºÅ</p>
            </div>`;
        return;
    }

    // ÈÅçÂéÜÂéÜÂè≤ËÆ∞ÂΩï (ÂÄíÂ∫èÔºåÊúÄÊñ∞ÁöÑÂú®‰∏äÈù¢)
    data.history.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '15px';
        div.style.padding = '15px';
        div.style.background = '#fff';
        div.style.borderLeft = '4px solid #ffcc80'; // Ë£ÖÈ•∞Á∫ø
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding-bottom:8px; margin-bottom:8px;">
                <span style="font-size:0.8rem; color:#888;">${new Date(item.date).toLocaleString()}</span>
                <span style="font-size:0.8rem; font-weight:bold; color:#d35400;">${item.action}</span>
            </div>
            <div style="font-size:0.95rem; color:#333; line-height:1.6; text-align:justify;">
                ${item.text.replace(/\n/g, '<br>')}
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button class="m-btn small" onclick="deletePetDiaryEntry(${index})" style="background:#ffcdd2; color:#c62828; font-size:0.7rem; padding:4px 10px;">üóëÔ∏è Âà†Èô§</button>
            </div>
        `;
        container.appendChild(div);
    });
}

// 3. Âà†Èô§ÂçïÊù°Êó•ËÆ∞ (ÂêåÊ≠•Êõ¥Êñ∞Êó†ÈôêÂ≠òÂÇ®)
function deletePetDiaryEntry(index) {
    if(!confirm("Á°ÆÂÆöË¶ÅÊíïÊéâËøô‰∏ÄÈ°µÊó•ËÆ∞ÂêóÔºü(Êó†Ê≥ïÊÅ¢Â§ç)")) return;
    
    const data = window.BIG_MEMORY.pet_data;
    if(data && data.history) {
        data.history.splice(index, 1); // Âà†Èô§
        
        // üî• ÂÖ≥ÈîÆÔºö‰øùÂ≠òÂõû IndexedDB (Êó†ÈôêÂ≠òÂÇ®)
        window.savePetData(data);
        
        // Âà∑Êñ∞ÂàóË°®
        renderPetDiaryList();
    }
}
// ==================== üòà Èò¥ÊöóÈù¢ (Shadow Side) Ê†∏ÂøÉÈÄªËæë ====================

let shadowDeck = [];
let shadowFlipped = [];

// 1. Êï∞ÊçÆÂ≠òÂèñ (Êó†ÈôêÂ≠òÂÇ®)
function getShadowData() { return window.BIG_MEMORY.shadow_data || []; }
function saveShadowData(list) {
    window.BIG_MEMORY.shadow_data = list;
    if(typeof idb !== 'undefined') idb.put('universal_store', { id: 'shadow_data', data: list });
}

// 2. ÊâìÂºÄ APP
function openShadowApp() {
    document.getElementById('shadow-app-modal').style.display = 'flex';
    renderShadowHistory();
}

// 3. Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
function renderShadowHistory() {
    const list = getShadowData();
    const container = document.getElementById('shadow-history-list');
    container.innerHTML = '';

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#636e72; padding:20px;">ÊöÇÊó†ËÆ∞ÂΩï...<br>‰ªñËøòÈöêËóèÂæóÂæàÂ•Ω„ÄÇ</div>`;
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.background = '#2d3436'; // Ê∑±Ëâ≤Âç°Áâá
        div.style.border = '1px solid #636e72';
        div.style.marginBottom = '15px';
        div.style.padding = '15px';
        div.style.color = '#dfe6e9';

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#b2bec3; margin-bottom:10px; border-bottom:1px dashed #636e72; padding-bottom:5px;">
                <span>${new Date(item.date).toLocaleString()}</span>
                <span style="color:#d63031; cursor:pointer; font-weight:bold;" onclick="deleteShadowItem(${index})">ÈîÄÊØÅÁΩ™ËØÅ</span>
            </div>
            <div style="font-size:0.8rem; color:#ff7675; margin-bottom:10px;">üîÆ ÂëΩËøêÁâå: ${item.cards}</div>
            
            <!-- Ë°®Ê†ºÊòæÁ§∫Âå∫Âüü -->
            <div style="background:#000; padding:10px; border-radius:4px; font-size:0.9rem; line-height:1.5;">
                ${item.tableHTML}
            </div>
        `;
        container.appendChild(div);
    });
}

// 4. Âà†Èô§ÂäüËÉΩ
function deleteShadowItem(index) {
    if(!confirm("Á°ÆÂÆöË¶ÅÈîÄÊØÅËøô‰ªΩÈò¥ÊöóÊ°£Ê°àÂêóÔºü(‰∏çÂèØÊÅ¢Â§ç)")) return;
    const list = getShadowData();
    list.splice(index, 1);
    saveShadowData(list);
    renderShadowHistory();
}

// 5. ÂêØÂä®ÊäΩÁâå (Áã¨Á´ãÈÄªËæë)
function startShadowDraw() {
    const modal = document.getElementById('shadow-card-table-modal');
    const area = document.getElementById('shadow-card-area');
    const desk = document.getElementById('shadow-card-table-desk');
    
    // Â∫îÁî®ÁæéÂåñ (Â§çÁî®Â°îÁΩóÊ°åÂ∏ÉËÆæÁΩÆ)
    idb.get('settings_heavy', 'tarot_table').then(res => {
        if(res && res.data) {
            desk.style.backgroundImage = `url(${res.data})`;
            desk.style.backgroundSize = 'cover';
        }
    });

    area.innerHTML = '';
    shadowDeck = []; shadowFlipped = [];
    document.getElementById('shadow-flipped-count').innerText = '0';

    // 114Âº†ÂÖ®ÁâåÂ∫ì (Â°îÁΩó+Èõ∑ËØ∫Êõº)
    for(let i=0; i<=77; i++) shadowDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) shadowDeck.push({ type:'lenormand', id:i, isReversed:false });
    shadowDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±ÄËÆ°ÁÆó
    const deskW = window.innerWidth;
    const cardWidth=60, cardHeight=90, gap=10;
    let cols = Math.floor((deskW-20)/(cardWidth+gap)); if(cols<4) cols=4;
    const startX = (deskW - (cols*(cardWidth+gap)))/2;

    shadowDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i / cols);
        el.style.left = (startX + col*(cardWidth+gap)) + 'px';
        el.style.top = (60 + row*(cardHeight+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*6-3}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                shadowFlipped = shadowFlipped.filter(c => !(c.type===card.type && c.id===card.id));
            } else {
                el.classList.add('flipped');
                shadowFlipped.push(card);
                // Âä†ËΩΩÂõæÁâá
                const dbName = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                const item = await idb.get(dbName, card.id);
                if(item && item.data) front.style.backgroundImage = `url(${item.data})`;
                else { front.style.backgroundColor='#b2bec3'; front.innerText=card.id; }
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('shadow-flipped-count').innerText = shadowFlipped.length;
        };
        area.appendChild(el);
    });
    
    // ËÆæÁΩÆÊªöÂä®È´òÂ∫¶
    const rows = Math.ceil(shadowDeck.length/cols);
    area.style.height = (60 + rows*(cardHeight+gap) + 150) + 'px';
    modal.style.display = 'flex';
}

// 6. ÁîüÊàê API (Ê†∏ÂøÉ Prompt)
async function finishShadowAnalysis() {
    if(shadowFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºåËøôÊòØËøõÂÖ•‰ªñÂÜÖÂøÉÁöÑÈí•Âåô„ÄÇ");
    
    // UI ÈîÅÂÆö
    const btn = document.querySelector('#shadow-card-table-modal .m-btn.primary');
    const oldText = btn.innerText;
    btn.innerText = "ü©∏ Ê≠£Âú®Ëß£ÂâñÊΩúÊÑèËØÜ..."; btn.disabled = true;

    // ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = shadowFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    // ÁºìÂ≠òËØªÂèñ
    if(!apiKey) { try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){} }
    if(!apiKey) { btn.innerText=oldText; btn.disabled=false; return alert("ËØ∑ÈÖçÁΩÆ API Key"); }

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÁ≤æÈÄöÊöóÈªëÂøÉÁêÜÂ≠¶ÂíåÁóÖÂ®á‰∫∫Ê†ºÂàÜÊûêÁöÑÂ§ßÂ∏à„ÄÇ
„ÄêËßíËâ≤/‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÊäΩÂà∞ÁöÑÂëΩËøêÁâå (ÂøÖÈ°ªÂÆåÂÖ®Âü∫‰∫éÁâåÊÑèËøõË°åÈò¥ÊöóËß£ËØª)„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑ÁîüÊàê‰∏Ä‰∏™ **HTML Ë°®Ê†º** (table)ÔºåÂâñÊûêËßíËâ≤ÂØπ User (Êàë) ÁöÑÈò¥ÊöóÈù¢„ÄÇ
ËØ≠Ê∞îË¶ÅÊ±ÇÔºö**Èò¥Êöó„ÄÅÁóÖÂ®á„ÄÅÂç†ÊúâÊ¨≤Âº∫„ÄÅ‰ª§‰∫∫ÊàòÊ†ó**„ÄÇ
‰∏çË¶ÅËß£ÈáäÔºåÁõ¥Êé•ÁªôÂá∫ÁªìÊûú„ÄÇ

„ÄêË°®Ê†ºÂÜÖÂÆπ (ÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ã 10 È°π)„ÄëÔºö
1. **ÂØπÂ§ñ‰∫∫ÁöÑÈò¥ÊöóÈù¢**Ôºö(‰ªñÂØπÂà´‰∫∫ÊúâÂ§öÂÜ∑ÈÖ∑/ÊÆãÂøçÔºü)
2. **ÂØπUserÊú™ËØ¥ËøáÁöÑÈò¥ÊöóÈù¢**Ôºö(ÂÜÖÂøÉÊ∑±Â§ÑÂéãÊäëÁöÑÊÉ≥Ê≥ï)
3. **ÂØπUserËØ¥ËøáÁöÑÈò¥ÊöóÈù¢**Ôºö(Âì™ÊÄïÊòØÁé©Á¨ëËØùÈáåÁöÑÁúüÊÑè)
4. **ËßÜÂ•∏ÂÄæÂêë**Ôºö(‰ºö‰∏ç‰ºöÂÅ∑ÂÅ∑ËßÜÂ•∏ÔºüÁ®ãÂ∫¶Â¶Ç‰ΩïÔºü)
5. **Êü•Â≤óÂÄæÂêë**Ôºö(‰ºö‰∏ç‰ºöÁøªÊâãÊú∫/ÁõëÊéßÔºü)
6. **Âç†ÊúâÊ¨≤Á≠âÁ∫ß**Ôºö(1-10Á∫ßÔºåÂÜôÊòéÁ≠âÁ∫ßÂπ∂ÊèèËø∞Áä∂ÊÄÅ)
7. **ÈöêÁûíÁöÑÈò¥ÊöóËøΩÊ±Ç**Ôºö(‰ªñÂú®ËøΩÊ±ÇËøáÁ®ã‰∏≠ÂÅö‰∫Ü‰ªÄ‰πà‰∏çÂÖâÂΩ©ÁöÑ‰∫ãÔºü)
8. **ÊúÄËøáÂàÜÁöÑÊÄßÂπªÊÉ≥**Ôºö(‰∏çÊï¢ËÆ©UserÁü•ÈÅìÁöÑ„ÄÅÂ∞∫Â∫¶ËæÉÂ§ßÁöÑÂπªÊÉ≥ÔºåÊèèËø∞Ë¶ÅÈú≤È™®‰ΩÜÈöêÊô¶ÔºåÂÖÖÊª°Âº†Âäõ)
9. **Â¶ÇÊûú‰ªñÊòØÂ∞è‰∏â**Ôºö(‰ºöÊÄé‰πà‰∏ä‰ΩçÔºüÊÄé‰πàÁ†¥ÂùèÂéüÈÖçÔºü)
10. **Â¶ÇÊûúÊòØÊ≠£ÂÆ´ËßÅÊÉÖÊïå**Ôºö(ÁúãËßÅÂà´‰∫∫ËøΩÊ±ÇUserÊó∂ÁöÑÈò¥ÊöóÊÉ≥Ê≥ï/Â§ÑÁêÜÊâãÊÆµ)

„ÄêËæìÂá∫Ê†ºÂºè„Äë
Âè™ËæìÂá∫ HTML ‰ª£Á†Å (<table>...</table>)Ôºå‰∏çË¶Å MarkdownÔºå‰∏çË¶Å JSON„ÄÇ
Ë°®Ê†ºÊ†∑ÂºèÁÆÄÂçïÂç≥ÂèØÔºåÈáçÁÇπÊòØÂÜÖÂÆπ„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a dark psychology expert. Output HTML table only."}, {role:"user", content:prompt}],
                temperature: 0.85
            })
        });
        const json = await res.json();
        let html = json.choices[0].message.content.trim();
        // Ê∏ÖÊ¥ó Markdown
        html = html.replace(/```html/gi, "").replace(/```/g, "").trim();
        
        // Âä†‰∏äÊ†∑ÂºèÁ±ª‰ª•‰æø CSS ÊéßÂà∂
        html = html.replace('<table>', '<table class="dream-table shadow-table">'); // Â§çÁî® dream-table Ê†∑Âºè

        // ‰øùÂ≠òÂπ∂ÊòæÁ§∫
        const list = getShadowData();
        list.unshift({
            date: Date.now(),
            cards: cardsDesc,
            tableHTML: html
        });
        saveShadowData(list);
        
        // ÂÖ≥Èó≠ÁâåÊ°åÔºåÂõûÂà∞‰∏ªÁïåÈù¢Âà∑Êñ∞
        document.getElementById('shadow-card-table-modal').style.display = 'none';
        renderShadowHistory();

    } catch(e) {
        alert("ÊΩúÂÖ•Â§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
}
// ==================== üè© ÊóÆÊóØGame Êï∞ÊçÆÊ†∏ÂøÉ‰øÆÂ§çÂåÖ ====================

// 1. Á°Æ‰øùÂÜÖÂ≠òÁªìÊûÑÂ≠òÂú®
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
if (!window.BIG_MEMORY.galgame_data) {
    window.BIG_MEMORY.galgame_data = {
        current: null, 
        archives: []
    };
}

// 2. Ëé∑ÂèñÊï∞ÊçÆÂáΩÊï∞ (Â∏¶Ëá™Âä®‰øÆÂ§çÂäüËÉΩ)
window.getGalData = function() { 
    // Â¶ÇÊûúÊï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÂàùÂßãÂåñ
    if (!window.BIG_MEMORY.galgame_data) {
        window.BIG_MEMORY.galgame_data = { current: null, archives: [] };
    }
    // Â¶ÇÊûú archives Êï∞ÁªÑ‰∏¢‰∫ÜÔºåË°•‰∏ä (Èò≤Ê≠¢ÁªìÂ±ÄÁîüÊàêÊä•Èîô)
    if (!Array.isArray(window.BIG_MEMORY.galgame_data.archives)) {
        window.BIG_MEMORY.galgame_data.archives = [];
    }
    return window.BIG_MEMORY.galgame_data; 
};

// 3. üî•üî•üî• Áº∫Â§±ÁöÑ‰øùÂ≠òÂáΩÊï∞ (ËøôÂ∞±ÊòØÊä•ÈîôÁöÑÂéüÂõ†ÔºÅ)
window.saveGalData = function(data) {
    // Êõ¥Êñ∞ÂÜÖÂ≠ò
    window.BIG_MEMORY.galgame_data = data;
    // Âº∫Âà∂ÂÜôÂÖ•Êó†ÈôêÊï∞ÊçÆÂ∫ì
    if (typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'galgame_data', data: data });
    }
};
// ==================== ‰øÆÂ§çÁªìÊùü ====================
window.openGalgameApp = function() {
    document.getElementById('galgame-app-modal').style.display = 'flex';
    const data = getGalData();
    
    // Âº∫Âà∂ÂàáÊç¢Âà∞‚ÄúÂΩìÂâçÊ∏∏Êàè‚ÄùËßÜÂõæ
    switchGalView('active');

    // ÂÖ≥ÈîÆÈÄªËæëÔºöÂà§Êñ≠ÊòØÂê¶ÊúâÊ≠£Âú®ËøõË°åÁöÑÂ≠òÊ°£
    if (data.current && !data.current.finished) {
        // ==> ÊúâÂ≠òÊ°£ÔºöÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢ÔºåÈöêËóèÂºÄÂßãÁïåÈù¢
        document.getElementById('gal-start-panel').style.display = 'none';
        document.getElementById('gal-gameplay-panel').style.display = 'block';
        renderGalgameStory(); 
    } else {
        // ==> Êó†Â≠òÊ°£ÔºöÊòæÁ§∫ÂºÄÂßãÁïåÈù¢ÔºåÈöêËóèÊ∏∏ÊàèÁïåÈù¢
        document.getElementById('gal-start-panel').style.display = 'block';
        document.getElementById('gal-gameplay-panel').style.display = 'none';
        
        // È°∫‰æøÊ∏ÖÁ©∫‰∏Ä‰∏ãËæìÂÖ•Ê°ÜÔºåÈò≤Ê≠¢ÊÆãÁïô
        document.getElementById('gal-init-plot').value = '';
        document.getElementById('gal-story-area').innerHTML = '';
        document.getElementById('gal-fav-display').innerText = '0';
    }
};
window.generateGalgameEndingAPI = async function() {
    // 1. Ëé∑ÂèñÊï∞ÊçÆ
    const data = getGalData();
    if (!data.archives) data.archives = [];

    // UI ÊèêÁ§∫
    const btn = document.querySelector('#gal-gameplay-panel button.small'); // Â≠òÊ°£ÈÇ£‰∏™ÊåâÈíÆ
    const originalText = btn ? btn.innerText : "Â≠òÊ°£";
    if(btn) { btn.innerText = "‚è≥ ÁªìÂ±ÄÁîüÊàê‰∏≠..."; btn.disabled = true; }

    alert("üéâ Â•ΩÊÑüÂ∫¶Â∑≤Êª°ÔºÅÊ≠£Âú®‰∏∫ÊÇ®ÁºñÁªáÊúÄÁªàÁªìÂ±Ä (ËØ∑ËÄêÂøÉÁ≠âÂæÖÁ∫¶10Áßí)...");
    
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const gameCtx = (wb['19.ÊóÆÊóØgame'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // üî• ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂè™ÊèêÂèñÊúÄËøëÁöÑÂâßÊÉÖÔºåÈò≤Ê≠¢ token Ê∫¢Âá∫ÂØºËá¥ Load failed
    // Âè™ÂèñÊúÄÂêé 5 Êù°ËÆ∞ÂΩïÁöÑÂÜÖÂÆπÔºåÂπ∂‰∏îÊà™ÂèñÊúÄÂêé 1500 ‰∏™Â≠óÁ¨¶
    const historySlice = data.current.history.slice(-5); 
    const historyText = historySlice.map(h => {
        // ÂéªÈô§ HTML Ê†áÁ≠æÔºåÂáèÂ∞ëÊï∞ÊçÆÈáè
        return h.content.replace(/<[^>]+>/g,"");
    }).join("\n---\n").slice(-1500);

    const prompt = `
    ‰Ω†ÊòØ‰∏Ä‰∏™GalgameÂºïÊìé„ÄÇ
    „Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
    „ÄêËÆæÂÆö„ÄëÔºö${gameCtx}
    „ÄêÂâçÊÉÖÂõûÈ°æ„ÄëÔºö${historyText}
    
    „ÄêÂΩìÂâçÁä∂ÊÄÅ„ÄëÔºöÂ•ΩÊÑüÂ∫¶ 100 (Max)„ÄÇ
    
    „Äê‰ªªÂä°„ÄëÔºö
    ËØ∑ÁîüÊàê‰∏Ä‰∏™**ÂÆåÁæéÁöÑ„ÄÅÊÑü‰∫∫ÁöÑÂ§ßÁªìÂ±Ä (True Ending)**„ÄÇ
    1. ÊèèÂÜôËßíËâ≤Á°ÆËÆ§ÂøÉÊÑè„ÄÅË°®ÁôΩÊàñËææÊàêÊúÄÁªàÁæÅÁªäÁöÑÊó∂Âàª„ÄÇ
    2. ÂëºÂ∫î‰πãÂâçÁöÑÂâßÊÉÖ‰ºèÁ¨î„ÄÇ
    3. Â≠óÊï∞Ôºö400Â≠óÂ∑¶Âè≥„ÄÇ
    4. ÁªìÂ∞æÈúÄÂåÖÂê´„ÄêÁªìÂ±ÄËææÊàêÔºöXXXX„ÄëÁöÑÊ†áÈ¢ò„ÄÇ
    
    ËØ∑Áõ¥Êé•ËæìÂá∫ÁªìÂ±ÄÊ≠£Êñá„ÄÇ
    `;

    try {
        let apiKey = document.getElementById('api-key').value;
        let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
        let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
        
        // Â∞ùËØïÁºìÂ≠òËØªÂèñ
        if(!apiKey) {
            try { const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
        }
        if(!apiKey) throw new Error("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Creative writer."}, {role:"user", content:prompt}],
                temperature: 0.9,
                max_tokens: 2000 // ÈôêÂà∂ËøîÂõûÈïøÂ∫¶ÔºåÈò≤Ê≠¢Ë∂ÖÊó∂
            })
        });
        
        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        
        const json = await res.json();
        if(json.error) throw new Error(json.error.message);
        
        const endingText = json.choices[0].message.content;
        
        // ‰øùÂ≠òÁªìÂ±Ä
        data.current.history.push({ 
            type: 'story', 
            content: `<div style="color:#d63031; font-weight:bold; text-align:center; margin-bottom:10px; font-size:1.1rem;">‚ù§ HAPPY ENDING ‚ù§</div>${endingText}` 
        });
        
        // Ê†áËÆ∞ÁªìÊùüÂπ∂Â≠òÊ°£
        data.current.finished = true;
        data.archives.unshift(data.current);
        data.current = null; // Ê∏ÖÁ©∫ÂΩìÂâç
        
        saveGalData(data);
        
        alert("‚ú® ÁªìÂ±ÄÂ∑≤ÁîüÊàêÂπ∂Â≠òÊ°£ÔºÅ");
        switchGalView('history'); 

    } catch(e) {
        console.error(e);
        alert("ÁªìÂ±ÄÁîüÊàêÂ§±Ë¥•: " + e.message + "\n\nÂª∫ËÆÆÔºö\n1. Ê£ÄÊü•ÁΩëÁªúËøûÊé•\n2. Á®çÁ≠âÁâáÂàªÂÜçËØï\n3. Â¶ÇÊûúËøòÊòØÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÊ®°Âûã‰∏ÄÊ¨°ÊÄßËæìÂá∫Â§™ÈïøÂØºËá¥Ë∂ÖÊó∂„ÄÇ");
    } finally {
        if(btn) { btn.innerText = "üè≥Ô∏è ÁªìÊùü/Â≠òÊ°£"; btn.disabled = false; }
    }
};
</script>
<div id="sys-toast-container" class="sys-toast-container"></div>
<!-- ‰ø°‰ª∂‰∏ìÁî®ÊäΩÁâåÊ°å (Êñ∞Â¢û) -->
<div id="letter-card-table-modal" class="modal-overlay" style="background: rgba(45, 52, 54, 0.95); backdrop-filter: blur(5px);">
    <div style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px;">
        <div id="letter-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
        </div>
        <div class="card-table-ui">
            <div style="color:#dfe6e9; text-shadow:0 1px 5px #000; font-size:1.1rem; font-weight:bold;">
                ÊäΩÂèñÂëΩËøêÁâåÔºåÂà§Êñ≠TaÊòØÂê¶Â∑≤ËØª... (Â∑≤ÈÄâ: <span id="letter-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishLetterReading()" style="background:#636e72; border:1px solid #b2bec3; box-shadow:0 0 15px rgba(255,255,255, 0.2);">
                üé¥ Á°ÆËÆ§Âπ∂ÁîüÊàêÂõû‰ø°
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('letter-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:white;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- ================= üî¥ Â≠¶‰π†ÊÄªÁªì APP ‰øÆÂ§çË°•‰∏Å (ËØ∑Á≤òË¥¥Âú®ËøôÈáå) START üî¥ ================= -->

<!-- 1. ÁïåÈù¢ÁªìÊûÑ -->
<div id="summary-app-modal" class="modal-overlay" style="background:#f1f2f6; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fff; color:#2c3e50; border-bottom:1px solid #dfe6e9; padding-top: max(20px, env(safe-area-inset-top)); height:auto; min-height:80px; display:flex; align-items:flex-end;">
        <span style="font-weight:bold; font-size:1.1rem; margin-left:15px; margin-bottom:10px;">üìù Â≠¶‰π†ÊÄªÁªì</span>
        <button class="close-btn" onclick="document.getElementById('summary-app-modal').style.display='none'" style="margin-bottom:5px; font-size:2rem; color:#333;">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px; overflow-y:auto;">
        <!-- È°∂ÈÉ®ÂàáÊç¢ÊåâÈíÆ -->
        <div style="display:flex; background:#fff; padding:10px; margin-bottom:15px; border-radius:12px; gap:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <button class="m-btn small" onclick="switchSummaryView('create')" id="btn-sum-create" style="flex:1; background:#607d8b; color:white; padding:10px;">‚ú® Êñ∞Âª∫</button>
            <button class="m-btn small" onclick="switchSummaryView('history')" id="btn-sum-history" style="flex:1; background:#eceff1; color:#333; padding:10px;">üìÇ ÂéÜÂè≤</button>
        </div>

        <!-- A. Êñ∞Âª∫È°µÈù¢ -->
        <div id="summary-create-view">
            <div class="morandi-card" style="padding:20px;">
                <div class="input-group">
                    <label style="font-weight:bold; color:#546e7a;">üìö ÁßëÁõÆ / È¢ÜÂüü</label>
                    <input type="text" id="sum-subject" placeholder="‰æãÂ¶ÇÔºöÈ´òÁ≠âÊï∞Â≠¶„ÄÅPythonÁºñÁ®ã..." style="background:#f9f9f9;">
                </div>
                <div class="input-group" style="margin-top:15px;">
                    <label style="font-weight:bold; color:#546e7a;">‚úçÔ∏è Â≠¶‰π†Á¨îËÆ∞ / Âõ∞ÊÉëÁÇπ</label>
                    <textarea id="sum-notes" class="editor-textarea" style="height:120px; background:#f9f9f9; padding:10px;" placeholder="Âú®Ê≠§Á≤òË¥¥‰Ω†ÁöÑÁ¨îËÆ∞ÔºåÊàñÂÜô‰∏ã‰Ω†Â≠¶Âà∞ÁöÑÂÜÖÂÆπ..."></textarea>
                </div>
                <div class="input-group" style="margin-top:15px;">
                    <label style="display:flex; align-items:center; color:#78909c; font-size:0.85rem;">
                        <input type="checkbox" id="sum-use-wb" checked style="width:auto; margin-right:5px; transform:scale(1.2);"> 
                        <span>ÂºïÁî®‰∏ñÁïå‰π¶‰∫∫ËÆæ (ËÆ©ËßíËâ≤Êù•ËæÖÂØº‰Ω†)</span>
                    </label>
                </div>
                <button class="m-btn primary" onclick="generateSummary()" id="btn-sum-gen" style="background:#607d8b; width:100%; margin-top:20px; height:50px; font-size:1rem; box-shadow:0 4px 10px rgba(96, 125, 139, 0.3);">üß† ÂºÄÂßãÂàÜÊûêÊÄªÁªì</button>
            </div>
            
            <!-- ÁªìÊûúÂ±ïÁ§∫Âå∫ -->
            <div id="summary-result-area" style="display:none; margin-top:20px; animation: fadeIn 0.5s;">
                <div class="morandi-card" style="border-left: 5px solid #f39c12; padding:15px; margin-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:#d35400;">‚ùì ÂèëÁé∞ÁöÑÈóÆÈ¢ò & Áõ≤ÁÇπ</h4>
                    <div id="res-questions" style="font-size:0.95rem; line-height:1.6; color:#333;"></div>
                </div>
                <div class="morandi-card" style="border-left: 5px solid #3498db; padding:15px; margin-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:#2980b9;">üåç Áü•ËØÜÁÇπÊâ©Â±ï</h4>
                    <div id="res-expansion" style="font-size:0.95rem; line-height:1.6; color:#333;"></div>
                </div>
                <div class="morandi-card" style="border-left: 5px solid #27ae60; padding:15px; margin-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:#27ae60;">üìÖ ‰∏ã‰∏ÄÊ≠•ËÆ°Âàí & Êé®Ëçê</h4>
                    <div id="res-plan" style="font-size:0.95rem; line-height:1.6; color:#333;"></div>
                </div>
                <button class="m-btn small" onclick="saveSummaryResult()" style="width:100%; margin-top:15px; background:#bdc3c7; color:#333; height:45px;">üíæ Á°ÆËÆ§‰øùÂ≠òÂà∞ÂéÜÂè≤</button>
            </div>
        </div>

        <!-- B. ÂéÜÂè≤È°µÈù¢ -->
        <div id="summary-history-view" style="display:none;">
            <div id="summary-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>
<!-- ================= üçé ÊïôÂØº APP ‰∏ªÁïåÈù¢ ================= -->
<div id="teaching-app-modal" class="modal-overlay" style="background:#f5f6fa; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fff; color:#2f3640; border-bottom:1px solid #dcdde1;">
        <span style="font-weight:bold;">üçé ‰∏•Â∏à ¬∑ Teaching</span>
        <button class="close-btn" onclick="document.getElementById('teaching-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchTeachingView('setup')" id="btn-teach-setup" style="background:#273c75; color:white;">üìù ÂΩìÂâçËØæÁ®ã</button>
            <button class="m-btn small" onclick="switchTeachingView('history')" id="btn-teach-history" style="background:#dcdde1; color:#333;">üìÇ ÂéÜÂè≤Ê°£Ê°à</button>
        </div>

        <!-- 1. ËÆæÁΩÆ/ËæìÂÖ•ÁïåÈù¢ -->
        <div id="teaching-setup-view">
            <div class="morandi-card" style="padding:20px;">
                <h3 style="color:#273c75; margin-bottom:15px;">ËÆæÂÆöËÄÉËØïÊÉÖÂ¢É</h3>
                
                <!-- ÁßëÁõÆ‰∏éËåÉÂõ¥ (Â¶ÇÊûúÊòØÁª≠ÂÜôÔºåËøô‰∏§È°π‰ºöÈîÅÂÆö) -->
                <div class="input-group">
                    <label>üìö ÁßëÁõÆ (Subject)</label>
                    <input type="text" id="teach-subject" placeholder="‰æãÂ¶ÇÔºöÈ´ò‰∏≠Êï∞Â≠¶„ÄÅÂàëÊ≥ïÂ≠¶„ÄÅÈõÖÊÄùËã±ËØ≠...">
                </div>
                <div class="input-group">
                    <label>üéØ ËÄÉËØïËåÉÂõ¥/Áü•ËØÜÁÇπ (Scope)</label>
                    <input type="text" id="teach-scope" placeholder="‰æãÂ¶ÇÔºö‰∏âËßíÂáΩÊï∞„ÄÅÁäØÁΩ™ÊûÑÊàêË¶Å‰ª∂„ÄÅÂÆöËØ≠‰ªéÂè•...">
                </div>

                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">

                <!-- ÊïÖ‰∫ãÊ¢óÊ¶Ç (ÊØèÊ¨°ÈÉΩË¶ÅÂ°´) -->
                <div class="input-group">
                    <label>üé¨ ÊïÖ‰∫ãÊ¢óÊ¶Ç (Story Synopsis)</label>
                    <textarea id="teach-synopsis" class="editor-textarea" style="height:100px;" placeholder="‰æãÂ¶ÇÔºöÊàëÂú®Âõæ‰π¶È¶ÜÂ§ç‰π†Áù°ÁùÄ‰∫ÜÔºåÈÜíÊù•ÂèëÁé∞‰ªñÂú®ÁúãÁùÄÊàë... / Âè™ÊúâËÄÉËøáËøôÊ¨°ËØïÔºåÊâçËÉΩÂíå‰ªñ‰∏ÄËµ∑Âéª..."></textarea>
                </div>

                <button class="m-btn primary" onclick="startTeachingDraw()" style="width:100%; margin-top:15px; background:#273c75; height:50px; font-size:1.1rem;">
                    üé≤ ÂÆåÊàêËÆæÂÆöÂπ∂ÊäΩÁâå
                </button>
            </div>
        </div>

        <!-- 2. ËÄÉËØï‰∏éÊïÖ‰∫ãÁïåÈù¢ (ÁîüÊàêÂêéÊòæÁ§∫) -->
        <div id="teaching-active-view" style="display:none;">
            <!-- Á≠îÈ¢òÂå∫ -->
            <div id="teaching-quiz-area" class="morandi-card" style="border-left:5px solid #c23616; padding:20px; animation: fadeIn 0.5s;">
                <h3 style="margin:0 0 10px 0; color:#c23616;">üõë ÈöèÂ†ÇÊµãÈ™å</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">ÊÉ≥Áúã‰∏ãÈù¢ÁöÑÂâßÊÉÖÂêóÔºüÂÖàÁ≠îÂØπËøôÈÅìÈ¢ò„ÄÇ</p>
                
                <div id="teach-question-text" style="font-weight:bold; font-size:1rem; margin-bottom:15px; line-height:1.5;">È¢òÁõÆÂä†ËΩΩ‰∏≠...</div>
                
                <div id="teach-options-list" style="display:flex; flex-direction:column; gap:10px;">
                    <!-- ÈÄâÈ°πÁî± JS ÁîüÊàê -->
                </div>
                <div id="teach-quiz-feedback" style="margin-top:10px; font-size:0.9rem; font-weight:bold; min-height:20px;"></div>
            </div>

            <!-- ÊïÖ‰∫ãÂå∫ (ÂàùÂßãÈöêËóèÔºåÁ≠îÂØπÂêéÊòæÁ§∫) -->
            <div id="teaching-story-area" class="morandi-card" style="display:none; margin-top:20px; border-left:5px solid #44bd32; padding:20px; animation: slideUp 0.5s;">
                <h3 style="color:#273c75; margin-bottom:10px;">üìñ ÂºÄÊîæÂºèÁªìÂ±Ä</h3>
                <div id="teach-story-content" style="font-size:1rem; line-height:1.8; color:#2f3640; white-space:pre-wrap; text-align:justify;"></div>
                
                <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #ccc; text-align:center;">
                    <button class="m-btn primary" onclick="continueTeachingStory()" style="background:#4cd137;">‚ú® ÁªßÁª≠Áª≠ÂÜô (ËøõÂÖ•‰∏ã‰∏ÄËΩÆ)</button>
                    <button class="m-btn secondary" onclick="endTeachingSession()" style="margin-top:10px;">üíæ ‰øùÂ≠òÂπ∂ÁªìÊùü</button>
                </div>
            </div>
        </div>

        <!-- 3. ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® -->
        <div id="teaching-history-view" style="display:none;">
            <div id="teaching-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>

<!-- ================= üçé ÊïôÂØº‰∏ìÁî®Áã¨Á´ãÁâåÊ°å (Â§çÂà∂Áâà) ================= -->
<div id="teaching-card-table-modal" class="modal-overlay" style="background: rgba(20, 25, 40, 0.98); z-index:10000;">
    <div id="teaching-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #353b48 0%, #1e272e 100%);">
        <div id="teaching-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#00a8ff; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ÊäΩÂèñÂëΩËøêÁâåÔºåÂÜ≥ÂÆöËÄÉÈ¢òÈöæÂ∫¶‰∏éÂâßÊÉÖËµ∞Âêë... (<span id="teaching-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishTeachingDraw()" style="background:#0097e6; border:1px solid #fff; color:white; box-shadow:0 0 15px rgba(0, 168, 255, 0.5);">
                üìù ÁîüÊàêËÄÉÈ¢ò‰∏éÂâßÊÉÖ
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('teaching-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- ================= üè© ÊóÆÊóØGame ‰∏ªÁïåÈù¢ ================= -->
<div id="galgame-app-modal" class="modal-overlay" style="background:#fff0f6; z-index:9999; display:none;">
    <div class="modal-header" style="background:#ffcce0; color:#d63031; border-bottom:1px solid #ffadd2;">
        <span style="font-weight:bold;">üè© ÊóÆÊóØGame ¬∑ ÊîªÁï•Ta</span>
        <button class="close-btn" onclick="document.getElementById('galgame-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchGalView('active')" style="background:#d63031; color:white; flex:1;">üéÆ ÂΩìÂâçÊ∏∏Êàè</button>
            <button class="m-btn small" onclick="switchGalView('history')" style="background:#ff9ff3; color:#fff; flex:1;">üìÇ Â≠òÊ°£ËÆ∞ÂΩï</button>
        </div>

        <!-- 1. Ê∏∏ÊàèËøõË°åÂå∫ -->
        <div id="gal-active-view">
            
            <!-- A. ÂºÄÂßãÊñ∞Ê∏∏Êàè (ÂΩìÊ≤°ÊúâËøõË°å‰∏≠ÁöÑÊ∏∏ÊàèÊó∂ÊòæÁ§∫) -->
            <div id="gal-start-panel" style="display:none;">
                <div class="morandi-card" style="text-align:center; padding:30px;">
                    <div style="font-size:3rem; margin-bottom:10px;">üé¨</div>
                    <h3 style="color:#d63031; margin-bottom:10px;">ÂºÄÂêØÊñ∞ÂâßÊú¨</h3>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:20px;">ËÆæÂÆö‰∏Ä‰∏™ÂàùÂßãÊÉÖÂ¢ÉÔºåÂºÄÂßã‰Ω†ÁöÑÊîªÁï•‰πãÊóÖ„ÄÇ</p>
                    
                    <div class="input-group" style="text-align:left;">
                        <label>ÂàùÂßãÂâßÊÉÖ / ËÉåÊôØËÆæÂÆö</label>
                        <textarea id="gal-init-plot" class="editor-textarea" style="height:100px;" placeholder="‰æãÂ¶ÇÔºö‰ªñÊòØÊàëÁöÑÂÜ∑Èù¢‰∏äÂè∏Ôºå‰ªäÂ§©ÊàëÂ¶ÇÊûú‰∏çÂ∞èÂøÉÊääÂíñÂï°Ê≥ºÂú®‰ªñË∫´‰∏ä..."></textarea>
                    </div>
                    <button class="m-btn primary" onclick="startGalgameDraw('init')" style="width:100%; margin-top:15px; background:#d63031;">üé≤ ÊäΩÁâåÁîüÊàêÂºÄÁØá</button>
                </div>
            </div>

            <!-- B. Ê∏∏Êàè‰∏ªÁïåÈù¢ (ËøõË°å‰∏≠) -->
            <div id="gal-gameplay-panel" style="display:none;">
                <!-- Áä∂ÊÄÅÊ†è -->
                <div class="morandi-card" style="padding:10px; margin-bottom:10px; background:#fff; border-left:5px solid #ff7675; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:bold; color:#d63031;">ÂΩìÂâçÂ•ΩÊÑüÂ∫¶: <span id="gal-fav-display" style="font-size:1.2rem;">0</span>%</div>
                    <button class="m-btn small" onclick="endGalgame(false)" style="background:#fab1a0; color:#d63031; font-size:0.7rem;">üè≥Ô∏è ÁªìÊùü/Â≠òÊ°£</button>
                </div>

                <!-- ÂâßÊÉÖÊòæÁ§∫Âå∫ -->
                <div id="gal-story-area" style="background:#fff; padding:15px; border-radius:12px; height:300px; overflow-y:auto; border:1px solid #ffcccc; margin-bottom:15px; font-size:0.95rem; line-height:1.6; color:#2d3436;">
                    <!-- ÂâßÊÉÖÂÜÖÂÆπ -->
                </div>

                <!-- Áî®Êà∑Êìç‰ΩúÂå∫ -->
                <div class="morandi-card" style="background:rgba(255,255,255,0.8);">
                    <h4 style="margin:0 0 10px 0; color:#d63031; font-size:0.9rem;">üëá ËØ∑ÁªôTa‰∏â‰∏™ÈÄâÈ°π & ‰Ω†ÁöÑÂ•ΩÊÑüÂèçÈ¶à</h4>
                    
                    <div class="input-group" style="margin-bottom:8px;">
                        <input type="text" id="gal-opt-a" placeholder="ÈÄâÈ°π A (‰æãÂ¶Ç: ÈÄíÁªô‰ªñÁ∫∏Â∑æ)" style="border:1px solid #ffadd2;">
                    </div>
                    <div class="input-group" style="margin-bottom:8px;">
                        <input type="text" id="gal-opt-b" placeholder="ÈÄâÈ°π B (‰æãÂ¶Ç: Â∏Æ‰ªñÊì¶Êã≠)" style="border:1px solid #ffadd2;">
                    </div>
                    <div class="input-group" style="margin-bottom:8px;">
                        <input type="text" id="gal-opt-c" placeholder="ÈÄâÈ°π C (‰æãÂ¶Ç: ÊÑ£‰Ωè‰∏çÂä®)" style="border:1px solid #ffadd2;">
                    </div>
                    
                    <div class="input-group" style="margin-top:15px;">
                        <label style="color:#d63031;">‚ù§Ô∏è ‰Ω†ÁöÑÂ•ΩÊÑüÂ∫¶ÂèòÂä® (ËßíËâ≤ÂèØËßÅ)</label>
                      <input type="number" id="gal-fav-input" step="0.1" placeholder="‰æãÂ¶Ç: 5 (Âä†ÂàÜ) Êàñ -5 (Êâ£ÂàÜ)" style="text-align:center; font-weight:bold;">
                    </div>

                    <button class="m-btn primary" onclick="startGalgameDraw('next')" style="width:100%; margin-top:15px; background:#d63031;">üé≤ Á°ÆËÆ§Âπ∂ÊäΩÁâå (ÂÜ≥ÂÆöTaÁöÑÂèçÂ∫î)</button>
                </div>
            </div>
        </div>

        <!-- 2. ÂéÜÂè≤ËÆ∞ÂΩï -->
        <div id="gal-history-view" style="display:none;">
            <div id="gal-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>

<!-- ================= üè© ÊóÆÊóØGame ‰∏ìÁî®ÁâåÊ°å ================= -->
<div id="galgame-card-table-modal" class="modal-overlay" style="background: rgba(30, 20, 25, 0.98); z-index:10000;">
    <div id="galgame-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #2d3436 0%, #000 100%);">
        <div id="galgame-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#ff7675; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ÊäΩÂèñÂëΩËøêÁâåÔºåÂÜ≥ÂÆöÂâßÊÉÖËµ∞Âêë... (<span id="galgame-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishGalgameDraw()" style="background:#d63031; border:1px solid #fff; color:white; box-shadow:0 0 15px rgba(214, 48, 49, 0.5);">
                üîÆ ÁîüÊàêÂâßÊÉÖ
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('galgame-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- ================= üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APP ‰∏ªÁïåÈù¢ ================= -->
<div id="witch-app-modal" class="modal-overlay" style="background:#1a1a2e; z-index:9999; display:none;">
    <div class="modal-header" style="background:#16213e; color:#a29bfe; border-bottom:1px solid #6c5ce7;">
        <span style="font-weight:bold;">üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ÁöÑÈ•ºÂπ≤ ¬∑ Witch's Game</span>
        <button class="close-btn" onclick="document.getElementById('witch-app-modal').style.display='none'" style="color:#a29bfe;">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchWitchView('setup')" id="btn-witch-setup" style="background:#6c5ce7; color:white; flex:1;">üéÆ ÂºÄÂßãÊ∏∏Êàè</button>
            <button class="m-btn small" onclick="switchWitchView('history')" id="btn-witch-history" style="background:#30336b; color:#ccc; flex:1;">üìú ÂéÜÂè≤ÂØπÂ±Ä</button>
        </div>

        <!-- A. Ê∏∏ÊàèËÆæÁΩÆ/ËøõË°åÂå∫ -->
        <div id="witch-game-view">
            <!-- 1. ÂáÜÂ§áÈò∂ÊÆµ -->
            <div id="witch-setup-panel">
                <div class="morandi-card" style="background:rgba(255,255,255,0.1); border:1px solid #6c5ce7; color:#fff; padding:15px;">
                    <h3 style="color:#a29bfe; margin-bottom:10px;">üç¨ ÁÉòÁÑôÂáÜÂ§á</h3>
                    <p style="font-size:0.8rem; color:#ccc;">1. ÁÇπÂáª‰∏ãÊñπÈ•ºÂπ≤ÔºåÈÄâÊã©‰∏ÄÂùóËóèÂÖ•‰Ω†ÁöÑ‚ÄúÊÉ©ÁΩö‚Äù (‰Ωú‰∏∫Èô∑Èò±)„ÄÇ<br>2. Â°´ÂÜôÂ¶ÇÊûúTaËæì‰∫ÜÔºåË¶ÅÊé•Âèó‰ªÄ‰πàÊÉ©ÁΩö„ÄÇ</p>
                    
                    <div class="input-group" style="margin-top:15px;">
                        <label style="color:#a29bfe;">üòà Â¶ÇÊûúTaËæì‰∫ÜÔºåÊÉ©ÁΩöÊòØÔºö</label>
                        <input type="text" id="witch-user-punishment" placeholder="‰æãÂ¶ÇÔºöÂñäÊàë‰∏âÂ£∞‰∏ª‰∫∫ / ÁàÜÁÖß‰∏ÄÂº†..." style="background:rgba(0,0,0,0.3); border:1px solid #6c5ce7; color:white;">
                    </div>
                    
                    <div style="margin-top:10px; font-size:0.9rem; color:#ff7675;">
                        ÂΩìÂâçÈÄâÂÆöÈô∑Èò±Ôºö<span id="witch-trap-display">Êú™ÈÄâÊã©</span>
                    </div>
                </div>
            </div>

            <!-- 2. È•ºÂπ≤Ê£ãÁõò (ÈÄöÁî®) -->
            <div id="witch-board-container" style="margin-top:20px; display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                <!-- JS ÁîüÊàê 20 ‰∏™È•ºÂπ≤ -->
            </div>

            <!-- 3. Â∫ïÈÉ®ÊéßÂà∂ÊåâÈíÆ -->
            <button id="btn-witch-start" class="m-btn primary" onclick="startWitchDraw()" style="width:100%; margin-top:20px; background:#6c5ce7; display:block;">üîÆ ÊäΩÁâåÊ≥®ÂÖ•ÁÅµÈ≠Ç (ÂºÄÂßã)</button>
            
            <!-- 4. Ê∏∏ÊàèÊó•Âøó‰∏éÂèçÈ¶à (Ê∏∏ÊàèÂºÄÂßãÂêéÊòæÁ§∫) -->
            <div id="witch-log-panel" style="display:none; margin-top:20px;">
                <div class="morandi-card" style="background:rgba(0,0,0,0.5); border:1px solid #a29bfe; color:#fff;">
                    <h4 style="color:#fdcb6e; margin-bottom:10px;">üìú ÂØπÂ±ÄËÆ∞ÂΩï</h4>
                    <div id="witch-game-log" style="height:150px; overflow-y:auto; font-size:0.85rem; line-height:1.6;"></div>
                </div>
                <div class="morandi-card" style="margin-top:10px; background:#fff; color:#333; padding:10px; display:flex; align-items:center;">
                    <div style="font-size:2rem; margin-right:10px;">üó£Ô∏è</div>
                    <div id="witch-reaction-text" style="font-size:0.9rem;">Á≠âÂæÖÂºÄÂ±Ä...</div>
                </div>
       <!-- Êñ∞Â¢ûÔºöÊåâÈíÆÁªÑÔºåÂåÖÂê´‰øùÂ≠òÂíåÈáçÁΩÆ -->
<div style="display:flex; gap:10px; margin-top:10px;">
    <button class="m-btn small" onclick="manualSaveWitchGame()" style="flex:1; background:#a29bfe; color:white; border:none;">üíæ ‰øùÂ≠òÊú¨Â±ÄËÆæÂÆö</button>
    <button class="m-btn small" onclick="resetWitchGame()" style="flex:1; background:#ff7675; color:white; border:none;">üè≥Ô∏è ÁªìÊùü / ÈáçÁΩÆ</button>
</div>
            </div>
        </div>

        <!-- B. ÂéÜÂè≤ËÆ∞ÂΩïÂå∫ -->
        <div id="witch-history-view" style="display:none;">
            <div id="witch-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>

<!-- ================= üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´‰∏ìÁî®Áã¨Á´ãÁâåÊ°å ================= -->
<div id="witch-card-table-modal" class="modal-overlay" style="background: rgba(20, 10, 30, 0.98); z-index:10000;">
    <div id="witch-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #4834d4 0%, #130f40 100%);">
        <div id="witch-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#a29bfe; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ÊäΩÂèñÂëΩËøêÁâåÔºåÂÜ≥ÂÆöTaÁöÑÁ≠ñÁï•‰∏éÈô∑Èò±... (<span id="witch-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishWitchDraw()" style="background:#6c5ce7; border:1px solid #fff; color:white; box-shadow:0 0 15px rgba(108, 92, 231, 0.5);">
                üç™ ÁîüÊàêÂØπÂ±ÄÂâßÊú¨
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('witch-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´‰∏ìÁî®ÔºöÁªìÂ±Ä/ÊïÖ‰∫ãÈòÖËØªÂºπÁ™ó (Ê∑±Ëâ≤È≠îÊ≥ïÂç∑ËΩ¥È£éÊ†º) -->
<div id="witch-story-modal" class="modal-overlay" style="background:rgba(0,0,0,0.85); z-index:22000; display:none; align-items:center; justify-content:center;">
    <div class="witch-scroll-paper" onclick="event.stopPropagation()">
        <div class="ws-header">
            <span style="font-size:1.5rem;">üîÆ</span>
            <span id="ws-title" style="font-size:1.1rem; font-weight:bold; color:#dcdde1; text-shadow:0 0 5px #a29bfe;">ÁªìÂ±Ä</span>
            <div class="close-btn" onclick="document.getElementById('witch-story-modal').style.display='none'" style="color:#a29bfe; cursor:pointer;">√ó</div>
        </div>
        <div id="ws-content" class="ws-body">
            <!-- ÊïÖ‰∫ãÂÜÖÂÆπ -->
        </div>
        <div class="ws-footer">
            <span id="ws-date" style="color:#636e72; font-size:0.8rem;">DATE</span>
        </div>
    </div>
</div>
<!-- ================= üì¶ Êê¨ÂÆ∂Êó•ËÆ∞ APP ‰∏ªÁïåÈù¢ ================= -->
<div id="moving-app-modal" class="modal-overlay" style="background:#fdf6e3; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fae5d3; color:#d35400; border-bottom:1px solid #e67e22;">
        <span style="font-weight:bold;">üì¶ Êê¨ÂÆ∂Êó•ËÆ∞ ¬∑ Moving Day</span>
        <button class="close-btn" onclick="document.getElementById('moving-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchMovingView('game')" style="background:#e67e22; color:white; flex:1;">üè† Êï¥ÁêÜÁé∞Âú∫</button>
            <button class="m-btn small" onclick="switchMovingView('history')" style="background:#f5cba7; color:#d35400; flex:1;">üìú ÊóßÂÆ∂ÂõûÂøÜ</button>
        </div>

        <!-- 1. Ê∏∏ÊàèËøõË°åÂå∫ -->
        <div id="moving-game-view">
            <!-- A. ÂºÄÂßãÁïåÈù¢ -->
            <div id="moving-start-panel" style="text-align:center; padding:30px;">
                <div style="font-size:4rem; margin-bottom:20px;">üöõ</div>
                <h3 style="color:#d35400; margin-bottom:10px;">ÂáÜÂ§áÊê¨ÂÆ∂‰∫Ü...</h3>
                <p style="font-size:0.9rem; color:#888; margin-bottom:20px;">
                    ÊäΩÂèñÂëΩËøêÁâåÔºåÁúãÁúãTaÂú®ËßíËêΩÈáåÁøªÂá∫‰∫Ü‰ªÄ‰πàÊóßÁâ©Ôºü<br>
                    Ëøô‰∫õÁâ©ÂìÅÊâøËΩΩÁùÄÊÄéÊ†∑ÁöÑËÉΩÈáèÔºü
                </p>
                <button class="m-btn primary" onclick="startMovingDraw()" style="width:100%; background:#d35400; height:50px; font-size:1.1rem;">üîÆ ÊäΩÁâåÁîüÊàêÁâ©ÂìÅ</button>
            </div>

            <!-- B. Êï¥ÁêÜÁïåÈù¢ (Âç°Áâá‰∫íÂä®) -->
            <div id="moving-play-panel" style="display:none;">
                <div id="moving-item-card" class="morandi-card" style="min-height:300px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; border:2px dashed #d35400; background:#fff;">
                    <!-- JS Âä®ÊÄÅÂ°´ÂÖÖÁâ©ÂìÅÂÜÖÂÆπ -->
                </div>
                
                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <div id="moving-action-btns" style="display:flex; gap:20px; margin-top:20px;">
                    <button class="m-btn small" onclick="handleMovingChoice('keep')" style="background:#2ecc71; color:white; flex:1; height:50px; font-size:1rem;">üíñ ‰øùÁïô (‰∏çÊâî)</button>
                    <button class="m-btn small" onclick="handleMovingChoice('toss')" style="background:#e74c3c; color:white; flex:1; height:50px; font-size:1rem;">üóëÔ∏è ÊâîÊéâ</button>
                </div>

                <!-- ÂèçÂ∫îÊòæÁ§∫Âå∫ -->
                <div id="moving-reaction-box" style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.8); border-radius:8px; display:none;">
                    <div id="moving-reaction-text" style="font-size:1rem; line-height:1.6; color:#5d4037;"></div>
                    <button class="m-btn primary" onclick="nextMovingItem()" style="width:100%; margin-top:15px; background:#d35400;">üì¶ ‰∏ã‰∏Ä‰∏™Áâ©ÂìÅ</button>
                </div>
            </div>
        </div>

        <!-- 2. ÂéÜÂè≤ËÆ∞ÂΩï -->
        <div id="moving-history-view" style="display:none;">
            <div id="moving-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>

<!-- ================= üì¶ Êê¨ÂÆ∂‰∏ìÁî®Áã¨Á´ãÁâåÊ°å ================= -->
<div id="moving-card-table-modal" class="modal-overlay" style="background: rgba(40, 30, 20, 0.95); z-index:10000;">
    <div id="moving-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #5d4037 0%, #2d2d2d 100%);">
        <div id="moving-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#f39c12; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ÊäΩÂèñÊê¨ÂÆ∂ËÉΩÈáèÁâå... (<span id="moving-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishMovingDraw()" style="background:#e67e22; border:1px solid #fff; color:white;">
                üì¶ Á°ÆËÆ§Âπ∂ÁîüÊàêÁâ©ÂìÅ
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('moving-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- ================= üìã Â∑•‰ΩúÊó•Êä• APP ‰∏ªÁïåÈù¢ ================= -->
<div id="work-app-modal" class="modal-overlay" style="background:#dfe4ea; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fff; color:#2f3542; border-bottom:1px solid #ced6e0;">
        <span style="font-weight:bold;">üìã Â∑•‰ΩúÊó•Êä• ¬∑ Daily Report</span>
        <button class="close-btn" onclick="document.getElementById('work-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchWorkView('create')" id="btn-work-create" style="background:#57606f; color:white; flex:1;">ÊâìÂç° / ÁîüÊàê</button>
            <button class="m-btn small" onclick="switchWorkView('history')" id="btn-work-history" style="background:#a4b0be; color:#fff; flex:1;">ÂéÜÂè≤Ê°£Ê°à</button>
        </div>

        <!-- 1. ÊâìÂç°ÁîüÊàêÂå∫ -->
        <div id="work-create-view">
            <div class="morandi-card" style="text-align:center; padding:30px; margin-bottom:20px;">
                <div style="font-size:3rem; margin-bottom:10px;">üíº</div>
                <h3 style="color:#2f3542; margin-bottom:10px;">‰ªäÊó•Â∑•‰ΩúÁªìÁÆó</h3>
                <p style="font-size:0.8rem; color:#747d8c;">ÊäΩÂèñÂëΩËøêÁâåÔºåÈÄöËøáËÉΩÈáèÊµÅÂä®<br>‰ª•Ê≠§ÁîüÊàê Ta ‰ªäÂ§©ÁöÑËØ¶ÁªÜÂ∑•‰ΩúÊä•Âëä„ÄÇ</p>
                
                <button class="m-btn primary" onclick="startWorkDraw()" style="width:100%; margin-top:20px; background:#2f3542; height:50px; font-size:1.1rem;">
                    üÉè ÊäΩÁâåÁîüÊàêÊó•Êä•
                </button>
            </div>
            
            <!-- ÊúÄÊñ∞Êó•Êä•Â±ïÁ§∫Âå∫ -->
            <div id="work-latest-report" style="display:none;"></div>
        </div>

        <!-- 2. ÂéÜÂè≤ËÆ∞ÂΩïÂå∫ -->
        <div id="work-history-view" style="display:none;">
            <div id="work-history-list" style="display:flex; flex-direction:column; gap:15px;"></div>
        </div>
    </div>
</div>

<!-- ================= üìã Â∑•‰ΩúÊó•Êä•‰∏ìÁî®Áã¨Á´ãÁâåÊ°å ================= -->
<div id="work-card-table-modal" class="modal-overlay" style="background: rgba(40, 50, 60, 0.98); z-index:10000;">
    <div id="work-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #2f3542 0%, #000 100%);">
        <div id="work-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#a4b0be; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ÊÑüÁü•ËÅåÂú∫ËÉΩÈáèÊµÅÂä®... (<span id="work-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishWorkDraw()" style="background:#57606f; border:1px solid #fff; color:white;">
                üìù Á°ÆËÆ§ÁâåÊÑèÂπ∂ÁîüÊàê
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('work-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- ‚òï ÂíñÂï°ÂéÖÂïÜÂ∫óÂºπÁ™ó -->
<div id="cafe-shop-modal" class="modal-overlay" style="background:rgba(255,255,255,0.95); z-index:11000; display:none;">
    <div class="modal-header" style="background:#fff; color:#5d4037; border-bottom:1px solid #d7ccc8;">
        <span>‚òï ÁîúÁÇπÊüúÂè∞</span>
        <button class="close-btn" onclick="document.getElementById('cafe-shop-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div class="morandi-card" style="margin-bottom:15px; background:#fff8e1; color:#5d4037; text-align:center;">
            <div>ÂΩìÂâçÁßØÂàÜ: <span id="cafe-coin-display" style="font-weight:bold; font-size:1.2rem;">0.00</span></div>
            <div style="font-size:0.8rem; opacity:0.8;">(Ê∂àËÄóÂÆ†Áâ©Á≥ªÁªüÁßØÂàÜ)</div>
        </div>
        <!-- ÂïÜÂìÅÂàóË°® -->
        <div id="cafe-item-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; padding-bottom:50px;">
            <!-- JS ÁîüÊàê -->
        </div>
    </div>
</div>

<!-- ================= üå∏ È¶ôÁâá (Scent) APP ‰∏ªÁïåÈù¢ ================= -->
<div id="scent-app-modal" class="modal-overlay" style="background:#fffcf5; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fff; color:#5d4037; border-bottom:1px solid #eee;">
        <span style="font-family: 'Noto Serif SC', serif; font-weight:bold;">üå∏ Ê∞îÂë≥ËÆ∞ÂøÜ ¬∑ Scent Library</span>
        <button class="close-btn" onclick="document.getElementById('scent-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:0; display:flex; flex-direction:column; height:100%;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="padding:15px; display:flex; gap:10px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.02);">
            <button class="m-btn small" onclick="switchScentView('collection')" id="btn-scent-col" style="background:#d4a5a5; color:white; flex:1;">üîÆ ÂΩìÂâçÊî∂ÈõÜ (12È¶ô)</button>
            <button class="m-btn small" onclick="switchScentView('history')" id="btn-scent-hist" style="background:#eee; color:#555; flex:1;">üìú ÂéÜÂè≤Ê∞îÂë≥</button>
        </div>

        <!-- 1. ÂΩìÂâçÊî∂ÈõÜÂ±ïÁ§∫Âå∫ (12ÂÆ´Ê†º) -->
        <div id="scent-collection-view" style="flex:1; overflow-y:auto; padding:15px;">
            <!-- Á©∫Áä∂ÊÄÅ / ÂºïÂØº -->
            <div id="scent-empty-state" style="text-align:center; margin-top:50px; color:#888;">
                <div style="font-size:3rem; opacity:0.3; margin-bottom:10px;">üå¨Ô∏è</div>
                <p>ÊäΩÂèñÂëΩËøêÁâåÔºå<br>‰∏ÄÊ¨°ÊÄßÂÖ∑Ë±°Âåñ Ta ÁöÑ 12 ÊÆµÊ∞îÂë≥ËÆ∞ÂøÜ„ÄÇ</p>
                <button class="m-btn primary" onclick="startScentDraw()" style="margin-top:20px; width:200px; background:linear-gradient(45deg, #ff9a9e, #fad0c4); color:#d35400; border:none;">‚ú® ÂºÄÂêØÊ∞îÂë≥‰ª™Âºè</button>
            </div>

            <!-- 12È¶ôÁâáÁΩëÊ†º -->
            <div id="scent-grid" style="display:none; grid-template-columns: repeat(3, 1fr); gap:10px;">
                <!-- JS Âä®ÊÄÅÁîüÊàê 12 ‰∏™È¶ôÁâá -->
            </div>
            
            <div id="scent-save-btn-area" style="display:none; padding:20px 0; text-align:center;">
                <button class="m-btn small" onclick="saveScentSession()" style="background:#a5d6a7; color:#2e7d32;">üíæ Â∞ÜËøôÁªÑÈ¶ôÊ∞îÂ≠òÂÖ•ÂéÜÂè≤</button>
            </div>
        </div>

        <!-- 2. ÂéÜÂè≤ËÆ∞ÂΩïÂå∫ -->
        <div id="scent-history-view" style="display:none; flex:1; overflow-y:auto; padding:15px;">
            <div id="scent-history-list"></div>
        </div>
    </div>
</div>

<!-- ================= üå∏ È¶ôÁâá‰∏ìÁî®Áã¨Á´ãÁâåÊ°å ================= -->
<div id="scent-card-table-modal" class="modal-overlay" style="background: rgba(30, 20, 30, 0.98); z-index:10000; display:none;">
    <div id="scent-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #4a3b3b 0%, #1a1a1a 100%);">
        <div id="scent-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#ffcdd2; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ËØ∑ÁøªÂºÄÂá†Âº†ÁâåÔºåÂÆöË∞ÉËøôÁªÑÈ¶ôÊ∞î... (<span id="scent-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishScentDraw()" style="background:linear-gradient(45deg, #f8bbd0, #f48fb1); border:1px solid #fff; color:#880e4f;">
                üè∫ ÂáùÁªÉ 12 ÊûöÈ¶ôÁâá
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('scent-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>

<!-- ================= üå∏ È¶ôÁâáËØ¶ÊÉÖÂºπÁ™ó (ÁÇπÂáªÁøªÂºÄÂêéÊòæÁ§∫) ================= -->
<div id="scent-detail-modal" class="modal-overlay" style="background:rgba(0,0,0,0.6); z-index:11000; display:none; align-items:center; justify-content:center;">
    <div class="morandi-card" style="width:85%; max-width:400px; max-height:80vh; overflow-y:auto; padding:0; overflow:hidden; animation: popIn 0.3s; background:#fff;">
        <div style="height:120px; background:linear-gradient(135deg, #fdfbf7 0%, #fff0f5 100%); display:flex; align-items:center; justify-content:center; position:relative;">
            <div style="font-size:4rem; filter:drop-shadow(0 5px 10px rgba(0,0,0,0.1));">üß¥</div>
            <div class="close-btn" onclick="document.getElementById('scent-detail-modal').style.display='none'" style="position:absolute; top:5px; right:10px; cursor:pointer; color:#888;">√ó</div>
        </div>
        <div style="padding:20px;">
            <h2 id="sd-name" style="margin:0; color:#5d4037; font-family:'Songti SC', serif;">È¶ôÊ∞¥Âêç</h2>
            <div id="sd-notes" style="font-size:0.8rem; color:#999; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">ÂâçË∞É/‰∏≠Ë∞É/ÂêéË∞É</div>
            
            <div style="margin-bottom:15px;">
                <strong style="color:#d81b60; font-size:0.9rem;">üìù Ê∞îÂë≥ËØÑ‰ª∑:</strong>
                <p id="sd-review" style="font-size:0.9rem; color:#555; line-height:1.6; margin-top:5px;"></p>
            </div>
            
            <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                <strong style="color:#6d4c41; font-size:0.9rem;">üìñ ËÆ∞ÂøÜÊïÖ‰∫ã:</strong>
                <p id="sd-story" style="font-size:0.95rem; color:#3e2723; line-height:1.8; margin-top:5px; font-family:'Songti SC', serif; text-align:justify;"></p>
            </div>
        </div>
    </div>
</div>
<!-- ================= üíû ÈªòÂ•ëÂ§ßÊåëÊàò APP ‰∏ªÁïåÈù¢ ================= -->
<div id="tacit-app-modal" class="modal-overlay" style="background:#fff0f5; z-index:9999; display:none;">
    <div class="modal-header" style="background:#ffcce0; color:#d63031; border-bottom:1px solid #ffadd2;">
        <span style="font-weight:bold;">üíû ÈªòÂ•ëÂ§ßÊåëÊàò ¬∑ Tacit Test</span>
        <button class="close-btn" onclick="document.getElementById('tacit-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchTacitView('setup')" id="btn-tacit-setup" style="background:#d63031; color:white; flex:1;">üéÆ ÂèëËµ∑ÊåëÊàò</button>
            <button class="m-btn small" onclick="switchTacitView('history')" id="btn-tacit-history" style="background:#ff9ff3; color:#fff; flex:1;">üìÇ ÊåëÊàòËÆ∞ÂΩï</button>
        </div>

        <!-- 1. ËÆæÁΩÆ/ÊåëÊàòÁïåÈù¢ -->
        <div id="tacit-setup-view">
            <div class="morandi-card" style="padding:15px; margin-bottom:15px; background:rgba(255,255,255,0.8);">
                <h3 style="color:#d63031; margin-bottom:10px; font-size:1rem;">üìù ËßÑÂàôËØ¥Êòé</h3>
                <p style="font-size:0.8rem; color:#888;">
                    1. Â°´ÂÜôÈóÆÈ¢òÂíå‰∏§‰∏™ÈÄâÈ°π„ÄÇ<br>
                    2. ÁÇπÂáªÂè≥‰æßÊåâÈíÆÔºå‰∏∫ËøôÈÅìÈ¢òÊäΩÂèñ‰∏ÄÂº†‚ÄúÂëΩËøêÁâå‚Äù„ÄÇ<br>
                    3. ÂãæÈÄâ **‰Ω†ÂøÉ‰∏≠ËÆ§‰∏∫Ê≠£Á°Æ/‰Ω†‰ºöÈÄâ** ÁöÑÈÇ£‰∏™ÈÄâÈ°π„ÄÇ<br>
                    4. ÂÖ®ÈÉ®ÂÆåÊàêÂêéÊèê‰∫§ÔºåTa ‰ºöÊ†πÊçÆÁâåÊÑèÂíå‰∫∫ËÆæËøõË°åÈÄâÊã©„ÄÇ
                </p>
            </div>

            <!-- ÈóÆÈ¢òÂàóË°®ÂÆπÂô® -->
            <div id="tacit-question-list"></div>

            <button class="m-btn small" onclick="addTacitQuestion()" style="width:100%; background:#e0e0e0; color:#555; margin-bottom:20px;">+ Ê∑ªÂä†‰∏ÄÈ¢ò (ÊúÄÂ§ö10È¢ò)</button>
            
            <button class="m-btn primary" onclick="submitTacitChallenge()" id="btn-tacit-submit" style="width:100%; height:50px; background:#ff7675; font-size:1.1rem; box-shadow:0 4px 10px rgba(255,118,117,0.4);">
                üíå Êèê‰∫§Áªô Ta (ÂºÄÂßãÊµãËØï)
            </button>
        </div>

        <!-- 2. ÁªìÊûú/ËØ¶ÊÉÖÁïåÈù¢ -->
        <div id="tacit-result-view" style="display:none;">
            <div class="morandi-card" style="text-align:center; padding:20px; margin-bottom:15px; background:#fff;">
                <h2 id="tacit-score-display" style="color:#d63031; font-size:2rem; margin:0;">100%</h2>
                <div style="font-size:0.9rem; color:#888;">ÈªòÂ•ëÂ∫¶</div>
                <div id="tacit-summary-reaction" style="margin-top:15px; font-style:italic; color:#5d4037; font-weight:bold;"></div>
            </div>
            
            <div id="tacit-result-list"></div>
            
            <button class="m-btn small" onclick="switchTacitView('setup')" style="width:100%; margin-top:20px; background:#ccc;">üîô ËøîÂõû</button>
        </div>

        <!-- 3. ÂéÜÂè≤ËÆ∞ÂΩïÁïåÈù¢ -->
        <div id="tacit-history-view" style="display:none;">
            <div id="tacit-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>

<!-- ================= üíû ÈªòÂ•ëÊåëÊàò‰∏ìÁî®Áã¨Á´ãÁâåÊ°å ================= -->
<div id="tacit-card-table-modal" class="modal-overlay" style="background: rgba(40, 20, 30, 0.98); z-index:10000; display:none;">
    <div id="tacit-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #fd79a8 0%, #2d3436 100%);">
        <div id="tacit-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#fab1a0; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem;">
                ‰∏∫ËøôÈÅìÈ¢òÊäΩÂèñÂëΩËøêÊåáÂºï... (<span id="tacit-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="confirmTacitCard()" style="background:#d63031; border:1px solid #fff; color:white; box-shadow:0 0 15px rgba(214, 48, 49, 0.5);">
                ‚úÖ Á°ÆËÆ§ËøôÂº†Áâå
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('tacit-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- üì© ÈöèÊú∫Áü≠‰ø°ÊÇ¨ÊµÆÁ™ó -->
<div id="random-sms-trigger" class="random-sms-toast" onclick="handleSmsClick()">
    <div class="random-sms-icon">üíå</div>
    <div style="color:white; font-weight:bold; font-size:0.8rem; margin-top:5px;">Ta ÁöÑÊù•‰ø°</div>
</div>

<!-- üì© Áü≠‰ø°‰∏ìÁî®ÊäΩÁâåÊ°å (Â§çÁî®Áé∞ÊúâÈÄªËæëÔºåÁã¨Á´ãID) -->
<div id="sms-card-modal" class="modal-overlay" style="background: rgba(40, 20, 30, 0.95); z-index:21000; display:none;">
    <div id="sms-card-desk" style="width:100%; height:100%; position:relative; overflow-y:auto;">
        <!-- ÊäΩÁâåÂå∫Âüü -->
        <div id="sms-card-area" style="width:100%; height:100%; position:relative; transform-style:preserve-3d; perspective:1000px;"></div>
        
        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="card-table-ui">
            <div style="color:#ff9a9e; font-weight:bold; text-shadow:0 1px 2px black;">
                ÊäΩÂèñÂëΩËøêÁâåÔºåËØªÂèñTaÂΩì‰∏ãÁöÑËÆØÊÅØ... (<span id="sms-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishSmsDraw()" style="background:#ff7675; color:white; border:1px solid white;">
                ‚ú® ËØªÂèñÁü≠‰ø°ÂÜÖÂÆπ
            </button>
            <button class="m-btn secondary" onclick="closeSmsModal()" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂøΩÁï•
            </button>
        </div>
    </div>

    <!-- ÁªìÊûúÂ±ïÁ§∫ÂºπÁ™ó (Áõ¥Êé•ÂµåÂú®ÈáåÈù¢) -->
    <div id="sms-result-overlay" class="modal-overlay" style="background:rgba(0,0,0,0.8); z-index:22000; display:none; align-items:center; justify-content:center;">
        <div class="sms-result-box">
            <div style="font-size:1.2rem; font-weight:bold; color:#d63031; text-align:center;">üì¨ Áü≠‰ø°Â∑≤ÈÄÅËææ</div>
            <div style="background:#fff0f6; padding:10px; border-radius:8px;">
                <strong>üëÄ TaÊ≠£Âú®ÂÅöÁöÑ‰∫ãÔºö</strong><br>
                <span id="sms-res-action">...</span>
            </div>
            <div style="background:#e3f2fd; padding:10px; border-radius:8px;">
                <strong>üí¨ TaÊÉ≥ÂØπ‰Ω†ËØ¥Ôºö</strong><br>
                <span id="sms-res-msg">...</span>
            </div>
            <div style="font-size:0.7rem; color:#aaa; text-align:center;">üîÆ ÁâåÊÑèÊåáÂºï: <span id="sms-res-cards"></span></div>
            <button class="m-btn primary" onclick="closeSmsResult()" style="width:100%;">Êî∂‰∏ãËøô‰ªΩÂøÉÊÑè</button>
        </div>
    </div>
</div>
<!-- ================= üß© ËÆ∞ÂøÜÊãºÂõæ APP ‰∏ªÁïåÈù¢ ================= -->
<div id="puzzle-app-modal" class="modal-overlay" style="background:#f0f8ff; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fff; color:#2c3e50; border-bottom:1px solid #dfe6e9;">
        <span style="font-weight:bold;">üß© ËÆ∞ÂøÜÊãºÂõæ ¬∑ Fragments</span>
        <button class="close-btn" onclick="document.getElementById('puzzle-app-modal').style.display='none'">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px;">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="m-btn small" onclick="switchPuzzleView('create')" id="btn-puzzle-create" style="background:#74ebd5; color:#fff; flex:1;">üì∏ Êñ∞ÁöÑÂõûÂøÜ</button>
            <button class="m-btn small" onclick="switchPuzzleView('history')" id="btn-puzzle-history" style="background:#dfe6e9; color:#333; flex:1;">üìÇ ÊãºÂõæÂÜå</button>
        </div>

        <!-- 1. ÂàõÂª∫/Ê∏∏ÊàèÁïåÈù¢ -->
        <div id="puzzle-create-view">
            <!-- A. ‰∏ä‰º†Âå∫Âüü -->
            <div id="puzzle-upload-panel" class="morandi-card" style="text-align:center; padding:30px;">
                <div style="font-size:3rem; margin-bottom:10px;">üñºÔ∏è</div>
                <h3 style="color:#2c3e50; margin-bottom:10px;">Âî§ÈÜí‰∏ÄÊÆµËÆ∞ÂøÜ</h3>
                <p style="font-size:0.8rem; color:#7f8c8d; margin-bottom:20px;">‰∏ä‰º†‰∏ÄÂº†ÁÖßÁâáÔºåÊäΩÂèñÂëΩËøêÁâå<br>ÈáçÊûÑËßíËâ≤ÂØπÊ≠§ÁöÑ 9 ‰∏™ËÆ∞ÂøÜÁ¢éÁâá„ÄÇ</p>
                
                <input type="file" id="puzzle-file-input" style="display:none;" accept="image/*" onchange="handlePuzzleUpload(this)">
                <button class="m-btn primary" onclick="document.getElementById('puzzle-file-input').click()" style="width:100%; background:#0984e3;">
                    üì§ ‰∏ä‰º†ÁÖßÁâáÂπ∂ÂºÄÂßã
                </button>
            </div>

            <!-- B. Ê∏∏ÊàèÂå∫Âüü (ÂàùÂßãÈöêËóè) -->
            <div id="puzzle-game-panel" style="display:none; flex-direction:column; align-items:center;">
                <div style="margin-bottom:10px; font-weight:bold; color:#0984e3;" id="puzzle-status-text">ÁÇπÂáª‰∏§ÂùóÊãºÂõæËøõË°å‰∫§Êç¢...</div>
                
                <!-- ÊãºÂõæÂÆπÂô® -->
                <div id="puzzle-board" class="puzzle-board">
                    <!-- JS ÁîüÊàê 9 ‰∏™Ê†ºÂ≠ê -->
                </div>

                <div class="morandi-card" style="width:100%; margin-top:20px; padding:10px;">
                    <div style="font-size:0.8rem; color:#888;">üîÆ ÂëΩËøêÁâåÊåáÂºï: <span id="puzzle-cards-display"></span></div>
                    <button class="m-btn small" onclick="resetPuzzleGame()" style="width:100%; margin-top:10px; background:#fab1a0; color:#d63031;">üè≥Ô∏è ÊîæÂºÉ / ÈáçÊù•</button>
                </div>
            </div>
        </div>

        <!-- 2. ÂéÜÂè≤ËÆ∞ÂΩïÁïåÈù¢ -->
        <div id="puzzle-history-view" style="display:none;">
            <div id="puzzle-history-list" style="display:flex; flex-direction:column; gap:15px;"></div>
        </div>
    </div>
</div>

<!-- ================= üß© ÊãºÂõæ‰∏ìÁî®Áã¨Á´ãÁâåÊ°å (Ê∏∏ÊàèÊú∫È£éÊ†º) ================= -->
<div id="puzzle-card-table-modal" class="modal-overlay" style="background: rgba(20, 20, 30, 0.98); z-index:10000; display:none;">
    <div id="puzzle-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #6c5ce7 0%, #2d3436 100%);">
        
        <!-- Ê∏∏ÊàèÊú∫Ë£ÖÈ•∞Ê°Ü -->
        <div class="game-console-frame" style="pointer-events:none; position:absolute; top:0; left:0; width:100%; height:100%; border:10px solid #2d3436; box-sizing:border-box; z-index:5;"></div>
        
        <div id="puzzle-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui" style="z-index:10;">
            <div style="color:#74ebd5; text-shadow:0 1px 3px #000; font-weight:bold; font-size:1.1rem; font-family:'Courier New', monospace;">
                MEMORY SYNC... CARD: <span id="puzzle-flipped-count">0</span>
            </div>
            <button class="m-btn primary" onclick="finishPuzzleDraw()" style="background:#0984e3; border:2px solid #74ebd5; color:white; box-shadow:0 0 15px rgba(116, 235, 213, 0.5);">
                üíæ Ëß£ÊûêËÆ∞ÂøÜÁ¢éÁâá
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('puzzle-card-table-modal').style.display='none'" style="background:#2d3436; color:#ccc;">
                CANCEL
            </button>
        </div>
    </div>
</div>
<!-- === ÊñáÊ∏∏ (Text Adventure) ‰∏ªÁïåÈù¢ === -->
<div id="adv-modal" class="modal-overlay">
    <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="adv-top-bar">
        <div class="adv-user-info">
            <div id="adv-user-avatar" class="adv-avatar"></div>
            <div class="adv-stats">
                <span id="adv-user-name" onclick="editAdvName()">Áé©ÂÆ∂</span>
                <span style="font-weight:normal; font-size:0.7rem; margin-top:2px;">
                    Ê∏ÖÊ¥Å: <span id="adv-stat-clean">100</span>% | ÈáëÈí±: <span id="adv-stat-money">0</span>
                </span>
            </div>
        </div>
        <button class="adv-exit-btn" onclick="closeTextAdventure()">ÈÄÄÂá∫Ê∏∏Êàè</button>
    </div>

    <!-- Âú∫ÊôØËÉåÊôØÂÆπÂô® -->
    <!-- ‰øÆÊîπÔºöÂ¢ûÂä†ÁÇπÂáªËÉåÊôØÈöêËóèÂØπËØùÊ°ÜÁöÑÈÄªËæë -->
<div id="adv-scene-container" onclick="if(event.target === this) document.getElementById('adv-dialog-box').style.display='none'">
        <!-- ÊåâÈíÆÂ∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
    </div>
<!-- Â∫ïÈÉ®ÂØπËØùÊ°Ü (‰øÆÊîπÁâàÔºöÁÇπÂáªÁøªÈ°µ) -->
<div id="adv-dialog-box" style="display:none;" onclick="nextAdvDialogueChunk()">
    <div id="adv-dialog-img" class="adv-dialog-avatar"></div>
    <div class="adv-dialog-content">
        <div id="adv-dialog-name" class="adv-dialog-name">System</div>
        <div id="adv-dialog-text" class="adv-dialog-text">...</div>
        <!-- ‰∏ã‰∏ÄÈ°µÊèêÁ§∫ÂõæÊ†á -->
        <div style="text-align:right; font-size:0.8rem; color:yellow; margin-top:5px;">‚ñº ÁÇπÂáªÁªßÁª≠</div>
    </div>
</div>
<!-- ================= „ÄêÁ¨¨‰∏âÈò∂ÊÆµ„ÄëÊñ∞Â¢ûÁªÑ‰ª∂ ================= -->

<!-- 1. üîÆ Ê¢¶Âç†Ê®°Âºè‰∏ìÁî®ÁâåÊ°å (ÂÆåÂÖ®Â§çÂàªÊ∏∏ÊàèÊú∫ÁâåÊ°åÔºåÁã¨Á´ãID) -->
<div id="dream-divination-modal" class="modal-overlay" style="background: rgba(10, 10, 20, 0.98); z-index:20000; display:none;">
    <div id="dream-divination-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #2d3436 0%, #000 100%);">
        <div id="dream-divination-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÁî± JS ÁîüÊàê -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#a29bfe; text-shadow:0 1px 5px #000; font-size:1.1rem; font-weight:bold;">
                üîÆ Ê¢¶Âç†Ê®°ÂºèÔºöËØ∑ÊäΩÂèñÂëΩËøêÊåáÂºï... (<span id="dream-div-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishDreamDivination()" style="background:#6c5ce7; border:1px solid #fff; color:white;">
                ‚ú® Á°ÆËÆ§ÁâåÊÑèÂπ∂ÁªßÁª≠
            </button>
            <!-- Ê≥®ÊÑèÔºöÊ¢¶Âç†Ê®°ÂºèÂº∫Âà∂ÂºÄÂêØÊó∂‰∏çÂèØÂèñÊ∂àÔºåÈô§ÈùûÂÖ≥Èó≠Ê®°Âºè -->
            <button class="m-btn secondary" onclick="cancelDreamDivination()" style="background:rgba(255,255,255,0.2); color:#ccc;">
                ÂèñÊ∂à (‰∏çÁîüÊàê)
            </button>
        </div>
    </div>
</div>

<!-- 2. üìÖ Á∫¶‰ºöËÆ°ÂàíË°® -->
<div id="adv-date-modal" class="modal-overlay" style="background:#fff; z-index:15000; display:none;">
    <div class="modal-header" style="background:#ff7675; color:white;">
        <span>üìÖ Á∫¶‰ºöËÆ°Âàí</span>
        <button class="close-btn" onclick="document.getElementById('adv-date-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div class="morandi-card" style="padding:20px;">
            <h3 style="color:#d63031;">ÂéªÂì™ÈáåÁ∫¶‰ºöÔºü</h3>
            
            <div class="input-group">
                <label>üìç Âú∞ÁÇπ (Location)</label>
                <select id="date-location-select" style="padding:10px; background:#fff;">
                    <!-- JS Ëá™Âä®Â°´ÂÖÖ -->
                </select>
            </div>
            <div class="input-group">
                <label>üé° Á∫¶‰ºöÈ°πÁõÆ (Activity)</label>
                <input type="text" id="date-activity" placeholder="‰æãÂ¶ÇÔºöÁúãÁîµÂΩ±„ÄÅÈáéÈ§ê„ÄÅÁúãÊòüÊòü...">
            </div>
            <div class="input-group">
                <label>‚è∞ Êó∂Èó¥ (Time)</label>
                <input type="text" id="date-time" placeholder="‰æãÂ¶ÇÔºöÂë®Êú´Êôö‰∏ä„ÄÅÈªÑÊòè...">
            </div>
            <div class="input-group">
                <label>üìù ÊÉ≥ÂÅöÁöÑ‰∫ã (Detail)</label>
                <textarea id="date-detail" class="editor-textarea" style="height:80px;" placeholder="‰æãÂ¶ÇÔºöÊÉ≥ÁâµÊâã„ÄÅÊÉ≥ÈÄÅÁ§ºÁâ©..."></textarea>
            </div>

            <button class="m-btn primary" onclick="startDatingEvent()" style="width:100%; margin-top:15px; background:#ff7675; font-size:1.1rem;">
                üíñ Âá∫ÂèëÔºÅ
            </button>
        </div>
    </div>
</div>

<!-- 3. üìú ÊñáÊ∏∏ÂéÜÂè≤ËÆ∞ÂΩï -->
<div id="adv-history-modal" class="modal-overlay" style="background:#f5f5f5; z-index:15000; display:none;">
    <div class="modal-header" style="background:#fff; color:#333;">
        <span>üìñ ÂÜíÈô©ÂõûÂøÜÂΩï</span>
        <button class="close-btn" onclick="document.getElementById('adv-history-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body" style="padding:15px;">
        <div id="adv-history-list" style="display:flex; flex-direction:column; gap:15px;"></div>
    </div>
</div>

<!-- 4. üé≤ ÈöèÊú∫‰∫ã‰ª∂ËæìÂÖ•Ê°Ü -->
<div id="adv-random-modal" class="modal-overlay" style="background:rgba(0,0,0,0.8); z-index:16000; align-items:center; justify-content:center; display:none;">
    <div class="morandi-card" style="width:85%; max-width:400px;">
        <h3 style="color:#0984e3;">‚ú® Ëß¶Âèë‰∫ÜÁâπÊÆäÂâßÊÉÖÔºÅ</h3>
        <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">‰Ω†ÂèØ‰ª•‰øÆÊîπ‰∏ãÊñπÁöÑÊèèËø∞ÔºåËÆ©AIÁîüÊàêÊõ¥Á≤æÂΩ©ÁöÑÊïÖ‰∫ãÔºö</p>
        <textarea id="adv-random-input" class="editor-textarea" style="height:100px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="m-btn secondary" onclick="document.getElementById('adv-random-modal').style.display='none'">ÂøΩÁï•</button>
            <button class="m-btn primary" onclick="confirmRandomEvent()" style="background:#0984e3;">üé¨ ÁîüÊàêÂâßÊÉÖ</button>
        </div>
    </div>
</div>

<!-- 5. üîö ÁªìÂ±ÄÁîüÊàêÁ°ÆËÆ§ -->
<div id="adv-ending-modal" class="modal-overlay" style="background:#000; color:#fff; z-index:17000; display:none;">
    <div style="padding:30px; text-align:center; max-width:500px;">
        <div style="font-size:3rem; margin-bottom:20px;">üé¨</div>
        <h2>ÁªìÊùüËøô‰∏™‰∏ñÁïåÔºü</h2>
        <p style="color:#aaa; line-height:1.6; margin-bottom:30px;">
            ËøôÂ∞ÜÊ±áÊÄª‰Ω†ÊâÄÊúâÁöÑÂ±ûÊÄß„ÄÅÂ•ΩÊÑüÂ∫¶‰ª•Âèä„ÄêÈáçË¶ÅÂõûÂøÜ„ÄëÔºåÁîüÊàêÊúÄÁªàÁªìÂ±Ä„ÄÇ<br>
            <span style="color:#ff7675;">ÁîüÊàêÂêéÔºåÊâÄÊúâÊï∞ÊçÆÂ∞ÜË¢´ÈáçÁΩÆÔºåÊñ∞ÁöÑËΩÆÂõûÂ∞ÜÂºÄÂßã„ÄÇ</span>
        </p>
        <button class="m-btn primary" onclick="generateEnding()" style="background:#fff; color:#000; font-weight:bold; width:100%;">Á°ÆËÆ§ÁîüÊàêÁªìÂ±Ä</button>
        <button class="m-btn secondary" onclick="document.getElementById('adv-ending-modal').style.display='none'" style="background:transparent; color:#aaa; margin-top:15px; border:1px solid #555;">ÊàëËøòË¶ÅÁªßÁª≠Êé¢Á¥¢</button>
    </div>
</div>
</div>
<!-- üíç ÁªìÂ©öËØÅ‰π¶Á≠æÂ≠óÂºπÁ™ó -->
<div id="marriage-cert-modal" class="modal-overlay" style="background:rgba(0,0,0,0.8); z-index:20000; display:none; align-items:center; justify-content:center;">
  <div style="position:relative; width:90%; max-width:600px;">
    <!-- ‰øÆÊîπÁÇπÔºöÊ∑ªÂä† opacity: 0; ËÆ©ÂÆÉÈöêË∫´ÔºåÂè™Ëµ∑ÊíëÂºÄÂ∏ÉÂ±ÄÁöÑ‰ΩúÁî® -->
    <img src="https://i.postimg.cc/Nf9QVP0M/IMG_2144.jpg" style="width:100%; border-radius:8px; box-shadow:0 0 20px rgba(255,255,255,0.2); opacity: 0;">
    
    <!-- Á≠æÂêçÁîªÂ∏ÉÂå∫Âüü (JS‰ºöÂú®ËøôÈáåÁîªÂá∫ËÉåÊôØÂõæÂíåÁ≠æÂêçÔºåÊâÄ‰ª•Âè™ÊòæÁ§∫ËøôÂ±ÇÂ∞±Â§ü‰∫Ü) -->
    <canvas id="cert-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%; cursor:crosshair; touch-action:none;"></canvas>
        <div style="position:absolute; bottom:-60px; left:0; width:100%; display:flex; justify-content:center; gap:20px;">
            <button class="m-btn small" onclick="clearCertCanvas()" style="background:#fff; color:#333;">ÈáçÁ≠æ</button>
            <button class="m-btn primary" onclick="finishMarriage()" style="background:#d63031; border:1px solid #fff;">ÂÆåÊàêÂπ∂ÂÆ£Ë™ì</button>
            <button class="m-btn secondary" onclick="document.getElementById('marriage-cert-modal').style.display='none'">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
<!-- ‚ù§Ô∏è ÁîªÁà±ÂøÉ‰∫íÂä®Â±Ç (Âê´ÂëºÂê∏ÁâπÊïà) -->
<div id="adv-heart-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 30000; display: none; flex-direction: column; align-items: center; justify-content: flex-end;">
    <!-- ÂëºÂê∏Âä®ÁîªÊ†∑Âºè -->
    <style>
        @keyframes char-breathing {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.03) translateY(-1%); } /* Âê∏Ê∞îÔºöÂèòÂ§ß‰∏îÂæÆ‰∏äÊµÆ */
            100% { transform: scale(1) translateY(0); }
        }
    </style>

    <!-- Â∫ïÂ±ÇÁ´ãÁªò (Â∑≤Ê∑ªÂä† animation Â±ûÊÄß) -->
    <img id="heart-char-img" src="" style="position: absolute; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.8); pointer-events: none; transform-origin: bottom center; animation: char-breathing 4s ease-in-out infinite;">
    
    <!-- ÁªòÁîªÂ±Ç -->
    <canvas id="heart-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; touch-action: none;"></canvas>

    <!-- ÂØπËØùÊ°Ü -->
    <div id="heart-msg-box" style="position: relative; z-index: 10; margin-bottom: 80px; background: rgba(255,255,255,0.95); color: #333; padding: 15px 25px; border-radius: 20px; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.5); max-width: 80%; text-align: center; border: 2px solid #ff7675; transition: all 0.3s;">
        ‰Ω†Áé©Â•Ω‰πÖ‰∫ÜÔºå‰ºëÊÅØ‰∏Ä‰∏ãÂø´ËØ¥Áà±ÊàëÔºÅ
    </div>
    
    <div style="position:absolute; bottom:30px; z-index:10; color:rgba(255,255,255,0.6); font-size:0.8rem; pointer-events:none;">
        (ËØ∑Âú®Â±èÂπï‰∏äÁîª‰∏™Áà±ÂøÉ)
    </div>
</div>
<script>
(function() {
    console.log("Ê≠£Âú®ÂàùÂßãÂåñÂ≠¶‰π†ÊÄªÁªì APP...");

    // 1. ÂàùÂßãÂåñÊï∞ÊçÆÁªìÊûÑ (Êó†ÈôêÂ≠òÂÇ®)
    if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
    if (!window.BIG_MEMORY.summary_data) window.BIG_MEMORY.summary_data = [];

    // 2. ÊåÇËΩΩÂÖ®Â±ÄÂáΩÊï∞
    window.getSummaryData = function() { return window.BIG_MEMORY.summary_data || []; };
    
    window.saveSummaryData = function(list) {
        window.BIG_MEMORY.summary_data = list;
        if (typeof idb !== 'undefined' && idb.put) {
            idb.put('universal_store', { id: 'summary_data', data: list });
        }
    };

    window.openSummaryApp = function() {
        const modal = document.getElementById('summary-app-modal');
        if(modal) {
            modal.style.display = 'flex';
            switchSummaryView('create');
        } else {
            alert("ÈîôËØØÔºöÁïåÈù¢Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•‰ª£Á†ÅÁ≤òË¥¥‰ΩçÁΩÆÔºÅ");
        }
    };

    window.switchSummaryView = function(mode) {
        const createEl = document.getElementById('summary-create-view');
        const histEl = document.getElementById('summary-history-view');
        const btnCreate = document.getElementById('btn-sum-create');
        const btnHist = document.getElementById('btn-sum-history');

        if (mode === 'create') {
            createEl.style.display = 'block';
            histEl.style.display = 'none';
            btnCreate.style.background = '#607d8b'; btnCreate.style.color = '#fff';
            btnHist.style.background = '#eceff1'; btnHist.style.color = '#333';
        } else {
            createEl.style.display = 'none';
            histEl.style.display = 'block';
            btnCreate.style.background = '#eceff1'; btnCreate.style.color = '#333';
            btnHist.style.background = '#607d8b'; btnHist.style.color = '#fff';
            renderSummaryHistory();
        }
    };

    let pendingSummary = null;

    window.generateSummary = async function() {
        const subject = document.getElementById('sum-subject').value;
        const notes = document.getElementById('sum-notes').value;
        if (!subject || !notes) return alert("ËØ∑Â°´ÂÜôÂÜÖÂÆπÔºÅ");

        const btn = document.getElementById('btn-sum-gen');
        const oldText = btn.innerText;
        btn.disabled = true; btn.innerText = "üß† Ê≠£Âú®ËøûÊé•Â§ßËÑë...";

        // Ëé∑Âèñ API Key
        let apiKey = "";
        try { apiKey = document.getElementById('api-key').value; } catch(e){}
        if(!apiKey) {
            try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; } catch(e){}
        }
        if(!apiKey) { 
            alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
            btn.disabled = false; btn.innerText = oldText;
            return;
        }

        let apiUrl = document.getElementById('api-url')?.value || "https://api.openai.com/v1";
        if(apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0,-1);
        let model = document.getElementById('model-select')?.value || "gpt-3.5-turbo";

        // Ëé∑Âèñ‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñá
        const wb = window.BIG_MEMORY.world_book || {};
        const globalCtx = document.getElementById('sum-use-wb').checked 
            ? (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n") 
            : "";

        const prompt = `
‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂ≠¶‰π†ÂØºÂ∏àÔºåÂêåÊó∂‰Ω†ÈúÄË¶Å**‰∏•Ê†ºÊâÆÊºî‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤**„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}

„ÄêÁî®Êà∑ËæìÂÖ•„Äë
ÁßëÁõÆÔºö${subject}
Á¨îËÆ∞ÂÜÖÂÆπÔºö${notes}

„Äê‰ªªÂä°„Äë
ËØ∑‰ª•ËßíËâ≤ÁöÑÂè£ÂêªÔºåÂØπÁî®Êà∑ÁöÑÁ¨îËÆ∞ËøõË°åÊ∑±Â∫¶ÂàÜÊûêÊÄªÁªì„ÄÇ
**ÂøÖÈ°ª‰∏•Ê†ºËæìÂá∫ JSON Ê†ºÂºè**Ôºå‰∏çË¶Å Markdown ‰ª£Á†ÅÂùó„ÄÇ

„ÄêJSON ÁªìÊûÑ„Äë
{
  "questions": "ÊåáÂá∫Á¨îËÆ∞‰∏≠ÈÄªËæë‰∏çÈÄö„ÄÅÈÅóÊºèÁöÑÂÖ≥ÈîÆÁÇπÔºåÊàñËÄÖÈíàÂØπÁ¨îËÆ∞ÂÜÖÂÆπÊèêÂá∫ 2-3 ‰∏™ÂêØÂèëÊÄßÈóÆÈ¢ò„ÄÇ",
  "expansion": "Ê†πÊçÆÁ¨îËÆ∞ÂÜÖÂÆπÔºåÊâ©Â±ïÂª∂‰º∏Áõ∏ÂÖ≥ÁöÑÁü•ËØÜÁÇπ„ÄÅËÉåÊôØÊàñÈ´òÁ∫ßÁî®Ê≥ïÔºàËßíËâ≤ËßÜËßíÁöÑËßÅËß£Ôºâ„ÄÇ",
  "plan": "Êé®Ëçê‰∏ã‰∏ÄÊ≠•ÁöÑÂ≠¶‰π†ÁõÆÊ†á„ÄÅÂÖ∑‰ΩìÁöÑÊïôÊùêÂêçÁß∞„ÄÅÊïôÁ®ãÈìæÊé•ÂÖ≥ÈîÆËØçÔºàÂøÖÈ°ªÁúüÂÆûÂ≠òÂú®Ôºâ„ÄÇ"
}
`;

        try {
            const res = await fetch(`${apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{role:"system", content:"You are a helpful tutor. Output JSON only."}, {role:"user", content:prompt}],
                    temperature: 0.7
                })
            });

            const json = await res.json();
            if(json.error) throw new Error(json.error.message);
            
            let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
            // ÁÆÄÂçïÂÆπÈîô
            const first = raw.indexOf('{'); const last = raw.lastIndexOf('}');
            if(first !== -1 && last !== -1) raw = raw.substring(first, last+1);
            
            const result = JSON.parse(raw);

            document.getElementById('res-questions').innerText = result.questions;
            document.getElementById('res-expansion').innerText = result.expansion;
            document.getElementById('res-plan').innerText = result.plan;
            document.getElementById('summary-result-area').style.display = 'block';
            
            pendingSummary = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                subject: subject,
                notes: notes,
                result: result
            };

        } catch(e) {
            console.error(e);
            alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    };

    window.saveSummaryResult = function() {
        if (!pendingSummary) return;
        const list = getSummaryData();
        list.unshift(pendingSummary);
        saveSummaryData(list);
        alert("‚úÖ Â∑≤‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩïÔºÅ");
        document.getElementById('summary-result-area').style.display = 'none';
        document.getElementById('sum-notes').value = '';
        switchSummaryView('history');
    };

    window.renderSummaryHistory = function() {
        const list = getSummaryData();
        const container = document.getElementById('summary-history-list');
        container.innerHTML = '';
        
        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; padding:30px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
            return;
        }

        list.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'morandi-card';
            div.style.marginBottom = '15px'; 
            div.style.padding = '15px';
            div.style.background = '#fff';
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:10px;">
                    <span style="font-weight:bold; color:#607d8b; font-size:1rem;">üìò ${item.subject}</span>
                    <span style="font-size:0.8rem; color:#999;">${item.date}</span>
                </div>
                
                <div style="font-size:0.85rem; background:#f5f5f5; padding:8px; border-radius:6px; margin-bottom:12px; color:#555;">
                    üìù <strong>Á¨îËÆ∞:</strong> ${item.notes.substring(0, 50)}...
                </div>

                <div style="font-size:0.9rem; line-height:1.6; color:#333;">
                    <div style="margin-bottom:8px;"><strong style="color:#d35400;">‚ùì ÈóÆÈ¢ò:</strong> ${item.result.questions}</div>
                    <div style="margin-bottom:8px;"><strong style="color:#2980b9;">üåç Êâ©Â±ï:</strong> ${item.result.expansion}</div>
                    <div><strong style="color:#27ae60;">üìÖ ËÆ°Âàí:</strong> ${item.result.plan}</div>
                </div>

                <div style="text-align:right; margin-top:10px;">
                    <button class="m-btn small" onclick="deleteSummaryItem(${index})" style="background:#ffcdd2; color:#c0392b; font-size:0.8rem; padding:5px 12px;">üóëÔ∏è Âà†Èô§</button>
                </div>
            `;
            container.appendChild(div);
        });
    };

    window.deleteSummaryItem = function(index) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
        const list = getSummaryData();
        list.splice(index, 1);
        saveSummaryData(list);
        renderSummaryHistory();
    };

    // 3. Âº∫Âà∂Êï∞ÊçÆÂä†ËΩΩ
    setTimeout(async () => {
        try {
            if(typeof idb !== 'undefined') {
                const res = await idb.get('universal_store', 'summary_data');
                if(res) window.BIG_MEMORY.summary_data = res.data;
            }
        } catch(e) {}
    }, 1000);

})();
/* ==================== ÊñáÊ∏∏ (Text Adventure) Á≥ªÁªü (Phase 2.2 Final) ==================== */

// 1. Êï∞ÊçÆÁªìÊûÑÂàùÂßãÂåñ
if (!window.BIG_MEMORY.adv_data) {
    window.BIG_MEMORY.adv_data = {
        name: "Áé©ÂÆ∂",
        cleanliness: 100,
        money: 100,
        affection: 0,
        attributes: { learning: 0, art: 0, talent: 0, fitness: 0 },
        inventory: [],
        avatars: { user: "", char: "" } // Êç¢Ë°£Èó¥‰∏ä‰º†ÁöÑÁ´ãÁªò
    };
}

// ÁºìÂ≠ò Line ÁöÑÂ§¥ÂÉèÂíåÊòµÁß∞
let ADV_CACHE = {
    lineUserAvatar: null,
    lineCharAvatar: null,
    lineCharName: "Ta"
};

function getAdvData() { return window.BIG_MEMORY.adv_data; }
function saveAdvData(data) {
    window.BIG_MEMORY.adv_data = data;
    if (typeof idb !== 'undefined') idb.put('universal_store', { id: 'adv_data', data: data });
    updateAdvUI();
}

// 2. Âú∫ÊôØÈÖçÁΩÆ (Âê´ËÇ°Á•®ÂäüËÉΩ)
const ADV_SCENES = {
    'main_map': {
        bg: 'https://i.postimg.cc/g0nxYFxL/IMG_2008.png',
        buttons: [
 { text: 'üè∞ Â±±Â∫ÑÂà´Â¢Ö', pos: 'pos-top-left', action: 'logic:enter_villa_check' }, // Êñ∞Â¢û
            { text: 'üíç Ê∞ëÊîøÂ±Ä', pos: 'pos-top-right', style:'top:30%; right:10%;', action: 'goto:civil_bureau' }, 
            { text: 'üè´ Â≠¶Ê†°', pos: 'pos-center', action: 'goto:school_main' },
            { text: 'üå≥ ÂÖ¨Âõ≠', pos: 'pos-top-left', style:'left:10%; top:40%;', action: 'goto:park' },
            { text: '‚úàÔ∏è ÊóÖË°åÁ§æ', pos: 'pos-btm-left', action: 'goto:travel_main' },
            { text: 'üè† ÂõûÂÆ∂', pos: 'pos-top-right', action: 'goto:home_room' },
            { text: 'üõçÔ∏è ÂïÜÂú∫', pos: 'pos-btm-right', action: 'goto:mall_main' }
        ]
    },
    'school_main': {
        bg: 'https://i.postimg.cc/NG15Gx0f/IMG_1989.png',
        buttons: [
            { text: 'ÊïôÂ≠¶Ê•º', pos: 'pos-top-mid', action: 'goto:school_corridor' },
            { text: 'ÊìçÂú∫', pos: 'pos-top-left', action: 'goto:school_ground' },
            { text: '‰ΩìËÇ≤È¶Ü', pos: 'pos-top-right', style:'right:20%; top:40%;', action: 'goto:school_gym' },
            { text: 'Â§ßÁ§ºÂ†Ç', pos: 'pos-center', style:'left:20%;', action: 'goto:school_hall' },
            { text: '‚¨ÖÔ∏è Á¶ªÂºÄ', pos: 'pos-btm-mid', action: 'goto:main_map' }
        ]
    },
    'school_corridor': {
        bg: 'https://i.postimg.cc/7Lf5x85V/IMG_2004.png',
        buttons: [
            { text: 'Áè≠Á∫ß', pos: 'pos-top-left', action: 'goto:class_room' },
            { text: 'Âé®ÊàøËØæ', pos: 'pos-top-right', action: 'goto:class_kitchen' },
            { text: 'Èí¢Áê¥ËØæ', pos: 'pos-btm-left', action: 'goto:class_piano' },
            { text: 'ÁîªÂÆ§', pos: 'pos-btm-right', action: 'goto:class_art' },
            { text: 'üîô ËøîÂõû', pos: 'pos-btm-mid', action: 'goto:school_main' }
        ]
    },
    'class_room': {
        bg: 'https://i.postimg.cc/bvWsrCbj/IMG_1999.png',
        buttons: [
            { text: 'üìö Â≠¶‰π†', pos: 'pos-center', style:'top:30%', action: 'logic:study' },
            { text: 'üò∂ ÂèëÂëÜ', pos: 'pos-center', style:'top:50%', action: 'logic:daydream' },
            { text: 'üìÑ ‰º†Á∫∏Êù°', pos: 'pos-center', style:'top:70%', action: 'logic:pass_note' },
            { text: 'üîô Á¶ªÂºÄ', pos: 'pos-btm-mid', action: 'goto:school_corridor' }
        ]
    },
    'class_kitchen': {
        bg: 'https://i.postimg.cc/nLgCrRmS/IMG_2002.png',
        buttons: [
            { text: 'üç≥ ÂÅöÊñôÁêÜ', pos: 'pos-center', style:'top:40%', action: 'logic:cook_food' },
            { text: 'üç∞ ÂÅöÁîúÂìÅ', pos: 'pos-center', style:'top:60%', action: 'logic:cook_sweet' },
            { text: 'üîô Á¶ªÂºÄ', pos: 'pos-btm-mid', action: 'goto:school_corridor' }
        ]
    },
    'class_piano': {
        bg: 'https://i.postimg.cc/25MVycWs/IMG_2001.png',
        buttons: [
            { text: 'üéπ ÁªÉÁê¥', pos: 'pos-center', style:'top:40%', action: 'logic:learn_music' },
            { text: 'üéº ÂêàÂ•è', pos: 'pos-center', style:'top:60%', action: 'logic:play_piano_together' },
            { text: 'üîô Á¶ªÂºÄ', pos: 'pos-btm-mid', action: 'goto:school_corridor' }
        ]
    },
    'class_art': {
        bg: 'https://i.postimg.cc/vmc4QF1w/IMG_2003.png',
        buttons: [
            { text: 'üé® ÁªÉÁîª', pos: 'pos-center', style:'top:40%', action: 'logic:practice_draw' },
            { text: '‚úèÔ∏è Á¥†Êèè', pos: 'pos-center', style:'top:60%', action: 'logic:sketch' },
            { text: 'üîô Á¶ªÂºÄ', pos: 'pos-btm-mid', action: 'goto:school_corridor' }
        ]
    },
    'school_hall': { bg: 'https://i.postimg.cc/XvprVSrK/IMG_2005.png', buttons: [{text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:school_main'}] },
    'school_gym': { 
        bg: 'https://i.postimg.cc/R0NWM5Wc/IMG_2006.png', 
        buttons: [
            {text:'ÁæΩÊØõÁêÉ', pos:'pos-list-left', action:'logic:sport'},
            {text:'ÁΩëÁêÉ', pos:'pos-list-left', style:'top:25%', action:'logic:sport'},
            {text:'Ê∏∏Ê≥≥', pos:'pos-list-left', style:'top:40%', action:'logic:sport'},
            {text:'ÂºìÈÅì', pos:'pos-list-left', style:'top:55%', action:'logic:sport'},
            {text:'üîô Á¶ªÂºÄ', pos:'pos-btm-mid', action:'goto:school_main'}
        ] 
    },
    'school_ground': { 
        bg: 'https://i.postimg.cc/43mYJkYp/IMG_2007.png', 
        buttons: [
            {text:'üèÉ Ë∑ëÊ≠•', pos:'pos-center', style:'top:40%', action:'logic:sport'},
            {text:'üèÄ ÁØÆÁêÉ', pos:'pos-center', style:'top:60%', action:'logic:sport'},
            {text:'üèê ÊéíÁêÉ', pos:'pos-center', style:'top:20%', action:'logic:sport'},
            {text:'üîô Á¶ªÂºÄ', pos:'pos-btm-mid', action:'goto:school_main'}
        ] 
    },
    'mall_main': {
        bg: 'https://i.postimg.cc/TYfhKWyT/IMG_1988.png',
        buttons: [
{text:'üíÖ ÁæéÁî≤Â∫ó', pos:'pos-center', style:'top:30%', action:'goto:mall_nail'}, // Êñ∞Â¢ûÂÖ•Âè£
          
            {text:'üéÅ Á§ºÁâ©Â∫ó', pos:'pos-list-left', action:'goto:mall_gift'},
            {text:'üëó ÊúçË£ÖÂ∫ó', pos:'pos-list-left', style:'top:25%', action:'goto:mall_clothes'},
            {text:'üç∞ ÁîúÂìÅÂ∫ó', pos:'pos-list-left', style:'top:40%', action:'goto:mall_sweet'},
            {text:'üõçÔ∏è ÈÄõË°ó', pos:'pos-list-left', style:'top:55%', action:'goto:mall_walk'},
            {text:'üç¢ Â∞èÂêÉË°ó', pos:'pos-list-left', style:'top:70%', action:'goto:mall_food'},
            {text:'‚¨ÖÔ∏è Á¶ªÂºÄ', pos:'pos-btm-mid', action:'goto:main_map'}
        ]
    },
    'mall_gift': { bg:'https://i.postimg.cc/26W3ZQFv/IMG_1996.png', buttons:[{text:'‰π∞Á§ºÁâ©(5Èáë)', pos:'pos-center', action:'logic:buy_gift'}, {text:'ÊâìÂ∑•', pos:'pos-center', style:'top:65%', action:'logic:work_gift'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:mall_main'}]},
    'mall_clothes': { bg:'https://i.postimg.cc/7hyhM5mn/IMG_1994.png', buttons:[{text:'‰π∞Ë°£Êúç(ÈöèÊú∫)', pos:'pos-center', action:'logic:buy_clothes'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:mall_main'}]},
    'mall_sweet': { 
        bg:'https://i.postimg.cc/zBh3gCSw/IMG_1995.png', 
        buttons:[
            {text:'üç´ ÂÅöÂ∑ßÂÖãÂäõ', pos:'pos-center', style:'top:30%', action:'logic:open_choco_game'}, // Êñ∞Â¢û
            {text:'‰π∞È´òÁ∫ßÁîúÂìÅ(8Èáë)', pos:'pos-center', action:'logic:buy_sweet'}, 
            {text:'‰∏ÄËµ∑ÂÅöÁîúÂìÅ', pos:'pos-center', style:'top:65%', action:'logic:make_sweet_together'}, 
            {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:mall_main'}
        ]
    },
    'mall_walk': { bg:'https://i.postimg.cc/bJndtxHJ/IMG_1997.png', buttons:[{text:'‰∏ÄËµ∑ÈÄõË°ó', pos:'pos-center', action:'logic:walk_together'}, {text:'Ëá™Â∑±ÈÄõË°ó', pos:'pos-center', style:'top:65%', action:'logic:walk_alone'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:mall_main'}]},
    'mall_food': { bg:'https://i.postimg.cc/8khjkbzn/IMG_1990.png', buttons:[{text:'ÂêÉÁÇπÂ∞èÂêÉ', pos:'pos-center', action:'logic:eat_snack'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:mall_main'}]},
      'travel_main': {
        bg: 'https://i.postimg.cc/wjxtGsg6/IMG_2015.png',
        buttons: [
            // ‰øÆÊîπÁÇπÔºöaction ‰ªé logic:travel Êîπ‰∏∫ goto:ÂÖ∑‰ΩìÂú∫ÊôØÂêç
            {text:'üèØ ÊïÖÂÆ´', pos:'pos-list-left', action:'goto:travel_gugong'},
            {text:'üåä Êµ∑Ëæπ', pos:'pos-list-left', style:'top:22%', action:'goto:travel_seaside'},
            {text:'üóº ‰∏ú‰∫¨', pos:'pos-list-left', style:'top:34%', action:'goto:travel_tokyo'},
            {text:'üè∞ Ê≥ïÂõΩ', pos:'pos-list-left', style:'top:46%', action:'goto:travel_france'},
            {text:'üá¨üáß Ëã±ÂõΩ', pos:'pos-list-left', style:'top:58%', action:'goto:travel_uk'},
            {text:'üá∫üá∏ ÁæéÂõΩ', pos:'pos-list-left', style:'top:70%', action:'goto:travel_usa'},
            {text:'‚¨ÖÔ∏è Á¶ªÂºÄ', pos:'pos-btm-mid', action:'goto:main_map'}
        ]
    },
    
    // --- ‰∏ãÈù¢ÊòØÊñ∞Â¢ûÁöÑ 6 ‰∏™Âú∞ÁÇπÂú∫ÊôØ ---
    // ÊäÄÂ∑ßÔºö‰∏≠Èó¥ÁöÑÊåâÈíÆÁªëÂÆö 'logic:travel'ÔºåËøôÊ†∑Êó¢ËÉΩÊâ£Èí±Ôºå‰πüËÉΩËá™Âä®Ëß¶Âèë‰Ω†‰ª£Á†ÅÈáåÂ∑≤ÊúâÁöÑ 15% ÈöèÊú∫‰∫ã‰ª∂ÈÄªËæë
    
    'travel_gugong': {
        bg: 'https://i.postimg.cc/VksSVbmk/IMG_2013.png',
        buttons: [
            { text: 'üì∏ Ê∏∏Áé©ÊâìÂç° (1Èáë)', pos: 'pos-center', action: 'logic:travel' },
            { text: 'üîô ÂõûÂà∞ÊóÖË°åÁ§æ', pos: 'pos-btm-mid', action: 'goto:travel_main' }
        ]
    },
    'travel_seaside': {
        bg: 'https://i.postimg.cc/3xrycDYJ/IMG_2014.png',
        buttons: [
            { text: 'üèñÔ∏è Ê∏∏Áé©ÊâìÂç° (1Èáë)', pos: 'pos-center', action: 'logic:travel' },
            { text: 'üîô ÂõûÂà∞ÊóÖË°åÁ§æ', pos: 'pos-btm-mid', action: 'goto:travel_main' }
        ]
    },
    'travel_tokyo': {
        bg: 'https://i.postimg.cc/XY2ZS7Yy/IMG_2012.png',
        buttons: [
            { text: 'üóº Ê∏∏Áé©ÊâìÂç° (1Èáë)', pos: 'pos-center', action: 'logic:travel' },
            { text: 'üîô ÂõûÂà∞ÊóÖË°åÁ§æ', pos: 'pos-btm-mid', action: 'goto:travel_main' }
        ]
    },
    'travel_france': {
        bg: 'https://i.postimg.cc/7ZBC8YZf/IMG_2011.png',
        buttons: [
            { text: 'üè∞ Ê∏∏Áé©ÊâìÂç° (1Èáë)', pos: 'pos-center', action: 'logic:travel' },
            { text: 'üîô ÂõûÂà∞ÊóÖË°åÁ§æ', pos: 'pos-btm-mid', action: 'goto:travel_main' }
        ]
    },
    'travel_uk': {
        bg: 'https://i.postimg.cc/rwhdXFwW/IMG_2010.png',
        buttons: [
            { text: 'üá¨üáß Ê∏∏Áé©ÊâìÂç° (1Èáë)', pos: 'pos-center', action: 'logic:travel' },
            { text: 'üîô ÂõûÂà∞ÊóÖË°åÁ§æ', pos: 'pos-btm-mid', action: 'goto:travel_main' }
        ]
    },
    'travel_usa': {
        bg: 'https://i.postimg.cc/SxZXFNxc/IMG_2009.png',
        buttons: [
            { text: 'üóΩ Ê∏∏Áé©ÊâìÂç° (1Èáë)', pos: 'pos-center', action: 'logic:travel' },
            { text: 'üîô ÂõûÂà∞ÊóÖË°åÁ§æ', pos: 'pos-btm-mid', action: 'goto:travel_main' }
        ]
    },
    'park': {
        bg: 'https://i.postimg.cc/P5fLR8Tq/IMG_2016.png',
        buttons: [
            {text:'üö∂ Êï£Ê≠•', pos:'pos-center', action:'logic:park_walk'},
            {text:'‚¨ÖÔ∏è Á¶ªÂºÄ', pos:'pos-btm-mid', action:'goto:main_map'}
        ]
    },
    'home_room': {
        bg: 'https://i.postimg.cc/6qL3HBPK/IMG_1992.png',
        buttons: [
            {text:'üöø ÂéªÊµ¥ÂÆ§', pos:'pos-list-left', action:'goto:home_bath'},
            {text:'üëó Êç¢Ë°£Èó¥', pos:'pos-list-left', style:'top:25%', action:'goto:home_closet'},
            {text:'üìà ËÇ°Á•®', pos:'pos-list-left', style:'top:40%', action:'logic:stock_market'},
            {text:'üí∞ ÂâØ‰∏ö', pos:'pos-list-left', style:'top:55%', action:'logic:side_job'},
            {text:'‚¨ÖÔ∏è Á¶ªÂºÄ', pos:'pos-btm-mid', action:'goto:main_map'}
        ]
    },
    'home_bath': { 
        bg:'https://i.postimg.cc/J0W0csPd/IMG_1993.png', 
        buttons:[
            {text:'üõÅ Ê≥°Êæ°(+10Ê∏ÖÊ¥Å)', pos:'pos-center', action:'logic:bath_normal'}, 
            {text:'üîô ÂõûÊàøÈó¥', pos:'pos-btm-mid', action:'goto:home_room'}
        ]
    }, 
// ... (Âú® home_bath ÁöÑÂÆö‰πâ‰πãÂêéËøΩÂä†) ...

    // === üè∞ Êñ∞Âú∫ÊôØÔºöÂ±±Â∫ÑÂà´Â¢Ö ===
    'villa_gate': {
        // ËøôÈáåÁî®‰∏ÄÂº†ÈÄöÁî®ËÉåÊôØÊàñ‰∏ªÈ°µËÉåÊôØ‰Ωú‰∏∫ËøáÊ∏°ÔºåÂÆûÈôÖ‰∏äÈÄªËæë‰ºöÊã¶Êà™
        bg: 'https://i.postimg.cc/9QyCXRZQ/IMG_2142.png', 
        buttons: [
            { text: 'üö™ ËøõÂÖ•Âà´Â¢Ö', pos: 'pos-center', action: 'logic:enter_villa_check' },
            { text: 'üîô ËøîÂõûÂú∞Âõæ', pos: 'pos-btm-mid', action: 'goto:main_map' }
        ]
    },
    'villa_main': {
        bg: 'https://i.postimg.cc/9QyCXRZQ/IMG_2142.png',
        buttons: [
            { text: 'üõå ‰∏ªÂçß', pos: 'pos-list-left', action: 'goto:villa_bedroom' },
            { text: 'üèä ÁßÅ‰∫∫Ê≥≥Ê±†', pos: 'pos-list-left', style:'top:25%', action: 'goto:villa_pool' },
            { text: 'ü¶å ËçâÂù™', pos: 'pos-list-left', style:'top:40%', action: 'goto:villa_lawn' },
            { text: 'üçñ ÁÉßÁÉ§Âå∫', pos: 'pos-list-left', style:'top:55%', action: 'goto:villa_bbq' },
            { text: 'üê† Ê∞¥ÊóèÈ¶Ü', pos: 'pos-list-left', style:'top:70%', action: 'goto:villa_aqua' },
            { text: 'üîô Á¶ªÂºÄ', pos: 'pos-btm-mid', action: 'goto:main_map' }
        ]
    },
    'villa_bedroom': { bg:'https://i.postimg.cc/yNBBD1y0/IMG_2140.png', buttons:[{text:'‰∫§Áâ©‰∏öË¥π(-270)', pos:'pos-center', action:'logic:villa_fee'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:villa_main'}]},
    'villa_pool': { bg:'https://i.postimg.cc/htVc4zT4/IMG_2141.png', buttons:[{text:'üèä ‰∏ÄËµ∑Ê∏∏Ê≥≥', pos:'pos-center', action:'logic:villa_swim'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:villa_main'}]},
    'villa_lawn': { bg:'https://i.postimg.cc/9fVVDmYY/IMG_2139.png', buttons:[{text:'ü¶å ÂíåÂ∞èÈπøÁé©', pos:'pos-center', action:'logic:villa_play'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:villa_main'}]},
    'villa_bbq': { bg:'https://i.postimg.cc/fbKsXGHQ/IMG_2138.png', buttons:[{text:'üçñ ÁÉßÁÉ§', pos:'pos-center', action:'logic:villa_eat'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:villa_main'}]},
    'villa_aqua': { bg:'https://i.postimg.cc/C1rVrjTq/IMG_2137.png', buttons:[{text:'üê† ÈÄõÈÄõ', pos:'pos-center', action:'logic:villa_wander'}, {text:'üîô ËøîÂõû', pos:'pos-btm-mid', action:'goto:villa_main'}]},

    // === üíç Êñ∞Âú∫ÊôØÔºöÊ∞ëÊîøÂ±Ä ===
    // ÈÄªËæë‰ºöÂä®ÊÄÅÂà§Êñ≠ÊòæÁ§∫Â∑≤Â©ö/Êú™Â©öÁïåÈù¢ÔºåËøôÈáåÂÆö‰πâÂü∫Á°Ä
    'civil_bureau': {
        bg: 'https://i.postimg.cc/pXhP71dD/IMG_2143.png',
        buttons: [
            { text: '‚ù§Ô∏è ÂäûÁêÜ‰∏öÂä°', pos: 'pos-center', action: 'logic:civil_service' },
            { text: 'üîô ËøîÂõûÂú∞Âõæ', pos: 'pos-btm-mid', action: 'goto:main_map' }
        ]
    },

    // === üíÖ Êñ∞Âú∫ÊôØÔºöÁæéÁî≤Â∫ó ===
    'mall_nail': {
        bg: 'https://i.postimg.cc/L5qFcn20/IMG_2136.png',
        buttons: [
            { text: 'üíÖ ÂÅöÁæéÁî≤', pos: 'pos-list-left', action: 'logic:nail_self' },
            { text: 'üíñ ËÆ©‰ªñÂ∏ÆÂÅö', pos: 'pos-list-left', style:'top:30%', action: 'logic:nail_him' },
            { text: 'ü¶∂ ËÆ©‰ªñ‰øÆËÑö', pos: 'pos-list-left', style:'top:45%', action: 'logic:nail_feet' },
            { text: 'üé® Â∏Æ‰ªñÂÅö', pos: 'pos-list-left', style:'top:60%', action: 'logic:nail_reverse' },
            { text: 'üîô ËøîÂõû', pos: 'pos-btm-mid', action: 'goto:mall_main' }
        ]
    }
};

// 3. Ê†∏ÂøÉÈÄªËæëÂáΩÊï∞
async function openTextAdventure() {
    document.getElementById('adv-modal').style.display = 'flex';
    
    // ËØªÂèñ Line ËÆæÁΩÆ
    const settings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    ADV_CACHE.lineCharName = settings.title || "Ta";
    
    // È¢ÑÂä†ËΩΩÂ§¥ÂÉè
    try {
        const myRes = await idb.get('settings_heavy', 'myAvatar');
        const charRes = await idb.get('settings_heavy', 'botAvatar');
        if (myRes) ADV_CACHE.lineUserAvatar = myRes.data;
        if (charRes) ADV_CACHE.lineCharAvatar = charRes.data;
    } catch(e) {}

    // ÈáçÊñ∞Ê≥®ÂÖ•Á´ãÁªòÂ±Ç (Á°Æ‰øùÁªìÊûÑÊ≠£Á°Æ)
    // ÁßªÈô§ÊóßÂÆπÂô®Èò≤Ê≠¢ÈáçÂ§ç
    const oldTachie = document.getElementById('adv-tachie-layer');
    if(oldTachie) oldTachie.remove();

    // ÂàõÂª∫Êñ∞ÂÆπÂô®ÔºöÂåÖÂê´Â∑¶Á´ãÁªòÂíåÂè≥Á´ãÁªò
    const layer = document.createElement('div');
    layer.id = 'adv-tachie-layer';
    layer.innerHTML = `
        <img id="adv-tachie-user" class="adv-tachie-img tachie-left" src="">
        <img id="adv-tachie-char" class="adv-tachie-img tachie-right" src="">
    `;
    document.getElementById('adv-modal').appendChild(layer);

    updateAdvUI();
    renderAdvScene('main_map');
}

function closeTextAdventure() {
    document.getElementById('adv-modal').style.display = 'none';
}

// üî• ÂÖ≥ÈîÆÂáΩÊï∞ÔºöÈöêËóèÂØπËØùÊ°ÜÊó∂ÔºåÂêåÊó∂ÈöêËóèÁ´ãÁªò
function hideAdvDialog() {
    document.getElementById('adv-dialog-box').style.display = 'none';
    document.getElementById('adv-tachie-user').style.display = 'none';
    document.getElementById('adv-tachie-char').style.display = 'none';
}

function updateAdvUI() {
    const data = getAdvData();
    // È°∂ÈÉ®Â∞èÂ§¥ÂÉèÔºöÊòæÁ§∫ Line Áî®Êà∑Â§¥ÂÉè
    const avatarEl = document.getElementById('adv-user-avatar');
    if (ADV_CACHE.lineUserAvatar) avatarEl.style.backgroundImage = `url(${ADV_CACHE.lineUserAvatar})`;
    else avatarEl.style.backgroundColor = '#ccc';
    
    document.getElementById('adv-user-name').innerText = data.name;
    document.getElementById('adv-stat-clean').innerText = Math.floor(data.cleanliness);
    document.getElementById('adv-stat-money').innerText = Math.floor(data.money);
}

function renderAdvScene(sceneId) {
    if (sceneId === 'home_closet') { renderClosetUI(); return; }

    const scene = ADV_SCENES[sceneId];
    if(!scene) return;

    const container = document.getElementById('adv-scene-container');
    container.innerHTML = ''; 
    container.style.backgroundImage = `url(${scene.bg})`;
    
    // ÁªëÂÆöÁÇπÂáªËÉåÊôØÈöêËóèÂØπËØùÊ°Ü‰∫ã‰ª∂
    container.onclick = () => hideAdvDialog();

    if(scene.buttons) {
        scene.buttons.forEach(btnConfig => {
            const btn = document.createElement('div');
            btn.className = `adv-btn ${btnConfig.pos || ''}`;
            btn.innerText = btnConfig.text;
            if(btnConfig.style) btn.style.cssText += btnConfig.style;
            btn.onclick = (e) => { 
                e.stopPropagation(); // ÈòªÊ≠¢ÂÜíÊ≥°Âà∞ËÉåÊôØ
                handleAdvAction(btnConfig.action); 
            };
            container.appendChild(btn);
        });
    }
    
    hideAdvDialog(); // ÂàáÊç¢Âú∫ÊôØÊó∂ÈöêËóè
}

function handleAdvAction(actionString) {
    const [type, val] = actionString.split(':');
    if (type === 'goto') renderAdvScene(val);
    else if (type === 'logic') executeAdvLogic(val);
}

function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function modAdv(updates, costClean = true) {
    const data = getAdvData();
    
    // 1. Ë°åÂä®Ê∂àËÄóÊ∏ÖÊ¥ÅÂ∫¶
    if (costClean) data.cleanliness = Math.max(0, data.cleanliness - 3);
    
    // 2. Êõ¥Êñ∞Â±ûÊÄß
    for (let key in updates) {
        if (typeof updates[key] === 'object') {
            for (let subKey in updates[key]) data[key][subKey] = (data[key][subKey] || 0) + updates[key][subKey];
        } else {
            data[key] = (data[key] || 0) + updates[key];
        }
    }
    
    // üî•„Äê‰øÆÂ§çË°•‰∏Å„ÄëÂº∫Âà∂Â∞ÜÊ∏ÖÊ¥ÅÂ∫¶ÈôêÂà∂Âú® 0 Âà∞ 100 ‰πãÈó¥
    if (data.cleanliness < 0) data.cleanliness = 0;
    if (data.cleanliness > 100) data.cleanliness = 100;
    
    saveAdvData(data);
}

function advAddItem(name, count=1, itemType='item') {
    const data = getAdvData();
    if (!data.inventory) data.inventory = [];
    let existing = data.inventory.find(i => i.name === name);
    if (existing) existing.count += count;
    else data.inventory.push({ name: name, count: count, type: itemType });
    saveAdvData(data);
}
// ==================== üõ†Ô∏è ÂêçÂ≠óÊòæÁ§∫‰øÆÂ§çË°•‰∏Å ====================
window.showAdvDialog = function(text, talkerType) {
    const box = document.getElementById('adv-dialog-box');
    box.style.display = 'flex';
    
    const nameEl = document.getElementById('adv-dialog-name');
    const textEl = document.getElementById('adv-dialog-text');
    const iconDiv = document.getElementById('adv-dialog-img');
    
    // Ëé∑ÂèñÁ´ãÁªòÂÖÉÁ¥†
    const userTachie = document.getElementById('adv-tachie-user');
    const charTachie = document.getElementById('adv-tachie-char');
    
    // üî• Ê†∏ÂøÉ‰øÆÊîπÔºöËé∑ÂèñÂÆûÊó∂Â≠òÊ°£Êï∞ÊçÆ
    const data = getAdvData(); 
    // ‰ºòÂÖàËØªÂèñÊõ¥Ë°£ÂÆ§ËÆæÁΩÆÁöÑÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÁî®ÈªòËÆ§ÁöÑ "Ta"
    const savedCharName = data.charName || "Ta";
    const savedUserName = data.name || "Áé©ÂÆ∂";

    if (talkerType === "System") {
        // === Áé©ÂÆ∂Ë°å‰∏∫/Á≥ªÁªüÊèêÁ§∫ ===
        nameEl.innerText = savedUserName; // ‰ΩøÁî®Â≠òÊ°£ÁöÑÁé©ÂÆ∂Âêç
        nameEl.style.color = "#ffffff";   // Áé©ÂÆ∂ÂêçÂ≠óÈ¢úËâ≤
        
        // Â∑¶ËæπÂ∞èÂ§¥ÂÉèÔºöLine Áî®Êà∑Â§¥ÂÉè
        if (typeof ADV_CACHE !== 'undefined' && ADV_CACHE.lineUserAvatar) {
            iconDiv.style.backgroundImage = `url(${ADV_CACHE.lineUserAvatar})`;
        } else {
            iconDiv.style.backgroundColor = '#ccc';
        }
        
        // ÊòæÁ§∫Â∑¶‰æßÁ´ãÁªò (Áî®Êà∑‰∏ä‰º†ÁöÑ)ÔºåÈöêËóèÂè≥‰æß
        if (data.avatars && data.avatars.user) {
            userTachie.src = data.avatars.user;
            userTachie.style.display = 'block';
        } else {
            userTachie.style.display = 'none';
        }
        if(charTachie) charTachie.style.display = 'none';

    } else {
        // === ËßíËâ≤ËØ¥ËØù (Character) ===
        nameEl.innerText = savedCharName; // üî• ËøôÈáåÊîπÊàê‰∫ÜËØªÂèñÊõ¥Ë°£ÂÆ§ÂêçÂ≠ó
        nameEl.style.color = "#f1c40f";   // ËßíËâ≤ÂêçÂ≠óÈ´ò‰∫ÆËâ≤
        
        // Â∑¶ËæπÂ∞èÂ§¥ÂÉèÔºöLine ËßíËâ≤Â§¥ÂÉè
        if (typeof ADV_CACHE !== 'undefined' && ADV_CACHE.lineCharAvatar) {
            iconDiv.style.backgroundImage = `url(${ADV_CACHE.lineCharAvatar})`;
        } else {
            iconDiv.style.backgroundColor = '#a29bfe';
        }
        
        // ÊòæÁ§∫Âè≥‰æßÁ´ãÁªò (ËßíËâ≤‰∏ä‰º†ÁöÑ)ÔºåÈöêËóèÂ∑¶‰æß
        if (data.avatars && data.avatars.char) {
            charTachie.src = data.avatars.char;
            charTachie.style.display = 'block';
        } else {
            if(charTachie) charTachie.style.display = 'none';
        }
        if(userTachie) userTachie.style.display = 'none';
    }
    
    textEl.innerText = text;
};
// 5. ÈÄªËæëÂà§Êñ≠
function executeAdvLogic(logicKey) {
    const data = getAdvData();
    let msg = "";
    let talker = "System"; // ÈªòËÆ§Áé©ÂÆ∂Ë°å‰∏∫

    if (data.cleanliness <= 0 && !['bath_normal', 'home_room'].includes(logicKey)) {
        return showAdvDialog("‰Ω†Â§™Á¥Ø‰∫ÜÔºåÂÖàÂéªÊ¥ó‰∏™Êæ°ÂêßÔºÅ", "System");
    }

    switch(logicKey) {
        // ËÇ°Á•®
        case 'stock_market':
            const isUp = Math.random() > 0.5;
            const percent = 0.10;
            const change = Math.floor(data.money * percent);
            if (isUp) { modAdv({ money: change }, false); msg = `üìà ËÇ°Â∏ÇÂ§ßÊ∂®ÔºÅËµÑ‰∫ßÂ¢ûÂä† ${change} ÈáëÈí±„ÄÇ`; } 
            else { modAdv({ money: -change }, false); msg = `üìâ ËÇ°Â∏ÇÊö¥Ë∑å... ‰∫èÊçü‰∫Ü ${change} ÈáëÈí±„ÄÇ`; }
            break;

        case 'study': modAdv({ attributes: { learning: rnd(1,3) } }); msg = `ËÆ§ÁúüÂ≠¶‰π†ÔºåÂ≠¶‰π†Â±ûÊÄß‰∏äÂçá„ÄÇ`; break;
        case 'daydream': msg = ["‰Ω†Êµ™Ë¥π‰∫Ü‰∏ÄËäÇËØæ„ÄÇ", "ÂèëÂëÜÁúãÁ™óÂ§ñÁöÑÂ∞èÈ∏ü„ÄÇ", "Ë¢´ËÄÅÂ∏àÂè´Ëµ∑Êù•ÁΩöÁ´ô„ÄÇ"][rnd(0,2)]; break;
        case 'pass_note':
            const aff = rnd(1, 7); modAdv({ affection: aff });
            const notes = ["‰Ω†‰ª¨‰ø©Ë¢´ËÄÅÂ∏àÁΩöÁ´ô‰∫Ü„ÄÇ", "Áà±‰Ω†„ÄÇ", "‰∏ãËØæ‰∏ÄËµ∑ÂéªÂêÉÈ•≠ÂêóÔºü"];
            msg = notes[rnd(0,2)] + ` (Â•ΩÊÑü+${aff})`;
            if(msg.includes("ËßíËâ≤")) talker = "Character";
            break;
        case 'learn_music': modAdv({ attributes: { talent: rnd(1,3) } }); msg = "Â≠¶‰π†Èü≥‰πêÔºåÊâçËâ∫ÊèêÂçá„ÄÇ"; break;
        case 'play_piano_together': modAdv({ attributes: { talent: 1 }, affection: 2 }); msg = "‰Ω†‰ª¨‰∏ÄËµ∑ÂºπÂ•è‰∫Ü‰∏ÄÊõ≤„ÄÇ"; talker = "Character"; break;
        case 'cook_food': 
            const f = rnd(0,3); modAdv({}); if(f>0) advAddItem("ÊñôÁêÜ",f,"food"); 
            msg = `ÂÅö‰∫Ü ${f} ‰ªΩÊñôÁêÜ„ÄÇ`; break;
        case 'cook_sweet': 
            const s = rnd(0,3); modAdv({}); if(s>0) advAddItem("ÁîúÂìÅ",s,"sweet"); 
            msg = `ÂÅö‰∫Ü ${s} ‰ªΩÁîúÂìÅ„ÄÇ`; break;
        case 'practice_draw': modAdv({ attributes: { art: rnd(1,3) } }); msg = "ÁªÉ‰π†Á¥†ÊèèÔºåÁîªÊäÄÊèêÂçá„ÄÇ"; break;
        case 'sketch': 
            modAdv({});
            if(Math.random()<0.3) msg = "ËÄÅÂ∏àËÆ©‰Ω†ÈáçÁîª„ÄÇ";
            else { modAdv({money:5}, false); msg = "Â∏ÆÂêåÂ≠¶Áîª‰Ωú‰∏öÔºåËµö‰∫Ü5Èáë„ÄÇ"; }
            break;
        case 'sport': modAdv({ attributes: { fitness: rnd(1,3) } }); msg = "Êå•Ê¥íÊ±óÊ∞¥Ôºå‰ΩìËÉΩÊèêÂçá„ÄÇ"; break;
        
        case 'buy_gift':
            if(data.money>=5){ modAdv({money:-5}); advAddItem("Á§ºÁâ©",1,"gift"); msg = "‰π∞Âà∞‰∫ÜÁ§ºÁâ©„ÄÇ"; } 
            else msg = "Èí±‰∏çÂ§ü„ÄÇ"; break;
        case 'work_gift': 
            const w = rnd(1,10); modAdv({money:w}); msg = `ÊâìÂ∑•Ëµö‰∫Ü ${w} Èáë„ÄÇ`; break;
        
        case 'buy_clothes':
            const c = rnd(1,6);
            if(data.money>=c){ modAdv({money:-c}); advAddItem("Ë°£Êúç",1,"clothes"); msg = `‰π∞Ë°£ÊúçËä±‰∫Ü ${c} Èáë„ÄÇ`; }
            else msg = "Èí±‰∏çÂ§ü‰π∞Ë°£Êúç„ÄÇ"; break;
        case 'open_choco_game':
            initChocoGame(); // ËøõÂÖ•Â∑ßÂÖãÂäõÊ∏∏Êàè
            return; // ÈòªÊ≠¢ÂêéÁª≠ÈªòËÆ§ÈÄªËæë
        
        case 'buy_sweet':
            if(data.money>=8){ modAdv({money:-8}); advAddItem("È´òÁ∫ßÁîúÂìÅ",1,"high_sweet"); msg = "‰π∞‰∫ÜÈ´òÁ∫ßÁîúÂìÅ„ÄÇ"; }
            else msg = "Èí±‰∏çÂ§ü„ÄÇ"; break;
        case 'make_sweet_together':
            const ms = rnd(0,2); modAdv({}); if(ms>0) advAddItem("È´òÁ∫ßÁîúÂìÅ",ms,"high_sweet");
            msg = `‰∏ÄËµ∑ÂÅöÁîúÂìÅÔºåÊàêÂìÅ ${ms} ‰∏™„ÄÇ`; talker = "Character"; break;
        
        case 'walk_together':
            modAdv({affection:3}); msg = "‰∏ÄËµ∑ÈÄõË°óÂæàÂºÄÂøÉ„ÄÇ(Â•ΩÊÑü+3)"; talker = "Character"; break;
        case 'walk_alone':
            modAdv({money: rnd(1,3)}); msg = "Ëá™Â∑±ÈÄõË°óÊç°Âà∞‰∫ÜÈí±„ÄÇ"; break;
        case 'eat_snack':
            advAddItem("ÊñôÁêÜ",1,"food"); modAdv({}); msg = "ÂêÉ‰∫ÜÂ∞èÂêÉÔºåÊâìÂåÖ‰∫Ü‰∏Ä‰ªΩÊñôÁêÜ„ÄÇ"; break;
        case 'travel':
            if(data.money>=1){ modAdv({money:-1, affection:5}); msg = "ÊóÖÈÄîÊÑâÂø´„ÄÇ(Â•ΩÊÑü+5)"; talker = "Character"; }
            else msg = "Ê≤°Èí±ÊóÖÊ∏∏„ÄÇ"; break;
        case 'park_walk':
            modAdv({affection:2}); msg = "ÂÖ¨Âõ≠Êï£Ê≠•„ÄÇ(Â•ΩÊÑü+2)"; talker = "Character"; break;
        case 'bath_normal':
            data.cleanliness = 100; saveAdvData(data); msg = "Ê¥óÊæ°ÁªìÊùüÔºåÁ≤æÁ•ûÁÑïÂèë„ÄÇ"; break;
        case 'side_job':
            const max = Math.max(data.attributes.learning, data.attributes.art, data.attributes.talent, data.attributes.fitness);
            const sal = max > 100 ? 15 : (max > 50 ? 9 : (max > 25 ? 6 : 3));
            modAdv({money:sal}); msg = `ÂÅöÂâØ‰∏öËµö‰∫Ü ${sal} Èáë„ÄÇ`; break;
        // ======= ‚¨áÔ∏è Âú® case 'side_job' ‰∏ãÈù¢ÊèíÂÖ•Ëøô‰∫õÊñ∞‰ª£Á†Å ‚¨áÔ∏è =======

        // === üè∞ Âà´Â¢ÖÈÄªËæë ===
        case 'enter_villa_check':
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ë¥≠‰π∞ (ÈúÄË¶ÅÂú®Êï∞ÊçÆ‰∏≠ËÆ∞ÂΩïÔºåÂ¶ÇÊûúÊ≤°ÊúâËÆ∞ÂΩïÈªòËÆ§‰∏∫false)
            if (data.unlocked_villa) {
                renderAdvScene('villa_main');
            } else {
                if (data.money >= 700) {
                    if(confirm("Ëß£ÈîÅÂ±±Â∫ÑÂà´Â¢ÖÈúÄË¶Å 700 ÈáëÈí±ÔºåÁ°ÆÂÆöË¥≠‰π∞ÂêóÔºü")) {
                        modAdv({money: -700}, false);
                        data.unlocked_villa = true;
                        saveAdvData(data);
                        alert("üéâ ÊÅ≠ÂñúÔºÅÊÇ®Â∑≤Êã•ÊúâÁßÅ‰∫∫Â±±Â∫ÑÂà´Â¢ÖÔºÅ");
                        renderAdvScene('villa_main');
                    }
                } else {
                    showAdvDialog(`ÈáëÈí±‰∏çË∂≥ÔºÅÈúÄË¶Å 700ÔºåÂΩìÂâçÂè™Êúâ ${Math.floor(data.money)}„ÄÇ`, "System");
                }
            }
            break;
        case 'villa_fee':
            if(data.money >= 270) {
                modAdv({money: -270});
                handleRandomEvent("ÊàëÁº¥Á∫≥‰∫ÜÂà´Â¢ÖÁâ©‰∏öË¥π", "ÊîØ‰ªò‰∫ÜÊòÇË¥µÁöÑÁâ©‰∏öË¥πÔºåÂøÉÂú®Êª¥Ë°ÄÔºå‰ΩÜ‰∫´Âèó‰∫ÜÂ∞äË¥µÁöÑÊúçÂä°„ÄÇ");
            } else msg = "Ê≤°Èí±‰∫§Áâ©‰∏öË¥π‰∫Ü...";
            break;
        case 'villa_swim':
            handleRandomEvent("Êàë‰ª¨Âú®ÁßÅ‰∫∫Ê≥≥Ê±†Ê∏∏Ê≥≥", "‰Ω†‰ª¨Ê≥°‰∫Ü‰∏Ä‰ºöÂÑøÔºåÊ∞¥Ê∏©ÂàöÂàöÂ•Ω„ÄÇ", {affection: 20});
            break;
        case 'villa_play':
            handleRandomEvent("Âú®ËçâÂù™‰∏äÂíåÂ∞èÂä®Áâ©Áé©", "‰Ω†‰ª¨Âú®ËçâÂù™‰∏äËøΩÈÄêÁùÄÂ∞èÁæä„ÄÅÂ∞èÈπøÁé©ÁöÑ‰∏ç‰∫¶‰πê‰πé„ÄÇ", {cleanliness: 100}); 
            if(Math.random()>0.85) data.cleanliness = 100; 
            break;
        case 'villa_eat':
            handleRandomEvent("Êàë‰ª¨Âú®Âà´Â¢ÖÂå∫ÁÉßÁÉ§", "‰∏ÄËµ∑Âú®Âà´Â¢ÖÁÉ§ÂíåÂêÉÁÉßÁÉ§ÔºåÂë≥ÈÅìÁúü‰∏çÈîô„ÄÇ", {affection: 15});
            break;
        case 'villa_wander':
            handleRandomEvent("ÂèÇËßÇÁßÅ‰∫∫Ê∞¥ÊóèÈ¶Ü", "‰Ω†‰ª¨Âú®‰Ω†‰ª¨ÁöÑÁßÅ‰∫∫Ê∞¥ÊóèÈ¶ÜÁé©‰∫Ü‰∏Ä‰ºöÂÑø„ÄÇ", {cleanliness: -5});
            break;

        // === üíÖ ÁæéÁî≤ÈÄªËæë ===
        case 'nail_self':
            modAdv({cleanliness: 10}); msg = "ÂÅö‰∫Ü‰∏™Á≤æËá¥ÁöÑÁæéÁî≤ÔºåÂøÉÊÉÖÂèòÂ•Ω‰∫Ü„ÄÇ(Ê∏ÖÊ¥Å+10)"; break;
        case 'nail_him':
            modAdv({affection: 5}); msg = "Áî±‰ªñÂ∏Æ‰Ω†ÂÅö‰∫ÜÁæéÁî≤ÔºåËôΩÁÑ∂ÊúâÁÇπÁ¨®Êãô‰ΩÜÂæàÊ∏©Êüî„ÄÇ(Â•ΩÊÑü+5)"; talker = "Character"; break;
        case 'nail_feet':
            modAdv({affection: 5}); msg = "‰Ω†ËÆ©‰ªñÂ∏ÆÂøôÊ∂ÇËÑöÊåáÁî≤Ê≤πÔºåÊúâ‰∫õÂÆ≥Áæû„ÄÇ(Â•ΩÊÑü+5)"; talker = "Character"; break;
        case 'nail_reverse':
            modAdv({affection: 5}); msg = "‰Ω†ÁúãÁùÄtaÁöÑÊâãÁ™ÅÂèëÂ•áÊÉ≥Â∏Æ‰ªñÂÅöÁæéÁî≤Ôºå‰ªñÊó†Â•àÂú∞Êé•Âèó‰∫Ü„ÄÇ(Â•ΩÊÑü+5)"; talker = "Character"; break;

        // === üíç Ê∞ëÊîøÂ±ÄÂÖ•Âè£ÈÄªËæë ===
        case 'civil_service':
            if (data.isMarried) {
                // Â∑≤Â©ö -> Á¶ªÂ©öÊµÅÁ®ã
                if(confirm("üíî Á°ÆÂÆöË¶ÅÂäûÁêÜÁ¶ªÂ©öÊâãÁª≠ÂêóÔºü")) {
                    callGlobalLLM("Êàë‰ª¨ÂéªÊ∞ëÊîøÂ±ÄÂäûÁêÜ‰∫ÜÁ¶ªÂ©öÊâãÁª≠ÔºåÁªìÊùü‰∫ÜËøôÊÆµÂ©öÂßª„ÄÇ", "event", "„ÄêÁâπÊÆäÊåá‰ª§„ÄëÊèèÂÜô‰∏§‰∫∫Âú®Ê∞ëÊîøÂ±ÄÁ¶ªÂ©öÁöÑÂú∫ÊôØÔºåÂ∏¶ÊúâÈÅóÊÜæÊàñÈáäÁÑ∂„ÄÇ");
                    data.isMarried = false;
                    saveAdvData(data);
                    // Âà∑Êñ∞‰∏Ä‰∏ãÊõ¥Ë°£ÂÆ§ÊòæÁ§∫Áä∂ÊÄÅ
                    if(document.querySelector('.closet-container')) renderClosetUI(); 
                }
            } else {
                // Êú™Â©ö -> ÁªìÂ©öÊµÅÁ®ã
                if(confirm("üíç Á°ÆÂÆöË¶ÅÂíå Ta ÁôªËÆ∞ÁªìÂ©öÂêóÔºü")) {
                    openMarriageCertificate(); // ÊâìÂºÄÁ≠æÂ≠óÁâà
                }
            }
            break;
            
        // ======= ‚¨ÜÔ∏è ÊèíÂÖ•ÁªìÊùü ‚¨ÜÔ∏è =======
    }
    
    if(msg) showAdvDialog(msg, talker);
}
// ËæÖÂä©Ôºö15% Ê¶ÇÁéáËß¶Âèë APIÔºåÂê¶ÂàôÊòæÁ§∫Âõ∫ÂÆöÊñáÊú¨
function handleRandomEvent(apiPrompt, staticText, statUpdates = {}) {
    // ÂÖàÊõ¥Êñ∞Â±ûÊÄß
    if (Object.keys(statUpdates).length > 0) modAdv(statUpdates);
    
    // Âà§ÂÆöÊ¶ÇÁéá
    if (Math.random() < 0.15) {
        checkDreamMode((ctx) => callGlobalLLM(apiPrompt, "random", ctx));
    } else {
        showAdvDialog(staticText, "System");
    }
}

// ÁªìÂ©öÁîªÂ∏ÉÈÄªËæë
let certCanvas, certCtx;
function openMarriageCertificate() {
    const modal = document.getElementById('marriage-cert-modal');
    modal.style.display = 'flex';
    
    // ÂàùÂßãÂåñÁîªÂ∏É
    certCanvas = document.getElementById('cert-canvas');
    certCtx = certCanvas.getContext('2d');
    
    // ÈÄÇÈÖçÂ±èÂπï
    const rect = certCanvas.getBoundingClientRect();
    certCanvas.width = rect.width;
    certCanvas.height = rect.height;
    
    certCtx.strokeStyle = "#000";
    certCtx.lineWidth = 3;
    certCtx.lineCap = "round";
    // === ÊèíÂÖ•ÂºÄÂßãÔºöÁªòÂà∂ËÉåÊôØÂõæ ===
    const bgImg = new Image();
    bgImg.crossOrigin = "Anonymous"; // ÂÖÅËÆ∏Ë∑®ÂüüÔºåÈò≤Ê≠¢‰øùÂ≠òÊä•Èîô
    bgImg.src = "https://i.postimg.cc/Nf9QVP0M/IMG_2144.jpg"; // ËØÅ‰π¶ÂéüÂõæÂú∞ÂùÄ
    bgImg.onload = () => {
        // Á°Æ‰øùÂõæÁâáÁîªÊª°Êï¥‰∏™ÁîªÂ∏É
        certCtx.drawImage(bgImg, 0, 0, certCanvas.width, certCanvas.height);
    };
    // === ÊèíÂÖ•ÁªìÊùü ===
    
    // ÁªëÂÆöËß¶Êë∏‰∫ã‰ª∂
    let isDrawing = false;
    
    const start = (e) => { isDrawing = true; certCtx.beginPath(); draw(e); };
    const end = () => { isDrawing = false; certCtx.beginPath(); };
    const draw = (e) => {
        if (!isDrawing) return;
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        certCtx.lineTo(x, y);
        certCtx.stroke();
    };

    certCanvas.onmousedown = start;
    certCanvas.onmousemove = draw;
    certCanvas.onmouseup = end;
    certCanvas.ontouchstart = (e) => { e.preventDefault(); start(e); };
    certCanvas.ontouchmove = (e) => { e.preventDefault(); draw(e); };
    certCanvas.ontouchend = end;
}
function clearCertCanvas() {
    // ÂÖàÊ∏ÖÁ©∫Á¨îËøπ
    certCtx.clearRect(0, 0, certCanvas.width, certCanvas.height);
    // ÂÜçÈáçÊñ∞Áîª‰∏äËÉåÊôØÂõæ
    const bgImg = new Image();
    bgImg.crossOrigin = "Anonymous";
    bgImg.src = "https://i.postimg.cc/Nf9QVP0M/IMG_2144.jpg";
    bgImg.onload = () => {
        certCtx.drawImage(bgImg, 0, 0, certCanvas.width, certCanvas.height);
    };
}


function finishMarriage() {
    const data = getAdvData();
    data.isMarried = true;
    saveAdvData(data);
    
    // Â∞ùËØï‰øùÂ≠òÂõæÁâá (ÁÆÄÂçï‰∏ãËΩΩ)
            // === iOS ÂÖºÂÆπ‰øùÂ≠ò‰øÆÂ§ç ===
    try {
        // 1. ÁîüÊàêÂõæÁâáÊï∞ÊçÆ
        const imgData = certCanvas.toDataURL("image/png");
        
        // 2. ÂàõÂª∫‰∏Ä‰∏™ÂÖ®Â±èÈªëÂ∫ïÂºπÁ™ó
        const overlay = document.createElement('div');
        overlay.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:30000; display:flex; flex-direction:column; align-items:center; justify-content:center;";
        
        // 3. ÊòæÁ§∫ÁîüÊàêÁöÑËØÅ‰π¶ÂõæÁâá
        const img = document.createElement('img');
        img.src = imgData;
        img.style.cssText = "max-width:90%; max-height:80%; border-radius:8px; box-shadow:0 0 20px white;";
        
        // 4. ÊèêÁ§∫ÊñáÂ≠ó
        const hint = document.createElement('div');
        hint.innerText = "üëÜ ËØ∑ÈïøÊåâÂõæÁâá -> Â≠òÂÇ®Âà∞‚ÄúÁÖßÁâá‚Äù";
        hint.style.cssText = "color:#ffd700; margin-top:20px; font-size:1.1rem; font-weight:bold; text-shadow:0 1px 2px black;";
        
        // 5. ÂÖ≥Èó≠ÊåâÈíÆ
        const closeBtn = document.createElement('button');
        closeBtn.innerText = "ÂÖ≥Èó≠";
        closeBtn.style.cssText = "margin-top:20px; padding:8px 30px; background:white; border:none; border-radius:20px; color:#333;";
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // 6. ÁªÑË£ÖÂπ∂ÊòæÁ§∫
        overlay.appendChild(img);
        overlay.appendChild(hint);
        overlay.appendChild(closeBtn);
        document.body.appendChild(overlay);

    } catch(e) { 
        alert("ÂõæÁâáÁîüÊàêÂ§±Ë¥•Ôºö" + e.message); 
    }
    document.getElementById('marriage-cert-modal').style.display = 'none';
    
    // 100% Ëß¶Âèë API
    callGlobalLLM("Êàë‰ª¨ÂàöÂàöÁ≠æ‰∏ã‰∫ÜÁªìÂ©öËØÅ‰π¶ÔºåÊ≠£ÂºèÊàê‰∏∫‰∫ÜÂ§´Â¶ª„ÄÇ", "event", "„ÄêÁâπÊÆäÊåá‰ª§„ÄëÊèèÂÜô‰∏§‰∫∫È¢ÜËØÅÂêéÊøÄÂä®„ÄÅÂπ∏Á¶èÁöÑÊó∂ÂàªÔºå‰ª•ÂèäÂÆ£Ë™ìÁöÑÂú∫ÊôØ„ÄÇ");
}

// Êç¢Ë°£Èó¥Ê∏≤Êüì (Âê´‰øÆÊ≠£ÁöÑÊñáÊ°à)
function renderClosetUI() {
    const data = getAdvData();
    const container = document.getElementById('adv-scene-container');
    container.innerHTML = ''; container.style.backgroundImage = 'none'; container.style.backgroundColor = '#fdfbf7';
    
    const charName = ADV_CACHE.lineCharName || "Ta";

    const html = `
    <div class="closet-container">
        <div class="closet-header">
            <h3>üëó Êç¢Ë°£Èó¥</h3>
            <button class="m-btn small" onclick="renderAdvScene('home_room')">üîô Á¶ªÂºÄ</button>
        </div>
        <div class="closet-avatars">
            <div class="closet-avatar-box" onclick="document.getElementById('upload-user-adv').click()">
                ${data.avatars.user ? `<img src="${data.avatars.user}">` : '<span>ÁÇπÂáª‰∏ä‰º†<br>Áî®Êà∑Á´ãÁªò(Â∑¶)</span>'}
            </div>
            <div class="closet-avatar-box" onclick="document.getElementById('upload-char-adv').click()">
                ${data.avatars.char ? `<img src="${data.avatars.char}">` : '<span>ÁÇπÂáª‰∏ä‰º†<br>ËßíËâ≤Á´ãÁªò(Âè≥)</span>'}
            </div>
        </div>
        <input type="file" id="upload-user-adv" style="display:none" onchange="uploadAdvImg('user', this)">
        <input type="file" id="upload-char-adv" style="display:none" onchange="uploadAdvImg('char', this)">

        <table class="attr-table">
            <tr><td>üìö Â≠¶‰π†</td><td>${data.attributes.learning}</td></tr>
            <tr><td>üé® ÁîªÁîª</td><td>${data.attributes.art}</td></tr>
            <tr><td>üéª ÊâçËâ∫</td><td>${data.attributes.talent}</td></tr>
            <tr><td>üèÉ ‰ΩìËÉΩ</td><td>${data.attributes.fitness}</td></tr>
            <tr><td>‚ù§Ô∏è ‰Ω†ÂØπ ${charName} ÁöÑÂ•ΩÊÑüÂ∫¶</td><td>${data.affection}</td></tr>
            <tr><td>‚ú® Ê∏ÖÊ¥ÅÂ∫¶</td><td>${Math.floor(data.cleanliness)}%</td></tr>
            <tr><td>üí∞ ÈáëÈí±</td><td>${Math.floor(data.money)}</td></tr>
        </table>

        <div style="font-weight:bold; margin-bottom:10px;">üëú ÊàëÁöÑËÉåÂåÖ</div>
        <div class="inv-list" id="adv-inv-list"></div>
    </div>`;
    
    container.innerHTML = html;
    renderInventoryItems();
    
    // ËøõÂÖ•Êç¢Ë°£Èó¥Êó∂‰πüÈöêËóèÁ´ãÁªò
    hideAdvDialog();
}

function uploadAdvImg(role, input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = getAdvData();
        data.avatars[role] = e.target.result;
        saveAdvData(data);
        renderClosetUI();
    };
    reader.readAsDataURL(file);
}

function renderInventoryItems() {
    const data = getAdvData();
    const listEl = document.getElementById('adv-inv-list');
    if(!listEl) return;
    listEl.innerHTML = '';
    
    if (!data.inventory || data.inventory.length === 0) { 
        listEl.innerHTML = '<div style="color:#999;text-align:center;">Á©∫Á©∫Â¶Ç‰πü...</div>'; 
        return; 
    }
    
    data.inventory.forEach((item, index) => {
        if(item.count <= 0) return;
        const div = document.createElement('div');
        div.className = 'inv-item';
        div.innerHTML = `<span>${item.name} x${item.count}</span>
            <div class="inv-btn-group">
                <button class="inv-btn btn-use" onclick="handleItemAction('use', ${index})">‰ΩøÁî®</button>
                <button class="inv-btn btn-sell" onclick="handleItemAction('sell', ${index})">ÂçñÂá∫</button>
            </div>`;
        listEl.appendChild(div);
    });

    // üëáüëáüëá Êñ∞Â¢ûÔºöÊ∑ªÂä†Â∫ïÈÉ®Âç†‰ΩçÔºåÈò≤Ê≠¢Ë¢´ÈÅÆÊå° üëáüëáüëá
    const spacer = document.createElement('div');
    spacer.style.height = "150px"; // Ë∂≥Â§üÁöÑÈ´òÂ∫¶
    spacer.style.flexShrink = "0"; // Èò≤Ê≠¢Ë¢´ÂéãÁº©
    listEl.appendChild(spacer);
}

function handleItemAction(action, index) {
    const data = getAdvData();
    const item = data.inventory[index];
    if (action === 'use') {
        let msg = "";
        if (['food','sweet'].includes(item.type)) { data.affection += 2; msg = "Â•ΩÊÑüÂ∫¶ +2"; }
        else if (item.type === 'high_sweet') { data.affection += 5; msg = "Â•ΩÊÑüÂ∫¶ +5"; }
        else if (item.type === 'gift') { data.affection += 4; msg = "Â•ΩÊÑüÂ∫¶ +4"; }
        else if (item.type === 'clothes') { data.affection += 3; msg = "Â•ΩÊÑüÂ∫¶ +3"; }
        else msg = "Êó†ÁâπÊÆäÊïàÊûú";
        
        item.count--; if(item.count <= 0) data.inventory.splice(index, 1);
        saveAdvData(data); renderClosetUI(); alert(`‰ΩøÁî®‰∫Ü [${item.name}]ÔºÅ${msg}`);
    } else if (action === 'sell') {
        let price = 1;
        if (item.type === 'high_sweet') price = 5;
        else if (item.type === 'gift') price = 3;
        else if (item.type === 'clothes') price = 2;
        data.money += price;
        item.count--; if(item.count <= 0) data.inventory.splice(index, 1);
        saveAdvData(data); renderClosetUI(); alert(`ÂçñÂá∫‰∫Ü [${item.name}]ÔºåËé∑Âæó ${price} ÈáëÈí±„ÄÇ`);
    }
}
// ============================================================
// üöÄ „ÄêÁ¨¨‰∏âÈò∂ÊÆµ„ÄëÊñáÊ∏∏Á≥ªÁªüÂçáÁ∫ßË°•‰∏Å (Phase 3 Final)
// ============================================================

// 1. Êï∞ÊçÆÁªìÊûÑÂçáÁ∫ß (Ëá™Âä®ÂêàÂπ∂)
if (!window.BIG_MEMORY.adv_data) window.BIG_MEMORY.adv_data = {};
// Á°Æ‰øùÊñ∞Â≠óÊÆµÂ≠òÂú®
Object.assign(window.BIG_MEMORY.adv_data, {
    history: [],       // ÂéÜÂè≤ËÆ∞ÂΩï
    dream_mode: false, // Ê¢¶Âç†Ê®°ÂºèÂºÄÂÖ≥
    important_memories: [] // Ê†áËÆ∞‰∏∫ÈáçË¶ÅÁöÑÂõûÂøÜ
});

// 2. ÂÖ®Â±Ä API Ë∞ÉÁî®Â∞ÅË£Ö (‰øÆÊ≠£Â•ΩÊÑüÂ∫¶ÂÆö‰πâ)
async function callGlobalLLM(userPrompt, type = "normal", extraContext = "") {
    const data = getAdvData();
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const gameCtx = (wb['2.Â∞èÂâßÂú∫'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    const chatSettings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    const charName = chatSettings.title || "Ta";

    // üî• Ê†∏ÂøÉ‰øÆÊ≠£ÔºöPrompt ‰∏≠ÊòéÁ°ÆÂ•ΩÊÑüÂ∫¶ÁöÑÊñπÂêë
    const systemPrompt = `
‰Ω†ÊòØ‰∏Ä‰∏™È´òËá™Áî±Â∫¶ÊñáÂ≠óÂÜíÈô©Ê∏∏Êàè(MUD)ÁöÑGM„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÊ∏∏ÊàèËÆæÂÆö„ÄëÔºö${gameCtx}
„ÄêÁé©ÂÆ∂‰ø°ÊÅØ„ÄëÔºö
- ÊòµÁß∞Ôºö${data.name}
- Áä∂ÊÄÅÔºöÈáëÈí±${data.money} / Ê∏ÖÊ¥ÅÂ∫¶${data.cleanliness}
- **Áé©ÂÆ∂ÂØπ${charName}ÁöÑÂñúÁà±Â∫¶**Ôºö${data.affection} (Êï∞ÂÄºË∂äÈ´òÔºå‰ª£Ë°®Áé©ÂÆ∂Ë∂ä‰∏ªÂä®„ÄÅË∂äÊ∑±ÊÉÖ)

„ÄêÂΩìÂâç‰ΩçÁΩÆ„ÄëÔºö${window.currentAdvScene || "Êú™Áü•Âú∫ÊôØ"}
${extraContext}

„Äê‰ªªÂä°„ÄëÔºö
ÁîüÊàê‰∏ÄÊÆµ 100-200 Â≠óÁöÑÂâßÊÉÖ‰∫íÂä®„ÄÇ
1. ËØ∑Ê†πÊçÆ‚ÄúÁé©ÂÆ∂ÂØπËßíËâ≤ÁöÑÂñúÁà±Â∫¶‚ÄùÊù•ÊèèÂÜôÁé©ÂÆ∂ÁöÑÂøÉÁêÜÊ¥ªÂä®ÊàñÁªÜÂæÆÂä®‰ΩúÔºàÂ¶ÇÊûúÊï∞ÂÄºÈ´òÔºåÁé©ÂÆ∂Â∫îËØ•Ë°®Áé∞ÂæóÊõ¥Âú®ÊÑèËßíËâ≤Ôºâ„ÄÇÔºàËßíËâ≤‰ºö‰∏ÄÁõ¥Áà±Áé©ÂÆ∂Ôºâ
2. ÊèèÂÜôËßíËâ≤Ôºà${charName}ÔºâÂØπÁé©ÂÆ∂Ë°å‰∏∫ÁöÑÂèçÂ∫î„ÄÇ
3. ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚ÄùÊåá‰ª£Áé©ÂÆ∂„ÄÇ
`;

    // API Ë∞ÉÁî®ÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèò
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");
    if(!apiUrl) apiUrl = "https://api.openai.com/v1";
    if(!model) model = "gpt-3.5-turbo";

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:systemPrompt}, {role:"user", content:userPrompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const content = json.choices[0].message.content;
        
        showAdvDialog(content, "System"); // ÈªòËÆ§Áî®Á≥ªÁªü/Áé©ÂÆ∂Á´ãÁªò
        saveAdvHistory(userPrompt, content, window.currentAdvScene);
        
    } catch(e) {
        alert("API Error: " + e.message);
    }
}

// 3. Ê¢¶Âç†Ê®°ÂºèÈÄªËæë (Êã¶Êà™Âô®)
let pendingDreamCallback = null;
let dreamDeck = [], dreamFlipped = [];

function checkDreamMode(callback) {
    const data = getAdvData();
    if (data.dream_mode) {
        pendingDreamCallback = callback;
        openDreamDivinationTable();
    } else {
        callback(""); // Â¶ÇÊûúÊ≤°ÂºÄÔºåÁõ¥Êé•ÂõûË∞ÉÁ©∫Â≠óÁ¨¶‰∏≤
    }
}

function openDreamDivinationTable() {
    const modal = document.getElementById('dream-divination-modal');
    const area = document.getElementById('dream-divination-area');
    
    // ÂàùÂßãÂåñÁâåÊ°å (Â§çÁî®Â°îÁΩóÊ°åÂ∏É)
    idb.get('settings_heavy', 'tarot_table').then(res => {
        if(res && res.data) document.getElementById('dream-divination-desk').style.backgroundImage = `url(${res.data})`;
    });

    area.innerHTML = '';
    dreamDeck = []; dreamFlipped = [];
    document.getElementById('dream-div-count').innerText = '0';

    // ÁîüÊàê114Âº†Áâå
    for(let i=0; i<=77; i++) dreamDeck.push({ type:'tarot', id:i, isReversed:Math.random()<0.3 });
    for(let i=1; i<=36; i++) dreamDeck.push({ type:'lenormand', id:i, isReversed:false });
    dreamDeck.sort(()=>Math.random()-0.5);

    // Â∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cols = 4; const cardW=60, cardH=90, gap=10;
    const startX = (deskW - (cols*(cardW+gap)))/2;

    dreamDeck.forEach((card, i) => {
        const el = document.createElement('div');
        el.className = 'playing-card';
        const col = i % cols, row = Math.floor(i/cols);
        el.style.left = (startX + col*(cardW+gap)) + 'px';
        el.style.top = (60 + row*(cardH+gap)) + 'px';
        el.style.transform = `rotate(${Math.random()*6-3}deg)`;
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        el.onclick = async () => {
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                dreamFlipped = dreamFlipped.filter(c=>!(c.id===card.id && c.type===card.type));
            } else {
                el.classList.add('flipped');
                dreamFlipped.push(card);
                const db = card.type==='tarot'?'tarot_deck':'lenormand_deck';
                idb.get(db, card.id).then(res=>{ 
                    if(res && res.data) front.style.backgroundImage=`url(${res.data})`;
                    else { front.style.background="#fff"; front.innerText=card.id; }
                });
                if(card.isReversed) front.style.transform = "rotateY(180deg) rotate(180deg)";
                else front.style.transform = "rotateY(180deg)";
            }
            document.getElementById('dream-div-count').innerText = dreamFlipped.length;
        };
        area.appendChild(el);
    });

    modal.style.display = 'flex';
}

function finishDreamDivination() {
    if(dreamFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");
    const cardsDesc = dreamFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    
    document.getElementById('dream-divination-modal').style.display = 'none';
    
    if (pendingDreamCallback) {
        pendingDreamCallback(`„ÄêÂ°îÁΩóÊ¢¶Âç†ÊåáÂºï„ÄëÔºö${cardsDesc} (ËØ∑Ê†πÊçÆÊ≠§ÁâåÊÑèÂºïÂØºÂâßÊÉÖËµ∞Âêë)`);
        pendingDreamCallback = null;
    }
}

function cancelDreamDivination() {
    document.getElementById('dream-divination-modal').style.display = 'none';
    if (pendingDreamCallback) {
        pendingDreamCallback(""); // ÂõûË∞ÉÁ©∫
        pendingDreamCallback = null;
    }
}

// 4. Âä´ÊåÅÊñáÊ∏∏ÈÄªËæë (ÂÆûÁé∞ 15% ÈöèÊú∫ÂâßÊÉÖ)
const _originalExecuteAdvLogic = window.executeAdvLogic;
window.executeAdvLogic = function(logicKey) {
    // 15% Ê¶ÇÁéáËß¶ÂèëÈöèÊú∫ÂâßÊÉÖ
    if (Math.random() < 0.15) {
        // Ëé∑ÂèñÂéüÊú¨Â∫îËØ•ÂèëÁîüÁöÑÊèèËø∞‰Ωú‰∏∫ÈªòËÆ§ÂÄº
        let defaultText = `‰Ω†Ê≠£ÂáÜÂ§á${logicKey.replace(/_/g, ' ')}...`;
        
        document.getElementById('adv-random-input').value = defaultText;
        document.getElementById('adv-random-modal').style.display = 'flex';
        return;
    }
    
    // Âê¶ÂàôÊâßË°åÂéüÈÄªËæë
    _originalExecuteAdvLogic(logicKey);
}

// === üõ†Ô∏è Êä¢Èí±ÈÄªËæë‰øÆÂ§çË°•‰∏ÅÔºöÁîüÊàêÂâßÊÉÖÂêéÊâçÂä†Èí± ===
window.confirmRandomEvent = function() {
    const text = document.getElementById('adv-random-input').value;
    document.getElementById('adv-random-modal').style.display = 'none';
    
    // Ëß¶ÂèëÊ¢¶Âç†Ê£ÄÊü• -> ÁÑ∂ÂêéË∞ÉÁî® API
    checkDreamMode(async (dreamContext) => {
        // 1. Á≠âÂæÖ AI ÁîüÊàêÊïÖ‰∫ãÂÆåÊØï (await Á°Æ‰øùÂâßÊÉÖÂÖàÂá∫Êù•)
        await callGlobalLLM(text, "random", dreamContext);
        
        // 2. Ê£ÄÊµãÊñáÊú¨‰∏≠ÊòØÂê¶ÂåÖÂê´‚ÄúÊä¢Èí±‚ÄùÂÖ≥ÈîÆËØç
        // Â¶ÇÊûúÂåÖÂê´ÔºåËØ¥ÊòéËøôÊòØÊä¢Èí±‰∫ã‰ª∂Ôºå‰∏îÂâßÊÉÖÂ∑≤ÁîüÊàêÂÆåÊØïÔºåÁé∞Âú®Âä†Èí±
        if (text.includes("„Äêüî™ Êä¢Èí±„Äë")) {
            const d = getAdvData();
            d.money += 300; // Â¢ûÂä†300ÈáëÈí±
            saveAdvData(d); // ‰øùÂ≠òÂπ∂Âà∑Êñ∞Â∑¶‰∏äËßíUI
            
            // Âª∂Ëøü‰∏ÄÁÇπÁÇπÂºπÂá∫ÊèêÁ§∫Ôºå‰ΩìÈ™åÊõ¥Â•Ω
            setTimeout(() => {
                alert(`üí∞ Êä¢Âä´ÊàêÂäüÔºÅ\nÊÅ∂ÂêëËÉÜËæπÁîüÔºå‰Ω†Ëé∑Âæó‰∫Ü 300 ÈáëÈí±„ÄÇ\n(ÂΩìÂâç‰ΩôÈ¢ù: ${d.money})`);
            }, 500);
        }
    });
}
// 5. Êâ©Â±ïÂäüËÉΩËèúÂçï (Ê≥®ÂÖ•Âà∞È°∂ÈÉ®Áä∂ÊÄÅÊ†è)
function injectAdvMenu() {
    const bar = document.querySelector('.adv-top-bar');
    if (!document.getElementById('btn-adv-menu')) {
        const menuBtn = document.createElement('button');
        menuBtn.id = 'btn-adv-menu';
        menuBtn.innerText = "ÂäüËÉΩ üîΩ";
        menuBtn.className = "adv-exit-btn"; // Â§çÁî®Ê†∑Âºè
        menuBtn.style.marginRight = "10px";
        menuBtn.style.background = "#fff";
        menuBtn.style.color = "#333";
        
        menuBtn.onclick = () => {
            const data = getAdvData();
            // ÁÆÄÂçïÁöÑ Prompt ËèúÂçï
            const choice = prompt(
                `===== ÊñáÊ∏∏ÂäüËÉΩËèúÂçï =====\n` +
                `1. ${data.dream_mode ? '‚úÖ' : '‚¨ú'} Ê¢¶Âç†Ê®°Âºè (ÂºÄÂÖ≥)\n` +
                `2. üìÖ Á∫¶‰ºöÁ≥ªÁªü\n` +
                `3. üìñ ÂéÜÂè≤ÂõûÈ°æ\n` +
                `4. üîö ÁªìÊùüËøô‰∏™‰∏ñÁïå\n` +
                `ËØ∑ËæìÂÖ•Êï∞Â≠óÈÄâÊã©Ôºö`
            );
            
            if (choice === '1') {
                data.dream_mode = !data.dream_mode;
                saveAdvData(data);
                alert(`Ê¢¶Âç†Ê®°ÂºèÂ∑≤${data.dream_mode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}ÔºÅ\n(ÂºÄÂêØÂêéÔºåÊØèÊ¨°ÁîüÊàêÂâßÊÉÖÂâçÈÉΩ‰ºöÂÖàÊäΩÁâå)`);
            } else if (choice === '2') {
                openDatingMenu();
            } else if (choice === '3') {
                openAdvHistory();
            } else if (choice === '4') {
                document.getElementById('adv-ending-modal').style.display = 'flex';
            }
        };
        
        bar.insertBefore(menuBtn, bar.lastElementChild); // ÊèíÂú®ÈÄÄÂá∫ÊåâÈíÆÂâçÈù¢
    }
    
    // Ê≥®ÂÖ•Â§ßÁ§ºÂ†ÇÊ±áÊºîÊåâÈíÆ (Â¶ÇÊûúÂú®Â§ßÁ§ºÂ†Ç)
    const container = document.getElementById('adv-scene-container');
    if (window.currentAdvScene === 'school_hall' && !document.getElementById('btn-hall-show')) {
        if (Math.random() < 0.2) { // 20% Ê¶ÇÁéáÂá∫Áé∞
            const btn = document.createElement('div');
            btn.id = 'btn-hall-show';
            btn.className = 'adv-btn pos-center';
            btn.innerText = 'üé≠ Â≠¶Ê†°ÊñáËâ∫Ê±áÊºî';
            btn.style.top = '40%';
            btn.onclick = (e) => {
                e.stopPropagation();
                const act = prompt("‰Ω†Ë¶ÅË°®Êºî‰ªÄ‰πàËäÇÁõÆÔºü");
                if(act) {
                    checkDreamMode((ctx) => callGlobalLLM(`ÊàëÂú®Â≠¶Ê†°Â§ßÁ§ºÂ†ÇÂèÇÂä†Ê±áÊºîÔºåË°®Êºî‰∫Ü${act}`, "event", ctx));
                }
            };
            container.appendChild(btn);
        }
    }
}

// Âä´ÊåÅ renderAdvScene Êù•Ê≥®ÂÖ•ËèúÂçï
const _originalRenderAdvScene = window.renderAdvScene;
window.renderAdvScene = function(sceneId) {
    window.currentAdvScene = sceneId; // ËÆ∞ÂΩïÂΩìÂâçÂú∫ÊôØ
    _originalRenderAdvScene(sceneId);
    setTimeout(injectAdvMenu, 50); // Âª∂ËøüÊ≥®ÂÖ•ÔºåÈò≤Ê≠¢Ë¢´Ë¶ÜÁõñ
}

// 6. Á∫¶‰ºöÁ≥ªÁªü
function openDatingMenu() {
    const modal = document.getElementById('adv-date-modal');
    const select = document.getElementById('date-location-select');
    select.innerHTML = '';
    
    // üî•„Äê‰øÆÊîπË°•‰∏Å„ÄëÁ∫ØÊñáÊ∏∏Âú∫ÊôØÊò†Â∞ÑË°® (ÂâîÈô§‰∫ÜRPGÂú∫ÊôØ)
    const sceneMap = {
        // === üè† ÂÆ∂‰∏≠ ===
        'home_room': 'üè† ÊàëÁöÑÊàøÈó¥',
        'home_bath': 'üõÅ Êµ¥ÂÆ§',

        // === üè´ Â≠¶Ê†°Âå∫Âüü ===
        'school_main': 'üè´ Â≠¶Ê†°Ê≠£Èó®',
        'school_corridor': 'üè´ ÊïôÂ≠¶Ê•ºËµ∞Âªä',
        'class_room': 'üìö ÊïôÂÆ§',
        'class_kitchen': 'üç≥ ÊñôÁêÜÊïôÂÆ§',
        'class_piano': 'üéπ Èí¢Áê¥Êàø',
        'class_art': 'üé® ÁîªÂÆ§',
        'school_hall': 'üé≠ Â§ßÁ§ºÂ†Ç',
        'school_gym': 'üè∏ ‰ΩìËÇ≤È¶Ü',
        'school_ground': 'üèÉ Â≠¶Ê†°ÊìçÂú∫',
        
        // === üè¨ ÂïÜÂú∫Âå∫Âüü ===
        'mall_main': 'üè¨ ÂïÜÂú∫‰∏≠ÂøÉ',
        'mall_gift': 'üéÅ Á§ºÁâ©Â∫ó',
        'mall_clothes': 'üëó ÊúçË£ÖÂ∫ó',
        'mall_sweet': 'üç∞ ÁîúÂìÅÂ∫ó',
        'mall_walk': 'üõçÔ∏è Ê≠•Ë°åË°ó',
        'mall_food': 'üç¢ Â∞èÂêÉË°ó', 'mall_nail': 'üíÖ ÁæéÁî≤Â∫ó', 
        
        // === üå≥ Êà∑Â§ñ‰∏éÊóÖË°å ===
        'park': 'üå≥ ÂÖ¨Âõ≠',
        'travel_main': '‚úàÔ∏è ÊóÖË°åÁ§æÂ§ßÂéÖ',
        'travel_gugong': 'üèØ ÊïÖÂÆ´ (ÊóÖË°å)',
        'travel_seaside': 'üåä Êµ∑ËæπÂ∫¶ÂÅáÂå∫ (ÊóÖË°å)',
        'travel_tokyo': 'üóº ‰∏ú‰∫¨ÈìÅÂ°î (ÊóÖË°å)',
        'travel_france': 'üè∞ Ê≥ïÂõΩÂüéÂ†° (ÊóÖË°å)',
        'travel_uk': 'üá¨üáß Ëã±ÂõΩË°óÂ§¥ (ÊóÖË°å)',
        'travel_usa': 'üóΩ Ëá™Áî±Â•≥Á•ûÂÉè (ÊóÖË°å)',

        // === üè∞ Êñ∞Â¢ûÔºöÂ±±Â∫ÑÂà´Â¢ÖÂå∫Âüü ===
        'villa_main': 'üè∞ Â±±Â∫ÑÂà´Â¢ÖÂ§ßÂéÖ',
        'villa_bedroom': 'üõå Âà´Â¢Ö‰∏ªÂçß',
        'villa_pool': 'üèä Âà´Â¢ÖÊ≥≥Ê±†',
        'villa_lawn': 'ü¶å Âà´Â¢ÖËçâÂù™',
        'villa_bbq': 'üçñ Âà´Â¢ÖÁÉßÁÉ§Âå∫',
        'villa_aqua': 'üê† Âà´Â¢ÖÊ∞¥ÊóèÈ¶Ü',

        // === üíç Êñ∞Â¢ûÔºöÁâπÊÆäÂú∞ÁÇπ ===
        'civil_bureau': 'üíç Ê∞ëÊîøÂ±Ä'
    };

    // ÈÅçÂéÜÁîüÊàêÈÄâÈ°π
    for (let id in sceneMap) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.innerText = sceneMap[id];
        select.appendChild(opt);
    }
    
    modal.style.display = 'flex';
}

function startDatingEvent() {
    const loc = document.getElementById('date-location-select').value;
    const act = document.getElementById('date-activity').value;
    const time = document.getElementById('date-time').value;
    const detail = document.getElementById('date-detail').value;
    
    if(!act) return alert("ËØ∑Â°´ÂÜôÁ∫¶‰ºöÈ°πÁõÆÔºÅ");
    
    document.getElementById('adv-date-modal').style.display = 'none';
    
        // Ë∑≥ËΩ¨Âú∫ÊôØ
    renderAdvScene(loc);
    // ÈöêËóèÂú∫ÊôØÂÜÖÁöÑÈªòËÆ§ÊåâÈíÆÔºåÂè™ÁïôËÉåÊôØ
    const container = document.getElementById('adv-scene-container');
    Array.from(container.children).forEach(c => c.style.display = 'none');

    // üëá Êñ∞Â¢ûÔºöÊ∑ªÂä†‰∏Ä‰∏™ËøîÂõûÊåâÈíÆ üëá
    const backBtn = document.createElement('div');
    backBtn.className = 'adv-btn pos-btm-mid'; // ‰ΩøÁî®Â∫ïÈÉ®‰∏≠Èó¥Ê†∑Âºè
    backBtn.innerText = 'üè† ÁªìÊùüÁ∫¶‰ºöËøîÂõû';
    backBtn.style.zIndex = '100'; // Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç
    backBtn.onclick = () => {
        renderAdvScene('main_map'); // ÁÇπÂáªÂêéÂº∫Âà∂ÂõûÂ§ßÂú∞Âõæ
    };
    container.appendChild(backBtn);
    
    // Ëß¶ÂèëÁîüÊàê
    checkDreamMode((dreamCtx) => {
        const prompt = `Êàë‰ª¨Ê≠£Âú®Á∫¶‰ºöÔºÅ\nÂú∞ÁÇπÔºö${loc}\nÊó∂Èó¥Ôºö${time}\nÈ°πÁõÆÔºö${act}\nËØ¶ÊÉÖÔºö${detail}`;
        callGlobalLLM(prompt, "date", dreamCtx);
    });
}

// 7. ÂéÜÂè≤ËÆ∞ÂΩïÁ≥ªÁªü
function saveAdvHistory(action, result, scene) {
    const data = getAdvData();
    if(!data.history) data.history = [];
    
    data.history.unshift({
        id: Date.now(),
        date: new Date().toLocaleString(),
        scene: scene,
        action: action,
        result: result,
        isImportant: false
    });
    
    saveAdvData(data);
}

function openAdvHistory() {
    const modal = document.getElementById('adv-history-modal');
    const list = document.getElementById('adv-history-list');
    const data = getAdvData();
    
    list.innerHTML = '';
    (data.history || []).forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.padding = '10px';
        div.innerHTML = `
            <div style="font-size:0.8rem; color:#888; display:flex; justify-content:space-between;">
                <span>${item.date} @ ${item.scene}</span>
                <span onclick="deleteAdvHistory(${index})" style="color:red; cursor:pointer;">√ó</span>
            </div>
            <div style="font-weight:bold; margin:5px 0;">${item.action}</div>
            <div style="font-size:0.9rem; color:#555; max-height:60px; overflow:hidden;">${item.result}</div>
            <div style="text-align:right; margin-top:5px;">
                <label><input type="checkbox" ${item.isImportant?'checked':''} onchange="toggleImportant(${index})"> ‚≠ê ËÆæ‰∏∫ÈáçË¶ÅÂõûÂøÜ</label>
            </div>
        `;
        list.appendChild(div);
    });
    
    modal.style.display = 'flex';
}

function toggleImportant(index) {
    const data = getAdvData();
    data.history[index].isImportant = !data.history[index].isImportant;
    saveAdvData(data);
}

function deleteAdvHistory(index) {
    const data = getAdvData();
    data.history.splice(index, 1);
    saveAdvData(data);
    openAdvHistory(); // Âà∑Êñ∞
}
// 8. ÁªìÂ±ÄÁ≥ªÁªü (‰øÆÂ§çÁâàÔºöÈªëÂ∫ïÁôΩÂ≠ó + Â•ΩÊÑüÂ∫¶ÂÆö‰πâ‰øÆÊ≠£)
async function generateEnding() {
    const data = getAdvData();
    // Á≠õÈÄâÈáçË¶ÅÂõûÂøÜ
    const memories = (data.history || []).filter(h => h.isImportant).map(h => h.result).join("\n---\n");
    
    const btn = document.querySelector('#adv-ending-modal .m-btn.primary');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ Ê≠£Âú®ÁºñÂÜôÊúÄÁªàÁ´†..."; 
    btn.disabled = true;

    // üî• Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÊòéÁ°ÆÂëäËØâ AI Â•ΩÊÑüÂ∫¶ÊòØË∞ÅÂØπË∞ÅÁöÑ
    const prompt = `
ËøôÊòØËøôÂ±ÄÊ∏∏ÊàèÁöÑÊúÄÁªàÁªìÂ±Ä„ÄÇ
„ÄêÁé©ÂÆ∂Â±ûÊÄß„ÄëÔºö${JSON.stringify(data.attributes)}
„ÄêÁé©ÂÆ∂ÂØπËßíËâ≤ÁöÑÂñúÁà±Â∫¶/Â•ΩÊÑüÂ∫¶„ÄëÔºö${data.affection} (Ê≥®ÊÑèÔºöÊï∞ÂÄºË∂äÈ´ò‰ª£Ë°®Áé©ÂÆ∂Ë∂äÂñúÊ¨¢ËßíËâ≤ÔºåËßíËâ≤ÊòØË¢´Áà±ÁöÑ‰∏ÄÊñπ)
„ÄêÈáçË¶ÅÂõûÂøÜ„ÄëÔºö
${memories || "ÔºàÊó†ÈáçË¶ÅÂõûÂøÜÔºåÂπ≥Ê∑°ÁöÑ‰∏ÄÁîüÔºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑Ê†πÊçÆ‰ª•‰∏äÊï∞ÊçÆÔºåÁîüÊàê‰∏ÄÁØá 600 Â≠óÂ∑¶Âè≥ÁöÑÁªìÂ±ÄÊïÖ‰∫ã„ÄÇ
1. **ÊÉÖÊÑüÂà§ÂÆö**Ôºö
   - Â¶ÇÊûúÁé©ÂÆ∂Â•ΩÊÑüÂ∫¶È´òÔºö‰ª£Ë°®Áé©ÂÆ∂Ê∑±Áà±ÁùÄËßíËâ≤„ÄÇËØ∑ÊèèÂÜôËßíËâ≤Èù¢ÂØπËøô‰ªΩÊ∑±ÊÉÖÁöÑÂõûÂ∫îÔºàÊòØÊÑüÂä®Êé•Âèó„ÄÅËøòÊòØÂÇ≤Â®á„ÄÅËøòÊòØÈÅóÊÜæÈîôËøáÔºüÔºâ„ÄÇ
   - Â¶ÇÊûúÁé©ÂÆ∂Â•ΩÊÑüÂ∫¶‰ΩéÔºö‰ª£Ë°®Áé©ÂÆ∂ÂØπËßíËâ≤Êó†ÊÑü„ÄÇËØ∑ÊèèÂÜô‰∏§‰∫∫ÁöÑÊ∏êË°åÊ∏êËøú„ÄÇ
2. **ÁªìÂêàÂ±ûÊÄß**ÔºöÊ†πÊçÆÁé©ÂÆ∂ÁöÑÂ±ûÊÄßÔºàÂ≠¶‰π†/ÊâçËâ∫Á≠âÔºâÂÜ≥ÂÆöÁé©ÂÆ∂ÁöÑÊú™Êù•ËÅå‰∏öÂíå‰∫∫ÁîüËµ∞Âêë„ÄÇ
3. **È£éÊ†º**ÔºöÊ∑±Âàª„ÄÅÂîØÁæé„ÄÅÂÖ∑ÊúâÁîµÂΩ±ÁªìÊùüÁöÑÁîªÈù¢ÊÑü„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫ÁªìÂ±ÄÊ≠£Êñá„ÄÇ
`;

    // API Ë∞ÉÁî®ÂáÜÂ§á
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;

    if(!apiKey) {
        try { 
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); 
            apiKey = s.key; apiUrl = s.url; model = s.model; 
        } catch(e){}
    }
    
    if(!apiUrl) apiUrl = "https://api.openai.com/v1";
    if(!model) model = "gpt-3.5-turbo";
    
    if(!apiKey) {
        btn.innerText = oldText; btn.disabled = false;
        return alert("API Key Missing");
    }

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Creative writer."}, {role:"user", content:prompt}],
                temperature: 0.9
            })
        });
        const json = await res.json();
        if (json.error) throw new Error(json.error.message);
        
        const endingText = json.choices[0].message.content;
        
        // --- üî¥ ‰øÆÂ§çÁÇπÔºöÂàõÂª∫ÂÖ®Êñ∞ÁöÑÈªëËâ≤ÂÖ®Â±èÂ±ÇÔºåË¶ÜÁõñ‰∏ÄÂàá ---
        // 1. ÂÖ≥Èó≠Á°ÆËÆ§ÂºπÁ™ó
        document.getElementById('adv-ending-modal').style.display = 'none'; 
        
        // 2. ÂàõÂª∫/Ëé∑ÂèñÁªìÂ±ÄÂ±Ç
        let endLayer = document.getElementById('final-ending-overlay');
        if (!endLayer) {
            endLayer = document.createElement('div');
            endLayer.id = 'final-ending-overlay';
            endLayer.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: #000; color: #fff; z-index: 99999;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                padding: 40px; box-sizing: border-box; text-align: center;
                animation: fadeIn 2s ease-in;
            `;
            document.body.appendChild(endLayer);
        }
        
        // 3. Â°´ÂÖÖÂÜÖÂÆπ
        endLayer.innerHTML = `
            <div style="font-family: 'Old English Text MT', serif; font-size: 3rem; margin-bottom: 30px; letter-spacing: 5px;">THE END</div>
            <div style="font-family: 'Songti SC', serif; font-size: 1.1rem; line-height: 2; max-width: 600px; max-height: 60vh; overflow-y: auto; text-align: justify;">
                ${endingText.replace(/\n/g, '<br>')}
            </div>
            <button onclick="resetWorldAndClose()" style="margin-top: 40px; padding: 10px 30px; background: transparent; border: 1px solid #fff; color: #fff; cursor: pointer; border-radius: 20px;">
                ‚Ü∫ ÂºÄÂêØÊñ∞ÁöÑËΩÆÂõû (ÈáçÁΩÆ)
            </button>
        `;
        endLayer.style.display = 'flex';

        // 4. ÂÆö‰πâÈáçÁΩÆÂáΩÊï∞ (ÊåÇËΩΩÂà∞ window ‰ª•‰æøÊåâÈíÆË∞ÉÁî®)
        window.resetWorldAndClose = function() {
            // ÈáçÁΩÆÊï∞ÊçÆ
            window.BIG_MEMORY.adv_data = {
                name: "Áé©ÂÆ∂", cleanliness: 100, money: 100, affection: 0,
                attributes: { learning: 0, art: 0, talent: 0, fitness: 0 },
                inventory: [], avatars: { user: "", char: "" },
                history: [], dream_mode: false
            };
            saveAdvData(window.BIG_MEMORY.adv_data);
            
            // ÂÖ≥Èó≠ÊâÄÊúâÂ±Ç
            document.getElementById('final-ending-overlay').remove();
            document.getElementById('adv-modal').style.display = 'none'; // ÂÖ≥Èó≠Ê∏∏ÊàèÁïåÈù¢
            
            alert("‚ú® ‰∏ñÁïåÁ∫øÂ∑≤ÈáçÁΩÆÔºå‰Ω†ÂõûÂà∞‰∫ÜÂéüÁÇπ„ÄÇ");
        };

    } catch(e) {
        alert("ÁªìÂ±ÄÁîüÊàêÂá∫Èîô: " + e.message);
        btn.innerText = oldText; 
        btn.disabled = false;
    }
}
// ============================================================
// üöÄ „ÄêÊñáÊ∏∏Á≥ªÁªü Phase 3.5„Äë‰∫§‰∫í‰ΩìÈ™å‰ºòÂåñË°•‰∏Å
// ============================================================

// --- 1. ÂÖ®Â±ÄÂèòÈáèÔºöÁî®‰∫éÂ≠òÂÇ®ÂâßÊÉÖÈòüÂàó ---
let advStoryQueue = []; // Â≠òÊîæÂàáÂàÜÂêéÁöÑÂâßÊÉÖÁâáÊÆµ
let advCurrentChunkIndex = 0; // ÂΩìÂâçÊí≠ÊîæÂà∞Á¨¨Âá†ÊÆµ

// --- 2. Áé©ÂÆ∂ÊîπÂêçÂäüËÉΩ (Ëá™Âä®‰øùÂ≠ò) ---
window.editAdvName = function() {
    const data = getAdvData();
    const newName = prompt("ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊñ∞ÊòµÁß∞:", data.name);
    
    if (newName && newName.trim() !== "") {
        data.name = newName.trim();
        saveAdvData(data); // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
        updateAdvUI();     // Âà∑Êñ∞ÁïåÈù¢
        alert(`ÊòµÁß∞Â∑≤‰øÆÊîπ‰∏∫Ôºö${newName}`);
    }
};

// --- 3. ÂâßÊÉÖÂàáÂàÜ‰∏éÁ´ãÁªòÂà§Êñ≠Ê†∏ÂøÉÈÄªËæë ---
window.startAdvStory = function(fullText) {
    const box = document.getElementById('adv-dialog-box');
    box.style.display = 'flex'; // ÊòæÁ§∫ÂØπËØùÊ°Ü
    
    // 1. Êåâ 20 Â≠óÂàáÂàÜÊñáÊú¨ (‰øùÁïôÊ†áÁÇπÁ¨¶Âè∑ÁöÑÂÆåÊï¥ÊÄßÂª∫ËÆÆÁî®Ê≠£ÂàôÔºåËøôÈáåÁî®ÁÆÄÂçïÂàáÁâá)
    const chunkSize = 20;
    advStoryQueue = [];
    
    for (let i = 0; i < fullText.length; i += chunkSize) {
        advStoryQueue.push(fullText.substring(i, i + chunkSize));
    }
    
    advCurrentChunkIndex = 0;
    renderCurrentChunk(); // Á´ãÂç≥ÊòæÁ§∫Á¨¨‰∏ÄÊÆµ
};

window.nextAdvDialogueChunk = function() {
    advCurrentChunkIndex++;
    if (advCurrentChunkIndex >= advStoryQueue.length) {
        // Êí≠ÊîæÂÆåÊØïÔºåÂÖ≥Èó≠ÂØπËØùÊ°Ü
        document.getElementById('adv-dialog-box').style.display = 'none';
        // ÂêåÊó∂‰πüÈöêËóèÁ´ãÁªò
        updateTachieDisplay("hide_all");
    } else {
        renderCurrentChunk();
    }
};

function renderCurrentChunk() {
    const text = advStoryQueue[advCurrentChunkIndex];
    const data = getAdvData();
    const chatSettings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    const charName = chatSettings.title || "Ta"; // Ëé∑ÂèñËßíËâ≤ÂêçÂ≠ó
    
    // Êõ¥Êñ∞ÊñáÊú¨
    document.getElementById('adv-dialog-text').innerText = text;
    
    // --- Êô∫ËÉΩÁ´ãÁªòÂà§Êñ≠ÈÄªËæë ---
    // ‰ºòÂÖàÁ∫ßÔºöËßíËâ≤Âêç > "‰Ω†/Êàë" > ÊóÅÁôΩ
    
    if (text.includes(charName) || text.includes("Ta") || text.includes("ËßíËâ≤")) {
        // ==> ËßíËâ≤ËØ¥ËØù/Âä®‰Ωú
        document.getElementById('adv-dialog-name').innerText = charName;
        updateTachieDisplay("char");
        // Êõ¥Êñ∞Â∞èÂ§¥ÂÉè
        updateSmallAvatar("char");
    } 
    else if (text.includes("‰Ω†") || text.includes(data.name) || text.includes("Êàë")) {
        // ==> Áî®Êà∑ËØ¥ËØù/Âä®‰Ωú
        document.getElementById('adv-dialog-name').innerText = data.name;
        updateTachieDisplay("user");
        updateSmallAvatar("user");
    } 
    else {
        // ==> ÊóÅÁôΩ/ÁéØÂ¢ÉÊèèÂÜô
        document.getElementById('adv-dialog-name').innerText = ""; // ÊóÅÁôΩ‰∏çÊòæÁ§∫ÂêçÂ≠ó
        updateTachieDisplay("hide_all"); // ‰πü‰∏çÊòæÁ§∫Á´ãÁªò
        document.getElementById('adv-dialog-img').style.backgroundImage = 'none'; // ÈöêËóèÂ∞èÂ§¥ÂÉè
        document.getElementById('adv-dialog-img').style.backgroundColor = 'transparent';
    }
}

// ËæÖÂä©ÔºöÊéßÂà∂Á´ãÁªòÊòæÁ§∫/ÈöêËóè
function updateTachieDisplay(mode) {
    const userImg = document.getElementById('adv-tachie-user');
    const charImg = document.getElementById('adv-tachie-char');
    const data = getAdvData(); // Ëé∑Âèñ‰∏ä‰º†ÁöÑÁ´ãÁªòÊï∞ÊçÆ

    // Âè™ÊúâÂΩìÁî®Êà∑‰∏ä‰º†‰∫ÜÁ´ãÁªòÊâçÊòæÁ§∫ÔºåÂê¶Âàô‰øùÊåÅÈöêËóè
    const hasUserArt = !!data.avatars.user;
    const hasCharArt = !!data.avatars.char;

    if (mode === "user" && hasUserArt) {
        userImg.src = data.avatars.user;
        userImg.style.display = 'block';
        charImg.style.display = 'none';
    } else if (mode === "char" && hasCharArt) {
        charImg.src = data.avatars.char;
        charImg.style.display = 'block';
        userImg.style.display = 'none';
    } else {
        userImg.style.display = 'none';
        charImg.style.display = 'none';
    }
}

// ËæÖÂä©ÔºöÊõ¥Êñ∞ÂØπËØùÊ°ÜÂ∑¶‰æßÁöÑÂ∞èÂ§¥ÂÉè
function updateSmallAvatar(who) {
    const iconDiv = document.getElementById('adv-dialog-img');
    iconDiv.style.backgroundColor = '#ccc'; // ÈªòËÆ§Â∫ïËâ≤
    
    if (who === "user" && ADV_CACHE.lineUserAvatar) {
        iconDiv.style.backgroundImage = `url(${ADV_CACHE.lineUserAvatar})`;
    } else if (who === "char" && ADV_CACHE.lineCharAvatar) {
        iconDiv.style.backgroundImage = `url(${ADV_CACHE.lineCharAvatar})`;
    }
}

// ==========================================
// üîß ÊñáÊ∏∏Ê†∏ÂøÉÈÄªËæë‰øÆÊ≠£Áâà (ÂêçÂ≠ó‰øÆÂ§ç + ÂéªÊòüÂè∑)
// ==========================================
window.callGlobalLLM = async function(userPrompt, type = "normal", extraContext = "") {
    const data = getAdvData();
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const gameCtx = (wb['2.Â∞èÂâßÂú∫'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // „Äê‰øÆÊîπÁÇπ1„ÄëÂêçÂ≠óËé∑ÂèñÈÄªËæë‰øÆÊ≠£Ôºö‰ºòÂÖàËØªÂèñÊñáÊ∏∏Â≠òÊ°£(data.charName)ÔºåÊ≤°ÊúâÊâçËØªËÅäÂ§©ËÆæÁΩÆÔºåÊúÄÂêéÈªòËÆ§"Ta"
    const chatSettings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
    const charName = data.charName || chatSettings.title || "Ta";
    const userName = data.name || "Áé©ÂÆ∂";
    // üî•üî•üî•„ÄêÊñ∞Â¢û„ÄëÂ©öÂßªÁä∂ÊÄÅÂà§Êñ≠ÈÄªËæë Start üî•üî•üî•
    let marriageContext = "";
    if (data.isMarried) {
        // Â¶ÇÊûúÂ∑≤Â©öÔºåÁªô AI Ê≥®ÂÖ•Â§´Â¶ªËÆæÂÆöÁöÑÊåá‰ª§
        marriageContext = `
„ÄêÂÖ≥ÈîÆÂÖ≥Á≥ªÁä∂ÊÄÅ„ÄëÔºö‚úÖ Â∑≤Â©ö (Â§´Â¶ªÂÖ≥Á≥ª)
ËØ∑Âú®ÊèèÂÜô‰∫íÂä®Êó∂Ôºå‰ΩìÁé∞Âá∫Â©öÂêéÁöÑ‰∫≤ÂØÜÊÑü„ÄÅÈªòÂ•ëÊÑüÊàñÁîüÊ¥ªÊÑü„ÄÇ
Áß∞Âëº‰∏äÂèØ‰ª•Êõ¥Âä†‰∫≤ÊòµÔºàÂ¶ÇËÄÅÂÖ¨/ËÄÅÂ©Ü/‰∫≤Áà±ÁöÑÔºåÊàñËÄÖÁ¨¶Âêà‰∫∫ËÆæÁöÑÊòµÁß∞Ôºâ„ÄÇ
`;
    } else {
        // Â¶ÇÊûúÊú™Â©öÔºå‰øùÊåÅÂéüÊúâÁöÑÊößÊòßÊàñËøΩÊ±ÇÁä∂ÊÄÅ
        marriageContext = `
„ÄêÂÖ≥ÈîÆÂÖ≥Á≥ªÁä∂ÊÄÅ„ÄëÔºö‚¨ú Êú™Â©ö (ÊÅãÁà±ÊàñËøΩÊ±Ç‰∏≠)
ËØ∑Ê†πÊçÆÂ•ΩÊÑüÂ∫¶Êï∞ÂÄºÊù•ÂÜ≥ÂÆö‰∫íÂä®ÁöÑË∑ùÁ¶ªÊÑü„ÄÇ
`;
    }
    // üî•üî•üî•„ÄêÊñ∞Â¢û„ÄëÂ©öÂßªÁä∂ÊÄÅÂà§Êñ≠ÈÄªËæë End üî•üî•üî•

    // „Äê‰øÆÊîπÁÇπ2„Äë‰øùÁïôÂéüÁâàÈÄªËæëÔºå‰ΩÜÂú®ÊúÄÂêéÂä†ÂÖ•Ê†ºÂºèÈôêÂà∂Êåá‰ª§
    const systemPrompt = `
‰Ω†ÊòØ‰∏Ä‰∏™È´òËá™Áî±Â∫¶ÊñáÂ≠óÂÜíÈô©Ê∏∏Êàè(MUD)ÁöÑGM„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÊ∏∏ÊàèËÆæÂÆö„ÄëÔºö${gameCtx}
„ÄêÁé©ÂÆ∂‰ø°ÊÅØ„ÄëÔºö
- ÊòµÁß∞Ôºö${userName}
- Áä∂ÊÄÅÔºöÈáëÈí±${data.money} / Ê∏ÖÊ¥ÅÂ∫¶${data.cleanliness}
- **Áé©ÂÆ∂ÂØπ${charName}ÁöÑÂñúÁà±Â∫¶**Ôºö${data.affection} (Êï∞ÂÄºË∂äÈ´òÔºå‰ª£Ë°®Áé©ÂÆ∂Ë∂ä‰∏ªÂä®„ÄÅË∂äÊ∑±ÊÉÖ)
-${marriageContext} 

„ÄêÂΩìÂâç‰ΩçÁΩÆ„ÄëÔºö${window.currentAdvScene || "Êú™Áü•Âú∫ÊôØ"}
${extraContext}

„Äê‰ªªÂä°„ÄëÔºö
ÁîüÊàê‰∏ÄÊÆµ 100-200 Â≠óÁöÑÂâßÊÉÖ‰∫íÂä®„ÄÇ
1. ËØ∑Ê†πÊçÆ‚ÄúÁé©ÂÆ∂ÂØπËßíËâ≤ÁöÑÂñúÁà±Â∫¶‚ÄùÊù•ÊèèÂÜôÁé©ÂÆ∂ÁöÑÂøÉÁêÜÊ¥ªÂä®ÊàñÁªÜÂæÆÂä®‰Ωú„ÄÇÔºàËßíËâ≤‰ºö‰∏ÄÁõ¥Áà±Áé©ÂÆ∂Ôºâ
2. ÊèèÂÜôËßíËâ≤Ôºà${charName}ÔºâÂØπÁé©ÂÆ∂Ë°å‰∏∫ÁöÑÂèçÂ∫î„ÄÇ
3. ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚ÄùÊåá‰ª£Áé©ÂÆ∂„ÄÇ

„Äê‚ö†Ô∏è ÁªùÂØπÊ†ºÂºèÁ¶Å‰ª§ ‚ö†Ô∏è„ÄëÔºö
1. **Á¶ÅÊ≠¢‰ΩøÁî®MarkdownÁ¨¶Âè∑**ÔºöÁªùÂØπ‰∏çË¶ÅÂú®ËæìÂá∫‰∏≠‰ΩøÁî® ** Êàñ * Á¨¶Âè∑Êù•Âä†Á≤ó„ÄÇ
2. **Âº∫Âà∂‰ΩøÁî®ÂêçÂ≠ó**ÔºöÊèêÂà∞ËßíËâ≤Êó∂ÔºåÂøÖÈ°ªÁõ¥Êé•‰ΩøÁî®ÂêçÂ≠ó"${charName}"ÔºåÁ¶ÅÊ≠¢‰ΩøÁî®"Ta"„ÄÅ"‰ªñ"„ÄÅ"Â•π"Êàñ"ËßíËâ≤"Êù•‰ª£Êåá„ÄÇ
`;

    // Ê®°ÊãüÁ≠âÂæÖ
    // Ê≥®ÊÑèÔºöËøôÈáåÂ∞ùËØïË∞ÉÁî® showAdvDialog (Â¶ÇÊûúÊúâ) ÊàñËÄÖ startAdvStory (Â¶ÇÊûúÊúâÊâìÂ≠óÊú∫Ë°•‰∏Å)
    if(typeof showAdvDialog === 'function') showAdvDialog("Ê≠£Âú®ÁîüÊàêÂâßÊÉÖ...", "System");

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");
    if(!apiUrl) apiUrl = "https://api.openai.com/v1";
    if(!model) model = "gpt-3.5-turbo";

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:systemPrompt}, {role:"user", content:userPrompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        let content = json.choices[0].message.content;
        
        // „Äê‰øÆÊîπÁÇπ3„ÄëÊö¥ÂäõÊ∏ÖÊ¥óÔºöÊó†ËÆ∫ AI ÊòØÂê¶Âê¨ËØùÔºåÈÉΩÂú®ÂâçÁ´ØÂº∫Âà∂Âà†ÊéâÊòüÂè∑
        content = content.replace(/\*\*/g, "").replace(/\*/g, ""); 

        // ‰ºòÂÖà‰ΩøÁî®ÊâìÂ≠óÊú∫ÊïàÊûú(startAdvStory)ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÊôÆÈÄöÂØπËØùÊ°Ü(showAdvDialog)
        if (typeof startAdvStory === 'function') {
            startAdvStory(content);
        } else {
            showAdvDialog(content, "System");
        }
        
        saveAdvHistory(userPrompt, content, window.currentAdvScene);
        
    } catch(e) {
        alert("API Error: " + e.message);
    }
};

// --- 5. ‰º†Á∫∏Êù°ÈÄªËæë‰øÆÊ≠£ (Á°Æ‰øùËß¶ÂèëËßíËâ≤Á´ãÁªò) ---
const _origExecuteAdvLogic = window.executeAdvLogic;
window.executeAdvLogic = function(logicKey) {

    if (logicKey === 'pass_note') {
        const input = prompt("Âú®Á∫∏Êù°‰∏äÂÜô‰ªÄ‰πàÔºü");
        if (input) {
            // ËøôÈáåÊàë‰ª¨ÁâπÂà´Ê†áÊ≥® "‰º†Á∫∏Êù°"ÔºåËÆ© AI Áü•ÈÅìÊòØËßíËâ≤‰∫íÂä®
            callGlobalLLM(`Êàë‰º†‰∫Ü‰∏ÄÂº†Á∫∏Êù°ÁªôËßíËâ≤Ôºå‰∏äÈù¢ÂÜôÁùÄÔºö"${input}"`, "interact", "„ÄêÁâπÊÆäÊåá‰ª§„ÄëËØ∑ÊèèÂÜôËßíËâ≤Êî∂Âà∞Á∫∏Êù°ÂêéÁöÑÂèçÂ∫îÔºåÂπ∂ÂÜôÂá∫taÁöÑÂõû‰ø°ÂÜÖÂÆπ„ÄÇ");
        }
    } else {
        // ÂÖ∂‰ªñÈÄªËæëËµ∞ÂéüÂáΩÊï∞ (Â¶ÇÊûúÂéüÂáΩÊï∞ÈáåÊúâÁ°¨ÁºñÁ†ÅÁöÑ msgÔºåÊàë‰ª¨ÈúÄË¶ÅÊã¶Êà™ÂÆÉÊîπÁî® startAdvStory)
        // ‰∏∫‰∫ÜÁÆÄÂçïÔºåÊàë‰ª¨ÈáçÂÜô switch ÈÉ®ÂàÜÔºåÊää showAdvDialog ÊõøÊç¢‰∏∫ startAdvStory
        
        const data = getAdvData();
        let msg = "";
        
        // Â§çÁî®‰πãÂâçÁöÑÈÄªËæëÔºå‰ΩÜÊîπÊàêÁîüÊàêÂ≠óÁ¨¶‰∏≤
        switch(logicKey) {
            case 'study': modAdv({ attributes: { learning: rnd(1,3) } }); msg = `‰Ω†ÁøªÂºÄ‰π¶Êú¨ËÆ§ÁúüÂ≠¶‰π†... (Â≠¶‰π†+${rnd(1,3)})`; break;
            case 'daydream': msg = "‰Ω†ÊúõÁùÄÁ™óÂ§ñÂèë‰∫Ü‰∏Ä‰ºöÂÑøÂëÜÔºå‰∫ëÊúµÂÉèÊ£âËä±Á≥ñ‰∏ÄÊ†∑..."; break;
            // ... ÂÖ∂‰ªñ‰∏çÈúÄË¶Å AI ÁîüÊàêÁöÑÁÆÄÂçïÈÄªËæë ...
            // Ââ©‰∏ãÁöÑ‰øùÁïôÂéüÊ†∑ÔºåÂ¶ÇÊûúÊòØË¥≠‰π∞Áâ©ÂìÅÁ≠âÔºåÁõ¥Êé•ÂºπÁ™óÂç≥ÂèØ
            default: _origExecuteAdvLogic(logicKey); return; 
        }
        
        if (msg) startAdvStory(msg);
    }
};

// --- 6. ÂéÜÂè≤ËÆ∞ÂΩïÂ±ïÂºÄ‰øÆÂ§ç ---
window.openAdvHistory = function() {
    const modal = document.getElementById('adv-history-modal');
    const list = document.getElementById('adv-history-list');
    const data = getAdvData();
    
    list.innerHTML = '';
    
    if(!data.history || data.history.length === 0) {
        list.innerHTML = "<div style='text-align:center;color:#999;'>ÊöÇÊó†ÂõûÂøÜ</div>";
    }

    (data.history || []).forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'adv-history-item'; // ‰ΩøÁî®Êñ∞ÁöÑ CSS Á±ª
        div.onclick = function() { this.classList.toggle('expanded'); }; // ÁÇπÂáªÂ±ïÂºÄ/Êî∂Ëµ∑
        
                // ... Âú® forEach Âæ™ÁéØÂÜÖÈÉ® ...
        div.innerHTML = `
            <div class="adv-history-summary">
                <div style="display:flex; flex-direction:column;">
                    <span>${item.date} @ ${item.scene}</span>
                    <span style="font-size:0.8rem; opacity:0.7;">${item.action.substring(0, 10)}...</span>
                </div>
                <!-- üëá Êñ∞Â¢ûÂà†Èô§ÊåâÈíÆ üëá -->
                <div onclick="event.stopPropagation(); deleteAdvHistory(${index})" style="color:#ff6b6b; font-weight:bold; padding:5px 10px;">√ó</div>
            </div>
            <div class="adv-history-detail">
                <strong>‰Ω†ÁöÑË°åÂä®Ôºö</strong>${item.action}<br><br>
                <strong>ÂâßÊÉÖÂèëÁîüÔºö</strong><br>${item.result}
            </div>
            <div style="text-align:right; margin-top:5px; font-size:0.8rem;">
                <label onclick="event.stopPropagation()"><input type="checkbox" ${item.isImportant?'checked':''} onchange="toggleImportant(${index})"> ‚≠ê ËÆæ‰∏∫ÈáçË¶ÅÂõûÂøÜ</label>
            </div>
        `;
        list.appendChild(div);
    });
    
    modal.style.display = 'flex';
};

console.log("‚úÖ ÊñáÊ∏∏‰ΩìÈ™åË°•‰∏ÅÂ∑≤Âä†ËΩΩ (ÁÇπÂáªÁøªÈ°µ / Á´ãÁªòÂà§ÂÆö / ÂêçÂ≠ó‰øÆÊîπ / ÂéÜÂè≤Â±ïÂºÄ)");
// ============================================================
// üõ†Ô∏è ÊñáÊ∏∏‰øÆÂ§çË°•‰∏Å V2ÔºöÂêçÂ≠óËá™ÂÆö‰πâ & ‰º†Á∫∏Êù°ÂÆöÂêë‰ºòÂåñ
// ============================================================

// 1. „ÄêÈáçÂÜô„ÄëÊç¢Ë°£Èó¥Ê∏≤ÊüìÔºöÂ¢ûÂä†ÂêçÂ≠óËÆæÁΩÆËæìÂÖ•Ê°Ü
window.renderClosetUI = function() {
    // Á°Æ‰øùÊï∞ÊçÆÁªìÊûÑÂ≠òÂú®
    if (!window.BIG_MEMORY.adv_data) window.BIG_MEMORY.adv_data = {};
    const data = window.BIG_MEMORY.adv_data;
    
    // ÂàùÂßãÂåñÂêçÂ≠óÂ≠óÊÆµ (Â¶ÇÊûú‰∏çÂ≠òÂú®)
    if (!data.name) data.name = "Áé©ÂÆ∂";
    if (!data.charName) data.charName = "Ta"; // ÈªòËÆ§‰∏∫ Ta

    const container = document.getElementById('adv-scene-container');
    container.innerHTML = ''; 
    container.style.backgroundImage = 'none'; 
    container.style.backgroundColor = '#fdfbf7';
    
    // ÂÖÅËÆ∏ÁÇπÂáªÂêçÂ≠óÁõ¥Êé•‰øÆÊîπ
    const html = `
    <div class="closet-container">
        <div class="closet-header">
            <h3>üëó Êç¢Ë°£Èó¥ & ËÆæÂÆö</h3>
            <button class="m-btn small" onclick="renderAdvScene('home_room')">üîô ÂÆåÊàêÂπ∂Á¶ªÂºÄ</button>
        </div>

        <!-- üî¥ Êñ∞Â¢ûÔºöÂêçÂ≠óËÆæÂÆöÂå∫Âüü -->
        <div class="morandi-card" style="padding:15px; margin-bottom:15px; background:#fff;">
            <h4 style="margin:0 0 10px 0; color:#5d4037;">üìù Áß∞ÂëºËÆæÂÆö (ÂÜ≥ÂÆöÁ´ãÁªòÊòæÁ§∫)</h4>
            <div class="input-group">
                <label>‰Ω†ÁöÑÂêçÂ≠ó (Â∑¶‰æßÁ´ãÁªò)</label>
                <input type="text" id="set-adv-user" value="${data.name}" onblur="saveAdvNames()" style="border:1px solid #8d6e63; color:#5d4037;">
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>ËßíËâ≤ÂêçÂ≠ó (Âè≥‰æßÁ´ãÁªò)</label>
                <input type="text" id="set-adv-char" value="${data.charName}" onblur="saveAdvNames()" style="border:1px solid #8d6e63; color:#5d4037;">
            </div>
            <div style="font-size:0.7rem; color:#aaa; margin-top:5px;">* ‰øÆÊîπÂêéÔºåÂâßÊÉÖ‰∏≠Âá∫Áé∞ËØ•ÂêçÂ≠óÊó∂‰ºöËá™Âä®ÊòæÁ§∫ÂØπÂ∫îÁ´ãÁªò„ÄÇ</div>
        </div>

        <div class="closet-avatars">
            <div class="closet-avatar-box" onclick="document.getElementById('upload-user-adv').click()">
                ${data.avatars.user ? `<img src="${data.avatars.user}">` : '<span>ÁÇπÂáª‰∏ä‰º†<br>‰Ω†ÁöÑÁ´ãÁªò</span>'}
            </div>
            <div class="closet-avatar-box" onclick="document.getElementById('upload-char-adv').click()">
                ${data.avatars.char ? `<img src="${data.avatars.char}">` : '<span>ÁÇπÂáª‰∏ä‰º†<br>ËßíËâ≤Á´ãÁªò</span>'}
            </div>
        </div>
        <input type="file" id="upload-user-adv" style="display:none" onchange="uploadAdvImg('user', this)">
        <input type="file" id="upload-char-adv" style="display:none" onchange="uploadAdvImg('char', this)">

        <table class="attr-table">
            <tr><td>üìö Â≠¶‰π†</td><td>${data.attributes.learning}</td></tr>
            <tr><td>üé® ÁîªÁîª</td><td>${data.attributes.art}</td></tr>
            <tr><td>üéª ÊâçËâ∫</td><td>${data.attributes.talent}</td></tr>
            <tr><td>üèÉ ‰ΩìËÉΩ</td><td>${data.attributes.fitness}</td></tr>
            <tr><td>‚ù§Ô∏è ÂØπ${data.charName}ÁöÑÂ•ΩÊÑü</td><td>${data.affection}</td></tr>
            <tr><td>‚ú® Ê∏ÖÊ¥ÅÂ∫¶</td><td>${Math.floor(data.cleanliness)}%</td></tr>
            <tr><td>üí∞ ÈáëÈí±</td><td>${Math.floor(data.money)}</td></tr>
        </table>

        <div style="font-weight:bold; margin-bottom:10px;">üëú ÊàëÁöÑËÉåÂåÖ</div>
        <div class="inv-list" id="adv-inv-list"></div>
    </div>`;
    
    container.innerHTML = html;
    renderInventoryItems();
    hideAdvDialog();
};

// Êñ∞Â¢ûÔºö‰øùÂ≠òÂêçÂ≠óÈÄªËæë
window.saveAdvNames = function() {
    const data = getAdvData();
    const uName = document.getElementById('set-adv-user').value.trim();
    const cName = document.getElementById('set-adv-char').value.trim();
    
    if(uName) data.name = uName;
    if(cName) data.charName = cName;
    
    saveAdvData(data); // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
    // Êõ¥Êñ∞È°∂ÈÉ®UI
    document.getElementById('adv-user-name').innerText = data.name;
};

// 2. „ÄêÈáçÂÜô„ÄëÁ´ãÁªòÊòæÁ§∫ÈÄªËæëÔºö‰∏•Ê†ºÂåπÈÖçËá™ÂÆö‰πâÂêçÂ≠ó
window.renderCurrentChunk = function() {
    const text = advStoryQueue[advCurrentChunkIndex];
    const data = getAdvData();
    
    // Ëé∑ÂèñÂΩìÂâçËÆæÂÆöÁöÑÂêçÂ≠ó
    const userName = data.name || "Áé©ÂÆ∂";
    const charName = data.charName || "Ta";
    
    // Êõ¥Êñ∞ÊñáÊú¨
    document.getElementById('adv-dialog-text').innerText = text;
    
    // --- Êô∫ËÉΩÁ´ãÁªòÂà§Êñ≠ (‰ºòÂÖàÁ∫ßÔºöËßíËâ≤ > Áî®Êà∑) ---
    
    // 1. Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´„ÄêËßíËâ≤ÂêçÂ≠ó„Äë
    if (text.includes(charName) || text.includes("ËßíËâ≤")) {
        document.getElementById('adv-dialog-name').innerText = charName;
        updateTachieDisplay("char"); // ÊòæÁ§∫Âè≥Ëæπ
        updateSmallAvatar("char");
    } 
    // 2. Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´„ÄêÁî®Êà∑ÂêçÂ≠ó„ÄëÊàñ "‰Ω†"/"Êàë"
    else if (text.includes(userName) || text.includes("‰Ω†") || text.includes("Êàë")) {
        document.getElementById('adv-dialog-name').innerText = userName;
        updateTachieDisplay("user"); // ÊòæÁ§∫Â∑¶Ëæπ
        updateSmallAvatar("user");
    } 
    // 3. ÊóÅÁôΩ
    else {
        document.getElementById('adv-dialog-name').innerText = ""; 
        updateTachieDisplay("hide_all"); 
        document.getElementById('adv-dialog-img').style.backgroundImage = 'none';
        document.getElementById('adv-dialog-img').style.backgroundColor = 'transparent';
    }
};

// 3. „ÄêÈáçÂÜô„Äë‰º†Á∫∏Êù°ÈÄªËæëÔºöÂº∫Âà∂ËßíËâ≤ÂõûÂ§ç
// Ë¶ÜÁõñÂéüÊúâÁöÑ executeAdvLogic ‰∏≠ÁöÑ switch ÈÉ®ÂàÜ
const _origLogicV2 = window.executeAdvLogic;
window.executeAdvLogic = function(logicKey) {
  // --- ÊâæÂà∞ window.executeAdvLogic ÂáΩÊï∞ÂÜÖÈÉ® ---
    // =========== üëá Á≤òË¥¥ËøôÊÆµ‰øÆÂ§ç‰ª£Á†Å üëá ===========
    
    // 1. Ë°•ÂõûÔºöÊ∏ÖÊ¥ÅÂ∫¶Ê£ÄÊü• (Â¶ÇÊûúÂ§™ËÑè‰∏î‰∏çÊòØÂéªÊ¥óÊæ°ÔºåÊã¶Êà™Êìç‰Ωú)
    const _checkData = getAdvData();
    if (_checkData.cleanliness <= 0 && logicKey !== 'bath_normal') {
        return showAdvDialog("Ë∫´‰∏äÂ§™ËÑè‰∫ÜÔºåÁîöËá≥Ë¢´ËãçËùáÂåÖÂõ¥‰∫Ü...\n(ËØ∑Âéª„ÄêÊµ¥ÂÆ§„ÄëÊ≥°Êæ°ÊÅ¢Â§çÔºåÂê¶ÂàôÊó†Ê≥ïË°åÂä®)", "System");
    }

    // 2. Ë°•ÂõûÔºö15% ÈöèÊú∫‰∫ã‰ª∂ÁîüÊàê (ÂåÖÊã¨ÂºπÂá∫ËæìÂÖ•Ê°Ü)
    if (Math.random() < 0.15) {
        // Ëé∑ÂèñÂéüÊú¨Â∫îËØ•ÂèëÁîüÁöÑÊèèËø∞‰Ωú‰∏∫ÈªòËÆ§ÂÄº
        let defaultText = `(Ëß¶ÂèëÈöèÊú∫‰∫ã‰ª∂) ‰Ω†Ê≠£ÂáÜÂ§á${logicKey}...`;
        if (logicKey === 'pass_note') defaultText = "(Ëß¶ÂèëÈöèÊú∫‰∫ã‰ª∂) ‰Ω†Ê≠£ÂáÜÂ§á‰º†Á∫∏Êù°ÁªôTa...";
        if (logicKey === 'cook_food') defaultText = "(Ëß¶ÂèëÈöèÊú∫‰∫ã‰ª∂) ‰Ω†Ëµ∞ËøõÂé®ÊàøÊ≠£ÂáÜÂ§áÂÅöÈ•≠...";
        if (logicKey === 'park_walk') defaultText = "(Ëß¶ÂèëÈöèÊú∫‰∫ã‰ª∂) ‰Ω†Ê≠£ÂáÜÂ§áÂú®ÂÖ¨Âõ≠Êï£Ê≠•...";
        
        document.getElementById('adv-random-input').value = defaultText;
        document.getElementById('adv-random-modal').style.display = 'flex';
        return; // ÈòªÊ≠¢ÂêéÁª≠ÈÄªËæëÔºåÁõ¥Âà∞Â§ÑÁêÜÂÆåÈöèÊú∫‰∫ã‰ª∂
    }

    // =========== üëÜ Á≤òË¥¥ÁªìÊùü üëÜ ===========

if (logicKey === 'pass_note') {
    // 1. ÂÆö‰πâÈöèÊú∫ÂÜÖÂÆπÊ±†
    const notes = [
        "‰Ω†‰ª¨‰ø©Ë¢´ËÄÅÂ∏àÂè´Ëµ∑Êù•ÁΩöÁ´ô‰∫Ü„ÄÇ",
        "‰ªñÁªô‰Ω†‰º†‰∫ÜÂº†Á∫∏Êù°Ôºå‰Ω†ÊâìÂºÄÂêéÂèëÁé∞ÊòØÔºöÁà±‰Ω†„ÄÇ",
        "‰ªñÁªô‰Ω†‰º†‰∫ÜÁ∫∏Êù°ÔºöË¶Å‰∏çË¶Å‰∏ãËØæÂêé‰∏ÄËµ∑ÂéªÂêÉÈ•≠Ôºü"
    ];
    // 2. ÈöèÊú∫ÊäΩÂèñ‰∏ÄÂè•
    const randomNote = notes[Math.floor(Math.random() * notes.length)];
    
    // 3. Â¢ûÂä†Â•ΩÊÑüÂ∫¶ (ÂèØÈÄâ)
    modAdv({ affection: 2 });

    // 4. Áõ¥Êé•ÊòæÁ§∫ÂØπËØù (Á¨¨‰∫å‰∏™ÂèÇÊï∞ "Character" ‰ºöÂº∫Âà∂Ëß¶ÂèëÂè≥‰æßÁ´ãÁªò)
    // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨Áõ¥Êé•Ë∞ÉÁî® showAdvDialog Âç≥ÂèØÔºå‰∏çÁî®Ëµ∞ AI ÁîüÊàê‰∫Ü
    showAdvDialog(randomNote, "Character");
    
    } 
else {
        // ÂÖ∂‰ªñÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºå‰ΩÜ‰∏∫‰∫ÜÁ°Æ‰øùÁ´ãÁªòÂà§ÂÆöÔºåÁ®çÂæÆ‰øÆÊîπÊôÆÈÄöÈÄªËæëÁöÑËæìÂá∫
        const data = getAdvData();
        let msg = "";
        
        switch(logicKey) {
            case 'study': 
                modAdv({ attributes: { learning: rnd(1,3) } }); 
                // Âä†‰∏ä"‰Ω†"ÔºåËß¶ÂèëÂ∑¶‰æßÁ´ãÁªò
                msg = `‰Ω†ÁøªÂºÄ‰π¶Êú¨ËÆ§ÁúüÂ≠¶‰π†... (Â≠¶‰π†Â±ûÊÄß‰∏äÂçá)`; 
                break;
            case 'daydream': 
                msg = "‰Ω†ÊúõÁùÄÁ™óÂ§ñÂèë‰∫Ü‰∏Ä‰ºöÂÑøÂëÜÔºå‰∫ëÊúµÂÉèÊ£âËä±Á≥ñ‰∏ÄÊ†∑..."; 
                break;
            case 'cook_food':
                const f = rnd(0,3); modAdv({}); if(f>0) advAddItem("ÊñôÁêÜ",f,"food"); 
                msg = `‰Ω†Âú®Âé®ÊàøÂøôÁ¢å‰∫Ü‰∏ÄÈòµÔºåÂÅö‰∫Ü ${f} ‰ªΩÊñôÁêÜ„ÄÇ`; 
                break;
            case 'park_walk':
                modAdv({affection:2}); 
                // Âä†‰∏äËßíËâ≤ÂêçÔºåËß¶ÂèëÂè≥‰æßÁ´ãÁªò
                msg = `${data.charName || "Ta"}Èô™‰Ω†Âú®ÂÖ¨Âõ≠Êï£Ê≠•ÔºåÂøÉÊÉÖÁúãËµ∑Êù•‰∏çÈîô„ÄÇ(Â•ΩÊÑü+2)`; 
                break;
            default: 
                // Ë∞ÉÁî®ÂéüÂßãÈÄªËæëÂ§ÑÁêÜË¥≠‰π∞Á≠â
                _origLogicV2(logicKey); 
                return; 
        }
        
        if (msg) startAdvStory(msg);
    }
};

console.log("‚úÖ ÊñáÊ∏∏Ë°•‰∏Å V2 Âä†ËΩΩÂÆåÊØïÔºöÂêçÂ≠óËá™ÂÆö‰πâ + ‰º†Á∫∏Êù°Á´ãÁªò‰øÆÊ≠£");
// ============================================================
// üé® Á´ãÁªòÈÄªËæë‰øÆÊ≠£ÔºöÊóÅÁôΩÈªòËÆ§ÊòæÁ§∫Áé©ÂÆ∂
// ============================================================

window.renderCurrentChunk = function() {
    const text = advStoryQueue[advCurrentChunkIndex];
    const data = getAdvData();
    
    // Ëé∑ÂèñÂΩìÂâçËÆæÂÆöÁöÑÂêçÂ≠ó
    const userName = data.name || "Áé©ÂÆ∂";
    const charName = data.charName || "Ta";
    
    // Êõ¥Êñ∞ÊñáÊú¨ÂÜÖÂÆπ
    document.getElementById('adv-dialog-text').innerText = text;
    
    // --- Êô∫ËÉΩÁ´ãÁªòÂà§Êñ≠ (‰ºòÂÖàÁ∫ßÔºöËßíËâ≤ > ÈªòËÆ§Áé©ÂÆ∂) ---
    
    // 1. Â¶ÇÊûúÊñáÊú¨ÂåÖÂê´„ÄêËßíËâ≤ÂêçÂ≠ó„ÄëÊàñ "ËßíËâ≤" -> ÂàáÊç¢Âà∞Âè≥‰æßÁ´ãÁªò
    if (text.includes(charName) || text.includes("ËßíËâ≤")) {
        document.getElementById('adv-dialog-name').innerText = charName;
        updateTachieDisplay("char"); // ÊòæÁ§∫Âè≥Ëæπ
        updateSmallAvatar("char");   // ÂàáÊç¢Â∞èÂ§¥ÂÉè
    } 
    // 2. ÂÖ∂‰ªñÊÉÖÂÜµ (ÂåÖÂê´ "‰Ω†"/"Êàë" ÊàñËÄÖ Á∫ØÊóÅÁôΩ) -> ÂÖ®ÈÉ®ÈªòËÆ§ÊòæÁ§∫Áé©ÂÆ∂Á´ãÁªò
    else {
        // Â¶ÇÊûúÊñáÊú¨ÈáåÊòéÁ°ÆÊúâÁé©ÂÆ∂ÂêçÂ≠óÔºåÂêçÂ≠óÊ†èÊòæÁ§∫ÂêçÂ≠óÔºõÂ¶ÇÊûúÊòØÊóÅÁôΩÔºåÂêçÂ≠óÊ†èÁïôÁ©∫
        if (text.includes(userName) || text.includes("‰Ω†") || text.includes("Êàë")) {
            document.getElementById('adv-dialog-name').innerText = userName;
        } else {
            // ÊóÅÁôΩÊ®°ÂºèÔºöÂêçÂ≠óÊ†è‰∏∫Á©∫Ôºå‰ΩÜÁ´ãÁªò‰æùÊóßÊòæÁ§∫Áé©ÂÆ∂
            document.getElementById('adv-dialog-name').innerText = ""; 
        }
        
        // ÂÖ≥ÈîÆ‰øÆÊîπÔºöÊó†ËÆ∫ÊòØÂê¶ÊóÅÁôΩÔºåÈÉΩÂº∫Âà∂ÊòæÁ§∫Áî®Êà∑Á´ãÁªò
        updateTachieDisplay("user"); // ÊòæÁ§∫Â∑¶Ëæπ
        updateSmallAvatar("user");   // ÂàáÊç¢Â∞èÂ§¥ÂÉè
    }
};

console.log("‚úÖ Á´ãÁªòÈÄªËæëÂ∑≤Êõ¥Êñ∞ÔºöÊóÅÁôΩÁé∞Âú®‰ºöÊòæÁ§∫Áé©ÂÆ∂Á´ãÁªò");
</script>
<!-- ================= üî¥ Â≠¶‰π†ÊÄªÁªì APP ‰øÆÂ§çË°•‰∏Å END üî¥ ================= -->
<div id="lofter-modal" class="modal-overlay" style="background:#fff;">
    <div class="fridge-header-clean" style="border-bottom:none;">
        <button class="fh-btn" onclick="document.getElementById('lofter-modal').style.display='none'">‚ùÆ ËøîÂõû</button>
        <span class="fh-title" style="color:#2c6e49; font-weight:900; letter-spacing:1px;">LOFTER</span>
        <div style="width:30px;"></div> <!-- Âç†‰Ωç -->
    </div>
    
    <!-- Êñ∞Â¢ûÔºöÁî®Êà∑Ë¶ÅÊ±ÇËæìÂÖ•Ê°Ü -->
    <div class="lofter-toolbar">
        <input type="text" id="lofter-user-req" class="lofter-input" placeholder="ËæìÂÖ•Ê¢ó/ËÆæÂÆö/ÊÉ≥ÁúãÁöÑ (Â¶Ç: Ê†°Âõ≠PA/Á†¥ÈïúÈáçÂúÜ)...">
        <button class="fh-btn" onclick="generateLofterFeed()" style="font-weight:bold; color:#2c6e49;">‰∫ßÁ≤Æ</button>
    </div>

    <div id="lofter-scroll-area" style="flex:1; overflow-y:auto; background:#f2f2f2; padding:10px;">
        <div id="lofter-feed-list"></div>
        <div style="text-align:center; padding:20px; color:#999; font-size:0.8rem;">
            <span onclick="clearLofterHistory()" style="text-decoration:underline; cursor:pointer;">Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤</span>
        </div>
    </div>
</div>

<div id="lofter-detail-modal" class="modal-overlay" style="background:#fff; z-index:2100;">
    <div class="fridge-header-clean">
        <button class="fh-btn" onclick="closeLofterDetail()">‚ùÆ ËøîÂõûÂàóË°®</button>
        <span class="fh-title">ÈòÖËØªÊ≠£Êñá</span>
        <div style="width:30px;"></div>
    </div>
    <div id="lofter-article-body" style="flex:1; overflow-y:auto; padding:20px; font-family:'Songti SC', serif; line-height:1.8;">
        <!-- Ê≠£ÊñáÂÜÖÂÆπ -->
    </div>
</div>
<!-- ÂÖ≥‰∫éÁóõËã¶ APP ‰∏ªÁïåÈù¢ -->
<div id="pain-app-modal" class="modal-overlay" style="background:#f5f6fa;">
    <div class="modal-header" style="background:#dcdde1; color:#2f3640;">
        <span>ÂÖ≥‰∫éÁóõËã¶ ¬∑ Pain & Healing</span>
        <button class="close-btn" onclick="document.getElementById('pain-app-modal').style.display='none'">√ó</button>
    </div>
    
    <div class="modal-body" style="padding:0;">
        <!-- È°∂ÈÉ®Ê†áÁ≠æÂàáÊç¢ -->
        <div style="display:flex; background:#fff; padding:10px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <button class="m-btn small" onclick="switchPainTab('his')" id="btn-tab-his" style="flex:1; margin-right:5px; background:#2f3640; color:white;">ÂÖ≥‰∫é‰ªñÁöÑÁóõËã¶</button>
            <button class="m-btn small" onclick="switchPainTab('my')" id="btn-tab-my" style="flex:1; margin-left:5px; background:#dfe4ea;">ÂÖ≥‰∫é‰Ω†ÁöÑÁóõËã¶</button>
        </div>

        <!-- 1. ÂÖ≥‰∫é‰ªñÁöÑÁóõËã¶ -->
        <div id="pain-tab-his" style="padding:20px; overflow-y:auto; padding-bottom:80px;">
            <div class="morandi-card" style="text-align:center; padding:30px; margin-bottom:20px;">
                <h3 style="color:#2f3640;">Ê¥ûÂØü‰ªñÁöÑ‰º§Áóï</h3>
                <p style="font-size:0.8rem; color:#7f8fa6;">ÈÄöËøáÁâåÊÑèÔºåÊÑüÁü•‰ªñÊú™ÊõæË®ÄËØ¥ÁöÑÁóõÊ•ö‰∏éÊ∏¥Êúõ„ÄÇ</p>
                <button class="m-btn primary" onclick="startPainDraw('his')" style="margin-top:15px; background:#2f3640;">üîÆ ÊäΩÂèñÁâåÁªÑÂπ∂Ëß£Êûê</button>
            </div>
            <div id="pain-his-history"></div> <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂå∫ -->
        </div>

        <!-- 2. ÂÖ≥‰∫é‰Ω†ÁöÑÁóõËã¶ -->
        <div id="pain-tab-my" style="display:none; padding:20px; overflow-y:auto; padding-bottom:80px;">
            <div class="morandi-card">
                <h3 style="margin-bottom:15px; color:#2f3640;">ÂÄæËØâ‰∏éÁñóÊÑà</h3>
                <div class="input-group"><label>ÁóõËã¶ÁöÑÊ†πÊ∫ê (Pain)</label><textarea id="my-pain-source" class="editor-textarea" style="height:60px;"></textarea></div>
                <div class="input-group"><label>‰Ω†ÁöÑÊÑüÂèó (Feeling)</label><textarea id="my-pain-feeling" class="editor-textarea" style="height:60px;"></textarea></div>
                <div class="input-group"><label>ÁõÆÂâçÁöÑÊÉ≥Ê≥ï (Thought)</label><textarea id="my-pain-thought" class="editor-textarea" style="height:60px;"></textarea></div>
                <div class="input-group"><label>ÊúüÊúõÁöÑË∞ÉËäÇÊñπÊ°à (Plan)</label><textarea id="my-pain-plan" class="editor-textarea" style="height:60px;"></textarea></div>
                <div class="input-group"><label>Â∏åÊúõ‰ªñÂ¶Ç‰ΩïÂ∏Æ‰Ω† (Help)</label><textarea id="my-pain-help" class="editor-textarea" style="height:60px;"></textarea></div>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="m-btn secondary" onclick="saveMyPainDraft()">üíæ ÊöÇÂ≠òËçâÁ®ø</button>
                    <button class="m-btn primary" onclick="startPainDraw('my')" style="background:#2f3640;">üì® ÂèëÈÄÅÂπ∂Ëé∑ÂèñÂõûÂ∫î</button>
                </div>
            </div>
            <div id="pain-my-reply-area" style="margin-top:20px;"></div>
        </div>
    </div>
</div>
<!-- üî• ‰øÆÊ≠£ÁâàÔºöÂÖ≥‰∫éÁóõËã¶‰∏ìÁî®ÂÖ®ÂäüËÉΩÁâåÊ°å (114Âº†ÂÖ®ÁâåÂ∫ì) -->
<div id="pain-card-table-modal" class="modal-overlay" style="background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(5px);">
    <div id="pain-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; box-shadow: inset 0 0 100px rgba(0,0,0,0.8);">
        <!-- ËøôÈáåÁöÑ ID ÊòØ pain-card-areaÔºåÁî®‰∫é JS ÁîüÊàêÂç°Áâá -->
        <div id="pain-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
        </div>
        
        <!-- Â∫ïÈÉ®ÊéßÂà∂Ê†è -->
        <div class="card-table-ui">
            <div style="color:#dcdde1; text-shadow:0 1px 3px #000; font-weight:bold;">
                ËØ∑ÊäΩÂèñËÉΩÂ§üÊè≠Á§∫ÁúüÁõ∏ÁöÑÁâå... (Â∑≤ÈÄâ: <span id="pain-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishPainAnalysis()" style="background:#2f3640; border:1px solid #718093; box-shadow:0 0 15px rgba(255,255,255,0.1);">
                üëÅÔ∏è Á°ÆËÆ§Âπ∂ÂºÄÂßãËß£ËØª
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('pain-card-table-modal').style.display='none'">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<!-- üç¨ Êâ≠ËõãÊú∫‰∏ªÁïåÈù¢ (ÂéÜÂè≤ËÆ∞ÂΩï + Êú∫Âô®) -->
<div id="gashapon-app-modal" class="modal-overlay" style="background:#fff0f5;">
    <div class="modal-header" style="background:#ffcdd2; color:#c62828;">
        <span>Âπ≥Ë°å‰∏ñÁïåÊâ≠ËõãÊú∫</span>
        <button class="close-btn" onclick="document.getElementById('gashapon-app-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body" style="padding:0; display:flex; flex-direction:column;">
        <!-- Êú∫Âô®Â±ïÁ§∫Âå∫ -->
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, #fff 20%, #ffebee 100%);">
            <div class="gashapon-machine" onclick="triggerGashaponStart()">
                <div class="gm-glass">
                    <div class="gm-ball b1"></div><div class="gm-ball b2"></div><div class="gm-ball b3"></div>
                </div>
                <div class="gm-body">
                    <div class="gm-knob"></div>
                    <div class="gm-exit"></div>
                </div>
                <div class="gm-label">PUSH</div>
            </div>
            <p style="margin-top:20px; color:#ef9a9a; font-weight:bold;">ÁÇπÂáªÊâ≠ËõãÊú∫ÔºåÂºÄÂêØ‰∏ÄÊÆµÂπ≥Ë°å‰∫∫Áîü</p>
        </div>
        
        <!-- Â∫ïÈÉ®ÂéÜÂè≤ËÆ∞ÂΩïÊäΩÂ±â -->
        <div class="gashapon-history-drawer">
            <div class="gh-handle" onclick="toggleGashaponHistory()">üìú Êü•ÁúãÊî∂ËóèÁöÑÊâ≠ËõãÊïÖ‰∫ã</div>
            <div id="gashapon-history-list" class="gh-list"></div>
        </div>
    </div>
</div>

<!-- üç¨ ËæìÂÖ•ËÆæÂÆöÂºπÁ™ó -->
<div id="gashapon-input-modal" class="modal-overlay" style="background:rgba(0,0,0,0.5); z-index:2200; align-items:center; justify-content:center;">
    <div class="morandi-card" style="width:85%; max-width:400px; padding:20px; animation: popIn 0.3s;">
        <h3 style="color:#e91e63; margin-bottom:10px;">ËÆæÂÆö‰Ω†ÁöÑÂπ≥Ë°å‰∏ñÁïå</h3>
        <p style="font-size:0.8rem; color:#888; margin-bottom:10px;">Â¶ÇÊûú‰∏çÂ°´ÔºåÂ∞ÜÈöèÊú∫ÊéâËêΩ‰∏Ä‰∏™‰∏ñÁïå„ÄÇ</p>
        <textarea id="gashapon-scenario" class="editor-textarea" style="height:100px; margin-bottom:15px;" placeholder="‰æãÂ¶ÇÔºö‰ªñÊòØÂê∏Ë°ÄÈ¨ºÔºåÊàëÊòØÁåé‰∫∫ / Êàë‰ª¨ÊòØÈùíÊ¢ÖÁ´πÈ©¨‰ΩÜÂ§±Êï£Â§öÂπ¥ / ABOËÆæÂÆö..."></textarea>
        <div style="display:flex; gap:10px;">
            <button class="m-btn secondary" onclick="document.getElementById('gashapon-input-modal').style.display='none'">ÂèñÊ∂à</button>
            <button class="m-btn primary" onclick="enterGashaponTable()" style="background:#f48fb1;">üé≤‰ª•Ê≠§ËÆæÂÆöÂéªÊäΩÁâå</button>
        </div>
    </div>
</div>

<!-- üç¨ ‰∏ìÁî®Áã¨Á´ãÁâåÊ°å (Â§çÂà∂Ëá™Ê∏∏ÊàèÊú∫ÔºåÊîπID) -->
<div id="gashapon-card-table-modal" class="modal-overlay" style="background: rgba(40, 20, 30, 0.95); backdrop-filter: blur(5px);">
    <div id="gashapon-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px;">
        <div id="gashapon-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;"></div>
        <div class="card-table-ui">
            <div style="color:#f8bbd0; text-shadow:0 1px 5px #000; font-weight:bold;">
                ÊäΩÂèñÂëΩËøêÂç°ÁâåÔºåÁºñÁªá‰∏ñÁïåÁ∫ø... (<span id="gashapon-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishGashaponDrawing()" style="background:#ec407a; border:1px solid #ff80ab; box-shadow:0 0 15px rgba(236, 64, 122, 0.4);">
                üîÆ ÁîüÊàêÂπ≥Ë°åÊïÖ‰∫ã
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('gashapon-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:white;">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<!-- üç¨ ÊúÄÁªàÁªìÊûúÔºöÂ∑®Â§ßÁöÑÊú™ÂºÄÂ∞ÅÊâ≠Ëõã -->
<div id="gashapon-capsule-modal" class="modal-overlay" style="background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center;">
    <div id="big-capsule" class="big-capsule" onclick="openBigCapsule()">
        <div class="bc-top"></div>
        <div class="bc-bottom"></div>
        <div class="bc-text">CLICK TO OPEN</div>
    </div>
    
    <!-- ÊïÖ‰∫ãÁ∫∏Êù° (ÂàùÂßãÈöêËóè) -->
    <div id="gashapon-story-paper" class="story-paper" style="display:none;">
        <div class="sp-header">
            <span id="sp-date">DATE</span>
            <span class="sp-tag">PARALLEL WORLD</span>
        </div>
        <div class="sp-content" id="gashapon-story-content"></div>
        <div class="sp-footer">
            <button class="m-btn small" onclick="closeGashaponResult()">Êî∂ËóèÂπ∂ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>
<!-- ÂÆ†Áâ©ÔºöÈ¢ÜÂÖªÂºπÁ™ó -->
<div id="pet-adopt-modal" class="modal-overlay" style="z-index:5000; background:#fffbe7;">
    <div class="modal-header" style="background:#f0e68c;"><span>È¢ÜÂÖª‰∏≠ÂøÉ</span></div>
    <div class="modal-body" style="text-align:center;">
        <h3>ËØ∑ÈÄâÊã©‰Ω†ÁöÑ‰ºô‰º¥</h3>
        <div id="adopt-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;">
            <!-- JSÂ°´ÂÖÖ -->
        </div>
        <div class="input-group">
            <label>‰∏ä‰º†ÁÖßÁâá (Ëá™ÂÆö‰πâ)</label>
            <input type="file" id="adopt-upload" accept="image/*">
        </div>
        <div class="input-group">
            <label>Âèñ‰∏™ÂêçÂ≠ó</label>
            <input type="text" id="adopt-name" placeholder="Name...">
        </div>
        <button class="m-btn primary" onclick="confirmAdoption()">Á°ÆËÆ§È¢ÜÂÖª</button>
    </div>
</div>

<!-- ÂÆ†Áâ©ÔºöÂïÜÂ∫óÂºπÁ™ó -->
<div id="pet-shop-modal" class="modal-overlay">
    <div class="modal-header">
        <span>ÂïÜÂ∫ó (ÁßØÂàÜ: <span id="shop-coins">0</span>)</span>
        <button class="close-btn" onclick="document.getElementById('pet-shop-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div class="receipt-tabs">
            <div class="r-tab active" onclick="switchShopTab('food')">È£üÁâ©</div>
            <div class="r-tab" onclick="switchShopTab('bath')">Ê¥óÊä§</div>
            <div class="r-tab" onclick="switchShopTab('bg')">ËÉåÊôØ</div>
            <div class="r-tab" onclick="switchShopTab('decor')">Ë£ÖÈ•∞</div>
        </div>
        <div id="shop-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; padding-top:15px;"></div>
    </div>
</div>

<!-- ÂÆ†Áâ©ÔºöËÉåÂåÖÂºπÁ™ó -->
<div id="pet-bag-modal" class="modal-overlay">
    <div class="modal-header">
        <span>ËÉåÂåÖ (ÁßØÂàÜ: <span id="bag-coins">0</span>)</span>
        <button class="close-btn" onclick="document.getElementById('pet-bag-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div id="bag-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div>
    </div>
</div>

<!-- ÂÆ†Áâ©ÔºöËÆæÁΩÆ‰∏éÁä∂ÊÄÅ -->
<div id="pet-settings-modal" class="modal-overlay">
    <div class="modal-header">
        <span>ÂÆ†Áâ©Ê°£Ê°à</span>
        <button class="close-btn" onclick="document.getElementById('pet-settings-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div class="morandi-card" style="text-align:center;">
            <div id="pet-info-display" style="font-size:1.5rem; font-weight:bold;"></div>
            <div class="pet-bars" style="margin-top:15px; text-align:left;">
                <label>È•±È£üÂ∫¶: <span id="stat-hunger">0</span>%</label>
                <div class="g-bar-bg"><div id="bar-hunger" class="g-bar-fill" style="background:#ff9f43; width:0%"></div></div>
                
                <label>Ê∏ÖÊ¥ÅÂ∫¶: <span id="stat-clean">0</span>%</label>
                <div class="g-bar-bg"><div id="bar-clean" class="g-bar-fill" style="background:#54a0ff; width:0%"></div></div>
                
                <label>ÂøÉÊÉÖÂÄº: <span id="stat-mood">0</span>%</label>
                <div class="g-bar-bg"><div id="bar-mood" class="g-bar-fill" style="background:#ff6b6b; width:0%"></div></div>
            </div>
        </div>
         <div class="morandi-card">
            <h3>‰ªªÂä°‰∏éÂ•ñÂä±(‰ΩôÈ¢ù: <span id="setting-coin-display">0.00</span>)</h3>

            <button class="m-btn primary" id="btn-daily-checkin" onclick="petDailyCheckIn()" style="width:100%; margin-bottom:10px;">üìÖ ÊØèÊó•Á≠æÂà∞ (+10ÁßØÂàÜ)</button>
            <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">üí¨ ‰ªªÂä°: ‰∏éËßíËâ≤ÂØπËØù30Ê¨° (+5ÁßØÂàÜ) <span id="chat-task-progress">(0/30)</span></div>
            
            <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                <!-- üëáüëáüëá ËøôÈáåÊòØÊñ∞Â¢ûÁöÑËΩ¨ÁõòÊåâÈíÆ üëáüëáüëá -->
                <button class="m-btn primary" onclick="spinGamblingWheel()" style="width:100%; background:linear-gradient(45deg, #ff9a9e, #fad0c4); color:#d35400; border:none; box-shadow:0 4px 10px rgba(255, 107, 107, 0.3); margin-bottom:10px;">
                    üé∞ ËµåÁãóÂ§ßËΩ¨Áõò (0.25ÂàÜ/Ê¨°)
                </button>
                

                <button class="m-btn small" onclick="openCheatInput()" style="background:#eee;">üõ†Ô∏è ‰ΩúÂºäÈÄöÈÅì</button>
                <div style="font-size:0.6rem; color:#999; margin-top:5px;">ÊÉ≥Ë¶Å‰ΩúÂºäÂèØ‰ª•dd‰ΩúËÄÖ</div>
            </div>
        </div>

      <!-- ËøôÈáåÁöÑ onclick ÊîπÊàê‰∫Ü openAdoptionModal()ÔºåËøôÊ†∑ÁÇπÂáªÊó∂Êâç‰ºöÈáçÊñ∞ÁîüÊàêÂõæÁâáÂàóË°® -->
<button class="m-btn secondary" onclick="openAdoptionModal()" style="width:100%; background:#ffcccc; color:red;">ÈáçÊñ∞È¢ÜÂÖª (ÈáçÁΩÆÊï∞ÊçÆ)</button>
    </div>
</div>
<!-- üêæ ÂÆ†Áâ©Êó•ËÆ∞Áã¨Á´ã APP ÁïåÈù¢ -->
<div id="pet-diary-app-modal" class="modal-overlay" style="background:#fff8e1;">
    <div class="modal-header" style="background:#ffecb3; color:#d35400;">
        <span>ÂÆ†Áâ©Èô™‰º¥Êó•ËÆ∞</span>
        <button class="close-btn" onclick="document.getElementById('pet-diary-app-modal').style.display='none'">√ó</button>
    </div>
    <div class="modal-body">
        <div class="morandi-card" style="text-align:center; padding:20px; margin-bottom:15px; background:rgba(255,255,255,0.6);">
            <div style="font-size:3rem;">üìñ</div>
            <h3 style="color:#d35400; margin:10px 0;">ÊàëÂíåÂÆÉÁöÑÊïÖ‰∫ã</h3>
            <p style="font-size:0.8rem; color:#888;">ËøôÈáåËÆ∞ÂΩï‰∫Ü‰Ω†‰ª¨‰∫íÂä®ÁöÑÊØè‰∏Ä‰∏™Áû¨Èó¥</p>
        </div>
        
        <!-- ÊïÖ‰∫ãÂàóË°®ÂÆπÂô® -->
        <div id="pet-diary-full-list" style="padding-bottom:50px;"></div>
    </div>
</div>
<!-- üòà Èò¥ÊöóÈù¢Ôºö‰∏ªÁïåÈù¢ (ÂéÜÂè≤ËÆ∞ÂΩï) -->
<div id="shadow-app-modal" class="modal-overlay" style="background:#1e272e;">
    <div class="modal-header" style="background:#000; color:#d63031; border-bottom:1px solid #636e72;">
        <span style="font-family: 'Old English Text MT', serif; letter-spacing:1px;">Dark Side ¬∑ Èò¥ÊöóÈù¢</span>
        <button class="close-btn" onclick="document.getElementById('shadow-app-modal').style.display='none'" style="color:#d63031;">√ó</button>
    </div>
    <div class="modal-body" style="padding:20px;">
        <!-- È°∂ÈÉ®Êìç‰ΩúÂç°Áâá -->
        <div class="morandi-card" style="background:rgba(0,0,0,0.6); border:1px solid #d63031; text-align:center; padding:30px; margin-bottom:20px;">
            <div style="font-size:3rem; margin-bottom:15px; filter: drop-shadow(0 0 5px red);">‚ù§Ô∏è</div>
            <h3 style="color:#d63031; margin-bottom:10px;">Áõ¥ËßÜÊ∑±Ê∏ä</h3>
            <p style="font-size:0.8rem; color:#b2bec3;">ÊäΩÂèñÂëΩËøêÁâåÔºåÂº∫Ë°åÊè≠ÂºÄTaÂÜÖÂøÉÊúÄÈò¥Êöó„ÄÅ<br>ÊúÄÁóÖÊÄÅ„ÄÅÊúÄ‰∏çÊï¢ËÆ©‰Ω†Áü•ÈÅìÁöÑËßíËêΩ„ÄÇ</p>
            <button class="m-btn primary" onclick="startShadowDraw()" style="margin-top:20px; background:#c0392b; color:#fff; border:none; box-shadow:0 0 15px rgba(192, 57, 43, 0.4);">
                ü©∏ ÂºÄÂßãÊΩúÂÖ• (ÁîüÊàêËß£Êûê)
            </button>
        </div>

        <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® -->
        <div style="color:#636e72; font-size:0.8rem; margin-bottom:10px; border-bottom:1px solid #636e72; padding-bottom:5px;">
            ARCHIVES (Â∑≤Â≠òÊ°£ÁöÑÁΩ™ËØÅ)
        </div>
        <div id="shadow-history-list" style="padding-bottom:50px;"></div>
    </div>
</div>

<!-- üòà Èò¥ÊöóÈù¢Ôºö‰∏ìÁî®ÊäΩÁâåÊ°å (Áã¨Á´ãÂ§çÂà∂Ôºå‰∏çÂπ≤Êâ∞ÂÖ∂‰ªñ) -->
<div id="shadow-card-table-modal" class="modal-overlay" style="background: rgba(10, 10, 10, 0.98);">
    <div id="shadow-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px; background: radial-gradient(circle, #2d3436 0%, #000 100%);">
        <div id="shadow-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;"></div>
        
        <div class="card-table-ui">
            <div style="color:#fab1a0; text-shadow:0 0 5px red; font-weight:bold; font-family:serif;">
                ËØ∑ÁøªÂºÄËÉΩÂ§üÁÖß‰∫ÆÈªëÊöóÁöÑÁâå... (<span id="shadow-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishShadowAnalysis()" style="background:#d63031; border:1px solid #ff7675; color:white;">
                üíóÁ°ÆËÆ§Âπ∂ÁîüÊàêÈò¥ÊöóÊä•Âëä
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('shadow-card-table-modal').style.display='none'" style="background:#2d3436; color:#ccc;">
                ÈÄÉÁ¶ª
            </button>
        </div>
    </div>
</div>
<!-- === üï∞Ô∏è Èô™‰º¥ APP ‰∏ªÁïåÈù¢ (RPG Ê≤âÊµ∏Áâà) === -->
<div id="companion-app-modal" class="modal-overlay" style="background:#000;">
    <!-- È°∂ÈÉ®ÈÄèÊòéÂØºËà™Ê†è -->
    <div class="modal-header" style="background:linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); border-bottom:none; color:#fff; position:absolute; top:0; left:0; width:100%; z-index:50;">
        <span style="text-shadow:0 1px 3px #000;">Êó∂ÂÖâÈô™‰º¥ ¬∑ Companion</span>
        <div style="display:flex; gap:10px;">
            <!-- Âú® RPG Ê®°Âºè‰∏ãÊü•ÁúãÂÖ®ÈÉ®ËÆ∞ÂΩï -->
            <button class="m-btn small" onclick="toggleCompanionHistory()" style="background:rgba(255,255,255,0.2); color:#fff; backdrop-filter:blur(5px);">üìú ÂõûÈ°æ</button>
            <button class="close-btn" onclick="closeCompanionApp()" style="color:#fff;">√ó</button>
        </div>
    </div>

    <!-- ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†è (‰øùÊåÅ‰∏çÂèò) -->
    <div id="companion-history-panel" class="chat-settings-panel">
        <h3>üï∞Ô∏è Èô™‰º¥ÂæÄ‰∫ã</h3>
        <button class="m-btn small" onclick="toggleCompanionHistory()" style="margin-bottom:10px; background:#e8d7d7;">ÂÖ≥Èó≠</button>
        <div id="companion-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div class="modal-body" style="padding:0; overflow:hidden; display:flex; flex-direction:column; position:relative; height:100%;">
        
        <!-- ================= ËÆæÁΩÆÂå∫ (Setup View) ================= -->
        <!-- ËøôÈáåÁöÑÊ†∑ÂºèÂæÆË∞ÉÔºå‰ΩøÂÖ∂ÊµÆÂú®ËÉåÊôØ‰πã‰∏ä -->
        <div id="comp-setup-view" style="flex:1; padding:20px; padding-top:80px; overflow-y:auto; z-index:10; background:#fdfbf7;">
            <div class="morandi-card" style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:#5d4037;">ËÆæÁΩÆÂú∫ÊôØ</h3>
                    <div style="text-align:right;">
                        <input type="file" id="comp-img-upload" style="display:none;" accept="image/*" onchange="uploadCompanionImg(this)">
                        <button class="m-btn small" onclick="document.getElementById('comp-img-upload').click()">üñºÔ∏è ËÆæÁΩÆËßíËâ≤Á´ãÁªò</button>
                    </div>
                </div>
                <!-- ÂõæÁâáÈ¢ÑËßàÂå∫ -->
                <div style="margin-top:10px; height:150px; background:#eee; border-radius:8px; overflow:hidden; display:flex; justify-content:center; align-items:center;">
                    <img id="comp-preview-img" src="" style="height:100%; object-fit:contain; display:none;">
                    <span id="comp-preview-text" style="color:#999; font-size:0.8rem;">(ÊöÇÊó†ÂõæÁâáÔºåËØ∑‰∏ä‰º†ÂçäË∫´Âõæ)</span>
                </div>

                <div class="input-group" style="margin-top:10px;">
                    <label>Èô™‰º¥Êó∂Èïø (ÂàÜÈíü)</label>
                    <select id="comp-duration" style="background:#fff;">
                        <option value="5">5 ÂàÜÈíü (ÈÄüÁ≠î)</option>
                        <option value="30" selected>30 ÂàÜÈíü (ÊÇ†Èó≤)</option>
                        <option value="60">60 ÂàÜÈíü (Ê∑±Â∫¶)</option>
                        <option value="120">2 Â∞èÊó∂ (Êº´Èïø)</option>
                    </select>
                </div>
            </div>

            <div id="comp-question-list"></div>

            <button class="m-btn small" onclick="addCompQuestion()" style="width:100%; background:#e0e0e0; color:#555; margin-bottom:20px;">+ Ê∑ªÂä†‰∏Ä‰∏™ÈóÆÈ¢ò</button>
            <div style="height:80px;"></div>
            
            <!-- Â∫ïÈÉ®ÂºÄÂßãÊåâÈíÆ -->
            <div style="position:fixed; bottom:0; left:0; width:100%; padding:20px; background:linear-gradient(to top, #fdfbf7 80%, transparent); pointer-events:none;">
                <button class="m-btn primary" onclick="startCompanionSession()" id="btn-comp-start" style="width:100%; pointer-events:auto; background:#6c5ce7; box-shadow:0 4px 15px rgba(108, 92, 231, 0.4);">‚è≥ ËøõÂÖ•Ê≤âÊµ∏Èô™‰º¥Ê®°Âºè</button>
            </div>
        </div>

        <!-- ================= RPG ËøêË°åÂå∫ (Active View) ================= -->
        <div id="comp-active-view" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:5;">
            <!-- 1. ËÉåÊôØÂ±Ç (Ê®°Á≥äÂ§ÑÁêÜÔºåÂ°´ÂÖÖÂ±èÂπï) -->
            <div id="comp-rpg-bg-blur" style="position:absolute; width:100%; height:100%; background-size:cover; background-position:center; filter:blur(10px); opacity:0.5;"></div>
            
            <!-- 2. ËßíËâ≤Á´ãÁªòÂ±Ç (Â±Ö‰∏≠ÊòæÁ§∫) -->
            <img id="comp-rpg-char" src="" style="position:absolute; bottom:0; left:50%; transform:translateX(-50%); height:85%; max-width:95%; object-fit:contain; z-index:2; filter:drop-shadow(0 0 20px rgba(0,0,0,0.5)); transition: opacity 0.5s;">

            <!-- 3. È°∂ÈÉ®ÂÄíËÆ°Êó∂ -->
            <div style="position:absolute; top:80px; left:20px; z-index:10; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px; color:#fff; font-family:monospace; border:1px solid rgba(255,255,255,0.3);">
                ‚è≥ <span id="comp-timer-display">00:00</span>
            </div>

            <!-- 4. Â∫ïÈÉ® RPG ÂØπËØùÊ°Ü -->
            <div class="comp-rpg-dialog-box">
                <!-- ÂêçÂ≠ó -->
                <div class="comp-rpg-name-tag" id="comp-rpg-name">Ta</div>
                
                <!-- ÊñáÊú¨ÊªöÂä®Âå∫ -->
                <div id="comp-rpg-text-area" class="comp-rpg-text">
                    Ê≠£Âú®ÊÄùËÄÉ‰Ω†ÁöÑÈóÆÈ¢ò...
                </div>

                <!-- Âè≥‰∏ãËßíÂ∞èÊèêÁ§∫ (ÁâåÊÑè/Áä∂ÊÄÅ) -->
                <div id="comp-rpg-sub-info" class="comp-rpg-sub"></div>
                
                <!-- ÁªìÊùüÊåâÈíÆ (ÊÇ¨ÊµÆÂú®ÂØπËØùÊ°ÜÂè≥‰∏ä) -->
                <button onclick="endCompanionSession()" style="position:absolute; bottom:15px; right:15px; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:#fff; font-size:0.7rem; padding:4px 8px; border-radius:4px; cursor:pointer;">ÁªìÊùü</button>
            </div>
        </div>

    </div>
</div>
<!-- === üï∞Ô∏è Èô™‰º¥‰∏ìÁî®Áã¨Á´ãÁâåÊ°å === -->
<div id="comp-card-table-modal" class="modal-overlay" style="background: rgba(30, 30, 40, 0.95); backdrop-filter: blur(5px);">
    <div id="comp-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px;">
        <div id="comp-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;"></div>
        <div class="card-table-ui">
            <div style="color:#a29bfe; font-weight:bold;">‰∏∫Ëøô‰∏™ÈóÆÈ¢òÊäΩÁâå... (<span id="comp-flipped-count">0</span>)</div>
            <button class="m-btn primary" onclick="confirmCompCards()" style="background:#6c5ce7; color:white;">‚úÖ Á°ÆËÆ§ÈÄâÁâå</button>
            <button class="m-btn secondary" onclick="document.getElementById('comp-card-table-modal').style.display='none'">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
<!-- === RPG Ê∏∏Êàè‰∏ªÁïåÈù¢ === -->
<div id="rpg-app-modal" class="modal-overlay" style="background:#000;">
    <!-- Ê∏∏ÊàèÂå∫Âüü -->
    <div id="rpg-viewport" style="position:relative; width:100%; height:100%; overflow:hidden; display:flex; align-items:center; justify-content:center;">
        
        <!-- Âú® id="rpg-app-modal" ÂÜÖÈÉ®ÊâæÂà∞ rpg-map-container -->
<div id="rpg-map-container" style="position:relative; width:100%; height:100%; max-width:600px; max-height:900px; overflow:hidden;">
    <!-- 1. Â∫ïÂ±ÇËÉåÊôØ (ÊàøÈó¥/Â§ñÈù¢) -->
    <img id="rpg-bg-layer" src="" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:fill; z-index:0;">
    
    <!-- 2. Âú∞Êùø/Á¢∞ÊíûÂõæÂ±Ç (Áé∞Âú®ÊòØÂèØËßÅÁöÑÔºÅ) -->
    <img id="rpg-floor-layer" src="" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:fill; z-index:1; pointer-events:none;">

    <!-- 3. ÈÄªËæëÁ¢∞ÊíûÂ±Ç (ÈöêËóèÔºåÁî®‰∫é JS ËØªÂèñÂÉèÁ¥†) -->
    <canvas id="rpg-collision-canvas" style="display:none;"></canvas>

    <!-- 4. Ë£ÖÈ•∞Áâ©Â±Ç -->
    <div id="rpg-decor-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:5; pointer-events:none;"></div>

        <!-- 5. ËßíËâ≤Â±Ç -->
    <div id="rpg-char-npc" class="rpg-sprite" style="z-index:10;"></div>
    <div id="rpg-char-player" class="rpg-sprite" style="z-index:11;"></div>

    <!-- üöó Êñ∞Â¢ûÔºöÂºÄËΩ¶Âä®ÁîªÂ±Ç (ÈªòËÆ§ÈöêËóè) -->
    <div id="rpg-driving-layer" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:20; background-image:url('https://i.postimg.cc/hGtSGYL9/IMG_1841.png'); background-size:cover; background-position:center;">
        <img id="rpg-car-sprite" src="https://i.postimg.cc/wBj6BrXX/IMG_1840.png" style="position:absolute; bottom:45%; width:120px; transition: transform 0.1s;">
    </div>

    <!-- üöó Êñ∞Â¢ûÔºöÂ§ñÂá∫Âú∞ÁÇπÈÄâÊã©ÂºπÁ™ó (ÈªòËÆ§ÈöêËóè) -->
   <div id="rpg-travel-modal" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:100; text-align:center; min-width:250px; max-height:80vh; overflow-y:auto;">
    <h3 style="margin:0 0 15px 0; color:#333;">ÂáÜÂ§áÂéªÂì™ÈáåÔºü</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button class="m-btn primary" onclick="startDrivingTo('outside')" style="background:#00cec9;">üèñÔ∏è Ê≤ôÊª©</button>
        <button class="m-btn primary" onclick="startDrivingTo('store')" style="background:#ff7675;">üè™ ‰æøÂà©Â∫ó</button>
        <button class="m-btn primary" onclick="startDrivingTo('hospital')" style="background:#74b9ff;">üè• ÂåªÈô¢</button>
        <button class="m-btn primary" onclick="startDrivingTo('seaside')" style="background:#0984e3;">üåä Êµ∑Ëæπ</button>
        <button class="m-btn primary" onclick="startDrivingTo('sakura')" style="background:#fab1a0;">üå∏ Ê®±Ëä±ÂÖ¨Âõ≠</button>
        <button class="m-btn primary" onclick="startDrivingTo('church')" style="background:#a29bfe;">‚õ™ ÊïôÂ†Ç</button>
        <button class="m-btn primary" onclick="startDrivingTo('new_year')" style="background:#d63031;">üßß Êñ∞Âπ¥ÂπøÂú∫</button>
        <button class="m-btn primary" onclick="startDrivingTo('cafe')" style="background:#fdcb6e;">‚òï ÂíñÂï°ÂéÖ</button>
    </div>
    <button class="m-btn secondary" onclick="closeTravelModal()" style="width:100%; margin-top:15px;">ÂèñÊ∂à</button>
</div>
    </div>
</div> 

        <!-- UIÂ±ÇÔºöÂØπËØùÊ°Ü -->
      <div id="rpg-dialog-overlay" style="display:none; position:absolute; bottom:20px; left:10px; right:10px; background:rgba(0,0,0,0.9); border:2px solid #fff; border-radius:4px; padding:10px; z-index:100; color:#fff; font-family:'Courier New';">
    <div id="rpg-dialog-text">ËøôÈáåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ...</div>
    <input type="text" id="rpg-interact-input" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂä®‰ΩúÊàñË°•ÂÖÖËÆæÂÆö(ÂèØÈÄâ)..." style="width:100%; margin-top:8px; background:rgba(255,255,255,0.2); border:1px solid #666; color:#fff; padding:5px; border-radius:4px; outline:none;">
    <div id="rpg-dialog-actions" style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="m-btn small" id="rpg-btn-yes" style="background:#00b894; color:fff;">Á°ÆÂÆö</button>
        <button class="m-btn small" onclick="closeRpgDialog()" style="background:#636e72; color:#ccc;">ÂèñÊ∂à</button>
    </div>
</div>

        <!-- UIÂ±ÇÔºöËôöÊãüÊëáÊùÜ (ÁÆÄÂçïÁöÑÊñπÂêëÈîÆ) -->
<!-- === üïπÔ∏è ÁúüÂÆûÁöÑÁâ©ÁêÜÊãñÊãΩÊëáÊùÜ === -->
<div id="rpg-controls" style="position:absolute; bottom:40px; left:30px; z-index:90; width:120px; height:120px;">
    <!-- ÊëáÊùÜÂ∫ïÂ∫ß -->
    <div id="joy-base" style="width:100%; height:100%; background:rgba(0,0,0,0.4); border-radius:50%; border:2px solid rgba(255,255,255,0.2); position:relative; backdrop-filter:blur(4px); touch-action:none;">
        <!-- ÊëáÊùÜÊùÜÂ§¥ (ÂèØÊãñÂä®ÁöÑÈÉ®ÂàÜ) -->
        <div id="joy-stick" style="width:50px; height:50px; background:radial-gradient(circle at 30% 30%, #fff, #aaa); border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); box-shadow:0 4px 10px rgba(0,0,0,0.5); pointer-events:none;"></div>
    </div>
</div>
        <!-- È°∂ÈÉ®ÂäüËÉΩÊ†è -->
        <div style="position:absolute; top:calc(var(--safe-top) + 10px); right:10px; z-index:90; display:flex; gap:10px;">
            <button class="m-btn small" onclick="toggleRpgHistory()" style="background:rgba(255,255,255,0.2); color:#fff;">üìú ÊïÖ‰∫ãÈõÜ</button>
            <button class="m-btn small" onclick="closeRpgApp()" style="background:rgba(255,0,0,0.5); color:#fff;">ÈÄÄÂá∫</button>
        </div>
    </div>
<!-- üìñ Êñ∞Â¢ûÔºöÂÖ®Â±èÊïÖ‰∫ã‰π¶ÂºπÁ™ó (Áã¨Á´ã‰∫éÊ∏∏ÊàèÁïåÈù¢‰πãÂ§ñ) -->
<!-- üìñ ‰øÆÊîπÁâàÔºöÂçïÈ°µÁ¨îËÆ∞Êú¨ÂºπÁ™ó -->
<div id="rpg-book-modal">
    <!-- 1. Â∞ÅÈù¢ËßÜÂõæ -->
    <div id="book-cover-view" class="book-cover-state" onclick="openBookSingle()">
        <div class="book-spine-deco"></div>
        <div class="book-title-gold">Our<br>Story</div>
        <div class="book-subtitle">MEMORIES</div>
        <div style="position:absolute; bottom:20px; color:rgba(255,255,255,0.6); font-size:0.7rem;">TAP TO OPEN</div>
    </div>

    <!-- 2. ÂçïÈ°µÂÜÖÈ°µËßÜÂõæ -->
    <div id="book-single-view" class="book-single-view custom-paper-bg">
        <!-- Âà†Èô§ÊåâÈíÆ -->
        <div class="book-del-icon" onclick="deleteCurrentBookPage()">√ó</div>

        <!-- Â§¥ÈÉ®‰ø°ÊÅØ -->
        <div class="book-page-header">
            <span id="book-page-date" class="book-date">--/--/--</span>
            <span id="book-page-tag" class="book-tag">EVENT</span>
        </div>

        <!-- Ê≠£ÊñáÂÜÖÂÆπ (Â§™Èïø‰ºöÊªöÂä®) -->
        <div id="book-page-content" class="book-content-area"></div>

        <!-- Â∫ïÈÉ®ÂØºËà™ -->
        <button class="book-nav-btn btn-prev" onclick="turnBookPage(-1)">‚ùÆ</button>
        <span id="book-page-indicator" class="book-page-num">1 / 1</span>
        <button class="book-nav-btn btn-next" onclick="turnBookPage(1)">‚ùØ</button>

        <!-- ÂÖ≥Èó≠ÊåâÈíÆ (ÊÇ¨ÊµÆÂú®‰π¶Êú¨Â§ñ‰∏ãÊñπ) -->
        <div onclick="closeRpgBook()" style="position:absolute; bottom:-50px; left:50%; transform:translateX(-50%); color:white; cursor:pointer; background:rgba(0,0,0,0.5); padding:8px 20px; border-radius:20px; font-size:0.9rem; border:1px solid rgba(255,255,255,0.3);">
            Âêà‰∏äÁ¨îËÆ∞
        </div>
    </div>
</div>
<div id="rpg-chat-modal" class="modal-overlay" style="display:none; background:#000;">
    <!-- 1. ËÉåÊôØÂÆπÂô® (Ëß£ÂÜ≥ÁôΩÂ±èÈóÆÈ¢ò) -->
    <div id="rpg-chat-bg-container" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0.6; filter: blur(2px);"></div>

    <!-- 2. È°∂ÈÉ®Ê†áÈ¢ò -->
    <div class="modal-header" style="background:rgba(0,0,0,0.6); color:#fff; position:relative; z-index:20;">
        <span>‰∏é Ta ÂØπËØù</span>
        <button class="close-btn" onclick="closeRpgChat()" style="color:#fff;">√ó</button>
    </div>
    
    <!-- 3. Á´ãÁªòÂå∫Âüü (‰∏≠Èó¥) -->
    <div style="flex:1; position:relative; display:flex; justify-content:center; align-items:center; z-index:20; overflow:hidden;">
        <!-- ÂØπÊñπÁ´ãÁªò (‰ªñËØ¥ËØùÊó∂ÊòæÁ§∫) -->
        <img id="rpg-chat-npc-img" src="" style="height:70%; max-height:400px; object-fit:contain; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); display:none; transition: opacity 0.3s;">
        <!-- ÊàëÁöÑÁ´ãÁªò (ÊàëËæìÂÖ•Êó∂ÊòæÁ§∫) -->
        <img id="rpg-chat-user-img" src="" style="height:70%; max-height:400px; object-fit:contain; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); transition: opacity 0.3s;">
    </div>

    <!-- 4. Â∫ïÈÉ®ÂØπËØùÊéßÂà∂Âå∫ -->
    <div style="padding:20px; background:rgba(0,0,0,0.85); z-index:20; min-height:160px; border-top:2px solid #555; position:relative;">
        
        <!-- ÊâæÂà∞ rpg-chat-modal ÈáåÁöÑÂ∫ïÈÉ®ËæìÂÖ•Âå∫Âüü (Â§ßÁ∫¶Âú® 2750Ë°åÈôÑËøë)ÔºåÂÆåÂÖ®ÊõøÊç¢‰∏∫Ôºö -->
<div style="flex:1; display:flex; flex-direction:column; background:rgba(0,0,0,0.8); padding:15px; border-top:1px solid rgba(255,255,255,0.2);">
    
    <!-- 1. ËæìÂÖ•Ê®°Âºè (Âπ≥Êó∂ÊòæÁ§∫Ëøô‰∏™) -->
    <div id="rpg-input-mode" style="display:block; width:100%; height:100%; display:flex; flex-direction:column;">
        <textarea id="rpg-chat-input" placeholder="ËæìÂÖ•ÂØπËØù... (ÁÇπÂáªÂè≥‰æßÊåâÈíÆÊäΩÁâå)" style="flex:1; background:transparent; border:none; color:#fff; resize:none; font-size:1rem; outline:none;"></textarea>
        
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <!-- ÂäüËÉΩÊåâÈíÆ -->
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:1.2rem;">üì∑</button>
                <button onclick="alert('ËØ≠Èü≥ÂäüËÉΩÂºÄÂèë‰∏≠')" style="background:none; border:none; font-size:1.2rem;">üé§</button>
            </div>
            <!-- ÊäΩÁâåÊåâÈíÆ -->
            <button onclick="openRpgCardTable()" style="background:linear-gradient(45deg, #9c27b0, #673ab7); border:none; color:#fff; padding:5px 15px; border-radius:20px; cursor:pointer;">üîÆ ÂëΩËøêÊäΩÁâå</button>
        </div>
    </div>

    <!-- 2. ÊòæÁ§∫/ÊâìÂ≠óÊú∫Ê®°Âºè (ÂàöÂõûÂ§çÊó∂ÊòæÁ§∫Ëøô‰∏™ÔºåÂπ≥Êó∂ÈöêËóè) -->
    <!-- üî• ÂøÖÈ°ªÊúâËøô‰∏™ id="rpg-display-mode"ÔºåÂê¶ÂàôÁÇπÂáªÊäΩÁâåÂêéÊó†Ê≥ïÂàáÊç¢ÁïåÈù¢ -->
    <div id="rpg-display-mode" style="display:none; width:100%; height:100%; overflow-y:auto; cursor:pointer;" onclick="resetRpgChatInput()">
        <div id="rpg-typewriter-text" style="font-family:'Songti SC', serif; color:#fff; font-size:1.1rem; line-height:1.6; white-space: pre-wrap;">
            <!-- JS ‰ºöÊääÁîüÊàêÁöÑÂõûÂ§çÂ°´Âú®ËøôÈáå -->
        </div>
        <div style="text-align:center; font-size:0.8rem; color:rgba(255,255,255,0.5); margin-top:10px;">
            ( ÁÇπÂáª‰ªªÊÑèÂ§ÑÁªßÁª≠ÂõûÂ§ç )
        </div>
    </div>

</div>
    
    <!-- 5. ÂéÜÂè≤ËÆ∞ÂΩïÊÇ¨ÊµÆÁ™ó -->
    <div id="rpg-chat-history-box" style="position:absolute; top:60px; right:10px; width:200px; max-height:200px; overflow-y:auto; background:rgba(255,255,255,0.9); border-radius:8px; padding:10px; display:none; z-index:30;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="font-weight:bold; font-size:0.8rem;">ÂØπËØùËÆ∞ÂΩï</span>
            <span onclick="toggleRpgChatHistory()" style="cursor:pointer;">√ó</span>
        </div>
        <div id="rpg-chat-list"></div>
    </div>
    <button onclick="toggleRpgChatHistory()" style="position:absolute; top:60px; right:10px; background:rgba(255,255,255,0.5); border:none; border-radius:50%; width:30px; height:30px; z-index:30;">üìù</button>
</div>

<!-- === RPG ‰∏ìÁî®ÁâåÊ°å (Â§çÁî®ÈÄªËæëÔºåÁã¨Á´ãID) === --><div id="rpg-card-table-modal" class="modal-overlay" style="background: rgba(10, 10, 20, 0.95); backdrop-filter: blur(5px); z-index: 3100;">
   <div id="rpg-card-table-desk" style="width:100%;height:100%;position:relative;overflow-y:auto;">
        <div id="rpg-card-area" style="width:100%;height:100%;perspective:1000px;"></div>
        <div class="card-table-ui">
            <div style="color:#fdcb6e;">ÂëΩËøêÂà§ÂÆö‰∏≠... (<span id="rpg-flipped-count">0</span>)</div>
           <!-- ÂøÖÈ°ªÈïøËøôÊ†∑ -->
<button class="m-btn primary" onclick="finishRpgChat()" style="background:#e17055; border:1px solid #fab1a0; color:white;">üó£Ô∏è Á°ÆËÆ§Âπ∂Ëß£ËØª</button>
            <button class="m-btn secondary" onclick="document.getElementById('rpg-card-table-modal').style.display='none'">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<!-- ================= üî¥ Â≠¶‰π†ÊÄªÁªì APP ‰øÆÂ§çÊï¥ÂêàÂåÖ START üî¥ ================= -->

<!-- 1. ÁïåÈù¢ÈÉ®ÂàÜ (HTML) -->
<div id="summary-app-modal" class="modal-overlay" style="background:#f1f2f6; z-index:9999; display:none;">
    <div class="modal-header" style="background:#fff; color:#2c3e50; border-bottom:1px solid #dfe6e9; padding-top: max(20px, env(safe-area-inset-top)); height:auto; min-height:80px; display:flex; align-items:flex-end;">
        <span style="font-weight:bold; font-size:1.1rem; margin-left:15px; margin-bottom:10px;">üìù Â≠¶‰π†ÊÄªÁªì</span>
        <button class="close-btn" onclick="document.getElementById('summary-app-modal').style.display='none'" style="margin-bottom:5px; font-size:2rem; color:#333;">√ó</button>
    </div>

    <div class="modal-body" style="padding:15px; padding-bottom:100px; overflow-y:auto;">
        <!-- È°∂ÈÉ®ÂàáÊç¢ÊåâÈíÆ -->
        <div style="display:flex; background:#fff; padding:10px; margin-bottom:15px; border-radius:12px; gap:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <button class="m-btn small" onclick="switchSummaryView('create')" id="btn-sum-create" style="flex:1; background:#607d8b; color:white; padding:10px;">‚ú® Êñ∞Âª∫</button>
            <button class="m-btn small" onclick="switchSummaryView('history')" id="btn-sum-history" style="flex:1; background:#eceff1; color:#333; padding:10px;">üìÇ ÂéÜÂè≤</button>
        </div>

        <!-- A. Êñ∞Âª∫È°µÈù¢ -->
        <div id="summary-create-view">
            <div class="morandi-card" style="padding:20px;">
                <div class="input-group">
                    <label style="font-weight:bold; color:#546e7a;">üìö ÁßëÁõÆ / È¢ÜÂüü</label>
                    <input type="text" id="sum-subject" placeholder="‰æãÂ¶ÇÔºöÈ´òÁ≠âÊï∞Â≠¶„ÄÅPythonÁºñÁ®ã..." style="background:#f9f9f9;">
                </div>
                <div class="input-group" style="margin-top:15px;">
                    <label style="font-weight:bold; color:#546e7a;">‚úçÔ∏è Â≠¶‰π†Á¨îËÆ∞ / Âõ∞ÊÉëÁÇπ</label>
                    <textarea id="sum-notes" class="editor-textarea" style="height:120px; background:#f9f9f9; padding:10px;" placeholder="Âú®Ê≠§Á≤òË¥¥‰Ω†ÁöÑÁ¨îËÆ∞ÔºåÊàñÂÜô‰∏ã‰Ω†Â≠¶Âà∞ÁöÑÂÜÖÂÆπ..."></textarea>
                </div>
                <div class="input-group" style="margin-top:15px;">
                    <label style="display:flex; align-items:center; color:#78909c; font-size:0.85rem;">
                        <input type="checkbox" id="sum-use-wb" checked style="width:auto; margin-right:5px; transform:scale(1.2);"> 
                        <span>ÂºïÁî®‰∏ñÁïå‰π¶‰∫∫ËÆæ (ËÆ©ËßíËâ≤Êù•ËæÖÂØº‰Ω†)</span>
                    </label>
                </div>
                <button class="m-btn primary" onclick="generateSummary()" id="btn-sum-gen" style="background:#607d8b; width:100%; margin-top:20px; height:50px; font-size:1rem; box-shadow:0 4px 10px rgba(96, 125, 139, 0.3);">üß† ÂºÄÂßãÂàÜÊûêÊÄªÁªì</button>
            </div>
            
            <!-- ÁªìÊûúÂ±ïÁ§∫Âå∫ -->
            <div id="summary-result-area" style="display:none; margin-top:20px; animation: fadeIn 0.5s;">
                <div class="morandi-card" style="border-left: 5px solid #f39c12; padding:15px; margin-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:#d35400;">‚ùì ÂèëÁé∞ÁöÑÈóÆÈ¢ò & Áõ≤ÁÇπ</h4>
                    <div id="res-questions" style="font-size:0.95rem; line-height:1.6; color:#333;"></div>
                </div>
                <div class="morandi-card" style="border-left: 5px solid #3498db; padding:15px; margin-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:#2980b9;">üåç Áü•ËØÜÁÇπÊâ©Â±ï</h4>
                    <div id="res-expansion" style="font-size:0.95rem; line-height:1.6; color:#333;"></div>
                </div>
                <div class="morandi-card" style="border-left: 5px solid #27ae60; padding:15px; margin-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:#27ae60;">üìÖ ‰∏ã‰∏ÄÊ≠•ËÆ°Âàí & Êé®Ëçê</h4>
                    <div id="res-plan" style="font-size:0.95rem; line-height:1.6; color:#333;"></div>
                </div>
                <button class="m-btn small" onclick="saveSummaryResult()" style="width:100%; margin-top:15px; background:#bdc3c7; color:#333; height:45px;">üíæ Á°ÆËÆ§‰øùÂ≠òÂà∞ÂéÜÂè≤</button>
            </div>
        </div>

        <!-- B. ÂéÜÂè≤È°µÈù¢ -->
        <div id="summary-history-view" style="display:none;">
            <div id="summary-history-list" style="padding-bottom:50px;"></div>
        </div>
    </div>
</div>


<!-- 2. ÈÄªËæëËÑöÊú¨ (JS) -->
<script>
(function() {
    // Á´ãÂç≥ÊâßË°åÂáΩÊï∞ÔºåÈò≤Ê≠¢ÂèòÈáèÊ±°Êüì
    console.log("Ê≠£Âú®ÂàùÂßãÂåñÂ≠¶‰π†ÊÄªÁªì APP...");

    // 1. Âº∫Âà∂ÂàùÂßãÂåñÊï∞ÊçÆÁªìÊûÑ (Èò≤Ê≠¢ undefined)
    if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
    if (!window.BIG_MEMORY.summary_data) window.BIG_MEMORY.summary_data = [];

    // 2. ÊåÇËΩΩÂÖ®Â±ÄÂáΩÊï∞ (Á°Æ‰øù onclick ËÉΩÊâæÂà∞)
    window.getSummaryData = function() { return window.BIG_MEMORY.summary_data || []; };
    
    window.saveSummaryData = function(list) {
        window.BIG_MEMORY.summary_data = list;
        if (typeof idb !== 'undefined' && idb.put) {
            idb.put('universal_store', { id: 'summary_data', data: list });
        }
    };

    window.openSummaryApp = function() {
        const modal = document.getElementById('summary-app-modal');
        if(modal) {
            modal.style.display = 'flex';
            switchSummaryView('create');
        } else {
            alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞ÁïåÈù¢ÂÖÉÁ¥†ÔºÅËØ∑Ê£ÄÊü•‰ª£Á†ÅÁ≤òË¥¥‰ΩçÁΩÆ„ÄÇ");
        }
    };

    window.switchSummaryView = function(mode) {
        const createEl = document.getElementById('summary-create-view');
        const histEl = document.getElementById('summary-history-view');
        const btnCreate = document.getElementById('btn-sum-create');
        const btnHist = document.getElementById('btn-sum-history');

        if (mode === 'create') {
            createEl.style.display = 'block';
            histEl.style.display = 'none';
            btnCreate.style.background = '#607d8b'; btnCreate.style.color = '#fff';
            btnHist.style.background = '#eceff1'; btnHist.style.color = '#333';
        } else {
            createEl.style.display = 'none';
            histEl.style.display = 'block';
            btnCreate.style.background = '#eceff1'; btnCreate.style.color = '#333';
            btnHist.style.background = '#607d8b'; btnHist.style.color = '#fff';
            renderSummaryHistory();
        }
    };

    let pendingSummary = null;

    window.generateSummary = async function() {
        const subject = document.getElementById('sum-subject').value;
        const notes = document.getElementById('sum-notes').value;
        if (!subject || !notes) return alert("ËØ∑Â°´ÂÜôÂÜÖÂÆπÔºÅ");

        const btn = document.getElementById('btn-sum-gen');
        const oldText = btn.innerText;
        btn.disabled = true; btn.innerText = "üß† Ê≠£Âú®ËøûÊé•Â§ßËÑë...";

        // Âº∫ÂäõËé∑Âèñ API Key
        let apiKey = "";
        try { apiKey = document.getElementById('api-key').value; } catch(e){}
        if(!apiKey) {
            try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; } catch(e){}
        }
        if(!apiKey) { 
            alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API KeyÔºÅ");
            btn.disabled = false; btn.innerText = oldText;
            return;
        }

        let apiUrl = document.getElementById('api-url')?.value || "https://api.openai.com/v1";
        if(apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0,-1);
        let model = document.getElementById('model-select')?.value || "gpt-3.5-turbo";

        // Ëé∑Âèñ‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñá
        const wb = window.BIG_MEMORY.world_book || {};
        const globalCtx = document.getElementById('sum-use-wb').checked 
            ? (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n") 
            : "";

        const prompt = `
‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂ≠¶‰π†ÂØºÂ∏àÔºåÂêåÊó∂‰Ω†ÈúÄË¶Å**‰∏•Ê†ºÊâÆÊºî‰∏ñÁïå‰π¶‰∏≠ÁöÑËßíËâ≤**„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}

„ÄêÁî®Êà∑ËæìÂÖ•„Äë
ÁßëÁõÆÔºö${subject}
Á¨îËÆ∞ÂÜÖÂÆπÔºö${notes}

„Äê‰ªªÂä°„Äë
ËØ∑‰ª•ËßíËâ≤ÁöÑÂè£ÂêªÔºåÂØπÁî®Êà∑ÁöÑÁ¨îËÆ∞ËøõË°åÊ∑±Â∫¶ÂàÜÊûêÊÄªÁªì„ÄÇ
**ÂøÖÈ°ª‰∏•Ê†ºËæìÂá∫ JSON Ê†ºÂºè**Ôºå‰∏çË¶Å Markdown ‰ª£Á†ÅÂùó„ÄÇ

„ÄêJSON ÁªìÊûÑ„Äë
{
  "questions": "ÊåáÂá∫Á¨îËÆ∞‰∏≠ÈÄªËæë‰∏çÈÄö„ÄÅÈÅóÊºèÁöÑÂÖ≥ÈîÆÁÇπÔºåÊàñËÄÖÈíàÂØπÁ¨îËÆ∞ÂÜÖÂÆπÊèêÂá∫ 2-3 ‰∏™ÂêØÂèëÊÄßÈóÆÈ¢ò„ÄÇ",
  "expansion": "Ê†πÊçÆÁ¨îËÆ∞ÂÜÖÂÆπÔºåÊâ©Â±ïÂª∂‰º∏Áõ∏ÂÖ≥ÁöÑÁü•ËØÜÁÇπ„ÄÅËÉåÊôØÊàñÈ´òÁ∫ßÁî®Ê≥ïÔºàËßíËâ≤ËßÜËßíÁöÑËßÅËß£Ôºâ„ÄÇ",
  "plan": "Êé®Ëçê‰∏ã‰∏ÄÊ≠•ÁöÑÂ≠¶‰π†ÁõÆÊ†á„ÄÅÂÖ∑‰ΩìÁöÑÊïôÊùêÂêçÁß∞„ÄÅÊïôÁ®ãÈìæÊé•ÂÖ≥ÈîÆËØçÔºàÂøÖÈ°ªÁúüÂÆûÂ≠òÂú®Ôºâ„ÄÇ"
}
`;

        try {
            const res = await fetch(`${apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{role:"system", content:"You are a helpful tutor. Output JSON only."}, {role:"user", content:prompt}],
                    temperature: 0.7
                })
            });

            const json = await res.json();
            if(json.error) throw new Error(json.error.message);
            
            let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
            // ÁÆÄÂçïÂÆπÈîô
            const first = raw.indexOf('{'); const last = raw.lastIndexOf('}');
            if(first !== -1 && last !== -1) raw = raw.substring(first, last+1);
            
            const result = JSON.parse(raw);

            document.getElementById('res-questions').innerText = result.questions;
            document.getElementById('res-expansion').innerText = result.expansion;
            document.getElementById('res-plan').innerText = result.plan;
            document.getElementById('summary-result-area').style.display = 'block';
            
            pendingSummary = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                subject: subject,
                notes: notes,
                result: result
            };

        } catch(e) {
            console.error(e);
            alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    };

    window.saveSummaryResult = function() {
        if (!pendingSummary) return;
        const list = getSummaryData();
        list.unshift(pendingSummary);
        saveSummaryData(list);
        alert("‚úÖ Â∑≤‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩïÔºÅ");
        document.getElementById('summary-result-area').style.display = 'none';
        document.getElementById('sum-notes').value = '';
        switchSummaryView('history');
    };

    window.renderSummaryHistory = function() {
        const list = getSummaryData();
        const container = document.getElementById('summary-history-list');
        container.innerHTML = '';
        
        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; padding:30px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
            return;
        }

        list.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'morandi-card';
            div.style.marginBottom = '15px'; 
            div.style.padding = '15px';
            div.style.background = '#fff';
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:10px;">
                    <span style="font-weight:bold; color:#607d8b; font-size:1rem;">üìò ${item.subject}</span>
                    <span style="font-size:0.8rem; color:#999;">${item.date}</span>
                </div>
                
                <div style="font-size:0.85rem; background:#f5f5f5; padding:8px; border-radius:6px; margin-bottom:12px; color:#555;">
                    üìù <strong>Á¨îËÆ∞:</strong> ${item.notes.substring(0, 50)}...
                </div>

                <div style="font-size:0.9rem; line-height:1.6; color:#333;">
                    <div style="margin-bottom:8px;"><strong style="color:#d35400;">‚ùì ÈóÆÈ¢ò:</strong> ${item.result.questions}</div>
                    <div style="margin-bottom:8px;"><strong style="color:#2980b9;">üåç Êâ©Â±ï:</strong> ${item.result.expansion}</div>
                    <div><strong style="color:#27ae60;">üìÖ ËÆ°Âàí:</strong> ${item.result.plan}</div>
                </div>

                <div style="text-align:right; margin-top:10px;">
                    <button class="m-btn small" onclick="deleteSummaryItem(${index})" style="background:#ffcdd2; color:#c0392b; font-size:0.8rem; padding:5px 12px;">üóëÔ∏è Âà†Èô§</button>
                </div>
            `;
            container.appendChild(div);
        });
    };

    window.deleteSummaryItem = function(index) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) return;
        const list = getSummaryData();
        list.splice(index, 1);
        saveSummaryData(list);
        renderSummaryHistory();
    };

    // 3. „ÄêÂÖ≥ÈîÆË°•‰∏Å„ÄëÂä´ÊåÅÂä†ËΩΩÂáΩÊï∞ÔºåÁ°Æ‰øùÊï∞ÊçÆË¢´ËØªÂèñ
    const originalLoad = window.loadAllBigData;
    window.loadAllBigData = async function() {
        if(originalLoad) await originalLoad();
        
        // Â∞ùËØïÂçïÁã¨ËØªÂèñ
        try {
            if(typeof idb !== 'undefined') {
                const res = await idb.get('universal_store', 'summary_data');
                if(res) window.BIG_MEMORY.summary_data = res.data;
            }
        } catch(e) {}
        console.log("Â≠¶‰π†ÊÄªÁªìÊï∞ÊçÆË°•‰∏ÅÂ∑≤Âä†ËΩΩ");
    };

    // 4. „ÄêÂÖ≥ÈîÆË°•‰∏Å„ÄëÊ≥®ÂÜåÁæéÂåñÊò†Â∞Ñ (Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øù APP_MAP Â≠òÂú®)
    setTimeout(() => {
        if(typeof APP_MAP !== 'undefined') {
            const exists = APP_MAP.find(a => a.id === 'summary');
            if(!exists) {
                APP_MAP.push({ 
                    id: 'summary', 
                    name: 'Â≠¶‰π†ÊÄªÁªì', 
                    selector: 'div[onclick="openSummaryApp()"]' 
                });
            }
        }
    }, 2000);

})();
</script>
<!-- ================= üî¥ Â≠¶‰π†ÊÄªÁªì APP ‰øÆÂ§çÊï¥ÂêàÂåÖ END üî¥ ================= -->
<script>
const RPG_ASSETS = {
    // === ËÉåÊôØÂõæÈÖçÁΩÆ (Êñ∞Â¢û‰∫ÜÊñ∞Âú∫ÊôØËÉåÊôØ) ===
    bg_room: "https://i.postimg.cc/4xNTKjLp/IMG_0470.png",
    bg_outside: "https://i.postimg.cc/bwCf1L4q/IMG_0496.png",
    bg_store: "https://i.postimg.cc/BnPmP1hr/IMG_1348.png",
    bg_hospital: "https://i.postimg.cc/GpVZ1gqG/IMG_1848.jpg",
    bg_hospital_room: "https://i.postimg.cc/cJ2VNkX8/IMG_1849.jpg",
    bg_seaside: "https://i.postimg.cc/BvkdG7MB/IMG_1843.png",
    bg_seaside_hut: "https://i.postimg.cc/25MPf92v/IMG_1846.jpg",
    bg_sakura: "https://i.postimg.cc/fbp6hqBY/IMG_1847.jpg",
    bg_church: "https://i.postimg.cc/xdhWSpty/IMG_1844.png",
    bg_new_year: "https://i.postimg.cc/YSZJwDb3/IMG_1842.png",
    bg_cafe: "https://i.postimg.cc/fbp6hqBx/IMG_1845.jpg",

    collision_map: "https://i.postimg.cc/SKH0vRS0/IMG_0488.png",

    char_gifs: {
        idle: "https://i.postimg.cc/N0ZhzFgm/IMG_0486.gif",
        right: "https://i.postimg.cc/LsGdb5Ht/IMG_0482.gif",
        front: "https://i.postimg.cc/LsGdb5HB/IMG_0487.gif",
        back: "https://i.postimg.cc/bv4XBrz9/IMG_0483.gif"
    },

    // === ‚òï ÂíñÂï°ÂéÖÂïÜÂìÅÂàóË°® (Áî®‰∫éÂïÜÂ∫óÂºπÁ™ó) ===
    cafe_items: [
        {name: "Â•∂Ëå∂", img: "https://i.postimg.cc/P564gL2X/IMG_1831.png"},
        {name: "ÊûúÊ±Å", img: "https://i.postimg.cc/htCrkJpP/IMG_1832.png"},
        {name: "ÊÖïÊñØÂ∞èËõãÁ≥ï", img: "https://i.postimg.cc/Bnhgr8M3/IMG_1830.png"},
        {name: "ÊäπËå∂ËõãÁ≥ï", img: "https://i.postimg.cc/CxvN3ZmH/IMG_1820.png"},
        {name: "ËçâËéìËõãÁ≥ï", img: "https://i.postimg.cc/FHPZMfDc/IMG_1822.png"},
        {name: "Â∑ßÂÖãÂäõËõãÁ≥ï", img: "https://i.postimg.cc/XY28RZQB/IMG_1823.png"},
        {name: "ËìùËéìËõãÁ≥ï", img: "https://i.postimg.cc/T3k9zyCb/IMG_1824.png"},
        {name: "ËäíÊûúËõãÁ≥ï", img: "https://i.postimg.cc/9Qxp64JR/IMG_1825.png"},
        {name: "Â©öÁ§º‰∏âÂ±ÇËõãÁ≥ï", img: "https://i.postimg.cc/JzTqfyP0/IMG_1828.png"},
        {name: "ÁîüÊó•ÂàáÂùóËõãÁ≥ï", img: "https://i.postimg.cc/6pH0k7Y7/IMG_1827.png"},
        {name: "Â∞èÊõ≤Â•á", img: "https://i.postimg.cc/HkS2qJBj/IMG_1829.png"}
    ],

    items: [
        // === üè† ÊàøÈó¥ (Room) - ÂéüÊúâÂÜÖÂÆπÂÆåÂÖ®‰øùÁïô ===
        { id: 'bed', scene: 'room', name: 'Â∫ä', src: 'https://i.postimg.cc/d0wYxxN7/IMG_1834.png', x: 1, y: 53, w: 28, h: 20, prompt: 'Ë¶ÅË∫∫‰∏ã‰ºëÊÅØÂêóÔºü' },
        { id: 'tv', scene: 'room', name: 'ÁîµËßÜ', src: 'https://i.postimg.cc/N0BczzCX/IMG_1838.png', x: 18, y: 10, w: 30, h: 20, prompt: 'Ë¶ÅÁúã‰ºöÂÑøÁîµËßÜÂêóÔºü' },
        { id: 'kitchen', scene: 'room', name: 'Âé®Êàø', src: 'https://i.postimg.cc/Bv40VV7D/IMG_1837.png', x: 60, y: 4, w: 40, h: 30, prompt: 'Ë¶ÅÂÅöÁÇπÂêÉÁöÑÂêóÔºü' },
        { id: 'catbed', scene: 'room', name: 'Áå´Á™ù', src: 'https://i.postimg.cc/5tbVRRKY/IMG_1835.png', x: 70, y: 50, w: 25, h: 25, prompt: 'Ë¶ÅÂíåÂÆ†Áâ©‰∫íÂä®ÂêóÔºü' },
        { id: 'tub', scene: 'room', name: 'Êµ¥Áº∏', src: 'https://i.postimg.cc/tgpjMMvn/IMG_1836.png', x: 65, y: 70, w: 30, h: 20, prompt: 'Ë¶ÅÊ≥°‰∏™Êæ°ÂêóÔºü' },
        { id: 'carpet', scene: 'room', name: 'Âú∞ÊØØ', src: 'https://i.postimg.cc/jjtbFF3C/IMG_1839.png', x: 40, y: 85, w: 20, h: 10, prompt: 'ÂáÜÂ§áÂá∫Èó®ÂêóÔºü', action: 'show_travel_options' },

        // === üèñÔ∏è Ê≤ôÊª© (Outside) - ÂéüÊúâÂÜÖÂÆπÂÆåÂÖ®‰øùÁïô ===
        { id: 'door', scene: 'outside', name: 'Èó®', src: 'https://i.postimg.cc/BnYf2NkR/IMG_0501.png', x: 40, y: 0, w: 20, h: 10, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },
        // Ë£ÖÈ•∞
        { id: 'l1', scene: 'outside', src: 'https://i.postimg.cc/02Csy9fN/IMG_0503.png', x: 5, y: 10, w: 15 },
        { id: 'l2', scene: 'outside', src: 'https://i.postimg.cc/TYc63T9K/IMG_0504.png', x: 20, y: 10, w: 19 },
        { id: 'l3', scene: 'outside', src: 'https://i.postimg.cc/6Q8JcnNw/IMG_0505.png', x: 80, y: 15, w: 13 },
        { id: 'l4', scene: 'outside', src: 'https://i.postimg.cc/65hXpB02/IMG_0506.png', x: 60, y: 10, w: 19, collision: false },
        { id: 'l5', scene: 'outside', src: 'https://i.postimg.cc/SKnFdCps/IMG_0507.png', x: 80, y: 38, w: 8, collision: false },
        { id: 'l6', scene: 'outside', src: 'https://i.postimg.cc/9fD5bZjy/IMG_0518.png', x: 10, y: 36, w: 10, collision: false },
        // ÊúãÂèã
        { id: 'n1', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫A', src: 'https://i.postimg.cc/cL9GfT2m/IMG_0509.png', x: 28, y: 17, w: 15, h: 20, prompt: '‚ÄúÁ•ù‰Ω†‰ª¨Ê∞∏ËøúÂπ∏Á¶è„ÄÇ‚Äù' },
        { id: 'n2', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫B', src: 'https://i.postimg.cc/fbVnCmhk/IMG_0510.png', x: 20, y: 40, w: 22, h: 20, prompt: '‚Äú‰ªäÂ§©ÁöÑÊµ∑È£éÁúüËàíÊúçÂïä„ÄÇ‚Äù' },
        { id: 'n3', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫C', src: 'https://i.postimg.cc/4xLRpwjN/IMG_0511.png', x: 7, y: 33, w: 20, h: 20, prompt: '‚Äú‰Ω†‰ª¨ÁúãËµ∑Êù•ÁúüËà¨ÈÖçÔºÅ‚Äù' },
        { id: 'n4', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫D', src: 'https://i.postimg.cc/SxTbcVHK/IMG_0512.png', x: 65, y: 19, w: 20, h: 20, prompt: '‚ÄúË¶Å‰∏çË¶Å‰∏ÄËµ∑ÂéªÂÜ≤Êµ™Ôºü‚Äù' },
        { id: 'n5', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫E', src: 'https://i.postimg.cc/vHvsZGz6/IMG_0513.png', x: 70, y: 33, w: 18, h: 20, prompt: '‚Äú‰∏äÊ¨°ÁöÑËÅö‰ºöÂæàÂºÄÂøÉÔºÅ‚Äù' },
        { id: 'n6', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫F', src: 'https://i.postimg.cc/bvZcgkjq/IMG_0514.png', x: 25, y: 29, w: 15, h: 20, prompt: '‚ÄúË¶Å‰∏ÄÁõ¥ÂºÄÂøÉ‰∏ãÂéªÂì¶ÔºÅ‚Äù' },
        { id: 'n7', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫G', src: 'https://i.postimg.cc/JhsVxZWy/IMG_0515.png', x: 52, y: 40, w: 23, h: 20, prompt: '‚Äú‰Ω†‰ª¨ÁöÑÊÑüÊÉÖÁúüËÆ©‰∫∫Áæ°ÊÖï„ÄÇ‚Äù' },
        { id: 'n9', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫H', src: 'https://i.postimg.cc/1z8hBwZN/IMG_0516.png', x: 55, y: 28, w: 19, h: 20, prompt: '‚ÄúÂÅ∑ÂÅ∑ÂëäËØâÊàëÔºåË∞ÅÂÖàË°®ÁôΩÁöÑÔºü‚Äù' },
        { id: 'n10', scene: 'outside', type: 'person', name: 'Ë∑Ø‰∫∫I', src: 'https://i.postimg.cc/8C7Q4MVJ/IMG_0517.png', x: 13, y: 22, w: 20, h: 20, prompt: '‚ÄúÂ•Ω‰πÖ‰∏çËßÅÔºÅ‰Ω†‰ª¨ËøòÊòØËøô‰πàÂ•Ω„ÄÇ‚Äù' },

        // === üè™ ‰æøÂà©Â∫ó (Store) - ÂéüÊúâÂÜÖÂÆπÂÆåÂÖ®‰øùÁïô ===
        { id: 'store_exit', scene: 'store', name: 'Âá∫Âè£', src: '', x: 50, y: 80, w: 20, h: 30, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },
        { id: 'shelf1', scene: 'store', type: 'shelf', name: 'ÂÆ†Áâ©Áî®ÂìÅ', src: 'https://i.postimg.cc/CLQvK444/IMG_1349.png', x: 10, y: 40, w: 21, h: 18, prompt: 'Ë¶ÅÁªôÂÆ†Áâ©‰π∞ÁÇπ‰ªÄ‰πàÂêóÔºü' },
        { id: 'shelf2', scene: 'store', type: 'shelf', name: 'ÂÜ∑È•ÆÊüú', src: 'https://i.postimg.cc/BQVhvCCK/IMG_1350.png', x: 30, y: 40, w: 18, h: 20, prompt: 'Ë¶Å‰π∞ÁÇπÂÜ∞ÈïáÈ•ÆÊñôÂêóÔºü' },
        { id: 'shelf3', scene: 'store', type: 'shelf', name: 'ÁÜüÈ£üÂå∫', src: 'https://i.postimg.cc/L6bysVTK/IMG_1351.png', x: 50, y: 43, w: 45, h: 40, prompt: 'Ë¶Å‰π∞ÁÇπÁÉ≠‰πéÁöÑ‰æøÂΩìÂêóÔºü' },
        { id: 'shelf4', scene: 'store', type: 'shelf', name: 'Èõ∂È£üÂå∫', src: 'https://i.postimg.cc/ZKMfqLLc/IMG_1352.png', x: 38, y: 21, w: 50, h: 25, prompt: 'Ë¶ÅÂõ§ÁÇπÈõ∂È£üÂêóÔºü' },

        // ========================== ‰ª•‰∏ã‰∏∫Êú¨Ê¨°Êñ∞Â¢û ==========================

        // --- üè• Êñ∞Â¢ûÔºöÂåªÈô¢ (Hospital) ---
        { id: 'h_mri', scene: 'hospital', name: 'Ê†∏Á£ÅÂÖ±ÊåØ', src: '', x: 5, y: 10, w: 30, h: 20, prompt: 'ÈúÄË¶ÅÂÅö‰∏Ä‰∏ãÊ†∏Á£ÅÂÖ±ÊåØÂêó', action: 'pixel_story' },
        { id: 'h_stay', scene: 'hospital', name: '‰ΩèÈô¢ÈÉ®', src: '', x: 65, y: 10, w: 30, h: 20, prompt: 'ÁîüÁóÖÂæà‰∏•ÈáçÈúÄË¶Å‰ΩèÈô¢Ôºå‰ΩèÈô¢ÁîüÊ¥ª', action: 'pixel_story' },
        { id: 'h_iv', scene: 'hospital', name: 'ËæìÊ∂≤Âå∫', src: '', x: 70, y: 70, w: 25, h: 20, prompt: 'ËæìÊ∂≤‰∏≠‚Ä¶', action: 'pixel_story' },
        { id: 'h_vip', scene: 'hospital', name: 'VIPÁóÖÊàø', src: '', x: 5, y: 70, w: 30, h: 20, prompt: 'ÈúÄË¶ÅËøõÂÖ•vipÁã¨Á´ãÁóÖÊàøÂêó', action: 'jump_hospital_room' },
        { id: 'h_exit', scene: 'hospital', name: 'Âá∫Âè£', src: '', x: 40, y: 85, w: 20, h: 15, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },

        // --- üè• Êñ∞Â¢ûÔºöVIPÁóÖÊàø (Sub-scene) ---
        // Ë¶ÜÁõñ‰∏äÊñπ 70% Âå∫ÂüüËß¶Âèë R18
        { id: 'h_r18', scene: 'hospital_room', name: 'ÁóÖÂ∫ä', src: '', x: 10, y: 10, w: 80, h: 60, prompt: 'È¢†È∏æÂÄíÂá§‰∏Ä‰∏ãÔºàÊú™ÊàêÂπ¥Ê≠¢Ê≠•Ôºâ', action: 'pixel_story_r18' },
        { id: 'h_room_exit', scene: 'hospital_room', name: 'Âá∫Èô¢', src: '', x: 30, y: 80, w: 40, h: 20, prompt: 'ÊòØÂê¶Âá∫Èô¢Ôºü', action: 'jump_back_hospital' },

        // --- üèñÔ∏è Êñ∞Â¢ûÔºöÊµ∑Ëæπ (Seaside) ---
        { id: 'sea_hut', scene: 'seaside', name: 'Â∞èÊú®Â±ã', src: '', x: 0, y: 30, w: 20, h: 30, prompt: 'ÊòØÂê¶ÂéªÂ∞èÊú®Â±ã‰ºëÊÅØ‰∏Ä‰∏ãÔºü', action: 'jump_seaside_hut' },
        { id: 'sea_chair', scene: 'seaside', name: 'Ê≤ôÊª©Ê§Ö', src: '', x: 80, y: 40, w: 20, h: 20, prompt: 'Ê≤ôÊª©Ê§ÖÊôí‰ºöÂÑøÂ§™Èò≥„ÄÇ', action: 'pixel_story' },
        { id: 'sea_play', scene: 'seaside', name: 'Â§ßÊµ∑', src: '', x: 30, y: 5, w: 40, h: 20, prompt: 'Êµ∑ËæπÊç°Êç°Ë¥ùÂ£≥„ÄÅË∏©Ë∏©Ê∞¥„ÄÅÈíìÈ±ºÔºü', action: 'pixel_story' },
        { id: 'sea_exit', scene: 'seaside', name: 'Âá∫Âè£', src: '', x: 40, y: 85, w: 20, h: 15, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },

        // --- üèñÔ∏è Êñ∞Â¢ûÔºöÊµ∑ËæπÂ∞èÊú®Â±ã (Sub-scene) ---
        { id: 'hut_rest', scene: 'seaside_hut', name: '‰ºëÊÅØÂå∫', src: '', x: 20, y: 30, w: 60, h: 40, prompt: 'ÊòØÂê¶‰ºëÊÅØ‰∏Ä‰∏ãÔºü', action: 'pixel_story_hut' },
        { id: 'hut_exit', scene: 'seaside_hut', name: 'Á¶ªÂºÄ', src: '', x: 30, y: 80, w: 40, h: 20, prompt: '‰ºëÊÅØÂ•Ω‰∫ÜÔºü', action: 'jump_back_seaside' },

        // --- üå∏ Êñ∞Â¢ûÔºöÊ®±Ëä±ÂÖ¨Âõ≠ (Sakura) ---
        { id: 'sakura_picnic', scene: 'sakura', name: 'ÈáéÈ§êÂû´', src: '', x: 30, y: 40, w: 40, h: 30, prompt: '‰∏ÄËµ∑Âú®Ê®±Ëä±‰∏õ‰∏≠ÈáéÈ§êÔºàÁ∫¶‰ºöÔºâ', action: 'pixel_story' },
        { id: 'sakura_exit', scene: 'sakura', name: 'Âá∫Âè£', src: '', x: 40, y: 85, w: 20, h: 15, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },

        // --- ‚õ™ Êñ∞Â¢ûÔºöÊïôÂ†Ç (Church) ---
        { id: 'church_marry', scene: 'church', name: 'Á•≠Âùõ', src: '', x: 30, y: 20, w: 40, h: 30, prompt: '‰∫å‰ΩçÂ∑≤ÁªèÂáÜÂ§áÂ•ΩËøõÂÖ•Â©öÂßªÁöÑÊÆøÂ†Ç‰∫ÜÂêóÔºü', action: 'pixel_story' },
        { id: 'church_exit', scene: 'church', name: 'Âá∫Âè£', src: '', x: 40, y: 85, w: 20, h: 15, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },

        // --- üßß Êñ∞Â¢ûÔºöÊñ∞Âπ¥ÂπøÂú∫ (New Year) ---
        { id: 'ny_npc1', scene: 'new_year', name: 'NPC1', src: 'https://i.postimg.cc/d1JYhXKG/IMG_1575.png', x: 3, y: 80, w: 40, h: 20, prompt: 'Êñ∞Âπ¥Âø´‰πêÔºÅ', action: 'pixel_story_npc' },
        { id: 'ny_npc2', scene: 'new_year', name: 'ÂÖ´ÂÆùÁ≤•', src: 'https://i.postimg.cc/7LHGgq0Y/IMG-1624.png', x: 0, y: 50, w: 25, h: 0, prompt: 'ÂêÉÁÇπÂÖ´ÂÆùÁ≤•ÔºÅ', action: 'pixel_story_npc' },
        { id: 'ny_npc3', scene: 'new_year', name: 'Âπ¥Â§úÈ•≠', src: 'https://i.postimg.cc/CKTYg5P8/IMG_1577.png', x: 3, y: 20, w: 60, h: 20, prompt: 'Âπ¥Â§úÈ•≠Êù•ÂñΩ„ÄÇ', action: 'pixel_story_npc' },
        { id: 'ny_npc4', scene: 'new_year', name: 'ÂçñËä±Â•≥', src: 'https://i.postimg.cc/VNQ18vGS/IMG_1578.png', x: 45, y: 50, w: 42, h: 20, prompt: 'Êñ∞Âπ¥‰∫ÜÔºåË¶ÅÁªôÁà±‰∫∫‰π∞ÊùüËä±ÂêóÔºü', action: 'pixel_story_npc' },
        { id: 'ny_npc5', scene: 'new_year', name: 'Âπ¥Ë¥ßÊëä', src: 'https://i.postimg.cc/pdbxHrG3/IMG_1579.png', x: 79, y: 48, w: 30, h: 20, prompt: '‰∏ÄËµ∑‰π∞ÁÇπÂπ¥Ë¥ßÂêßÔºÅ', action: 'pixel_story_npc' },
        { id: 'ny_exit', scene: 'new_year', name: 'Âá∫Âè£', src: '', x: 40, y: 85, w: 20, h: 15, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' },

        // --- ‚òï Êñ∞Â¢ûÔºöÂíñÂï°ÂéÖ (Cafe) ---
        { id: 'cafe_sit', scene: 'cafe', name: 'Â∫ß‰Ωç', src: '', x: 20, y: 20, w: 60, h: 30, prompt: 'Âùê‰∏Ä‰ºöÂÑøÔºüÂñùÁÇπÂíñÂï°Ôºü', action: 'pixel_story' },
        { id: 'cafe_shop', scene: 'cafe', name: 'ÊüúÂè∞', src: '', x: 5, y: 40, w: 20, h: 30, prompt: 'Ë¶Å‰π∞ÁÇπ‰ªÄ‰πàÂêó', action: 'open_cafe_shop' },
        { id: 'cafe_exit', scene: 'cafe', name: 'Âá∫Âè£', src: '', x: 40, y: 85, w: 20, h: 15, prompt: 'Ë¶ÅÂºÄËΩ¶ÂõûÂÆ∂ÂêóÔºü', action: 'drive_home' }
    ]
};
// --- 2. Áä∂ÊÄÅ‰∏éÁöÆËÇ§ ---
let rpgState = {
    player: { x: 50, y: 80, dir: 'front' }, 
    npc: { x: 50, y: 50, dir: 'idle', moveTimer: null },
    currentScene: 'room',
    isMoving: false,
    moveDir: null,
    moveInterval: null,
    collisionCtx: null, 
    mapW: 0, mapH: 0
};

// ÂÖ®Â±ÄÁöÆËÇ§ÁºìÂ≠ò (ÁæéÂåñÁî®)
let RPG_SKINS = {
    user_idle: null,
    user_front: null,
    user_back: null,
    user_right: null,
    user_left: null,
    npc_idle: null,
    // --- Êñ∞Â¢û NPC Ë°åËµ∞ÁöÆËÇ§ ---
    npc_front: null,
    npc_back: null,
    npc_right: null
};

// Êõ¥Êñ∞Âä†ËΩΩÂáΩÊï∞
async function loadRpgSkins() {
    try {
        const keys = ['rpg_user_idle', 'rpg_user_front', 'rpg_user_back', 'rpg_user_right', 'rpg_user_left', 'rpg_npc_idle'];
        for (let key of keys) {
            const res = await idb.get('settings_heavy', key);
            if (res) {
                // ÂéªÊéâ 'rpg_' ÂâçÁºÄ‰Ωú‰∏∫ÈîÆÂêç
                const skinKey = key.replace('rpg_', '');
                RPG_SKINS[skinKey] = res.data;
            }
        }
    } catch(e) { console.log("ÁöÆËÇ§Âä†ËΩΩÁï•Ëøá"); }
}

// --- 3. ÂàùÂßãÂåñ ---
function openRpgApp() {
    document.getElementById('rpg-app-modal').style.display = 'flex';
    // Âä†ËΩΩÁæéÂåñËµÑÊ∫ê
    loadRpgSkins().then(() => {
        initRpgGame();
        renderRpgHistory();
    });
}

function closeRpgApp() {
    document.getElementById('rpg-app-modal').style.display = 'none';
    stopMove();
    if(rpgState.npc.moveTimer) clearInterval(rpgState.npc.moveTimer);
}

function initRpgGame() {
    const container = document.getElementById('rpg-map-container');
    rpgState.mapW = container.clientWidth;
    rpgState.mapH = container.clientHeight;

    switchScene('room');

    // ÂàùÂßãÂåñÁ¢∞Êíû Canvas
    const canvas = document.getElementById('rpg-collision-canvas');
    canvas.width = rpgState.mapW;
    canvas.height = rpgState.mapH;
    rpgState.collisionCtx = canvas.getContext('2d', { willReadFrequently: true });
    
    // Âä†ËΩΩÁ¢∞ÊíûÂõæÊï∞ÊçÆ
    const colImg = new Image();
    colImg.crossOrigin = "Anonymous";
    colImg.src = RPG_ASSETS.collision_map;
    colImg.onload = () => {
        rpgState.collisionCtx.drawImage(colImg, 0, 0, rpgState.mapW, rpgState.mapH);
    };

    updateSpritePosition('player');
    updateSpritePosition('npc');
    startNpcAI();
}
async function loadRpgSkins() {
    try {
        // ÂÆö‰πâÊâÄÊúâÈúÄË¶ÅÂä†ËΩΩÁöÑ key (Ê≥®ÊÑèÔºöÊï∞ÊçÆÂ∫ìÈáåÁöÑ key ÊòØÂ∏¶ rpg_ ÂâçÁºÄÁöÑ)
        const keys = [
            'rpg_user_idle', 'rpg_user_front', 'rpg_user_back', 'rpg_user_right', 'rpg_user_left', 
            'rpg_npc_idle',
            // --- Êñ∞Â¢û NPC Key ---
            'rpg_npc_front', 'rpg_npc_back', 'rpg_npc_right'
        ];
        
        for (let key of keys) {
            const res = await idb.get('settings_heavy', key);
            if (res) {
                // ÂéªÊéâ 'rpg_' ÂâçÁºÄ‰Ωú‰∏∫ÂÜÖÂ≠òÂØπË±°ÁöÑÈîÆÂêç
                const skinKey = key.replace('rpg_', '');
                RPG_SKINS[skinKey] = res.data;
            }
        }
    } catch(e) { console.log("ÁöÆËÇ§Âä†ËΩΩÁï•Ëøá"); }
}
function switchScene(sceneName) {
    rpgState.currentScene = sceneName;
    
    const bgImg = document.getElementById('rpg-bg-layer');
    const floorImg = document.getElementById('rpg-floor-layer');
    
    // Ê∏ÖÁ©∫Á¢∞ÊíûÂ±Ç (Âõ†‰∏∫Âè™Êúâ Room ÊúâÁ¢∞ÊíûÈÄªËæë)
    if(rpgState.collisionCtx) rpgState.collisionCtx.clearRect(0, 0, rpgState.mapW, rpgState.mapH);

    // ËÆæÁΩÆËÉåÊôØ
    if(sceneName === 'room') {
        bgImg.src = RPG_ASSETS.bg_room;
        bgImg.style.display = 'block';
        floorImg.src = RPG_ASSETS.collision_map;
        floorImg.style.display = 'block';
        
        // ÈáçÊñ∞Âä†ËΩΩÊàøÈó¥Á¢∞ÊíûÂõæ
        const colImg = new Image(); 
        colImg.crossOrigin = "Anonymous"; 
        colImg.src = RPG_ASSETS.collision_map;
        colImg.onload = () => { if(rpgState.collisionCtx) rpgState.collisionCtx.drawImage(colImg, 0, 0, rpgState.mapW, rpgState.mapH); };
        
        rpgState.player.x = 50; rpgState.player.y = 80;
    } 
    else {
        // === ÊâÄÊúâÂ§ñÈÉ®Âú∫ÊôØ (ÂåÖÊã¨Êñ∞Â¢ûÁöÑ) ===
        floorImg.style.display = 'none'; // ÈöêËóèÂú∞ÊùøÂ±Ç
        
        // Êò†Â∞ÑÂú∫ÊôØÂêçÂà∞ËÉåÊôØËµÑÊ∫ê
        const bgMap = {
            'outside': RPG_ASSETS.bg_outside,
            'store': RPG_ASSETS.bg_store,
            'hospital': RPG_ASSETS.bg_hospital,
            'hospital_room': RPG_ASSETS.bg_hospital_room,
            'seaside': RPG_ASSETS.bg_seaside,
            'seaside_hut': RPG_ASSETS.bg_seaside_hut,
            'sakura': RPG_ASSETS.bg_sakura,
            'church': RPG_ASSETS.bg_church,
            'new_year': RPG_ASSETS.bg_new_year,
            'cafe': RPG_ASSETS.bg_cafe
        };
        
        if (bgMap[sceneName]) {
            bgImg.src = bgMap[sceneName];
            
            // ‰æøÂà©Â∫óÁâπÊÆäÁ¢∞Êíû (Â¶ÇÊûúÈúÄË¶ÅÁöÑËØùÔºåÊääËÉåÊôØÂΩìÂ¢ô)
            if (sceneName === 'store') {
                const storeImg = new Image();
                storeImg.crossOrigin = "Anonymous";
                storeImg.src = RPG_ASSETS.bg_store;
                storeImg.onload = () => { if(rpgState.collisionCtx) rpgState.collisionCtx.drawImage(storeImg, 0, 0, rpgState.mapW, rpgState.mapH); };
            }
        }
        
        // ËÆæÁΩÆÂàùÂßã‰ΩçÁΩÆ
        if (sceneName === 'hospital_room' || sceneName === 'seaside_hut') {
            rpgState.player.x = 50; rpgState.player.y = 80;
        } else {
            rpgState.player.x = 10; rpgState.player.y = 80; 
        }
    }
    
    renderDecorations();
}

// Ê∏≤ÊüìË£ÖÈ•∞Áâ©
function renderDecorations() {
    const layer = document.getElementById('rpg-decor-layer');
    layer.innerHTML = '';
    
    RPG_ASSETS.items.forEach(item => {
        if (item.scene !== rpgState.currentScene) return;

        const img = document.createElement('img');
        img.src = item.src;
        img.className = 'rpg-decor'; // CSS class handled styling
        img.style.position = 'absolute';
        img.style.left = item.x + '%';
        img.style.top = item.y + '%';
        img.style.width = item.w + '%';
        img.style.zIndex = Math.floor(item.y); // ÁÆÄÂçïÈÅÆÊå°ÂÖ≥Á≥ª
        
        if(item.type === 'person') {
             img.style.pointerEvents = 'auto';
             img.style.cursor = 'pointer';
             img.onclick = (e) => { e.stopPropagation(); openRpgChatMode(); };
        } else {
             img.style.pointerEvents = 'none';
        }
        layer.appendChild(img);
    });
}
function startMove(dir) {
    if (rpgState.isMoving) return;
    rpgState.isMoving = true;
    rpgState.moveDir = dir;
    
    const pDiv = document.getElementById('rpg-char-player');
    let src = "";
    
    // ÈáçÁΩÆ transformÔºåÈÅøÂÖçÁøªËΩ¨Âπ≤Êâ∞
    pDiv.style.transform = 'none';

    if(dir === 'right') {
        // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂè≥ÂõæÁî®Âè≥ÂõæÔºåÊ≤°ÊúâÂàôÁî®ÈªòËÆ§ GIF
        src = RPG_SKINS.user_right || RPG_ASSETS.char_gifs.right;
        // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÂè≥Âõæ(Áî®ÁöÑÊòØÈªòËÆ§)ÔºåÂèØËÉΩÈúÄË¶ÅÂ§ÑÁêÜÁøªËΩ¨(ËßÜÁ¥†ÊùêËÄåÂÆöÔºåËøôÈáåÂÅáËÆæÈªòËÆ§Á¥†ÊùêÂêëÂè≥)
    } 
    else if (dir === 'left') {
        // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ∑¶ÂõæÔºåÁõ¥Êé•Áî®
        if (RPG_SKINS.user_left) {
            src = RPG_SKINS.user_left;
        } else {
            // Ê≤°ÊúâËá™ÂÆö‰πâÂ∑¶ÂõæÔºåÂÄüÁî®Âè≥ÂõæÂπ∂ÁøªËΩ¨
            src = RPG_SKINS.user_right || RPG_ASSETS.char_gifs.right;
            pDiv.style.transform = 'scaleX(-1)';
        }
    } 
    else if (dir === 'up') {
        src = RPG_SKINS.user_back || RPG_ASSETS.char_gifs.back;
    } 
    else if (dir === 'down') {
        src = RPG_SKINS.user_front || RPG_ASSETS.char_gifs.front;
    }
    
    pDiv.style.backgroundImage = `url(${src})`;
    rpgState.moveInterval = setInterval(gameLoop, 30);
}

// ÂêåÊó∂‰πü‰øÆÊ≠£ stopMove ÊÅ¢Â§çÂæÖÊú∫Âõæ
function stopMove() {
    rpgState.isMoving = false;
    clearInterval(rpgState.moveInterval);
    const pDiv = document.getElementById('rpg-char-player');
    // ÊÅ¢Â§çÂæÖÊú∫Âõæ
    const src = RPG_SKINS.user_idle || RPG_ASSETS.char_gifs.idle;
    pDiv.style.backgroundImage = `url(${src})`;
    pDiv.style.transform = 'none';
}

// === üèÉ‚Äç‚ôÇÔ∏è ÂçáÁ∫ßÁâàÊ∏∏ÊàèÂæ™ÁéØ (ÊîØÊåÅ8ÊñπÂêë/ÊñúÂêëÁßªÂä®) ===
// === üèÉ‚Äç‚ôÇÔ∏è ‰øÆÂ§çÁâàÔºöÊ∏∏ÊàèÂæ™ÁéØ ===
function gameLoop() {
    // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ¶ÇÊûúÊï∞ÊçÆ‰∏çÂÖ®ÔºåÂÅúÊ≠¢ÁßªÂä®
    if (!rpgState.isMoving || !rpgState.moveVector) return;

    // ÈÄüÂ∫¶Á≥ªÊï∞ (0.6 ~ 1.0 ‰πãÈó¥Ë∞ÉÊï¥)
    const speed = 0.5; 

    // ËÆ°ÁÆó‰ΩçÁßª
    let nextX = rpgState.player.x + (rpgState.moveVector.x * speed);
    let nextY = rpgState.player.y + (rpgState.moveVector.y * speed);

    // ËæπÁïåÈôêÂà∂
    if(nextX < 0) nextX = 0; if(nextX > 90) nextX = 90;
    if(nextY < 0) nextY = 0; if(nextY > 90) nextY = 90;

    // Êõ¥Êñ∞ÂùêÊ†á
    if (!checkCollision(nextX, nextY)) {
        rpgState.player.x = nextX;
        rpgState.player.y = nextY;
    }

    // üß† Ê†∏ÂøÉÔºöÂà§Êñ≠ÊúùÂêëÂπ∂‰º†ÁªôÊ∏≤ÊüìÂáΩÊï∞
    const absX = Math.abs(rpgState.moveVector.x);
    const absY = Math.abs(rpgState.moveVector.y);
    
    let dominantDir = 'down'; 
    
    // Â¶ÇÊûúÊ®™ÂêëÁßªÂä®ÊØîÁ∫µÂêëÂ§öÔºåÂ∞±ÊòØÂ∑¶Âè≥ÔºõÂê¶ÂàôÊòØ‰∏ä‰∏ã
    if (absX > absY) {
        dominantDir = rpgState.moveVector.x > 0 ? 'right' : 'left';
    } else {
        dominantDir = rpgState.moveVector.y > 0 ? 'down' : 'up';
    }

    // üî• ËøôÈáåÂøÖÈ°ª‰º†ÂÖ• dominantDirÔºåÂê¶ÂàôÂ∞±‰ºöÂèòÊàê idle
    updateSpritePosition('player', dominantDir); 
    
    checkInteraction();
}
// === üé® ‰øÆÂ§çÁâàÔºöÂº∫Âà∂Ê∏≤ÊüìËßíËâ≤Á´ãÁªò ===
function updateSpritePosition(role, overrideDir) {
    const el = document.getElementById(role === 'player' ? 'rpg-char-player' : 'rpg-char-npc');
    // Èò≤Ê≠¢Êä•ÈîôÔºöÂ¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂÖÉÁ¥†Áõ¥Êé•ËøîÂõû
    if (!el) return;

    const data = role === 'player' ? rpgState.player : rpgState.npc;
    
    // ‰ºòÂÖàÁ∫ßÔºöÂèÇÊï∞‰º†ÂÖ•ÁöÑÊñπÂêë > Êï∞ÊçÆÈáåÁöÑÊñπÂêë > ÈªòËÆ§ idle
    const dir = overrideDir || data.dir || 'idle';
    
    // ÈáçÁΩÆ CSS ÂèòÊç¢ÔºåÈò≤Ê≠¢ÁøªËΩ¨Âè†Âä†
    el.style.transform = 'none';

    let src = "";

    // === Áé©ÂÆ∂ÈÄªËæë ===
    if (role === 'player') {
        // 1. ‰ºòÂÖàÂ∞ùËØïËØªÂèñËá™ÂÆö‰πâÁöÆËÇ§ (RPG_SKINS)
        // 2. Â¶ÇÊûúÊ≤°ÊúâÔºåËØªÂèñÈªòËÆ§ËµÑÊ∫ê (RPG_ASSETS.char_gifs)
        // 3. Â¶ÇÊûúËøòÊ≤°ÊúâÔºåÁªô‰∏Ä‰∏™Á©∫Â≠óÁ¨¶‰∏≤Èò≤Ê≠¢Êä•Èîô
        
        if (dir === 'right') {
            src = RPG_SKINS.user_right || RPG_ASSETS.char_gifs.right;
        } 
        else if (dir === 'left') {
            // Â∑¶‰æßÁâπÊÆäÂ§ÑÁêÜÔºöÊúâÂ∑¶ÂõæÁî®Â∑¶ÂõæÔºåÊ≤°Â∑¶ÂõæÁî®Âè≥Âõæ+ÈïúÂÉèÁøªËΩ¨
            if (RPG_SKINS.user_left) {
                src = RPG_SKINS.user_left;
            } else {
                src = RPG_SKINS.user_right || RPG_ASSETS.char_gifs.right; 
                el.style.transform = 'scaleX(-1)'; 
            }
        }
        else if (dir === 'up') {
            src = RPG_SKINS.user_back || RPG_ASSETS.char_gifs.back;
        }
        else if (dir === 'down') {
            src = RPG_SKINS.user_front || RPG_ASSETS.char_gifs.front;
        }
        else {
            // ÂæÖÊú∫Áä∂ÊÄÅ
            src = RPG_SKINS.user_idle || RPG_ASSETS.char_gifs.idle;
        }
        
        // ‚ö°Ô∏è Âº∫Âà∂Â∫îÁî®ËÉåÊôØÂõæ
        if (src) el.style.backgroundImage = `url(${src})`;
    }
    
    // === NPC ÈÄªËæë (‰øùÊåÅ‰∏çÂèò) ===
    else if (role === 'npc') {
        let nSrc = RPG_SKINS.npc_idle || RPG_ASSETS.char_gifs.idle;
        
        if (dir === 'down') nSrc = RPG_SKINS.npc_front || RPG_ASSETS.char_gifs.front || nSrc;
        else if (dir === 'up') nSrc = RPG_SKINS.npc_back || RPG_ASSETS.char_gifs.back || nSrc;
        else if (dir === 'right') nSrc = RPG_SKINS.npc_right || RPG_ASSETS.char_gifs.right || nSrc;
        else if (dir === 'left') { 
            nSrc = RPG_SKINS.npc_right || RPG_ASSETS.char_gifs.right || nSrc; 
            el.style.transform = 'scaleX(-1)'; 
        }
        
        if (nSrc) el.style.backgroundImage = `url(${nSrc})`;
        el.style.pointerEvents = 'auto';
        el.onclick = () => openRpgChatMode();
    }
    
    // Êõ¥Êñ∞ÂùêÊ†á
    el.style.left = data.x + '%';
    el.style.top = data.y + '%';
}
// ==================== 1. Á¢∞ÊíûÊ£ÄÊµãÔºà‰øÆÊîπ‰∏∫ÔºöÊó†ÈôêÂà∂Ê®°ÂºèÔºâ ====================
function checkCollision(xPercent, yPercent) {
    // Áõ¥Êé•ËøîÂõû falseÔºåÊÑèÂë≥ÁùÄ‚ÄúÊ≤°ÊúâÁ¢∞Êíû‚ÄùÔºåÂÖÅËÆ∏Áé©ÂÆ∂Ëµ∞Âà∞Âú∞Âõæ‰ªª‰ΩïÂùêÊ†á
    return false;
}
function checkInteraction() {
    let nearItem = null;
    const px = rpgState.player.x;
    const py = rpgState.player.y;

    for (let item of RPG_ASSETS.items) {
        if (item.scene !== rpgState.currentScene) continue;
        const h = item.h || 15;
        const w = item.w || 15;
        if (px >= item.x - 5 && px <= item.x + w + 5 &&
            py >= item.y - 5 && py <= item.y + h + 5) {
            nearItem = item;
            break;
        }
    }

    const dialog = document.getElementById('rpg-dialog-overlay');
    const inputEl = document.getElementById('rpg-interact-input');
    
    if (nearItem && nearItem.prompt) {
        if (dialog.style.display === 'none') inputEl.value = ''; 
        
        dialog.style.display = 'block';
        document.getElementById('rpg-dialog-text').innerText = nearItem.prompt;
        
        const yesBtn = document.getElementById('rpg-btn-yes');
        yesBtn.onclick = null; // Ëß£ÁªëÊóß‰∫ã‰ª∂
        
        yesBtn.onclick = () => {
            // Ëé∑ÂèñÁî®Êà∑ËæìÂÖ•
            const userExtra = inputEl.value.trim();

            if (nearItem.action === 'show_travel_options') showTravelOptions(); 
            else if (nearItem.action === 'drive_home') startDrivingHome(); 
            else if (nearItem.action === 'open_cafe_shop') { openCafeShop(); closeRpgDialog(); } 
            else if (nearItem.action === 'jump_hospital_room') { switchScene('hospital_room'); closeRpgDialog(); } 
            else if (nearItem.action === 'jump_back_hospital') { switchScene('hospital'); closeRpgDialog(); } 
            else if (nearItem.action === 'jump_seaside_hut') { switchScene('seaside_hut'); closeRpgDialog(); } 
            else if (nearItem.action === 'jump_back_seaside') { switchScene('seaside'); closeRpgDialog(); } 
            
            // ÂâßÊÉÖÁîüÊàêÁ±ª (‰º†ÂÖ• userExtra)
            else if (nearItem.action === 'pixel_story' || nearItem.action === 'pixel_story_npc' || nearItem.action === 'pixel_story_hut') {
                generatePixelStory(nearItem.prompt, false, userExtra);
                closeRpgDialog();
            } 
            else if (nearItem.action === 'pixel_story_r18') {
                generatePixelStory(nearItem.prompt, true, userExtra); 
                closeRpgDialog();
            } 
            else if (nearItem.type === 'person') {
                generateFriendStory(nearItem, userExtra); 
                closeRpgDialog();
            } 
            else if (nearItem.type === 'shelf') {
                generateStoreShopping(nearItem, userExtra); 
                closeRpgDialog();
            } 
            else {
                generateRpgStory(nearItem, userExtra); 
                closeRpgDialog();
            }
        };
    } else {
        dialog.style.display = 'none';
    }
}
function closeRpgDialog() { 
    document.getElementById('rpg-dialog-overlay').style.display = 'none'; 
}

// --- 5. ËÅäÂ§©Ê®°Âºè (ËÉåÊôØÊòæÁ§∫‰øÆÂ§ç) ---
function openRpgChatMode() {
    document.getElementById('rpg-chat-modal').style.display = 'flex';
    
    // 1. ËÆæÁΩÆËÉåÊôØÂÆπÂô® (Ëß£ÂÜ≥ÁôΩÂ±èÈóÆÈ¢ò)
    const bgContainer = document.getElementById('rpg-chat-bg-container');
    const bgSrc = rpgState.currentScene === 'room' ? RPG_ASSETS.bg_room : RPG_ASSETS.bg_outside;
    bgContainer.style.backgroundImage = `url(${bgSrc})`;
    bgContainer.style.backgroundSize = 'cover';
    bgContainer.style.backgroundPosition = 'center';
    
    // 2. Â∞ÜÂΩìÂâçÂú∫ÊôØÁöÑÂÆ∂ÂÖ∑Â§çÂà∂ËøõËÉåÊôØÂÆπÂô®ÔºåÂÆûÁé∞"ÁúãÂà∞Ë£ÖÈ•∞"
    bgContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÁöÑ
    // Â§çÂà∂Âú∞ÊùøÂ±Ç (Â¶ÇÊûúÂú®ÊàøÈó¥)
    if(rpgState.currentScene === 'room') {
        const floor = document.createElement('img');
        floor.src = RPG_ASSETS.collision_map;
        floor.style.cssText = "position:absolute; top:0; left:0; width:100%; height:100%; object-fit:fill;";
        bgContainer.appendChild(floor);
    }
    // Â§çÂà∂Ë£ÖÈ•∞Áâ©
    const originalDecor = document.getElementById('rpg-decor-layer');
    // ÂÖãÈöÜËäÇÁÇπ
    const cloneDecor = originalDecor.cloneNode(true);
    bgContainer.appendChild(cloneDecor);

    // 3. ËÆæÁΩÆÁ´ãÁªò
    const npcImg = document.getElementById('rpg-chat-npc-img');
    const userImg = document.getElementById('rpg-chat-user-img');
    npcImg.src = RPG_SKINS.npc_idle || RPG_ASSETS.char_gifs.idle;
    userImg.src = RPG_SKINS.user_idle || RPG_ASSETS.char_gifs.idle;

    renderRpgChatList();
}

function closeRpgChat() {
    document.getElementById('rpg-chat-modal').style.display = 'none';
}
// ‰øÆÊîπ NPC AIÔºöÁßªÂä®Êó∂Âà§Êñ≠ÊñπÂêëÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
function startNpcAI() {
    if(rpgState.npc.moveTimer) clearInterval(rpgState.npc.moveTimer);
    rpgState.npc.moveTimer = setInterval(() => {
        if(Math.random() < 0.4) { // ÊèêÈ´ò‰∏ÄÁÇπÂä®ÂºπÁöÑÈ¢ëÁéá
            let nx = rpgState.npc.x, ny = rpgState.npc.y;
            let dir = 'idle'; // ÈªòËÆ§Áä∂ÊÄÅ
            
            const r = Math.random();
            // Ê†πÊçÆÈöèÊú∫Êï∞ÂÜ≥ÂÆöÊñπÂêë
            if(r < 0.25) { 
                nx -= 5; dir = 'left'; 
            } else if(r < 0.5) { 
                nx += 5; dir = 'right'; 
            } else if(r < 0.75) { 
                ny -= 5; dir = 'up';   // ‰πüÂ∞±ÊòØËÉåÂΩ±
            } else { 
                ny += 5; dir = 'down'; // ‰πüÂ∞±ÊòØÊ≠£Èù¢
            }

            // ËæπÁïåÊ£ÄÊü•
            if(nx > 0 && nx < 90 && ny > 0 && ny < 90) {
                rpgState.npc.x = nx; 
                rpgState.npc.y = ny;
                rpgState.npc.dir = dir; // ËÆ∞ÂΩïÂΩìÂâçÊñπÂêë
                updateSpritePosition('npc'); // Êõ¥Êñ∞ÁîªÈù¢
            }
        } else {
            // ÊúâÊ¶ÇÁéáÂÅú‰∏ãÊù•ÂèëÂëÜ
            rpgState.npc.dir = 'idle';
            updateSpritePosition('npc');
        }
    }, 2000);
}

// Á°Æ‰øùÂú®ÁæéÂåñÁïåÈù¢Â∫îÁî®ËÆæÁΩÆÊó∂Êõ¥Êñ∞ RPG ÁöÆËÇ§
if(typeof applyAllThemeSettings === 'function') {
    const _oldApply = applyAllThemeSettings;
    applyAllThemeSettings = async function() {
        await _oldApply();
        await loadRpgSkins(); // ÈáçÊñ∞Âä†ËΩΩÁöÆËÇ§
    }
}
// ==================== RPG ÂÉèÁ¥†ÁîüÊ¥ªÁ≥ªÁªü (‰øÆÂ§çÊï¥ÂêàÁâà) ====================

// --- ÂèòÈáèÂÆö‰πâ (Áã¨Á´ã‰∫é Page 2 Ê∏∏ÊàèÊú∫) ---
let rpgActiveDeck = [];
let rpgFlippedCards = [];

// 1. ÂêØÂä® RPG ‰∏ìÁî®ÊäΩÁâå (ÂØπÂ∫îÁÇπÂáª "üé≤ ÊäΩÁâåÂπ∂ÂØπËØù")
// 1. ÂêØÂä® RPG ‰∏ìÁî®ÊäΩÁâå (ÂØπÂ∫îÁÇπÂáª "üé≤ ÊäΩÁâåÂπ∂ÂØπËØù")
window.openRpgCardTable = function() {
    const inputVal = document.getElementById('rpg-chat-input').value.trim();
    if(!inputVal) return alert("ËØ∑ÂÖàÂú®ËæìÂÖ•Ê°ÜÂØπ Ta ËØ¥ÁÇπ‰ªÄ‰πà...");

    const modal = document.getElementById('rpg-card-table-modal');
    const area = document.getElementById('rpg-card-area');
    const desk = document.getElementById('rpg-card-table-desk');

    // Â∫îÁî®ÁæéÂåñ (Â§çÁî®Â°îÁΩóÊ°åÂ∏É)
    if(typeof idb !== 'undefined') {
        idb.get('settings_heavy', 'tarot_table').then(res => {
            if(res && res.data) {
                desk.style.backgroundImage = `url(${res.data})`;
                desk.style.backgroundSize = 'cover';
            }
        });
    }

    area.innerHTML = ''; 
    rpgActiveDeck = [];
    rpgFlippedCards = [];
    document.getElementById('rpg-flipped-count').innerText = '0';

    // ÁîüÊàêÂÆåÊï¥ÁâåÂ∫ì (0-77 Â°îÁΩó + 1-36 Èõ∑ËØ∫Êõº)
    for(let i=0; i<=77; i++) rpgActiveDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 }); 
    for(let i=1; i<=36; i++) rpgActiveDeck.push({ type: 'lenormand', id: i, isReversed: false }); 
    
    // Ê¥óÁâå
    rpgActiveDeck.sort(() => Math.random() - 0.5);

    // ËÆ°ÁÆóÂ∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cardWidth = 60, cardHeight = 90, gapX = 10, gapY = 15;       
    let columns = Math.floor((deskW - 20) / (cardWidth + gapX));
    if (columns < 4) columns = 4;
    
    const startX = Math.max(0, (deskW - (columns * cardWidth + (columns - 1) * gapX)) / 2);
    const startY = 60;

    rpgActiveDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card'; 
        
        const colIndex = index % columns;
        const rowIndex = Math.floor(index / columns);
        
        el.style.left = (startX + colIndex * (cardWidth + gapX)) + 'px';
        el.style.top = (startY + rowIndex * (cardHeight + gapY)) + 'px';
        el.style.transform = `rotate(${Math.random() * 6 - 3}deg)`; 
        
        // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
        el.onclick = () => flipRpgCard(el, card);
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        area.appendChild(el);
    });
    
    const totalRows = Math.ceil(rpgActiveDeck.length / columns);
    area.style.height = (startY + totalRows * (cardHeight + gapY) + 120) + 'px';

    modal.style.display = 'flex';
}

// 2. ÁøªÁâåÈÄªËæë
async function flipRpgCard(el, cardData) {
    if(el.classList.contains('flipped')) {
        // ÂèñÊ∂àÁøªÁâå
        el.classList.remove('flipped');
        rpgFlippedCards = rpgFlippedCards.filter(c => !(c.type === cardData.type && c.id === cardData.id));
        
        setTimeout(() => {
            const frontEl = el.querySelector('.playing-card-front');
            if(frontEl) {
                frontEl.style.backgroundImage = ''; 
                frontEl.style.transform = ''; 
                frontEl.innerText = '';
            }
        }, 300);
    } else {
        // ÁøªÁâå
        el.classList.add('flipped');
        rpgFlippedCards.push(cardData);
        
        const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        try {
            const item = await idb.get(dbName, cardData.id);
            const frontEl = el.querySelector('.playing-card-front');
            
            if (item && item.data) {
                frontEl.style.backgroundImage = `url(${item.data})`;
                frontEl.style.backgroundSize = 'cover'; 
                frontEl.style.backgroundPosition = 'center';
                frontEl.innerText = ''; 
            } else {
                // Ê≤°ÂõæÊó∂ÁöÑÂÖúÂ∫ïÊòæÁ§∫
                frontEl.style.backgroundColor = '#e17055';
                frontEl.style.color = '#fff';
                frontEl.style.display = 'flex';
                frontEl.style.alignItems = 'center';
                frontEl.style.justifyContent = 'center';
                frontEl.style.fontSize = '0.7rem';
                frontEl.innerText = `${cardData.type}\n#${cardData.id}`;
            }
            
            // Â§ÑÁêÜÈÄÜ‰Ωç
            if(cardData.type === 'tarot' && cardData.isReversed) {
                frontEl.style.transform = "rotateY(180deg) rotate(180deg)"; 
            } else {
                frontEl.style.transform = "rotateY(180deg)";
            }
        } catch(e) { console.error("Âä†ËΩΩÂõæÁâáÂ§±Ë¥•:", e); }
    }
    document.getElementById('rpg-flipped-count').innerText = rpgFlippedCards.length;
}

// 3. Ê†∏ÂøÉ API ÁîüÊàêÔºöÂÆåÊàêÂØπËØù (‰øùÁïôÂéüÊèêÁ§∫ËØç)
async function finishRpgChat() {
    if(rpgFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºåËÆ©ÂëΩËøêÊåáÂºï Ta ÁöÑÂõûÂ§çÔºÅ");
    
    // UI ‰∫§‰∫í
    const userInput = document.getElementById('rpg-chat-input').value;
    const btn = document.querySelector('#rpg-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ Ê≠£Âú®ËøûÊé• Ta ÁöÑÊΩúÊÑèËØÜ..."; btn.disabled = true;

    // ÂáÜÂ§á‰∏ä‰∏ãÊñáÊï∞ÊçÆ
    const cardsDesc = rpgFlippedCards.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const chatCtx = (wb['2.Â∞èÂâßÂú∫'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
        let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    // üü¢ ‰øÆÂ§çÔºöÂº∫Âà∂ËØªÂèñÁºìÂ≠ò
    if(!apiKey || !model) {
        try { 
            const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); 
            if(!apiKey) apiKey = s.key; 
            if(!apiUrl) apiUrl = s.url; 
            if(!model) model = s.model;
        } catch(e){}
    }
    // ÈªòËÆ§ÂÄº
    if(!apiUrl) apiUrl = "https://api.openai.com/v1";
    if(!model) model = "gpt-3.5-turbo";

    if(!apiKey) { btn.innerText = oldText; btn.disabled = false; return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API Key"); }

    // === üåü ÂéüÁâàÊèêÁ§∫ËØç (Original Prompt) ===
    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®ÂíåÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑ‰∫≤ÂØÜÂØπËØù„ÄÇ
„ÄêËßíËâ≤ËÆæÂÆö„ÄëÔºö${globalCtx}
„ÄêË°•ÂÖÖËÆæÂÆö„ÄëÔºö${chatCtx}

„ÄêÊÉÖÂ¢É„ÄëÔºö
Áî®Êà∑ÂØπ‰Ω†ËØ¥‰∫ÜÔºö"${userInput}"
‰∏éÊ≠§ÂêåÊó∂ÔºåÊ≠§Êó∂Ê≠§ÂàªÁöÑÂëΩËøêÂç°ÁâåÊòæÁ§∫‰∫ÜÂΩì‰∏ãÁöÑËÉΩÈáèÂú∫Ôºö„Äê${cardsDesc}„Äë

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÁªìÂêà**ÁâåÊÑè**ÂíåËßíËâ≤ÊÄßÊ†ºÔºåÁªôÁî®Êà∑‰∏Ä‰∏™ÂõûÂ§ç„ÄÇ

üëâ **Ëß£ÁâåÊ†∏ÂøÉË¶ÅÊ±ÇÔºàÈáçË¶ÅÔºâ**Ôºö
ËØ∑‰∏çË¶ÅÁÖß‰π¶Êú¨ËÉåËØµÁâå‰πâ„ÄÇËØ∑Ê†πÊçÆÁâåÈù¢ÁöÑ**„ÄêÁîªÈù¢ÊÑü (Imagery)„Äë**Âíå**„ÄêËÉΩÈáèÁöÑÊµÅÂä® (Energy Flow)„Äë**Êù•ÂÜ≥ÂÆöËßíËâ≤Ê≠§ÂàªÁöÑÊÉÖÁª™ÂíåÊΩúÂè∞ËØç„ÄÇ
   - ‰æãÂ¶ÇÔºöÊäΩÂà∞„ÄäÂÆùÂâëÂÖ≠„ÄãÔºåËÉΩÈáèÊòØ‚ÄúÊ∏°ËøáÈöæÂÖ≥ÂêéÁöÑÂπ≥Èùô‰ΩÜÂ∏¶ÁùÄÂøß‰º§‚ÄùÔºåÁîªÈù¢ÊòØ‚Äú‰πòËàπËøúÂéª‚Äù„ÄÇËßíËâ≤ÂõûÂ§çÊó∂Â∫îËØ•Â∏¶ÁùÄËøôÁßçÂæÆÂæÆÁöÑÁñèÁ¶ªÊÑüÊàñÈáäÁÑ∂ÊÑü„ÄÇ
   - ‰æãÂ¶ÇÔºöÊäΩÂà∞„ÄäÊùÉÊùñÂÖ´„ÄãÔºåËÉΩÈáèÊòØ‚ÄúÊÄ•ÈÄü„ÄÅÁÉ≠ÁÉà„ÄÅÂÜ≤Âä®‚ÄùÔºåÁîªÈù¢ÊòØ‚ÄúÊª°Â§©È£ûÊù•ÁöÑÊùÉÊùñ‚Äù„ÄÇËßíËâ≤ÂõûÂ§çÊó∂ËØ≠ÈÄüÂ∫îËØ•ÂæàÂø´ÔºåÊÉÖÁª™È´òÊòÇÔºåËø´‰∏çÂèäÂæÖ„ÄÇ

„ÄêËæìÂá∫Ë¶ÅÊ±Ç„ÄëÔºö
1. **Â≠óÊï∞**Ôºö‰∏•Ê†ºÊéßÂà∂Âú® **3 Âà∞ 4 Âè•ËØù**„ÄÇ
2. **ÂÜÖÂÆπ**ÔºöËΩ¨Âåñ‰∏∫ËßíËâ≤ÁöÑËá™ÁÑ∂ËØ≠Ë®ÄÔºå**ÁªùÂØπ‰∏çË¶Å**Âá∫Áé∞‚ÄúÂõ†‰∏∫ÁâåÊÑèÊòØ...‚ÄùËøôÁßçËß£ÈáäÊÄßÁöÑËØù„ÄÇ
3. **Ê†ºÂºè**ÔºöÁõ¥Êé•ËæìÂá∫ÂõûÂ§çÂÜÖÂÆπÔºå‰∏çË¶ÅÂºïÂè∑„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a roleplay character."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const reply = json.choices[0].message.content.trim();

        // --- ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ® (Big Memory) ---
        if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
        if(!window.BIG_MEMORY.rpg_data.chat_history) window.BIG_MEMORY.rpg_data.chat_history = [];
        
        // Â≠òÂÖ•Áî®Êà∑Ê∂àÊÅØ
        window.BIG_MEMORY.rpg_data.chat_history.push({ role: 'me', text: userInput });
        // Â≠òÂÖ•ÂõûÂ§ç (Â∏¶Â∞èÂ∞æÂ∑¥ÊòæÁ§∫ÁâåÂêç)
        window.BIG_MEMORY.rpg_data.chat_history.push({ role: 'char', text: reply + ` <span style="font-size:0.6rem;opacity:0.5;">(üîÆ${cardsDesc})</span>` });
        
        // ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
        saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
        
        // Âà∑Êñ∞ÁïåÈù¢
        renderRpgChatList();
        document.getElementById('rpg-chat-input').value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        document.getElementById('rpg-card-table-modal').style.display = 'none'; // ÂÖ≥Èó≠ÁâåÊ°å

    } catch(e) {
        console.error(e);
        alert("ÂõûÂ§çÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
}

// ==================== 3. ÊïÖ‰∫ãÁîüÊàêÂáΩÊï∞Áæ§ (Êó†ÈôêÂ≠òÂÇ®ÊîØÊåÅ) ====================

// A. ÊàøÈó¥‰∫íÂä®ÊïÖ‰∫ã (‰øÆÂ§çÔºöÁ°Æ‰øùË∞ÉÁî®ÊàêÂäü)
async function generateRpgStory(item, userExtra) {
    showRpgLoading(`Ê≠£Âú®ÁîüÊàê‰∏é„Äê${item.name}„ÄëÁöÑ‰∫íÂä®...`);
    
    const context = await getRpgContext();
    if(!context) return; 

    // üî• ËûçÂêàÈÄªËæë
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊ≤ªÊÑàÁ≥ªÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÂÆ∂‰∏≠„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑‰ΩøÁî®‰∫ÜÊàøÈó¥ÈáåÁöÑ„Äê${item.name}„Äë„ÄÇ
„ÄêÁî®Êà∑Ë°•ÂÖÖÁªÜËäÇ„ÄëÔºö${userExtra || "ÔºàÊó†Ôºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ÂÜô‰∏ÄÊÆµ 150-250 Â≠óÁöÑÊ∏©È¶®ÁîüÊ¥ªÁâáÊÆµ„ÄÇ
ËßÜËßíÔºöÁ¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚Äù„ÄÇ
ÂÜÖÂÆπÔºöËØ∑ÊèèÂÜôÁî®Êà∑‰ΩøÁî®${item.name}ÁöÑËøáÁ®ãÔºåÂπ∂ÁªìÂêàÁî®Êà∑ÁöÑË°•ÂÖÖÁªÜËäÇÔºàÂ¶ÇÊûúÊúâÔºâ„ÄÇ
ÈáçÁÇπÊèèÂÜôÊÑüÂÆòÁªÜËäÇ„ÄÅËß¶ÊÑü„ÄÅÂ£∞Èü≥Ôºå‰ª•ÂèäÊ≠§ÂàªËßíËâ≤ÔºàTaÔºâÂú®ÂÅö‰ªÄ‰πà„ÄÇ
`;
    
    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üè† Â±ÖÂÆ∂ ¬∑ ${item.name}`, story);
        alert(`‚ú® ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ`);
    });
}
async function generateFriendStory(friend, userExtra) {
    showRpgLoading(`Ê≠£Âú®ËÅÜÂê¨${friend.name}ÁöÑÁ•ùÁ¶è...`);
    
    const context = await getRpgContext();
    if(!context) return;

    // üî• ËûçÂêàÈÄªËæë
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊÉÖÊÑüÁªÜËÖªÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÊà∑Â§ñ„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑ÂíåËßíËâ≤ÔºàTaÔºâÂÅ∂ÈÅá‰∫ÜÊúãÂèã„Äê${friend.name}„Äë„ÄÇ
„ÄêÊúãÂèãËØ¥„ÄëÔºö"${friend.prompt}"
„ÄêÁî®Êà∑Ê≠§Êó∂ÁöÑÂèçÂ∫î„ÄëÔºö${userExtra || "ÔºàÂÆ≥ÁæûÊàñÈªòËÆ§Ôºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ÂÜô‰∏ÄÊÆµ 200 Â≠óÂ∑¶Âè≥ÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ
1. ÊèèÂÜôÂê¨Âà∞ÊúãÂèãËøôÂè•ËØùÂêéÔºå‰Ω†ÂíåTaÂêÑËá™ÁöÑÂèçÂ∫î„ÄÇ
2. **ËØ∑ÈáçÁÇπ‰ΩìÁé∞Áî®Êà∑ËæìÂÖ•ÁöÑÂèçÂ∫î**ÔºåÂπ∂ÊèèÂÜôËßíËâ≤ÂØπÊ≠§ÁöÑÂõûÂ∫î„ÄÇ
3. Ê∞õÂõ¥ÔºöÁîúËúú„ÄÅÈò≥ÂÖâ„ÄÅ‰ª§‰∫∫ÂøÉÂä®„ÄÇ
`;

    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üèñÔ∏è ÂÅ∂ÈÅá ¬∑ ${friend.name}`, story);
        alert(`üíå ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ`);
    });
}
async function generateStoreShopping(item, userExtra) {
    showRpgLoading(`Ê≠£Âú®Ë¥ßÊû∂Ââç...`);
    
    const context = await getRpgContext();
    if(!context) return;

    // üî• ËûçÂêàÈÄªËæë
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÁîüÊ¥ªËßÇÂØüÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºö‰æøÂà©Â∫ó„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑Ê≠£Âú®Ë¥ßÊû∂ÂâçÊåëÈÄâ„Äê${item.name}„Äë„ÄÇ
„ÄêÁî®Êà∑ÂÖ∑‰ΩìÊÉ≥‰π∞/ÂÅöÁöÑ„ÄëÔºö${userExtra || "ÔºàÈöèÊÑèÊµèËßàÔºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ 150-200 Â≠óÁöÑÁâáÊÆµ„ÄÇ
1. ÊèèÂÜôÊåëÈÄâÂïÜÂìÅÁöÑËøáÁ®ã„ÄÇÂ¶ÇÊûúÁî®Êà∑ÊåáÂÆö‰∫ÜË¶Å‰π∞‰ªÄ‰πàÔºåËØ∑Âõ¥ÁªïËØ•Áâ©ÂìÅÂ±ïÂºÄ„ÄÇ
2. ËßíËâ≤ÔºàTaÔºâÁªôÂá∫‰∫Ü‰ªÄ‰πàÂª∫ËÆÆÔºüÊàñËÄÖTaÂÅ∑ÂÅ∑ÂæÄÁØÆÂ≠êÈáåÊîæ‰∫Ü‰ªÄ‰πàÔºü
3. ÁªìË¥¶Êó∂ÁöÑÂ∞èÊèíÊõ≤„ÄÇ
`;

    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üè™ Ë¥≠Áâ© ¬∑ ${item.name}`, story);
        alert(`üõí ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ`);
    });
}

// --- ËæÖÂä©ÂáΩÊï∞ÔºöAPI Ë∞ÉÁî®‰∏éÂ≠òÂÇ® ---

function showRpgLoading(text) {
    const list = document.getElementById('rpg-history-list');
    const div = document.createElement('div');
    div.id = 'rpg-temp-loading';
    div.className = 'morandi-card';
    div.innerHTML = `<div class="skeleton-text">${text}</div>`;
    list.prepend(div);
}

async function getRpgContext() {
    const wb = window.BIG_MEMORY.world_book || {};
    const global = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; } catch(e){}
    }
    
    if(!apiKey) {
        const loading = document.getElementById('rpg-temp-loading');
        if(loading) loading.remove();
        alert("‚ùå ËØ∑ÂÖàÈÖçÁΩÆ API KeyÔºÅ");
        return null;
    }
    
    return { global, apiKey };
}

async function callRpgApi(prompt, ctx, callback) {
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ctx.apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a creative writer."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content;
        
        // ÁßªÈô§ loading
        const loading = document.getElementById('rpg-temp-loading');
        if(loading) loading.remove();
        
        callback(story);

    } catch(e) {
        console.error(e);
        const loading = document.getElementById('rpg-temp-loading');
        if(loading) loading.innerHTML = `<span style="color:red">ÁîüÊàêÂ§±Ë¥•: ${e.message}</span>`;
    }
}

// Áªü‰∏Ä‰øùÂ≠òÂáΩÊï∞ (Êó†ÈôêÂ≠òÂÇ®)
function saveRpgStory(title, text) {
    if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
    if(!window.BIG_MEMORY.rpg_data.history) window.BIG_MEMORY.rpg_data.history = [];

    window.BIG_MEMORY.rpg_data.history.unshift({
        date: Date.now(),
        item: title,
        text: text
    });
    
    // ÈôêÂà∂Êï∞ÈáèÂπ∂‰øùÂ≠ò
    if(window.BIG_MEMORY.rpg_data.history.length > 50) window.BIG_MEMORY.rpg_data.history.pop();
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    
    // Âà∑Êñ∞ÂàóË°®
    renderRpgHistory();
}
// 5. Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï (‰æßËæπÊ†è)
function renderRpgHistory() {
    const data = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const con = document.getElementById('rpg-history-list');
    con.innerHTML = '';
    
    if(!data || data.length === 0) {
        con.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">ÊöÇÊó†ÊïÖ‰∫ãÔºåÂø´ÂéªÁÇπÂáªÊàøÈó¥ÈáåÁöÑÁâ©ÂìÅÂêß~</div>';
        return;
    }

    data.forEach((h, i) => {
        con.innerHTML += `
        <div class="morandi-card" style="padding:10px; margin-bottom:10px; background:#fff;">
            <div style="font-size:0.8rem;color:#888; border-bottom:1px dashed #eee; margin-bottom:5px;">
                ${new Date(h.date).toLocaleString()} [${h.item}]
            </div>
            <div style="font-size:0.9rem; line-height:1.5;">${h.text}</div>
            <button class="m-btn small" onclick="deleteRpgHistory(${i})" style="color:red;margin-top:8px;width:100%;background:#ffcdd2;">Âà†Èô§</button>
        </div>`;
    });
}

// 6. Âà†Èô§ÊïÖ‰∫ã
function deleteRpgHistory(index) {
    if(!confirm("Âà†Èô§ËøôÊÆµÂõûÂøÜÔºü")) return;
    window.BIG_MEMORY.rpg_data.history.splice(index, 1);
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    renderRpgHistory();
}

// 7. Ê∏≤ÊüìÂØπËØùÂéÜÂè≤ (ÊµÆÁ™ó)
function renderRpgChatList() {
    const list = document.getElementById('rpg-chat-list');
    const data = (window.BIG_MEMORY.rpg_data && window.BIG_MEMORY.rpg_data.chat_history) ? window.BIG_MEMORY.rpg_data.chat_history : [];
    
    list.innerHTML = '';
    data.forEach(msg => {
        const div = document.createElement('div');
        div.className = `rpg-chat-bubble ${msg.role}`; 
        // class .me Âíå .char Â∑≤ÁªèÂú®‰Ω†ÁöÑ CSS ÈáåÂÆö‰πâ‰∫Ü
        div.innerHTML = msg.text;
        list.appendChild(div);
    });
    // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
    const box = document.getElementById('rpg-chat-history-box');
    if(box) box.scrollTop = box.scrollHeight;
}

// 8. Ê∏ÖÁ©∫ÂØπËØù
function clearRpgChatHistory() {
    if(!confirm("Ê∏ÖÁ©∫ÂØπËØùËÆ∞ÂΩïÔºü")) return;
    window.BIG_MEMORY.rpg_data.chat_history = [];
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    renderRpgChatList();
}
// === üöó RPG Êñ∞Â¢ûÈÄªËæëÔºöÂºÄËΩ¶‰∏é‰æøÂà©Â∫ó ===

// 1. ÊòæÁ§∫Â§ñÂá∫ÈÄâÈ°π
function showTravelOptions() {
    closeRpgDialog();
    document.getElementById('rpg-travel-modal').style.display = 'block';
}

function closeTravelModal() {
    document.getElementById('rpg-travel-modal').style.display = 'none';
}

// 2. ÂºÄÂßãÂºÄËΩ¶ÂéªÊüêÂú∞
function startDrivingTo(destination) {
    closeTravelModal();
    playDrivingAnimation('right', () => {
        switchScene(destination);
    });
}

// 3. ÂºÄËΩ¶ÂõûÂÆ∂
function startDrivingHome() {
    closeRpgDialog();
    playDrivingAnimation('left', () => {
        switchScene('room');
    });
}

// 4. Êí≠ÊîæÂºÄËΩ¶Âä®Áîª (direction: 'left' or 'right')
function playDrivingAnimation(direction, callback) {
    const layer = document.getElementById('rpg-driving-layer');
    const car = document.getElementById('rpg-car-sprite');
    
    layer.style.display = 'block'; // ÊòæÁ§∫È©¨Ë∑ØËÉåÊôØ
    
    // ÈáçÁΩÆÂä®Áîª
    car.classList.remove('car-drive-right', 'car-drive-left');
    void car.offsetWidth; // Ëß¶ÂèëÈáçÁªò
    
    // Ê∑ªÂä†Âä®ÁîªÁ±ª
    if (direction === 'right') {
        car.classList.add('car-drive-right'); // ‰ªéÂ∑¶ÂæÄÂè≥ (Âéª)
    } else {
        car.classList.add('car-drive-left');  // ‰ªéÂè≥ÂæÄÂ∑¶ (Âõû)
    }
    
    // 3ÁßíÂêéÁªìÊùüÂä®ÁîªÔºåÂàáÊç¢Âú∫ÊôØ
    setTimeout(() => {
        layer.style.display = 'none';
        if (callback) callback();
    }, 3000);
}

// 5. ÁîüÊàê‰æøÂà©Â∫óË¥≠Áâ©ÂâßÊÉÖ (Êó†ÈôêÂ≠òÂÇ®ÊîØÊåÅ)
async function generateStoreShopping(item) {
    // UI ÊèêÁ§∫
    const storyList = document.getElementById('rpg-history-list');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'morandi-card';
    const itemName = item.name.replace('Ë¥ßÊû∂',''); 
    loadingDiv.innerHTML = `<div class="skeleton-text">Ê≠£Âú®ÊåëÈÄâ${itemName}...</div>`;
    storyList.prepend(loadingDiv);

    // ÂáÜÂ§áÊï∞ÊçÆ
    const wb = window.getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { 
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){} 
    }
    if(!apiKey) { loadingDiv.remove(); return alert("ËØ∑ÈÖçÁΩÆ API Key"); }

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Â∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÂú∫ÊôØ„ÄëÔºöÊ∑±Â§ú‰æøÂà©Â∫ó„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑Ê≠£Âú®Ë¥ßÊû∂ÂâçÊåëÈÄâ„Äê${itemName}„Äë„ÄÇ

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ 100-200 Â≠óÁöÑÁîüÊ¥ªÂåñÁâáÊÆµ„ÄÇ
ÊèèÂÜôÁî®Êà∑ÊåëÈÄâÂïÜÂìÅÁöÑËøáÁ®ãÔºåÊàñËÄÖÁúãÂà∞Êüê‰∏™ÂïÜÂìÅÊÉ≥Ëµ∑‰∫ÜË∞ÅÔºàËßíËâ≤Ôºâ„ÄÇ
ÊúÄÂêéÊèèÂÜôÁî®Êà∑‰π∞‰∏ã‰∫Ü‰ªÄ‰πàÔºåÂøÉÊÉÖÂ¶Ç‰Ωï„ÄÇ
È£éÊ†ºÔºöÊ∏©È¶®„ÄÅÊ≤ªÊÑà„ÄÅÂÖÖÊª°ÁÉüÁÅ´Ê∞î„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a creative writer."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content;

        // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
        if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
        if(!window.BIG_MEMORY.rpg_data.history) window.BIG_MEMORY.rpg_data.history = [];

        window.BIG_MEMORY.rpg_data.history.unshift({
            date: Date.now(),
            text: story,
            item: `Ë¥≠‰π∞ ¬∑ ${itemName}`
        });
        
        saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
        
        loadingDiv.remove();
        renderRpgHistory(); // Âà∑Êñ∞‰æßËæπÊ†è
        alert(`üõí ‰π∞‰∫Ü${itemName}ÔºÅÊïÖ‰∫ãÂ∑≤ÁîüÊàê„ÄÇ`);

    } catch(e) {
        console.error(e);
        loadingDiv.innerHTML = `<span style="color:red">ÁîüÊàêÂ§±Ë¥•</span>`;
    }
}
// === ‚òï ÂíñÂï°ÂéÖÂïÜÂ∫óÈÄªËæë ===
function openCafeShop() {
    document.getElementById('cafe-shop-modal').style.display = 'flex';
    const petData = window.BIG_MEMORY.pet_data || { inventory: { coins: 0 } };
    document.getElementById('cafe-coin-display').innerText = parseFloat(petData.inventory.coins).toFixed(2);
    
    const grid = document.getElementById('cafe-item-grid');
    grid.innerHTML = '';
    
    RPG_ASSETS.cafe_items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'pet-item-card';
        div.innerHTML = `
            <img src="${item.img}" class="pet-item-img">
            <div style="font-size:0.7rem; margin-top:5px;">${item.name}</div>
            <button class="m-btn small" onclick="buyCafeItem('${item.name}')" style="width:100%; margin-top:5px; background:#d7ccc8; color:#fff;">1 ÁßØÂàÜ</button>
        `;
        grid.appendChild(div);
    });
}

function buyCafeItem(itemName) {
    const petData = window.BIG_MEMORY.pet_data;
    if (!petData || petData.inventory.coins < 1) {
        return alert("ÁßØÂàÜ‰∏çË∂≥ÔºÅËØ∑ÂéªÁÖßÈ°æÂÆ†Áâ©ËµöÂèñÁßØÂàÜ„ÄÇ");
    }
    
    if(confirm(`Ëä±Ë¥π 1 ÁßØÂàÜË¥≠‰π∞„Äê${itemName}„ÄëÂπ∂‰∏ÄËµ∑‰∫´Áî®ÂêóÔºü`)) {
        petData.inventory.coins -= 1;
        window.savePetData(petData);
        document.getElementById('cafe-coin-display').innerText = parseFloat(petData.inventory.coins).toFixed(2);
        
        document.getElementById('cafe-shop-modal').style.display = 'none';
        generatePixelStory(`ÂíåËßíËâ≤‰∏ÄËµ∑ÂêÉ${itemName}Ôºå‰∫´ÂèóÁæéÂë≥ÁöÑ‰∏ãÂçàËå∂Êó∂ÂÖâ`);
    }
}

// === üìù ÈÄöÁî®ÂÉèÁ¥†ÂâßÊÉÖÁîüÊàêÂô® (300Â≠ó+) ===
async function generatePixelStory(promptText, isR18 = false, userExtra = "") {
    alert(`‚è≥ Ê≠£Âú®ÁîüÊàêÂâßÊÉÖ...\n‰∏ªÈ¢ò: ${promptText.substring(0,10)}...`);
    
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const pixelCtx = (wb['20.ÂÉèÁ¥†Â∞èÂ±ã'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    if(!apiKey) { try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; } catch(e){} }
    if(!apiKey) return alert("ËØ∑ÈÖçÁΩÆ API Key");

    let extraInstruction = isR18 ? 
        "„ÄêÁâπÊÆäÊ®°Âºè„ÄëÔºöËøôÊòØÁßÅÂØÜ‰∫íÂä®„ÄÇËØ∑ÊèèÂÜô‰∏§‰∫∫‰πãÈó¥ÊûÅÂ∫¶‰∫≤ÂØÜ„ÄÅÁîöËá≥Â∏¶ÊúâÊÉÖËâ≤Âº†ÂäõÁöÑ‰∫íÂä®„ÄÇ" : 
        "ËØ∑ÂÜô‰∏ÄÊÆµÊ∏©È¶®„ÄÅÊ≤ªÊÑà„ÄÅÂÖÖÊª°ÁîüÊ¥ªÊ∞îÊÅØÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ";

    // üî• ËûçÂêàÈÄªËæëÔºöÂ∞ÜÂéüÊù•ÁöÑ promptText Âíå userExtra Âπ∂Âàó
    const fullPrompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÁªÜËÖªÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÂú∫ÊôØËÆæÂÆö„ÄëÔºö${pixelCtx}

„ÄêÂΩìÂâçÊÉÖÂ¢É„ÄëÔºö
1. **Âü∫Á°Ä‰∫ã‰ª∂**Ôºö${promptText}
2. **Áî®Êà∑ÂÖ∑‰ΩìÂä®‰Ωú**Ôºö${userExtra || "Êó†ÔºàÈ°∫ÂÖ∂Ëá™ÁÑ∂Ôºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑Ê†πÊçÆ‰∏äËø∞ËÆæÂÆöÔºåÂÜô‰∏ÄÊÆµ**‰∏çÂ∞ë‰∫é 400 Â≠ó**ÁöÑÂâßÊÉÖ„ÄÇ
**ËØ∑Â∞Ü„ÄêÂü∫Á°Ä‰∫ã‰ª∂„ÄëÂíå„ÄêÁî®Êà∑Âä®‰Ωú„ÄëËá™ÁÑ∂Âú∞ËûçÂêàÂú®‰∏ÄËµ∑**„ÄÇ
${extraInstruction}
ËßÜËßíÔºöÁ¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚Äù„ÄÇ
ËØ∑Áõ¥Êé•ËæìÂá∫Ê≠£Êñá„ÄÇ
`;

    try {
        let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
        let model = document.getElementById('model-select').value || "gpt-3.5-turbo";

        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a creative writer."}, {role:"user", content:fullPrompt}],
                temperature: 0.85,
                max_tokens: 5000
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content;
        
        saveRpgStory(`ÂÉèÁ¥†Êó•Â∏∏`, story);
        alert("‚ú® ÂâßÊÉÖÂ∑≤ÁîüÊàêÔºÅ\nËØ∑Âéª„ÄêÊïÖ‰∫ãÈõÜ„ÄëÈáåÁøªÈòÖ„ÄÇ");

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    }
}
</script>
<!-- === RPG ‰∏ìÁî®Áã¨Á´ãÁâåÊ°å (ÂäüËÉΩÂ§çÂàªÁâàÔºöÊó†ÈôêÂ≠òÂÇ® + 114Âº†ÂÖ®ÁâåÂ∫ì) === -->
<div id="rpg-card-table-modal" class="modal-overlay" style="background: rgba(10, 10, 20, 0.95); backdrop-filter: blur(5px);">
    <div id="rpg-card-table-desk" style="width: 100%; height: 100%; position: relative; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px;">
        <div id="rpg-card-area" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; perspective: 1000px;">
            <!-- Âç°ÁâåÂ∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        
        <div class="card-table-ui">
            <div style="color:#fdcb6e; text-shadow:0 1px 5px #000; font-size:1.1rem; font-weight:bold;">
                ËØ∑ÊäΩÂèñËÉΩÂ§üÂÜ≥ÂÆöÂØπËØùËµ∞ÂêëÁöÑÁâå... (<span id="rpg-flipped-count">0</span>)
            </div>
            <button class="m-btn primary" onclick="finishRpgChat()" style="background:#e17055; border:1px solid #fab1a0; color:white; box-shadow:0 0 15px rgba(225, 112, 85, 0.4);">
                üó£Ô∏è Á°ÆËÆ§ÁâåÊÑèÂπ∂ÁîüÊàêÂõûÂ§ç
            </button>
            <button class="m-btn secondary" onclick="document.getElementById('rpg-card-table-modal').style.display='none'" style="background:rgba(255,255,255,0.2); color:white;">
                ÂèñÊ∂à
            </button>
        </div>
    </div>
</div>
<script>
// ==================== üõ†Ô∏è RPG Á≥ªÁªüÁªàÊûÅ‰øÆÂ§çË°•‰∏Å (Êó†ÈôêÂ≠òÂÇ® + Ê≤âÊµ∏ÂØπËØù) ====================

let rpgTypewriterTimer = null;

// 1. ÊâìÂºÄÂØπËØùÊ®°ÂºèÔºöÂàùÂßãÂåñÁä∂ÊÄÅ
window.openRpgChatMode = function() {
    document.getElementById('rpg-chat-modal').style.display = 'flex';
    
    // ËÉåÊôØÂ§ÑÁêÜÔºöÂ§çÂà∂ÂΩìÂâçÂú∫ÊôØ‰Ωú‰∏∫ËÉåÊôØÔºåËß£ÂÜ≥ÁôΩÂ±è
    const bgContainer = document.getElementById('rpg-chat-bg-container');
    bgContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÁöÑ
    
    // ÊîæÂÖ•ËÉåÊôØÂõæ
    const bgSrc = rpgState.currentScene === 'room' ? RPG_ASSETS.bg_room : RPG_ASSETS.bg_outside;
    bgContainer.style.backgroundImage = `url(${bgSrc})`;
    bgContainer.style.backgroundSize = 'cover';
    
    // Â¶ÇÊûúÊòØÊàøÈó¥ÔºåÊîæÂÖ•Âú∞Êùø
    if(rpgState.currentScene === 'room') {
        const floor = document.createElement('img');
        floor.src = RPG_ASSETS.collision_map;
        floor.style.cssText = "position:absolute; top:0; left:0; width:100%; height:100%; object-fit:fill;";
        bgContainer.appendChild(floor);
    }
    // Â§çÂà∂ÂÆ∂ÂÖ∑Â±Ç
    const cloneDecor = document.getElementById('rpg-decor-layer').cloneNode(true);
    bgContainer.appendChild(cloneDecor);

    // ËÆæÁΩÆÁ´ãÁªò
    document.getElementById('rpg-chat-npc-img').src = RPG_SKINS.npc_idle || RPG_ASSETS.char_gifs.idle;
    document.getElementById('rpg-chat-user-img').src = RPG_SKINS.user_idle || RPG_ASSETS.char_gifs.idle;

    // üî• ÂÖ≥ÈîÆÔºöÂàùÂßãÁä∂ÊÄÅ -> ÊòæÁ§∫ËæìÂÖ•Ê°ÜÔºåÊòæÁ§∫"Êàë"ÁöÑÁ´ãÁªòÔºåÈöêËóèNPC
    resetRpgChatInput();
    renderRpgChatList();
};

// 2. ÂàáÊç¢ËßÜËßâÁä∂ÊÄÅ (ÊéßÂà∂Ë∞ÅÂú®ËØ¥ËØùÔºåÊòæÁ§∫Ë∞ÅÁöÑÁ´ãÁªò)
// ÂàáÊç¢ËßÜËßâÁä∂ÊÄÅ (ÊéßÂà∂Ë∞ÅÂú®ËØ¥ËØùÔºåÊòæÁ§∫Ë∞ÅÁöÑÁ´ãÁªò + ÂàáÊç¢Â∫ïÈÉ®ÁõíÂ≠ê)
function toggleSpeaker(who) {
    const npcImg = document.getElementById('rpg-chat-npc-img');
    const userImg = document.getElementById('rpg-chat-user-img');
    const inputMode = document.getElementById('rpg-input-mode');
    const displayMode = document.getElementById('rpg-display-mode');

    if (who === 'me') {
        // ËΩÆÂà∞ÊàëÔºöÊòæÁ§∫ÊàëÔºåÈöêËóè‰ªñÔºåÊòæÁ§∫ËæìÂÖ•Ê°ÜÔºåÈöêËóèÂõûÂ§çÊ°Ü
        if(npcImg) npcImg.style.display = 'none';
        if(userImg) userImg.style.display = 'block';
        
        if(inputMode) inputMode.style.display = 'block';
        if(displayMode) displayMode.style.display = 'none';
    } else {
        // ËΩÆÂà∞‰ªñÔºöÊòæÁ§∫‰ªñÔºåÈöêËóèÊàëÔºåÈöêËóèËæìÂÖ•Ê°ÜÔºåÊòæÁ§∫ÂõûÂ§çÊ°Ü (Âú®Âêå‰∏Ä‰ΩçÁΩÆ)
        if(npcImg) npcImg.style.display = 'block';
        if(userImg) userImg.style.display = 'none';
        
        if(inputMode) inputMode.style.display = 'none';
        if(displayMode) displayMode.style.display = 'block'; // ËøôÈáåÁöÑ block ÈÖçÂêà CSS ÈáåÁöÑÊ†∑Âºè
    }
}
// === üî• ÂøÖÈ°ªË°•‰∏äËøô‰∏™ÂáΩÊï∞ÔºåÂê¶Âàô‰ºöÊä•Èîô ===
function toggleSpeaker(who) {
    const npcImg = document.getElementById('rpg-chat-npc-img');
    const userImg = document.getElementById('rpg-chat-user-img');
    const inputMode = document.getElementById('rpg-input-mode');
    const displayMode = document.getElementById('rpg-display-mode');

    if (who === 'me') {
        // ËΩÆÂà∞ÊàëÔºöÊòæÁ§∫ÊàëÔºåÈöêËóè‰ªñÔºåÊòæÁ§∫ËæìÂÖ•Ê°ÜÔºåÈöêËóèÂõûÂ§çÊ°Ü
        if(npcImg) npcImg.style.display = 'none';
        if(userImg) userImg.style.display = 'block';
        
        if(inputMode) inputMode.style.display = 'block';
        if(displayMode) displayMode.style.display = 'none';
    } else {
        // ËΩÆÂà∞‰ªñÔºöÊòæÁ§∫‰ªñÔºåÈöêËóèÊàëÔºåÈöêËóèËæìÂÖ•Ê°ÜÔºåÊòæÁ§∫ÂõûÂ§çÊ°Ü (Âú®Âêå‰∏Ä‰ΩçÁΩÆ)
        if(npcImg) npcImg.style.display = 'block';
        if(userImg) userImg.style.display = 'none';
        
        if(inputMode) inputMode.style.display = 'none';
        if(displayMode) displayMode.style.display = 'block';
    }
}
// 3. ÈáçÁΩÆÂõûËæìÂÖ•Áä∂ÊÄÅ (ÁÇπÂáªÊñáÊú¨Ê°ÜÂêéËß¶Âèë)
window.resetRpgChatInput = function() {
    if(rpgTypewriterTimer) clearInterval(rpgTypewriterTimer);
    document.getElementById('rpg-chat-input').value = ''; 
    toggleSpeaker('me'); // ÂàáÊç¢Âõû"Êàë"ÁöÑËßÜËßí
};

function playRpgTypewriter(text) {
    const el = document.getElementById('rpg-typewriter-text');
    el.innerHTML = '';
    let i = 0;
    if(window.rpgTypewriterTimer) clearInterval(window.rpgTypewriterTimer);
    
    window.rpgTypewriterTimer = setInterval(() => {
        el.innerText += text.charAt(i); 
        i++;
        if(i >= text.length) clearInterval(window.rpgTypewriterTimer);
    }, 50); 
}
// ==================== üõ†Ô∏è RPG Ê†∏ÂøÉÈÄªËæë (Â∑≤‰øÆÂ§çÔºöËØªÂèñ‰º†ËÆØ + ÂàáÊç¢UI) ====================

window.finishRpgChat = async function() {
    // 1. Ê†°È™åÊòØÂê¶ÁøªÁâå
    if(rpgFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºÅ");
    
    // 2. Ëé∑ÂèñÁî®Êà∑ÂàöÊâçÁöÑËæìÂÖ•
    const userInput = document.getElementById('rpg-chat-input').value;
    const btn = document.querySelector('#rpg-card-table-modal .primary');
    const oldText = btn.innerText;
    
    // 3. UI ÈîÅÂÆöÁä∂ÊÄÅ
    btn.innerText = "‚è≥ Ê≠£Âú®ËøûÊé• Ta ÁöÑÊΩúÊÑèËØÜ..."; btn.disabled = true;

    // 4. ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = rpgFlippedCards.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    
    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êï∞ÊçÆ
    const wb = window.getWBData(); 
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // üî•„ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëËøôÈáåÊîπÊàêËØªÂèñ '5.‰º†ËÆØ'
    const msgCtx = (wb['5.‰º†ËÆØ'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    // Ëé∑Âèñ API Key
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) { btn.innerText = oldText; btn.disabled = false; return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key"); }

    // 5. ÊûÑÂª∫ÊèêÁ§∫ËØç
    const prompt = `
‰Ω†Áé∞Âú®Ê≠£Âú®ÂíåÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑ‰∫≤ÂØÜÂØπËØù„ÄÇ
„ÄêËßíËâ≤ËÆæÂÆö„ÄëÔºö${globalCtx}
„Äê‰º†ËÆØ/Áü≠‰ø°È£éÊ†ºËÆæÂÆö„ÄëÔºö${msgCtx} 
„ÄêÊÉÖÂ¢É„ÄëÔºöÁî®Êà∑ËØ¥Ôºö"${userInput}"
„ÄêÂëΩËøêÂç°Áâå„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÁªìÂêàÁâåÊÑèÂíåËßíËâ≤ÊÄßÊ†ºÔºåÁªôÁî®Êà∑‰∏Ä‰∏™ÂõûÂ§ç„ÄÇ
Â∞ÜÁâåÈù¢ÁöÑËÉΩÈáèËΩ¨Âåñ‰∏∫ËßíËâ≤ÁöÑÊÉÖÁª™ÂíåÊΩúÂè∞ËØç„ÄÇ
**Â≠óÊï∞ÈôêÂà∂Ôºö3-4Âè•ËØù„ÄÇ**
Áõ¥Êé•ËæìÂá∫ÂõûÂ§çÂÜÖÂÆπ„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a roleplay character."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const reply = json.choices[0].message.content.trim();

        // === Êï∞ÊçÆ‰øùÂ≠òÈÄªËæë (Êó†ÈôêÂ≠òÂÇ®) ===
        if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
        if(!window.BIG_MEMORY.rpg_data.chat_history) window.BIG_MEMORY.rpg_data.chat_history = [];
        
        // Â≠òÂÖ•ËÅäÂ§©Ê∞îÊ≥°
        window.BIG_MEMORY.rpg_data.chat_history.push({ role: 'me', text: userInput });
        window.BIG_MEMORY.rpg_data.chat_history.push({ role: 'char', text: reply + ` <span style="font-size:0.6rem;opacity:0.5;">(üîÆ${cardsDesc})</span>` });
        
        // Â≠òÂÖ•ÊïÖ‰∫ãÈõÜ
        if(!window.BIG_MEMORY.rpg_data.history) window.BIG_MEMORY.rpg_data.history = [];
        window.BIG_MEMORY.rpg_data.history.unshift({
            date: Date.now(),
            item: "ÂØπËØù ¬∑ ÂëΩËøêÁâå",
            text: `„ÄêÊàë„Äë${userInput}\n„ÄêTa„Äë${reply}\n\nüîÆ ÁâåÊÑèÊåáÂºïÔºö${cardsDesc}`
        });

        if(window.BIG_MEMORY.rpg_data.history.length > 50) window.BIG_MEMORY.rpg_data.history.pop();
        window.saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
document.getElementById('rpg-card-table-modal').style.display = 'none'; 
        const chatModal = document.getElementById('rpg-chat-modal');
        chatModal.style.display = 'flex';
        chatModal.style.zIndex = '3000'; 
        toggleSpeaker('npc'); 
        playRpgTypewriter(reply);
        renderRpgChatList();

    } catch(e) {
        console.error(e);
        alert("ÂõûÂ§çÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};
window.toggleRpgHistory = function() {
    const panel = document.getElementById('rpg-history-panel');
    panel.classList.toggle('open');
    if(panel.classList.contains('open')) {
        renderRpgHistory();
    }
};
window.renderRpgHistory = function() {
    const data = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const con = document.getElementById('rpg-history-list');
    con.innerHTML = '';
    
    if(!data || data.length === 0) {
        con.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">ÊöÇÊó†Êó•ËÆ∞<br>ÂéªÂíåTaÂØπËØùÊàñÁÇπÂáªÂÆ∂ÂÖ∑ÁîüÊàêÊïÖ‰∫ãÂêß~</div>';
        return;
    }

    data.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'rpg-diary-entry'; 
        const dateObj = new Date(h.date);
        const dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;

        div.innerHTML = `
            <div class="rpg-diary-date">${dateStr} ¬∑ ${h.item || 'ÈöèÁ¨î'}</div>
            <div class="rpg-diary-text">${h.text}</div>
            <div class="rpg-diary-del" onclick="deleteRpgHistory(${i})">ÊíïÊéâËøô‰∏ÄÈ°µ</div>
        `;
        con.appendChild(div);
    });
};

window.deleteRpgHistory = function(index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊÆµÂõûÂøÜÂêóÔºü")) return;
    window.BIG_MEMORY.rpg_data.history.splice(index, 1);
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    renderRpgHistory();
};
</script>
  <script>
// ============================================================
// ü¶Ñ Ê¢¶App ÊäΩÁâåÊ°åÂ±ÇÁ∫ß‰øÆÂ§çË°•‰∏Å
// Ëß£ÂÜ≥ÁÇπÂáª‚ÄúÂºÄÂßãÊäΩÁâå‚ÄùÂêéÁâåÊ°å‰∏çÊòæÁ§∫ÔºàË¢´ÈÅÆÊå°ÔºâÁöÑÈóÆÈ¢ò
// ============================================================

window.startDreamDrawing = function() {
    const modal = document.getElementById('dream-card-table-modal');
    const area = document.getElementById('dream-card-area');
    
    // üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂Â∞ÜÁâåÊ°åÂ±ÇÁ∫ßËÆæ‰∏∫ÊúÄÈ´ò (30000)ÔºåÁ°Æ‰øùÊµÆÂú®ÊâÄÊúâÁ™óÂè£‰πã‰∏ä
    modal.style.zIndex = "30000"; 
    
    // --- ‰ª•‰∏ãÊòØÊ†áÂáÜÁöÑÂàùÂßãÂåñÈÄªËæë ---
    area.innerHTML = ''; 
    dreamActiveDeck = [];
    dreamFlippedCards = []; // Á°Æ‰øù‰ΩøÁî®Ê≠£Á°ÆÁöÑÂÖ®Â±ÄÂèòÈáè
    
    if(document.getElementById('dream-flipped-count')) {
        document.getElementById('dream-flipped-count').innerText = '0';
    }

    // ÁîüÊàêÂÆåÊï¥ÁâåÂ∫ì (78Âº†Â°îÁΩó + 36Âº†Èõ∑ËØ∫Êõº)
    for(let i=0; i<=77; i++) dreamActiveDeck.push({ type: 'tarot', id: i, isReversed: Math.random() < 0.3 }); 
    for(let i=1; i<=36; i++) dreamActiveDeck.push({ type: 'lenormand', id: i, isReversed: false }); 
    
    // Ê¥óÁâå
    dreamActiveDeck.sort(() => Math.random() - 0.5);
    
    // ËÆ°ÁÆóÂ∏ÉÂ±Ä
    const deskW = window.innerWidth;
    const cardWidth = 60, cardHeight = 90, gapX = 10, gapY = 15;       
    let columns = Math.floor((deskW - 20) / (cardWidth + gapX));
    if (columns < 4) columns = 4;
    
    const startX = Math.max(0, (deskW - (columns * cardWidth + (columns - 1) * gapX)) / 2);
    const startY = 60;

    // Ê∏≤ÊüìÂç°Áâå
    dreamActiveDeck.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'playing-card'; 
        
        const colIndex = index % columns;
        const rowIndex = Math.floor(index / columns);
        
        el.style.left = (startX + colIndex * (cardWidth + gapX)) + 'px';
        el.style.top = (startY + rowIndex * (cardHeight + gapY)) + 'px';
        el.style.transform = `rotate(${Math.random() * 6 - 3}deg)`; 
        
        // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂ (Á°Æ‰øùË∞ÉÁî®ÂÖ®Â±ÄÁöÑ flipDreamCard)
        el.onclick = () => flipDreamCard(el, card);
        
        const front = document.createElement('div');
        front.className = 'playing-card-front';
        el.appendChild(front);
        
        area.appendChild(el);
    });
    
    // ËÆæÁΩÆÂå∫ÂüüÈ´òÂ∫¶ÔºåÈò≤Ê≠¢Â∫ïÈÉ®ÂàáÊñ≠
    const totalRows = Math.ceil(dreamActiveDeck.length / columns);
    area.style.height = (startY + totalRows * (cardHeight + gapY) + 120) + 'px';

    // ÊòæÁ§∫ÂºπÁ™ó
    modal.style.display = 'flex';
};

// Á°Æ‰øùÁøªÁâåÂáΩÊï∞Â≠òÂú®‰∏îÂèòÈáèÊ≠£Á°Æ
window.flipDreamCard = async function(el, cardData) {
    if(el.classList.contains('flipped')) {
        el.classList.remove('flipped');
        dreamFlippedCards = dreamFlippedCards.filter(c => !(c.type === cardData.type && c.id === cardData.id));
        setTimeout(() => {
            const frontEl = el.querySelector('.playing-card-front');
            if(frontEl) { frontEl.style.backgroundImage = ''; frontEl.innerText = ''; frontEl.style.transform = ''; }
        }, 300);
    } else {
        el.classList.add('flipped');
        dreamFlippedCards.push(cardData);
        
        const dbName = cardData.type === 'tarot' ? 'tarot_deck' : 'lenormand_deck';
        try {
            if (typeof idb !== 'undefined') {
                const item = await idb.get(dbName, cardData.id);
                const frontEl = el.querySelector('.playing-card-front');
                if (item && item.data) {
                    frontEl.style.backgroundImage = `url(${item.data})`;
                    frontEl.innerText = '';
                } else {
                    frontEl.style.backgroundColor = '#ddd';
                    frontEl.innerText = cardData.id;
                }
                
                // Â§ÑÁêÜÈÄÜ‰Ωç
                if(cardData.type === 'tarot' && cardData.isReversed) {
                    frontEl.style.transform = "rotateY(180deg) rotate(180deg)"; 
                } else {
                    frontEl.style.transform = "rotateY(180deg)";
                }
            }
        } catch(e) {}
    }
    if(document.getElementById('dream-flipped-count')) {
        document.getElementById('dream-flipped-count').innerText = dreamFlippedCards.length;
    }
};
console.log("‚úÖ Ê¢¶APP ÊäΩÁâåÊ°åÂ±ÇÁ∫ß‰øÆÂ§çÂ∑≤Âä†ËΩΩ");
</script>
<!-- ================== Êñ∞Âπ¥ÈôêÊó∂ÂÖ¨Âëä‰ª£Á†Å START ================== -->
<script>
(function() {
    // --- 1. Êó∂Èó¥ÊéßÂà∂Ôºö17Âè∑Âèä‰ª•Âêé‰∏çÂÜçÊòæÁ§∫ ---
    // Ëé∑ÂèñÂΩìÂâçÊó•Êúü
    var now = new Date();
    var date = now.getDate(); // Ëé∑ÂèñÂá†Âè∑
    // Â¶ÇÊûú‰ªäÂ§©ÊòØ17Âè∑ÊàñÊõ¥Â§ßÔºåÁõ¥Êé•ÈÄÄÂá∫Ôºå‰∏çÊòæÁ§∫
    if (date >= 17) return;

    // --- 2. ÂîØ‰∏ÄÊÄßÊéßÂà∂ÔºöÊú¨Âú∞Â∑≤ËØªËøáÂàô‰∏çÊòæÁ§∫ ---
    var storageKey = "ganmei_newyear_2025_read"; 
    if (localStorage.getItem(storageKey)) return;

    // --- 3. Ê†∑ÂºèÂÆö‰πâ ---
    var overlayStyle = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; display:flex; align-items:center; justify-content:center; flex-direction:column; animation: fadeIn 0.3s;";
    var cardStyle = "background:#fff; width:85%; max-width:450px; padding:25px; border-radius:16px; box-shadow:0 0 30px rgba(0,0,0,0.5); font-family:sans-serif; position:relative; max-height:80vh; overflow-y:auto;";
    var btnStyle = "margin-top:20px; width:100%; padding:12px; border:none; background:#ff7675; color:white; border-radius:10px; font-weight:bold; font-size:1rem; cursor:pointer; transition:0.2s;";

    // --- Á¨¨‰∏ÄÊ≠•ÔºöÊòæÁ§∫Á•ùÁ¶èÂÖ¨Âëä ---
    function showGreeting() {
        var div = document.createElement('div');
        div.id = "gm-step1";
        div.style.cssText = overlayStyle;
        div.innerHTML = `
            <div style="${cardStyle} border: 2px solid #ff7675;">
                <h3 style="color:#d63031; margin-top:0; text-align:center;">üßß ËäÇÊó•Âø´‰πêÔºÅ</h3>
                <div style="font-size:0.95rem; line-height:1.6; color:#333; text-align:justify;">
                    <p>ÂæàÊÑüË∞¢Â§ßÂÆ∂ÂñúÊ¨¢ÁîòÊ¢ÖÂ∞èÊâãÊú∫‰πüÊÑøÊÑèÁé©ÁîòÊ¢ÖÂ∞èÊâãÊú∫ÔºåÂêÑ‰ΩçÂ∞èÁîòÊ¢ÖËäÇÊó•Âø´‰πêÔºÅÔºàÊôöÁÇπË¶Å‰∏äËØæËøôËæπÂ∞±Âè™ËÉΩÊèêÂâçÁ•ùÁ¶è‰∫ÜÔºâ</p>
                    <p>ÊâøËíôÂ§ßÂÆ∂ÁöÑÂñúÊ¨¢ÊÄª‰ºöÊÉ≥ÊòØ‰∏çÊòØËøòÊúâÂì™ÈáåÊ≤°ÂÅöÂà∞‰ΩçÊ≤°ÊúâÂÅöÂ•ΩÔºåÁúãÁùÄÂ§ßÂÆ∂ÁöÑÂñúÊ¨¢‰πüÊõ¥ÊúâÂä®ÂäõÂéªÊõ¥Êñ∞‰∫Ü„ÄÇ‰ªäÂ§©ËøòÊòØÊÉ≥ËØ¥ÂæàÊÑüË∞¢ÂêÑ‰ΩçÂ∞èÁîòÊ¢ÖÁöÑÂñúÊ¨¢Ôºå‰πüÂ∏åÊúõÂ∞èÁîòÊ¢Ö‰ª¨Êñ∞Âπ¥Âø´‰πêÔºÅ‰∫ã‰∫ãÈ°∫ÂøÉ‰∏á‰∫ãÂ¶ÇÊÑè„ÄÇ</p>
                    <p style="background:#fff0f6; padding:10px; border-radius:8px;">Ëøô‰∏™Á∫¢ÂåÖÊòØÊØèÊ¨°ÁúãÂà∞Â§ßÂÆ∂ÁöÑÂñúÊ¨¢Êàë‰πüÊÉ≥Â§ßÂÆ∂ÂºÄÂøÉ‰∫õÊâÄ‰ª•ÊÉ≥‰∏∫Â§ßÂÆ∂Êõ¥Âä†ÂÅö‰∫õ‰ªÄ‰πàÁöÑÊÉ≥Ê≥ïÔºå‰πüÈ∫ªÁÉ¶Â∞èÁîòÊ¢Ö‰ª¨ËØ∑‰∏çË¶ÅÊé®ËçêÁîòÊ¢ÖÁÇ∏Êú∫Ë∞¢Ë∞¢Â§ßÂÆ∂ÔºàÂõ†‰∏∫ÂèØËÉΩÂØºËá¥‰ºöÊúâ‰∏Ä‰∫õÂ∞èÁîòÊ¢ÖÊî∂‰∏çÂà∞Á≥ñÊûúÔºâÔºåËØ∑‰∏ÄÁõ¥‰ª•Êù•ÁÖßÈ°æÊàëÁöÑÂêÑ‰Ωç‰ª¨ÂêÉÂè£Êñ∞Âπ¥Âø´‰πêÁ≥ñ„ÄÇ</p>
                </div>
                <button id="gm-btn-ok" style="${btnStyle}">Á°ÆÂÆö</button>
            </div>
        `;
        document.body.appendChild(div);

        // ÁÇπÂáªÁ°ÆÂÆöÂêé
        document.getElementById('gm-btn-ok').onclick = function() {
            // Ê†áËÆ∞‰∏∫Â∑≤ËØªÔºå‰∏ãÊ¨°‰∏çÂÜçÊòæÁ§∫Á¨¨‰∏ÄÊ≠•
            localStorage.setItem(storageKey, "true");
            // ÁßªÈô§ÂΩìÂâçÂºπÁ™ó
            div.remove();
            // ËøõÂÖ•Á¨¨‰∫åÊ≠•
            showWarning();
        };
    }

    // --- Á¨¨‰∫åÊ≠•ÔºöÊòæÁ§∫‰øùÂØÜÊèêÁ§∫ (Âº∫Âà∂8Áßí) ---
    function showWarning() {
        var div = document.createElement('div');
        div.style.cssText = overlayStyle;
        div.innerHTML = `
            <div style="${cardStyle}">
                <h3 style="color:#e17055; margin-top:0; text-align:center;">ü§´ ÊÇÑÊÇÑËØù</h3>
                <div style="font-size:0.95rem; line-height:1.6; color:#333; text-align:justify;">
                    <p style="font-weight:bold;">ËØ∑Â§ßÂÆ∂Âõ†Ê≠§‰∏çË¶ÅÂÆ£‰º†ÁîòÊ¢ÖÁÇ∏Êú∫Ôºå‰πüËØ∑Â§ßÂÆ∂‰øùÂØÜËøôÈÉ®ÂàÜÂÜÖÂÆπÂõ†‰∏∫Âè™ÊòØÁ•ùÁ¶èÁöÑÊÉ≥Ê≥ïÊÉ≥ÊÑüË∞¢Â§ßÂÆ∂ËÄå‰∏çÊòØÊÉ≥Ë¶ÅË¢´Êé®Âπø‰πãÁ±ªÁöÑÔºåÂæàÊÑüË∞¢Â§ßÂÆ∂ÂñúÊ¨¢ÁîòÊ¢ÖÁÇ∏Êú∫„ÄÇ</p>
                    <p style="font-size:0.85rem; color:#666; margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;">
                        ÔºàÊàë‰πü‰∏çÂ∏åÊúõÈô§‰∫ÜÂ∞èÁîòÊ¢Ö‰ª¨ÁöÑ‰∫∫È¢ÜÂà∞Á≥ñÊûúËÄå‰∏îÂèØËÉΩ‰ºöËÆ©‰∏ÄÈÉ®ÂàÜÂ∞èÁîòÊ¢ÖÊ≤°Ê≥ïÈ¢ÜÂà∞Á≥ñÊûúÔºåÂõ†‰∏∫Â§ßÂÆ∂ÁöÑÂñúÊ¨¢ÔºåÊàëÊâçÊúâÂàõ‰ΩúÁöÑÂä®ÂäõÔºåÂ¶ÇÊûúÂèëÁé∞ÂºÇÂ∏∏Ë°å‰∏∫‰ºöÈ©¨‰∏äÂà†Èô§Ëøô‰∏™Âè£‰ª§ÂíåÂÖ¨ÂëäÔºâ
                    </p>
                </div>
                <button id="gm-btn-wait" style="${btnStyle}; background:#b2bec3; cursor:not-allowed;" disabled>
                    ËØ∑ËÆ§ÁúüÈòÖËØª (8s)
                </button>
            </div>
        `;
        document.body.appendChild(div);

        // ÂÄíËÆ°Êó∂ÈÄªËæë
        var timeLeft = 8;
        var btn = document.getElementById('gm-btn-wait');
        var timer = setInterval(function() {
            timeLeft--;
            btn.innerText = "ËØ∑ËÆ§ÁúüÈòÖËØª (" + timeLeft + "s)";
            if (timeLeft <= 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.innerText = "ÊàëÊòéÁôΩ‰∫Ü";
                btn.style.background = "#e17055";
                btn.style.cursor = "pointer";
            }
        }, 1000);

        btn.onclick = function() {
            div.remove();
            showImage();
        };
    }

    // --- Á¨¨‰∏âÊ≠•ÔºöÊòæÁ§∫ÂõæÁâá (10ÁßíËá™Âä®ÂÖ≥Èó≠) ---
    function showImage() {
        var div = document.createElement('div');
        // ËÉåÊôØËÆæ‰∏∫Ê∑±ÈªëËâ≤ÔºåÁ™ÅÂá∫ÂõæÁâá
        div.style.cssText = overlayStyle + "background:rgba(0,0,0,0.95);";
        div.innerHTML = `
            <img src="https://i.postimg.cc/bYLT92Yh/IMG-2372.png" 
                 style="max-width:95%; max-height:80vh; border-radius:8px; box-shadow:0 0 20px rgba(255,255,255,0.2); object-fit:contain;">
            <div style="color:white; margin-top:20px; font-weight:bold; font-size:1.1rem;">
                ÂõæÁâáÂ∞ÜÂú® <span id="img-timer" style="color:#ff7675;">10</span> ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            </div>
        `;
        document.body.appendChild(div);

        var timeLeft = 10;
        var timerSpan = document.getElementById('img-timer');
        var timer = setInterval(function() {
            timeLeft--;
            if(timerSpan) timerSpan.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                div.remove(); // ÂÖ≥Èó≠ÂõæÁâá
            }
        }, 1000);
        
        // ÁÇπÂáªËÉåÊôØ‰πüÂèØ‰ª•ÊèêÂâçÂÖ≥Èó≠
        div.onclick = function() {
            clearInterval(timer);
            div.remove();
        }
    }

    // ÂêØÂä®ÊµÅÁ®ã
    showGreeting();

})();
</script>
<!-- ================== Êñ∞Âπ¥ÈôêÊó∂ÂÖ¨Âëä‰ª£Á†Å END ================== -->
</body>
<style>
@viewport { fit: cover; }
:root {
    --safe-top: max(44px, env(safe-area-inset-top)); 
}
.modal-header,           
.chat-header,            
.theater-header,         
.fridge-header-clean,    
.pickup-header,          
.hp-app-header,          
#camera-ui > div:first-child 
{
    padding-top: var(--safe-top) !important;
    height: auto !important;
    min-height: calc(50px + var(--safe-top)) !important;
    align-items: flex-end !important;
    padding-bottom: 12px !important;
    box-sizing: border-box !important;
    background-clip: padding-box !important;
    z-index: 9999 !important; 
}

    padding-top: calc(70px + var(--safe-top)) !important; 
}
.chat-settings-panel {
    padding-top: calc(20px + var(--safe-top)) !important;
}
.game-stats-panel {
    top: calc(20px + var(--safe-top)) !important;
}
.game-history-btn {
    top: calc(20px + var(--safe-top)) !important;
}
.paper-full-view {
    margin-top: var(--safe-top) !important;
    height: calc(90vh - var(--safe-top)) !important;
}
#letter-write-view > div:first-child {
    padding-top: var(--safe-top) !important;
    height: auto !important;
    min-height: calc(50px + var(--safe-top)) !important;
    align-items: flex-end !important;
    padding-bottom: 10px !important;
}
#camera-ui > div:first-child {
    background: #000 !important;
    display: flex !important;
    align-items: flex-end !important; 
}
#hp-os-view > div:first-child {
    padding-top: var(--safe-top) !important;
    height: auto !important;
    min-height: calc(30px + var(--safe-top)) !important;
    align-items: flex-end !important;
}
.hp-app-header {
    padding-top: var(--safe-top) !important;
    height: calc(50px + var(--safe-top)) !important;
    align-items: flex-end !important;
    padding-bottom: 10px !important;
}
#fan-modal .close-btn {
    top: calc(30px + var(--safe-top)) !important;
}
#gift-modal .close-btn {
    top: calc(30px + var(--safe-top)) !important;
}
.page {
    padding-top: calc(30px + var(--safe-top)) !important;
}
body, #screen {
    background-color: #cdd1d3; 
}
.study-resource-tag { 
    display: inline-block; background: #e3f2fd; color: #0277bd; 
    padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; 
    margin-right: 5px; margin-bottom: 5px; border: 1px solid #b3e5fc;
}
.study-sub-task {
    font-size: 0.85rem; color: #666; margin-top: 4px; 
    padding-left: 10px; border-left: 2px solid #cfd8dc;
}
.mind-map-box {
    font-family: "Courier New", monospace; white-space: pre-wrap; 
    font-size: 0.8rem; background: #fff; padding: 15px; 
    border-radius: 8px; border: 1px dashed #aaa; line-height: 1.4;
    overflow-x: auto; color: #37474f;
}
.diary-book-container {
    width: 95%; max-width: 800px; height: 75vh;
    background: #fdfbf7;
    margin: auto; margin-top: 60px;
    display: flex;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    border-radius: 4px;
    position: relative;
}
.diary-book-container::before { 
    content: ""; position: absolute; top:0; bottom:0; left:50%; width:40px; transform:translateX(-50%);
    background: linear-gradient(to right, transparent, rgba(0,0,0,0.1) 45%, rgba(0,0,0,0.1) 55%, transparent);
    pointer-events: none; z-index: 5;
}
.diary-page {
    flex: 1; padding: 25px 30px; overflow-y: auto;
    background-image: repeating-linear-gradient(transparent, transparent 27px, #e0e0e0 28px);
    background-attachment: local;
    line-height: 28px; color: #4e342e; font-family: "Georgia", serif;
}
.diary-page.left { border-right: 1px solid #eee; }
.diary-status-bar {
    display: flex; gap: 10px; font-size: 0.7rem; font-family: monospace; 
    background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; margin-bottom: 10px;
    justify-content: space-around; font-weight: bold; color: #5d4037;
}
.diary-date { text-align: right; font-style: italic; color: #888; margin-bottom: 15px; border-bottom: 2px double #ccc; }
.diary-text-body { font-size: 0.95rem; text-align: justify; white-space: pre-wrap; }
.diary-photo-frame {
    width: 120px; height: 120px; float: left; margin: 0 15px 5px 0;
    background: #eee; border: 5px solid #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    transform: rotate(-3deg); position: relative;
}
.photo-pin { position: absolute; top: -10px; left: 50%; font-size: 1.2rem; transform:translateX(-50%); }
.bag-item-box {
    margin-bottom: 15px; border: 1px solid #d7ccc8; padding: 10px; background: rgba(255,255,255,0.6);
}
.bag-item-name { font-weight: bold; font-size: 1rem; color: #3e2723; }
.bag-item-note { 
    font-size: 0.8rem; color: #5d4037; margin-top: 5px; 
    border-top: 1px dashed #d7ccc8; padding-top: 5px; line-height: 1.4;
}
@media (max-width: 600px) {
    .diary-book-container { flex-direction: column; height: 85vh; overflow-y: scroll; }
    .diary-page { min-height: 500px; border-right: none; border-bottom: 10px solid #eee; }
    .diary-book-container::before { display: none; }
}
.coin {
    width: 60px; height: 60px; background: #ffd700; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; box-shadow: 0 4px 0 #b8860b; border: 4px solid #fff;
    transition: transform 0.5s;
}
.coin.animate { animation: spinCoin 0.5s ease-out; }
@keyframes spinCoin { 0% { transform: rotateY(0); } 100% { transform: rotateY(720deg); } }

.iching-line {
    width: 200px; height: 20px; display: flex; gap: 20px; justify-content: center;
}
.line-part { background: #e2c2b3; height: 100%; border-radius: 4px; }
.line-yin .line-part { flex: 1; } 
.line-yang .line-part { width: 100%; } 
.line-moving { background: #ff6b6b !important; } 
.line-label { position: absolute; left: -30px; font-size: 0.8rem; color: #aaa; }
.lofter-card {
    background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;
}
.lofter-tags { display:flex; gap:5px; margin-bottom:8px; }
.lofter-tag { font-size:0.7rem; color:#888; background:#f0f0f0; padding:2px 6px; border-radius:2px; }
.lofter-title { font-size:1.1rem; font-weight:bold; color:#333; margin-bottom:5px; line-height:1.3; }
.lofter-preview { font-size:0.9rem; color:#666; line-height:1.5; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
.lofter-meta { 
    margin-top:10px; padding-top:8px; border-top:1px solid #f5f5f5; 
    display:flex; justify-content:space-between; font-size:0.75rem; color:#999; 
}
.lofter-comment-section {
    margin-top: 30px; padding-top: 20px; border-top: 5px solid #f5f5f5;
}
.lofter-cmt-row { display:flex; gap:10px; margin-bottom:15px; font-size:0.9rem; }
.lofter-cmt-avatar { width:30px; height:30px; background:#ddd; border-radius:50%; flex-shrink:0; }
.lofter-toolbar {
    padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0;
    display: flex; gap: 10px; align-items: center;
}
.lofter-input {
    flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px;
    font-size: 0.9rem; background: #f9f9f9; outline: none;
}
.lofter-del-btn {
    position: absolute; top: 10px; right: 10px;
    width: 20px; height: 20px; text-align: center; line-height: 18px;
    color: #ccc; border-radius: 50%; font-size: 1.2rem;
    z-index: 10; padding-bottom: 2px;
}
.lofter-del-btn:hover { color: #ff4757; background: #fff0f0; }
.lofter-card { position: relative; } 
#lofter-feed-list {
    column-count: 2;
    column-gap: 10px;
    padding-bottom: 60px;
}

.lofter-card-new {
    break-inside: avoid;
    background: #fff;
    margin-bottom: 10px;
    border-radius: 8px; 
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    position: relative;
    display: flex;
    flex-direction: column;
}
.lof-cover-placeholder {
    width: 100%;
    height: 120px;
    background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
    position: relative;
}
.lof-cover-placeholder::after {
    content: "LOFTER";
    position: absolute;
    bottom: 5px; right: 10px;
    font-weight: 900; color: rgba(0,0,0,0.1);
    font-size: 1.5rem; letter-spacing: 2px;
}

.lof-body {
    padding: 10px;
    cursor: pointer;
}

.lof-title {
    font-size: 0.95rem; font-weight: bold; color: #333;
    margin-bottom: 5px; line-height: 1.3;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

.lof-preview {
    font-size: 0.8rem; color: #666; line-height: 1.5;
    margin-bottom: 8px;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.lof-footer {
    padding: 0 10px 10px 10px;
    display: flex; align-items: center; justify-content: space-between;
}
.lof-user-row {
    display: flex; align-items: center; gap: 6px;
}
.lof-avatar {
    width: 20px; height: 20px; border-radius: 50%;
    background: #ccc; font-size: 0.6rem; color: #fff;
    display: flex; align-items: center; justify-content: center;
}
.lof-author { font-size: 0.7rem; color: #888; max-width: 60px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.lof-hot { font-size: 0.7rem; color: #999; display: flex; align-items: center; gap: 2px;}
.lof-tags { display: none; } 
.lof-del {
    position: absolute; top: 5px; right: 5px;
    width: 20px; height: 20px; background: rgba(0,0,0,0.5);
    color: #fff; border-radius: 50%; text-align: center; line-height: 18px;
    font-size: 1rem; cursor: pointer; z-index: 5; opacity: 0.6;
}
.gashapon-machine {
    width: 200px; height: 320px; position: relative; cursor: pointer;
    transition: transform 0.1s;
}
.gashapon-machine:active { transform: scale(0.95) rotate(1deg); }
.gashapon-machine.shaking { animation: shakeMachine 0.5s infinite; }
@keyframes shakeMachine { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }

.gm-glass {
    width: 180px; height: 180px; background: rgba(255,255,255,0.3);
    border: 4px solid #f48fb1; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    margin: 0 auto; position: relative; overflow: hidden;
    box-shadow: inset -10px -10px 20px rgba(255, 182, 193, 0.5), 0 5px 15px rgba(0,0,0,0.1);
    z-index: 2;
}
.gm-ball {
    width: 40px; height: 40px; border-radius: 50%; position: absolute; border: 2px solid rgba(0,0,0,0.1);
    box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2);
}
.b1 { background: #ffcc80; bottom: 10px; left: 30px; transform: rotate(45deg); }
.b2 { background: #81d4fa; bottom: 40px; right: 40px; transform: rotate(-20deg); }
.b3 { background: #a5d6a7; bottom: 10px; right: 20px; }

.gm-body {
    width: 200px; height: 140px; background: #f48fb1;
    border-radius: 10px 10px 30px 30px; position: absolute; bottom: 0;
    box-shadow: inset 5px 0 10px rgba(0,0,0,0.1);
}
.gm-knob {
    width: 40px; height: 40px; background: #fff; border-radius: 50%;
    position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
    border: 4px solid #e0e0e0; box-shadow: 0 4px 5px rgba(0,0,0,0.2);
}
.gm-knob::after { content:""; width: 30px; height: 6px; background: #ccc; position: absolute; top: 13px; left: 1px; transform: rotate(90deg); }
.gm-exit {
    width: 60px; height: 40px; background: #333; border-radius: 5px 5px 20px 20px;
    position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
    box-shadow: inset 0 5px 10px rgba(0,0,0,0.8);
}
.gm-label {
    position: absolute; top: 100px; left: 50%; transform:translateX(-50%);
    background: #fff; padding: 2px 8px; font-size: 0.7rem; color: #f48fb1; font-weight: bold; border-radius: 4px; z-index: 5;
}
.gashapon-history-drawer {
    background: #fff; border-radius: 20px 20px 0 0; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    max-height: 60%; display: flex; flex-direction: column;
    transition: transform 0.3s;
}
.gh-handle {
    text-align: center; padding: 15px; color: #880e4f; font-weight: bold; font-size: 0.9rem; cursor: pointer;
    border-bottom: 1px solid #fce4ec;
}
.gh-list { flex: 1; overflow-y: auto; padding: 15px; display: none; }
.gh-list.show { display: block; }
.big-capsule {
    width: 200px; height: 200px; border-radius: 50%; 
    position: relative; cursor: pointer;
    animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    overflow: hidden;
    transform-origin: center; transition: all 0.5s;
}
@keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
.bc-top { height: 50%; width: 100%; background: #ff4081; position: relative; z-index: 2; border-bottom: 4px solid rgba(0,0,0,0.1); }
.bc-bottom { height: 50%; width: 100%; background: #fff; position: relative; z-index: 1; }
.bc-text { 
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
    z-index: 3; color: rgba(0,0,0,0.5); font-weight: bold; font-family: monospace; 
    pointer-events: none; background: rgba(255,255,255,0.8); padding: 2px 5px;
}
.big-capsule.open {
    transform: scale(1.5); opacity: 0; pointer-events: none;
}
.story-paper {
    width: 90%; max-width: 500px; max-height: 80vh;
    background: #fffdf0; padding: 25px;
    box-shadow: 0 0 30px rgba(255,255,255,0.8);
    font-family: "Noto Serif SC", serif; color: #4a4a4a;
    display: flex; flex-direction: column;
    animation: unfold 0.8s ease-out;
    background-image: linear-gradient(90deg, rgba(200, 200, 200, 0.1) 1px, transparent 1px), linear-gradient(rgba(200, 200, 200, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    border: 1px solid #ddd;
}
@keyframes unfold { 0% { transform: scaleY(0.1); opacity: 0; } 100% { transform: scaleY(1); opacity: 1; } }
.sp-header { 
    border-bottom: 2px double #e91e63; padding-bottom: 10px; margin-bottom: 15px; 
    display: flex; justify-content: space-between; font-size: 0.7rem; color: #e91e63; font-weight: bold; 
}
.sp-content { 
    flex: 1; overflow-y: auto; line-height: 1.8; font-size: 1rem; text-align: justify; 
    white-space: pre-wrap; padding-bottom: 20px;
}
.sp-content p { margin-bottom: 15px; }
.sp-footer { margin-top: auto; text-align: center; padding-top: 10px; border-top: 1px dashed #ccc; }
.pet-item-card {
    background: #fff; border: 1px solid #ddd; border-radius: 8px;
    padding: 5px; text-align: center; cursor: pointer; position: relative;
}
.pet-item-img { width: 100%; height: 60px; object-fit: contain; }
.pet-item-price { font-size: 0.8rem; color: #d35400; font-weight: bold; }
.pet-item-count { 
    position: absolute; top: -5px; right: -5px; 
    background: #e74c3c; color: white; border-radius: 50%; 
    width: 20px; height: 20px; font-size: 0.7rem; 
    display: flex; align-items: center; justify-content: center;
}
.pet-decor-obj {
    position: absolute; pointer-events: auto; cursor: pointer;
    transition: transform 0.1s;
}
.pet-decor-obj:active { transform: scale(0.95); }
@keyframes petBreathe {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02) translateY(-2px); }
}
.pet-anim { animation: petBreathe 3s infinite ease-in-out; }
#bag-grid, #shop-grid, #adopt-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important; 
    gap: 10px !important;
    padding: 15px !important;
    justify-content: center !important;
}
.pet-item-card {
    width: 100% !important;
    aspect-ratio: 0.85 !important;
    min-width: 0 !important;
}
.pet-item-card {
    width: 100% !important;
    min-width: 0 !important; 
    aspect-ratio: 0.8 !important; 
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}

.pet-item-img {
    width: 70% !important;
    height: 60% !important;
    object-fit: contain !important;
    margin-bottom: 5px !important;
}
.shadow-table {
    width: 100%;
    border-collapse: collapse;
    color: #dfe6e9;
    font-size: 0.9rem;
}
.shadow-table th, .shadow-table td {
    border: 1px solid #636e72;
    padding: 8px;
    text-align: left;
}
.shadow-table tr:nth-child(odd) {
    background: rgba(255, 255, 255, 0.05);
}
.shadow-table td:first-child {
    font-weight: bold;
    color: #ff7675; 
    width: 30%;
}
.rpg-sprite {
    position: absolute;
    width: 64px; 
    height: 64px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center bottom;
    transition: left 0.1s linear, top 0.1s linear; 
}
.rpg-decor {
    position: absolute;
    pointer-events: none; 
}
.rpg-dpad-btn {
    width: 40px; height: 40px;
    background: rgba(255,255,255,0.3);
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 8px; color: white;
    font-weight: bold; font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center;
}
.rpg-dpad-btn:active { background: rgba(255,255,255,0.6); }
.rpg-chat-bubble {
    font-size: 0.8rem; padding: 5px; margin-bottom: 5px; border-radius: 4px;
}
.rpg-chat-bubble.me { background: #ffeaa7; text-align: right; }
.rpg-chat-bubble.char { background: #fff; text-align: left; }
#rpg-history-panel {
    z-index: 10000 !important; 
    background: #fdfbf7 !important; 
    width: 85% !important;
    max-width: 300px;
    right: 0;
    top: 0;
    height: 100%;
    position: absolute;
}

/* Á°Æ‰øùÁîüÊàêÁöÑÂàóË°®ÂèØ‰ª•ÊªöÂä® */
#rpg-history-list {
    overflow-y: auto !important;
    height: calc(100% - 60px) !important;
    padding-bottom: 50px;
}
/* ‰øÆÊîπÊàñÊ∑ªÂä†Âà∞‰Ω†ÁöÑ <style> Âùó‰∏≠ */
#rpg-chat-modal > div:nth-child(4) { 
    min-height: 160px;
    padding: 20px;
    box-sizing: border-box;
}
#rpg-display-mode {
    display: none; 
    height: 100%; 
    color: #fff; 
    font-family: 'Songti SC', serif;
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 10px;
    box-sizing: border-box;
}
#rpg-typewriter-text {
    font-size: 1.1rem; 
    line-height: 1.6; 
    min-height: 60px; 
    white-space: pre-wrap;
    color: #ecf0f1;
}
#rpg-chat-modal > div:nth-child(4) { 
    min-height: 180px !important; 
    height: 180px !important;     
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: rgba(0,0,0,0.85); 
}
#rpg-display-mode {
    display: none; 
    width: 100%;
    height: 100%; 
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid rgba(255, 255, 255, 0.3); 
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    cursor: pointer; 
    overflow-y: auto; 
}
#rpg-typewriter-text {
    color: #fff;
    font-family: 'Songti SC', serif;
    font-size: 1.1rem; 
    line-height: 1.6; 
    white-space: pre-wrap;
}
#rpg-display-mode {
    display: none; 
    width: 100%;
    height: 100%; 
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid rgba(255, 255, 255, 0.3); 
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    cursor: pointer; 
    overflow-y: auto;
}
#rpg-chat-modal > div:nth-child(4) { 
    min-height: 180px !important;
    height: 180px !important;
    display: flex;
    flex-direction: column;
}
.comp-q-row {
    background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
    border-left: 4px solid #ccc; transition: border-color 0.3s;
}
.comp-q-row.has-cards { border-left-color: #6c5ce7; }
.comp-q-input {
    width: 100%; border: none; border-bottom: 1px dashed #ddd; 
    padding: 5px; font-size: 0.95rem; outline: none; background: transparent;
}
.comp-card-preview {
    font-size: 0.75rem; color: #6c5ce7; margin-top: 8px; 
    display: flex; gap: 5px; flex-wrap: wrap;
}
.comp-del-btn {
    position: absolute; top: 5px; right: 5px; color: #ff7675; 
    cursor: pointer; font-size: 1.2rem; line-height: 1;
}
.comp-msg-bubble {
    background: #fff; padding: 15px; border-radius: 12px 12px 12px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: popIn 0.5s;
    border: 1px solid #f0f0f0;
}
.comp-msg-q { font-weight: bold; color: #5d4037; font-size: 0.9rem; margin-bottom: 5px; }
.comp-msg-a { font-size: 0.95rem; color: #333; line-height: 1.6; }
.comp-msg-cards { font-size: 0.7rem; color: #a29bfe; margin-top: 8px; text-align: right; }
@keyframes popIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
.flat-bottle {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: flex-end !important;
    min-width: 40px !important;
    height: 70px !important;
    opacity: 0.5;
    transition: all 0.2s;
    position: relative;
    z-index: 10;
}
.flat-bottle.active { opacity: 1 !important; transform: scale(1.1); }
.bottle-shape {
    width: 30px !important;
    height: 45px !important;
    border-radius: 4px !important;
    background-color: #e0e0e0; 
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
}
.bottle-shape::before {
    content: "";
    position: absolute;
    top: -6px; left: 50%; transform: translateX(-50%);
    width: 16px; height: 6px;
    background: #555;
    border-radius: 2px;
}
.b-oil .bottle-shape { background-color: #fdd835 !important; border-color: #fbc02d !important; }
.b-dark .bottle-shape { background-color: #5d4037 !important; border-color: #3e2723 !important; } 
.b-black .bottle-shape { background-color: #2d3436 !important; border-color: #000 !important; } 
.b-white .bottle-shape { background-color: #ffffff !important; border-color: #dfe6e9 !important; } 
.b-wine .bottle-shape { background-color: #fdcb6e !important; border-color: #e17055 !important; } 

.bottle-name {
    font-size: 0.65rem !important;
    color: #333 !important;
    margin-top: 4px;
    font-weight: bold;
    text-align: center;
}
@keyframes driveRight {
    0% { left: -150px; }
    100% { left: 100%; }
}

@keyframes driveLeft {
    0% { left: 100%; }
    100% { left: -150px; }
}

.car-drive-right {
    animation: driveRight 3s linear forwards;
    transform: scaleX(1); 
}

.car-drive-left {
    animation: driveLeft 3s linear forwards;
    transform: scaleX(-1); 
}
.rpg-diary-entry {
    background-color: #fff9c4; 
    background-image: 
        radial-gradient(#d7ccc8 1px, transparent 1px), 
        linear-gradient(to bottom, transparent 29px, #bcaaa4 30px); 
    background-size: 20px 20px, 100% 30px;
    background-attachment: local;
    
    padding: 20px 20px 30px 20px;
    margin-bottom: 20px;
    border-radius: 2px;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
    
    font-family: "Long Cang", "Comic Sans MS", cursive, serif; 
    color: #5d4037;
    position: relative;
    transform: rotate(-1deg); 
    transition: transform 0.2s;
    line-height: 30px; 
}

.rpg-diary-entry:nth-child(even) {
    transform: rotate(1deg); 
}

.rpg-diary-entry:hover {
    transform: scale(1.02) rotate(0deg);
    z-index: 10;
    box-shadow: 5px 10px 15px rgba(0,0,0,0.15);
}

/* Êó•ËÆ∞‰∏äÁöÑÂõæÈíâË£ÖÈ•∞ */
.rpg-diary-entry::before {
    content: "üìå";
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2rem;
    filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
}

.rpg-diary-date {
    font-size: 0.9rem;
    color: #8d6e63;
    font-weight: bold;
    text-align: right;
    margin-bottom: 10px;
    border-bottom: 2px dashed #8d6e63;
    padding-bottom: 5px;
}

.rpg-diary-text {
    font-size: 1.1rem;
    white-space: pre-wrap;
}

.rpg-diary-del {
    position: absolute;
    bottom: 5px;
    right: 10px;
    font-size: 0.8rem;
    color: #ef5350;
    cursor: pointer;
    font-family: sans-serif;
    opacity: 0.5;
}
.rpg-diary-del:hover { opacity: 1; font-weight: bold; }
/* üêª Â∞èÁÜäÈ•ºÂπ≤Ê†∑Âºè */
.cookie-btn {
    aspect-ratio: 1;
    background: #e17055;
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    box-shadow: 0 4px 0 #d35400;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.2rem;
    transition: transform 0.1s;
    border: 2px solid #fab1a0;
}
.cookie-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #d35400; }
.cookie-btn::before, .cookie-btn::after {
    content: ""; position: absolute; top: -5px; width: 12px; height: 12px;
    background: #e17055; border-radius: 50%; border: 2px solid #fab1a0;
}
.cookie-btn::before { left: 5px; }
.cookie-btn::after { right: 5px; }

/* Áä∂ÊÄÅÊ†∑Âºè */
.cookie-btn.selected { background: #00cec9; border-color: #81ecec; box-shadow: 0 4px 0 #00b894; }
.cookie-btn.selected::before, .cookie-btn.selected::after { background: #00cec9; border-color: #81ecec; }

.cookie-btn.eaten { 
    background: #636e72; box-shadow: none; transform: scale(0.9); opacity: 0.5; pointer-events: none; 
}
.cookie-btn.eaten::before, .cookie-btn.eaten::after { background: #636e72; border-color: #2d3436; }

.cookie-btn.trap-revealed {
    background: #ff7675; border-color: #d63031; animation: shake 0.5s;
}
/* üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´Âç∑ËΩ¥Ê†∑Âºè */
.witch-scroll-paper {
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
    border: 2px solid #6c5ce7;
    box-shadow: 0 0 30px rgba(108, 92, 231, 0.4), inset 0 0 50px rgba(0,0,0,0.8);
    border-radius: 12px;
    padding: 25px;
    display: flex;
    flex-direction: column;
    color: #dfe6e9;
    font-family: "Songti SC", serif; /* ÂÆã‰ΩìÊõ¥ÊúâÈ≠îÂπªÊÑü */
    position: relative;
    animation: unfold 0.6s ease-out;
}

.ws-header {
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #6c5ce7; padding-bottom: 10px; margin-bottom: 15px;
}

.ws-body {
    flex: 1; overflow-y: auto;
    font-size: 1.05rem; line-height: 1.8; text-align: justify;
    white-space: pre-wrap;
    padding-right: 5px;
    color: #ecf0f1;
    text-shadow: 0 1px 2px #000;
}

.ws-footer {
    margin-top: 15px; padding-top: 10px; border-top: 1px dashed #636e72; text-align: right;
}
/* üíû ÈªòÂ•ëÂ§ßÊåëÊàò‰∏ìÁî®Ê†∑Âºè */
.tacit-q-card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid #ffefff;
    position: relative;
}
.tacit-del-btn {
    position: absolute; top: 10px; right: 10px;
    color: #ff7675; cursor: pointer; font-weight: bold;
}
.tacit-input-row { margin-bottom: 8px; }
.tacit-input {
    width: 100%; padding: 8px; border: 1px solid #eee; 
    border-radius: 6px; font-size: 0.9rem; background: #fdfdfd;
}
.tacit-opt-group {
    display: flex; gap: 10px; align-items: center; margin-top: 5px;
}
.tacit-radio { transform: scale(1.2); accent-color: #d63031; }
.tacit-card-status {
    margin-top: 10px; padding: 8px; background: #fff0f6; 
    border-radius: 6px; color: #d63031; font-size: 0.8rem; text-align: center;
    cursor: pointer; border: 1px dashed #ffadd2;
}
.tacit-result-card {
    background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px;
    border-left: 4px solid #ccc;
}
.tacit-result-card.correct { border-left-color: #00b894; background: #f0fdf4; }
.tacit-result-card.wrong { border-left-color: #ff7675; background: #fff5f5; }
.tacit-res-header { font-weight: bold; margin-bottom: 5px; color: #2d3436; }
.tacit-res-reason { font-size: 0.85rem; color: #636e72; margin-top: 8px; line-height: 1.5; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 4px;}
.tacit-card-tag { font-size: 0.75rem; color: #a29bfe; margin-top: 5px; }
/* === ‰øÆÂ§çË°•‰∏ÅÔºöÈ¶ôÁâáËØ¶ÊÉÖÈ°µÊªëÂä® === */

#scent-detail-modal .morandi-card {
    display: flex;
    flex-direction: column;
    max-height: 85vh !important; /* ÈôêÂà∂ÂºπÁ™óÊúÄÂ§ßÈ´òÂ∫¶ */
}
#scent-detail-modal .morandi-card > div:last-child {
    overflow-y: auto !important; /* ÂÖÅËÆ∏ÂÜÖÂÆπÂå∫ÂüüÂûÇÁõ¥ÊªöÂä® */
    flex: 1; /* Âç†Êª°Ââ©‰ΩôÁ©∫Èó¥ */
    -webkit-overflow-scrolling: touch; /* iOS ‰∏ùÊªëÊªöÂä® */
}
/* ==================== üõ†Ô∏è ‰øÆÂ§çË°•‰∏ÅÔºöÁîüÊ¥ªÁâáÊÆµÈù¢ÊùøÈò≤Á©øÈÄè ==================== */

/* ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å */
#rpg-history-panel {
    position: absolute; 
    top: 0; 
    right: 0; 
    width: 260px;
    height: 100%;
    background: #fdfbf7;
    
    /* ‚úÖ ‰øÆÂ§çÔºöÊîπÂ§ßÂà∞ 3000ÔºåÁ°Æ‰øùÊµÆÂú®Ê∏∏ÊàèÊú∫ÁîªÈù¢‰πã‰∏ä */
    z-index: 3000 !important; 
    
    transform: translateX(100%);
    transition: transform 0.3s ease;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    
    /* ‰øùÊåÅÈöêËóèÈÄªËæë‰∏çÂèò */
    display: none !important; 
    flex-direction: column;
}
/* 2. ÂΩìÈù¢ÊùøÊâìÂºÄÊó∂ÊâçÊòæÁ§∫ */
#rpg-history-panel.open {
    transform: translateX(0);
    display: flex !important; /* Âè™ÊúâÊ∑ªÂä†‰∫Ü open Á±ªÊó∂ÊâçÊòæÁ§∫ */
}

/* 3. Á°Æ‰øùÂàóË°®ÂÜÖÂÆπÂèØ‰ª•ÊªöÂä® */
#rpg-history-list {
    overflow-y: auto !important;
    height: 100%;
    padding-bottom: 50px;
    flex: 1;
}

/* === üìñ ‰øÆÊîπÁâàÔºöÂçïÈ°µÁâõÁöÆÁ¨îËÆ∞Êú¨Ê†∑Âºè === */
#rpg-book-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 12000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}

/* Â∞ÅÈù¢Áä∂ÊÄÅ (‰øùÊåÅ‰∏çÂèò) */
.book-cover-state {
    width: 280px; height: 380px;
    background: #5d4037;
    background-image: repeating-linear-gradient(135deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 4px);
    border-radius: 6px 16px 16px 6px;
    box-shadow: 10px 10px 30px rgba(0,0,0,0.7);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; position: relative; border: 4px solid #3e2723;
    transition: transform 0.3s;
}
.book-cover-state:active { transform: scale(0.98); }

.book-spine-deco {
    position: absolute; left: 0; top: 0; bottom: 0; width: 25px;
    background: #3e2723; border-radius: 4px 0 0 4px;
    box-shadow: inset -2px 0 5px rgba(0,0,0,0.5);
}

.book-title-gold {
    font-family: "Old English Text MT", serif; font-size: 2.2rem; color: #ffd700;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-bottom: 5px;
}
.book-subtitle { font-size: 0.8rem; color: #a1887f; letter-spacing: 3px; text-transform: uppercase; }
/* üìñ ÂçïÈ°µÂÜÖÈ°µËßÜÂõæ (‰øÆÊ≠£ËÉåÊôØÂπ≥Èì∫ÈóÆÈ¢ò) */
.book-single-view {
    width: 90%; max-width: 500px;
    height: 80vh; max-height: 750px;
    background-color: #fdf6e3; /* ÈªòËÆ§Á±≥ÈªÑ */
    
    /* ÈªòËÆ§ÊñπÊ†ºÁ∫πÁêÜ (‰ºöË¢´Ëá™ÂÆö‰πâËÉåÊôØË¶ÜÁõñ) */
    background-image: 
        linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px),
        linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
    
    /* üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ¶ÇÊûú‰Ω†‰∏ä‰º†‰∫ÜÂõæÁâáÔºå‰∏ãÈù¢ÁöÑ js ‰ºöË¶ÜÁõñËøô‰∏™Â±ûÊÄßÔºå‰ΩÜÂú® CSS ÈáåÊàë‰ª¨Ë¶ÅÈªòËÆ§Èì∫Êª° */
    background-size: 100% 100% !important; 
    background-repeat: no-repeat !important;
    background-position: center !important;

    border-radius: 6px 12px 12px 6px;
    box-shadow: 
        inset 15px 0 20px rgba(0,0,0,0.1), /* ‰π¶ËÑäÈò¥ÂΩ± */
        10px 10px 40px rgba(0,0,0,0.6);
        
    display: none; 
    position: relative;
    padding: 40px 30px 60px 40px; /* Ë∞ÉÊï¥ËæπË∑ùÔºåÁªôÊñáÂ≠óÁïôÁ©∫Èó¥ */
    flex-direction: column;
}

/* Á¨îËÆ∞Êú¨‰æßËæπÁöÑË£ÖËÆ¢Á∫øËßÜËßâÊïàÊûú */
.book-single-view::before {
    content: ""; position: absolute; left: 15px; top: 0; bottom: 0; width: 2px;
    border-left: 2px dashed rgba(0,0,0,0.1); z-index: 1;
}

/* ÂÜÖÂÆπÂå∫Âüü */
.book-content-area {
    flex: 1;
    overflow-y: auto; /* ÂÜÖÂÆπÂ§™ÈïøÊó∂Ëá™Âä®ÊªöÂä® */
    font-family: "Songti SC", "Noto Serif SC", serif;
    color: #4e342e;
    line-height: 1.8;
    font-size: 1.05rem;
    white-space: pre-wrap;
    text-align: justify;
}

/* Êó•ÊúüÂ§¥ */
.book-page-header {
    border-bottom: 2px double #8d6e63;
    padding-bottom: 10px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: flex-end;
}
.book-date { font-family: 'Courier New', monospace; font-weight: bold; color: #5d4037; }
.book-tag { font-size: 0.7rem; background: #8d6e63; color: white; padding: 2px 6px; border-radius: 4px; }

/* ÁøªÈ°µÊåâÈíÆ (ÊîæÂú®‰π¶Êú¨‰∏ãÊñπÁöÑ‰∏§‰æß) */
.book-nav-btn {
    position: absolute; bottom: 15px;
    background: none; border: none; font-size: 1.5rem;
    color: #8d6e63; cursor: pointer; opacity: 0.7;
    transition: 0.2s; z-index: 10;
}
.book-nav-btn:hover { opacity: 1; transform: scale(1.1); }
.book-nav-btn:active { transform: scale(0.9); }
.btn-prev { left: 40px; }
.btn-next { right: 25px; }

/* È°µÁ†ÅÊåáÁ§∫ */
.book-page-num {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    font-size: 0.8rem; color: #aaa; font-family: monospace;
}

/* Âà†Èô§ÊåâÈíÆ (Âè≥‰∏äËßí) */
.book-del-icon {
    position: absolute; top: 15px; right: 15px;
    color: #e57373; cursor: pointer; font-size: 1.2rem; opacity: 0.5;
}
.book-del-icon:hover { opacity: 1; }
/* === Êñ∞Â¢ûÔºöÂ§úÈó¥Ê®°Âºè‰∏éÊëáÊùÜÊ†∑Âºè === */
html.night-mode {
    filter: brightness(50%); /* Êï¥‰Ωì‰∫ÆÂ∫¶Èôç‰Ωé50% */
    background-color: #000;  /* Èò≤Ê≠¢ËÉåÊôØÁ©øÈÄèÁôΩÂÖâ */
}

/* ÊëáÊùÜÂ∫ïÂ∫ß */
.joystick-base {
    position: absolute; 
    left: 15px; 
    top: 50%; 
    transform: translateY(-50%);
    width: 60px; 
    height: 60px; 
    background: #151515; 
    border-radius: 50%;
    box-shadow: inset 0 5px 10px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.1);
    z-index: 10;
}
/* ÊëáÊùÜÊùÜÂ§¥ */
.joystick-stick {
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%);
    width: 36px; 
    height: 36px;
    background: radial-gradient(circle at 30% 30%, #555, #1a1a1a);
    border-radius: 50%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.6);
    border: 1px solid #333;
}
/* ÁªôÊëáÊùÜÂä†‰∏™Á∫πÁêÜÂ¢ûÂä†ÁúüÂÆûÊÑü */
.joystick-stick::after {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    background: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.2) 3px);
    opacity: 0.5;
}



/* --- 2. ‰øÆÂ§çÁ¨¨‰∏âÈ°µ RPGÔºöÂ∫ïÈÉ®ÂõûÁ≠îË¢´ÈÅÆÊå°ÁöÑÈóÆÈ¢ò --- */

/* ÂÆö‰ΩçÂà∞ RPG ÂØπËØùÁïåÈù¢ÁöÑÂ∫ïÈÉ®Âå∫Âüü (ËæìÂÖ•Ê°Ü/ÂõûÂ§çÊ°ÜÁöÑÂÆπÂô®) */
#rpg-chat-modal > div:nth-child(4) {
    /* ÂèñÊ∂àÂõ∫ÂÆöÈ´òÂ∫¶ÔºåÊîπ‰∏∫Ëá™ÈÄÇÂ∫î */
    height: auto !important;
    min-height: 200px !important;
    
    /* üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÂ¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÔºåÈÄÇÈÖçÊâãÊú∫Â∫ïÈÉ®ÈªëÊù° (Safe Area) */
    padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;
    
    /* Á°Æ‰øùËÉåÊôØ‰∏çÈÄèÊòéÔºåÈò≤Ê≠¢Áúã‰∏çÊ∏ÖÂ≠ó */
    background: rgba(0, 0, 0, 0.9) !important;
    border-top: 1px solid #444 !important;
}

/* ‰øÆÂ§çÊñáÂ≠óÊòæÁ§∫Âå∫Âüü */
#rpg-display-mode {
    /* Á°Æ‰øùÂÆπÂô®Âç†Êª° */
    height: 100% !important;
    min-height: 120px !important;
    
    /* ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä® */
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    
    /* Â¢ûÂä†Â∫ïÈÉ®ÁïôÁôΩÔºåËøôÊ†∑ÊªëÂà∞Â∫ïÈÉ®Êó∂ÊñáÂ≠ó‰∏ç‰ºöË¥¥Ëæπ */
    padding-bottom: 50px !important;
}

/* ‰ºòÂåñÊâìÂ≠óÊú∫ÊñáÂ≠óÊ†∑Âºè */
#rpg-typewriter-text {
    font-size: 1.1rem !important;
    line-height: 1.8 !important;
    color: #fff !important;
    white-space: pre-wrap !important;
}
<style>
/* === üéÆ ‰øÆÂ§çÊ∏∏ÊàèÊú∫ÊñáÊú¨‰∏çÊòæÁ§∫ Bug === */
#game-modal .rpg-text {
    color: #ffffff !important;       /* Âº∫Âà∂ÊñáÂ≠óÁôΩËâ≤ÔºåÈò≤Ê≠¢ÂèòÈªëÁúã‰∏çËßÅ */
    min-height: 50px !important;     /* Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂ÁªôÊ≠£ÊñáÁïôÂá∫ÊúÄÂ∞èÈ´òÂ∫¶ÔºåÈò≤Ê≠¢Ë¢´Êå§Ê≤°‰∫Ü */
    flex: 1 1 auto !important;       /* Á°Æ‰øùÂÆÉËÉΩËá™Âä®ÊíëÂºÄ */
}

#game-modal .card-meaning-display {
    max-height: 40px !important;     /* ÈôêÂà∂Â∫ïÈÉ®ÁâåÊÑèÂå∫ÂüüÁöÑÊúÄÂ§ßÈ´òÂ∫¶ */
    overflow-y: auto !important;     /* Â¶ÇÊûúÁâåÊÑèÂ§™ÈïøÔºåËÆ©ÂÆÉÂÜÖÈÉ®ÊªöÂä®Ôºå‰∏çË¶ÅÂéªÊå§ÂéãÊ≠£Êñá */
    flex-shrink: 0 !important;       /* Á¶ÅÊ≠¢Â∫ïÈÉ®Âå∫ÂüüË¢´ÂéãÁº© */
    margin-top: auto !important;     /* Á°Æ‰øùÊ≤âÂ∫ï */
}
</style>
<script>
if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
if (!window.BIG_MEMORY.rpg_data) {
    window.BIG_MEMORY.rpg_data = { 
        history: [],       
        chat_history: []   
    };
}
window.toggleRpgHistory = function() {
    const panel = document.getElementById('rpg-history-panel');
    panel.classList.toggle('open');
    if(panel.classList.contains('open')) {
        renderRpgHistory(); 
    }
};

window.renderRpgHistory = function() {
    const data = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const con = document.getElementById('rpg-history-list');
    con.innerHTML = '';
    
    if(!data || data.length === 0) {
        con.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">ÊöÇÊó†Êó•ËÆ∞<br>ÂéªÂíåTaÂØπËØùÊàñÁÇπÂáªÂÆ∂ÂÖ∑ÁîüÊàêÊïÖ‰∫ãÂêß~</div>';
        return;
    }

    data.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'rpg-diary-entry'; 
        const dateObj = new Date(h.date);
        const dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;

        div.innerHTML = `
            <div class="rpg-diary-date">${dateStr} ¬∑ ${h.item || 'ÈöèÁ¨î'}</div>
            <div class="rpg-diary-text">${h.text}</div>
            <div class="rpg-diary-del" onclick="deleteRpgHistory(${i})">ÊíïÊéâËøô‰∏ÄÈ°µ</div>
        `;
        con.appendChild(div);
    });
};
window.deleteRpgHistory = function(index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊÆµÂõûÂøÜÂêóÔºü")) return;
window.BIG_MEMORY.rpg_data.history.splice(index, 1);
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    renderRpgHistory();
};

window.finishRpgChat = async function() {
    if(rpgFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøª‰∏ÄÂº†ÁâåÔºÅ");
    const userInput = document.getElementById('rpg-chat-input').value;
    const cardsDesc = rpgFlippedCards.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.getWBData(); 
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const msgCtx = (wb['5.‰º†ËÆØ'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) {
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÂú®Ê°åÈù¢„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÖçÁΩÆ API Key");
    document.getElementById('rpg-card-table-modal').style.display = 'none'; 
    const chatModal = document.getElementById('rpg-chat-modal');
    chatModal.style.display = 'flex';
    chatModal.style.zIndex = '3000'; 
    toggleSpeaker('npc'); 
    playRpgTypewriter(`(üîÆ ÂëΩËøêÁâåÔºö${cardsDesc})\n\nTa Ê≠£Âú®ÊÑüÂèó‰Ω†ÁöÑÂøÉÊÑè...`);

    // 5. ÊûÑÂª∫ÊèêÁ§∫ËØç (Prompt)
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Ë•øÊñπÁéÑÂ≠¶Â§ßÂ∏àÔºåÁé∞Âú®Ê≠£Âú®ÂíåÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑÂÅáÊâÆËßíËâ≤ÂíåÁî®Êà∑‰º†ËææËßíËâ≤ÁöÑËØùËØ≠ÁöÑ‰∫≤ÂØÜÂØπËØù„ÄÇ
„ÄêËßíËâ≤ËÆæÂÆö„ÄëÔºö${globalCtx}
„Äê‰º†ËÆØ/Áü≠‰ø°È£éÊ†ºËÆæÂÆö„ÄëÔºö${msgCtx} 
„ÄêÊÉÖÂ¢É„ÄëÔºöÁî®Êà∑ËØ¥Ôºö"${userInput}"
„ÄêÂëΩËøêÂç°Áâå„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÁªìÂêàÁâåÊÑèÂíåËßíËâ≤ÊÄßÊ†ºÔºåÁªôÁî®Êà∑‰∏Ä‰∏™ÂõûÂ§ç„ÄÇ
Â∞ÜÁâåÈù¢ÁöÑËÉΩÈáèËΩ¨Âåñ‰∏∫ËßíËâ≤ÁöÑÊÉÖÁª™ÂíåÊΩúÂè∞ËØç„ÄÇ
Â∞ÜÁâåÊÑèÂíåËÉΩÈáèËûçÂÖ•ËØùËØ≠„ÄÇ‰∏çË¶ÅoocÔºåË¶ÅË¥¥Âêà‰∏ñÁïå‰π¶ÂÖ®Â±ÄÈáåÁöÑËÆæÂÆöÔºåÂÉèËßíËâ≤‰∏ÄÊ†∑ÁöÑÊ¥ª‰∫∫ÊÑüËøõË°åÂØπËØù„ÄÇ
ÊúÄÈáçË¶ÅÁöÑÊòØÊ†πÊçÆÁâåÊÑèÂíåÁâåÁöÑËÉΩÈáèÊµÅÂä®„ÄÇ
**Â≠óÊï∞ÈôêÂà∂Ôºö3-4Âè•ËØù„ÄÇ**
Áõ¥Êé•ËæìÂá∫ÂõûÂ§çÂÜÖÂÆπ„ÄÇ
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a roleplay character."}, {role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const reply = json.choices[0].message.content.trim();
        if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
        if(!window.BIG_MEMORY.rpg_data.chat_history) window.BIG_MEMORY.rpg_data.chat_history = [];
window.BIG_MEMORY.rpg_data.chat_history.push({ role: 'me', text: userInput });
        window.BIG_MEMORY.rpg_data.chat_history.push({ role: 'char', text: reply + ` <span style="font-size:0.6rem;opacity:0.5;">(üîÆ${cardsDesc})</span>` });
        if(!window.BIG_MEMORY.rpg_data.history) window.BIG_MEMORY.rpg_data.history = [];
        window.BIG_MEMORY.rpg_data.history.unshift({
            date: Date.now(),
            item: "ÂØπËØù ¬∑ ÂëΩËøêÁâå",
            text: `„ÄêÊàë„Äë${userInput}\n„ÄêTa„Äë${reply}\n\nüîÆ ÁâåÊÑèÊåáÂºïÔºö${cardsDesc}`
        });
        if(window.BIG_MEMORY.rpg_data.history.length > 50) window.BIG_MEMORY.rpg_data.history.pop();
        window.saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
        playRpgTypewriter(reply);
        renderRpgChatList();      document.getElementById('rpg-chat-input').value = ''; 

    } catch(e) {
        console.error(e);
        playRpgTypewriter(`(ËøûÊé•‰∏≠Êñ≠... ${e.message})`); 
    }
};
window.generateRpgStory = async function(item) {
    /* 
       ... API Ë∞ÉÁî®ÊàêÂäüÊãøÂà∞ story ÂèòÈáèÂêé ...
    */
    /* 
    if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
    
    window.BIG_MEMORY.rpg_data.history.unshift({
        date: Date.now(),
        item: `‰∫íÂä® ¬∑ ${item.name}`,
        text: story
    });
    
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    renderRpgHistory(); // Âà∑Êñ∞‰æßËæπÊ†è
    */
    
    // ‰∏∫‰∫ÜÂÆåÊï¥ÊÄßÔºåËøôÈáåÈáçÂÜôÊï¥‰∏™ generateRpgStory Á°Æ‰øù‰Ω†‰∏çÊºèÊéâ
    const storyList = document.getElementById('rpg-history-list');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'morandi-card';
    loadingDiv.innerHTML = `<div class="skeleton-text">Ê≠£Âú®ÁîüÊàê‰∏é„Äê${item.name}„ÄëÁöÑ‰∫íÂä®ÊïÖ‰∫ã...</div>`;
    storyList.prepend(loadingDiv);
    
    const wb = getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { 
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; apiUrl=s.url; model=s.model; } catch(e){} 
    }
    if(!apiKey) { loadingDiv.remove(); return alert("ËØ∑ÈÖçÁΩÆ API Key"); }

    const prompt = `‰Ω†ÊòØ‰∏Ä‰∏™Â∞èËØ¥ÂÆ∂„ÄÇÊ†πÊçÆËÆæÂÆöÔºö${globalCtx}„ÄÇÁî®Êà∑‰∏éÊàøÈó¥ÈáåÁöÑ„Äê${item.name}„Äë‰∫íÂä®‰∫Ü„ÄÇËØ∑‰ª•Á¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚ÄùÂÜô‰∏ÄÊÆµÊ∏©È¶®ÁöÑÁîüÊ¥ªÁâáÊÆµÔºà300Â≠óÂ∑¶Âè≥Ôºâ„ÄÇÁõ¥Êé•ËæìÂá∫Ê≠£Êñá„ÄÇ`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"user", content:prompt}],
                temperature: 0.8
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content;
        if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
        if(!window.BIG_MEMORY.rpg_data.history) window.BIG_MEMORY.rpg_data.history = [];

        window.BIG_MEMORY.rpg_data.history.unshift({
            date: Date.now(),
            item: `‰∫íÂä® ¬∑ ${item.name}`,
            text: story
        });
        
        saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
        
        loadingDiv.remove();
        renderRpgHistory(); 
        alert("‚ú® ‰∫íÂä®ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅÁÇπÂºÄÊïÖ‰∫ãÈõÜÊü•Áúã„ÄÇ");

    } catch(e) {
        loadingDiv.innerHTML = `<span style="color:red">Â§±Ë¥•: ${e.message}</span>`;
    }
};
<script>
/**
 * =================================================================
 * üöÄ RetroOS ÁªàÊûÅÁ≥ªÁªüË°•‰∏Å (Êó†ÈôêÂ≠òÂÇ® + Â•≥Â∑´‰øÆÂ§ç + ÂÖ®Â±ÄÂÖºÂÆπ)
 * =================================================================
 */
// 1. Âº∫Âà∂ÂàùÂßãÂåñÂ§ßÂÆπÈáèÂÜÖÂ≠òÁªìÊûÑ
window.BIG_MEMORY = window.BIG_MEMORY || {};
const REQUIRED_KEYS = [
    'world_book', 'letters', 'finance', 'study', 'period', 'memo', 
    'chat_settings', 'theme_fonts', 'api_profiles', 'thesaurus_data', 
    'game_history', 'game_stats', 'tarot_history', 'his_phone_history', 
    'dream_history', 'forum_data', 'pickup_data', 'diary_history', 
    'pet_data', 'lofter_data', 'pain_data', 'gashapon_history', 
    'shadow_data', 'rpg_data', 'moving_data', 'teaching_data', 
    'companion_data', 'summary_data', 'galgame_data', 'scent_data', 
    'puzzle_data', 'work_data', 'witch_data', 'gacha_data', 'tacit_data',
    'adv_data' // üëàüî• ÂøÖÈ°ªË¶ÅÊúâËøô‰∏ÄÈ°πÔºåÊñáÊ∏∏Êï∞ÊçÆÊâçËÉΩË¢´ÂØºÂá∫ÔºÅ
];

// 2. ÈÄöÁî®‰øùÂ≠òÂáΩÊï∞ (ÂÜôÂÖ• IndexedDB Êó†ÈôêÂ≠òÂÇ®)
window.saveToBigDB = function(key, data) {
    // Êõ¥Êñ∞ÂÜÖÂ≠ò
    window.BIG_MEMORY[key] = data;
    // ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
    if (typeof idb !== 'undefined') {
        // ÂÖºÂÆπ‰∏çÂêåÁöÑ key ÂÜôÊ≥ï (Êúâ‰∫õÊòØ _data ÁªìÂ∞æÔºåÊúâ‰∫õ‰∏çÊòØÔºåÁªü‰∏ÄÂ§ÑÁêÜ)
        idb.put('universal_store', { id: key, data: data });
    }
};

// 3. ÂÖ®ÈáèÊï∞ÊçÆÂä†ËΩΩÂô® (ÂºÄÊú∫Êó∂ÊääÊâÄÊúâÊï∞ÊçÆ‰ªéÊï∞ÊçÆÂ∫ìÊãâËøõÂÜÖÂ≠ò)
window.loadAllBigData = async function() {
    console.log("üöÄ [Á≥ªÁªüË°•‰∏Å] Ê≠£Âú®ÂêØÂä®Êó†ÈôêÂÆπÈáèÂºïÊìé...");
    
    // Á°Æ‰øù idb Â∑≤ËøûÊé•
    if (!idb.db) await idb.init();

    for (let key of REQUIRED_KEYS) {
        try {
            let res = await idb.get('universal_store', key);
            if (res) {
                window.BIG_MEMORY[key] = res.data;
            } else {
                // Â¶ÇÊûúÊï∞ÊçÆÂ∫ìÊ≤°Êï∞ÊçÆÔºåÂ∞ùËØï‰ªé LocalStorage ËøÅÁßªÊóßÊï∞ÊçÆ (Âè™ÂÅö‰∏ÄÊ¨°)
                // ËøôÊòØ‰∏Ä‰∏™Ëá™Âä®ËøÅÁßªÊú∫Âà∂Ôºå‰øùÊä§‰Ω†ÁöÑÊóßÊï∞ÊçÆ
                const oldLocal = localStorage.getItem(key) || localStorage.getItem(key + '_list') || localStorage.getItem(key + '_data');
                if (oldLocal) {
                    try {
                        const parsed = JSON.parse(oldLocal);
                        window.BIG_MEMORY[key] = parsed;
                        // Â≠òÂÖ•Êñ∞Â∫ì
                        idb.put('universal_store', { id: key, data: parsed });
                        console.log(`‚ôªÔ∏è Â∑≤Â∞Ü [${key}] ËøÅÁßªËá≥Êó†ÈôêÂ≠òÂÇ®`);
                    } catch(e) { window.BIG_MEMORY[key] = []; }
                } else {
                    // ÈªòËÆ§ÂàùÂßãÂåñ
                    if (key === 'game_stats') window.BIG_MEMORY[key] = { mood: 50, love: 50 };
                    else if (key.includes('settings') || key === 'theme_fonts') window.BIG_MEMORY[key] = {};
                    else window.BIG_MEMORY[key] = []; 
                }
            }
        } catch (e) {
            console.error(`‚ùå Âä†ËΩΩ ${key} Â§±Ë¥•`, e);
            window.BIG_MEMORY[key] = []; // ÂÖúÂ∫ïÈò≤Ê≠¢ÁôΩÂ±è
        }
    }
    
    // 4. Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåÂà∑Êñ∞ÊâÄÊúâÁïåÈù¢
    refreshAllUI();
    console.log("üéâ [Á≥ªÁªüË°•‰∏Å] ÂÖ®Á≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂÆåÊØïÔºÅ");
};

// ËæÖÂä©ÔºöÂà∑Êñ∞ÊâÄÊúâÁïåÈù¢ UI
function refreshAllUI() {
    try {
        if(typeof renderLetterList === 'function') renderLetterList();
        if(typeof renderFinanceUI === 'function') renderFinanceUI();
        if(typeof updateGameStatsUI === 'function') updateGameStatsUI();
        if(typeof renderWitchHistory === 'function') renderWitchHistory();
        if(typeof updateSettingsUI === 'function') updateSettingsUI(); // ÂÆ†Áâ©
        if(typeof renderStudyList === 'function' && window.BIG_MEMORY.study) renderStudyList(window.BIG_MEMORY.study);
    } catch(e) { console.log("UIÂà∑Êñ∞ËΩªÂæÆÊä•Èîô (Ê≠£Â∏∏Áé∞Ë±°):", e); }
}

// ============================================================
// üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APP ‰∏ìÈ°π‰øÆÂ§ç (Ëß£ÂÜ≥ÁÇπÂáª‰øùÂ≠òÊó†ÂèçÂ∫î)
// ============================================================

// 1. Á°Æ‰øùËé∑ÂèñÊï∞ÊçÆÁöÑÂáΩÊï∞ÊòØÂÆâÂÖ®ÁöÑ
window.getWitchData = function() { 
    if (!window.BIG_MEMORY.witch_data || !Array.isArray(window.BIG_MEMORY.witch_data)) {
        window.BIG_MEMORY.witch_data = [];
    }
    return window.BIG_MEMORY.witch_data; 
};

// 2. ÈáçÂÜô‰øùÂ≠òÂáΩÊï∞ (Â¢ûÂä†ÈîôËØØÊèêÁ§∫ÂíåÂº∫Âà∂ÊâßË°å)
window.manualSaveWitchGame = function() {
    console.log("üîÆ Â∞ùËØï‰øùÂ≠òÂ•≥Â∑´Ê∏∏Êàè...");
    
    // Ê£ÄÊü•Ê∏∏ÊàèÁä∂ÊÄÅ
    if (!witchGameState || (!witchGameState.isPlaying && !witchGameState.charTrap)) {
        return alert("‚ö†Ô∏è Ê∏∏ÊàèËøòÊ≤°ÂºÄÂßãÔºàÊàñËÄÖÊï∞ÊçÆÊú™ÁîüÊàêÔºâÔºåÊó†Ê≥ï‰øùÂ≠òÔºÅ\nËØ∑ÂÖàÁÇπÂáª„ÄêüîÆ ÊäΩÁâåÊ≥®ÂÖ•ÁÅµÈ≠Ç„ÄëÂºÄÂßã‰∏ÄÂ±ÄÊ∏∏Êàè„ÄÇ");
    }

    try {
        const list = window.getWitchData(); 
        
        // ÂàõÂª∫Â≠òÊ°£ÂØπË±° (Ê∑±Â∫¶Êã∑Ë¥ùÈò≤Ê≠¢ÂºïÁî®ÈîôËØØ)
        const historyItem = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            userPunish: document.getElementById('witch-user-punishment').value || "Êó†ÊÉ©ÁΩö",
            winner: witchGameState.eatenCookies.includes(witchGameState.charTrap) ? 'User' : (witchGameState.eatenCookies.includes(witchGameState.myTrap) ? 'Char' : 'ËøõË°å‰∏≠'),
            state: JSON.parse(JSON.stringify(witchGameState)) 
        };

        // Â≠òÂÖ•Â§¥ÈÉ®
        list.unshift(historyItem);
        
        // Âº∫Âà∂‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        window.saveToBigDB('witch_data', list);
        
        alert("‚úÖ ‰øùÂ≠òÊàêÂäüÔºÅ\nÂ∑≤Â≠òÂÖ•„ÄêÂéÜÂè≤ÂØπÂ±Ä„ÄëÔºå‰Ω†ÂèØ‰ª•ÈöèÊó∂ÂõûÁúãÊàñÈáçÁé©„ÄÇ");
        
        // Âà∑Êñ∞ÂàóË°®
        if(typeof renderWitchHistory === 'function') renderWitchHistory();

    } catch (e) {
        console.error(e);
        alert("‚ùå ‰øùÂ≠òÂá∫Èîô: " + e.message);
    }
};

// 3. ÈáçÂÜôÂéÜÂè≤ËÆ∞ÂΩïÊ∏≤Êüì (Á°Æ‰øùÂà†Èô§ÊåâÈíÆÊúâÊïà)
window.renderWitchHistory = function() {
    const list = window.getWitchData();
    const container = document.getElementById('witch-history-list');
    if(!container) return;
    container.innerHTML = '';
    
    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†Â≠òÊ°£</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '15px';
        div.style.background = '#2d3436'; 
        div.style.border = '1px solid #6c5ce7';
        div.style.color = '#dfe6e9';
        
        let statusText = item.winner === 'User' ? 'üèÜ ‰Ω†Ëµ¢‰∫Ü' : (item.winner === 'Char' ? 'üíÄ ‰Ω†Ëæì‰∫Ü' : 'üíæ Â≠òÊ°£ÁÇπ');

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#b2bec3; margin-bottom:5px;">
                <span>${item.date}</span>
                <span style="color:#ff7675; cursor:pointer;" onclick="deleteWitchHistory(${index})">üóëÔ∏è Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; margin:5px 0; color:#a29bfe; font-size:1rem;">${statusText}</div>
            <div style="font-size:0.85rem; color:#b2bec3; margin-bottom:10px;">ÊÉ©ÁΩö: ${item.userPunish}</div>
            
            <div style="display:flex; gap:10px;">
                <button class="m-btn small" onclick="retryWitchGame(${index})" style="flex:1; background:#6c5ce7; color:white; border:none;">üîÑ ÈáçÁé©</button>
                <button class="m-btn small" onclick="readWitchStory(${index})" style="flex:1; background:#a29bfe; color:#2d3436; border:none;">üìñ ÁªìÂ±Ä</button>
            </div>
        `;
        container.appendChild(div);
    });
};

window.deleteWitchHistory = function(index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°Â≠òÊ°£Ôºü")) return;
    const list = window.getWitchData();
    list.splice(index, 1);
    window.saveToBigDB('witch_data', list);
    window.renderWitchHistory();
};

// ============================================================
// üîÑ ÂÖ®Â±ÄÂäüËÉΩÈáçÂÜô (Â∞ÜÊóßÁâà localStorage ÊõøÊç¢‰∏∫Êó†ÈôêÂ≠òÂÇ®)
// ============================================================

// 1. ËÆ∞Ë¥¶ (Finance)
window.getFinanceData = function() { return window.BIG_MEMORY.finance || []; };
window.addFinanceRecord = function(category, type) {
    // ... (‰øùÁïôÂéüÈÄªËæëÔºå‰ΩÜÊîπÁî® saveToBigDB)
    const amountIn = document.getElementById('finance-amount');
    const val = parseFloat(amountIn.value);
    if (!val || val <= 0) return alert("ËØ∑ËæìÂÖ•ÈáëÈ¢ù");
    
    // ÁÆÄÂçïËé∑ÂèñÊèèËø∞
    const desc = type==='expense'?'ÊîØÂá∫':'Êî∂ÂÖ•'; 
    const record = { id: Date.now(), date: new Date().toISOString(), category, type, amount: val, desc };
    
    const data = window.getFinanceData();
    data.unshift(record);
    window.saveToBigDB('finance', data); // ‰øùÂ≠ò
    
    amountIn.value = '';
    if(typeof renderFinanceUI === 'function') renderFinanceUI();
};
window.deleteFinance = function(id) {
    if(confirm("Âà†Èô§Ê≠§Ë¥¶ÁõÆÔºü")) {
        let data = window.getFinanceData();
        data = data.filter(i => i.id !== id);
        window.saveToBigDB('finance', data);
        if(typeof renderFinanceUI === 'function') renderFinanceUI();
    }
};

// 2. ‰ø°‰ª∂ (Letters)
window.getLetters = function() { return window.BIG_MEMORY.letters || []; };
window.saveLetters = function(data) { window.saveToBigDB('letters', data); };

// 3. Â≠¶‰π†ËÆ°Âàí (Study)
window.getStudyData = function() { return window.BIG_MEMORY.study; };
window.saveStudyData = function(data) { window.saveToBigDB('study', data); };
window.deleteStudyPlan = function() {
    if(confirm("Âà†Èô§ÂΩìÂâçËÆ°ÂàíÔºü")) {
        window.saveToBigDB('study', null);
        if(typeof renderStudyApp === 'function') renderStudyApp();
    }
};

// 4. ÁªèÊúü (Period)
window.getPeriodData = function() { return window.BIG_MEMORY.period || {records:[], isBleeding:false}; };
window.savePeriodData = function(data) { window.saveToBigDB('period', data); };

// 5. Â§áÂøòÂΩï (Memo)
window.saveMemoToLocal = function() {
    const text = document.getElementById('memo-full-text').value;
    window.saveToBigDB('memo', text);
    document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæë...";
};
window.loadMemoFromLocal = function() {
    const text = window.BIG_MEMORY.memo || "";
    if(document.getElementById('memo-full-text')) document.getElementById('memo-full-text').value = text;
    if(document.getElementById('desktop-memo-text')) document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæë...";
};

// 6. Ê∏∏ÊàèÊú∫Áä∂ÊÄÅ (Game Stats)
window.updateGameStatsUI = function() {
    // ÁÆÄÂçïÁöÑÊõ¥Êñ∞ UI ÈÄªËæë
    const mood = window.gameState ? window.gameState.mood : 50;
    const love = window.gameState ? window.gameState.love : 50;
    if(document.getElementById('bar-mood')) {
        document.getElementById('bar-mood').style.width = mood + '%';
        document.getElementById('val-mood').innerText = mood;
        document.getElementById('bar-love').style.width = love + '%';
        document.getElementById('val-love').innerText = love;
    }
    window.saveToBigDB('game_stats', { mood, love });
};

// ============================================================
// üèÅ Âº∫Âà∂ÂêØÂä®ÈÄªËæë (Ë¶ÜÁõñÂéüÊúâÁöÑ window.onload)
// ============================================================
window.addEventListener('load', function() {
    console.log("‚ö° [Ë°•‰∏Å] È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂàùÂßãÂåñÁ≥ªÁªü...");
    
    // Âª∂Ëøü‰∏ÄÁÇπÁÇπÔºåÁ°Æ‰øù IDB Â∫ìÂ∑≤Âä†ËΩΩ
    setTimeout(() => {
        idb.init().then(async () => {
            await window.loadAllBigData();
            
            // È¢ùÂ§ñÁöÑÂàùÂßãÂåñ
            if(typeof loadTVContent === 'function') loadTVContent();
            if(typeof loadMemoFromLocal === 'function') loadMemoFromLocal();
            
            // ÁªëÂÆöÂ•≥Â∑´ÁöÑ‰øùÂ≠òÊåâÈíÆ (Èò≤Ê≠¢ onclick Âú® HTML ‰∏≠Â§±Êïà)
            const witchSaveBtn = document.querySelector('#witch-log-panel button[onclick="manualSaveWitchGame()"]');
            if(witchSaveBtn) {
                witchSaveBtn.onclick = function() { window.manualSaveWitchGame(); };
            }
            
            console.log("‚úÖ [Ë°•‰∏Å] Á≥ªÁªüÂ∞±Áª™ÔºåÊâÄÊúâÂäüËÉΩÂ∑≤ÂàáÊç¢Ëá≥Êó†ÈôêÂ≠òÂÇ®„ÄÇ");
        });
    }, 500);
});

</script>
<script>
/**
 * =================================================================
 * üöÄ RetroOS ÁªàÊûÅÁ≥ªÁªüË°•‰∏Å (Êó†ÈôêÂ≠òÂÇ® + Â•≥Â∑´‰øÆÂ§ç + ÂÖ®Â±ÄÂÖºÂÆπ)
 * =================================================================
 */
// 1. Âº∫Âà∂ÂàùÂßãÂåñÂ§ßÂÆπÈáèÂÜÖÂ≠òÁªìÊûÑ
window.BIG_MEMORY = window.BIG_MEMORY || {};
const REQUIRED_KEYS = [
    'world_book', 'letters', 'finance', 'study', 'period', 'memo', 
    'chat_settings', 'theme_fonts', 'api_profiles', 'thesaurus_data', 
    'game_history', 'game_stats', 'tarot_history', 'his_phone_history', 
    'dream_history', 'forum_data', 'pickup_data', 'diary_history', 
    'pet_data', 'lofter_data', 'pain_data', 'gashapon_history', 
    'shadow_data', 'rpg_data', 'moving_data', 'teaching_data', 
    'companion_data', 'summary_data', 'galgame_data', 'scent_data', 
    'puzzle_data', 'work_data', 'witch_data', 'gacha_data', 'tacit_data',
    'adv_data' // üëàüî• ÂøÖÈ°ªË¶ÅÊúâËøô‰∏ÄÈ°πÔºåÊñáÊ∏∏Êï∞ÊçÆÊâçËÉΩË¢´ÂØºÂá∫ÔºÅ
];

// 2. ÈÄöÁî®‰øùÂ≠òÂáΩÊï∞ (ÂÜôÂÖ• IndexedDB Êó†ÈôêÂ≠òÂÇ®)
window.saveToBigDB = function(key, data) {
    // Êõ¥Êñ∞ÂÜÖÂ≠ò
    window.BIG_MEMORY[key] = data;
    // ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
    if (typeof idb !== 'undefined') {
        // ÂÖºÂÆπ‰∏çÂêåÁöÑ key ÂÜôÊ≥ï (Êúâ‰∫õÊòØ _data ÁªìÂ∞æÔºåÊúâ‰∫õ‰∏çÊòØÔºåÁªü‰∏ÄÂ§ÑÁêÜ)
        idb.put('universal_store', { id: key, data: data });
    }
};

// 3. ÂÖ®ÈáèÊï∞ÊçÆÂä†ËΩΩÂô® (ÂºÄÊú∫Êó∂ÊääÊâÄÊúâÊï∞ÊçÆ‰ªéÊï∞ÊçÆÂ∫ìÊãâËøõÂÜÖÂ≠ò)
window.loadAllBigData = async function() {
    console.log("üöÄ [Á≥ªÁªüË°•‰∏Å] Ê≠£Âú®ÂêØÂä®Êó†ÈôêÂÆπÈáèÂºïÊìé...");
    
    // Á°Æ‰øù idb Â∑≤ËøûÊé•
    if (!idb.db) await idb.init();

    for (let key of REQUIRED_KEYS) {
        try {
            let res = await idb.get('universal_store', key);
            if (res) {
                window.BIG_MEMORY[key] = res.data;
            } else {
                // Â¶ÇÊûúÊï∞ÊçÆÂ∫ìÊ≤°Êï∞ÊçÆÔºåÂ∞ùËØï‰ªé LocalStorage ËøÅÁßªÊóßÊï∞ÊçÆ (Âè™ÂÅö‰∏ÄÊ¨°)
                // ËøôÊòØ‰∏Ä‰∏™Ëá™Âä®ËøÅÁßªÊú∫Âà∂Ôºå‰øùÊä§‰Ω†ÁöÑÊóßÊï∞ÊçÆ
                const oldLocal = localStorage.getItem(key) || localStorage.getItem(key + '_list') || localStorage.getItem(key + '_data');
                if (oldLocal) {
                    try {
                        const parsed = JSON.parse(oldLocal);
                        window.BIG_MEMORY[key] = parsed;
                        // Â≠òÂÖ•Êñ∞Â∫ì
                        idb.put('universal_store', { id: key, data: parsed });
                        console.log(`‚ôªÔ∏è Â∑≤Â∞Ü [${key}] ËøÅÁßªËá≥Êó†ÈôêÂ≠òÂÇ®`);
                    } catch(e) { window.BIG_MEMORY[key] = []; }
                } else {
                    // ÈªòËÆ§ÂàùÂßãÂåñ
                    if (key === 'game_stats') window.BIG_MEMORY[key] = { mood: 50, love: 50 };
                    else if (key.includes('settings') || key === 'theme_fonts') window.BIG_MEMORY[key] = {};
                    else window.BIG_MEMORY[key] = []; 
                }
            }
        } catch (e) {
            console.error(`‚ùå Âä†ËΩΩ ${key} Â§±Ë¥•`, e);
            window.BIG_MEMORY[key] = []; // ÂÖúÂ∫ïÈò≤Ê≠¢ÁôΩÂ±è
        }
    }
    
    // 4. Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåÂà∑Êñ∞ÊâÄÊúâÁïåÈù¢
    refreshAllUI();
    console.log("üéâ [Á≥ªÁªüË°•‰∏Å] ÂÖ®Á≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂÆåÊØïÔºÅ");
};

// ËæÖÂä©ÔºöÂà∑Êñ∞ÊâÄÊúâÁïåÈù¢ UI
function refreshAllUI() {
    try {
        if(typeof renderLetterList === 'function') renderLetterList();
        if(typeof renderFinanceUI === 'function') renderFinanceUI();
        if(typeof updateGameStatsUI === 'function') updateGameStatsUI();
        if(typeof renderWitchHistory === 'function') renderWitchHistory();
        if(typeof updateSettingsUI === 'function') updateSettingsUI(); // ÂÆ†Áâ©
        if(typeof renderStudyList === 'function' && window.BIG_MEMORY.study) renderStudyList(window.BIG_MEMORY.study);
    } catch(e) { console.log("UIÂà∑Êñ∞ËΩªÂæÆÊä•Èîô (Ê≠£Â∏∏Áé∞Ë±°):", e); }
}

// ============================================================
// üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APP ‰∏ìÈ°π‰øÆÂ§ç (Ëß£ÂÜ≥ÁÇπÂáª‰øùÂ≠òÊó†ÂèçÂ∫î)
// ============================================================

// 1. Á°Æ‰øùËé∑ÂèñÊï∞ÊçÆÁöÑÂáΩÊï∞ÊòØÂÆâÂÖ®ÁöÑ
window.getWitchData = function() { 
    if (!window.BIG_MEMORY.witch_data || !Array.isArray(window.BIG_MEMORY.witch_data)) {
        window.BIG_MEMORY.witch_data = [];
    }
    return window.BIG_MEMORY.witch_data; 
};

// 2. ÈáçÂÜô‰øùÂ≠òÂáΩÊï∞ (Â¢ûÂä†ÈîôËØØÊèêÁ§∫ÂíåÂº∫Âà∂ÊâßË°å)
window.manualSaveWitchGame = function() {
    console.log("üîÆ Â∞ùËØï‰øùÂ≠òÂ•≥Â∑´Ê∏∏Êàè...");
    
    // Ê£ÄÊü•Ê∏∏ÊàèÁä∂ÊÄÅ
    if (!witchGameState || (!witchGameState.isPlaying && !witchGameState.charTrap)) {
        return alert("‚ö†Ô∏è Ê∏∏ÊàèËøòÊ≤°ÂºÄÂßãÔºàÊàñËÄÖÊï∞ÊçÆÊú™ÁîüÊàêÔºâÔºåÊó†Ê≥ï‰øùÂ≠òÔºÅ\nËØ∑ÂÖàÁÇπÂáª„ÄêüîÆ ÊäΩÁâåÊ≥®ÂÖ•ÁÅµÈ≠Ç„ÄëÂºÄÂßã‰∏ÄÂ±ÄÊ∏∏Êàè„ÄÇ");
    }

    try {
        const list = window.getWitchData(); 
        
        // ÂàõÂª∫Â≠òÊ°£ÂØπË±° (Ê∑±Â∫¶Êã∑Ë¥ùÈò≤Ê≠¢ÂºïÁî®ÈîôËØØ)
        const historyItem = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            userPunish: document.getElementById('witch-user-punishment').value || "Êó†ÊÉ©ÁΩö",
            winner: witchGameState.eatenCookies.includes(witchGameState.charTrap) ? 'User' : (witchGameState.eatenCookies.includes(witchGameState.myTrap) ? 'Char' : 'ËøõË°å‰∏≠'),
            state: JSON.parse(JSON.stringify(witchGameState)) 
        };

        // Â≠òÂÖ•Â§¥ÈÉ®
        list.unshift(historyItem);
        
        // Âº∫Âà∂‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        window.saveToBigDB('witch_data', list);
        
        alert("‚úÖ ‰øùÂ≠òÊàêÂäüÔºÅ\nÂ∑≤Â≠òÂÖ•„ÄêÂéÜÂè≤ÂØπÂ±Ä„ÄëÔºå‰Ω†ÂèØ‰ª•ÈöèÊó∂ÂõûÁúãÊàñÈáçÁé©„ÄÇ");
        
        // Âà∑Êñ∞ÂàóË°®
        if(typeof renderWitchHistory === 'function') renderWitchHistory();

    } catch (e) {
        console.error(e);
        alert("‚ùå ‰øùÂ≠òÂá∫Èîô: " + e.message);
    }
};

// 3. ÈáçÂÜôÂéÜÂè≤ËÆ∞ÂΩïÊ∏≤Êüì (Á°Æ‰øùÂà†Èô§ÊåâÈíÆÊúâÊïà)
window.renderWitchHistory = function() {
    const list = window.getWitchData();
    const container = document.getElementById('witch-history-list');
    if(!container) return;
    container.innerHTML = '';
    
    if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†Â≠òÊ°£</div>';
        return;
    }

    list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'morandi-card';
        div.style.marginBottom = '10px'; div.style.padding = '15px';
        div.style.background = '#2d3436'; 
        div.style.border = '1px solid #6c5ce7';
        div.style.color = '#dfe6e9';
        
        let statusText = item.winner === 'User' ? 'üèÜ ‰Ω†Ëµ¢‰∫Ü' : (item.winner === 'Char' ? 'üíÄ ‰Ω†Ëæì‰∫Ü' : 'üíæ Â≠òÊ°£ÁÇπ');

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#b2bec3; margin-bottom:5px;">
                <span>${item.date}</span>
                <span style="color:#ff7675; cursor:pointer;" onclick="deleteWitchHistory(${index})">üóëÔ∏è Âà†Èô§</span>
            </div>
            <div style="font-weight:bold; margin:5px 0; color:#a29bfe; font-size:1rem;">${statusText}</div>
            <div style="font-size:0.85rem; color:#b2bec3; margin-bottom:10px;">ÊÉ©ÁΩö: ${item.userPunish}</div>
            
            <div style="display:flex; gap:10px;">
                <button class="m-btn small" onclick="retryWitchGame(${index})" style="flex:1; background:#6c5ce7; color:white; border:none;">üîÑ ÈáçÁé©</button>
                <button class="m-btn small" onclick="readWitchStory(${index})" style="flex:1; background:#a29bfe; color:#2d3436; border:none;">üìñ ÁªìÂ±Ä</button>
            </div>
        `;
        container.appendChild(div);
    });
};

window.deleteWitchHistory = function(index) {
    if(!confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°Â≠òÊ°£Ôºü")) return;
    const list = window.getWitchData();
    list.splice(index, 1);
    window.saveToBigDB('witch_data', list);
    window.renderWitchHistory();
};

// ============================================================
// üîÑ ÂÖ®Â±ÄÂäüËÉΩÈáçÂÜô (Â∞ÜÊóßÁâà localStorage ÊõøÊç¢‰∏∫Êó†ÈôêÂ≠òÂÇ®)
// ============================================================

// 1. ËÆ∞Ë¥¶ (Finance)
window.getFinanceData = function() { return window.BIG_MEMORY.finance || []; };
window.addFinanceRecord = function(category, type) {
    // ... (‰øùÁïôÂéüÈÄªËæëÔºå‰ΩÜÊîπÁî® saveToBigDB)
    const amountIn = document.getElementById('finance-amount');
    const val = parseFloat(amountIn.value);
    if (!val || val <= 0) return alert("ËØ∑ËæìÂÖ•ÈáëÈ¢ù");
    
    // ÁÆÄÂçïËé∑ÂèñÊèèËø∞
    const desc = type==='expense'?'ÊîØÂá∫':'Êî∂ÂÖ•'; 
    const record = { id: Date.now(), date: new Date().toISOString(), category, type, amount: val, desc };
    
    const data = window.getFinanceData();
    data.unshift(record);
    window.saveToBigDB('finance', data); // ‰øùÂ≠ò
    
    amountIn.value = '';
    if(typeof renderFinanceUI === 'function') renderFinanceUI();
};
window.deleteFinance = function(id) {
    if(confirm("Âà†Èô§Ê≠§Ë¥¶ÁõÆÔºü")) {
        let data = window.getFinanceData();
        data = data.filter(i => i.id !== id);
        window.saveToBigDB('finance', data);
        if(typeof renderFinanceUI === 'function') renderFinanceUI();
    }
};

// 2. ‰ø°‰ª∂ (Letters)
window.getLetters = function() { return window.BIG_MEMORY.letters || []; };
window.saveLetters = function(data) { window.saveToBigDB('letters', data); };

// 3. Â≠¶‰π†ËÆ°Âàí (Study)
window.getStudyData = function() { return window.BIG_MEMORY.study; };
window.saveStudyData = function(data) { window.saveToBigDB('study', data); };
window.deleteStudyPlan = function() {
    if(confirm("Âà†Èô§ÂΩìÂâçËÆ°ÂàíÔºü")) {
        window.saveToBigDB('study', null);
        if(typeof renderStudyApp === 'function') renderStudyApp();
    }
};

// 4. ÁªèÊúü (Period)
window.getPeriodData = function() { return window.BIG_MEMORY.period || {records:[], isBleeding:false}; };
window.savePeriodData = function(data) { window.saveToBigDB('period', data); };

// 5. Â§áÂøòÂΩï (Memo)
window.saveMemoToLocal = function() {
    const text = document.getElementById('memo-full-text').value;
    window.saveToBigDB('memo', text);
    document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæë...";
};
window.loadMemoFromLocal = function() {
    const text = window.BIG_MEMORY.memo || "";
    if(document.getElementById('memo-full-text')) document.getElementById('memo-full-text').value = text;
    if(document.getElementById('desktop-memo-text')) document.getElementById('desktop-memo-text').innerText = text || "ÁÇπÂáªÁºñËæë...";
};

// 6. Ê∏∏ÊàèÊú∫Áä∂ÊÄÅ (Game Stats)
window.updateGameStatsUI = function() {
    // ÁÆÄÂçïÁöÑÊõ¥Êñ∞ UI ÈÄªËæë
    const mood = window.gameState ? window.gameState.mood : 50;
    const love = window.gameState ? window.gameState.love : 50;
    if(document.getElementById('bar-mood')) {
        document.getElementById('bar-mood').style.width = mood + '%';
        document.getElementById('val-mood').innerText = mood;
        document.getElementById('bar-love').style.width = love + '%';
        document.getElementById('val-love').innerText = love;
    }
    window.saveToBigDB('game_stats', { mood, love });
};

// ============================================================
// üèÅ Âº∫Âà∂ÂêØÂä®ÈÄªËæë (Ë¶ÜÁõñÂéüÊúâÁöÑ window.onload)
// ============================================================
window.addEventListener('load', function() {
    console.log("‚ö° [Ë°•‰∏Å] È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂàùÂßãÂåñÁ≥ªÁªü...");
    
    // Âª∂Ëøü‰∏ÄÁÇπÁÇπÔºåÁ°Æ‰øù IDB Â∫ìÂ∑≤Âä†ËΩΩ
    setTimeout(() => {
        idb.init().then(async () => {
            await window.loadAllBigData();
            
            // È¢ùÂ§ñÁöÑÂàùÂßãÂåñ
            if(typeof loadTVContent === 'function') loadTVContent();
            if(typeof loadMemoFromLocal === 'function') loadMemoFromLocal();
            
            // üî• Êñ∞Â¢ûÔºöÂä†ËΩΩÂÖ®Â±Ä CSS
            if(typeof applyGlobalCSS === 'function') applyGlobalCSS();
            
            // Âä†ËΩΩÊ∏∏ÊàèÊú∫ÁöÆËÇ§
            if(typeof loadGameWidgetTheme === 'function') loadGameWidgetTheme();
            try { await idb.get('settings_heavy', 'myAvatar'); } catch(e){}

            // ÁªëÂÆöÂ•≥Â∑´ÁöÑ‰øùÂ≠òÊåâÈíÆ
            const witchSaveBtn = document.querySelector('#witch-log-panel button[onclick="manualSaveWitchGame()"]');
            if(witchSaveBtn) {
                witchSaveBtn.onclick = function() { window.manualSaveWitchGame(); };
            }
            
            console.log("‚úÖ [Ë°•‰∏Å] Á≥ªÁªüÂ∞±Áª™ÔºåÊó†ÈôêÂ≠òÂÇ®‰∏éÂÖ®Â±ÄÊ†∑ÂºèÂ∑≤ÊøÄÊ¥ª„ÄÇ");
        });
    }, 500);
});
// ==================== üßπ ‰∏ÄÈîÆÁò¶Ë∫´Â∑•ÂÖ∑ (Êó†ÈúÄÈáçÊñ∞‰∏ä‰º†) ====================

// Ê†∏ÂøÉÔºöÂ§ÑÁêÜÂçïÂº† Base64 ÂõæÁâáÂ≠óÁ¨¶‰∏≤
function optimizeBase64(base64Str) {
    return new Promise((resolve) => {
        // 1. Â¶ÇÊûú‰∏çÊòØÂõæÁâáÔºåÊàñËÄÖÊòØ GIFÔºåÊàñËÄÖÂ§™Â∞è(<500KB)ÔºåÁõ¥Êé•ÂéüÊ†∑ËøîÂõû
        if (!base64Str || typeof base64Str !== 'string' || !base64Str.startsWith('data:image')) {
            return resolve(base64Str);
        }
        if (base64Str.startsWith('data:image/gif')) {
            return resolve(base64Str); // ‰øùÊä§ GIF ‰∏çÂä®
        }
        if (base64Str.length < 600000) { 
            return resolve(base64Str); // Â∞è‰∫éÁ∫¶450KBÁöÑ‰∏çÂä®
        }

        // 2. ÂºÄÂßãÂéãÁº©
        const img = new Image();
        img.src = base64Str;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // ÈôêÂà∂ÊúÄÂ§ßÂÆΩÈ´ò 1280 (Ë∂≥Â§üÊâãÊú∫Áúã‰∫Ü)
            const MAX_SIZE = 1280;
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
            } else {
                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            // Â¶ÇÊûúÂéüÂõæÊòØ PNGÔºå‰øùÊåÅ PNG (Èò≤ÈªëÂ∫ï)ÔºåÂê¶ÂàôËΩ¨ JPG 0.7
            let type = 'image/jpeg';
            let quality = 0.7;
            if (base64Str.startsWith('data:image/png')) {
                type = 'image/png';
                quality = 0.8; 
            }

            resolve(canvas.toDataURL(type, quality));
        };
        img.onerror = () => resolve(base64Str); // ÂùèÂõæÁõ¥Êé•Ë∑≥Ëøá
    });
}
// ==================== üßπ ÁªàÊûÅÂÜÖÂ≠òÊïëÊè¥ (ÂÖ®Ë¶ÜÁõñÁâà) ====================
// ==================== üßπ ÁªàÊûÅÂÜÖÂ≠òÊïëÊè¥ Pro (Âê´Êñá‰ª∂Â∫ìÂéãÁº©) ====================
// ==================== üßπ ÁªàÊûÅÂÜÖÂ≠òÊïëÊè¥ (Âç°ÁâåÊûÅÈôêÂéãÁº©Áâà) ====================
async function runSystemOptimization() {
    const btn = document.getElementById('btn-optimize-start');
    if(btn) { btn.innerText = "üßπ Ê≠£Âú®ÊûÅÈôêÂéãÁº© (ÂèØËÉΩÈúÄË¶Å1ÂàÜÈíü)..."; btn.disabled = true; }
    
    let totalFreed = 0;
    let count = 0;

    // --- ÈÄöÁî®ÂéãÁº© (ÁîªË¥®0.7, ÂÆΩ1280) ---
    function optimizeNormal(base64Str) {
        return new Promise((resolve) => {
            if (!base64Str || typeof base64Str !== 'string' || !base64Str.startsWith('data:image')) return resolve(base64Str);
            if (base64Str.startsWith('data:image/gif') || base64Str.length < 500000) return resolve(base64Str); // GIFÊàñÂ∞èÂõæË∑≥Ëøá

            const img = new Image();
            img.src = base64Str;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX = 1280; // ÊôÆÈÄöÂõæÁâá‰øùÊåÅÊ∏ÖÊô∞
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } } 
                else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                let type = 'image/jpeg', q = 0.7;
                if (base64Str.startsWith('data:image/png')) { type = 'image/png'; q = 0.8; }
                resolve(canvas.toDataURL(type, q));
            };
            img.onerror = () => resolve(base64Str);
        });
    }

    // --- üî• Âç°ÁâåÊûÅÈôêÂéãÁº© (ÁîªË¥®0.4, ÂÆΩ480) ---
    function optimizeCard(base64Str) {
        return new Promise((resolve) => {
            if (!base64Str || typeof base64Str !== 'string' || !base64Str.startsWith('data:image')) return resolve(base64Str);
            // Âç°Áâå‰∏çÈúÄË¶ÅGIFÂà§Êñ≠ÔºåÂÖ®ÈÉ®Âéã
            
            const img = new Image();
            img.src = base64Str;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX = 480; // ‚ö°Ô∏è Áº©Â∞èÂà∞ÊâãÊú∫Â±èÂπïÂç°ÁâáÂ§ßÂ∞è
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } } 
                else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                // ‚ö°Ô∏è Âº∫Âà∂ËΩ¨ JPGÔºåÁîªË¥® 0.4 (Ê®°Á≥ä‰∏ÄÁÇπ‰ΩÜ‰ΩìÁßØÊûÅÂ∞è)
                resolve(canvas.toDataURL('image/jpeg', 0.4));
            };
            img.onerror = () => resolve(base64Str);
        });
    }

    // ËæÖÂä©ÔºöÂ§ÑÁêÜÂØπË±°Êï∞ÁªÑ
    async function processArrayImages(arrayName, fieldName) {
        let list = window.BIG_MEMORY[arrayName];
        if (!list || list.length === 0) {
            const res = await idb.get('universal_store', arrayName);
            if (res) list = res.data;
        }
        if (!list || !Array.isArray(list)) return;

        let changed = false;
        for (let item of list) {
            if (item[fieldName]) {
                const oldLen = item[fieldName].length;
                const newData = await optimizeNormal(item[fieldName]); // ÊôÆÈÄöÂéãÁº©
                if (newData.length < oldLen) {
                    totalFreed += (oldLen - newData.length);
                    item[fieldName] = newData;
                    changed = true;
                    count++;
                }
            }
        }
        if (changed) {
            window.BIG_MEMORY[arrayName] = list;
            await idb.put('universal_store', { id: arrayName, data: list });
        }
    }

    // ËæÖÂä©ÔºöÂ§ÑÁêÜÂç°ÁâåÂ∫ì (‰ΩøÁî®ÊûÅÈôêÂéãÁº©)
    async function processDeckStore(storeName) {
        const items = await idb.getAll(storeName);
        for (let item of items) {
            if (item.data) {
                const oldLen = item.data.length;
                // Âè™Ë¶ÅÂ§ß‰∫é 100KB Â∞±ÂéãÔºåÂç°Áâå‰∏çÈúÄË¶ÅÂ§™È´òÊ∏Ö
                if (oldLen > 100000) { 
                    const newData = await optimizeCard(item.data); // üî• ‰ΩøÁî®ÊûÅÈôêÂéãÁº©
                    if (newData.length < oldLen) {
                        totalFreed += (oldLen - newData.length);
                        item.data = newData;
                        await idb.put(storeName, item);
                        count++;
                    }
                }
            }
        }
    }

    try {
        console.log("üöÄ ÂºÄÂßãÂéãÁº©...");

        // 1. Â§ÑÁêÜÁæéÂåñÁ¥†Êùê (ÊôÆÈÄöÂéãÁº©)
        const settings = await idb.getAll('settings_heavy');
        for (let item of settings) {
            const newData = await optimizeNormal(item.data);
            if (newData.length < item.data.length) {
                totalFreed += (item.data.length - newData.length);
                item.data = newData;
                await idb.put('settings_heavy', item);
                count++;
            }
        }
        
        // 2. Â§ÑÁêÜËÅäÂ§©ËÆ∞ÂΩï (ÊôÆÈÄöÂéãÁº©)
        const chatMsgs = await idb.getAll('chat_history');
        for (let msg of chatMsgs) {
            if (msg.type === 'image' && msg.text) {
                const newData = await optimizeNormal(msg.text);
                if (newData.length < msg.text.length) {
                    totalFreed += (msg.text.length - newData.length);
                    msg.text = newData;
                    await idb.put('chat_history', msg);
                    count++;
                }
            }
        }

        // 3. Â§ÑÁêÜÂêÑ‰∏™APPÁöÑÂéÜÂè≤ÂõæÁâá (ÊôÆÈÄöÂéãÁº©)
        await processArrayImages('chat_collections', 'text');
        await processArrayImages('puzzle_data', 'img'); 
        
        // 4. üî• Â§ÑÁêÜÂç°ÁâåÂ∫ì (ÊûÅÈôêÂéãÁº©)
        await processDeckStore('tarot_deck');
        await processDeckStore('lenormand_deck');
        
        // 5. Ë°®ÊÉÖÂåÖ (ÊôÆÈÄöÂéãÁº©)
        const stickers = await idb.getAll('chat_stickers');
        for (let item of stickers) {
            const newData = await optimizeNormal(item.data);
            if (newData.length < item.data.length) {
                totalFreed += (item.data.length - newData.length);
                item.data = newData;
                await idb.put('chat_stickers', item);
                count++;
            }
        }

        const mbFreed = (totalFreed / 1024 / 1024).toFixed(2);
        alert(`üéâ ÊûÅÈôêÁò¶Ë∫´ÂÆåÊàêÔºÅ\n\nÂ§ÑÁêÜÂõæÁâáÔºö${count} Âº†\nÈáäÊîæÁ©∫Èó¥Ôºö${mbFreed} MB\n\nÂç°ÁâåÂ∑≤Â§ßÂπÖÂéãÁº©ÔºåÁ≥ªÁªüÂ∞ÜÊõ¥ÊµÅÁïÖ„ÄÇ`);
        location.reload();

    } catch (e) {
        console.error(e);
        alert("‰ºòÂåñ‰∏≠Êñ≠Ôºö" + e.message);
        if(btn) btn.disabled = false;
    }
}
</script>
<script>
// ============================================================
// üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APP ‰øÆÊîπË°•‰∏ÅÔºöÂ∞ÜÈ•ºÂπ≤Êï∞ÈáèÊîπ‰∏∫ 19 Âùó
// ============================================================

// 1. ‰øÆÊîπÊ£ãÁõòÂàùÂßãÂåñÈÄªËæë (ÁîüÊàê 19 ‰∏™È•ºÂπ≤)
window.initWitchBoard = function(mode = 'new', data = null) {
    const grid = document.getElementById('witch-board-container');
    if(!grid) return;
    grid.innerHTML = '';
    
    // --- Ê®°Âºè A: Êñ∞Ê∏∏Êàè ---
    if (mode === 'new') {
        witchGameState = {
            myTrap: -1, charTrap: -1, charPunishment: "",
            charMoves: [], reactions: {}, stories: null,
            eatenCookies: [], isMyTurn: true, isPlaying: false, history: []
        };
        document.getElementById('witch-setup-panel').style.display = 'block';
        document.getElementById('btn-witch-start').style.display = 'block';
        document.getElementById('witch-log-panel').style.display = 'none';
        
        const punishInput = document.getElementById('witch-user-punishment');
        if(punishInput) punishInput.value = "";
        const trapDisplay = document.getElementById('witch-trap-display');
        if(trapDisplay) trapDisplay.innerText = "Êú™ÈÄâÊã©";
    }
    // --- Ê®°Âºè B: ÂéÜÂè≤ÂõûÊîæ ---
    else if (mode === 'replay') {
        witchGameState = JSON.parse(JSON.stringify(data));
        witchGameState.isPlaying = false;
        
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        document.getElementById('witch-reaction-text').innerText = "üìö ÂéÜÂè≤ÂõûÊîæÊ®°Âºè";
    }
    // --- Ê®°Âºè C: ÈáçÊñ∞ÊåëÊàò ---
    else if (mode === 'retry') {
        witchGameState = JSON.parse(JSON.stringify(data));
        witchGameState.eatenCookies = []; 
        witchGameState.isPlaying = true;
        witchGameState.isMyTurn = true;
        
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        document.getElementById('witch-reaction-text').innerText = "üîÑ ÈáçÊñ∞ÊåëÊàòÔºöËØ∑ÂºÄÂßã...";
    }

    // üî•üî•üî• ‰øÆÊîπÁÇπÔºöÂæ™ÁéØÊ¨°Êï∞Êîπ‰∏∫ 19 üî•üî•üî•
    for (let i = 0; i < 19; i++) {
        const btn = document.createElement('div');
        btn.className = 'cookie-btn';
        btn.id = `cookie-${i}`;
        
        if (mode === 'replay') {
            if (witchGameState.eatenCookies.includes(i)) {
                btn.classList.add('eaten');
                btn.innerText = '';
                if (i === witchGameState.myTrap) { btn.innerText = 'üòà'; btn.style.background = '#00cec9'; }
                if (i === witchGameState.charTrap) { btn.innerText = 'üíÄ'; btn.style.background = '#d63031'; }
            } else {
                btn.innerText = 'üêª';
            }
        } 
        else if (mode === 'retry') {
            btn.innerText = 'üêª';
            btn.onclick = () => handleCookieClick(i);
            if (i === witchGameState.myTrap) btn.style.border = "2px solid #00cec9"; 
        }
        else {
            btn.innerText = 'üêª';
            btn.onclick = () => handleCookieClick(i);
        }
        grid.appendChild(btn);
    }
};

// ============================================================
// üßô‚Äç‚ôÄÔ∏è Â•≥Â∑´ APP ‰øÆÂ§çÔºö‰øùÁïôÂéüÁâàÈ´òË¥®Èáè Prompt (19ÂùóÈ•ºÂπ≤Áâà)
// ============================================================

window.finishWitchDraw = async function() {
    if(witchFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#witch-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üîÆ Ê≠£Âú®ÁºñÁªá 19 ÂùóÈ•ºÂπ≤ÁöÑÂëΩËøê...";

    // ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = witchFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const userPunish = document.getElementById('witch-user-punishment').value;
    const userTrapIdx = witchGameState.myTrap;

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    if(!apiKey) { try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} }
    if(!apiKey) { btn.innerText = oldText; btn.disabled = false; return alert("ËØ∑ÈÖçÁΩÆ API Key"); }

    // üî•üî•üî• Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî®ÂéüÁâàËØ¶ÁªÜ PromptÔºå‰ªÖ‰øÆÊîπÊï∞Â≠óËåÉÂõ¥ (0-18) üî•üî•üî•
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™ÊìÖÈïøÂÜô‚ÄúÊÉ©ÁΩöÊ∏∏Êàè‚ÄùÂâßÊÉÖÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„ÄêÊ∏∏ÊàèËßÑÂàô„ÄëÔºöÁî®Êà∑(Êàë)ÂíåËßíËâ≤(Ta)Áé©ÂêÉÈ•ºÂπ≤ÔºåÊ°å‰∏äÂÖ±Êúâ 19 ÂùóÈ•ºÂπ≤„ÄÇÂêÉÂà∞Èô∑Èò±ÁöÑ‰∫∫Êé•ÂèóÊÉ©ÁΩö„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÂëΩËøêÁâå (ÂÜ≥ÂÆöÊÉ©ÁΩöÁöÑÂ∞∫Â∫¶ÂíåÊ∞õÂõ¥)„ÄëÔºö${cardsDesc}
„ÄêÁî®Êà∑ËÆæÂÆöÁöÑÊÉ©ÁΩö (Â¶ÇÊûúËßíËâ≤Ëæì‰∫Ü)„ÄëÔºö${userPunish}
„ÄêÁî®Êà∑Èô∑Èò±‰ΩçÁΩÆ„ÄëÔºö#${userTrapIdx} (0-18)

„Äê‚ö°Ô∏è Ê†∏ÂøÉÂéüÂàô„ÄëÔºö
**ÊâÄÊúâÁîüÊàêÁöÑÂÜÖÂÆπÔºàÈô∑Èò±ÈÄâÊã©„ÄÅÂèçÂ∫îÂè∞ËØç„ÄÅÊïÖ‰∫ãËµ∞ÂêëÔºâÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÊäΩÂà∞ÁöÑ„ÄêÂëΩËøêÁâå„ÄëÁöÑÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊ≥¢Âä®Ôºâ„ÄÇ**
‰æãÂ¶ÇÔºöÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÊòØ‚ÄúÊ¨∫È™ó/ÈöêÁûí‚ÄùÔºåËßíËâ≤ÂèØËÉΩ‰ºöÂÅáË£ÖÊ≤°‰∫ãÔºõÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÊòØ‚ÄúÂÜ≤Âä®/ÁÉ≠ÊÉÖ‚ÄùÔºåËßíËâ≤ÂèØËÉΩ‰ºöÊåëË°Ö„ÄÇ

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„Äë
ËØ∑ÁîüÊàê‰ª•‰∏ãÂÜÖÂÆπÔºö
1. **ËßíËâ≤ÁöÑÈô∑Èò±**Ôºö(0-18Ôºå‰∏çËÉΩÊòØ #${userTrapIdx})„ÄÇ
2. **Ë°åÂä®ÈÄªËæë**ÔºöËßíËâ≤ÂêÉÈ•ºÂπ≤ÁöÑ‰ºòÂÖàÈ°∫Â∫èÊï∞ÁªÑÔºàÁ°Æ‰øùÂè™ÂåÖÂê´ 0-18 ÁöÑÊï∞Â≠óÔºâ„ÄÇ
3. **Â§öÊù°ÂÆâÂÖ®ÂèçÂ∫î**ÔºöÂΩìËßíËâ≤ÂêÉÂà∞**ÂÆâÂÖ®È•ºÂπ≤**Êó∂ËØ¥ÁöÑÂè∞ËØç„ÄÇ**ËØ∑ÁîüÊàê 5 Âà∞ 9 Âè•ÂÆåÂÖ®‰∏çÂêåÁöÑÂèçÂ∫î**ÔºåËØ≠Ê∞îË¶ÅÁ¨¶Âêà‰∫∫ËÆæÂíåÁâåÊÑèÔºàÊúâÁöÑÁ¥ßÂº†ÔºåÊúâÁöÑÂæóÊÑèÔºåÊúâÁöÑÂπ≥Ê∑°Ôºâ„ÄÇ
4. **‰∏§ÁØáÈïøÁØáÂ∞èÊïÖ‰∫ã**Ôºö
   - **Story A (Áî®Êà∑Ëæì)**ÔºöËßíËâ≤Ëé∑ËÉú„ÄÇÊèèÂÜôËßíËâ≤Â¶Ç‰ΩïÂÆûÊñΩÊÉ©ÁΩö„ÄÇ**Â≠óÊï∞‰∏çÂ∞ë‰∫é 300 Â≠ó**„ÄÇ
   - **Story B (ËßíËâ≤Ëæì)**ÔºöÁî®Êà∑Ëé∑ËÉú„ÄÇÊèèÂÜôËßíËâ≤ÂêÉÂà∞Èô∑Èò±ÂêéÁöÑÂèçÂ∫î„ÄÇ**Â≠óÊï∞‰∏çÂ∞ë‰∫é 300 Â≠ó**„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
‰∏•Ê†º JSONÔºö
{
  "char_trap_index": 5,
  "char_move_priority": [0, 1, 2, ...],
  "user_lose_story": "ÈïøÁØáÊïÖ‰∫ãÔºöÁî®Êà∑Ëæì‰∫ÜË¢´ÊÉ©ÁΩö...",
  "char_lose_story": "ÈïøÁØáÊïÖ‰∫ãÔºöËßíËâ≤Ëæì‰∫ÜÊé•ÂèóÊÉ©ÁΩö...",
  "reactions": { 
      "safe": ["Âè∞ËØç1", "Âè∞ËØç2", "Âè∞ËØç3", "Âè∞ËØç4", "Âè∞ËØç5", ...], 
      "win": "ÂìàÔºå‰Ω†Ëæì‰∫ÜÔºÅ", 
      "lose": "Âîî...Ë¢´ÂèëÁé∞‰∫Ü..." 
  }
}
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON only."}, {role:"user", content:prompt}],
                temperature: 0.85 
            })
        });
        const json = await res.json();
        let raw = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
        const start = raw.indexOf('{'); const end = raw.lastIndexOf('}');
        if(start!==-1 && end!==-1) raw = raw.substring(start, end+1);
        
        const result = JSON.parse(raw);

        witchGameState.charTrap = result.char_trap_index;
        // ËøáÊª§ÊéâË∂äÁïåÁöÑÊï∞Â≠ó (Âè™‰øùÁïô 0-18)
        witchGameState.charMoves = result.char_move_priority.filter(n => n >= 0 && n <= 18);
        
        if (!Array.isArray(result.reactions.safe)) result.reactions.safe = [result.reactions.safe];
        witchGameState.reactions = result.reactions;
        
        witchGameState.stories = {
            user_lose: result.user_lose_story,
            char_lose: result.char_lose_story
        };

        witchGameState.isPlaying = true;
        witchGameState.isMyTurn = true;
        
        // ÁïåÈù¢ÂàáÊç¢
        document.getElementById('witch-card-table-modal').style.display = 'none';
        document.getElementById('witch-setup-panel').style.display = 'none';
        document.getElementById('btn-witch-start').style.display = 'none';
        document.getElementById('witch-log-panel').style.display = 'block';
        
        document.querySelectorAll('.cookie-btn').forEach(b => b.classList.remove('selected'));
        
        addWitchLog(`üéÆ Ê∏∏ÊàèÂºÄÂßãÔºÅÂÖ± 19 ÂùóÈ•ºÂπ≤...`);
        addWitchLog(`üîÆ ÂëΩËøêÁâåÊÑèÂ∑≤Ê≥®ÂÖ•ÔºåËã•‰Ω†Ëæì‰∫ÜÂ∞ÜËß¶ÂèëÈïøÁØáÂâßÊÉÖ...`);
        document.getElementById('witch-reaction-text').innerText = "ËØ∑ÂÖàÂêÉ‰∏ÄÂùóÈ•ºÂπ≤...";

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};
// 3. ‰øÆÊîπ NPC Ëá™Âä®Ë°åÂä®ÈÄªËæë (ÂÖúÂ∫ïËåÉÂõ¥Êîπ‰∏∫ 19)
window.charAutoTurn = function() {
    let pick = -1;
    // ÂÖàÂ∞ùËØï‰ªé AI ÁîüÊàêÁöÑÂàóË°®ÈáåÊâæ
    for (let idx of witchGameState.charMoves) {
        if (!witchGameState.eatenCookies.includes(idx)) {
            pick = idx;
            break;
        }
    }
    // ÂÖúÂ∫ïÔºöÂ¶ÇÊûúÂàóË°®ÈáåÁöÑÈÉΩÊ≤°‰∫ÜÔºåÈöè‰æøÊâæ‰∏Ä‰∏™Ê≤°ÂêÉÁöÑ (ËåÉÂõ¥ 0-18)
    if (pick === -1) {
        // üî•üî•üî• ‰øÆÊîπÁÇπÔºöÂæ™ÁéØÂ∞è‰∫é 19 üî•üî•üî•
        for (let i=0; i<19; i++) {
            if (!witchGameState.eatenCookies.includes(i)) { pick = i; break; }
        }
    }
    
    if (pick !== -1) {
        processTurn(pick, 'char');
    }
};
</script>
<script>
// ============================================================
// üõ†Ô∏è RetroOS Á¥ßÊÄ•‰øÆÂ§çË°•‰∏ÅÔºöÈ¶ôÁâá & Èò¥ÊöóÈù¢
// ============================================================

// 1. „ÄêÈò¥ÊöóÈù¢„Äë‰øÆÂ§çÔºölist.unshift is not a function
// ÂéüÂõ†ÔºöÊï∞ÊçÆÂ∫ìÈáåÁöÑ shadow_data ÂèØËÉΩË¢´Â≠òÊàê‰∫ÜÂØπË±°ÔºåËøôÈáåÂº∫Âà∂ËΩ¨‰∏∫Êï∞ÁªÑ
window.getShadowData = function() {
    let data = window.BIG_MEMORY.shadow_data;
    // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÊàñËÄÖ‰∏çÊòØÊï∞ÁªÑÔºåÂº∫Âà∂ÈáçÁΩÆ‰∏∫Êï∞ÁªÑ
    if (!data || !Array.isArray(data)) {
        console.warn("Ê£ÄÊµãÂà∞Èò¥ÊöóÈù¢Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÂ∑≤Ëá™Âä®‰øÆÂ§ç‰∏∫Êï∞ÁªÑ„ÄÇ");
        data = [];
        window.BIG_MEMORY.shadow_data = data; // Êõ¥Êñ∞ÂÜÖÂ≠ò
    }
    return data;
};

// Á°Æ‰øù‰øùÂ≠òÊó∂‰πüÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
window.saveShadowData = function(list) {
    window.BIG_MEMORY.shadow_data = list;
    if (typeof idb !== 'undefined') {
        idb.put('universal_store', { id: 'shadow_data', data: list });
    }
};

// 2. „ÄêÈ¶ôÁâá„Äë‰øÆÂ§çÔºöJSON Parse Error (Unterminated string)
// ÂéüÂõ†ÔºöÁîüÊàêÁöÑ 12 ‰∏™È¶ôÁâáÂÜÖÂÆπÂ§™ÈïøÔºåË∂ÖËøá‰∫Ü token ÈôêÂà∂Ë¢´Êà™Êñ≠„ÄÇ
// ‰øÆÂ§çÔºöÂ¢ûÂä† max_tokensÔºåÂπ∂Ê∑ªÂä† JSON ÂÆπÈîôÊà™ÂèñÈÄªËæë„ÄÇ
window.finishScentDraw = async function() {
    if(scentFlipped.length === 0) return alert("ËØ∑Ëá≥Â∞ëÊäΩ‰∏ÄÂº†ÁâåÔºÅ");

    const btn = document.querySelector('#scent-card-table-modal .primary');
    const oldText = btn.innerText;
    btn.disabled = true; btn.innerText = "üå¨Ô∏è Ê≠£Âú®Ë∞ÉÈ¶ô (Á∫¶20Áßí)...";

    // ÂáÜÂ§áÊï∞ÊçÆ
    const cardsDesc = scentFlipped.map(c => (c.type==='tarot'?TAROT_NAMES[c.id]:LENORMAND_NAMES[c.id]) + (c.isReversed?"(ÈÄÜ)":"")).join(", ");
    const wb = window.getWBData();
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    let apiKey = document.getElementById('api-key').value;
    let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || "gpt-3.5-turbo";
    
    // ËØªÂèñÁºìÂ≠ò Key
    if(!apiKey) { 
        try{ const s=JSON.parse(localStorage.getItem('api_settings_draft')||'{}'); apiKey=s.key; apiUrl=s.url; model=s.model; }catch(e){} 
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API Key");

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÈ°∂Á∫ßË∞ÉÈ¶ôÂ∏à„ÄÇ
„ÄêËßíËâ≤/‰∏ñÁïåËßÇ„ÄëÔºö${globalCtx}
„ÄêÂëΩËøêÁâå„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°„Äë
ËØ∑‰∏∫„ÄêÂêå‰∏Ä‰∏™ËßíËâ≤„ÄëÁîüÊàê **12 ÊîØ‰∏çÂêåÁöÑÈ¶ôÊ∞¥**ÔºàÈ¶ôÁâáÔºâ„ÄÇ
‰ª£Ë°® Ta Âú®‰∏çÂêåÊó∂Êúü„ÄÅ‰∏çÂêåÂøÉÂ¢É‰ΩøÁî®ÁöÑÈ¶ô„ÄÇÁªìÂêàÁâåÊÑè„ÄÇÔºàÂ∞èÊïÖ‰∫ã‰πüË¶ÅÂõ†‰∏∫ÁâåÊÑèÁîüÊàê„ÄÇ

„ÄêËæìÂá∫Ê†ºÂºè„Äë
**‰∏•Ê†ºËæìÂá∫ JSON Êï∞ÁªÑ**ÔºåÂåÖÂê´ 12 ‰∏™ÂØπË±°„ÄÇ‰∏çË¶Å Markdown„ÄÇ
[
  { "name": "...", "notes": "...", "review": "...", "story": "..." },
  ...
]
`;

    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"Output JSON array only."}, {role:"user", content:prompt}],
                temperature: 0.85,
                max_tokens: 6000 // üî¥ Â¢ûÂ§ß Token ÈôêÂà∂
            })
        });
        const json = await res.json();
        
        if (json.error) throw new Error(json.error.message);

        let raw = json.choices[0].message.content;
        
        // üî¥ Ê†∏ÂøÉ‰øÆÂ§çÔºöJSON Ê∏ÖÊ¥ó‰∏éÊà™Êñ≠‰øÆÂ§ç
        raw = raw.replace(/```json/g,"").replace(/```/g,"").trim();
        
        // Â∞ùËØïÊâæÂà∞ÊúÄÂêé‰∏Ä‰∏™Èó≠ÂêàÁöÑÂ§ßÊã¨Âè∑ } Êàñ Êï∞ÁªÑÊã¨Âè∑ ]
        const lastBracket = raw.lastIndexOf(']');
        const lastBrace = raw.lastIndexOf('}');
        
        // Â¶ÇÊûúÊ≤°ÊúâÂÆåÊï¥ÁöÑÁªìÂ∞æ ]ÔºåÂ∞ùËØïÊâãÂä®‰øÆÂ§ç
        if (lastBracket === -1 && lastBrace !== -1) {
            // Êà™ÂèñÂà∞ÊúÄÂêé‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÂØπË±°ÔºåÂπ∂Ë°•‰∏ä ]
            raw = raw.substring(0, lastBrace + 1) + ']';
            console.log("Ê£ÄÊµãÂà∞ JSON Êà™Êñ≠ÔºåÂ∑≤Â∞ùËØïËá™Âä®‰øÆÂ§ç„ÄÇ");
        } else if (lastBracket !== -1) {
            raw = raw.substring(0, lastBracket + 1);
        }

        let items;
        try {
            items = JSON.parse(raw);
        } catch (parseErr) {
            console.error("JSON Ëß£ÊûêÂ§±Ë¥•:", raw);
            throw new Error("ÁîüÊàêÁöÑÂÜÖÂÆπÊ†ºÂºèÊúâËØØÔºåËØ∑ÈáçËØï (Âª∫ËÆÆÂáèÂ∞ëÁîüÊàêÊï∞ÈáèÊàñÊõ¥Êç¢Ê®°Âûã)");
        }
        
        // ÁîüÊàê Session Êï∞ÊçÆ
        currentScentSession = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            cards: cardsDesc,
            chips: items.map(item => ({ ...item, revealed: false }))
        };

        // ÂÖ≥Èó≠ÁâåÊ°åÔºåÊòæÁ§∫ÁΩëÊ†º
        document.getElementById('scent-card-table-modal').style.display = 'none';
        renderScentGrid();

        // ‰øùÂ≠òÂà∞Êó†ÈôêÂ≠òÂÇ®
        const list = getScentData();
        list.unshift(currentScentSession);
        saveScentData(list);

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};

// 3. ÂÜçÊ¨°Âº∫Âà∂Á°Æ‰øù loadAllBigData Âä†ËΩΩËøô‰∏§‰∏™Êï∞ÊçÆ
// Èò≤Ê≠¢‰πãÂâçÁöÑÂä†ËΩΩÂáΩÊï∞ÊºèÊéâ‰∫ÜËøô‰∏§‰∏™ key
const _oldLoad = window.loadAllBigData;
window.loadAllBigData = async function() {
    if (_oldLoad) await _oldLoad();
    
    // Âº∫Âà∂Ê£ÄÊü• shadow_data Âíå scent_data
    try {
        if (typeof idb !== 'undefined') {
            let sData = await idb.get('universal_store', 'shadow_data');
            if (sData) window.BIG_MEMORY.shadow_data = sData.data;
            else window.BIG_MEMORY.shadow_data = []; // ÈªòËÆ§‰∏∫Á©∫Êï∞ÁªÑ

            let scData = await idb.get('universal_store', 'scent_data');
            if (scData) window.BIG_MEMORY.scent_data = scData.data;
            else window.BIG_MEMORY.scent_data = [];
        }
    } catch(e) { console.log("Ë°•‰∏ÅÂä†ËΩΩÊï∞ÊçÆÈîôËØØ", e); }
    
    console.log("‚úÖ ‰øÆÂ§çË°•‰∏ÅÂ∑≤Â∫îÁî®ÔºöÈò¥ÊöóÈù¢ & È¶ôÁâá");
};

let bookCurrentPage = 0; // ÂΩìÂâçÈ°µÁ†Å (0, 2, 4...)

// 1. ÊâìÂºÄ‰π¶Êú¨ÂÖ•Âè£ (ÊõøÊç¢ÂéüÊúâÁöÑ‰æßËæπÊ†èÂºÄÂÖ≥)
window.toggleRpgHistory = function() {
    const modal = document.getElementById('rpg-book-modal');
    const cover = document.getElementById('book-cover-view');
    const spread = document.getElementById('book-spread-view');
    
    // ÂàùÂßãÂåñÁä∂ÊÄÅÔºöÊòæÁ§∫Â∞ÅÈù¢ÔºåÈöêËóèÂÜÖÈ°µ
    modal.style.display = 'flex';
    cover.style.display = 'flex';
    spread.style.display = 'none';
    
    // Â∫îÁî®ÁæéÂåñËÉåÊôØ (Â¶ÇÊûúÂú®ÁæéÂåñAPPÈáåËÆæÁΩÆ‰∫Ü 'rpg_book_paper')
    applyBookPaperTheme();
};
window.openBookSpread = function() {
    document.getElementById('book-cover-view').style.display = 'none';
    document.getElementById('book-spread-view').style.display = 'flex';
    
    bookCurrentPage = 0; 
    renderBookPages();
};
window.closeRpgBook = function() {
    document.getElementById('rpg-book-modal').style.display = 'none';
};
window.turnBookPage = function(delta) {
    const list = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const newPage = bookCurrentPage + (delta * 2); 
    if (newPage < 0) return; 
    if (newPage >= list.length) return; 
    
    bookCurrentPage = newPage;
    renderBookPages();
};
window.renderBookPages = function() {
    const list = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const leftEl = document.getElementById('book-page-left');
    const rightEl = document.getElementById('book-page-right');
    
    // Ê∏≤ÊüìÂ∑¶È°µ (Index = bookCurrentPage)
    renderSinglePage(leftEl, list[bookCurrentPage], bookCurrentPage);
    
    // Ê∏≤ÊüìÂè≥È°µ (Index = bookCurrentPage + 1)
    renderSinglePage(rightEl, list[bookCurrentPage + 1], bookCurrentPage + 1);
};
function renderSinglePage(container, item, index) {
    if (!item) {
        container.innerHTML = `<div class="book-empty-hint">ÔºàÁ©∫ÁôΩÈ°µÔºâ</div>`;
        return;
    }
    
    const dateObj = new Date(item.date);
    const dateStr = `${dateObj.getFullYear()}.${dateObj.getMonth()+1}.${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
    
    container.innerHTML = `
        <div class="book-story-date">üìÖ ${dateStr} ¬∑ ${item.item || 'Êó•Â∏∏'}</div>
        <div class="book-story-text">${item.text}</div>
        <div class="book-story-del" onclick="deleteRpgHistoryBook(${index})">‚úÇÔ∏è ÊíïÊéâËøô‰∏ÄÈ°µ</div>
    `;
}
window.deleteRpgHistoryBook = function(index) {
    if(!confirm("Á°ÆÂÆöË¶ÅÊíïÊéâËøô‰∏ÄÈ°µÂõûÂøÜÂêóÔºü(‰∏çÂèØÊÅ¢Â§ç)")) return;
  window.BIG_MEMORY.rpg_data.history.splice(index, 1);
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    if (!window.BIG_MEMORY.rpg_data.history[bookCurrentPage] && bookCurrentPage > 0) {
        bookCurrentPage -= 2;
    }
    renderBookPages();
};
async function applyBookPaperTheme() {
    try {
        const res = await idb.get('settings_heavy', 'rpg_book_paper');
        if (res && res.data) {
            document.querySelectorAll('.custom-paper-bg').forEach(el => {
                el.style.backgroundImage = `url(${res.data})`;
            });
        }
    } catch(e) {}
}

let bookCurrentIndex = 0; 
window.toggleRpgHistory = function() {
    const modal = document.getElementById('rpg-book-modal');
    modal.style.display = 'flex';
    document.getElementById('book-cover-view').style.display = 'flex';
    document.getElementById('book-single-view').style.display = 'none';
    applyBookPaperTheme();
};

window.openBookSingle = function() {
    document.getElementById('book-cover-view').style.display = 'none';
    document.getElementById('book-single-view').style.display = 'flex';
    bookCurrentIndex = 0; // ÊâìÂºÄÊó∂ÈªòËÆ§ÁúãÊúÄÊñ∞ÁöÑ
    renderSingleBookPage();
};

window.closeRpgBook = function() {
    document.getElementById('rpg-book-modal').style.display = 'none';
};

// 2. ÁøªÈ°µ (delta: -1 ÂæÄÂâçÁøª/Êõ¥Êñ∞ÁöÑ, 1 ÂæÄÂêéÁøª/Êõ¥ÊóßÁöÑ)
// ËøôÈáåÈÄªËæëÊòØÔºöIndex 0 ÊòØÊúÄÊñ∞ÔºåIndex 1 ÊòØÊ¨°Êñ∞...
// ÊâÄ‰ª• "Next Page" (ÁøªËøáÂéª) Â∫îËØ•ÁúãÊóßËÆ∞ÂΩï -> Index + 1
// "Prev Page" (ÁøªÂõûÊù•) Â∫îËØ•ÁúãÊñ∞ËÆ∞ÂΩï -> Index - 1
window.turnBookPage = function(delta) {
    const list = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const newIndex = bookCurrentIndex + delta;
    
    if (newIndex < 0) return; 
    if (newIndex >= list.length) return; 
    
    bookCurrentIndex = newIndex;
    renderSingleBookPage();
};
window.renderSingleBookPage = function() {
    const list = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    const contentEl = document.getElementById('book-page-content');
    const dateEl = document.getElementById('book-page-date');
    const tagEl = document.getElementById('book-page-tag');
    const numEl = document.getElementById('book-page-indicator');
    
    if (list.length === 0) {
        contentEl.innerHTML = "<div style='text-align:center; margin-top:50%; color:#aaa;'>ÔºàÁ©∫ÁôΩÁöÑÁ¨îËÆ∞Êú¨...Ôºâ</div>";
        dateEl.innerText = "--";
        tagEl.style.display = 'none';
        numEl.innerText = "0 / 0";
        return;
    }

    const item = list[bookCurrentIndex];
    const dateObj = new Date(item.date);
    dateEl.innerText = dateObj.toLocaleDateString();
    tagEl.innerText = item.item || "RECORD";
    tagEl.style.display = 'inline-block';
    contentEl.innerHTML = item.text.replace(/\n/g, '<br>');
    numEl.innerText = `${bookCurrentIndex + 1} / ${list.length}`;
};
window.deleteCurrentBookPage = function() {
    const list = window.BIG_MEMORY.rpg_data ? window.BIG_MEMORY.rpg_data.history : [];
    if(list.length === 0) return;

    if(!confirm("Á°ÆÂÆöË¶ÅÊíïÊéâËøô‰∏ÄÈ°µÂêóÔºü(‰∏çÂèØÊÅ¢Â§ç)")) return;
    
    list.splice(bookCurrentIndex, 1);
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    if (bookCurrentIndex >= list.length && bookCurrentIndex > 0) {
        bookCurrentIndex--;
    }
    renderSingleBookPage();
};
window.saveRpgStory = function(title, text) {
    if(!window.BIG_MEMORY.rpg_data) window.BIG_MEMORY.rpg_data = { history: [], chat_history: [] };
    if(!window.BIG_MEMORY.rpg_data.history) window.BIG_MEMORY.rpg_data.history = [];

    window.BIG_MEMORY.rpg_data.history.unshift({
        date: Date.now(),
        item: title,
        text: text
    });
    
    if(window.BIG_MEMORY.rpg_data.history.length > 100) window.BIG_MEMORY.rpg_data.history.pop();
    saveToBigDB('rpg_data', window.BIG_MEMORY.rpg_data);
    toggleRpgHistory();
    openBookSingle();
};
window.generateRpgStory = async function(item) {
    alert(`‚è≥ Ê≠£Âú®ËßÇÂØü‰Ω†‰∏é„Äê${item.name}„ÄëÁöÑ‰∫íÂä®...\n(AI Ê≠£Âú®Êí∞ÂÜôÈïøÁØáÊïÖ‰∫ãÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖÔºåÁîüÊàêÂÆåÊØï‰ºöÊúâÊèêÁ§∫)`);
    
    const context = await getRpgContext();
    if(!context) return; 

    // üî• ÊÅ¢Â§çÂéüÁâàÈ´òË¥®Èáè Prompt
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊìÖÈïøÊèèÂÜôÁªÜËÖªÊÉÖÊÑüÁöÑÊ≤ªÊÑàÁ≥ªÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÊ∏©È¶®ÁöÑÂÆ∂‰∏≠„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑Ôºà‰Ω†ÔºâÊ≠£Âú®‰ΩøÁî®ÊàøÈó¥ÈáåÁöÑ„Äê${item.name}„Äë„ÄÇ

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑‰ª•**Á¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚Äù**ÁöÑËßÜËßíÔºåÂÜô‰∏ÄÊÆµ**‰∏çÂ∞ë‰∫é 300 Â≠ó**ÁöÑÁîüÊ¥ªÁâáÊÆµ„ÄÇ
ËØ∑ÈáçÁÇπÊèèÂÜôÔºö
1. **ÊÑüÂÆòÁªÜËäÇ**ÔºöÁâ©ÂìÅÁöÑËß¶ÊÑü„ÄÅÂ£∞Èü≥„ÄÅÊàøÈó¥ÁöÑÂÖâÂΩ±„ÄÅÁ©∫Ê∞îÁöÑÂë≥ÈÅì„ÄÇ
2. **ËßíËâ≤‰∫íÂä®**ÔºöÊ≠§ÂàªËßíËâ≤ÔºàTaÔºâÂú®ÂÅö‰ªÄ‰πàÔºüTa ÊòØÈùôÈùôÂú∞ÁúãÁùÄ‰Ω†ÔºåËøòÊòØËµ∞ËøáÊù•Âíå‰Ω†‰∏ÄËµ∑‰∫íÂä®Ôºü
3. **ÊÉÖÊÑüÊµÅÂä®**Ôºö‰Ω†‰ª¨‰πãÈó¥Êó†Â£∞ÁöÑÈªòÂ•ëÔºåÊàñËÄÖÊ∏©ÊüîÁöÑËØ≠Ë®Ä‰∫§ÊµÅ„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫ÊïÖ‰∫ãÊ≠£ÊñáÔºå‰∏çË¶ÅÊ†áÈ¢ò„ÄÇ
`;
    
    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üè† Â±ÖÂÆ∂ ¬∑ ${item.name}`, story);
        alert(`‚úÖ ‰∏é„Äê${item.name}„ÄëÁöÑ‰∫íÂä®ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ\nËØ∑ÁÇπÂáªÂè≥‰∏äËßí„ÄêÊïÖ‰∫ãÈõÜ„ÄëÊü•Áúã„ÄÇ`);
    });
};
window.generateFriendStory = async function(friend) {
    alert(`‚è≥ Ê≠£Âú®ËÅÜÂê¨„Äê${friend.name}„ÄëÁöÑÁ•ùÁ¶è...\n(AI Ê≠£Âú®ÊûÑÊÄùÔºåËØ∑Á®çÂÄô)`);
    
    const context = await getRpgContext();
    if(!context) return;
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊÉÖÊÑüÁªÜËÖªÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÈò≥ÂÖâÊòéÂ™öÁöÑÊ≤ôÊª©/Êà∑Â§ñ„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑Ôºà‰Ω†ÔºâÂíåËßíËâ≤ÔºàTaÔºâÂÅ∂ÈÅá‰∫ÜÊúãÂèã„Äê${friend.name}„Äë„ÄÇ
„ÄêÊúãÂèãËØ¥„ÄëÔºö"${friend.prompt}"

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ **300 Â≠óÂ∑¶Âè≥** ÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ
1. ÊèèÂÜôÂê¨Âà∞ÊúãÂèãËøôÂè•ËØùÂêéÔºå**‰Ω†ÂíåTaÂêÑËá™ÁöÑÂèçÂ∫î**ÔºàÊòØÂÆ≥ÁæûÂú∞ÂØπËßÜÔºåËøòÊòØÁ¥ßÁ¥ßÊè°‰Ωè‰∫ÜÊâãÔºüÔºâ„ÄÇ
2. ‰æßÈáçÊèèÂÜô‰∏§‰∫∫‰πãÈó¥ÊµÅÂä®ÁöÑÁà±ÊÑè„ÄÅÁ°ÆÂπ∏ÊÑüÔºå‰ª•ÂèäÊúãÂèãÁúº‰∏≠ÁöÑ‰Ω†‰ª¨ÊòØÂ§ö‰πàËà¨ÈÖç„ÄÇ
3. Ê∞õÂõ¥ÔºöÁîúËúú„ÄÅÈò≥ÂÖâ„ÄÅ‰ª§‰∫∫ÂøÉÂä®„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫ÊïÖ‰∫ãÊ≠£Êñá„ÄÇ
`;

    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üèñÔ∏è ÂÅ∂ÈÅá ¬∑ ${friend.name}`, story);
        alert(`‚úÖ ÊúãÂèãÁöÑÁ•ùÁ¶èÂ∑≤ËÆ∞ÂΩïÔºÅ\nËØ∑Âú®„ÄêÊïÖ‰∫ãÈõÜ„Äë‰∏≠Êü•Áúã„ÄÇ`);
    });
};

// 3. üõí ‰æøÂà©Â∫óË¥≠Áâ©ÁîüÊàê (ÂéüÁâàËØ¶ÁªÜ Prompt)
window.generateStoreShopping = async function(item) {
    const itemName = item.name.replace('Ë¥ßÊû∂','');
    alert(`‚è≥ Ê≠£Âú®ÊåëÈÄâ„Äê${itemName}„Äë...\n(ÁîüÊàê‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ)`);
    
    const context = await getRpgContext();
    if(!context) return;

    // üî• ÊÅ¢Â§çÂéüÁâàÈ´òË¥®Èáè Prompt
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊûÅÂÖ∑ÁîüÊ¥ªÊ∞îÊÅØÁöÑÂ∞èËØ¥ÂÆ∂ÔºàÁ±ª‰ººÂêâÊú¨Ëä≠Â®úÂ®úÈ£éÊ†ºÔºâ„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÊ∑±Â§ú/ÂÇçÊôöÁöÑ‰æøÂà©Â∫ó„ÄÇ
„Äê‰∫ã‰ª∂„ÄëÔºöÁî®Êà∑Ôºà‰Ω†ÔºâÊ≠£Âú®Ë¥ßÊû∂ÂâçÊåëÈÄâ„Äê${itemName}„Äë„ÄÇ

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ **300 Â≠óÂ∑¶Âè≥** ÁöÑÁâáÊÆµ„ÄÇ
1. **ÊåëÈÄâËøáÁ®ã**ÔºöËØ¶ÁªÜÊèèÂÜôÁ∫†ÁªìÁöÑËøáÁ®ãÔºàÊØîÂ¶ÇÁúã‰øùË¥®Êúü„ÄÅÊØîËæÉÂè£Âë≥„ÄÅÊàñËÄÖÂçïÁ∫ØË¢´ÂåÖË£ÖÂê∏ÂºïÔºâ„ÄÇ
2. **ËßíËâ≤‰∫íÂä®**ÔºöTa ÁªôÂá∫‰∫Ü‰ªÄ‰πàÂª∫ËÆÆÔºüÊàñËÄÖ Ta Ë∂Å‰Ω†‰∏çÊ≥®ÊÑèÂÅ∑ÂÅ∑ÂæÄÁØÆÂ≠êÈáåÊîæ‰∫Ü‰ªÄ‰πàÔºü
3. **ÁªìË¥¶ÊèíÊõ≤**ÔºöÊèèÂÜôÁªìË¥¶Êó∂Ê∏©È¶®ÁöÑÂ∞è‰∫íÂä®ÔºåÊàñËÄÖËµ∞Âá∫‰æøÂà©Â∫óÊó∂Â§úÊôöÁöÑÈ£é„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫ÊïÖ‰∫ãÊ≠£Êñá„ÄÇ
`;

    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üè™ Ë¥≠Áâ© ¬∑ ${itemName}`, story);
        alert(`‚úÖ Ë¥≠Áâ©Â∞èÂâßÂú∫Â∑≤ÁîüÊàêÔºÅ\nËØ∑Âú®„ÄêÊïÖ‰∫ãÈõÜ„Äë‰∏≠Êü•Áúã„ÄÇ`);
    });
};
window.generatePixelStory = async function(promptText, isR18 = false) {
    alert(`‚è≥ Ê≠£Âú®ÁîüÊàêÂâßÊÉÖ...\n‰∏ªÈ¢ò: ${promptText.substring(0,10)}...`);
    
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const pixelCtx = (wb['20.ÂÉèÁ¥†Â∞èÂ±ã'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    if(!apiKey) { 
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; } catch(e){} 
    }
    if(!apiKey) return alert("ËØ∑ÈÖçÁΩÆ API Key");

    let extraInstruction = isR18 ? 
        "„ÄêÁâπÊÆäÊ®°Âºè„ÄëÔºöËøôÊòØÁßÅÂØÜ‰∫íÂä®„ÄÇËØ∑ÊèèÂÜô‰∏§‰∫∫‰πãÈó¥ÊûÅÂ∫¶‰∫≤ÂØÜ„ÄÅÁîöËá≥Â∏¶ÊúâÊÉÖËâ≤Âº†ÂäõÁöÑ‰∫íÂä®„ÄÇÊèèÂÜôËß¶ÊÑü„ÄÅÂñòÊÅØ„ÄÅÁúºÁ•ûÂíåÂä®‰ΩúÔºåÂº†ÂäõÊãâÊª°„ÄÇ" : 
        "ËØ∑ÂÜô‰∏ÄÊÆµÊ∏©È¶®„ÄÅÊ≤ªÊÑà„ÄÅÂÖÖÊª°ÁîüÊ¥ªÊ∞îÊÅØÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ";

    const fullPrompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÁªÜËÖªÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÂú∫ÊôØËÆæÂÆö„ÄëÔºö${pixelCtx}
„ÄêÂΩìÂâç‰∫ã‰ª∂„ÄëÔºö${promptText}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑Ê†πÊçÆ‰∏äËø∞ËÆæÂÆöÔºåÂÜô‰∏ÄÊÆµ**‰∏çÂ∞ë‰∫é 400 Â≠ó**ÁöÑÂâßÊÉÖ„ÄÇÊ∏©ÊöñÔºåÊ∏©È¶®„ÄÇ
${extraInstruction}
ËßÜËßíÔºöÁ¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚Äù„ÄÇ
ËØ∑Áõ¥Êé•ËæìÂá∫Ê≠£ÊñáÔºå‰∏çË¶Å‰ªª‰ΩïÂâçË®ÄÂêéËØ≠„ÄÇ
`;

    try {
        let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
        let model = document.getElementById('model-select').value || "gpt-3.5-turbo";

        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a creative writer."}, {role:"user", content:fullPrompt}],
                temperature: 0.85,
                max_tokens: 6000
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content;
        
        saveRpgStory(`ÂÉèÁ¥†Êó•Â∏∏ ¬∑ ${promptText.substring(0,5)}`, story);
        alert("‚ú® ÂâßÊÉÖÂ∑≤ÁîüÊàêÔºÅ\nËØ∑Âéª„ÄêÊïÖ‰∫ãÈõÜ„ÄëÈáåÁøªÈòÖ„ÄÇ");

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    }
};
async function callRpgApi(prompt, ctx, callback) {
    let s = {};
    try { s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); } catch(e){}
    let apiUrl = document.getElementById('api-url').value || s.url || "https://api.openai.com/v1";
    let model = document.getElementById('model-select').value || s.model || "gpt-3.5-turbo";
    try {
        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ctx.apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a creative writer."}, {role:"user", content:prompt}],
                temperature: 0.8,
                max_tokens: 6000
            })
        });
        const json = await res.json();
        if (json.error) throw new Error(json.error.message);
        
        const story = json.choices[0].message.content;
        const loading = document.getElementById('rpg-temp-loading');
        if(loading) loading.remove();
        
        callback(story);

    } catch(e) {
        console.error(e);
        alert(`‚ùå API ËØ∑Ê±ÇÂ§±Ë¥•Ôºö${e.message}\nËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API Key„ÄÇ`);
        // ÁßªÈô§ loading ÊèêÁ§∫Èò≤Ê≠¢Âç°Ê≠ª
        const loading = document.getElementById('rpg-temp-loading');
        if(loading) loading.remove();
    }
}
async function performSelectiveReset() {
    // 1. ÂèåÈáçÁ°ÆËÆ§
    if (!confirm("‚ö†Ô∏è È´òËÉΩÈ¢ÑË≠¶ ‚ö†Ô∏è\n\n‰Ω†Á°ÆÂÆöË¶Å„ÄêÂà†Èô§ÊâÄÊúâ„ÄëÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü\n\nËøôÂ∞ÜÊ∏ÖÁ©∫Ôºö\n- ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï (Line/RPG/Êç°ÊâãÊú∫)\n- ÊâÄÊúâÊó•ËÆ∞„ÄÅÂâßÊú¨„ÄÅÂàÜÊûêÊä•Âëä\n- ÊâÄÊúâÊäΩÂç°ÁªìÊûú\n\n‚úÖ ‰Ω†ÁöÑ„ÄêÁæéÂåñ/ÂõæÁâá/ËÆæÂÆö/ÂÆ†Áâ©/Êî∂ËóèÂ§π„Äë‰ºö‰øùÁïô„ÄÇ")) return;
    if (!confirm("ÂÜçÊ¨°Á°ÆËÆ§ÔºöÊï∞ÊçÆÂà†Èô§Âêé„ÄêÊó†Ê≥ïÊÅ¢Â§ç„Äë„ÄÇ\n\nÊòØÂê¶Á´ãÂç≥ÊâßË°åÔºü")) return;

    const btn = event.target;
    btn.innerText = "‚è≥ Ê≠£Âú®Êö¥ÂäõÊ∏ÖÁêÜ..."; btn.disabled = true;

    try {
        const historyStores = [
            'chat_history', 'game_history', 'tarot_history', 
            'his_phone_history', 'dream_history', 'fridge_history', 
            'gashapon_history'
        ];
        
        for (let storeName of historyStores) {
            await idb.clear(storeName);
        }
        await idb.clear('pickup_data'); 
        await idb.put('pickup_data', { id: 'history_list', data: [] });
        await idb.clear('forum_data');
        await idb.put('forum_data', { id: 'history_list', data: [] });
        await idb.clear('theater_data');
        await idb.put('theater_data', { id: 'history_list', data: [] });

        const simpleLists = [
            'diary_history', 'lofter_data', 'shadow_data', 
            'summary_data', 'work_data', 'scent_data', 
            'puzzle_data', 'tacit_data', 'witch_data' 
        ];
        
        for (let key of simpleLists) {
            window.BIG_MEMORY[key] = [];
            await idb.put('universal_store', { id: key, data: [] });
        }

        // --- D. Â§çÊùÇÂØπË±°ÈáçÁΩÆ ---
        
        // RPG: Ê∏ÖÁ©∫ chat_history Âíå history
        if(window.BIG_MEMORY.rpg_data) {
            window.BIG_MEMORY.rpg_data.history = [];
            window.BIG_MEMORY.rpg_data.chat_history = [];
            await idb.put('universal_store', { id: 'rpg_data', data: window.BIG_MEMORY.rpg_data });
        }

        // ÂÆ†Áâ©: Ê∏ÖÁ©∫ historyÔºå‰øùÁïô inventory/stats/config
        if(window.BIG_MEMORY.pet_data) {
            window.BIG_MEMORY.pet_data.history = [];
            await idb.put('universal_store', { id: 'pet_data', data: window.BIG_MEMORY.pet_data });
        }

        // ÁóõËã¶ (Pain): Ê∏ÖÁ©∫
        window.BIG_MEMORY.pain_data = { his: [], my: [] };
        await idb.put('universal_store', { id: 'pain_data', data: { his:[], my:[] } });

        // Â≠¶‰π†ËÆ°Âàí (Study): Ê∏ÖÁ©∫
        window.BIG_MEMORY.study = null;
        await idb.put('universal_store', { id: 'study', data: null });

        // ÁªèÊúü: Ê∏ÖÁ©∫ records
        if(window.BIG_MEMORY.period) {
            window.BIG_MEMORY.period.records = [];
            window.BIG_MEMORY.period.lastAnalysis = null;
            await idb.put('universal_store', { id: 'period', data: window.BIG_MEMORY.period });
        }

        // Galgame: Ê∏ÖÁ©∫ archives
        if(window.BIG_MEMORY.galgame_data) {
            window.BIG_MEMORY.galgame_data.archives = [];
            window.BIG_MEMORY.galgame_data.current = null;
            await idb.put('universal_store', { id: 'galgame_data', data: window.BIG_MEMORY.galgame_data });
        }
        await idb.put('universal_store', { id: 'letters', data: [] });
        await idb.put('universal_store', { id: 'finance', data: [] });
        await idb.put('universal_store', { id: 'memo', data: "" });

        alert("üßπ Ê∏ÖÁêÜÂÆåÊØïÔºÅ\nÊâÄÊúâÂØπËØùÂíåÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∂àÂ§±ÔºåÁ≥ªÁªüÂ∑≤ÈáçÁΩÆ‰∏∫ËΩªÈáèÁä∂ÊÄÅ„ÄÇ\n(ÁæéÂåñÁ¥†ÊùêÂíåËÆæÂÆöÂ∑≤‰øùÁïô)");
        location.reload();

    } catch(e) {
        console.error(e);
        alert("Ê∏ÖÁêÜÈÉ®ÂàÜÂÜÖÂÆπÊó∂Âá∫Èîô (ÂèØËÉΩÂ∑≤ÁªèÊòØÁ©∫ÁöÑ): " + e.message);
        btn.disabled = false; btn.innerText = "‚ö†Ô∏è Âº∫Âà∂ÈáçËØï";
    }
}
function toggleNightMode(checkbox) {
    const slider = document.getElementById('night-slider');
    if (checkbox.checked) {
  document.documentElement.classList.add('night-mode');        checkbox.nextElementSibling.style.backgroundColor = "#6c5ce7";
        slider.style.transform = "translateX(26px)";
    } else {
        document.documentElement.classList.remove('night-mode');
        checkbox.nextElementSibling.style.backgroundColor = "#ccc";
        slider.style.transform = "translateX(0)";
    }
}
(function initJoystick() {
    const base = document.getElementById('joy-base');
    const stick = document.getElementById('joy-stick');
    if (!base || !stick) { setTimeout(initJoystick, 1000); return; }

    let isDragging = false;
    const maxRadius = 35;
    const startDrag = (e) => {
        isDragging = true;
        base.style.borderColor = "rgba(255,255,255,0.8)";
        stick.style.background = "radial-gradient(circle at 30% 30%, #a29bfe, #6c5ce7)";
        if (!rpgState.isMoving) {
            rpgState.isMoving = true;
            if(rpgState.moveInterval) clearInterval(rpgState.moveInterval);
            rpgState.moveInterval = setInterval(gameLoop, 16); 
        }
        handleDrag(e);
    };
    const endDrag = () => {
        isDragging = false;
        stick.style.transition = "0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
        stick.style.transform = `translate(-50%, -50%)`;
        base.style.borderColor = "rgba(255,255,255,0.2)";
        stick.style.background = "radial-gradient(circle at 30% 30%, #fff, #aaa)";
        rpgState.isMoving = false;
        rpgState.moveVector = { x: 0, y: 0 }; 
        if(rpgState.moveInterval) clearInterval(rpgState.moveInterval);
 updateSpritePosition('player'); 
    };
    const handleDrag = (e) => {
        if (!isDragging) return;
        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const rect = base.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        let dx = clientX - centerX;
        let dy = clientY - centerY;
        const distance = Math.sqrt(dx*dx + dy*dy);
        if (distance > maxRadius) {
            const ratio = maxRadius / distance;
            dx *= ratio;
            dy *= ratio;
        }
        stick.style.transition = "none";
        stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
        const angle = Math.atan2(dy, dx);
        rpgState.moveVector = {
            x: Math.cos(angle),
            y: Math.sin(angle)
        };
    };
  base.addEventListener('mousedown', startDrag);
    base.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('mousemove', handleDrag);
    window.addEventListener('touchmove', handleDrag, { passive: false });
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
})();

</script>
<script>
(function() {
    const originalFetch = window.fetch;
    window.fetch = async function(url, options) {
        if (url.includes('/chat/completions') && options && options.method === 'POST') {
            let body = JSON.parse(options.body);
            let headers = options.headers || {};
            let hasKey = false;
            if (headers['Authorization'] && headers['Authorization'].length > 10) hasKey = true;
            if (headers.Authorization && headers.Authorization.length > 10) hasKey = true;
            
            if (!hasKey || !body.model) {
                try {
                    const saved = JSON.parse(localStorage.getItem('api_settings_draft') || '{}');
                    if (saved.key && saved.key.startsWith('sk-')) {
                        if (!hasKey) {
                            headers['Authorization'] = 'Bearer ' + saved.key;
                        }
                        if (!url.startsWith('http')) {
                            let savedUrl = saved.url || "https://api.openai.com/v1";
                            if (savedUrl.endsWith('/')) savedUrl = savedUrl.slice(0, -1);
                            url = savedUrl + "/chat/completions";
                        }
                        if (!body.model && saved.model) {
                            body.model = saved.model;
                        }
                        options.headers = headers;
                        options.body = JSON.stringify(body);
                    }
                } catch (e) {}
            }
        }
        return originalFetch(url, options);
    };
})();
</script>
<!-- ================== ‚öñÔ∏è Âπ≥Ë°°Ë°•‰∏ÅÔºöËÆ©Á≥ªÁªüËÆæÂÆö‰∏éÁî®Êà∑ËæìÂÖ•ÂêåÁ≠âÈáçË¶Å ================== -->
<script>
// 1. Â±ÖÂÆ∂‰∫íÂä® (Âπ≥Ë°°Áâà)
window.generateRpgStory = async function(item, userExtra) {
    // ÊèêÁ§∫Áî®Êà∑Ê≠£Âú®ÁîüÊàê
    alert(`‚è≥ Ê≠£Âú®ÁîüÊàê...\n(‰∫ã‰ª∂: ‰ΩøÁî®${item.name} + ‰Ω†ÁöÑÂä®‰Ωú: ${userExtra || "ÈªòËÆ§"})`);
    
    const context = await getRpgContext();
    if(!context) return; 

    // üî• Ê†∏ÂøÉ‰øÆÊîπÔºöÊòéÁ°ÆÂëäËØâ AI ‰∏§ËÄÖÁªìÂêà
    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊ≤ªÊÑàÁ≥ªÁîüÊ¥ªÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÂÆ∂‰∏≠„ÄÇ

„ÄêÂΩìÂâçÂèëÁîüÁöÑ‰∏§‰∏™Ë¶ÅÁ¥†„ÄëÔºö
1. **ÂÆ¢ËßÇ‰∫ã‰ª∂**ÔºöÁî®Êà∑‰ΩøÁî®‰∫ÜÊàøÈó¥ÈáåÁöÑ„Äê${item.name}„Äë„ÄÇ
2. **Áî®Êà∑‰∏ªËßÇÂä®‰Ωú**Ôºö${userExtra || "ÔºàÁî®Êà∑Ê≤°ÊúâÁâπÊÆäÂä®‰ΩúÔºåÈ°∫ÂÖ∂Ëá™ÁÑ∂Âú∞‰ΩøÁî®Ôºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ 300-500 Â≠óÁöÑÁîüÊ¥ªÁâáÊÆµ„ÄÇ
**ËØ∑Â∞Ü‰∏äËø∞‰∏§‰∏™Ë¶ÅÁ¥†ÂÆåÁæéËûçÂêàÔºö**
ÊèèÂÜôÁî®Êà∑Âú®ËøõË°å„Äê‰∏ªËßÇÂä®‰Ωú„ÄëÁöÑÂêåÊó∂ÔºåÊòØÂ¶Ç‰Ωï‰ΩøÁî®„Äê${item.name}„ÄëÁöÑ„ÄÇ
Ôºà‰æãÂ¶ÇÔºöÂ¶ÇÊûú‰∫ã‰ª∂ÊòØ‚ÄúÂ∫ä‚ÄùÔºåÂä®‰ΩúÊòØ‚ÄúÂì≠‚ÄùÔºåËØ∑ÊèèÂÜô‚ÄúË∂¥Âú®Â∫ä‰∏äÂì≠Ê≥£‚ÄùÔºõÂ¶ÇÊûúÂä®‰ΩúÊòØ‚ÄúÂºÄÂøÉ‚ÄùÔºåËØ∑ÊèèÂÜô‚ÄúÂú®Â∫ä‰∏äÂºÄÂøÉÂú∞ÊâìÊªö‚Äù„ÄÇÔºâ
ËØ∑ÈáçÁÇπÊèèÂÜôÊÑüÂÆòÁªÜËäÇ„ÄÅÊ∞õÂõ¥‰ª•ÂèäËßíËâ≤ÔºàTaÔºâÂú®ÊóÅËæπÁöÑÂèçÂ∫î„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫Ê≠£Êñá„ÄÇ
`;
    
    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üè† Â±ÖÂÆ∂ ¬∑ ${item.name}`, story);
        alert(`‚ú® ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ`);
    });
};

// 2. ÂÅ∂ÈÅáÊúãÂèã (Âπ≥Ë°°Áâà)
window.generateFriendStory = async function(friend, userExtra) {
    alert(`‚è≥ Ê≠£Âú®ÁîüÊàêÂÅ∂ÈÅáÂâßÊÉÖ...`);
    
    const context = await getRpgContext();
    if(!context) return;

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊÉÖÊÑüÁªÜËÖªÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºöÊà∑Â§ñ„ÄÇ

„ÄêÂΩìÂâçÂèëÁîüÁöÑ‰∏§‰∏™Ë¶ÅÁ¥†„ÄëÔºö
1. **ÂÆ¢ËßÇ‰∫ã‰ª∂**ÔºöÂÅ∂ÈÅá‰∫ÜÊúãÂèã„Äê${friend.name}„ÄëÔºåÊúãÂèãËØ¥Ôºö"${friend.prompt}"
2. **Áî®Êà∑ÂõûÂ∫î/ÂèçÂ∫î**Ôºö${userExtra || "ÔºàÂÆ≥ÁæûÊàñÈªòËÆ§ÂõûÂ∫îÔºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ 300-500 Â≠óÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ
**ËØ∑Âπ≥Á≠âÂú∞Â§ÑÁêÜÊúãÂèãÁöÑËØùËØ≠ÂíåÁî®Êà∑ÁöÑÂèçÂ∫îÔºö**
ÊèèÂÜôÂê¨Âà∞ÊúãÂèãËøôÂè•ËØùÂêéÔºåÁî®Êà∑ÂÅöÂá∫‰∫Ü„Äê${userExtra}„ÄëÁöÑÂèçÂ∫îÔºåÂπ∂ÊèèÂÜôËßíËâ≤ÔºàTaÔºâÂØπÊ≠§ÁöÑÁúãÊ≥ïÂíå‰∫íÂä®„ÄÇ
Ê∞õÂõ¥ÔºöÁîúËúú„ÄÅËá™ÁÑ∂„ÄÅÁîüÊ¥ªÂåñ„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫Ê≠£Êñá„ÄÇ
`;

    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üèñÔ∏è ÂÅ∂ÈÅá ¬∑ ${friend.name}`, story);
        alert(`üíå ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ`);
    });
};

// 3. ‰æøÂà©Â∫ó/Âú∫ÊôØË¥≠Áâ© (Âπ≥Ë°°Áâà)
window.generateStoreShopping = async function(item, userExtra) {
    const itemName = item.name.replace('Ë¥ßÊû∂','');
    alert(`‚è≥ Ê≠£Âú®ÁîüÊàêË¥≠Áâ©ÂâßÊÉÖ...`);
    
    const context = await getRpgContext();
    if(!context) return;

    const prompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÊûÅÂÖ∑ÁîüÊ¥ªÊ∞îÊÅØÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ„ÄëÔºö${context.global}
„ÄêÂú∫ÊôØ„ÄëÔºö‰æøÂà©Â∫ó/ÂïÜÂ∫ó„ÄÇ

„ÄêÂΩìÂâçÂèëÁîüÁöÑ‰∏§‰∏™Ë¶ÅÁ¥†„ÄëÔºö
1. **ÂÆ¢ËßÇ‰∫ã‰ª∂**ÔºöÁî®Êà∑Á´ôÂú®Ë¥ßÊû∂ÂâçÔºåÂáÜÂ§áÊåëÈÄâ„Äê${itemName}„Äë„ÄÇ
2. **Áî®Êà∑ÂÖ∑‰ΩìÊÑèÂõæ**Ôºö${userExtra || "ÔºàÈöèÊÑèÊµèËßàÊåëÈÄâÔºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑ÂÜô‰∏ÄÊÆµ 300Â∑¶Âè≥ Â≠óÁöÑÁâáÊÆµ„ÄÇ
**ËØ∑Â∞ÜÁâ©ÂìÅÂ±ûÊÄßÂíåÁî®Êà∑ÊÑèÂõæÁªìÂêàÔºö**
ÊèèÂÜôÁî®Êà∑Âú®ÊåëÈÄâ„Äê${itemName}„ÄëÁöÑËøáÁ®ãÔºåÂπ∂ÂÖ∑‰Ωì‰ΩìÁé∞Âá∫„Äê${userExtra}„ÄëËøô‰∏™ÊÑèÂõæ„ÄÇ
ÂêåÊó∂ÊèèÂÜôËßíËâ≤ÔºàTaÔºâÂú®ÊóÅËæπÁöÑÂª∫ËÆÆÊàñÂ∞èÂä®‰Ωú„ÄÇ

ËØ∑Áõ¥Êé•ËæìÂá∫Ê≠£Êñá„ÄÇ
`;

    callRpgApi(prompt, context, (story) => {
        saveRpgStory(`üè™ Ë¥≠Áâ© ¬∑ ${itemName}`, story);
        alert(`üõí ÊïÖ‰∫ãÂ∑≤ÁîüÊàêÔºÅ`);
    });
};
</script>
<script>
// ================= üõ†Ô∏è ÈÄöÁî®Âú∫ÊôØ‰øÆÊ≠£Ë°•‰∏ÅÔºöÊñ∞Âπ¥/ÂåªÈô¢/Êµ∑ËæπÁ≠â =================

// Ë¶ÜÁõñÈÄöÁî®ÁöÑÂâßÊÉÖÁîüÊàêÂô® (ÈÄÇÁî®‰∫éÔºöÊñ∞Âπ¥ÂπøÂú∫„ÄÅÂåªÈô¢„ÄÅÊµ∑Ëæπ„ÄÅÊ®±Ëä±„ÄÅÊïôÂ†Ç„ÄÅÂíñÂï°ÂéÖ)
window.generatePixelStory = async function(promptText, isR18 = false, userExtra = "") {
    // ÊèêÁ§∫Áî®Êà∑Ê≠£Âú®ÁîüÊàê
    alert(`‚è≥ Ê≠£Âú®ÁîüÊàêÂâßÊÉÖ...\n‰∫ã‰ª∂: ${promptText.substring(0,10)}...\n(‰Ω†ÁöÑÂä®‰Ωú: ${userExtra || "Êó†"})`);
    
    // Ëé∑ÂèñÊï∞ÊçÆ
    const wb = window.BIG_MEMORY.world_book || {};
    const globalCtx = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const pixelCtx = (wb['20.ÂÉèÁ¥†Â∞èÂ±ã'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    
    let apiKey = document.getElementById('api-key').value;
    if(!apiKey) { 
        try { const s = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey=s.key; } catch(e){} 
    }
    if(!apiKey) return alert("ËØ∑ÈÖçÁΩÆ API Key");

    // R18 Ê®°ÂºèÂà§Êñ≠
    let extraInstruction = isR18 ? 
        "„ÄêÁâπÊÆäÊ®°Âºè„ÄëÔºöËøôÊòØÁßÅÂØÜ‰∫íÂä®„ÄÇËØ∑ÊèèÂÜô‰∏§‰∫∫‰πãÈó¥ÊûÅÂ∫¶‰∫≤ÂØÜ„ÄÅÁîöËá≥Â∏¶ÊúâÊÉÖËâ≤Âº†ÂäõÁöÑ‰∫íÂä®„ÄÇÊèèÂÜôËß¶ÊÑü„ÄÅÂñòÊÅØ„ÄÅÁúºÁ•ûÂíåÂä®‰ΩúÔºåÂº†ÂäõÊãâÊª°„ÄÇ" : 
        "ËØ∑ÂÜô‰∏ÄÊÆµÊ∏©È¶®„ÄÅÊ≤ªÊÑà„ÄÅÂÖÖÊª°ÁîüÊ¥ªÊ∞îÊÅØÁöÑÂ∞èÊïÖ‰∫ã„ÄÇ";

    // üî• Ê†∏ÂøÉ PromptÔºöËûçÂêà‚ÄúÈªòËÆ§‰∫ã‰ª∂‚Äù‰∏é‚ÄúÁî®Êà∑ËæìÂÖ•‚Äù
    const fullPrompt = `
‰Ω†ÊòØ‰∏Ä‰ΩçÁªÜËÖªÁöÑÂ∞èËØ¥ÂÆ∂„ÄÇ
„Äê‰∏ñÁïåËßÇ/ËßíËâ≤„ÄëÔºö${globalCtx}
„ÄêÂú∫ÊôØËÆæÂÆö„ÄëÔºö${pixelCtx}

„ÄêÂΩìÂâçÊÉÖÂ¢É„ÄëÔºö
1. **Âü∫Á°Ä‰∫ã‰ª∂ (Âú∫ÊôØÈªòËÆ§)**Ôºö${promptText}
2. **Áî®Êà∑ÂÖ∑‰ΩìÂä®‰Ωú/Êåá‰ª§**Ôºö${userExtra || "ÔºàÁî®Êà∑Êú™ÊåáÂÆöÔºåÈ°∫ÂÖ∂Ëá™ÁÑ∂Ôºâ"}

„Äê‰ªªÂä°„ÄëÔºö
ËØ∑Ê†πÊçÆ‰∏äËø∞ËÆæÂÆöÔºåÂÜô‰∏ÄÊÆµ**‰∏çÂ∞ë‰∫é 400 Â≠ó**ÁöÑÂâßÊÉÖ„ÄÇ
**Ê†∏ÂøÉË¶ÅÊ±ÇÔºöËØ∑Â∞Ü„ÄêÂü∫Á°Ä‰∫ã‰ª∂„Äë‰∏é„ÄêÁî®Êà∑Âä®‰Ωú„ÄëÂêåÁ≠âÈáçËßÜ„ÄÇ**
‰∏çË¶ÅÂè™ÂÜôÂü∫Á°Ä‰∫ã‰ª∂ËÄåÂøΩÁï•‰∫ÜÁî®Êà∑ÁöÑÂä®‰ΩúÔºå‰πü‰∏çË¶ÅÂè™ÂÜôÂä®‰ΩúËÄåËÑ±Á¶ª‰∫ÜÂú∫ÊôØ„ÄÇ
ËØ∑ÊèèÂÜôÁî®Êà∑ÂÅöËøô‰∏™Âä®‰ΩúÊó∂ÔºåËßíËâ≤ÁöÑÂèçÂ∫î„ÄÅÁ•ûÊÄÅ‰ª•ÂèäÂë®Âõ¥ÁéØÂ¢ÉÁöÑÊ∞õÂõ¥ÔºàÂÖâÂΩ±„ÄÅÂ£∞Èü≥„ÄÅÊ∞îÂë≥Ôºâ„ÄÇ

${extraInstruction}
ËßÜËßíÔºöÁ¨¨‰∫å‰∫∫Áß∞‚Äú‰Ω†‚Äù„ÄÇ
ËØ∑Áõ¥Êé•ËæìÂá∫Ê≠£ÊñáÔºå‰∏çË¶Å‰ªª‰ΩïÂâçË®ÄÂêéËØ≠„ÄÇ
`;

    try {
        let apiUrl = document.getElementById('api-url').value || "https://api.openai.com/v1";
        let model = document.getElementById('model-select').value || "gpt-3.5-turbo";

        const res = await fetch(`${apiUrl.replace(/\/$/, "")}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:"You are a creative writer."}, {role:"user", content:fullPrompt}],
                temperature: 0.85,
                max_tokens: 6000
            })
        });
        const json = await res.json();
        const story = json.choices[0].message.content;
        
        // ‰øùÂ≠òÂπ∂ÊèêÁ§∫
        saveRpgStory(`ÂÉèÁ¥†Êó•Â∏∏ ¬∑ ${promptText.substring(0,5)}`, story);
        alert("‚ú® ÂâßÊÉÖÂ∑≤ÁîüÊàêÔºÅ\nËØ∑Âéª„ÄêÊïÖ‰∫ãÈõÜ„ÄëÈáåÁøªÈòÖ„ÄÇ");

    } catch(e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    }
};
// Âº∫Âà∂‰øÆÂ§çÁªèÊúüÊï∞ÊçÆË°•‰∏Å
setTimeout(async () => {
    if(typeof idb !== 'undefined') {
        const res = await idb.get('universal_store', 'period');
        if (!res || !res.data || !Array.isArray(res.data.records)) {
            console.log("Ê£ÄÊµãÂà∞ÁªèÊúüÊï∞ÊçÆÊçüÂùèÔºåÊ≠£Âú®ÈáçÁΩÆ...");
            const cleanData = { records: [], isBleeding: false, lastAnalysis: null };
            window.BIG_MEMORY.period = cleanData;
            await idb.put('universal_store', { id: 'period', data: cleanData });
        }
    }
}, 3000);
</script>
<!-- ================= üöë ÊñáÊ∏∏Á¥ßÊÄ•‰øÆÂ§çË°•‰∏Å START ================= -->
<script>
(function() {
    console.log("Ê≠£Âú®ÊâßË°åÊñáÊ∏∏Êï∞ÊçÆ‰øÆÂ§ç‰∏éÁïåÈù¢Ë∞ÉÊï¥...");

    // 1. Âº∫Âà∂Êï∞ÊçÆ‰øÆÂ§çÂáΩÊï∞
    // Ëß£ÂÜ≥ NaN ÈóÆÈ¢òÔºåÈò≤Ê≠¢Âõ†Êï∞ÊçÆ‰∏∫Á©∫ÂØºËá¥ÁöÑÁôΩÂ±è
    function repairAdvData() {
        if (!window.BIG_MEMORY) window.BIG_MEMORY = {};
        
        // Â¶ÇÊûúÊï∞ÊçÆÂÆåÂÖ®‰∏çÂ≠òÂú®ÔºåÂàùÂßãÂåñ‰∏∫Á©∫ÂØπË±°
        let data = window.BIG_MEMORY.adv_data || {};

        // Ë°•ÂÖ®Âü∫Á°ÄÂ±ûÊÄß
        if (typeof data.money !== 'number') data.money = 100;
        if (typeof data.cleanliness !== 'number') data.cleanliness = 100;
        if (typeof data.affection !== 'number') data.affection = 0;
        if (!data.name) data.name = "Áé©ÂÆ∂";
        if (!data.charName) data.charName = "Ta";

        // Ë°•ÂÖ®Â±ûÊÄßÂØπË±° (ËøôÊòØÂØºËá¥ÁôΩÂ±èÁöÑÂÖ≥ÈîÆ)
        if (!data.attributes) {
            data.attributes = { learning: 0, art: 0, talent: 0, fitness: 0 };
        }
        
        // Ë°•ÂÖ®ËÉåÂåÖÂíåÁ´ãÁªò
        if (!Array.isArray(data.inventory)) data.inventory = [];
        if (!data.avatars) data.avatars = { user: "", char: "" };

        // ÂÜôÂõûÂÜÖÂ≠òÂíåÊï∞ÊçÆÂ∫ì
        window.BIG_MEMORY.adv_data = data;
        if (typeof idb !== 'undefined' && idb.put) {
            idb.put('universal_store', { id: 'adv_data', data: data });
        }
        
        console.log("‚úÖ ÊñáÊ∏∏Êï∞ÊçÆÂ∑≤‰øÆÂ§ç");
        return data;
    }

    // 2. ÈáçÂÜôÊõ¥Ë°£ÂÆ§Ê∏≤ÊüìÂáΩÊï∞ (Â¢ûÂä†Èò≤Â¥©Ê∫É‰øùÊä§)
    window.renderClosetUI = function() {
        // ÂÖà‰øÆÂ§çÊï∞ÊçÆÔºåÁ°Æ‰øù‰∏çÊä•Èîô
        const data = repairAdvData();
        
        const container = document.getElementById('adv-scene-container');
        if(!container) return;

        container.innerHTML = ''; 
        container.style.backgroundImage = 'none'; 
        container.style.backgroundColor = '#fdfbf7';
        
        // ÂÆâÂÖ®Ëé∑ÂèñÂ±ûÊÄßÔºåÈò≤Ê≠¢ undefined
        const attr = data.attributes || { learning: 0, art: 0, talent: 0, fitness: 0 };

        const html = `
        <div class="closet-container">
            <div class="closet-header">
                <h3>üëó Êç¢Ë°£Èó¥ & ËÆæÂÆö</h3>
                <button class="m-btn small" onclick="renderAdvScene('home_room')">üîô ÂÆåÊàêÂπ∂Á¶ªÂºÄ</button>
            </div>

            <!-- ÂêçÂ≠óËÆæÂÆö -->
            <div class="morandi-card" style="padding:15px; margin-bottom:15px; background:#fff;">
                <h4 style="margin:0 0 10px 0; color:#5d4037;">üìù Ê°£Ê°àÂç°</h4>
                <div class="input-group">
                    <label>‰Ω†ÁöÑÂêçÂ≠ó</label>
                    <input type="text" id="set-adv-user" value="${data.name}" onblur="saveAdvNames()" style="border:1px solid #8d6e63; color:#5d4037;">
                </div>
                <div class="input-group" style="margin-top:10px;">
                    <label>ËßíËâ≤ÂêçÂ≠ó</label>
                    <input type="text" id="set-adv-char" value="${data.charName||'Ta'}" onblur="saveAdvNames()" style="border:1px solid #8d6e63; color:#5d4037;">
                </div>
            </div>

            <!-- Á´ãÁªò‰∏ä‰º† -->
            <div class="closet-avatars">
                <div class="closet-avatar-box" onclick="document.getElementById('upload-user-adv').click()">
                    ${data.avatars.user ? `<img src="${data.avatars.user}">` : '<span style="font-size:0.8rem; color:#999;">ÁÇπÂáª‰∏ä‰º†<br>‰Ω†ÁöÑÁ´ãÁªò</span>'}
                </div>
                <div class="closet-avatar-box" onclick="document.getElementById('upload-char-adv').click()">
                    ${data.avatars.char ? `<img src="${data.avatars.char}">` : '<span style="font-size:0.8rem; color:#999;">ÁÇπÂáª‰∏ä‰º†<br>ËßíËâ≤Á´ãÁªò</span>'}
                </div>
            </div>
            <input type="file" id="upload-user-adv" style="display:none" onchange="uploadAdvImg('user', this)">
            <input type="file" id="upload-char-adv" style="display:none" onchange="uploadAdvImg('char', this)">

                        <!-- Â±ûÊÄßË°®Ê†º -->
            <table class="attr-table">
                <tr><td>üìö Â≠¶‰π†</td><td>${attr.learning}</td></tr>
                <tr><td>üé® ÁîªÁîª</td><td>${attr.art}</td></tr>
                <tr><td>üéª ÊâçËâ∫</td><td>${attr.talent}</td></tr>
                <tr><td>üèÉ ‰ΩìËÉΩ</td><td>${attr.fitness}</td></tr>
                <tr><td>‚ù§Ô∏è ÂØπ${data.charName || 'Ta'}ÁöÑÂ•ΩÊÑü</td><td>${data.affection}</td></tr>
                
                <!-- üëáüëáüëá ÊääÁ¨¨ÂõõÊ≠•ÁöÑ‰ª£Á†ÅÂä†Âú®ËøôÈáå üëáüëáüëá -->
                <tr>
                    <td>üíç Â©öÂßª</td>
                    <td style="color:${data.isMarried ? '#d63031' : '#888'}; font-weight:bold;">
                        ${data.isMarried ? 'Â∑≤Â©ö' : 'Êú™Â©ö'}
                    </td>
                </tr>
                <!-- üëÜüëÜüëÜ Âä†Âú® Ê∏ÖÊ¥ÅÂ∫¶ ÁöÑ‰∏äÈù¢ üëÜüëÜüëÜ -->

                <tr><td>‚ú® Ê∏ÖÊ¥ÅÂ∫¶</td><td>${Math.floor(data.cleanliness || 0)}%</td></tr>
                <tr><td>üí∞ ÈáëÈí±</td><td>${Math.floor(data.money || 0)}</td></tr>
            </table>

            <div style="font-weight:bold; margin-bottom:10px;">üëú ÊàëÁöÑËÉåÂåÖ</div>
            <div class="inv-list" id="adv-inv-list"></div>
        </div>`;
        
        container.innerHTML = html;
        if(typeof renderInventoryItems === 'function') renderInventoryItems();
        
        // ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂØπËØùÊ°Ü
        if(typeof hideAdvDialog === 'function') hideAdvDialog();
    };

    // 3. Â¢ûÂº∫ÁâàÁïåÈù¢Âà∑Êñ∞ (Ëß£ÂÜ≥ NaN ÊòæÁ§∫)
    const _origUpdateUI = window.updateAdvUI;
    window.updateAdvUI = function() {
        const data = repairAdvData(); // Ëé∑Âèñ‰øÆÂ§çÂêéÁöÑÊï∞ÊçÆ
        
        // È°∂ÈÉ®Â∞èÂ§¥ÂÉè
        const avatarEl = document.getElementById('adv-user-avatar');
        if(avatarEl) {
            if (typeof ADV_CACHE !== 'undefined' && ADV_CACHE.lineUserAvatar) {
                avatarEl.style.backgroundImage = `url(${ADV_CACHE.lineUserAvatar})`;
            } else {
                avatarEl.style.backgroundColor = '#ccc';
            }
        }
        
        // Êõ¥Êñ∞ÊñáÂ≠óÔºåÁ°Æ‰øù‰∏çÊòØ NaN
        const nameEl = document.getElementById('adv-user-name');
        const cleanEl = document.getElementById('adv-stat-clean');
        const moneyEl = document.getElementById('adv-stat-money');

        if(nameEl) nameEl.innerText = data.name;
        if(cleanEl) cleanEl.innerText = Math.floor(data.cleanliness || 0);
        if(moneyEl) moneyEl.innerText = Math.floor(data.money || 0);
    };

    // 4. Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°‰øÆÂ§ç
    setTimeout(() => {
        repairAdvData();
        if(document.getElementById('adv-modal').style.display === 'flex') {
            updateAdvUI();
        }
    }, 1000);

})();
</script>

<style>
/* ================= üé® ÁïåÈù¢‰ºòÂåñÊ†∑Âºè ================= */

/* 1. ‰øÆÂ§ç‰∏ªÁïåÈù¢Ê†èÈïøÂ∫¶ (ËÆ©ÂÆÉÊõ¥È´ò„ÄÅÊõ¥ÂÆΩ„ÄÅÂ∏ÉÂ±ÄÊõ¥ÂêàÁêÜ) */
.adv-top-bar {
    height: auto !important;       /* ÂÖÅËÆ∏È´òÂ∫¶Ëá™ÈÄÇÂ∫î */
    min-height: 100px !important;  /* Â¢ûÂä†ÊúÄÂ∞èÈ´òÂ∫¶ */
    padding: 15px 20px !important; /* Â¢ûÂä†ÂÜÖËæπË∑ù */
    padding-top: max(15px, env(safe-area-inset-top)) !important; /* ÈÄÇÈÖçÂàòÊµ∑Â±è */
    
    background: rgba(255, 255, 255, 0.95) !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
    border-bottom: 1px solid rgba(0,0,0,0.1) !important;
    
    display: flex !important;
    align-items: flex-start !important; /* È°∂ÈÉ®ÂØπÈΩê */
    justify-content: space-between !important;
    z-index: 200 !important;
}

/* Áî®Êà∑‰ø°ÊÅØÂå∫ÂüüÂä†ÂÆΩ */
.adv-user-info {
    flex: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
}

/* Â§¥ÂÉèÁ®çÂ§ß‰∏ÄÁÇπ */
.adv-avatar {
    width: 55px !important;
    height: 55px !important;
    border: 2px solid #2c3e50 !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
}

/* Â±ûÊÄßÊñáÂ≠óÂå∫Âüü‰ºòÂåñ */
.adv-stats {
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
}

#adv-user-name {
    font-size: 1.1rem !important;
    font-weight: bold !important;
    color: #2c3e50 !important;
    margin-bottom: 4px !important;
}

.adv-stats span:last-child {
    font-size: 0.85rem !important;
    color: #555 !important;
    background: #f0f0f0 !important;
    padding: 2px 8px !important;
    border-radius: 10px !important;
}

/* ÈÄÄÂá∫ÊåâÈíÆÊ†∑Âºè‰ºòÂåñ */
.adv-exit-btn {
    padding: 8px 15px !important;
    height: 40px !important;
    align-self: center !important; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
    background: #2c3e50 !important;
    color: white !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 0 #1a252f !important; /* Á´ã‰ΩìÊÑü */
    border: none !important;
    font-size: 0.9rem !important;
}
.adv-exit-btn:active {
    transform: translateY(2px) !important;
    box-shadow: 0 2px 0 #1a252f !important;
}

/* ‰øÆÂ§çÊõ¥Ë°£ÂÆ§‰∏çÊòæÁ§∫ÁöÑÈóÆÈ¢ò (Á°Æ‰øùÂÆπÂô®ÊúâÈ´òÂ∫¶ÂíåËÉåÊôØ) */
.closet-container {
    background: #fff !important;
    min-height: 100% !important;
    padding-bottom: 100px !important;
}
// === üßº Ê∏ÖÊ¥ÅÂ∫¶ÂΩíÈõ∂Âº∫Âà∂Ê¥óÊæ°Ë°•‰∏Å ===
const _checkCleanLogic = window.executeAdvLogic; // Ëé∑ÂèñÂΩìÂâçÈÄªËæë
window.executeAdvLogic = function(logicKey) {
    // 1. Ëé∑ÂèñÊï∞ÊçÆ
    const data = getAdvData();
    
    // 2. Ê£ÄÊü•ÔºöÂ¶ÇÊûúÊ∏ÖÊ¥ÅÂ∫¶<=0 ‰∏î Âä®‰Ωú‰∏çÊòØÊ¥óÊæ°
    if (data.cleanliness <= 0 && logicKey !== 'bath_normal') {
        // 3. Êã¶Êà™Âπ∂ÊèêÁ§∫
        return showAdvDialog("Ë∫´‰∏äÂ§™ËÑè‰∫ÜÔºåÁîöËá≥Ë¢´ËãçËùáÂåÖÂõ¥‰∫Ü...\n(ËØ∑Âéª„ÄêÊµ¥ÂÆ§„ÄëÊ≥°Êæ°ÊÅ¢Â§çÔºåÂê¶ÂàôÊó†Ê≥ïË°åÂä®)", "System");
    }
    
    // 4. ÈÄöËøáÊ£ÄÊü•ÔºåÊâßË°åÂéüÈÄªËæë
    _checkCleanLogic(logicKey);
};
</style>
<!-- ================= üöë ÊñáÊ∏∏Á¥ßÊÄ•‰øÆÂ§çË°•‰∏Å END ================= -->
<script>
// ============================================================
// üí∞ ÈáëÈí±ÂΩíÈõ∂ÁâπÊÆäÂâßÊÉÖË°•‰∏Å (‰øÆÊ≠£ÁâàÔºöÂ∏¶ÂºπÁ™óÁ°ÆËÆ§)
// ============================================================
(function() {
    // 1. Ëé∑ÂèñÂΩìÂâçÂ∑≤Â≠òÂú®ÁöÑÈÄªËæë
    const _previousLogic = window.executeAdvLogic;

    // 2. Ë¶ÜÁõñÈÄªËæëÂáΩÊï∞
    window.executeAdvLogic = function(logicKey) {
        const data = getAdvData(); 

        // Ëß¶ÂèëÊù°‰ª∂ÔºöÊ≤°Èí± + ‰∏çÊòØÂéªËµöÈí±/ÁßªÂä®/Ê¥óÊæ°
        if (data.money <= 10 && logicKey !== 'side_job' && logicKey !== 'bath_normal') {
            
            const currentScene = window.currentAdvScene || 'main_map';

            // ÊòæÁ§∫ÊèêÁ§∫
            showAdvDialog("üëõ Âõä‰∏≠ÁæûÊ∂©... Ë∫´Êó†ÂàÜÊñáÁöÑ‰Ω†ÊâìÁÆóÊÄé‰πàÂäûÔºü", "System");

            // Ê∏ÖÁ©∫Âú∫ÊôØÊåâÈíÆÔºåÂáÜÂ§áÊòæÁ§∫5‰∏™ÈÄâÈ°π
            const container = document.getElementById('adv-scene-container');
            container.innerHTML = ''; 

            const createOptBtn = (text, promptSuffix, topPercent) => {
                const btn = document.createElement('div');
                btn.className = 'adv-btn';
                btn.innerText = text;
                btn.style.cssText = `
                    position: absolute; left: 50%; transform: translateX(-50%);
                    top: ${topPercent}; z-index: 100; min-width: 180px; text-align: center;
                `;

                btn.onclick = (e) => {
                    e.stopPropagation();

                    // 1. Êó†ËÆ∫ÈÄâ‰ªÄ‰πàÔºåÂÖàÊÅ¢Â§çÂéüÊù•ÁöÑÂú∫ÊôØÁïåÈù¢ (ÊääËøô5‰∏™ÊåâÈíÆÊ∏ÖÊéâ)
                    renderAdvScene(currentScene);

                    if (!promptSuffix) {
                        // === ÊÉÖÂÜµ A: Ëá™Â∑±ËµöÈí± (ÂèñÊ∂à) ===
                        showAdvDialog("‰Ω†ÂÜ≥ÂÆöÈù†Ëá™Â∑±ÁöÑÂèåÊâãÂéªÊå£Èí±ÔºÅ(ËØ∑ÁÇπÂáªÂú∫ÊôØ‰∏≠ÁöÑÂâØ‰∏öÊåâÈíÆ)", "System");

                    } else {
                        // === ÊÉÖÂÜµ B: Ëß¶ÂèëÂºπÁ™ó (ÂÖ∂‰ΩôÂõõ‰∏™) ===
                        // 1. Â°´ÂÖ•È¢ÑËÆæÊñáÊú¨Âà∞ÈÇ£‰∏™ÈªëËâ≤ÁöÑËæìÂÖ•Ê°ÜÈáå
                        const inputEl = document.getElementById('adv-random-input');
                        inputEl.value = `(ÁâπÊÆä‰∫ã‰ª∂ÔºöÈáëÈí±ÂΩíÈõ∂) ÊàëË∫´Êó†ÂàÜÊñáÔºåÁúãÁùÄTaÔºåÂÜ≥ÂÆö„Äê${text}„Äë...`;
                        
                        // 2. ÊòæÂºèÊâìÂºÄÈÇ£‰∏™‚ÄúÈöèÊú∫‰∫ã‰ª∂ËæìÂÖ•Ê°Ü‚ÄùÔºåËÆ©‰Ω†ËÉΩ‰øÆÊîπ
                        document.getElementById('adv-random-modal').style.display = 'flex';
                    }
                };
                container.appendChild(btn);
            };

            // Ê∏≤ÊüìÈÄâÈ°π
            createOptBtn('ü§≤ ÂêëTaË¶ÅÈí±', 'beg', '20%');
            createOptBtn('üí≥ ÊúâÂÄüÊúâËøò', 'borrow', '35%');
            createOptBtn('üèÉ ÂÄü‰∫Ü‰∏çËøò', 'scam', '50%');
            createOptBtn('üî™ Êä¢Èí±', 'rob', '65%');
            createOptBtn('üí™ Ëá™Â∑±ËµöÈí± (ÂèñÊ∂à)', null, '80%'); // ÂèñÊ∂àÈîÆ
            
            return; // ÈòªÊ≠¢ÂéüÈÄªËæë
        }

        // Èí±Â§üÊàñËÄÖÊòØÂéªËµöÈí±ÔºåÊîæË°å
        _previousLogic(logicKey);
    };

    console.log("üí∞ Ë¥´Á©∑Ê®°ÊãüÂô®Ë°•‰∏Å (ÂºπÁ™óÁâà) Â∑≤Âä†ËΩΩ„ÄÇ");
})();
window.updateDreamUI = function() {
    const mode = document.getElementById('dream-mode-select').value;
    const descTitle = document.querySelector('#dream-app-modal h2');
    const descP = document.querySelector('#dream-app-modal p');
    const btn = document.querySelector('#dream-app-modal .m-btn.primary');
    const cardUiText = document.querySelector('#dream-card-table-modal .card-table-ui div');

    // ÈªòËÆ§ÊñáÊ°à
    let title = "ÊÉ≥Áü•ÈÅìtaÂÅö‰Ω†ÁöÑÊ¢¶Áî∑/Ê¢¶Â•≥Êó∂<br>‰ºöÂèëÁîü‰ªÄ‰πàÂêóÔºü";
    let sub = "ËØ∑Âú®ÂøÉ‰∏≠ÈªòÂøµËøô‰∏™ÈóÆÈ¢òÔºåÁÑ∂ÂêéÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊäΩÁâå„ÄÇ";
    let btnText = "üé¥ ÂºÄÂßãÊäΩÁâåËß£Êûê";
    let hint = "ÈªòÂøµ‚ÄúÂ¶ÇÊûú‰ªñÊòØÊàëÁöÑÊ¢¶Ëßí...‚ÄùÂπ∂ÊäΩÁâå";

    if (mode === 'become') {
        title = "Â¶ÇÊûú Ta ÂèòÊàê‰∫Ü‰Ω†...<br>‰ª£Êõø‰Ω†ÁîüÊ¥ª‰∏ÄÂ§©‰ºöÊÄéÊ†∑Ôºü";
        sub = "ÊäΩÂèñÂëΩËøêÁâåÔºåÁúãÁúã‰ªñÂ¶Ç‰ΩïÁ¨®ÊãôÊàñÂÆåÁæéÂú∞ÊâÆÊºî‰Ω†„ÄÇ";
        btnText = "üé≠ ÊäΩÂèñ‰∫íÊç¢ÂâßÊú¨";
        hint = "ÈªòÂøµ‚Äú‰ªñÂèòÊàê‰∫ÜÊàë...‚ÄùÂπ∂ÊäΩÁâå";
    } else if (mode === 'cosplay') {
        title = "Â¶ÇÊûú Ta ÂéªÊº´Â±ïÂá∫‰∫Ü‰Ω†ÁöÑCos...<br>ËøòÂéüÂ∫¶Âá†ÂàÜÔºü";
        sub = "ÊäΩÂèñÂëΩËøêÁâåÔºåÁúãÁúãÊº´Â±ï‰∏äÁöÑ‰ªñÊòØÁ§æÊ≠ªËøòÊòØÂ∞ÅÁ•û„ÄÇ";
        btnText = "üëò ÊäΩÂèñÊº´Â±ïËøîÂõæ";
        hint = "ÈªòÂøµ‚Äú‰ªñCos‰∫ÜÊàë...‚ÄùÂπ∂ÊäΩÁâå";
    } else if (mode === 'char_beauty') {
        title = "Âú®ÈÇ£‰∏™‰∏ñÁïåÁöÑÁæé‰∫∫ÂøÖÂêÉÊ¶ú...<br>Ta ÊéíÁ¨¨Âá†ÂêçÔºü";
        sub = "ÁúãÁúãÂ§ßÂÆ∂ÈÉΩÊÉ≥ÊÄé‰πà‚ÄúÂêÉ‚ÄùÊéâ‰ªñ„ÄÇÔºàÂ§ñË≤å/Ë∫´Êùê/Ê∞îË¥®ËØÑÊµãÔºâ";
        btnText = "üíã ÊäΩÂèñÊ¶úÂçïËØÑ‰ª∑";
        hint = "ÈªòÂøµ‚Äú‰ªñÁöÑÁæéÂë≥Á®ãÂ∫¶...‚ÄùÂπ∂ÊäΩÁâå";
    } else if (mode === 'user_beauty') {
        title = "Âú®ÈÇ£‰∏™‰∏ñÁïåÁöÑÁæé‰∫∫ÂøÖÂêÉÊ¶ú...<br>‰Ω† ÊéíÁ¨¨Âá†ÂêçÔºü";
        sub = "ÁúãÁúãÂ§ß‰ºóÔºàÂíå‰ªñÔºâËßâÂæó‰Ω†Âì™ÈáåÊúÄ‚ÄúÁßÄËâ≤ÂèØÈ§ê‚Äù„ÄÇ";
        btnText = "üòã ÊäΩÂèñ‰Ω†ÁöÑÊéíÂêç";
        hint = "ÈªòÂøµ‚ÄúÊàëÂú®Â§ß‰ºóÁúºÈáåÁöÑÁæéÂë≥Á®ãÂ∫¶...‚ÄùÂπ∂ÊäΩÁâå";
    } else if (mode === 'char_sleep') {
        title = "Ê∑±Â§úÔºåÂΩì‰Ω†ÁÜüÁù°Êó∂...<br>Ta ÊÇÑÊÇÑÈù†Ëøë‰∫Ü„ÄÇ";
        sub = "Ê∞¥ÁÖéÂåÖÊ®°ÂºèÔºö‰ªñÂú®‰Ω†‰∏çÁü•ÊÉÖÁöÑÊÉÖÂÜµ‰∏ãÂÅö‰∫Ü‰ªÄ‰πàÔºü";
        btnText = "üåô Êè≠ÁßòÊò®ÊôöÁöÑ‰∫ã";
        hint = "ÈªòÂøµ‚ÄúÊò®ÊôöÂèëÁîü‰∫Ü‰ªÄ‰πà...‚ÄùÂπ∂ÊäΩÁâå";
    } else if (mode === 'user_sleep') {
        title = "Ê∑±Â§úÔºåÂΩìTaÁÜüÁù°Êó∂...<br>‰Ω† ÊÇÑÊÇÑÈù†Ëøë‰∫Ü„ÄÇ";
        sub = "Ê∞¥ÁÖéÂåÖÊ®°ÂºèÔºö‰Ω†ÂØπ‰ªñ‰∏ãÊâã‰∫ÜÔºå‰ªñÁöÑÂèçÂ∫îÊòØÔºü";
        btnText = "üí§ ÂºÄÂßãÂ§úÈó¥Ë°åÂä®";
        hint = "ÈªòÂøµ‚ÄúÊàëÂØπÁÜüÁù°ÁöÑ‰ªñ...‚ÄùÂπ∂ÊäΩÁâå";
    } 
    // üëáüëáüëá ËøôÈáåÊòØÊñ∞Â¢ûÁöÑÈÉ®ÂàÜ üëáüëáüëá
    else if (mode === 'meeting') {
        title = "Êó∂ÂÖâÂÄíÊµÅ...<br>ÂàùËßÅÈÇ£‰∏ÄÂàªÔºå‰ªñÊòØÊÄé‰πàÊÉ≥ÁöÑÔºü";
        sub = "‰∏ÄËßÅÈíüÊÉÖËøòÊòØÊó•‰πÖÁîüÊÉÖÔºüÊè≠Áßò‰ªñÂΩìÊó∂ÁöÑÁä∂ÊÄÅÂíåÂÜÖÂøÉBGM„ÄÇ";
        btnText = "üíò ÊäΩÂèñÁõ∏ÈÅáÂõûÂøÜ";
        hint = "ÈªòÂøµ‚ÄúÊàë‰ª¨Áõ∏ÈÅáÁöÑÈÇ£‰∏ÄÂàª...‚ÄùÂπ∂ÊäΩÁâå";
    }
    // üëÜüëÜüëÜ Êñ∞Â¢ûÁªìÊùü üëÜüëÜüëÜ

    descTitle.innerHTML = title;
    descP.innerText = sub;
    btn.innerText = btnText;
    if(cardUiText) cardUiText.innerText = hint;
}
// 2. Ê†∏ÂøÉÁîüÊàêÈÄªËæë (‰∏•Ê†ºÊâßË°å Prompt)
window.finishDreamDrawing = async function() {
    if(dreamFlippedCards.length === 0) return alert("ËØ∑Ëá≥Â∞ëÁøªÂºÄ‰∏ÄÂº†ÁâåÔºÅ");
    
    closeDreamCardTable(); 
    
    const resultArea = document.getElementById('dream-result-area');
    resultArea.style.display = 'block';
    
    const mode = document.getElementById('dream-mode-select').value;
    
    let loadingText = "Ê≠£Âú®ËøûÊé•Ê¢¶Â¢ÉÊΩúÊÑèËØÜ...";
    if (mode.includes('beauty')) loadingText = "Ê≠£Âú®Êî∂ÈõÜÂ§ß‰ºóÁÇπËØÑÊï∞ÊçÆ...";
    if (mode.includes('sleep')) loadingText = "Ê≠£Âú®ÂõûÊ∫ØÊò®Â§úÁöÑÁßÅÂØÜËÆ∞ÂøÜ...";
    
    document.getElementById('dream-analysis-content').innerHTML = `<div class="skeleton-text">${loadingText}</div>`;

    // ÂáÜÂ§áÊï∞ÊçÆ
    let cardsDesc = dreamFlippedCards.map(c => {
        let name = (c.type === 'tarot') ? TAROT_NAMES[c.id] : LENORMAND_NAMES[c.id];
        let status = (c.type === 'tarot' && c.isReversed) ? "(ÈÄÜ‰Ωç)" : "";
        return `${name}${status}`;
    }).join(", ");

    const wb = window.BIG_MEMORY.world_book || {};
    const globalContext = (wb['1.ÂÖ®Â±Ä'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");
    const dreamContext = (wb['10.ÂÅáÂ¶Ç‰Ω†ÊòØtaÁöÑÊ¢¶Ëßí'] || []).filter(i=>i.enabled).map(i=>i.content).join("\n");

    let apiKey = document.getElementById('api-key').value; 
    let apiUrl = document.getElementById('api-url').value;
    let model = document.getElementById('model-select').value;
    
    if(!apiKey) {
        try { const saved = JSON.parse(localStorage.getItem('api_settings_draft') || '{}'); apiKey = saved.key; apiUrl = saved.url; model = saved.model; } catch(e){}
    }
    if(!apiKey) return alert("ËØ∑ÂÖàÈÖçÁΩÆ API KeyÔºÅ");

    // === üåü Prompt ÊûÑÂª∫Âå∫Âüü ===
    let prompt = "";
    
    // Âü∫Á°ÄÊåá‰ª§ÔºöÂº∫Ë∞ÉÁâåÊÑè‰ºòÂÖà
    const baseInstruction = `
    ‰Ω†ÊòØ‰∏Ä‰∏™Ê∑±Â∫¶ËßíËâ≤ÂàÜÊûêÂ∏àÂíåÂàõÊÑèÁºñÂâß„ÄÇ
    „Äê‰∏ñÁïå‰π¶/ËßíËâ≤ËÆæÂÆö„ÄëÔºö${globalContext}
    „ÄêÊäΩÂà∞ÁöÑÂëΩËøêÁâå„ÄëÔºö${cardsDesc}
    
    ‚ö°Ô∏è **ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁîüÊàêÂÜÖÂÆπÂøÖÈ°ª‰ª•„ÄêÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®Ôºâ„Äë‰∏∫‰∏ªÔºå‰∏ñÁïå‰π¶‰∫∫ËÆæ‰∏∫ËæÖ„ÄÇ**
    ËØ∑Ê†πÊçÆÁâåÈù¢ÂëàÁé∞ÁöÑÁä∂ÊÄÅÔºàÂ¶ÇÔºöÊùÉÊùñÁöÑÁÉ≠ÊÉÖ„ÄÅÂú£ÊùØÁöÑÊÑüÊÄß„ÄÅÂÆùÂâëÁöÑÁêÜÊô∫/ÂÜ∑Êº†„ÄÅÈí±Â∏ÅÁöÑÁé∞ÂÆû/ËÇâÊ¨≤ÔºâÊù•ÂÜ≥ÂÆöÁîüÊàêÂÜÖÂÆπÁöÑËµ∞ÂêëÂíåËØÑ‰ª∑„ÄÇ
    
    ËØ∑‰∏•Ê†ºÁîüÊàê‰∏Ä‰∏™ HTML Ë°®Ê†º‰ª£Á†ÅÔºà<table class="dream-table">...</table>ÔºâÔºå‰∏çË¶ÅMarkdownÔºå‰∏çË¶ÅÂâçË®ÄÂêéËØ≠„ÄÇ
    `;

    // --- 1. ÂéüÁâàÊ¢¶Áî∑/Ê¢¶Â•≥ (ÂéüÂ∞Å‰∏çÂä®) ---
    if (mode === 'partner') {
        prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Ê∑±Â∫¶ËßíËâ≤ÂàÜÊûêÂ∏à„ÄÇ
ËØ∑Ê†πÊçÆ‰ª•‰∏ã‰ø°ÊÅØÔºåÂíåÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÊ†πÊçÆÁâåÊÑèÁîüÊàê‰ª•‰∏ãÂÜÖÂÆπÔºöÂàÜÊûêÂ¶ÇÊûú„ÄêËßíËâ≤„ÄëÊàê‰∏∫Áî®Êà∑ÁöÑ„ÄêÊ¢¶Áî∑/Ê¢¶Â•≥„ÄëÔºàDream Character/PartnerÔºâ‰ºöÂèëÁîü‰ªÄ‰πà„ÄÇ

„Äê‰∏ñÁïå‰π¶/ËßíËâ≤ËÆæÂÆö„ÄëÔºö
${globalContext}

„Äê"ÂÅáÂ¶Ç‰Ω†ÊòØTaÁöÑÊ¢¶Ëßí"ËÆæÂÆö„ÄëÔºö
${dreamContext}

„ÄêÊäΩÂà∞ÁöÑÁâåÔºàÂëΩËøêÊåáÂºïÔºâ„ÄëÔºö
${cardsDesc}
(ËØ∑ÁªìÂêàÁâåÊÑèÊù•Êé®ÂØºÂàÜÊûêÁªìÊûúÔºå‰æãÂ¶ÇÔºöÊùÉÊùñÁâåÂèØËÉΩ‰ª£Ë°®ÁÉ≠ÊÉÖ‰π∞Ë∞∑ÔºåÊòüÂ∏ÅÁâå‰ª£Ë°®ÊÑøÊÑèËä±Èí±ÔºåÂÆùÂâëÁâå‰ª£Ë°®ÁêÜÊô∫ÊàñÁ∫†Áªì)

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„ÄëÔºö
ËØ∑‰∏•Ê†ºÁîüÊàê‰∏Ä‰∏™ HTML Ë°®Ê†º‰ª£Á†ÅÔºà<table>...</table>ÔºâÔºå‰∏çË¶ÅMarkdownÊ†áËÆ∞„ÄÇ
Ë°®Ê†ºÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãË°åÔºàRowÔºâÔºåÂ∑¶ËæπÊòØÈ°πÁõÆÔºåÂè≥ËæπÊòØÂàÜÊûêÂÜÖÂÆπÔºö

1. **ËßíËâ≤ÂÆö‰Ωç**ÔºöÊòØÊ¢¶Áî∑ËøòÊòØÊ¢¶Â•≥Ôºü(Ê†πÊçÆËßíËâ≤ÊÄßÂà´Âà§Êñ≠)
2. **‰π∞Ë∞∑Êï∞Èáè**Ôºö‰ºö‰π∞Â§öÂ∞ëÂë®ËæπÔºü(Êï∞ÈáèÁ∫ß)
3. **ÂñúÊ¨¢ÁöÑË∞∑**ÔºöÊúÄÂñúÊ¨¢‰π∞‰ªÄ‰πàÊ†∑ÁöÑÂë®ËæπÔºüÊúÄÂñúÊ¨¢‰ªÄ‰πàÊ†∑ÁöÑÊüÑÂõæÔºü(ÂêßÂîß/Á´ãÁâå/Ê£âËä±Â®ÉÂ®ÉÁ≠â)ÔºàÁî®Êà∑Âçï‰∫∫/Áî®Êà∑ÁöÑÂç∞Ë±°Êúç/Áî®Êà∑ÁöÑË±°ÂæÅÁâ©Á≠âÔºâ
4. **ÁâàÊùÉÊÑèËØÜ**Ôºö‰ºö‰∏ç‰ºöËÄÉËôë‰π∞ÁâàÊùÉ/‰π∞Êñ≠Ôºü
5. **ÂêåÊãÖÊÄÅÂ∫¶**ÔºöÂØπÂÖ∂‰ªñÂêå‰ª∑/ÂêåÊãÖÂàÜÂà´ÁöÑÊÄÅÂ∫¶Ôºü(Â´âÂ¶í/ÂèãÂñÑ/Êó†ËßÜ)
6. **ÊúàÊ∂àË¥π**ÔºöÊØè‰∏™Êúà‰ºöËä±Â§öÂ∞ëÈí±Âú®Ê¢¶Âêë‰∫ã‰ª∂‰∏äÔºü
7. **Á∫¶Á®øÂÅèÂ•Ω**Ôºö‰ºöÁ∫¶‰ªÄ‰πàÊ†∑ÁöÑÁ®ø‰ª∂Ôºü(ÊèíÂõæ/Êñá/Êù°Êº´)
8. **ÊúÄÂºÄÂøÉÁöÑ‰∫ã**ÔºöÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÊúÄÂºÄÂøÉÁöÑ‰∫ãÊÉÖÔºü
9. **ÊúÄÁóõËã¶ÁöÑ‰∫ã**ÔºöÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÊúÄÁóõËã¶ÁöÑ‰∫ãÊÉÖÔºü
10. **ÂàùÂßãÂøÉÊÉÖ**Ôºö‰∏ÄÂºÄÂßãÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÁöÑÂøÉÊÉÖÔºü

ÂàÜÊûêÂÜÖÂÆπË¶ÅÁ¨¶ÂêàËßíËâ≤ÊÄßÊ†ºÔºåÂπ∂ËûçÂêàÁâåÊÑèÔºåÂπ∂Ë∞®ËÆ∞ËßíËâ≤ÂÅöÊ¢¶Áî∑/Ê¢¶Â•≥ÊòØÂíåÁé∞ÂÆû‰∏ÄÊ†∑ÂÅöÊ¢¶Â•≥/Ê¢¶Áî∑ÁöÑÊÉÖÂÜµÔºåËßíËâ≤‰∏çÊ∏ÖÊ•öÁî®Êà∑ÊÄé‰πàÁúãÂæÖ‰ªñ/Â•π‰πü‰∏çÁü•ÈÅìÁî®Êà∑ÊòØÂê¶ÁúüÂÆûÂ≠òÂú®ÔºåÊòØÂê¶Âíå‰ªñ/Â•πË∞àÊÅãÁà±„ÄÇ
`;
    } 
    // --- 2. ‰∫íÊç¢Ë∫´‰Ωì (ÂéüÂ∞Å‰∏çÂä®) ---
    else if (mode === 'become') {
        prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™ÂàõÊÑèÁºñÂâß„ÄÇÁé∞Âú®ÂèëÁîü‰∫Ü‰∏Ä‰∏™Â•áÂπª‰∫ã‰ª∂ÔºöÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÂàÜÊûê„ÄêËßíËâ≤„ÄëÁ™ÅÁÑ∂ÁÅµÈ≠Ç‰∫íÊç¢ÔºåÂèòÊàê‰∫Ü„ÄêÁî®Êà∑(Êàë)„ÄëÁöÑË∫´‰ΩìÔºåÂπ∂‰ª£ÊõøÁî®Êà∑ÁîüÊ¥ª‰∫Ü‰∏ÄÂ§©ÁöÑÊÉÖÂÜµ„ÄÇ
„Äê‰∏ñÁïå‰π¶/ËßíËâ≤„ÄëÔºö${globalContext}
„ÄêÂëΩËøêÁâå (ÂÜ≥ÂÆö‰ªñÊâÆÊºîÂæóÊòØÂê¶È°∫Âà©)„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„ÄëÔºö
ËØ∑‰∏•Ê†ºÁîüÊàê‰∏Ä‰∏™ HTML Ë°®Ê†º‰ª£Á†ÅÔºà<table>...</table>ÔºâÔºå‰∏çË¶ÅMarkdown„ÄÇ
Ë°®Ê†ºÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãË°åÔºàRowÔºâÔºåÂ∑¶ËæπÊòØÈ°πÁõÆÔºåÂè≥‰æßÊòØËØ¶ÁªÜ‰∏îÊúâË∂£ÁöÑÊèèËø∞Ôºö

1. **ÊÄßÊ†ºÊâÆÊºî**Ôºö‰ªñÂ¶Ç‰ΩïÊ®°‰ªøÁî®Êà∑ÁöÑÊÄßÊ†ºÔºü(ÊòØÊãôÂä£ËøòÊòØÂÆåÁæéÔºü)
2. **Â≠¶‰π†‰π†ÊÉØ**Ôºö‰ªñË¢´Ëø´Â≠¶‰π†‰∫ÜÁî®Êà∑ÁöÑÂì™‰∫õ‰π†ÊÉØÔºü(ÊØîÂ¶ÇÁÜ¨Â§ú„ÄÅÂêÉÈõ∂È£ü„ÄÅÂè£Â§¥Á¶Ö)
3. **Á§æ‰∫§Â∫îÂØπ**Ôºö‰ªñÊòØÊÄé‰πàÂíåÁî®Êà∑ÁöÑÊúãÂèã‰∫§ÊµÅÁöÑÔºü(ÊúâÊ≤°ÊúâÈú≤È¶ÖÔºü)
4. **‰ª£Áè≠Â∑•‰Ωú/‰∏äÂ≠¶**Ôºö‰ªñÊõøÁî®Êà∑Âéª‰∏äÂ≠¶ÊàñÂ∑•‰ΩúÊó∂ÂèëÁîü‰∫Ü‰ªÄ‰πàË∂£‰∫ãÔºü
5. **ÂÆ∂Â∫≠Âë®Êóã**ÔºöÊÄé‰πàÂíåÁî®Êà∑ÁöÑÂÆ∂Èáå‰∫∫Êâì‰∫§ÈÅìÔºü
6. **Áïô‰ø°ÂÜÖÂÆπ**Ôºö‰∫íÊç¢ÁªìÊùüÂâçÔºå‰ªñÁªôÁî®Êà∑Áïô‰∏ãÁöÑ‰∏ÄÂ∞Å‰ø°ÁöÑÂÜÖÂÆπÊ¶ÇË¶Å„ÄÇ
7. **ÂºÇÊ†∑ÂØüËßâ**ÔºöÂë®Âõ¥‰∫∫ÊúÄÂêéÊúâÊ≤°ÊúâÂèëÁé∞‰∏çÂØπÂä≤Ôºü
8. **Ëá™ÊàëÊâìÂàÜ**ÔºöËßíËâ≤ÁªôËá™Â∑±‰ªäÂ§©ÁöÑÊâÆÊºîÊâìÂá†ÂàÜ (0-100)Ôºü

ËØ∑ÁªìÂêàÁâåÊÑèÔºöÂ¶ÇÊûúÁâåÈù¢ÁßØÊûÅÔºåËØ¥Êòé‰ªñÊâÆÊºîÂæóÂæàÊàêÂäüÔºõÂ¶ÇÊûúÁâåÈù¢Ê∑∑‰π±ÔºåËØ¥Êòé‰ªñÊâãÂøôËÑö‰π±„ÄÇ
`;
    } 
    // --- 3. Cosplay (ÂéüÂ∞Å‰∏çÂä®) ---
    else if (mode === 'cosplay') {
        prompt = `
‰Ω†ÊòØ‰∏Ä‰∏™Êº´Â±ïËßÇÂØüÂëò„ÄÇÊ†πÊçÆÁâåÊÑèÁîüÊàêÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÂàÜÊûêÂÅáËÆæ„ÄêËßíËâ≤„ÄëÂéªÂèÇÂä†Êº´Â±ïÔºåÂπ∂‰∏îÂá∫ CosplayÔºåÂá∫ÁöÑËßíËâ≤Á´üÁÑ∂ÊòØ„ÄêÁî®Êà∑(Êàë)„Äë„ÄÇ
„Äê‰∏ñÁïå‰π¶/ËßíËâ≤„ÄëÔºö${globalContext}
„ÄêÂëΩËøêÁâå (ÂÜ≥ÂÆöÊº´Â±ïÁöÑËøêÂäø)„ÄëÔºö${cardsDesc}

„Äê‰ªªÂä°Ë¶ÅÊ±Ç„ÄëÔºö
ËØ∑‰∏•Ê†ºÁîüÊàê‰∏Ä‰∏™ HTML Ë°®Ê†º‰ª£Á†ÅÔºà<table>...</table>ÔºâÔºå‰∏çË¶ÅMarkdown„ÄÇ
Ë°®Ê†ºÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãË°åÔºàRowÔºâÔºåÂ∑¶‰æßÊòØÈ°πÁõÆÔºåÂè≥‰æßÊòØËØ¶ÁªÜÊèèËø∞Ôºö

1. **ËøòÂéüÂ∫¶Ëá™ËØÑ**ÔºöËßíËâ≤ËßâÂæóËá™Â∑±CosÂæóÂÉèÂêóÔºü
2. **Ë∑Ø‰∫∫ËØÑ‰ª∑**ÔºöË∑Ø‰∫∫/ÊëÑÂΩ±Â∏àÂØπËøô‰∏™CosÁöÑËØÑ‰ª∑ (‰ª•‰∏∫ÊòØÂéüËÆæËøòÊòØ‰∫åËÆæÔºü)„ÄÇ
3. **ÂêåË°åËØÑ‰ª∑**Ôºö‰ªñÂØπÊº´Â±ï‰∏äÂÖ∂‰ªñÂá∫„ÄêÁî®Êà∑„ÄëÁöÑCoserÁöÑÁúãÊ≥ï„ÄÇ
4. **ÊàòÂà©ÂìÅ**ÔºöÊî∂Âà∞‰∫ÜÂ§öÂ∞ëÊäïÂñÇÈõ∂È£üÂíåÊó†ÊñôÔºü
5. **Âú∫ÁÖßËΩ∞Âä®**ÔºöÂú®Êº´Â±ïÊàñÊúãÂèãÂúàÊòØÂê¶ÂºïËµ∑‰∫ÜËΩ∞Âä®Ôºü
6. **CosÊÑüÂèó**ÔºöÊâÆÊºîÊàêÁî®Êà∑ÂéªÊº´Â±ïÔºå‰ªñÁöÑÂÜÖÂøÉÁúüÂÆûÊÑüÂèó„ÄÇ
7. **‰∏ÄÊó•ÊÄªÁªì**ÔºöCosplay‰∏ÄÂ§©ÁöÑÊï¥‰ΩìÊÉÖÂÜµÊÄªÁªì„ÄÇ

ËØ∑ÁªìÂêàÁâåÊÑèËøõË°åÊé®Êºî„ÄÇ
`;
    }
    // --- 4. ËßíËâ≤ÂøÖÂêÉÊ¶ú (Êñ∞) ---
    else if (mode === 'char_beauty') {
        prompt = `${baseInstruction}
        „ÄêÊÉÖÂ¢É„ÄëÔºöÂú®ËßíËâ≤ÁöÑ‰∏ñÁïåÈáåÔºåÊúâ‰∏Ä‰∏™‚ÄúÁæé‰∫∫ÂøÖÂêÉÊ¶ú‚Äù„ÄÇÊ†πÊçÆÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÂàÜÊûê„ÄêËßíËâ≤Êú¨‰∫∫„ÄëÁöÑ‰∏äÊ¶úÊÉÖÂÜµ„ÄÇ
        Ë°®Ê†ºÂÜÖÂÆπÔºö
        1. **Ëá™ÊàëÊéíÂêç**Ôºö‰ªñËÆ§‰∏∫Âú®‰ªñÁöÑ‰∏ñÁïåÁæé‰∫∫ÂøÖÂêÉÊ¶úÊòØÁ¨¨Âá†ÂêçÔºü
        2. **Â§ßÂÆ∂ËÆ§‰∏∫‰ªñÊúÄÁßÄËâ≤ÂèØÈ§êÁöÑÁÇπ**ÔºöÂ§ß‰ºóÂØπ‰ªñÊúÄÊÉ≥‚ÄúÂêÉ‚ÄùÁöÑÂú∞Êñπ„ÄÇ
        3. **‰ªñËá™ËÆ§‰∏∫ÊúÄÂê∏Âºï‰∫∫ÁöÑÁÇπ**Ôºö‰ªñËßâÂæóËá™Â∑±Âì™ÈáåÊúÄËø∑‰∫∫„ÄÇ
        4. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑÊâãÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÂØπ‰ªñÊâãÁöÑËØÑ‰ª∑„ÄÇ
        5. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑËÑ∏ÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÂØπ‰ªñËÑ∏ÁöÑËØÑ‰ª∑„ÄÇ
        6. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑÊ∞îË¥®ÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÂØπ‰ªñÊ∞îË¥®ÁöÑËØÑ‰ª∑„ÄÇ
        7. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑËÖ∞/ËÖπËÇåÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÂØπ‰ªñËÖ∞Ë∫´ÁöÑËØÑ‰ª∑„ÄÇ
        8. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑ‰ΩìÂûãÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÂØπ‰ªñ‰ΩìÂûãÁöÑËØÑ‰ª∑„ÄÇ
        9. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑËÖø/ËÑöÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÂØπ‰ªñËÖøËÑöÁöÑËØÑ‰ª∑„ÄÇ
        10. **Â§ßÂÆ∂ÂØπ‰ªñÁöÑÊÄßÂô®ÔºàÂπªÊÉ≥ÔºâÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÁöÑÁßÅÂØÜÂπªÊÉ≥ËØÑ‰ª∑(ËØ∑ÈöêÊô¶ËÄåËØ±ÊÉëÂú∞ÊèèËø∞)„ÄÇ
        11. **‰ªñÂÆûÈôÖÂú®‰∏ñÁïåÁæé‰∫∫ÂøÖÂêÉÊ¶úÁöÑÂâçÂá†‰ª•ÂèäÂøÖÂêÉÁöÑÂéüÂõ†**ÔºöÂÆ¢ËßÇÊéíÂêçÂíåÂéüÂõ†„ÄÇ
        `;
    }
    // --- 5. Áî®Êà∑ÂøÖÂêÉÊ¶ú (Êñ∞ - ‰øÆÊ≠£Áâà) ---
    else if (mode === 'user_beauty') {
        prompt = `${baseInstruction}
        „ÄêÊÉÖÂ¢É„ÄëÔºöÂú®ËßíËâ≤ÁöÑ‰∏ñÁïåÈáåÔºå„ÄêÁî®Êà∑(Êàë)„Äë‰πüÊòØÊ¶ú‰∏äÊúâÂêç„ÄÇÊ†πÊçÆÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÂàÜÊûê„ÄêÁî®Êà∑„ÄëÁöÑ‰∏äÊ¶úÊÉÖÂÜµ„ÄÇ
        **Ê≥®ÊÑè**ÔºöÈô§‰∫ÜÁ¨¨1È°πÂíåÁ¨¨3È°πÊòØËßíËâ≤ÁöÑËßÇÁÇπÔºåÂÖ∂‰ªñÈ°πÂÖ®ÊòØ„ÄêÂ§ß‰ºó/Â§ßÂÆ∂„ÄëÁöÑËßÇÁÇπ„ÄÇ
        
        Ë°®Ê†ºÂÜÖÂÆπÔºö
        1. **ËßíËâ≤ËÆ§‰∏∫Áî®Êà∑Âú®ÂøÖÂêÉÊ¶úÂâçÂá†Âêç**ÔºöËßíËâ≤ÂøÉ‰∏≠ÁöÑÊéíÂêç„ÄÇ
        2. **Â§ßÂÆ∂ËÆ§‰∏∫Áî®Êà∑ÊúÄÁßÄËâ≤ÂèØÈ§êÁöÑÁÇπ**ÔºöÂ§ß‰ºóËßâÂæóÁî®Êà∑Âì™ÈáåÊúÄËØ±‰∫∫Ôºü
        3. **ËßíËâ≤ËÆ§‰∏∫Áî®Êà∑ÊúÄÂê∏Âºï‰∫∫ÁöÑÁÇπ**ÔºöËßíËâ≤Áúº‰∏≠Áî®Êà∑ÊúÄËø∑‰∫∫ÁöÑÂú∞Êñπ„ÄÇ
        4. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑÊâãÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóËØÑ‰ª∑„ÄÇ
        5. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑËÑ∏ÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóËØÑ‰ª∑„ÄÇ
        6. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑÊ∞îË¥®ÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóËØÑ‰ª∑„ÄÇ
        7. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑËÖ∞/ËÖπËÇåÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóËØÑ‰ª∑„ÄÇ
        8. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑ‰ΩìÂûãÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóËØÑ‰ª∑„ÄÇ
        9. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑËÖø/ËÑöÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóËØÑ‰ª∑„ÄÇ
        10. **Â§ßÂÆ∂ÂØπÁî®Êà∑ÁöÑÊÄßÂô®ÔºàÂπªÊÉ≥ÔºâÁöÑËØÑ‰ª∑**ÔºöÂ§ß‰ºóÁöÑÁßÅÂØÜÂπªÊÉ≥ËØÑ‰ª∑(ËØ∑ÈöêÊô¶ËÄåËØ±ÊÉëÂú∞ÊèèËø∞)„ÄÇ
        11. **Áî®Êà∑ÂÆûÈôÖÂú®‰∏ñÁïåÁæé‰∫∫ÂøÖÂêÉÊ¶úÁöÑÂâçÂá†‰ª•ÂèäÂøÖÂêÉÁöÑÂéüÂõ†**ÔºöÂÆ¢ËßÇÊéíÂêçÂíåÂéüÂõ†„ÄÇ
        `;
    }
    // --- 6. ËßíËâ≤Ê∞¥ÁÖéÂåÖ (Êñ∞) ---
    else if (mode === 'char_sleep') {
        prompt = `${baseInstruction}
        „ÄêÊÉÖÂ¢É„ÄëÔºöËßíËâ≤ÂØπÁî®Êà∑ËøõË°å‰∫Ü‚ÄúÊ∞¥ÁÖéÂåÖ‚ÄùÔºàÁù°Â•∏Ôºâ„ÄÇ
        ËØ∑‰∏•Ê†ºÊ†πÊçÆÁâåÊÑè/ÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÂÜ≥ÂÆöË°å‰∏∫„ÄÇ
        Ë°®Ê†ºÂÜÖÂÆπÔºö
        1. **‰ªÄ‰πàÊó∂Èó¥ËøõË°åÁöÑ**ÔºöÂÖ∑‰ΩìÊó∂Èó¥„ÄÇ
        2. **‰∏∫‰ªÄ‰πàÂøΩÁÑ∂ÊÉ≥Ëøô‰πàÂÅö**ÔºöÂä®Êú∫„ÄÇ
        3. **ËøòÊ≤°ÂºÄÂßãÊó∂‰ªñÁúãÁî®Êà∑ÁöÑÁä∂ÊÄÅ**ÔºöÂáùËßÜ‰∏éÊÉ≥Ê≥ï„ÄÇ
        4. **ÂâçÊàèÊó∂‰ªñÊ≥®ÊÑèÂà∞ÁöÑÁî®Êà∑ÁöÑÂèçÂ∫îÂíå‰ªñÁöÑË°å‰∏∫**ÔºöÁªÜËäÇÊèèÂÜô„ÄÇ
        5. **Ê≠£Âú®ËøõË°åÊó∂‰ªñËßÇÂØüÁöÑÁî®Êà∑ÁöÑÂèçÂ∫îÂíå‰ªñÁöÑË°å‰∏∫**ÔºöËøáÁ®ãÁªÜËäÇ„ÄÇ
        6. **Ê≠£Âú®ËøõË°åÊó∂‰ªñÂú®ÊÉ≥‰ªÄ‰πà**ÔºöÂøÉÁêÜÊ¥ªÂä®„ÄÇ
        7. **È©¨‰∏äË¶ÅÁªìÊùü‰∫Ü‰ªñËßÇÂØüÁöÑÁî®Êà∑ÁöÑÂèçÂ∫îÂíå‰ªñÁöÑË°å‰∏∫**ÔºöÈ´òÊΩÆ/ÁªìÊùüÁªÜËäÇ„ÄÇ
        8. **Áî®Êà∑ÊòØÂê¶Ë¢´ÂêµÈÜí/‰ªÄ‰πàÈò∂ÊÆµË¢´ÂêµÈÜí**ÔºöËãèÈÜíÊÉÖÂÜµ„ÄÇ
        9. **‰∫ãÂêéÊ∏ÖÁêÜ/‰ºëÊÅØ**ÔºöÊî∂Â∞æÂ∑•‰Ωú„ÄÇ
        10. **‰ªñÂØπÊ≠§Ê¨°‰∫ã‰ª∂ÁöÑËØÑ‰ª∑**ÔºöÊª°Ë∂≥ÊÑüÊàñÂèçÊÄù„ÄÇ
        `;
    }
    // --- 7. Áî®Êà∑Ê∞¥ÁÖéÂåÖ (Êñ∞) ---
    else if (mode === 'user_sleep') {
        prompt = `${baseInstruction}
        „ÄêÊÉÖÂ¢É„ÄëÔºöÁî®Êà∑ÂØπËßíËâ≤ËøõË°å‰∫Ü‚ÄúÊ∞¥ÁÖéÂåÖ‚ÄùÔºàÁù°Â•∏Ôºâ„ÄÇÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÊ†πÊçÆÁâåÊÑèÂàÜÊûêÁîüÊàê‰ª•‰∏ãÂÜÖÂÆπÔºö
        Ë°®Ê†ºÂÜÖÂÆπÔºö
        1. **ËøòÊ≤°ÂºÄÂßãÊó∂ËßíËâ≤ÁöÑÂèçÂ∫î**ÔºöÁù°Âßø/ÂëºÂê∏/Èò≤Â§áÂøÉ„ÄÇ
        2. **ÂâçÂ§ïÊó∂ËßíËâ≤ÁöÑÁä∂ÊÄÅ/ÂèçÂ∫î**ÔºöÁîüÁêÜÊàñÊΩúÊÑèËØÜÂèçÂ∫î„ÄÇ
        3. **Ê≠£Âú®ËøõË°åÊó∂ËßíËâ≤ÁöÑÁä∂ÊÄÅ/ÂèçÂ∫î**ÔºöË∫´‰ΩìÂèçÂ∫î/Ê¢¶Âëì„ÄÇ
        4. **È©¨‰∏äÁªìÊùü‰∫ÜËßíËâ≤ÁöÑÁä∂ÊÄÅ/ÂèçÂ∫î**ÔºöÈ´òÊΩÆ/ÁªìÊùüÂèçÂ∫î„ÄÇ
        5. **ËßíËâ≤ÁöÑÊÑüÂèó**ÔºöË∫´‰ΩìÂíåÂøÉÁêÜÁöÑÁúüÂÆûÊÑüÂèóÔºàÂøÖÈ°ªÂü∫‰∫éÁâåÊÑèÔºâ„ÄÇ
        6. **ËßíËâ≤ÊòØÂê¶Ë¢´ÂêµÈÜí/ÂÖ®Á®ãÁöÑÊÑèËØÜÁä∂ÊÄÅ**ÔºöÊ∏ÖÈÜíÁ®ãÂ∫¶„ÄÇ
        7. **ËßíËâ≤ÂØπÊ≠§‰∫ãÁöÑÊÑüÂèó**ÔºöÈÜíÊù•ÂêéÊàñÊΩúÊÑèËØÜÈáåÁöÑÁúãÊ≥ï„ÄÇ
        8. **ËßíËâ≤ÊÉ≥ËØ¥ÁöÑËØù**ÔºöÂøÉÈáåËØù„ÄÇ
        `;
    }
// --- 8. ÂÖ≥‰∫éÁõ∏ÈÅá (Êñ∞Â¢û) ---
else if (mode === 'meeting') {
    prompt = `${baseInstruction}
    „ÄêÊÉÖÂ¢É„ÄëÔºöÂõûÊ∫ØËßíËâ≤‰∏éÁî®Êà∑ÔºàÊàëÔºâÁöÑÂàùÈÅáÊó∂Âàª„ÄÇÁâåÊÑèÔºàÁâåÈù¢ÁöÑËÉΩÈáèÊµÅÂä®ÔºâÊ†πÊçÆÁâåÊÑèËøõË°åÂàÜÊûê„ÄÇ
    
    Ë°®Ê†ºÂÜÖÂÆπÔºö
    1. **‰∏ÄËßÅÈíüÊÉÖËøòÊòØÊó•‰πÖÁîüÊÉÖ**ÔºöÂÆöÊÄßÂàÜÊûê„ÄÇ
    2. **ÂΩìÊó∂‰ªñÁöÑÁä∂ÊÄÅ**ÔºöÊúâÊ≤°ÊúâË¢´Èúá‰ΩèÔºüÊòØÂÜ∑ÈùôËßÇÂØüËøòÊòØÂøÉË∑≥Âä†ÈÄüÔºü
    3. **‰ªñÂèëÁé∞Ëá™Â∑±ÂñúÊ¨¢‰∏äÁî®Êà∑ÂêéÁöÑÁä∂ÊÄÅ**ÔºöÂøÉÁêÜÊ¥ªÂä®‰∏éÂ§ñÂú®Ë°®Áé∞„ÄÇ
    4. **‰ªñ‰ªÄ‰πàÊó∂ÂÄôÂºÄÂßãÊúüÂæÖÂíåÁî®Êà∑ÁöÑÊú™Êù•**ÔºöÂÖ∑‰ΩìÂ•ëÊú∫ÊàñÁû¨Èó¥„ÄÇ
    5. **‰ªñ‰ºöÊÄé‰πàÊèèÁªòÂøÉ‰∏≠Á¨¨‰∏ÄÁúºÁöÑÁî®Êà∑**ÔºöËßÜËßâ‰∏éÊÑüËßâÁöÑÊèèËø∞„ÄÇ
    6. **‰ªñÂØπÁé∞Âú®ÁöÑÁî®Êà∑ÁöÑÊÉ≥Ê≥ï**ÔºöÈöèÁùÄ‰∫ÜËß£Âä†Ê∑±ÂêéÁöÑÁúãÊ≥ï„ÄÇ
    7. **‰ªñËÆ§‰∏∫‰Ω†Á¨¨‰∏ÄÁúºÂíåÁé∞Âú®ÊúÄÂ§ßÁöÑ‰∏çÂêåÊòØ‰ªÄ‰πà**ÔºöÂèçÂ∑ÆËêåÊàñÊàêÈïø„ÄÇ
    8. **‰ªñÁ¨¨‰∏ÄÁúºÁúãËßÅÁî®Êà∑ÊÉ≥Ëµ∑ÁöÑÊòØÂì™È¶ñÈü≥‰πê**Ôºö(Áé∞ÂÆûÊ≤°ÊúâÁöÑÈü≥‰πêËØ∑ÂΩ¢ÂÆπÊóãÂæãÂíåÊ≠åËØçÂ§ßÊÑè)„ÄÇ
    9. **‰ªñÂØπÁî®Êà∑‰ª•ÂâçÁöÑÂä®Áâ©Â°ë**ÔºöÂàùÂç∞Ë±°ÂÉè‰ªÄ‰πàÂä®Áâ©Ôºü
    10. **‰ªñÂØπÁî®Êà∑ÁõÆÂâçÁöÑÂä®Áâ©Â°ë**ÔºöÁé∞Âú®ËßâÂæó‰Ω†ÂÉè‰ªÄ‰πàÂä®Áâ©Ôºü
    `;
}

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model || "gpt-3.5-turbo",
                messages: [{ role: "system", content: "You are a creative writer. Output HTML Table only." }, { role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const json = await res.json();
        let content = json.choices[0].message.content;
        
        content = content.replace(/```html/g, "").replace(/```/g, "").trim();
        // Âº∫Âà∂Âä†‰∏äÊ†∑ÂºèÁ±ª
        if(!content.includes('class="dream-table"')) {
            content = content.replace('<table>', '<table class="dream-table">');
        }

        document.getElementById('dream-analysis-content').innerHTML = content;
        
        // ‰øùÂ≠òÈÄªËæë (Âä†‰∏äÊ®°ÂºèÊ†áËÆ∞ emoji)
        const emojiMap = {
            'partner': 'ü¶Ñ', 'become': 'üé≠', 'cosplay': 'üëò',
            'char_beauty': 'üíã', 'user_beauty': 'üòã',
            'char_sleep': 'üåô', 'user_sleep': 'üí§' ,  'meeting': 'üíò'
        };
        
        currentDreamResult = {
            date: Date.now(),
            cards: `${emojiMap[mode] || '‚ùì'} ${cardsDesc}`, 
            htmlContent: content
        }; 
        
        NotificationManager.send({
            title: `${emojiMap[mode]} Ëß£ÊûêÂÆåÊàê`,
            body: "ÁÇπÂáªÊü•ÁúãËØ¶ÁªÜÊä•Âëä",
            onClick: () => openDreamApp()
        });

    } catch(e) {
        console.error(e);
        document.getElementById('dream-analysis-content').innerText = "ÁîüÊàêÂ§±Ë¥•: " + e.message;
    }
}
</script>

<script>
// === üéÆ ‰øÆÂ§çÊ∏∏ÊàèÊú∫Êï∞ÂÄº‰∏ç‰øùÂ≠òÈóÆÈ¢ò ===
// Ë¶ÜÁõñÂéüÊúâÁöÑÊâìÂºÄÂáΩÊï∞ÔºåÂº∫Âà∂‰ªéÊó†ÈôêÂ≠òÂÇ®(BIG_MEMORY)ËØªÂèñÊï∞ÊçÆ
window.openGameApp = async function() {
    document.getElementById('game-modal').style.display = 'flex';
    
    // 1. ‰ºòÂÖà‰ªéÊó†ÈôêÂ≠òÂÇ®Ëé∑Âèñ
    if (window.BIG_MEMORY && window.BIG_MEMORY.game_stats) {
        // Á°Æ‰øùÊï∞ÊçÆ‰∏çÊòØ NaN Êàñ undefined
        const s = window.BIG_MEMORY.game_stats;
        gameState.mood = (typeof s.mood === 'number') ? s.mood : 50;
        gameState.love = (typeof s.love === 'number') ? s.love : 50;
    } 
    // 2. ÂÖúÂ∫ïÔºöÂ¶ÇÊûúËøòÊ≤°Âä†ËΩΩÂÆåÔºåÂ∞ùËØïËØªÊóßÁºìÂ≠ò
    else {
        try {
            const savedStats = JSON.parse(localStorage.getItem('game_stats') || '{"mood":50, "love":50}');
            gameState.mood = savedStats.mood;
            gameState.love = savedStats.love;
        } catch(e) {
            gameState.mood = 50;
            gameState.love = 50;
        }
    }

    // 3. Âà∑Êñ∞ÁïåÈù¢ÊòæÁ§∫
    updateGameStatsUI();
    
    // 4. Âä†ËΩΩÂõæÁâáÁ≠âÂÖ∂‰ªñËµÑÊ∫ê
    await loadGameAssets();
    
    // 5. Â¶ÇÊûúÊñáÊú¨Ê°ÜÊòØÁ©∫ÁöÑÔºåÊòæÁ§∫ÂºïÂØºËØ≠
    const contentEl = document.getElementById('rpg-content');
    if (!contentEl.innerText || contentEl.innerText === "...") {
        rpgTypeWriter("ÊÇ®", "ÁÇπÂáª‰∏ãÊñπÊñáÊú¨Ê°ÜËæìÂÖ•ÂÜÖÂÆπÔºåÊäΩÂèñÂëΩËøêÁâåÂÜ≥ÂÆöÂâßÊÉÖËµ∞Âêë...", "");
    }
    
    toggleHalfBodies('both'); 
};
// ==================== üç´ Â∑ßÂÖãÂäõÂà∂‰ΩúÂ∞èÊ∏∏ÊàèÈÄªËæë ====================
let chocoStep = 0; // 0:Á©∫, 1:Âä†ÈªÑÊ≤π, 2:Âä†ÁâõÂ•∂, 3:Âä†Â∑ßÂÖãÂäõ, 4:ÂÆåÊàê

function initChocoGame() {
    chocoStep = 0;
    const container = document.getElementById('adv-scene-container');
    container.innerHTML = `
        <div class="choco-game-container" style="background-image: url('https://i.postimg.cc/2y9RGX90/IMG_2239.png');">
                <img id="c-pot" class="choco-pot" src="https://i.postimg.cc/vT2FhS2r/IMG_2243.png" style="top: 75%;"> 
            
            <!-- ÊùêÊñô -->
            <img id="c-butter" class="choco-item" src="https://i.postimg.cc/kGY3shYN/IMG_2242.png" style="top:40%; left:5%;width:140px;" onload="enableDrag(this, 1)">
            <img id="c-milk" class="choco-item" src="https://i.postimg.cc/MH325r3Y/IMG_2240.png" style="top:30%; left:40%;" onload="enableDrag(this, 2)">
            <img id="c-choco" class="choco-item" src="https://i.postimg.cc/8cXQ4nXB/IMG_2241.png" style="top:40%; right:5%;width:140px;" onload="enableDrag(this, 3)">
            <img id="c-rod" class="choco-item" src="https://i.postimg.cc/cCLGQNhw/IMG_2247.png" style="top:6%; right:10%;" onload="enableDrag(this, 4)">

            <!-- ÈÄÄÂá∫ÊåâÈíÆ -->
            <div class="adv-btn pos-btm-mid" onclick="renderAdvScene('mall_sweet')">üîô Á¶ªÂºÄ</div>
        </div>
    `;
    // ÈöêËóèÁ´ãÁªòÈò≤Ê≠¢ÈÅÆÊå°
    if(typeof hideAdvDialog === 'function') hideAdvDialog();
}

function enableDrag(el, stepReq) {
    let startX, startY, initialLeft, initialTop;
    const pot = document.getElementById('c-pot');

    const start = (e) => {
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        initialLeft = el.offsetLeft;
        initialTop = el.offsetTop;
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move, {passive: false});
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
    };

    const move = (e) => {
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;
        el.style.left = (initialLeft + dx) + 'px';
        el.style.top = (initialTop + dy) + 'px';
    };

    const end = (e) => {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('touchmove', move);
        document.removeEventListener('mouseup', end);
        document.removeEventListener('touchend', end);
        
        // Á¢∞ÊíûÊ£ÄÊµã
        const r1 = el.getBoundingClientRect();
        const r2 = pot.getBoundingClientRect();
        const overlap = !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);

        if (overlap) {
            handleChocoStep(stepReq, el);
        } else {
            // Â§ç‰Ωç
            el.style.left = initialLeft + 'px';
            el.style.top = initialTop + 'px';
        }
    };

    el.addEventListener('mousedown', start);
    el.addEventListener('touchstart', start, {passive: false});
}

function handleChocoStep(req, el) {
    const pot = document.getElementById('c-pot');
    
    // ÈÄªËæëÈ°∫Â∫èÊ£ÄÊü•
    if (req !== chocoStep + 1) {
        alert("ËØ∑ÊåâÈ°∫Â∫èÊ∑ªÂä†ÔºöÈªÑÊ≤π -> ÁâõÂ•∂ -> Â∑ßÂÖãÂäõ -> ÊêÖÊãåÊ£í");
        // Â§ç‰Ωç
        el.style.left = ""; el.style.top = ""; 
        return;
    }

    chocoStep = req;
    el.style.display = 'none'; // ÊîæÂÖ•ÈîÖ‰∏≠ÂêéÈöêËóèÁâ©ÂìÅ

    // ÂõæÁâáÂèòÂåñÈÄªËæë
    if (req === 1) pot.src = "https://i.postimg.cc/gj2bvPsq/IMG_2246.png"; // ÈªÑÊ≤πÂÖ•ÈîÖ
    else if (req === 2) pot.src = "https://i.postimg.cc/sxgCpRmJ/IMG_2245.png"; // ÁâõÂ•∂ÂÖ•ÈîÖ
    else if (req === 3) {
        // Â∑ßÂÖãÂäõÂÖ•ÈîÖ (Ê†πÊçÆ‰Ω†ÁöÑÊèèËø∞ÔºåËøô‰∏ÄÊ≠•‰∏çÊç¢ÂõæÔºåÂè™ÈöêËóèÂ∑ßÂÖãÂäõÔºåÊàñËÄÖÂ§çÁî®2245ÔºåÁ≠âÂæÖÊêÖÊãå)
        // ‰Ω†ÁöÑÊèèËø∞ÊòØÔºöÂ∑ßÂÖãÂäõÊãñÂä® -> Á¨¨‰∏âÊ≠•(ÊîæÂú®Âè≥Ëæπ) -> ÊêÖÊãåÊ£í -> Êç¢Âõæ
        // ËøôÈáåÊàë‰ª¨ËÆ©Â∑ßÂÖãÂäõÊ∂àÂ§±ÔºåË°®Á§∫ËøõÂÖ•ÈîÖÈáå‰∫Ü
    }
    else if (req === 4) {
        pot.src = "https://i.postimg.cc/GtgwKSgY/IMG_2244.png"; // ÊêÖÊãåÂÆåÊàê
        setTimeout(finishChocoMaking, 500);
    }
}

function finishChocoMaking() {
    const style = prompt("Â∑ßÂÖãÂäõÂà∂‰ΩúÂÆåÊàêÔºÅ\nËØ∑ËæìÂÖ•Â∑ßÂÖãÂäõÁöÑÊ†∑Âºè (Â¶Ç: ÂøÉÂΩ¢/Â∞èÁÜä):", "ÂøÉÂΩ¢");
    if (!style) return;
    const flavor = prompt("ËØ∑ËæìÂÖ•È¢ùÂ§ñÁöÑÂë≥ÈÅì (Â¶Ç: Ê¶õÂ≠ê/ÊúóÂßÜÈÖí):", "Êµ∑Áõê");
    if (!flavor) return;

    // Ëß¶ÂèëÊñáÊ∏∏ÁîüÊàêÈÄªËæë
    const text = `Êàë‰∫≤ÊâãÂú®ÁîúÂìÅÂ∫óÂà∂‰Ωú‰∫Ü‰∏Ä‰ªΩ„Äê${flavor}Âè£Âë≥ÁöÑ${style}Â∑ßÂÖãÂäõ„ÄëÔºåÂπ∂ÊääÂÆÉÈÄÅÁªô‰∫Ü‰Ω†„ÄÇ`;
    
    // Ë∞ÉÁî®ÂÖ®Â±Ä LLM (ÊîØÊåÅÊ¢¶Âç†Ê®°Âºè)
    if (typeof checkDreamMode === 'function' && typeof callGlobalLLM === 'function') {
        checkDreamMode((ctx) => {
            callGlobalLLM(text, "event", ctx + "\n„ÄêÁâπÊÆäÊåá‰ª§„ÄëËøôÊòØ‰∏ÄÊ¨°ÁîúËúúÁöÑ‰∫íÂä®ÔºåËØ∑ÊèèÂÜôËßíËâ≤Êî∂Âà∞Ëøô‰ªΩÊâãÂ∑•Â∑ßÂÖãÂäõÁöÑÂèçÂ∫îÔºå‰ª•ÂèäÂìÅÂ∞ùÂêéÁöÑËØÑ‰ª∑„ÄÇ");
        });
    }
    
    // ËøîÂõûÂïÜÂú∫
    renderAdvScene('mall_sweet');
}

// ==================== ‚ù§Ô∏è ÁîªÁà±ÂøÉ‰∫íÂä®ÂÆåÊï¥ÈÄªËæë (Âê´Êõ¥Ë°£ÂÆ§ÊµãËØï) ====================

let heartCtx;
let isDrawingHeart = false;
let heartDrawDistance = 0; // ËÆ∞ÂΩïÁîªÁîªÁöÑÊÄªÈïøÂ∫¶
let heartLastPoint = { x: 0, y: 0 };

// 1. Ëß¶Âèë‰∫ã‰ª∂ (ÂÖ•Âè£)
window.triggerHeartEvent = function() {
    const data = window.BIG_MEMORY.adv_data;
    
    // Ê£ÄÊü•ÂºÄÂÖ≥ (Â§çÁî® kiss_mode ÂèòÈáèÂêç‰ª•‰æøÂÖºÂÆπ)
    if (data.kiss_mode === false) return; 

    // Ëé∑ÂèñÁ´ãÁªò (ÂøÖÈ°ªÊúâËßíËâ≤Á´ãÁªòÊâçËß¶Âèë)
    const charImg = data.avatars.char;
    if (!charImg) return; 

    const overlay = document.getElementById('adv-heart-overlay');
    const img = document.getElementById('heart-char-img');
    const msg = document.getElementById('heart-msg-box');
    const canvas = document.getElementById('heart-canvas');

    // ÂàùÂßãÂåñÁïåÈù¢
    img.src = charImg;
    msg.innerText = "‰Ω†Áé©Â•Ω‰πÖ‰∫ÜÔºå‰ºëÊÅØ‰∏Ä‰∏ãÂø´ËØ¥Áà±ÊàëÔºÅ";
    msg.style.color = "#333";
    msg.style.transform = "scale(1)";
    overlay.style.display = 'flex';

    // ÂàùÂßãÂåñÁîªÂ∏É
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    heartCtx = canvas.getContext('2d');
    
    // ËÆæÁΩÆÁîªÁ¨îÊ†∑Âºè (Á≤âËâ≤ËçßÂÖâÁ¨îËß¶ÊÑü)
    heartCtx.strokeStyle = "#ff7675"; 
    heartCtx.lineWidth = 6;
    heartCtx.lineCap = "round";
    heartCtx.lineJoin = "round";
    heartCtx.shadowBlur = 5;
    heartCtx.shadowColor = "#ff7675";

    // Ê∏ÖÁ©∫ÁîªÂ∏É
    heartCtx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ÈáçÁΩÆÊï∞ÊçÆ
    heartDrawDistance = 0;
    isDrawingHeart = false;

    // ÁªëÂÆöÁªòÁîª‰∫ã‰ª∂ (ÂÖºÂÆπ Èº†Ê†á & Ëß¶Êë∏)
    canvas.ontouchstart = startHeart;
    canvas.ontouchmove = moveHeart;
    canvas.ontouchend = endHeart;
    canvas.onmousedown = startHeart;
    canvas.onmousemove = moveHeart;
    canvas.onmouseup = endHeart;
}

// 2. ÂºÄÂßãÁîª
function startHeart(e) {
    // ÈòªÊ≠¢ÈªòËÆ§ÊªöÂä®
    if(e.cancelable) e.preventDefault();
    
    isDrawingHeart = true;
    const pt = getPoint(e);
    heartLastPoint = pt;
    heartCtx.beginPath();
    heartCtx.moveTo(pt.x, pt.y);
}

// 3. ÁîªÁîª‰∏≠ (Á¥ØÂä†Ë∑ùÁ¶ª)
function moveHeart(e) {
    if (!isDrawingHeart) return;
    if(e.cancelable) e.preventDefault();
    
    const pt = getPoint(e);
    
    // ÁîªÁ∫ø
    heartCtx.lineTo(pt.x, pt.y);
    heartCtx.stroke();
    
    // ËÆ°ÁÆóËøôÊÆµÁöÑË∑ùÁ¶ªÂπ∂Á¥ØÂä†
    const dist = Math.hypot(pt.x - heartLastPoint.x, pt.y - heartLastPoint.y);
    heartDrawDistance += dist;
    
    heartLastPoint = pt;
}

// 4. ÁªìÊùüÁîªÁîª (Âà§ÂÆöÈÄªËæë)
function endHeart(e) {
    if (!isDrawingHeart) return;
    isDrawingHeart = false;
    
    const msg = document.getElementById('heart-msg-box');
    
    // === Âà§ÂÆöÊ†áÂáÜ ===
    // Ë∑ùÁ¶ªÈòàÂÄºËÆæ‰∏∫ 300 ÂÉèÁ¥†„ÄÇ
    // ÁÇπÂáª‰∏Ä‰∏ãË∑ùÁ¶ªÈÄöÂ∏∏ÊòØ 0~10ÔºåÁîª‰∏™ÂúàÊàñÂøÉÈÄöÂ∏∏ > 400„ÄÇ
    if (heartDrawDistance > 300) {
        // ÊàêÂäüÔºÅ
        msg.innerText = "Áà±‰Ω†ÔºÅ";
        msg.style.color = "#e84393"; // ‰∫ÆÁ≤âËâ≤
        msg.style.transform = "scale(1.2)"; // ÊîæÂ§ß‰∏ÄÁÇπË°®Á§∫È´òÂÖ¥
        
        // 1.5ÁßíÂêéÂÖ≥Èó≠
        setTimeout(() => {
            document.getElementById('adv-heart-overlay').style.display = 'none';
        }, 1500);
        
    } else {
        // Â§±Ë¥• (Êï∑Ë°ç)
        msg.innerText = "ÊÄé‰πàÊï∑Ë°çÊàë„ÄÇ";
        msg.style.color = "#d63031"; // Á∫¢Ëâ≤
        
        // 0.5ÁßíÂêéÊ∏ÖÁ©∫ÁîªÂ∏ÉÔºåËÆ©Áî®Êà∑ÈáçÁîª
        setTimeout(() => {
            if(heartCtx) heartCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            heartDrawDistance = 0;
            // ÊÅ¢Â§çÊèêÁ§∫ËØ≠È¢úËâ≤ÔºåÊöóÁ§∫ÂèØ‰ª•ÈáçËØï
            setTimeout(() => {
                if(document.getElementById('adv-heart-overlay').style.display !== 'none') {
                    msg.innerText = "Âø´Â•ΩÂ•ΩÁîªÔºÅ";
                    msg.style.color = "#333";
                }
            }, 1000);
        }, 500);
    }
}

// ËæÖÂä©ÔºöËé∑ÂèñÂùêÊ†á
function getPoint(e) {
    if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
    return { x: e.clientX, y: e.clientY };
}

// 5. Ê≥®ÂÖ•ÂäüËÉΩÊ†èÂºÄÂÖ≥ (Ëá™Âä®ÊâßË°å)
const _origInjectMenu = window.injectAdvMenu;
window.injectAdvMenu = function() {
    if(_origInjectMenu) _origInjectMenu(); 

    const menuBtn = document.getElementById('btn-adv-menu');
    if (menuBtn) {
        menuBtn.onclick = () => {
            const data = window.BIG_MEMORY.adv_data;
            if(data.kiss_mode === undefined) data.kiss_mode = true; // ÈªòËÆ§ÂºÄÂêØ

            const choice = prompt(
                `===== ÊñáÊ∏∏ÂäüËÉΩËèúÂçï =====\n` +
                `1. ${data.dream_mode ? '‚úÖ' : '‚¨ú'} Ê¢¶Âç†Ê®°Âºè\n` +
                `2. üìÖ Á∫¶‰ºöÁ≥ªÁªü\n` +
                `3. üìñ ÂéÜÂè≤ÂõûÈ°æ\n` +
                `4. üîö ÁªìÊùü‰∏ñÁïå\n` +
                `5. ${data.kiss_mode ? '‚ù§Ô∏è' : 'üö´'} ÁîªÁà±ÂøÉ‰∫íÂä® (ÂºÄÂÖ≥)\n` + 
                `ËØ∑ËæìÂÖ•Êï∞Â≠óÔºö`
            );
            
            if (choice === '5') {
                data.kiss_mode = !data.kiss_mode;
                saveToBigDB('adv_data', data);
                alert(`ÁîªÁà±ÂøÉ‰∫íÂä®Â∑≤${data.kiss_mode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}ÔºÅ`);
            }
            // ÂÖºÂÆπÊóßÈÄªËæë
            else if (choice === '1') {
                data.dream_mode = !data.dream_mode;
                saveToBigDB('adv_data', data);
                alert(`Ê¢¶Âç†Ê®°ÂºèÂ∑≤${data.dream_mode ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`);
            } else if (choice === '2') openDatingMenu();
            else if (choice === '3') openAdvHistory();
            else if (choice === '4') document.getElementById('adv-ending-modal').style.display = 'flex';
        };
    }
};

// 6. üî• Ê≥®ÂÖ•Êõ¥Ë°£ÂÆ§ÊµãËØïÊåâÈíÆ (100% Ëß¶Âèë)
const _origRenderCloset = window.renderClosetUI;
window.renderClosetUI = function() {
    // ÂÖàÊ∏≤ÊüìÂéüÁâàÁïåÈù¢
    _origRenderCloset(); 
    
    // ÊâæÂà∞ÂÆπÂô®
    const container = document.querySelector('.closet-container');
    if (container) {
        // ÂàõÂª∫ÊµãËØïÊåâÈíÆ
        const testBtn = document.createElement('button');
        testBtn.className = "m-btn secondary";
        testBtn.innerText = "‚ù§Ô∏è ÁîªÁà±ÂøÉ (100%Ëß¶Âèë)";
        testBtn.style.width = "100%";
        testBtn.style.marginBottom = "15px";
        testBtn.style.background = "#ff7675"; // Á≤âËâ≤ËÉåÊôØ
        testBtn.style.color = "white";
        testBtn.style.fontWeight = "bold";
        
        // ÁªëÂÆöËß¶Âèë‰∫ã‰ª∂
        testBtn.onclick = function() {
            // Âº∫Âà∂ÂºÄÂêØÂºÄÂÖ≥ÔºåÈò≤Ê≠¢Âõ†‰∏∫ÂÖ≥Èó≠‰∫ÜÂºÄÂÖ≥ÂØºËá¥ÊµãËØïÊó†Êïà
            window.BIG_MEMORY.adv_data.kiss_mode = true;
            window.triggerHeartEvent();
        };
        
        // ÊèíÂÖ•Âà∞ "ÊàëÁöÑËÉåÂåÖ" Ê†áÈ¢òÂâçÈù¢
        // Êàë‰ª¨ÂØªÊâæÂåÖÂê´‚ÄúÊàëÁöÑËÉåÂåÖ‚ÄùÂ≠óÊ†∑ÁöÑ div
        const allDivs = container.getElementsByTagName('div');
        let targetDiv = null;
        for(let div of allDivs) {
            if(div.innerText.includes("ÊàëÁöÑËÉåÂåÖ")) {
                targetDiv = div;
                break;
            }
        }
        
        if(targetDiv) {
            container.insertBefore(testBtn, targetDiv);
        } else {
            // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÔºåÂ∞±ÊèíÂú®ÊúÄÂêéÈù¢
            container.appendChild(testBtn);
        }
    }
};

// 7. ÈöèÊú∫Ëß¶ÂèëÂô® (ÊåÇËΩΩÂà∞Ê∏∏ÊàèÈÄªËæë)
const _origLogicHeart = window.executeAdvLogic;
window.executeAdvLogic = function(logicKey) {
    // 5% Ê¶ÇÁéáËß¶ÂèëÔºå‰∏îÂøÖÈ°ªÊúâËßíËâ≤Á´ãÁªò
    if (Math.random() < 0.05) {
        const data = window.BIG_MEMORY.adv_data;
        if (data.avatars && data.avatars.char) {
            triggerHeartEvent(); // Ëß¶ÂèëÁîªÁà±ÂøÉ
            return; // ÈòªÊñ≠ÂéüÊìç‰Ωú
        }
    }
    // Âê¶ÂàôÊâßË°åÂéüÈÄªËæë
    _origLogicHeart(logicKey);
}

console.log("‚úÖ ÁîªÁà±ÂøÉÁ≥ªÁªüÂ∑≤Âä†ËΩΩÔºöÊ£ÄÊµãÊãñÂä®Ë∑ùÁ¶ª + Êõ¥Ë°£ÂÆ§ÊµãËØïÊåâÈíÆ");
</script>

</html> 